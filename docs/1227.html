<html>
<head>
<title>How to improve interface responsiveness with web workers - LogRocket Blog</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>如何提高网络工作者的界面响应能力</h1>
<blockquote>原文：<a href="https://blog.logrocket.com/how-to-improve-interface-responsiveness-with-web-workers/#0001-01-01">https://blog.logrocket.com/how-to-improve-interface-responsiveness-with-web-workers/#0001-01-01</a></blockquote><div><article class="article-post">
<p>JavaScript是单线程的，所以任何运行的JavaScript都会阻止网页的响应。这在很多情况下都不是问题，因为代码运行得足够快，任何用户界面的停顿都不会被用户察觉。</p>
<p>然而，如果代码的计算量很大，或者用户的硬件能力不足，这就会成为一个严重的问题。</p>
<h2>网络工作者</h2>
<p>缓解这个问题的一个方法是通过将工作卸载到后台线程上来避免在主线程上放置太多的工作。其他平台，如Android T1和T2 iOS T3，强调让主线程处理尽可能少的非UI工作的重要性。</p>
<p><a href="https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API" target="_blank" rel="noopener noreferrer"> Web Workers API </a>是Android和iOS后台线程的Web等价物。<a href="https://caniuse.com/#feat=webworkers" target="_blank" rel="noopener noreferrer">超过97%的浏览器支持工人。</a></p>
<h2>演示</h2>
<p>让我们创建一个演示来演示问题和解决方案。你也可以在这里查看最终结果<a href="https://www.dannyguo.com/web-worker-demo" target="_blank" rel="noopener noreferrer">，在</a><a href="https://github.com/dguo/web-worker-demo" target="_blank" rel="noopener noreferrer"> GitHub </a>上查看源代码。我们先从最基本的开始。</p>
<pre>&lt;!DOCTYPE html&gt;
&lt;html lang="en"&gt;
  &lt;head&gt;
    &lt;meta charset="utf-8" /&gt;
    &lt;meta name="viewport" content="width=device-width, initial-scale=1.0" /&gt;
    &lt;title&gt;Web Worker Demo&lt;/title&gt;
    &lt;script src="./index.js" async&gt;&lt;/script&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;p&gt;The current time is: &lt;span id="time"&gt;&lt;/span&gt;&lt;/p&gt;
  &lt;/body&gt;
&lt;/html&gt;</pre>
<p>接下来，我们将添加<code>index.js</code>来持续更新时间，并像这样显示:<code>21:45:08.345</code>。</p>
<pre>// So that the hour, minute, and second are always two digits each
function padTime(number) {
  return number &lt; 10 ? "0" + number : number;
}

function getTime() {
  const now = new Date();
  return (
    padTime(now.getHours()) +
    ":" +
    padTime(now.getMinutes()) +
    ":" +
    padTime(now.getSeconds()) +
    "." +
    now.getMilliseconds()
  );
}

setInterval(function () {
  document.getElementById("time").innerText = getTime();
}, 50);</pre>
<p>通过将时间间隔设置为50毫秒，我们将看到时间更新非常快。</p>
<p><img data-attachment-id="26948" data-permalink="https://blog.logrocket.com/how-to-improve-interface-responsiveness-with-web-workers/s_2b1d39163f68bf012f7e2e562d0c8d85ee12db93ac548b1b538fd80767f90560_1599436104511_clock-1/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/10/s_2B1D39163F68BF012F7E2E562D0C8D85EE12DB93AC548B1B538FD80767F90560_1599436104511_clock-1.gif" data-orig-size="730,110" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="s_2B1D39163F68BF012F7E2E562D0C8D85EE12DB93AC548B1B538FD80767F90560_1599436104511_clock (1)" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/10/s_2B1D39163F68BF012F7E2E562D0C8D85EE12DB93AC548B1B538FD80767F90560_1599436104511_clock-1-300x45.gif" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/10/s_2B1D39163F68BF012F7E2E562D0C8D85EE12DB93AC548B1B538FD80767F90560_1599436104511_clock-1.gif" decoding="async" class="aligncenter size-full wp-image-26948 jetpack-lazy-image" src="../Images/e0e838fc90aa4010bfca92c71f26f326.png" alt="A gif showing a clock set to count down." data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2020/10/s_2B1D39163F68BF012F7E2E562D0C8D85EE12DB93AC548B1B538FD80767F90560_1599436104511_clock-1.gif?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/10/s_2B1D39163F68BF012F7E2E562D0C8D85EE12DB93AC548B1B538FD80767F90560_1599436104511_clock-1.gif"/></p><noscript><img data-lazy-fallback="1" data-attachment-id="26948" data-permalink="https://blog.logrocket.com/how-to-improve-interface-responsiveness-with-web-workers/s_2b1d39163f68bf012f7e2e562d0c8d85ee12db93ac548b1b538fd80767f90560_1599436104511_clock-1/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/10/s_2B1D39163F68BF012F7E2E562D0C8D85EE12DB93AC548B1B538FD80767F90560_1599436104511_clock-1.gif" data-orig-size="730,110" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="s_2B1D39163F68BF012F7E2E562D0C8D85EE12DB93AC548B1B538FD80767F90560_1599436104511_clock (1)" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/10/s_2B1D39163F68BF012F7E2E562D0C8D85EE12DB93AC548B1B538FD80767F90560_1599436104511_clock-1-300x45.gif" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/10/s_2B1D39163F68BF012F7E2E562D0C8D85EE12DB93AC548B1B538FD80767F90560_1599436104511_clock-1.gif" decoding="async" loading="lazy" class="aligncenter size-full wp-image-26948" src="../Images/e0e838fc90aa4010bfca92c71f26f326.png" alt="A gif showing a clock set to count down." data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/10/s_2B1D39163F68BF012F7E2E562D0C8D85EE12DB93AC548B1B538FD80767F90560_1599436104511_clock-1.gif"/></noscript>
<h3>设置服务器</h3>
<p>接下来，我们将使用<code>npm init</code>或<code>yarn init</code>启动Node.js项目，并安装<a href="https://parceljs.org/" target="_blank" rel="noopener noreferrer">包</a>。我们想使用package的第一个原因是，在Chrome的<a href="https://parceljs.org/" target="_blank" rel="noopener noreferrer">中，工人需要被服务</a>，而不是从本地文件加载。</p>
<p>所以当我们以后添加一个工人时，如果我们使用的是Chrome，我们就不能直接打开<code>index.html</code>。第二个原因是Parcel内置了对Web Workers API的支持，不需要为我们的演示进行任何配置。其他捆扎机如<a href="https://webpack.js.org/" target="_blank" rel="noopener noreferrer"> webpack </a>需要<a href="https://webpack.js.org/loaders/worker-loader/" target="_blank" rel="noopener noreferrer">更多的设置</a>。</p>
<p>我建议给<code>package.json</code>加一个开始命令:</p>
<pre>{
  "scripts": {
    "start": "parcel serve index.html --open"    
  }
}</pre>
<p>这将允许您运行<code>npm start</code>或<code>yarn start</code>来构建文件，启动服务器，在浏览器中打开页面，并在您更改源文件时自动更新页面。</p>
<h3>imagej</h3>
<p>现在让我们添加一些计算量很大的东西。</p>
<p>我们将安装<a href="https://github.com/ibezkrovnyi/image-quantization" target="_blank" rel="noopener noreferrer"> image-q </a>，一个图像<a href="https://en.wikipedia.org/wiki/Color_quantization" target="_blank" rel="noopener noreferrer">量化</a>库，我们将使用它来计算给定图像的主要颜色，从图像创建调色板。</p>
<p>这里有一个例子:</p>
<p><img data-attachment-id="26951" data-permalink="https://blog.logrocket.com/how-to-improve-interface-responsiveness-with-web-workers/crab/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/10/crab.png" data-orig-size="730,665" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="crab" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/10/crab-300x273.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/10/crab.png" decoding="async" class="aligncenter size-full wp-image-26951 jetpack-lazy-image" src="../Images/4a96d4fe5e68372387e4b03ddd09944c.png" alt="A picture of a crab." data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2020/10/crab.png 730w, https://blog.logrocket.com/wp-content/uploads/2020/10/crab-300x273.png 300w" data-lazy-sizes="(max-width: 730px) 100vw, 730px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2020/10/crab.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/10/crab.png"/></p><noscript><img data-lazy-fallback="1" data-attachment-id="26951" data-permalink="https://blog.logrocket.com/how-to-improve-interface-responsiveness-with-web-workers/crab/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/10/crab.png" data-orig-size="730,665" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="crab" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/10/crab-300x273.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/10/crab.png" decoding="async" loading="lazy" class="aligncenter size-full wp-image-26951" src="../Images/4a96d4fe5e68372387e4b03ddd09944c.png" alt="A picture of a crab." srcset="https://blog.logrocket.com/wp-content/uploads/2020/10/crab.png 730w, https://blog.logrocket.com/wp-content/uploads/2020/10/crab-300x273.png 300w" sizes="(max-width: 730px) 100vw, 730px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/10/crab.png"/></noscript>
<p>让我们更新一下<code>body</code>:</p>
<pre>&lt;body&gt;  
  &lt;div class="center"&gt;
    &lt;p&gt;The current time is: &lt;span id="time"&gt;&lt;/span&gt;&lt;/p&gt;

    &lt;form id="image-url-form"&gt;
      &lt;label for="image-url"&gt;Direct image URL&lt;/label&gt;
      &lt;input
        type="url"
        name="url"
        value="https://upload.wikimedia.org/wikipedia/commons/1/1f/Grapsus_grapsus_Galapagos_Islands.jpg"
      /&gt;
      &lt;input type="submit" value="Generate Color Palette" /&gt;
      &lt;p id="error-message"&gt;&lt;/p&gt;
    &lt;/form&gt;
  &lt;/div&gt;

  &lt;div id="loader-wrapper" class="center"&gt;
    &lt;div id="loader"&gt;&lt;/div&gt;
  &lt;/div&gt;

  &lt;div id="colors-wrapper" class="center"&gt;
    &lt;div id="color-0" class="color"&gt;&lt;/div&gt;
    &lt;div id="color-1" class="color"&gt;&lt;/div&gt;
    &lt;div id="color-2" class="color"&gt;&lt;/div&gt;
    &lt;div id="color-3" class="color"&gt;&lt;/div&gt;
  &lt;/div&gt;

  &lt;a class="center" id="image-link" target="_blank"&gt;
    &lt;img id="image" crossorigin="anonymous" /&gt;
  &lt;/a&gt;
&lt;/body&gt;</pre>
<p>因此，我们添加了一个直接链接到图像的表单。然后，我们有一个加载器在处理过程中显示旋转动画。我们将修改<a href="https://codepen.io/mandelid/pen/vwKoe" target="_blank" rel="noopener noreferrer">这个代码笔</a>来实现它。我们还有四个div，我们将使用它们来显示调色板。最后，我们将显示图像本身。</p>
<p>给<code>head</code>添加一些内联样式。这包括一个用于旋转加载器的CSS动画。</p>
<pre>&lt;style type="text/css"&gt;
  .center {
    display: block;
    margin: 0 auto;
    max-width: max-content;
  }

  form {
    margin-top: 25px;
    margin-bottom: 25px;
  }

  input[type="url"] {
    display: block;
    padding: 5px;
    width: 320px;
  }

  form * {
    margin-top: 5px;
  }

  #error-message {
    display: none;
    background-color: #f5e4e4;
    color: #b22222;
    border-radius: 5px;
    margin-top: 10px;
    padding: 10px;
  }

  .color {
    width: 80px;
    height: 80px;
    display: inline-block;
  }

  img {
    max-width: 90vw;
    max-height: 500px;
    margin-top: 25px;
  }

  #image-link {
    display: none;
  }

  #loader-wrapper {
    display: none;
  }

  #loader {
    width: 50px;
    height: 50px;
    border: 3px solid #d3d3d3;
    border-radius: 50%;
    border-top-color: green;
    animation: spin 1s ease-in-out infinite;
    -webkit-animation: spin 1s ease-in-out infinite;
  }

  @keyframes spin {
    to {
      -webkit-transform: rotate(360deg);
    }
  }
  @-webkit-keyframes spin {
    to {
      -webkit-transform: rotate(360deg);
    }
  }

  #error-message {
    display: none;
    background-color: #f5e4e4;
    color: #b22222;
    border-radius: 5px;
    margin-top: 10px;
    padding: 10px;
  }
&lt;/style&gt;</pre>
<p>更新<code>index.js</code>:</p>
<pre>import * as iq from "image-q";

// Previous code for updating the time

function setPalette(points) {
  points.forEach(function (point, index) {
    document.getElementById("color-" + index).style.backgroundColor =
      "rgb(" + point.r + "," + point.g + "," + point.b + ")";
  });

  document.getElementById("loader-wrapper").style.display = "none";
  document.getElementById("colors-wrapper").style.display = "block";
  document.getElementById("image-link").style.display = "block";
}

function handleError(message) {
  const errorMessage = document.getElementById("error-message");
  errorMessage.innerText = message;
  errorMessage.style.display = "block";
  document.getElementById("loader-wrapper").style.display = "none";
  document.getElementById("image-link").style.display = "none";
}

document
  .getElementById("image-url-form")
  .addEventListener("submit", function (event) {
    event.preventDefault();

    const url = event.target.elements.url.value;
    const image = document.getElementById("image");

    image.onload = function () {
      document.getElementById("image-link").href = url;

      const canvas = document.createElement("canvas");
      canvas.width = image.naturalWidth;
      canvas.height = image.naturalHeight;
      const context = canvas.getContext("2d");
      context.drawImage(image, 0, 0);
      const imageData = context.getImageData(
        0,
        0,
        image.naturalWidth,
        image.naturalHeight
      );

      const pointContainer = iq.utils.PointContainer.fromImageData(imageData);
      const palette = iq.buildPaletteSync([pointContainer], { colors: 4 });
      const points = palette._pointArray;
      setPalette(points);
    };

    image.onerror = function () {
      handleError("The image failed to load. Please double check the URL.");
    };

    document.getElementById("error-message").style.display = "none";
    document.getElementById("loader-wrapper").style.display = "block";
    document.getElementById("colors-wrapper").style.display = "none";
    document.getElementById("image-link").style.display = "none";

    image.src = url;
  });</pre>
<p><code>setPalette</code>函数设置颜色分区的背景颜色，以便显示调色板。我们还有一个<code>handleError</code>功能，以防图像加载失败。</p>
<p>然后，我们听取表单提交。每当我们得到一个新的提交，我们设置图像元素的<code>onload</code>函数，以适合<code>image-q</code>的格式提取图像数据。</p>
<p>所以我们<a href="https://developer.mozilla.org/en-US/docs/Web/API/Canvas_API" target="_blank" rel="noopener noreferrer">在画布</a>中绘制图像，以便我们可以检索一个<a href="https://developer.mozilla.org/en-US/docs/Web/API/ImageData" target="_blank" rel="noopener noreferrer"> ImageData </a>对象。</p>
<p>我们将该对象传递给<code>image-q</code>，并调用<code>iq.buildPaletteSync</code>，这是计算开销较大的部分。它返回四种颜色，我们将其传递给<code>setPalette</code>。</p>
<p>我们也适当地隐藏和取消隐藏元素。</p>
<h3>问题是</h3>
<p>尝试生成一个调色板。请注意，当<code>image-q</code>正在处理时，时间停止更新。如果你试图点击输入的网址，用户界面也不会有反应。但是，旋转动画可能仍然有效。解释是CSS动画有可能由一个<a href="https://www.viget.com/articles/animation-performance-101-browser-under-the-hood/" target="_blank" rel="noopener noreferrer">单独的合成器线程代替</a>来处理。</p>
<p>在Firefox上，浏览器最终会显示一条警告:</p>
<p><img data-attachment-id="26957" data-permalink="https://blog.logrocket.com/how-to-improve-interface-responsiveness-with-web-workers/warning/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/10/warning.png" data-orig-size="730,85" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="warning" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/10/warning-300x35.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/10/warning.png" decoding="async" class="aligncenter size-full wp-image-26957 jetpack-lazy-image" src="../Images/1ae9d6309205fd0f241c470615e00823.png" alt="a warning issued by Firefox." data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2020/10/warning.png 730w, https://blog.logrocket.com/wp-content/uploads/2020/10/warning-300x35.png 300w" data-lazy-sizes="(max-width: 730px) 100vw, 730px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2020/10/warning.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/10/warning.png"/></p><noscript><img data-lazy-fallback="1" data-attachment-id="26957" data-permalink="https://blog.logrocket.com/how-to-improve-interface-responsiveness-with-web-workers/warning/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/10/warning.png" data-orig-size="730,85" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="warning" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/10/warning-300x35.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/10/warning.png" decoding="async" loading="lazy" class="aligncenter size-full wp-image-26957" src="../Images/1ae9d6309205fd0f241c470615e00823.png" alt="a warning issued by Firefox." srcset="https://blog.logrocket.com/wp-content/uploads/2020/10/warning.png 730w, https://blog.logrocket.com/wp-content/uploads/2020/10/warning-300x35.png 300w" sizes="(max-width: 730px) 100vw, 730px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/10/warning.png"/></noscript>
<p>如果你有一台速度很快的电脑，这个问题可能不会那么明显，因为你的CPU可以很快地完成工作。要模拟一个较慢的设备，你可以使用Chrome，它有一个开发者工具设置来调节CPU。</p>
<p>打开性能选项卡，然后打开其设置以显示选项:</p>
<p><img data-attachment-id="26958" data-permalink="https://blog.logrocket.com/how-to-improve-interface-responsiveness-with-web-workers/4-x-slowdown/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/10/4-x-slowdown.png" data-orig-size="730,90" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="4-x-slowdown" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/10/4-x-slowdown-300x37.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/10/4-x-slowdown.png" decoding="async" class="aligncenter size-full wp-image-26958 jetpack-lazy-image" src="../Images/09c26d82a57c2959b08b66fb9ccbf7a6.png" alt="A four times slowdown." data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2020/10/4-x-slowdown.png 730w, https://blog.logrocket.com/wp-content/uploads/2020/10/4-x-slowdown-300x37.png 300w" data-lazy-sizes="(max-width: 730px) 100vw, 730px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2020/10/4-x-slowdown.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/10/4-x-slowdown.png"/></p><noscript><img data-lazy-fallback="1" data-attachment-id="26958" data-permalink="https://blog.logrocket.com/how-to-improve-interface-responsiveness-with-web-workers/4-x-slowdown/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/10/4-x-slowdown.png" data-orig-size="730,90" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="4-x-slowdown" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/10/4-x-slowdown-300x37.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/10/4-x-slowdown.png" decoding="async" loading="lazy" class="aligncenter size-full wp-image-26958" src="../Images/09c26d82a57c2959b08b66fb9ccbf7a6.png" alt="A four times slowdown." srcset="https://blog.logrocket.com/wp-content/uploads/2020/10/4-x-slowdown.png 730w, https://blog.logrocket.com/wp-content/uploads/2020/10/4-x-slowdown-300x37.png 300w" sizes="(max-width: 730px) 100vw, 730px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/10/4-x-slowdown.png"/></noscript>
<h3>添加工人</h3>
<p>要修复没有响应的UI，让我们使用一个worker。首先，我们将在表单中添加一个复选框，以指示站点是否应该使用该员工。在提交输入之前添加这个HTML。</p>
<pre>&lt;input type="checkbox" name="worker" /&gt;
&lt;label for="worker"&gt; Use worker&lt;/label&gt;
&lt;br /&gt;</pre>
<p>接下来，我们将在<code>index.js</code>中设置worker。尽管有广泛的浏览器支持，我们还是用<code>if (window.Worker)</code>添加一个特性检测检查以防万一。</p>
<pre>let worker;
if (window.Worker) {
  worker = new Worker("worker.js");
  worker.onmessage = function (message) {
    setPalette(message.data.points);
  };
}</pre>
<p><a href="https://developer.mozilla.org/en-US/docs/Web/API/Worker/onmessage" target="_blank" rel="noopener noreferrer"> onmessage </a>方法是我们从worker接收数据的方式。</p>
<p>然后，当复选框被选中时，我们将更改图像<code>onload</code>处理程序以使用worker。</p>
<pre>// From before
const imageData = context.getImageData(
    0,
    0
    image.naturalWidth,
    image.naturalHeight
);

if (event.target.elements.worker.checked) {
    if (worker) {
        worker.postMessage({ imageData });
    } else {
        handleError("Your browser doesn't support web workers.");
    }
    return;
}

// From before
const pointContainer = iq.utils.PointContainer.fromImageData(imageData);</pre>
<p>worker的<code><a href="https://developer.mozilla.org/en-US/docs/Web/API/Worker/postMessage" target="_blank" rel="noopener noreferrer">postMessage</a></code>方法就是我们如何向worker发送数据。</p>
<p>最后，我们需要在<code>worker.js</code>中创建工人本身。</p>
<pre>import * as iq from "image-q";

onmessage = function (e) {
  const pointContainer = iq.utils.PointContainer.fromImageData(
    e.data.imageData
  );
  const palette = iq.buildPaletteSync([pointContainer], { colors: 4 });
  postMessage({ points: palette._pointArray });
};</pre>
<p>注意，我们仍然使用<code>onmessage</code>和<code>postMessage</code>，但是现在<code>onmessage</code>从<code>index.js</code>接收一个消息，并且<code>postMessage</code>向<code>index.js</code>发送一个消息。</p>
<p>尝试用worker生成一个调色板，您应该看到时间在处理过程中不断更新。表单也保持交互而不是冻结。</p>
<h2>结论</h2>
<p>Web Workers API是一种有效的方法，可以让网站感觉响应更快，尤其是当网站更像一个应用程序，而不是主要显示静态数据时。正如我们所看到的，设置一个worker也可以相当简单，因此识别CPU密集型代码并将其转移到一个worker可能是一件轻而易举的事情。</p>
<p>工人确实有限制，主要是他们没有权限访问DOM。总的思路应该是让主线程尽可能地关注UI，包括更新DOM，同时将昂贵的工作转移给工人。通过在有意义的时候这样做，你可以给你的用户一个界面，它不会冻结，并且始终令人愉快地使用。</p><div class="code-block code-block-27">
<div class="blog-plug inline-plug vanilla-javascript-cta"><h2>通过理解上下文，更容易地调试JavaScript错误</h2>
<p>调试代码总是一项单调乏味的任务。但是你越了解自己的错误，就越容易改正。</p>
<p>LogRocket 让你以新的独特的方式理解这些错误。我们的前端监控解决方案跟踪用户与您的JavaScript前端的互动，让您能够准确找出导致错误的用户行为。</p>
<a href="https://lp.logrocket.com/blg/javascript-signup" class="signup" target="_blank" rel="noopener noreferrer"><img class="alignnone size-full wp-image-46 jetpack-lazy-image" src="../Images/cbfed9be3defcb505e662574769a7636.png" alt="LogRocket Dashboard Free Trial Banner" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2020/06/reproduce-javascript-errors.gif?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/06/reproduce-javascript-errors.gif"/><noscript><img data-lazy-fallback="1" class="alignnone size-full wp-image-46" src="../Images/cbfed9be3defcb505e662574769a7636.png" alt="LogRocket Dashboard Free Trial Banner" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/06/reproduce-javascript-errors.gif"/></noscript></a>
<p>LogRocket记录控制台日志、页面加载时间、堆栈跟踪、慢速网络请求/响应(带有标题+正文)、浏览器元数据和自定义日志。理解您的JavaScript代码的影响从来没有这么简单过！</p>
<a class="signup" href="https://lp.logrocket.com/blg/javascript-signup" target="_blank" rel="noopener noreferrer">Try it for free</a><p>.</p></div>


</div>

<p class="clearfix"/>
<p class="clearfix"/>
</article>
 
</div>    
</body>
</html>