<html>
<head>
<title>Using Deno's SMTP client - LogRocket Blog</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>使用Deno的SMTP客户端- LogRocket博客</h1>
<blockquote>原文：<a href="https://blog.logrocket.com/using-denos-smtp-client/#0001-01-01">https://blog.logrocket.com/using-denos-smtp-client/#0001-01-01</a></blockquote><div><article class="article-post">
<p>Deno是一个基于V8 JavaScript引擎和Rust的JavaScript和TypeScript运行时。</p>
<p>Node.js的原创者Ryan Dahl 于2019年4月在JSConf EU正式<a href="https://www.youtube.com/watch?v=z6JRlx5NC9E" target="_blank" rel="noopener noreferrer">宣布，Deno拥有一流的TypeScript支持。这意味着您不必编写任何手动配置来设置它，但这并不意味着您仅限于使用TypeScript编写代码。</a></p>
<p>Deno与Node非常不同，因为它没有包管理器。不得不依赖URL来托管和导入包有它的优点和缺点。</p>
<p>在本教程中，我们将构建一个Deno应用程序，使用<a href="https://deno.land/x/smtp@v0.3.0/README.md" target="_blank" rel="noopener noreferrer"> Deno的SMTP邮件客户端</a>向另一个用户发送邮件。要继续学习，您需要对JavaScript有一个基本的了解，一个文本编辑器(我们将使用VS代码)，以及安装在本地机器上的POSTMAN。</p>
<h2 id="installingdenoonlocalmachine">安装Deno</h2>
<p>安装Deno最好最简单的方法是使用<a href="https://formulae.brew.sh/formula/deno" target="_blank" rel="noopener noreferrer">自制软件</a>。</p>
<p>打开您的终端并键入:</p>
<pre>brew install deno
</pre>
<p>安装完成后，在您的终端上运行<code>deno</code>以确认安装成功。</p>
<h2>设置Deno服务器</h2>
<p>现在让我们为我们的应用程序设置一个服务器。我们将使用<a href="https://github.com/oakserver/oak" target="_blank" rel="noopener noreferrer"> Oak </a>来构建我们的服务器，它是Deno的HTTP服务器的中间件框架，也支持路由。</p>
<p>创建一个<code>server.ts</code>文件并添加以下内容。</p>
<pre>import { Application } from "https://deno.land/x/oak/mod.ts";
const app = new Application();
import router from "./routes.ts";
const PORT: number = 3000;
app.use(router.routes());
app.use(router.allowedMethods());
app.listen({ port: PORT });
</pre>
<p>在这里，我们访问了Oak的<code>Application</code>类，它包装了来自<code>http</code>包的<code>serve</code>函数。我们将该实例存储在<code>app</code>变量中，该变量将用于定义路由和监听端口。</p>
<h2>创建路线</h2>
<p>接下来，我们将创建一个<code>routes.ts</code>文件。这是我们创建路线的地方，它将与控制器文件通信。</p>
<pre>import { Router } from "https://deno.land/x/oak/mod.ts";
const router = new Router();
router
  .get("/", (ctx) =&gt; {
    ctx.response.body = "This is the home route";
  })
export default router;
</pre>
<p>请注意我们如何从Oak引入了<code>Router</code>类，然后创建了它的一个新实例。</p>
<p>现在我们可以通过在终端上运行<code>deno run --allow-all server.ts</code>来运行我们的应用程序。这将在端口<code>3000</code>上运行应用程序。现在，如果你尝试访问应用程序，你会得到<code>This is the home route</code>。</p>
<p>下一步是添加一个新的路由来发送我们的消息，然后实现mailer函数。</p>
<pre>import { Router } from "https://deno.land/x/oak/mod.ts";
import { sendMail } from "./controller.ts";
const router = new Router();
router
  .get("/", (ctx) =&gt; {
    ctx.response.body = "This is the home route";
  })
  .post("/send-mail", sendMail);
export default router;
</pre>
<p>我们添加了一个新的路由，这是一个发送邮件的<code>POST</code>请求。接下来，我们将创建一个<code>controller.ts</code>文件，在这里我们将定义我们的路由方法。我们还将为邮件配置创建一个<code>index.ts</code>文件。</p>
<p>创建<code>controller.ts</code>文件并添加以下代码。</p>
<pre>import { mailerObj } from "./index.ts";
let sendMail = async (ctx: any) =&gt; {
  try {
    let body: any = await ctx.request.body();
    let dataObj = await body.value;
    await mailerObj(dataObj);
    ctx.response.body = { status: true, message: "Mail Sent" };
    ctx.response.status = 201;
  } catch (err) {
    ctx.response.body = { status: false, data: null };
    ctx.response.status = 500;
    console.log(err);
  }
};
export { sendMail };
</pre>
<p>我们首先引入我们的mailer实例，我们将很快对其进行定义。每个控制器方法都传递了一个上下文，我们将使用它来创建请求体。这个主体将由我们的邮件<code>body</code>和<code>to</code>组成，前者是我们发送的邮件主体，后者是我们发送邮件的接收者。</p>
<p>为了方便访问，我们将把主体传递到我们的<code>mailerObj</code>方法中。</p>
<p>在我们设置我们的邮件方法之前，我们必须<a href="https://myaccount.google.com/lesssecureapps" target="_blank" rel="noopener noreferrer">打开<code>less secure</code>选项</a>。完成后，我们可以继续我们的配置。</p>
<h2>设置Deno SMTP客户端</h2>
<p>创建一个<code>index.ts</code>文件并添加以下代码。</p>
<pre>import { SmtpClient } from "https://deno.land/x/smtp/mod.ts";
const client = new SmtpClient();
await client.connectTLS({
  hostname: "smtp.gmail.com",
  port: 465,
  username: &lt;gmail email&gt;,
  password: &lt;gmail password&gt;
});
let mailerObj = async (data: any) =&gt; {
  await client.send({
    from: "Mail from Wisdom", // Your Email address
    to: data.to, // Email address of the destination
    subject: "Deno is Great",
    content: data.body,
  });
  await client.close();
};
export { mailerObj };
</pre>
<p>接下来，引入Deno的<code>SmtpClient</code>模块，然后创建它的一个实例。使用<code>Smtp</code>实例连接到Gmail。这个配置接受我们的Gmail用户名和密码。出于安全考虑，我们需要将这些细节保存在环境变量中。</p>
<p>下一步是定义我们的mailer对象，它接收关于消息的细节，比如发送者、接收者、主题和内容。我们必须导出这个配置，以便其他文件可以访问它。</p>
<h2 id="settingupenvironmentvariables">环境变量</h2>
<p>让我们通过使用一些环境变量来存储我们的Gmail信息，从而修改我们的代码。</p>
<p>在应用程序的根目录下创建一个<code>.env</code>文件，并添加以下内容。</p><div class="code-block code-block-54">
<hr/>
<h3>更多来自LogRocket的精彩文章:</h3>

<hr/></div>
<pre>GMAIL_USERNAME=&lt;gmail email&gt;
GMAIL_PASSWORD=&lt;gmail password&gt;
</pre>
<p>接下来，修改我们的邮件程序配置来监听这个环境变量。</p>
<pre>import "https://deno.land/x/dotenv/load.ts";
import { SmtpClient } from "https://deno.land/x/smtp/mod.ts";
const client = new SmtpClient();
await client.connectTLS({
  hostname: "smtp.gmail.com",
  port: 465,
  username: Deno.env.get("GMAIL_USERNAME"),
  password: Deno.env.get("GMAIL_PASSWORD"),
});
let mailerObj = async (data: any) =&gt; {
  await client.send({
    from: "Mail from Wisdom", // Your Email address
    to: data.to, // Email address of the destination
    subject: "Testing Deno SMTP client",
    content: data.body,
  });
  await client.close();
};
export { mailerObj };
</pre>
<p>为了访问存储在<code>.env</code>文件中的数据，我们必须引入Deno的env模块，并使用<code>Deno.env.get(name)</code>来获取存储的值。</p>
<p>始终记得创建一个与存储在<code>.env</code>文件中的键相同但没有值的<code>.env.example</code>文件，并将<code>.env</code>文件添加到<code>.gitignore</code>文件中。</p>
<p>要测试应用程序，打开POSTMAN并发出post请求。</p>
<p><img data-attachment-id="29708" data-permalink="https://blog.logrocket.com/using-denos-smtp-client/post-request-in-postman/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/11/post-request-in-postman.png" data-orig-size="720,439" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Post request in POSTMAN" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/11/post-request-in-postman-300x183.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/11/post-request-in-postman.png" decoding="async" class="aligncenter size-full wp-image-29708 jetpack-lazy-image" src="../Images/f96fbc9540a4e7727a335c9a98370476.png" alt="Post Request in POSTMAN" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2020/11/post-request-in-postman.png 720w, https://blog.logrocket.com/wp-content/uploads/2020/11/post-request-in-postman-300x183.png 300w" data-lazy-sizes="(max-width: 720px) 100vw, 720px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2020/11/post-request-in-postman.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/11/post-request-in-postman.png"/></p><noscript><img data-lazy-fallback="1" data-attachment-id="29708" data-permalink="https://blog.logrocket.com/using-denos-smtp-client/post-request-in-postman/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/11/post-request-in-postman.png" data-orig-size="720,439" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Post request in POSTMAN" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/11/post-request-in-postman-300x183.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/11/post-request-in-postman.png" decoding="async" loading="lazy" class="aligncenter size-full wp-image-29708" src="../Images/f96fbc9540a4e7727a335c9a98370476.png" alt="Post Request in POSTMAN" srcset="https://blog.logrocket.com/wp-content/uploads/2020/11/post-request-in-postman.png 720w, https://blog.logrocket.com/wp-content/uploads/2020/11/post-request-in-postman-300x183.png 300w" sizes="(max-width: 720px) 100vw, 720px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/11/post-request-in-postman.png"/></noscript>
<p>发出请求后，您可以打开收件人邮件以确认邮件已发送。</p>
<p><img data-attachment-id="29709" data-permalink="https://blog.logrocket.com/using-denos-smtp-client/testing-deno-stmp-client/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/11/testing-deno-stmp-client.png" data-orig-size="720,155" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Testing Deno’s STMP client" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/11/testing-deno-stmp-client-300x65.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/11/testing-deno-stmp-client.png" decoding="async" class="aligncenter size-full wp-image-29709 jetpack-lazy-image" src="../Images/68bc0174304303745f2196d986d1bd8d.png" alt="Testing Deno's STMP Client" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2020/11/testing-deno-stmp-client.png 720w, https://blog.logrocket.com/wp-content/uploads/2020/11/testing-deno-stmp-client-300x65.png 300w" data-lazy-sizes="(max-width: 720px) 100vw, 720px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2020/11/testing-deno-stmp-client.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/11/testing-deno-stmp-client.png"/></p><noscript><img data-lazy-fallback="1" data-attachment-id="29709" data-permalink="https://blog.logrocket.com/using-denos-smtp-client/testing-deno-stmp-client/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/11/testing-deno-stmp-client.png" data-orig-size="720,155" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Testing Deno’s STMP client" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/11/testing-deno-stmp-client-300x65.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/11/testing-deno-stmp-client.png" decoding="async" loading="lazy" class="aligncenter size-full wp-image-29709" src="../Images/68bc0174304303745f2196d986d1bd8d.png" alt="Testing Deno's STMP Client" srcset="https://blog.logrocket.com/wp-content/uploads/2020/11/testing-deno-stmp-client.png 720w, https://blog.logrocket.com/wp-content/uploads/2020/11/testing-deno-stmp-client-300x65.png 300w" sizes="(max-width: 720px) 100vw, 720px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/11/testing-deno-stmp-client.png"/></noscript>
<h2 id="conclusion">结论</h2>
<p>使用Deno SMTP客户端发送消息非常容易。此模块的常见用例包括向订阅者发送时事通讯和发送模板化的电子邮件。</p>
<p>在本教程中，我们介绍了如何为Gmail和其他邮件提供商设置SMTP配置，以及如何向用户发送动态邮件。为了提高安全性，将敏感的配置细节存储在环境变量中始终是一个好的做法。</p>
<p>前往<a href="https://github.com/Wisdom132/deno/tree/master/smtp" target="_blank" rel="noopener noreferrer"> GitHub </a>获取本教程中使用的完整源代码。</p><div class="code-block code-block-1">
<div class="blog-plug base-cta"><h2>使用<a class="signup" href="https://lp.logrocket.com/blg/signup" target="_blank" rel="noopener noreferrer"> LogRocket </a>消除传统错误报告的干扰</h2>
<a href="https://lp.logrocket.com/blg/signup" class="signup" target="_blank" rel="noopener noreferrer"><img class="alignnone size-full wp-image-46 jetpack-lazy-image" src="../Images/d6f5a5dd739296c1dd7aab3d5e77eeb9.png" alt="LogRocket Dashboard Free Trial Banner" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2017/03/1d0cd-1s_rmyo6nbrasp-xtvbaxfg.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2017/03/1d0cd-1s_rmyo6nbrasp-xtvbaxfg.png"/><noscript><img data-lazy-fallback="1" class="alignnone size-full wp-image-46" src="../Images/d6f5a5dd739296c1dd7aab3d5e77eeb9.png" alt="LogRocket Dashboard Free Trial Banner" data-original-src="https://blog.logrocket.com/wp-content/uploads/2017/03/1d0cd-1s_rmyo6nbrasp-xtvbaxfg.png"/></noscript></a>
<p><a href="https://lp.logrocket.com/blg/signup" target="_blank" rel="noopener noreferrer"> LogRocket </a>是一个数字体验分析解决方案，它可以保护您免受数百个假阳性错误警报的影响，只针对几个真正重要的项目。LogRocket会告诉您应用程序中实际影响用户的最具影响力的bug和UX问题。</p>
<p>然后，使用具有深层技术遥测的会话重放来确切地查看用户看到了什么以及是什么导致了问题，就像你在他们身后看一样。</p>
<p>LogRocket自动聚合客户端错误、JS异常、前端性能指标和用户交互。然后LogRocket使用机器学习来告诉你哪些问题正在影响大多数用户，并提供你需要修复它的上下文。</p>
<p>关注重要的bug—<a class="signup" href="https://lp.logrocket.com/blg/signup-issue-free" target="_blank" rel="noopener noreferrer">今天就试试LogRocket】。</a></p></div></div>

<p class="clearfix"/>
<p class="clearfix"/>
</article>

</div>    
</body>
</html>