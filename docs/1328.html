<html>
<head>
<title>Building an authentication API with NextAuth.js - LogRocket Blog</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>用NextAuth.js构建认证API</h1>
<blockquote>原文：<a href="https://blog.logrocket.com/building-authentication-api-nextauth-js/#0001-01-01">https://blog.logrocket.com/building-authentication-api-nextauth-js/#0001-01-01</a></blockquote><div><article class="article-post">
<p><em> <strong>编者按:</strong>这篇文章在2021年8月更新了相关信息，解决了开发人员在使用GitLab OAuth以及使用NextAuth.js命名文件以创建动态API路径时遇到的常见错误。</em></p>
<p>认证是证明某人是他们所说的那个人的行为，例如在应用程序中确认用户的身份。在本教程中，我们将学习如何使用<a href="https://next-auth.js.org/" target="_blank" rel="noopener noreferrer"> NextAuth.js </a>在<a href="https://nextjs.org/" target="_blank" rel="noopener noreferrer"> Next.js </a>应用中实现认证。</p>
<h2>什么是NextAuth.js？</h2>
<p>NextAuth.js是一个库，专门用于处理Next.js应用程序中的身份验证解决方案。根据<a href="https://next-auth.js.org/getting-started/introduction" target="_blank" rel="noopener noreferrer">文档</a>，“NextAuth.js是针对Next.js应用的完整开源认证解决方案。它被从头设计来支持Next.js和<a href="https://www.serverless.com/" target="_blank" rel="noopener noreferrer">无服务器</a>。”</p>
<h2>为Next.js构建身份验证API的先决条件</h2>
<p>要跟随本教程，您需要以下内容:</p>
<ul>
<li>基本了解<a href="https://reactjs.org/" target="_blank" rel="noopener noreferrer">反应</a></li>
<li>对<a href="https://www.mongodb.com/" target="_blank" rel="noopener noreferrer"> MongoDB </a>或任何其他数据库有基本的了解</li>
<li>对身份验证工作原理的基本理解</li>
</ul>
<p>美好的未来:</p>
<ul>
<li>以前使用Next.js框架的经验</li>
</ul>
<h2>用NextAuth.js构建身份验证API</h2>
<p>在本教程中，我们将使用内置的Next.js API路由构建一个基本的身份验证API。认证将包括一个无密码的电子邮件登录和谷歌开放认证。然后，我们将研究如何保护API端点和受保护的页面。</p>
<p>本教程中编写的所有代码都可以在这个GitHub <a href="https://github.com/francisudeji/authentication-for-nextjs-serverless" target="_blank" rel="noopener noreferrer">资源库</a>上获得。</p>
<h3>搭建应用程序</h3>
<p>Next.js有一个方便的CLI，我们可以用它来生成一个启动项目。首先，全局安装CLI:</p>
<pre>npm install -g create-next-app
</pre>
<p>现在，创建新的Next.js应用程序:</p>
<pre>create-next-app next-authentication
</pre>
<p>当提示选择模板时，选择<strong>默认启动应用</strong>选项并点击<strong>回车</strong>继续。</p>
<p>现在将目录更改为新创建的项目文件夹:</p>
<pre>cd next-authentication
</pre>
<p>然后，启动开发服务器:</p>
<pre>yarn dev
</pre>
<p>这应该会在<code><a href="http://localhost:3000" rel="nofollow">http://localhost:3000</a></code>启动开发服务器。</p>
<h3>在Next.js中创建环境变量</h3>
<p>因为我们将使用几个凭证，所以我们需要隐藏它们。在名为<code>.env.local</code>的项目文件夹的根目录下创建一个新文件，并粘贴到以下代码片段中:</p>
<pre>NEXTAUTH_URL=http://localhost:3000
</pre>
<p>请注意，这与我们的开发服务器的URL相同。如果你的在另一个端口上运行，那么就替换它。随着我们的进展，我们将填充这个文件。</p>
<h2>设置NextAuth.js</h2>
<p>在这一步，我们将安装<code>next-auth</code>依赖项并使用API路由。Next.js中的API路由允许我们在不创建定制服务器的情况下创建API端点。</p>
<p>API路由在开发过程中运行在一个服务器上，并且在部署时，被部署为彼此独立运行的无服务器功能。在<a href="https://nextjs.org/docs/api-routes/introduction" target="_blank" rel="noopener noreferrer">文档</a>中了解更多关于API路由的信息。</p>
<h3>安装<code>next-auth</code>依赖项</h3>
<p>通过运行下面的代码片段安装<code>next-auth</code>:</p>
<pre>yarn add next-auth
npm install next-auth</pre>
<h3>创建动态API路由</h3>
<p>在<code>pages/api/auth</code>中创建一个名为<code>[…nextauth].js</code>的新文件，并将这段代码粘贴到新创建的文件中:</p>
<pre>// pages/api/auth/[...nextauth].js
import NextAuth from 'next-auth'

const options = {
  site: process.env.NEXTAUTH_URL
}

export default (req, res) =&gt; NextAuth(req, res, options)</pre>
<p>确保您已经将文件命名为<code>[...nextauth.js]</code>而不是<code>[...nextAuth.js]</code>。如果你这样做，你会收到一个<code>undefined</code>错误。注意我们是如何在方括号中的动态API路由名称中使用spread操作符的。那是因为在后台，所有对<code>/api/auth/*</code>的请求(签到、回叫、签出等。)，会自动由NextAuth.js处理。</p>
<p>NextAuth.js使用<code>site</code>选项作为基本URL，因此所有重定向和回调URL都将使用<code><a href="http://localhost:3000" rel="nofollow">http://localhost:3000</a></code>作为它们的基本URL。例如，在生产中，这应该替换为您网站的基本URL。</p>
<h3>使用NextAuth.js <code>&lt;Provider&gt;</code></h3>
<p>根据<a href="https://next-auth.js.org/getting-started/client" target="_blank" rel="noopener noreferrer">文档</a>:<span>使用提供的React </span> <code>&lt;Provider&gt;</code> <span>允许</span> <code>useSession()</code> <span>的实例通过使用</span> <a href="https://reactjs.org/docs/context.html" target="_blank" rel="noopener noreferrer"> React上下文</a> <span>跨组件共享会话对象。这提高了性能，减少了网络调用，并避免了呈现时的页面闪烁。强烈建议您使用</span> <code>pages/_app.js</code> <span>将其轻松添加到Next.js应用程序的所有页面中。”</span></p>
<p>所以现在，打开<code>pages/_app.js</code>并用下面的代码片段替换它:</p>
<pre>// pages/_app.js
import { Provider } from 'next-auth/client'

export default function App({ Component, pageProps }) {
  return (
    &lt;Provider session={pageProps.session}&gt;
      &lt;Component {...pageProps} /&gt;
    &lt;/Provider&gt;
  )
}
</pre>
<p>在这段代码中，我们用来自NextAuth.js的<code>Provider</code>组件包装了我们的应用程序，并传入了会话页面属性。这是为了避免在支持服务器端和客户端呈现的页面上检查会话两次。</p>
<h2>使用电子邮件地址登录</h2>
<p>为了让电子邮件登录工作，我们需要一个数据库来存储用户信息。如前所述，我们将使用MongoDB作为数据库选择，但也可以随意使用任何其他数据库。</p>
<blockquote><p>注意:如果使用电子邮件登录，NextAuth.js需要一个数据库。但是，对于OAuth，不需要数据库。</p></blockquote>
<h3>创建MongoDB数据库</h3>
<p>因为我们将使用MongoDB，所以我们可以通过运行以下代码片段来创建数据库:</p>
<p>输入MongoDB shell:</p>
<pre>mongosh
</pre>
<p>创建一个名为<code>nextauth</code>的新数据库:</p>
<pre>use nextauth
</pre>
<h3>添加用于身份验证的数据库凭据</h3>
<p>我们的数据库连接字符串应该如下所示:</p>
<pre>mongodb://localhost:27017/nextauth.</pre>
<p>现在打开<code>.env.local</code>文件并添加以下代码片段:</p>
<pre>DATABASE_URL=mongodb://localhost:27017/nextauth
</pre>
<p>数据库工作所需的最后一部分是数据库驱动程序。幸运的是，我们现在需要做的就是安装<code>mongodb</code>作为一个依赖项:</p>
<pre>yarn add mongodb
npm install mongodb</pre>
<p>如果您使用任何其他数据库，请通过链接中的<a href="https://next-auth.js.org/configuration/databases" target="_blank" rel="noopener noreferrer">安装适当的数据库驱动程序。</a></p>
<h3>将<code>Providers</code>添加到NextAuth.js</h3>
<p>NextAuth.js有一个提供者的概念，它定义了可以用来登录的服务，比如email或者OAuth。</p>
<p>首先，导入<code>Providers</code>模块，并用<code>pages/api/auth/[…nextauth].js</code>中的以下代码片段替换options对象:</p>
<pre>// pages/api/auth/[…nextauth].js
// ...other imports
import Providers from 'next-auth/providers'

const options = {
  site: process.env.NEXTAUTH_URL,
  providers: [
    Providers.Email({
      server: {
        port: 465,
        host: 'smtp.gmail.com',
        secure: true,
        auth: {
          user: process.env.EMAIL_USERNAME,
          pass: process.env.EMAIL_PASSWORD,
        },
        tls: {
          rejectUnauthorized: false,
        },
      },
      from: process.env.EMAIL_FROM,
    })
  ],
  database: process.env.DATABASE_URL
}
</pre>
<p>让我们来分解一下这些新变化是什么:</p>
<p>首先，我们导入了<code>Providers</code>模块，它让我们能够访问NextAuth.js支持的不同提供者。接下来，我们引入了一个新的<code>providers</code>选项，这是一个接受所有提供者列表的数组。现在，我们通过了<code>Email</code>提供者以及一些关于我们电子邮件服务器的选项。</p>
<p>电子邮件提供者接受连接字符串或配置对象，类似于使用<a href="https://nodemailer.com/about/" target="_blank" rel="noopener noreferrer"> Nodemailer </a>根据上面传递的凭证发送确认电子邮件。</p>
<p>点击了解更多关于<a href="https://next-auth.js.org/providers/email" target="_blank" rel="noopener noreferrer">配置电子邮件提供商的信息。</a></p>
<blockquote><p>注意:在上面的配置中，我使用的是我的Gmail账户。如果你选择使用你的，那么你可能需要<a href="https://support.google.com/accounts/answer/6010255?hl=en" target="_blank" rel="noopener noreferrer">启用不太安全的应用</a>。稍后，请求一个应用程序密码，以便您可以将您的Gmail帐户与NextAuth链接。如果没有，请从您的电子邮件服务器提供凭证。</p></blockquote>
<p>接下来，<code>database</code>选项接收到之前创建的数据库的连接字符串。</p>
<p>从上面的片段中，我们引用了一些新的变量，所以通过将这个片段粘贴到<code>.env.local</code>文件中来添加它们:</p>
<pre>EMAIL_FROM=YOUR NAME &lt;<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="6f16001a1d0a020e06032f0a170e021f030a410c0002">[email protected]</a>&gt;
<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="5b1e161a1217040e081e09151a161e6622342e293e363a32371b3e233a362b373e75383436">[email protected]</a>
EMAIL_PASSWORD=your_app_password
</pre>
<p>此时，我们需要重启服务器，让这些新的环境变量生效。完成后，我们需要导航到<code><a href="http://localhost:3000/api/auth/signin" rel="nofollow">http://localhost:3000/api/auth/signin</a></code>来查看登录屏幕。</p>
<p>它应该是这样的:</p>
<p><img data-attachment-id="64380" data-permalink="https://blog.logrocket.com/building-authentication-api-nextauth-js/localhost-authentication-signin-email-e1605713111173/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/12/localhost-authentication-signin-email-e1605713111173.png" data-orig-size="730,389" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="localhost-authentication-signin-email-e1605713111173" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/12/localhost-authentication-signin-email-e1605713111173-300x160.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/12/localhost-authentication-signin-email-e1605713111173.png" decoding="async" class="aligncenter size-full wp-image-64380 jetpack-lazy-image" src="../Images/c6488dc3a707b448fa4ee5a3908d415b.png" alt="nextjs authentication localhost" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2020/12/localhost-authentication-signin-email-e1605713111173.png 730w, https://blog.logrocket.com/wp-content/uploads/2020/12/localhost-authentication-signin-email-e1605713111173-300x160.png 300w" data-lazy-sizes="(max-width: 730px) 100vw, 730px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2020/12/localhost-authentication-signin-email-e1605713111173.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/12/localhost-authentication-signin-email-e1605713111173.png"/></p>
<p>默认情况下，NextAuth.js附带了一个最小化的UI，该UI根据配置期间提供的身份验证提供者显示登录选项。</p><noscript><img data-lazy-fallback="1" data-attachment-id="64380" data-permalink="https://blog.logrocket.com/building-authentication-api-nextauth-js/localhost-authentication-signin-email-e1605713111173/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/12/localhost-authentication-signin-email-e1605713111173.png" data-orig-size="730,389" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="localhost-authentication-signin-email-e1605713111173" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/12/localhost-authentication-signin-email-e1605713111173-300x160.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/12/localhost-authentication-signin-email-e1605713111173.png" decoding="async" loading="lazy" class="aligncenter size-full wp-image-64380" src="../Images/c6488dc3a707b448fa4ee5a3908d415b.png" alt="nextjs authentication localhost" srcset="https://blog.logrocket.com/wp-content/uploads/2020/12/localhost-authentication-signin-email-e1605713111173.png 730w, https://blog.logrocket.com/wp-content/uploads/2020/12/localhost-authentication-signin-email-e1605713111173-300x160.png 300w" sizes="(max-width: 730px) 100vw, 730px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/12/localhost-authentication-signin-email-e1605713111173.png"/></noscript>
<p>提交表单后，我们应该被重定向到成功页面，并收到一封带有验证令牌的电子邮件(如果这是首次使用该电子邮件登录)。如果没有，我们将收到一个登录电子邮件链接。</p>
<p>成功页面应该是这样的:</p>
<p><img data-attachment-id="29177" data-permalink="https://blog.logrocket.com/building-authentication-api-nextauth-js/authentication-signin-redirected-success-page/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/11/authentication-signin-redirected-success-page-e1605713218263.png" data-orig-size="730,388" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="authentication-signin-redirected-success-page" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/11/authentication-signin-redirected-success-page-300x160.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/11/authentication-signin-redirected-success-page-1024x545.png" decoding="async" class="aligncenter size-full wp-image-29177 jetpack-lazy-image" src="../Images/34ff8763cc8f4eeed3aed5725527d645.png" alt="Authentication sign-in redirected success page" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2020/11/authentication-signin-redirected-success-page-e1605713218263.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/11/authentication-signin-redirected-success-page-e1605713218263.png"/></p>
<p>这是验证邮件的样子。</p><noscript><img data-lazy-fallback="1" data-attachment-id="29177" data-permalink="https://blog.logrocket.com/building-authentication-api-nextauth-js/authentication-signin-redirected-success-page/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/11/authentication-signin-redirected-success-page-e1605713218263.png" data-orig-size="730,388" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="authentication-signin-redirected-success-page" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/11/authentication-signin-redirected-success-page-300x160.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/11/authentication-signin-redirected-success-page-1024x545.png" decoding="async" loading="lazy" class="aligncenter size-full wp-image-29177" src="../Images/34ff8763cc8f4eeed3aed5725527d645.png" alt="Authentication sign-in redirected success page" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/11/authentication-signin-redirected-success-page-e1605713218263.png"/></noscript>
<p> </p>
<p><img data-attachment-id="64382" data-permalink="https://blog.logrocket.com/building-authentication-api-nextauth-js/authentication-verification-signin-email-e1605714616394/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/12/authentication-verification-signin-email-e1605714616394.png" data-orig-size="730,380" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="authentication-verification-signin-email-e1605714616394" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/12/authentication-verification-signin-email-e1605714616394-300x156.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/12/authentication-verification-signin-email-e1605714616394.png" decoding="async" class="aligncenter size-full wp-image-64382 jetpack-lazy-image" src="../Images/50025d24ec74b10b28ac71f28c51460a.png" alt="authorization NextAuth.js authentication verification message" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2020/12/authentication-verification-signin-email-e1605714616394.png 730w, https://blog.logrocket.com/wp-content/uploads/2020/12/authentication-verification-signin-email-e1605714616394-300x156.png 300w" data-lazy-sizes="(max-width: 730px) 100vw, 730px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2020/12/authentication-verification-signin-email-e1605714616394.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/12/authentication-verification-signin-email-e1605714616394.png"/></p>
<p>默认情况下，点击<strong>登录</strong>链接会将我们带到主页。</p><noscript><img data-lazy-fallback="1" data-attachment-id="64382" data-permalink="https://blog.logrocket.com/building-authentication-api-nextauth-js/authentication-verification-signin-email-e1605714616394/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/12/authentication-verification-signin-email-e1605714616394.png" data-orig-size="730,380" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="authentication-verification-signin-email-e1605714616394" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/12/authentication-verification-signin-email-e1605714616394-300x156.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/12/authentication-verification-signin-email-e1605714616394.png" decoding="async" loading="lazy" class="aligncenter size-full wp-image-64382" src="../Images/50025d24ec74b10b28ac71f28c51460a.png" alt="authorization NextAuth.js authentication verification message" srcset="https://blog.logrocket.com/wp-content/uploads/2020/12/authentication-verification-signin-email-e1605714616394.png 730w, https://blog.logrocket.com/wp-content/uploads/2020/12/authentication-verification-signin-email-e1605714616394-300x156.png 300w" sizes="(max-width: 730px) 100vw, 730px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/12/authentication-verification-signin-email-e1605714616394.png"/></noscript>
<p>在下一节中，我们将看看如何显示当前的用户信息。如果我们现在看一下我们的数据库，我们将看到一个新条目，其中包含有关登录用户的信息:</p>
<p><img data-attachment-id="29179" data-permalink="https://blog.logrocket.com/building-authentication-api-nextauth-js/authentication-database-signedin-user/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/11/authentication-database-signedin-user-e1605714736176.png" data-orig-size="730,279" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="authentication-database-signedin-user" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/11/authentication-database-signedin-user-300x115.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/11/authentication-database-signedin-user-1024x392.png" decoding="async" class="aligncenter size-full wp-image-29179 jetpack-lazy-image" src="../Images/45c3fa95240d8cd6e9e81e2893f51a0d.png" alt="authentication database for signed-in users" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2020/11/authentication-database-signedin-user-e1605714736176.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/11/authentication-database-signedin-user-e1605714736176.png"/></p>
<p>处理用户会话</p><noscript><img data-lazy-fallback="1" data-attachment-id="29179" data-permalink="https://blog.logrocket.com/building-authentication-api-nextauth-js/authentication-database-signedin-user/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/11/authentication-database-signedin-user-e1605714736176.png" data-orig-size="730,279" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="authentication-database-signedin-user" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/11/authentication-database-signedin-user-300x115.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/11/authentication-database-signedin-user-1024x392.png" decoding="async" loading="lazy" class="aligncenter size-full wp-image-29179" src="../Images/45c3fa95240d8cd6e9e81e2893f51a0d.png" alt="authentication database for signed-in users" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/11/authentication-database-signedin-user-e1605714736176.png"/></noscript>
<h2>在本节中，我们将使用会话数据来显示关于当前用户的信息。值得注意的是，默认情况下，NextAuth.js使用数据库会话进行电子邮件登录，使用<a href="https://jwt.io/" target="_blank" rel="noopener noreferrer"> JWT </a>进行OAuth。</h2>
<p>要在使用电子邮件登录时启用JWT，我们需要将该选项添加到API路由中。为此，将这个代码片段添加到<code>options</code>对象<code>in pages/api/[...nextauth].js</code>中:</p>
<p>这个选项告诉NextAuth.js使用JWT来存储用户会话，并且会话应该持续30天。有关可能选项的更多信息，请参考<a href="https://next-auth.js.org/configuration/options" target="_blank" rel="noopener noreferrer">文档</a>。</p>
<pre> session: {
  jwt: true,
  maxAge: 30 * 24 * 60 * 60 // the session will last 30 days
},
</pre>
<p>现在，要在我们的应用程序中获取会话数据，我们要么选择在客户端使用<code>useSession</code>钩子，要么在服务器端使用<code>getSession</code>函数。</p>
<p>接下来，打开<code>pages/index.js</code>，用下面的代码片段替换当前内容:</p>
<p>在这个代码片段中，我们导入了几个函数:<code>signIn</code>、<code>signOut</code>和<code>useSession</code>。正如您可能已经猜到的，前两个用于登录用户和注销已登录的用户。</p>
<pre>// pages/index.js
import { signIn, signOut, useSession } from 'next-auth/client'

export default function Page() {
  const [session, loading] = useSession()

  if (loading) {
    return &lt;p&gt;Loading...&lt;/p&gt;
  }

  return (
    &lt;&gt;
      {!session &amp;&amp; (
        &lt;&gt;
          Not signed in &lt;br /&gt;
          &lt;button onClick={signIn}&gt;Sign in&lt;/button&gt;
        &lt;/&gt;
      )}
      {session &amp;&amp; (
        &lt;&gt;
          Signed in as {session.user.email} &lt;br /&gt;
          &lt;button onClick={signOut}&gt;Sign out&lt;/button&gt;
        &lt;/&gt;
      )}
    &lt;/&gt;
  )
}
</pre>
<p><code>useSession</code>钩子返回一个包含<code>session</code>和<code>loading</code>状态的元组。我们使用加载状态来显示加载文本，并根据用户当前是否登录，有条件地呈现登录或注销按钮以及用户数据。</p>
<p>以下是登录用户和未登录用户的主页预览:</p>
<p>Next.js中受保护的路线</p>
<p>现在我们已经实现了电子邮件登录，我们可以使用用户会话来授权或拒绝对任何页面的访问。我们也可以选择在服务器上或者在客户端上做这件事。</p>
<figure id="attachment_64392" aria-describedby="caption-attachment-64392" class="wp-caption aligncenter"><img data-attachment-id="64392" data-permalink="https://blog.logrocket.com/building-authentication-api-nextauth-js/authentication-signedin-user1-e1605714898330-2/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/12/authentication-signedin-user1-e1605714898330-1.png" data-orig-size="730,391" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="authentication-signedin-user1-e1605714898330" data-image-description="" data-image-caption="&lt;p&gt;View of an authenticated user&lt;/p&gt;&#10;" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/12/authentication-signedin-user1-e1605714898330-1-300x161.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/12/authentication-signedin-user1-e1605714898330-1.png" decoding="async" class="wp-image-64392 size-full jetpack-lazy-image" src="../Images/01993ec09bd9f9f31edcaa8fb956de17.png" alt="authentication signed in user view" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2020/12/authentication-signedin-user1-e1605714898330-1.png 730w, https://blog.logrocket.com/wp-content/uploads/2020/12/authentication-signedin-user1-e1605714898330-1-300x161.png 300w" data-lazy-sizes="(max-width: 730px) 100vw, 730px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2020/12/authentication-signedin-user1-e1605714898330-1.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/12/authentication-signedin-user1-e1605714898330-1.png"/><noscript><img data-lazy-fallback="1" data-attachment-id="64392" data-permalink="https://blog.logrocket.com/building-authentication-api-nextauth-js/authentication-signedin-user1-e1605714898330-2/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/12/authentication-signedin-user1-e1605714898330-1.png" data-orig-size="730,391" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="authentication-signedin-user1-e1605714898330" data-image-description="" data-image-caption="&lt;p&gt;View of an authenticated user&lt;/p&gt;&#10;" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/12/authentication-signedin-user1-e1605714898330-1-300x161.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/12/authentication-signedin-user1-e1605714898330-1.png" decoding="async" loading="lazy" class="wp-image-64392 size-full" src="../Images/01993ec09bd9f9f31edcaa8fb956de17.png" alt="authentication signed in user view" srcset="https://blog.logrocket.com/wp-content/uploads/2020/12/authentication-signedin-user1-e1605714898330-1.png 730w, https://blog.logrocket.com/wp-content/uploads/2020/12/authentication-signedin-user1-e1605714898330-1-300x161.png 300w" sizes="(max-width: 730px) 100vw, 730px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/12/authentication-signedin-user1-e1605714898330-1.png"/></noscript><figcaption id="caption-attachment-64392" class="wp-caption-text">View of an authenticated user</figcaption></figure>
<p>服务器端保护</p>
<figure id="attachment_29182" aria-describedby="caption-attachment-29182" class="wp-caption aligncenter"><img data-attachment-id="29182" data-permalink="https://blog.logrocket.com/building-authentication-api-nextauth-js/authentication-signedout-user/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/11/authentication-signedout-user-e1605714920280.png" data-orig-size="730,388" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="authentication-signedout-user" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/11/authentication-signedout-user-300x159.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/11/authentication-signedout-user-1024x544.png" decoding="async" class="wp-image-29182 size-full jetpack-lazy-image" src="../Images/5c55f86a137b7fbfbeb797ad198c5954.png" alt="authentication signed out user" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2020/11/authentication-signedout-user-e1605714920280.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/11/authentication-signedout-user-e1605714920280.png"/><noscript><img data-lazy-fallback="1" data-attachment-id="29182" data-permalink="https://blog.logrocket.com/building-authentication-api-nextauth-js/authentication-signedout-user/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/11/authentication-signedout-user-e1605714920280.png" data-orig-size="730,388" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="authentication-signedout-user" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/11/authentication-signedout-user-300x159.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/11/authentication-signedout-user-1024x544.png" decoding="async" loading="lazy" class="wp-image-29182 size-full" src="../Images/5c55f86a137b7fbfbeb797ad198c5954.png" alt="authentication signed out user" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/11/authentication-signedout-user-e1605714920280.png"/></noscript><figcaption id="caption-attachment-29182" class="wp-caption-text">View of an unauthenticated user</figcaption></figure>
<h2>为了利用SSR的路由保护，我们可以使用<code>getSession</code>函数。首先，在<code>pages</code>文件夹中创建一个名为<code>dashboard.js</code>的新文件，并粘贴以下代码片段:</h2>
<p>为了在Next.js中呈现页面，我们需要导出一个名为<code>getServerSideProps</code>的<code>async</code>函数。这个函数接收一个上下文参数，通过将上下文传递给<code>getSession</code>函数，我们得到了会话。要在接下来了解更多关于SSR的内容，请阅读<a href="https://nextjs.org/docs/basic-features/data-fetching#getserversideprops-server-side-rendering" target="_blank" rel="noopener noreferrer">文档</a>。</p>
<h3>如果没有会话，我们简单地将用户重定向回主页，否则我们返回一个带有<code>user</code>属性的对象。这包含用户信息，如他们的电子邮件和全名。</h3>
<p>最后，在<code>Dashboard</code>组件上，我们访问了包含用户数据的<code>user</code>属性。</p>
<pre>// pages/dashboard.js
import { getSession } from 'next-auth/client'

export default function Dashboard({ user }) {
  return (
    &lt;div&gt;
      &lt;h1&gt;Dashboard&lt;/h1&gt;
      &lt;p&gt;Welcome {user.email}&lt;/p&gt;
    &lt;/div&gt;
  )
}

export async function getServerSideProps(ctx) {
  const session = await getSession(ctx)
  //if no session found(user hasn’t logged in)  if (!session) {
    return {
     redirect: {
     destination: ‘/’, //redirect user to homepage
     permanent: false,
     }
    }
   }
  return {
    props: {
      user: session.user,
    },
  }
}
</pre>
<p>客户端保护</p>
<p>首先，在<code>pages</code>文件夹中创建一个名为<code>profile.js</code>的新文件，并粘贴以下代码片段:</p>
<p>这有点类似于我们在<code>pages/index.js</code>文件中的内容，但是这一次，我们通过延迟加载<code>AuthenticatedComponent</code>和<code>UnauthenticatedComponent</code>来利用代码分割。</p>
<h3>下面是这段代码的概要:</h3>
<p>首先，我们导入了<code>useSession</code>钩子，然后我们在Next.js中导入了一个名为<code>dynamic</code>的特殊函数。这个函数使我们能够动态地导入任何组件。因为我们的应用程序总是处于两种状态之一——已验证或未验证——如果一次只使用一个组件，我们不需要导入两个组件。</p>
<pre>// pages/profile.js
import { useSession } from 'next-auth/client'
import dynamic from 'next/dynamic'

const UnauthenticatedComponent = dynamic(() =&gt;
  import('../components/unauthenticated')
)
const AuthenticatedComponent = dynamic(() =&gt;
  import('../components/authenticated')
)

export default function Profile() {
  const [session, loading] = useSession()

  if (typeof window !== 'undefined' &amp;&amp; loading) return &lt;p&gt;Loading...&lt;/p&gt;

  if (!session) return &lt;UnauthenticatedComponent /&gt;

  return &lt;AuthenticatedComponent user={session.user} /&gt;
}
</pre>
<p>接下来，我们析构了<code>session</code>和<code>loading</code>状态，并使用<code>session</code>来动态呈现DOM。</p>
<p>最后，我们在NextAuth.js仍在加载时呈现了一个加载文本，以及<code>AuthenticatedComponent</code>或<code>UnauthenticatedComponent</code>，这取决于我们是否有一个会话。</p>
<p>现在，创建一个名为<code>components</code>的新文件夹和两个文件:<code>authenticated.js</code>和<code>unauthenticated.js</code>。</p>
<p>在<code>authenticated.js</code>中，粘贴以下代码片段:</p>
<p>在<code>unauthenticated.js</code>文件中，粘贴以下代码片段:</p>
<p>在<code>components/authenticated.js</code>中，我们导入了<code>signOut</code>函数，并析构了从<code>pages/profile.js</code>传来的<code>user</code>道具。我们还显示了用户数据和注销用户的注销按钮。</p>
<p>在<code>components/unauthenticated.js</code>中，我们向用户显示了一条消息。当用户点击登录按钮时，我们调用上面导入的<code>signIn</code>函数。</p>
<pre>// components/authenticated.js
import { signOut } from 'next-auth/client'

export default function Authenticated({ user }) {
  return (
    &lt;div&gt;
      &lt;p&gt;You are authenticated {user.email}&lt;/p&gt;
      &lt;button onClick={signOut}&gt;Sign Out&lt;/button&gt;
    &lt;/div&gt;
  )
}
</pre>
<p>API路由保护</p>
<pre>// components/unauthenticated.js
import { signIn } from 'next-auth/client'

export default function Unauthenticated() {
  return (
    &lt;div&gt;
      &lt;p&gt;You are not authenticated&lt;/p&gt;
      &lt;button onClick={signIn}&gt;Sign In&lt;/button&gt;
    &lt;/div&gt;
  )
}
</pre>
<p>我们还可以将我们的认证服务扩展到Next.js的API路由。这将类似于我们对服务器端渲染所做的，对于只允许经过身份验证的用户访问API非常有用。</p>
<p>首先，在<code>pages/api</code>中创建一个名为<code>data.js</code>的新文件，并粘贴以下代码片段:</p>
<h3>任何导出默认<code>async</code>函数并在<code>page/api</code>文件夹中创建的文件都将自动成为API路径。在这种情况下，该文件将被映射到<code><a href="http://localhost:3000/api/data" rel="nofollow">http://localhost:3000/api/data</a></code>。</h3>
<p>在这个代码片段中，我们导入了<code>getSession</code>函数，并传入了从API route获取的请求对象。从那里，NextAuth.js负责读取cookies。最后，我们根据会话的可用性向用户返回一条消息。</p>
<p>为了测试这一点，我们可以创建一个对<code><a href="http://localhost:3000/api/data" rel="nofollow">http://localhost:3000/api/data</a></code>的<code>GET</code>请求来获得响应。</p>
<pre>// pages/api/data.js
import { getSession } from 'next-auth/client'

export default async (req, res) =&gt; {
  const session = await getSession({ req })

  if (session) {
    res.status(200).json({
      message: 'You can access this content because you are signed in.',
    })
  } else {
    res.status(403).json({
      message:
        'You must be sign in to view the protected content on this page.',
    })
  }
}
</pre>
<p>使用OAuth登录</p>
<p>NextAuth.js有许多现成的内置提供程序。与电子邮件提供商不同，我们不需要数据库来使用它们。在本节中，我们将在Google的开发人员控制台上创建一个应用程序，并获取我们的客户端ID和密码。</p>
<p>如果你已经熟悉在这些平台上创建应用，那么你可以跳到<a href="#handling-page-redirects">“处理页面重定向”</a>部分。</p>
<h2>使用Google登录</h2>
<p>要启用Google登录，我们需要在开发人员控制台上创建一个新项目，使用我们的Google帐户登录，并通过单击模式上的<strong>新项目</strong>按钮创建一个新应用程序。</p>
<p>它应该是这样的:</p>
<h3><img data-attachment-id="29185" data-permalink="https://blog.logrocket.com/building-authentication-api-nextauth-js/google-developer-console-new-project/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/11/google-developer-console-new-project-e1605715362311.png" data-orig-size="730,199" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="google developer console new project" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/11/google-developer-console-new-project-300x82.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/11/google-developer-console-new-project-1024x279.png" decoding="async" class="aligncenter size-full wp-image-29185 jetpack-lazy-image" src="../Images/8046bf2798b8cffdd814fc7a415d0f15.png" alt="Google developer console new project" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2020/11/google-developer-console-new-project-e1605715362311.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/11/google-developer-console-new-project-e1605715362311.png"/></h3>
<p>接下来，我们需要为我们的项目命名，并单击<strong> CREATE </strong>按钮:</p>
<p><img data-attachment-id="29186" data-permalink="https://blog.logrocket.com/building-authentication-api-nextauth-js/google-developer-console-project-name/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/11/google-developer-console-project-name-e1605715426419.png" data-orig-size="730,317" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="google-developer-console-project-name" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/11/google-developer-console-project-name-300x130.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/11/google-developer-console-project-name-1024x445.png" decoding="async" class="aligncenter size-full wp-image-29186 jetpack-lazy-image" src="../Images/760c140154b43ecf62f7be784f1ec5f1.png" alt="google developer console project name" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2020/11/google-developer-console-project-name-e1605715426419.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/11/google-developer-console-project-name-e1605715426419.png"/></p>
<p>接下来，点击<strong>配置同意屏幕</strong>按钮:</p><noscript><img data-lazy-fallback="1" data-attachment-id="29185" data-permalink="https://blog.logrocket.com/building-authentication-api-nextauth-js/google-developer-console-new-project/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/11/google-developer-console-new-project-e1605715362311.png" data-orig-size="730,199" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="google developer console new project" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/11/google-developer-console-new-project-300x82.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/11/google-developer-console-new-project-1024x279.png" decoding="async" loading="lazy" class="aligncenter size-full wp-image-29185" src="../Images/8046bf2798b8cffdd814fc7a415d0f15.png" alt="Google developer console new project" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/11/google-developer-console-new-project-e1605715362311.png"/></noscript>
<p><img data-attachment-id="29187" data-permalink="https://blog.logrocket.com/building-authentication-api-nextauth-js/google-developer-console-consent-screen/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/11/google-developer-console-consent-screen-e1605715473796.png" data-orig-size="730,336" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="google-developer-console-consent-screen" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/11/google-developer-console-consent-screen-300x138.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/11/google-developer-console-consent-screen-1024x471.png" decoding="async" class="aligncenter size-full wp-image-29187 jetpack-lazy-image" src="../Images/9db1e5349613ef44ecd8922c7dedaa6d.png" alt="google developer console consent screen" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2020/11/google-developer-console-consent-screen-e1605715473796.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/11/google-developer-console-consent-screen-e1605715473796.png"/></p>
<p>然后，勾选<strong>外部</strong>复选框，然后点击<strong>创建</strong>按钮。这是屏幕:</p><noscript><img data-lazy-fallback="1" data-attachment-id="29186" data-permalink="https://blog.logrocket.com/building-authentication-api-nextauth-js/google-developer-console-project-name/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/11/google-developer-console-project-name-e1605715426419.png" data-orig-size="730,317" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="google-developer-console-project-name" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/11/google-developer-console-project-name-300x130.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/11/google-developer-console-project-name-1024x445.png" decoding="async" loading="lazy" class="aligncenter size-full wp-image-29186" src="../Images/760c140154b43ecf62f7be784f1ec5f1.png" alt="google developer console project name" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/11/google-developer-console-project-name-e1605715426419.png"/></noscript>
<p><img data-attachment-id="29188" data-permalink="https://blog.logrocket.com/building-authentication-api-nextauth-js/google-developer-console-external-checkbox-screen/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/11/google-developer-console-external-checkbox-screen-e1605715514173.png" data-orig-size="730,372" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="google-developer-console-external-checkbox-screen" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/11/google-developer-console-external-checkbox-screen-300x153.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/11/google-developer-console-external-checkbox-screen-1024x522.png" decoding="async" class="aligncenter size-full wp-image-29188 jetpack-lazy-image" src="../Images/ff519a8af3629e30cfca1841d9d4ead3.png" alt="" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2020/11/google-developer-console-external-checkbox-screen-e1605715514173.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/11/google-developer-console-external-checkbox-screen-e1605715514173.png"/></p>
<p>下一步，我们需要给我们的应用命名。完成后，点击<strong>保存</strong>按钮。</p><noscript><img data-lazy-fallback="1" data-attachment-id="29187" data-permalink="https://blog.logrocket.com/building-authentication-api-nextauth-js/google-developer-console-consent-screen/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/11/google-developer-console-consent-screen-e1605715473796.png" data-orig-size="730,336" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="google-developer-console-consent-screen" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/11/google-developer-console-consent-screen-300x138.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/11/google-developer-console-consent-screen-1024x471.png" decoding="async" loading="lazy" class="aligncenter size-full wp-image-29187" src="../Images/9db1e5349613ef44ecd8922c7dedaa6d.png" alt="google developer console consent screen" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/11/google-developer-console-consent-screen-e1605715473796.png"/></noscript>
<p><img data-attachment-id="29189" data-permalink="https://blog.logrocket.com/building-authentication-api-nextauth-js/google-developer-console-application-name/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/11/google-developer-console-application-name-e1605715573585.png" data-orig-size="730,373" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="google developer console application name" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/11/google-developer-console-application-name-300x153.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/11/google-developer-console-application-name-1024x523.png" decoding="async" class="aligncenter size-full wp-image-29189 jetpack-lazy-image" src="../Images/9972f199115218605b88070b2cf6034a.png" alt="google developer console application name" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2020/11/google-developer-console-application-name-e1605715573585.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/11/google-developer-console-application-name-e1605715573585.png"/></p>
<p>现在我们需要返回到凭证页面，点击<strong>创建凭证</strong>下拉按钮，并选择<strong> OAuth客户端ID </strong>:</p><noscript><img data-lazy-fallback="1" data-attachment-id="29188" data-permalink="https://blog.logrocket.com/building-authentication-api-nextauth-js/google-developer-console-external-checkbox-screen/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/11/google-developer-console-external-checkbox-screen-e1605715514173.png" data-orig-size="730,372" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="google-developer-console-external-checkbox-screen" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/11/google-developer-console-external-checkbox-screen-300x153.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/11/google-developer-console-external-checkbox-screen-1024x522.png" decoding="async" loading="lazy" class="aligncenter size-full wp-image-29188" src="../Images/ff519a8af3629e30cfca1841d9d4ead3.png" alt="" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/11/google-developer-console-external-checkbox-screen-e1605715514173.png"/></noscript>
<p><img data-attachment-id="29190" data-permalink="https://blog.logrocket.com/building-authentication-api-nextauth-js/google-developer-console-oauth-client-id/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/11/google-developer-console-oauth-client-id-e1605715635540.png" data-orig-size="730,369" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="google-developer-console-oauth-client-id" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/11/google-developer-console-oauth-client-id-300x152.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/11/google-developer-console-oauth-client-id-1024x518.png" decoding="async" class="aligncenter size-full wp-image-29190 jetpack-lazy-image" src="../Images/b1cd7406a066ae8bbed5164cef1e3db6.png" alt="google console developer oauth id" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2020/11/google-developer-console-oauth-client-id-e1605715635540.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/11/google-developer-console-oauth-client-id-e1605715635540.png"/></p>
<p>选择<strong> Web应用</strong>作为应用类型:</p><noscript><img data-lazy-fallback="1" data-attachment-id="29189" data-permalink="https://blog.logrocket.com/building-authentication-api-nextauth-js/google-developer-console-application-name/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/11/google-developer-console-application-name-e1605715573585.png" data-orig-size="730,373" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="google developer console application name" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/11/google-developer-console-application-name-300x153.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/11/google-developer-console-application-name-1024x523.png" decoding="async" loading="lazy" class="aligncenter size-full wp-image-29189" src="../Images/9972f199115218605b88070b2cf6034a.png" alt="google developer console application name" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/11/google-developer-console-application-name-e1605715573585.png"/></noscript>
<p><img data-attachment-id="29191" data-permalink="https://blog.logrocket.com/building-authentication-api-nextauth-js/google-developer-console-oauth-web-application-type/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/11/google-developer-console-oauth-web-application-type-e1605715716572.png" data-orig-size="730,372" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="google-developer-console-oauth-web-application-type" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/11/google-developer-console-oauth-web-application-type-300x153.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/11/google-developer-console-oauth-web-application-type-1024x522.png" decoding="async" class="aligncenter wp-image-29191 size-full jetpack-lazy-image" src="../Images/816df61ec1072370db17d421f55b4cd9.png" alt="google developer search console oauth web application type" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2020/11/google-developer-console-oauth-web-application-type-e1605715716572.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/11/google-developer-console-oauth-web-application-type-e1605715716572.png"/></p>
<p>像下面的截图一样填写表格:</p><noscript><img data-lazy-fallback="1" data-attachment-id="29190" data-permalink="https://blog.logrocket.com/building-authentication-api-nextauth-js/google-developer-console-oauth-client-id/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/11/google-developer-console-oauth-client-id-e1605715635540.png" data-orig-size="730,369" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="google-developer-console-oauth-client-id" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/11/google-developer-console-oauth-client-id-300x152.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/11/google-developer-console-oauth-client-id-1024x518.png" decoding="async" loading="lazy" class="aligncenter size-full wp-image-29190" src="../Images/b1cd7406a066ae8bbed5164cef1e3db6.png" alt="google console developer oauth id" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/11/google-developer-console-oauth-client-id-e1605715635540.png"/></noscript>
<p><img data-attachment-id="29192" data-permalink="https://blog.logrocket.com/building-authentication-api-nextauth-js/google-developer-console-form-fill/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/11/google-developer-console-form-fill-e1605715779525.png" data-orig-size="730,374" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="google-developer-console-form-fill" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/11/google-developer-console-form-fill-300x154.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/11/google-developer-console-form-fill-1024x524.png" decoding="async" class="aligncenter size-full wp-image-29192 jetpack-lazy-image" src="../Images/5238d0794c76f71f575af8486e31e897.png" alt="google developer search console form fill" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2020/11/google-developer-console-form-fill-e1605715779525.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/11/google-developer-console-form-fill-e1605715779525.png"/></p>
<p>这里，我们添加了应用程序的基本URL和NextAuth.js为Google OAuth期望的回调URL。使用另一个类似GitHub的服务意味着我们需要用“/callback/github”替换“/callback/google”</p><noscript><img data-lazy-fallback="1" data-attachment-id="29191" data-permalink="https://blog.logrocket.com/building-authentication-api-nextauth-js/google-developer-console-oauth-web-application-type/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/11/google-developer-console-oauth-web-application-type-e1605715716572.png" data-orig-size="730,372" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="google-developer-console-oauth-web-application-type" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/11/google-developer-console-oauth-web-application-type-300x153.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/11/google-developer-console-oauth-web-application-type-1024x522.png" decoding="async" loading="lazy" class="aligncenter wp-image-29191 size-full" src="../Images/816df61ec1072370db17d421f55b4cd9.png" alt="google developer search console oauth web application type" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/11/google-developer-console-oauth-web-application-type-e1605715716572.png"/></noscript>
<p>点击<strong> CREATE </strong>按钮后，会弹出一个带有我们凭证的模态，如下所示:</p>
<p><img data-attachment-id="29193" data-permalink="https://blog.logrocket.com/building-authentication-api-nextauth-js/google-developer-console-oauth-credentials/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/11/google-developer-console-oauth-credentials.png" data-orig-size="1366,694" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="google-developer-console-oauth-credentials" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/11/google-developer-console-oauth-credentials-300x152.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/11/google-developer-console-oauth-credentials-1024x520.png" decoding="async" class="aligncenter wp-image-29193 jetpack-lazy-image" src="../Images/5ecfeb1a8f8a217ecebcdaa554ff2c3b.png" alt="google developer console oauth credentials" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2020/11/google-developer-console-oauth-credentials.png 1366w, https://blog.logrocket.com/wp-content/uploads/2020/11/google-developer-console-oauth-credentials-300x152.png 300w, https://blog.logrocket.com/wp-content/uploads/2020/11/google-developer-console-oauth-credentials-1024x520.png 1024w, https://blog.logrocket.com/wp-content/uploads/2020/11/google-developer-console-oauth-credentials-768x390.png 768w" data-lazy-sizes="(max-width: 730px) 100vw, 730px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2020/11/google-developer-console-oauth-credentials.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/11/google-developer-console-oauth-credentials.png"/></p><noscript><img data-lazy-fallback="1" data-attachment-id="29192" data-permalink="https://blog.logrocket.com/building-authentication-api-nextauth-js/google-developer-console-form-fill/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/11/google-developer-console-form-fill-e1605715779525.png" data-orig-size="730,374" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="google-developer-console-form-fill" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/11/google-developer-console-form-fill-300x154.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/11/google-developer-console-form-fill-1024x524.png" decoding="async" loading="lazy" class="aligncenter size-full wp-image-29192" src="../Images/5238d0794c76f71f575af8486e31e897.png" alt="google developer search console form fill" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/11/google-developer-console-form-fill-e1605715779525.png"/></noscript>
<p>我们现在需要做的就是将这些作为环境变量添加进来，并注册一个新的提供者。</p>
<p>添加Google凭据</p>
<p>打开<code>.env.local</code> lo文件并粘贴以下代码片段:</p><noscript><img data-lazy-fallback="1" data-attachment-id="29193" data-permalink="https://blog.logrocket.com/building-authentication-api-nextauth-js/google-developer-console-oauth-credentials/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/11/google-developer-console-oauth-credentials.png" data-orig-size="1366,694" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="google-developer-console-oauth-credentials" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/11/google-developer-console-oauth-credentials-300x152.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/11/google-developer-console-oauth-credentials-1024x520.png" decoding="async" loading="lazy" class="aligncenter wp-image-29193" src="../Images/5ecfeb1a8f8a217ecebcdaa554ff2c3b.png" alt="google developer console oauth credentials" srcset="https://blog.logrocket.com/wp-content/uploads/2020/11/google-developer-console-oauth-credentials.png 1366w, https://blog.logrocket.com/wp-content/uploads/2020/11/google-developer-console-oauth-credentials-300x152.png 300w, https://blog.logrocket.com/wp-content/uploads/2020/11/google-developer-console-oauth-credentials-1024x520.png 1024w, https://blog.logrocket.com/wp-content/uploads/2020/11/google-developer-console-oauth-credentials-768x390.png 768w" sizes="(max-width: 730px) 100vw, 730px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/11/google-developer-console-oauth-credentials.png"/></noscript>
<p>添加新的提供程序</p>
<h3>打开<code>pages/api/auth/[nextauth].js</code>文件并将该代码片段添加到<code>providers</code>数组中:</h3>
<p>我们需要重新启动应用程序才能看到新的变化。重新启动后，我们的登录页面应该是这样的。</p>
<pre>GOOGLE_ID=YOUR_GOOGLE_ID
GOOGLE_SECRET=YOUR_GOOGLE_SECRET
</pre>
<h3><img data-attachment-id="29194" data-permalink="https://blog.logrocket.com/building-authentication-api-nextauth-js/google-developer-console-signin-page/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/11/google-developer-console-signin-page.png" data-orig-size="1366,700" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="google-developer-console-signin-page" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/11/google-developer-console-signin-page-300x154.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/11/google-developer-console-signin-page-1024x525.png" decoding="async" class="aligncenter wp-image-29194 jetpack-lazy-image" src="../Images/f00d1237c07a1f6e47850375395a6465.png" alt="google developer console signin page" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2020/11/google-developer-console-signin-page.png 1366w, https://blog.logrocket.com/wp-content/uploads/2020/11/google-developer-console-signin-page-300x154.png 300w, https://blog.logrocket.com/wp-content/uploads/2020/11/google-developer-console-signin-page-1024x525.png 1024w, https://blog.logrocket.com/wp-content/uploads/2020/11/google-developer-console-signin-page-768x394.png 768w" data-lazy-sizes="(max-width: 730px) 100vw, 730px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2020/11/google-developer-console-signin-page.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/11/google-developer-console-signin-page.png"/></h3>
<p> </p>
<pre> Providers.Google({
  clientId: process.env.GOOGLE_ID,
  clientSecret: process.env.GOOGLE_SECRET,
}),
</pre>
<p>有了这个，我们应该可以用我们的谷歌账户登录了。从现在开始，添加一个新的提供商应该像在平台上创建一个应用程序、获取凭证并将其添加到提供商列表中一样简单。</p>
<p>处理页面重定向</p><noscript><img data-lazy-fallback="1" data-attachment-id="29194" data-permalink="https://blog.logrocket.com/building-authentication-api-nextauth-js/google-developer-console-signin-page/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/11/google-developer-console-signin-page.png" data-orig-size="1366,700" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="google-developer-console-signin-page" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/11/google-developer-console-signin-page-300x154.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/11/google-developer-console-signin-page-1024x525.png" decoding="async" loading="lazy" class="aligncenter wp-image-29194" src="../Images/f00d1237c07a1f6e47850375395a6465.png" alt="google developer console signin page" srcset="https://blog.logrocket.com/wp-content/uploads/2020/11/google-developer-console-signin-page.png 1366w, https://blog.logrocket.com/wp-content/uploads/2020/11/google-developer-console-signin-page-300x154.png 300w, https://blog.logrocket.com/wp-content/uploads/2020/11/google-developer-console-signin-page-1024x525.png 1024w, https://blog.logrocket.com/wp-content/uploads/2020/11/google-developer-console-signin-page-768x394.png 768w" sizes="(max-width: 730px) 100vw, 730px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/11/google-developer-console-signin-page.png"/></noscript>
<p>Next.js提供了一种在我们的应用程序中定制回调的方法。其中一个回调是重定向回调。每当用户被重定向到回调时，例如登录和注销，都会调用这个函数。</p>
<p>但是我们为什么要关心这个呢？你有没有注意到我们每次登录，都会被重定向回主页？让我们把它改成我们之前创建的<code>/profile</code>页面。</p>
<h2 id="handling-page-redirects">为了处理这个问题，我们需要挂钩到NextAuth.js的'<code>callbacks</code>选项，并且只修改<code>redirect</code>函数。将这段代码添加到<code>pages/api/auth/[…nextauth].js</code>中的<code>options</code>对象中:</h2>
<p><code>redirect</code>函数有两个参数:<code>url</code>和<code>baseUrl</code>。但是对于这个例子，我们不关心第二个参数。这个函数也期望我们返回一个承诺。</p>
<p>现在，查看我们当前是否在登录页面上。如果是，那么我们需要去<code>/profile</code>页面，否则我们被送回签到页面。</p>
<p>常见问题</p>
<pre>// ...other options
callbacks: {
    redirect: async (url, baseUrl) =&gt; {
      if (url === '/api/auth/signin') {
        return Promise.resolve('/profile')
      }
      return Promise.resolve('/api/auth/signin')
    },
},
</pre>
<p>有时GitLab OAuth会给出回调错误。确保您已经在<a href="https://github.com/nextauthjs/next-auth/issues/285#issuecomment-646483474" target="_blank" rel="noopener"> <strong>应用</strong> </a>页面上启用了<code>read_user</code>和<code>email</code>范围。此外，确保您的GitLab配置与<a href="https://github.com/nextauthjs/next-auth/issues/285#issuecomment-646483474" target="_blank" rel="noopener"> NextAuth的配置</a>匹配。这将允许您为您的应用程序成功启用OAuth。如果还是不行，看本期GitHub的这个解决方案<a href="https://github.com/nextauthjs/next-auth/issues/285#issuecomment-646483474" target="_blank" rel="noopener">。</a></p>
<p>结论</p>
<h2>在本教程中，我们学习了如何在应用程序中使用Next.js和NextAuth.js实现电子邮件和OAuth身份验证。在这个过程中，我们使用会话数据来保护客户端和服务器端的页面。读完这篇文章后，希望在全新或现有的Next.js应用程序中添加身份验证现在是无缝的。</h2>
<p>NextAuth.js内置了许多本教程中没有涉及的特性。下一步要做的是添加更多的OAuth提供者，并遵循本指南定制登录页面的设计。</p>
<h2><a href="https://lp.logrocket.com/blg/nextjs-signup" target="_blank"> LogRocket </a>:全面了解生产Next.js应用</h2>
<p>调试下一个应用程序可能会很困难，尤其是当用户遇到难以重现的问题时。如果您对监视和跟踪状态、自动显示JavaScript错误、跟踪缓慢的网络请求和组件加载时间感兴趣，</p>
<p>. </p><div class="code-block code-block-30">
<div class="blog-plug inline-plug next-plug"><h2>LogRocket 就像是网络和移动应用的DVR，记录下你的Next.js应用上发生的一切。您可以汇总并报告问题发生时应用程序的状态，而不是猜测问题发生的原因。LogRocket还可以监控应用程序的性能，报告客户端CPU负载、客户端内存使用等指标。</h2><p>LogRocket Redux中间件包为您的用户会话增加了一层额外的可见性。LogRocket记录Redux存储中的所有操作和状态。</p><a href="https://lp.logrocket.com/blg/nextjs-signup" target="_blank">try LogRocket</a><p>让您调试Next.js应用的方式现代化— <a class="signup" href="https://lp.logrocket.com/blg/nextjs-signup" target="_blank" rel="noopener noreferrer">开始免费监控</a>。</p><a class="signup" href="https://lp.logrocket.com/blg/nextjs-signup" target="_blank" rel="noopener noreferrer"><img class="alignnone size-full wp-image-46 jetpack-lazy-image" src="../Images/f300c244a1a1cf916df8b4cb02bec6c6.png" data-lazy-src="https://files.readme.io/27c94e7-Image_2017-06-05_at_9.46.04_PM.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://files.readme.io/27c94e7-Image_2017-06-05_at_9.46.04_PM.png"/><noscript><img data-lazy-fallback="1" class="alignnone size-full wp-image-46" src="../Images/f300c244a1a1cf916df8b4cb02bec6c6.png" data-original-src="https://files.readme.io/27c94e7-Image_2017-06-05_at_9.46.04_PM.png"/></noscript></a><a class="signup" href="https://lp.logrocket.com/blg/nextjs-signup" target="_blank" rel="noopener noreferrer"><img class="alignnone size-full wp-image-46 jetpack-lazy-image" src="../Images/d6f5a5dd739296c1dd7aab3d5e77eeb9.png" alt="LogRocket Dashboard Free Trial Banner" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2017/03/1d0cd-1s_rmyo6nbrasp-xtvbaxfg.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2017/03/1d0cd-1s_rmyo6nbrasp-xtvbaxfg.png"/><noscript><img data-lazy-fallback="1" class="alignnone size-full wp-image-46" src="../Images/d6f5a5dd739296c1dd7aab3d5e77eeb9.png" alt="LogRocket Dashboard Free Trial Banner" data-original-src="https://blog.logrocket.com/wp-content/uploads/2017/03/1d0cd-1s_rmyo6nbrasp-xtvbaxfg.png"/></noscript></a><p><a href="https://lp.logrocket.com/blg/nextjs-signup" target="_blank" rel="noopener noreferrer">LogRocket</a> is like a DVR for web and mobile apps, recording literally everything that happens on your Next.js app. Instead of guessing why problems happen, you can aggregate and report on what state your application was in when an issue occurred. LogRocket also monitors your app's performance, reporting with metrics like client CPU load, client memory usage, and more.</p><p>The LogRocket Redux middleware package adds an extra layer of visibility into your user sessions. LogRocket logs all actions and state from your Redux stores. </p><p>Modernize how you debug your Next.js apps — <a class="signup" href="https://lp.logrocket.com/blg/nextjs-signup" target="_blank" rel="noopener noreferrer">start monitoring for free</a>.</p></div></div>

<p class="clearfix"/>
<p class="clearfix"/>
</article>

</div>    
</body>
</html>