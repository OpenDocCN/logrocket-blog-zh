<html>
<head>
<title>Making a chat app with Dapr - LogRocket Blog</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>用Dapr - LogRocket Blog制作聊天应用</h1>
<blockquote>原文：<a href="https://blog.logrocket.com/making-a-chat-app-with-dapr/#0001-01-01">https://blog.logrocket.com/making-a-chat-app-with-dapr/#0001-01-01</a></blockquote><div><article class="article-post">
<h2>介绍</h2>
<p>分布式应用运行时(<a href="https://dapr.io/" target="_blank" rel="noopener noreferrer"> Dapr </a>)是由<a href="https://cloudblogs.microsoft.com/opensource/2019/10/16/announcing-dapr-open-source-project-build-microservice-applications/" target="_blank" rel="noopener noreferrer">微软</a>开发的开源项目。它是一个事件驱动的可移植运行时，旨在简化开发人员构建微服务应用程序。Dapr由标准HTTP或gRPC APIs访问的几个构建块组成，可以从各种编程语言中调用。</p>
<figure id="attachment_20174" aria-describedby="caption-attachment-20174" class="wp-caption aligncenter"><img data-attachment-id="20174" data-permalink="https://blog.logrocket.com/making-a-chat-app-with-dapr/dapr/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/06/dapr.png" data-orig-size="730,347" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="dapr" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/06/dapr-300x143.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/06/dapr.png" decoding="async" class="wp-image-20174 size-full jetpack-lazy-image" src="../Images/f7c0487fe3796a7ee3f710011ee6070d.png" alt="Dapr layout" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2020/06/dapr.png 730w, https://blog.logrocket.com/wp-content/uploads/2020/06/dapr-300x143.png 300w" data-lazy-sizes="(max-width: 730px) 100vw, 730px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2020/06/dapr.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/06/dapr.png"/><noscript><img data-lazy-fallback="1" data-attachment-id="20174" data-permalink="https://blog.logrocket.com/making-a-chat-app-with-dapr/dapr/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/06/dapr.png" data-orig-size="730,347" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="dapr" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/06/dapr-300x143.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/06/dapr.png" decoding="async" loading="lazy" class="wp-image-20174 size-full" src="../Images/f7c0487fe3796a7ee3f710011ee6070d.png" alt="Dapr layout" srcset="https://blog.logrocket.com/wp-content/uploads/2020/06/dapr.png 730w, https://blog.logrocket.com/wp-content/uploads/2020/06/dapr-300x143.png 300w" sizes="(max-width: 730px) 100vw, 730px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/06/dapr.png"/></noscript><figcaption id="caption-attachment-20174" class="wp-caption-text">Source: <a href="https://cloudblogs.microsoft.com/opensource/2019/10/16/announcing-dapr-open-source-project-build-microservice-applications/" target="_blank" rel="noopener noreferrer">https://cloudblogs.microsoft.com/opensource/2019/10/16/announcing-dapr-open-source-project-build-microservice-applications/</a></figcaption></figure>
<p>Dapr的主要构件包括:</p>
<ul>
<li><strong>服务调用</strong>–服务到服务的调用支持远程服务上的方法调用，包括重试，无论它们运行在受支持的托管环境中的何处</li>
<li><strong>状态管理</strong>–允许存储、检索和删除键/值对。不同的状态存储组件支持不同的数据存储，如Redis、Azure CosmosDB和DynamoDB</li>
<li><strong>发布和订阅服务间的消息传递</strong>–这实现了事件驱动的架构，使水平扩展变得更加容易，并增加了故障恢复能力</li>
<li><strong>事件驱动的源绑定</strong>–通过支持向外部资源(如数据库、队列、webhooks等)接收和发送事件，事件驱动架构的可伸缩性和弹性得到了进一步提高</li>
<li>虚拟角色(Virtual actors)——无状态和有状态对象的模式，通过方法和状态封装使并发变得简单</li>
<li><strong>服务之间的分布式跟踪</strong>–它编译Dapr实例之间的跟踪事件、指标和性能统计。这使您能够使用W3C跟踪上下文标准轻松地诊断和监控生产中多个服务之间的调用</li>
<li><strong>机密管理</strong>–它提供了一种简单的方法来访问机密，而不需要知道正在使用的特定机密存储的复杂性。支持的秘密商店包括Kubernetes、Azure Key Vault、AWS Secret manager等。</li>
</ul>
<p>在这篇文章中，我们将探讨如何使用一些构建模块来制作一个聊天应用程序。</p>
<h2>先决条件</h2>
<p>我们的聊天应用程序将使用<a href="https://nodejs.org/en/" target="_blank" rel="noopener noreferrer"> Node.js </a>和<a href="https://reactjs.org/" target="_blank" rel="noopener noreferrer"> React </a>构建。本文假设您对这两者都很熟悉，并且具备这两者的工作知识。在我们开始构建聊天应用程序之前，请确保您的机器上安装了<a href="https://nodejs.org/en/" target="_blank" rel="noopener noreferrer">节点</a>、<a href="https://yarnpkg.com/" target="_blank" rel="noopener noreferrer">纱线</a>或<a href="https://npmjs.com/" target="_blank" rel="noopener noreferrer"> npm </a>和<a href="https://www.docker.com/" target="_blank" rel="noopener noreferrer"> Docker </a>。如果您还没有安装它们，可以按照提供的链接中的说明进行安装。我们将使用<a href="https://github.com/facebook/create-react-app" target="_blank" rel="noopener noreferrer"> create-react-app </a>为我们的聊天应用程序创建UI。</p>
<h2>设置Dapr</h2>
<p>我们需要做的第一件事是在本地机器上安装Dapr CLI。我们将为我们的操作系统使用特定的安装脚本:</p>
<h3>Linux:</h3>
<pre>$ wget -q https://raw.githubusercontent.com/dapr/cli/master/install/install.sh -O - | /bin/bash</pre>
<h3>窗口:</h3>
<pre>$ powershell -Command "iwr -useb https://raw.githubusercontent.com/dapr/cli/master/install/install.ps1 | iex"</pre>
<h3>MacOS:</h3>
<pre>$ curl -fsSL https://raw.githubusercontent.com/dapr/cli/master/install/install.sh | /bin/bash</pre>
<p>安装CLI后，需要使用以下命令在计算机中设置Dapr:</p>
<pre>$ dapr init</pre>
<p><img data-attachment-id="20183" data-permalink="https://blog.logrocket.com/making-a-chat-app-with-dapr/installingdapr/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/06/installingdapr.png" data-orig-size="730,92" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="installingdapr" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/06/installingdapr-300x38.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/06/installingdapr.png" decoding="async" class="aligncenter size-full wp-image-20183 jetpack-lazy-image" src="../Images/c9a40922acf33f063e3048f3c1188b97.png" alt="installing dapr in the command line" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2020/06/installingdapr.png 730w, https://blog.logrocket.com/wp-content/uploads/2020/06/installingdapr-300x38.png 300w" data-lazy-sizes="(max-width: 730px) 100vw, 730px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2020/06/installingdapr.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/06/installingdapr.png"/></p><noscript><img data-lazy-fallback="1" data-attachment-id="20183" data-permalink="https://blog.logrocket.com/making-a-chat-app-with-dapr/installingdapr/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/06/installingdapr.png" data-orig-size="730,92" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="installingdapr" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/06/installingdapr-300x38.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/06/installingdapr.png" decoding="async" loading="lazy" class="aligncenter size-full wp-image-20183" src="../Images/c9a40922acf33f063e3048f3c1188b97.png" alt="installing dapr in the command line" srcset="https://blog.logrocket.com/wp-content/uploads/2020/06/installingdapr.png 730w, https://blog.logrocket.com/wp-content/uploads/2020/06/installingdapr-300x38.png 300w" sizes="(max-width: 730px) 100vw, 730px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/06/installingdapr.png"/></noscript>
<p>现在可以用<code>dapr run</code>在本地运行Dapr。</p>
<h2>设置订户</h2>
<p>我们的聊天应用将由两个微服务组成。第一个微服务将是一个节点应用程序，它将从客户端UI订阅已发布的消息(已发送的消息)(第二个微服务)。</p>
<p>为我们的服务器创建以下文件夹结构:</p>
<pre>node-subscriber
├── README.md
├── .gitignore
├── routes.js
└── app.js</pre>
<p>或者，这可以通过终端以下列方式完成:</p>
<pre>$ mkdir node-subscriber
$ cd node-subscriber
$ touch README.md app.js routes.js .gitignore</pre>
<p>您可以在README.md中添加对项目内容的描述。您还应该将<code>node_modules</code>文件夹添加到<code>.gitignore</code>文件中，如下所示:</p>
<pre>node_modules/</pre>
<p>要生成不带提示的package.json文件，请运行以下命令:</p>
<pre>$ npm init -y</pre>
<p>package.json文件的内容如下所示:</p>
<pre>{
  "name": "node-subscriber",
  "version": "1.0.0",
  "description": "",
  "main": "app.js",
  "scripts": {
    "test": "echo \"Error: no test specified\" &amp;&amp; exit 1"
  },
  "keywords": [],
  "author": "",
  "license": "ISC"
}</pre>
<h2>安装依赖项</h2>
<pre>$ yarn add express body-parser ws</pre>
<p>在<code>app.js</code>中，我们将创建一个简单的express应用程序，它公开一些路由和处理程序，并初始化一个WebSocket服务器实例来发送连接到客户端的消息。将以下代码添加到app.js文件中:</p>
<pre>const express = require("express");
const bodyParser = require('body-parser');
const WebSocket = require("ws");
const { createServer } = require("http");

const app = express();
app.use(bodyParser.json());
app.use("/", require("./routes"));

const port = process.env.PORT || 9000;

//initialize a http server
const server = createServer(app);
server.listen(port, () =&gt; {
  console.log(`Node subscriber server running on port: ${port}`);
});
//initialize the WebSocket server instance
const wss = new WebSocket.Server({ server });
wss.on("connection", (ws) =&gt; {
  console.info(`Total connected clients: ${wss.clients.size}`);
  app.locals.clients = wss.clients;
  //send immediate a feedback to the incoming connection
  ws.send(
    JSON.stringify({
      type: "connect",
      message: "Welcome to Dapr Chat App",
    })
  );
});</pre>
<p>我们首先使用express创建一个简单的HTTP服务器，然后添加一个使用express服务器的WebSocket服务器。WebSocket服务器的连接事件处理程序处理来自客户端的连接请求。然后，我们将WebSocket服务器的<code>clients</code>属性分配给<code>app.locals</code>。这使我们能够从任何路由端点向所有连接的客户端广播消息。最后，我们向客户机发送一条消息，表明连接成功。</p>
<p>我们公开了一个从客户端订阅消息的路由<code>/message</code>。路由处理器将在<code>routes.js</code>中定义。让我们添加一些代码，向连接的客户端发送一条简单的消息:</p>
<pre>const router = require("express").Router();
const WebSocket = require("ws");
const broadcast = (clients, message) =&gt; {
  clients.forEach((client) =&gt; {
    if (client.readyState === WebSocket.OPEN) {
      client.send(message);
    }
  });
};
router.post("/message", (req, res) =&gt; {
  broadcast(req.app.locals.clients, "Bark!");
  return res.sendStatus(200);
});
module.exports = router;</pre>
<h2>使用Dapr运行节点订阅服务器</h2>
<p>我们现在准备测试我们的节点订户服务器。确保您在<code>node-subscriber</code>目录中。使用Dapr <code>dapr run --app-id node-subscriber --app-port 9000 --port 3500 node app.js</code>运行节点订阅者应用程序。</p>
<p>选项app-id和app-port将是我们选择的任何唯一标识符和我们的节点应用程序运行的端口。port选项指示Dapr将在哪个端口上运行。我们还传递命令来运行我们的应用程序<code>node app.js</code>。</p>
<p>您可以使用<a href="https://www.npmjs.com/package/wscat" target="_blank" rel="noopener noreferrer"> wscat </a>实用程序或<a href="https://chrome.google.com/webstore/detail/smart-websocket-client/omalebghpgejjiaoknljcfmglgbpocdp" target="_blank" rel="noopener noreferrer">智能Websocket客户端</a> Chrome扩展来测试我们服务器的WebSocket功能。如果安装了wscat，请打开一个新的终端选项卡并运行:</p>
<pre>$ wscat -c ws://localhost:9000</pre>
<p><img data-attachment-id="20191" data-permalink="https://blog.logrocket.com/making-a-chat-app-with-dapr/connect-client-to-websocket/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/06/Connect-client-to-websocket.png" data-orig-size="730,111" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Connect client to websocket" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/06/Connect-client-to-websocket-300x46.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/06/Connect-client-to-websocket.png" decoding="async" class="aligncenter size-full wp-image-20191 jetpack-lazy-image" src="../Images/48507f2c58cc178b3af4ba7807ff1e6d.png" alt="Connect client to websocket" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2020/06/Connect-client-to-websocket.png 730w, https://blog.logrocket.com/wp-content/uploads/2020/06/Connect-client-to-websocket-300x46.png 300w" data-lazy-sizes="(max-width: 730px) 100vw, 730px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2020/06/Connect-client-to-websocket.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/06/Connect-client-to-websocket.png"/></p><noscript><img data-lazy-fallback="1" data-attachment-id="20191" data-permalink="https://blog.logrocket.com/making-a-chat-app-with-dapr/connect-client-to-websocket/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/06/Connect-client-to-websocket.png" data-orig-size="730,111" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Connect client to websocket" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/06/Connect-client-to-websocket-300x46.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/06/Connect-client-to-websocket.png" decoding="async" loading="lazy" class="aligncenter size-full wp-image-20191" src="../Images/48507f2c58cc178b3af4ba7807ff1e6d.png" alt="Connect client to websocket" srcset="https://blog.logrocket.com/wp-content/uploads/2020/06/Connect-client-to-websocket.png 730w, https://blog.logrocket.com/wp-content/uploads/2020/06/Connect-client-to-websocket-300x46.png 300w" sizes="(max-width: 730px) 100vw, 730px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/06/Connect-client-to-websocket.png"/></noscript>
<p>一旦我们连接到WebSocket，我们就可以使用Dapr CLI post消息进行测试，并查看连接的客户端是否收到消息:</p>
<pre>dapr invoke --app-id nodeapp --method message --payload '{"message": "This is a test" }'</pre>
<p><img data-attachment-id="20193" data-permalink="https://blog.logrocket.com/making-a-chat-app-with-dapr/thisisatest/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/06/thisisatest.png" data-orig-size="730,100" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="thisisatest" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/06/thisisatest-300x41.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/06/thisisatest.png" decoding="async" class="aligncenter size-full wp-image-20193 jetpack-lazy-image" src="../Images/47c61bca3b1b6e2c09ff38275ad550a3.png" alt="this is a test" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2020/06/thisisatest.png 730w, https://blog.logrocket.com/wp-content/uploads/2020/06/thisisatest-300x41.png 300w" data-lazy-sizes="(max-width: 730px) 100vw, 730px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2020/06/thisisatest.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/06/thisisatest.png"/></p><noscript><img data-lazy-fallback="1" data-attachment-id="20193" data-permalink="https://blog.logrocket.com/making-a-chat-app-with-dapr/thisisatest/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/06/thisisatest.png" data-orig-size="730,100" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="thisisatest" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/06/thisisatest-300x41.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/06/thisisatest.png" decoding="async" loading="lazy" class="aligncenter size-full wp-image-20193" src="../Images/47c61bca3b1b6e2c09ff38275ad550a3.png" alt="this is a test" srcset="https://blog.logrocket.com/wp-content/uploads/2020/06/thisisatest.png 730w, https://blog.logrocket.com/wp-content/uploads/2020/06/thisisatest-300x41.png 300w" sizes="(max-width: 730px) 100vw, 730px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/06/thisisatest.png"/></noscript>
<p><img data-attachment-id="20195" data-permalink="https://blog.logrocket.com/making-a-chat-app-with-dapr/s_75da164968ad39abff828293102537c9d6df107396c86e05823637fc387af424_1591212155633_screenshot2020-06-03at22-22-17/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/06/s_75DA164968AD39ABFF828293102537C9D6DF107396C86E05823637FC387AF424_1591212155633_ScreenShot2020-06-03at22.22.17.png" data-orig-size="730,99" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="s_75DA164968AD39ABFF828293102537C9D6DF107396C86E05823637FC387AF424_1591212155633_Screen+Shot+2020-06-03+at+22.22.17" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/06/s_75DA164968AD39ABFF828293102537C9D6DF107396C86E05823637FC387AF424_1591212155633_ScreenShot2020-06-03at22.22.17-300x41.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/06/s_75DA164968AD39ABFF828293102537C9D6DF107396C86E05823637FC387AF424_1591212155633_ScreenShot2020-06-03at22.22.17.png" decoding="async" class="aligncenter size-full wp-image-20195 jetpack-lazy-image" src="../Images/c1dc00cbb09e0fc864d08841c888b696.png" alt="wscat local host saying &quot;welcome to the chat app&quot;" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2020/06/s_75DA164968AD39ABFF828293102537C9D6DF107396C86E05823637FC387AF424_1591212155633_ScreenShot2020-06-03at22.22.17.png 730w, https://blog.logrocket.com/wp-content/uploads/2020/06/s_75DA164968AD39ABFF828293102537C9D6DF107396C86E05823637FC387AF424_1591212155633_ScreenShot2020-06-03at22.22.17-300x41.png 300w" data-lazy-sizes="(max-width: 730px) 100vw, 730px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2020/06/s_75DA164968AD39ABFF828293102537C9D6DF107396C86E05823637FC387AF424_1591212155633_ScreenShot2020-06-03at22.22.17.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/06/s_75DA164968AD39ABFF828293102537C9D6DF107396C86E05823637FC387AF424_1591212155633_ScreenShot2020-06-03at22.22.17.png"/></p><noscript><img data-lazy-fallback="1" data-attachment-id="20195" data-permalink="https://blog.logrocket.com/making-a-chat-app-with-dapr/s_75da164968ad39abff828293102537c9d6df107396c86e05823637fc387af424_1591212155633_screenshot2020-06-03at22-22-17/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/06/s_75DA164968AD39ABFF828293102537C9D6DF107396C86E05823637FC387AF424_1591212155633_ScreenShot2020-06-03at22.22.17.png" data-orig-size="730,99" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="s_75DA164968AD39ABFF828293102537C9D6DF107396C86E05823637FC387AF424_1591212155633_Screen+Shot+2020-06-03+at+22.22.17" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/06/s_75DA164968AD39ABFF828293102537C9D6DF107396C86E05823637FC387AF424_1591212155633_ScreenShot2020-06-03at22.22.17-300x41.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/06/s_75DA164968AD39ABFF828293102537C9D6DF107396C86E05823637FC387AF424_1591212155633_ScreenShot2020-06-03at22.22.17.png" decoding="async" loading="lazy" class="aligncenter size-full wp-image-20195" src="../Images/c1dc00cbb09e0fc864d08841c888b696.png" alt="wscat local host saying &quot;welcome to the chat app&quot;" srcset="https://blog.logrocket.com/wp-content/uploads/2020/06/s_75DA164968AD39ABFF828293102537C9D6DF107396C86E05823637FC387AF424_1591212155633_ScreenShot2020-06-03at22.22.17.png 730w, https://blog.logrocket.com/wp-content/uploads/2020/06/s_75DA164968AD39ABFF828293102537C9D6DF107396C86E05823637FC387AF424_1591212155633_ScreenShot2020-06-03at22.22.17-300x41.png 300w" sizes="(max-width: 730px) 100vw, 730px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/06/s_75DA164968AD39ABFF828293102537C9D6DF107396C86E05823637FC387AF424_1591212155633_ScreenShot2020-06-03at22.22.17.png"/></noscript>
<p>调用message方法后，连接的客户端会收到来自应用程序的消息。因为路由应该将从任何客户端发布的消息中继到其他连接的客户端，所以让我们对此方法做一些调整:</p>
<pre>const router = require("express").Router();
const WebSocket = require("ws");
const broadcast = (clients, text) =&gt; {
  clients.forEach((client) =&gt; {
    if (client.readyState === WebSocket.OPEN) {
      client.send(JSON.stringify({
        type: "message",
        text
      }));
    }
  });
};
router.post("/message", (req, res) =&gt; {
  const message = req.body.message;
  if(message) {
    broadcast(req.app.locals.clients, message);
  }
  return res.sendStatus(200);
});
module.exports = router;</pre>
<p>使用我们之前使用的示例消息调用该方法会产生以下结果:<img data-attachment-id="20198" data-permalink="https://blog.logrocket.com/making-a-chat-app-with-dapr/daprmessage/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/06/daprmessage.png" data-orig-size="730,127" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="daprmessage" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/06/daprmessage-300x52.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/06/daprmessage.png" decoding="async" class="aligncenter size-full wp-image-20198 jetpack-lazy-image" src="../Images/7a66d3d253afc24285f7875b897c5c11.png" alt="dapr chat message" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2020/06/daprmessage.png 730w, https://blog.logrocket.com/wp-content/uploads/2020/06/daprmessage-300x52.png 300w" data-lazy-sizes="(max-width: 730px) 100vw, 730px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2020/06/daprmessage.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/06/daprmessage.png"/></p><noscript><img data-lazy-fallback="1" data-attachment-id="20198" data-permalink="https://blog.logrocket.com/making-a-chat-app-with-dapr/daprmessage/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/06/daprmessage.png" data-orig-size="730,127" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="daprmessage" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/06/daprmessage-300x52.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/06/daprmessage.png" decoding="async" loading="lazy" class="aligncenter size-full wp-image-20198" src="../Images/7a66d3d253afc24285f7875b897c5c11.png" alt="dapr chat message" srcset="https://blog.logrocket.com/wp-content/uploads/2020/06/daprmessage.png 730w, https://blog.logrocket.com/wp-content/uploads/2020/06/daprmessage-300x52.png 300w" sizes="(max-width: 730px) 100vw, 730px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/06/daprmessage.png"/></noscript>
<p>服务器现在可以从客户端接收消息，并将其发送给其他连接的客户端。</p>
<h2>聊天应用客户端</h2>
<h3>设置</h3>
<p>我们的前端客户端将由服务器和应用程序组成。服务器将通过Dapr调用消息方法。让我们为客户创建文件夹结构:</p>
<pre>$ mkdir dapr-chat-app-client
$ cd dapr-chat-app-client
$ touch README.md server.js .gitignore</pre>
<p>将客户端的简短描述添加到README.md文件，并将node_modules文件夹添加到<code>.gitignore</code>文件。</p>
<p>接下来，使用以下命令生成package.json文件:</p>
<p>package.json文件的内容如下所示:</p>
<pre>{
  "name": "dapr-chat-app-client",
  "version": "1.0.0",
  "description": "",
  "main": "index.js",
  "scripts": {
    "test": "echo \"Error: no test specified\" &amp;&amp; exit 1"
  },
  "keywords": [],
  "author": "",
  "license": "ISC"
}</pre>
<h3>安装依赖项</h3>
<pre>$ yarn add express body-parser request</pre>
<p>进入dapr-chat-app-client目录，使用以下任意命令引导前端应用程序。</p>
<h3>npx:</h3>
<pre>$ npx create-react-app client</pre>
<h3>npm:</h3>
<pre>$ npm init react-app client</pre>
<h3>纱线:</h3>
<pre>$ yarn create react-app client</pre>
<h3>前端服务器</h3>
<p>当从前端应用发送消息时，前端服务器将调用节点订户的消息方法。将以下代码添加到<code>dapr-chat-app-client</code>目录下的server.js文件中:</p>
<pre>const express = require('express');
const path = require('path');
const request = require('request');
const bodyParser = require('body-parser');

const app = express();
app.use(bodyParser.json());

const daprPort = process.env.DAPR_HTTP_PORT || 3500;
const daprUrl = `http://localhost:${daprPort}/v1.0`;
const port = 8080;

app.post('/publish', (req, res) =&gt; {
  console.log("Publishing: ", req.body);
  const publishUrl = `${daprUrl}/invoke/node-subscriber/method/message`;
  request( { uri: publishUrl, method: 'POST', json: req.body } );
  res.sendStatus(200);
});

// Serve static files
app.use(express.static(path.join(__dirname, 'client/build')));
// For all other requests, route to React client
app.get('*', function (_req, res) {
  res.sendFile(path.join(__dirname, 'client/build', 'index.html'));
});
app.listen(process.env.PORT || port, () =&gt; console.log(`Listening on port ${port}!`));</pre>
<p>服务器文件创建一个express服务器，该服务器公开一个发布端点，该端点使用Dapr调用节点订阅者上的消息方法。它还为前端应用程序提供静态文件。</p>
<p>为了让客户端运行，我们需要构建并启动前端应用程序，我们在<code>dapr-chat-app-client</code>目录下的<code>client</code>文件夹中进行引导。</p>
<p>为此，我们需要在主文件夹的package.json文件中添加一些脚本:</p>
<pre>"scripts": {
    "client": "cd client &amp;&amp; yarn start",
    "start": "node server.js",
    "buildclient": "cd client &amp;&amp; npm install &amp;&amp; npm run build",
    "buildandstart": "npm run buildclient &amp;&amp; npm install &amp;&amp; npm run start"
},
</pre>
<p>使用Dapr运行应用程序:</p>
<pre>dapr run --app-id dapt-chat-app-client --app-port 8080 npm run buildandstart</pre>
<p>这将在开发模式下运行应用程序，您可以使用链接<a href="http://localhost:8080/"> http://localhost:8080/ </a>在浏览器中查看它。</p>
<h2 data-usually-unique-id="116534415320607122457652"><span class="thread-845039457611020920976465 author-d-1gg9uz65z1iz85zgdz68zmqkz84zo2qoxwyqz80zwgz89zdjpio8vaz65zz68zz68z1z75zz66zz68zpjz73zz76z88z75z7x">客户端应用</span></h2>
<p>我们已经准备好工作的前端应用程序。导航到客户端文件夹:</p>
<pre>cd client</pre>
<h3>安装附加依赖项</h3>
<p>我们将使用<a href="https://react.semantic-ui.com/" target="_blank" rel="noopener noreferrer">语义UI反应</a>进行样式化。</p>
<p>要安装它，请运行以下命令:</p>
<pre>$ yarn add semantic-ui-react</pre>
<p>为了主题化语义ui组件，我们需要语义UI样式表。最快的开始方式是使用CDN。只需将此链接添加到公共文件夹中您的<code>index.html</code>文件的<code>&lt;head&gt;</code>:</p>
<pre>&lt;link rel="stylesheet" href="//cdn.jsdelivr.net/npm/<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="3340565e525d475a501e465a73011d071d01">[email protected]</a>/dist/semantic.min.css" /&gt;</pre>
<h2>组件设置</h2>
<p>我们的应用程序将存放在app.js文件中，这将是主要组件:</p>
<pre># Navigate to source directory
$ cd src/</pre>
<p>当主组件挂载后，我们将创建一个WebSocket连接并使用Refs存储它。该连接将侦听来自我们的节点订阅服务器的消息。然后，接收到的消息将被添加到状态中，并被处理以供显示。初始设置如下所示:</p>
<pre>import React, { Fragment, useState, useEffect, useRef } from "react";
import {
  Header
} from "semantic-ui-react";
import "./App.css";

const App = () =&gt; {
  const webSocket = useRef(null);
  const [socketMessages, setSocketMessages] = useState([]);

  useEffect(() =&gt; {
    webSocket.current = new WebSocket("ws://localhost:9000");
    webSocket.current.onmessage = message =&gt; {
      const data = JSON.parse(message.data);
      setSocketMessages(prev =&gt; [...prev, data]);
    };
    webSocket.current.onclose = () =&gt; {
      webSocket.current.close();
    };
    return () =&gt; webSocket.current.close();
  }, []);
  return (
    &lt;div className="App"&gt;
      &lt;Header as="h2" icon&gt;
        &lt;Icon name="users" /&gt;
        Dapr Chat App
      &lt;/Header&gt;
      &lt;Grid&gt;
      &lt;/Grid&gt;
    &lt;/div&gt;
  );
};
export default App;</pre>
<p><img data-attachment-id="20230" data-permalink="https://blog.logrocket.com/making-a-chat-app-with-dapr/daprchatapp/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/06/daprchatapp.png" data-orig-size="1098,414" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="daprchatapp" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/06/daprchatapp-300x113.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/06/daprchatapp-1024x386.png" decoding="async" class="aligncenter size-full wp-image-20230 jetpack-lazy-image" src="../Images/25e5a0aea5e4a928bf8708256d459e86.png" alt="Dapr chat app" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2020/06/daprchatapp.png 1098w, https://blog.logrocket.com/wp-content/uploads/2020/06/daprchatapp-300x113.png 300w, https://blog.logrocket.com/wp-content/uploads/2020/06/daprchatapp-1024x386.png 1024w, https://blog.logrocket.com/wp-content/uploads/2020/06/daprchatapp-768x290.png 768w" data-lazy-sizes="(max-width: 1098px) 100vw, 1098px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2020/06/daprchatapp.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/06/daprchatapp.png"/></p><noscript><img data-lazy-fallback="1" data-attachment-id="20230" data-permalink="https://blog.logrocket.com/making-a-chat-app-with-dapr/daprchatapp/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/06/daprchatapp.png" data-orig-size="1098,414" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="daprchatapp" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/06/daprchatapp-300x113.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/06/daprchatapp-1024x386.png" decoding="async" loading="lazy" class="aligncenter size-full wp-image-20230" src="../Images/25e5a0aea5e4a928bf8708256d459e86.png" alt="Dapr chat app" srcset="https://blog.logrocket.com/wp-content/uploads/2020/06/daprchatapp.png 1098w, https://blog.logrocket.com/wp-content/uploads/2020/06/daprchatapp-300x113.png 300w, https://blog.logrocket.com/wp-content/uploads/2020/06/daprchatapp-1024x386.png 1024w, https://blog.logrocket.com/wp-content/uploads/2020/06/daprchatapp-768x290.png 768w" sizes="(max-width: 1098px) 100vw, 1098px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/06/daprchatapp.png"/></noscript>
<p>为了处理我们从节点订阅服务器收到的消息，我们将使用一个useEffect，每当<code>socketMessages</code>发生变化时就会触发它。它将获取最后一条消息并进行处理:</p>
<pre>useEffect(() =&gt; {
    let data = socketMessages.pop();
    if (data) {
      switch (data.type) {
        case "message":
          handleMessageReceived(data.text);
          break;
        default:
          break;
      }
    }
  }, [socketMessages]);</pre>
<p>消息将被处理，如果消息的类型是<code>message</code>，它将调用<code>handleMessageReceived</code>处理程序。该处理程序将使用新消息更新state messages变量，然后向用户显示新消息:</p>
<pre>const Chat = ({ connection, updateConnection, channel, updateChannel }) =&gt; {
  ...  
  const messagesRef = useRef([]);
  const [messages, setMessages] = useState({});
  ...
  const handleMessageReceived = (text) =&gt; {
    let messages = messagesRef.current;
    let newMessages = [...messages, text];
    messagesRef.current = newMessages;
    setMessages(newMessages);
  };
  ...
}</pre>
<p>处理程序检索当前存储的消息，并在更新值之前添加新接收的消息。</p>
<p>现在我们已经处理了从节点订阅服务器接收消息，我们需要显示聊天消息。此外，我们将为用户提供一个输入，以便向聊天中的其他用户发送消息。如果没有要显示的消息，我们将有一个横幅显示尚未收到任何消息。</p>
<p><img data-attachment-id="20234" data-permalink="https://blog.logrocket.com/making-a-chat-app-with-dapr/daprchatappstep1/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/06/daprchatappstep1.png" data-orig-size="1540,898" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="daprchatappstep1" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/06/daprchatappstep1-300x175.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/06/daprchatappstep1-1024x597.png" decoding="async" class="aligncenter size-full wp-image-20234 jetpack-lazy-image" src="../Images/325c9364f08911ea8379ffd625cc326b.png" alt="banner displaying that no messages have been received yet" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2020/06/daprchatappstep1.png 1540w, https://blog.logrocket.com/wp-content/uploads/2020/06/daprchatappstep1-300x175.png 300w, https://blog.logrocket.com/wp-content/uploads/2020/06/daprchatappstep1-1024x597.png 1024w, https://blog.logrocket.com/wp-content/uploads/2020/06/daprchatappstep1-768x448.png 768w, https://blog.logrocket.com/wp-content/uploads/2020/06/daprchatappstep1-1536x896.png 1536w" data-lazy-sizes="(max-width: 1540px) 100vw, 1540px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2020/06/daprchatappstep1.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/06/daprchatappstep1.png"/></p><noscript><img data-lazy-fallback="1" data-attachment-id="20234" data-permalink="https://blog.logrocket.com/making-a-chat-app-with-dapr/daprchatappstep1/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/06/daprchatappstep1.png" data-orig-size="1540,898" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="daprchatappstep1" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/06/daprchatappstep1-300x175.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/06/daprchatappstep1-1024x597.png" decoding="async" loading="lazy" class="aligncenter size-full wp-image-20234" src="../Images/325c9364f08911ea8379ffd625cc326b.png" alt="banner displaying that no messages have been received yet" srcset="https://blog.logrocket.com/wp-content/uploads/2020/06/daprchatappstep1.png 1540w, https://blog.logrocket.com/wp-content/uploads/2020/06/daprchatappstep1-300x175.png 300w, https://blog.logrocket.com/wp-content/uploads/2020/06/daprchatappstep1-1024x597.png 1024w, https://blog.logrocket.com/wp-content/uploads/2020/06/daprchatappstep1-768x448.png 768w, https://blog.logrocket.com/wp-content/uploads/2020/06/daprchatappstep1-1536x896.png 1536w" sizes="(max-width: 1540px) 100vw, 1540px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/06/daprchatappstep1.png"/></noscript>
<p>用如下消息框代码更新应用程序组件:</p>
<pre>...
import {
  Icon,
  Input,
  Grid,
  Segment,
  Card,
  Comment,
  Button,
} from "semantic-ui-react";

const App = () =&gt; {
  ...
  const [message, setMessage] = useState("");
  ...
  const handleSubmit = (e) =&gt; {
    fetch('/publish', {
        headers: {
            'Accept': 'application/json',
            'Content-Type': 'application/json'
        },
        method:"POST",
        body: JSON.stringify({ message }),
    });
    e.preventDefault();
    setMessage('');
  }
  ...
  return (
    &lt;div className="App"&gt;
      &lt;Header as="h2" icon&gt;
        &lt;Icon name="users" /&gt;
        Dapr Chat App
      &lt;/Header&gt;
      &lt;Grid centered&gt;
        &lt;Grid.Column width={9}&gt;
          &lt;Card fluid&gt;
            &lt;Card.Content&gt;
              {messages.length ? (
                  &lt;Fragment&gt;
                    {messages.map((text,id) =&gt; (
                      &lt;Comment key={`msg-${id}`}&gt;
                        &lt;Comment.Content&gt;
                          &lt;Comment.Text&gt;{text}&lt;/Comment.Text&gt;
                        &lt;/Comment.Content&gt;
                      &lt;/Comment&gt;
                    ))}
                  &lt;/Fragment&gt;
              ) : (
                &lt;Segment placeholder&gt;
                  &lt;Header icon&gt;
                    &lt;Icon name="discussions" /&gt;
                    No messages available yet
                  &lt;/Header&gt;
                &lt;/Segment&gt;
              )}
              &lt;Input
                fluid
                type="text"
                value={message}
                onChange={e =&gt; setMessage(e.target.value)}
                placeholder="Type message"
                action
              &gt;
                &lt;input /&gt;
                &lt;Button color="teal" disabled={!message} onClick={handleSubmit}&gt;
                  &lt;Icon name="send" /&gt;
                  Send Message
                &lt;/Button&gt;
              &lt;/Input&gt;
            &lt;/Card.Content&gt;
          &lt;/Card&gt;
        &lt;/Grid.Column&gt;
      &lt;/Grid&gt;
    &lt;/div&gt;
  );
}</pre>
<p>当用户键入消息时，提交按钮将被启用，并且状态消息值将被设置。当用户点击<code>Send Message</code>按钮时，我们将调用<code>handleSubmit</code>事件处理程序，它将使用用户输入的消息调用前端服务器。</p>
<p>前端应用程序的应用程序组件的完整代码将如下所示:</p>
<pre>import React, { useState, useEffect, useRef, Fragment } from "react";
import {
  Header,
  Icon,
  Input,
  Grid,
  Segment,
  Card,
  Comment,
  Button,
} from "semantic-ui-react";
import "./App.css";

const App = () =&gt; {
  const [socketMessages, setSocketMessages] = useState([]);
  const webSocket = useRef(null);
  const [message, setMessage] = useState("");
  const messagesRef = useRef([]);
  const [messages, setMessages] = useState({});

  useEffect(() =&gt; {
    webSocket.current = new WebSocket("ws://localhost:9000");
    webSocket.current.onmessage = message =&gt; {
      const data = JSON.parse(message.data);
      setSocketMessages(prev =&gt; [...prev, data]);
    };
    webSocket.current.onclose = () =&gt; {
      webSocket.current.close();
    };
    return () =&gt; webSocket.current.close();
  }, []);

  useEffect(() =&gt; {
    let data = socketMessages.pop();
    if (data) {
      switch (data.type) {
        case "message":
          handleMessageReceived(data.text);
          break;
        default:
          break;
      }
    }
  }, [socketMessages]);

  const handleMessageReceived = (text) =&gt; {
    let messages = messagesRef.current;
    let newMessages = [...messages, text];
    messagesRef.current = newMessages;
    setMessages(newMessages);
  };

  const handleSubmit = (e) =&gt; {
    fetch('/publish', {
        headers: {
            'Accept': 'application/json',
            'Content-Type': 'application/json'
        },
        method:"POST",
        body: JSON.stringify({ message }),
    });
    e.preventDefault();
    setMessage('');
  }

  return (
    &lt;div className="App"&gt;
      &lt;Header as="h2" icon&gt;
        &lt;Icon name="users" /&gt;
        Dapr Chat App
      &lt;/Header&gt;
      &lt;Grid centered&gt;
        &lt;Grid.Column width={9}&gt;
          &lt;Card fluid&gt;
            &lt;Card.Content&gt;
              {messages.length ? (
                  &lt;Fragment&gt;
                    {messages.map((text,id) =&gt; (
                      &lt;Comment key={`msg-${id}`}&gt;
                        &lt;Comment.Content&gt;
                          &lt;Comment.Text&gt;{text}&lt;/Comment.Text&gt;
                        &lt;/Comment.Content&gt;
                      &lt;/Comment&gt;
                    ))}
                  &lt;/Fragment&gt;
              ) : (
                &lt;Segment placeholder&gt;
                  &lt;Header icon&gt;
                    &lt;Icon name="discussions" /&gt;
                    No messages available yet
                  &lt;/Header&gt;
                &lt;/Segment&gt;
              )}
              &lt;Input
                fluid
                type="text"
                value={message}
                onChange={e =&gt; setMessage(e.target.value)}
                placeholder="Type message"
                action
              &gt;
                &lt;input /&gt;
                &lt;Button color="teal" disabled={!message} onClick={handleSubmit}&gt;
                  &lt;Icon name="send" /&gt;
                  Send Message
                &lt;/Button&gt;
              &lt;/Input&gt;
            &lt;/Card.Content&gt;
          &lt;/Card&gt;
        &lt;/Grid.Column&gt;
      &lt;/Grid&gt;
    &lt;/div&gt;
  );
};
export default App;</pre>
<p><img data-attachment-id="20237" data-permalink="https://blog.logrocket.com/making-a-chat-app-with-dapr/messageexampledapr/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/06/messageexampledapr.png" data-orig-size="1434,564" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="messageexampledapr" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/06/messageexampledapr-300x118.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/06/messageexampledapr-1024x403.png" decoding="async" class="aligncenter size-full wp-image-20237 jetpack-lazy-image" src="../Images/2010c14c247a3f8eb2a72760d370e56f.png" alt="messages sent in the chat app" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2020/06/messageexampledapr.png 1434w, https://blog.logrocket.com/wp-content/uploads/2020/06/messageexampledapr-300x118.png 300w, https://blog.logrocket.com/wp-content/uploads/2020/06/messageexampledapr-1024x403.png 1024w, https://blog.logrocket.com/wp-content/uploads/2020/06/messageexampledapr-768x302.png 768w" data-lazy-sizes="(max-width: 1434px) 100vw, 1434px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2020/06/messageexampledapr.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/06/messageexampledapr.png"/></p><noscript><img data-lazy-fallback="1" data-attachment-id="20237" data-permalink="https://blog.logrocket.com/making-a-chat-app-with-dapr/messageexampledapr/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/06/messageexampledapr.png" data-orig-size="1434,564" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="messageexampledapr" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/06/messageexampledapr-300x118.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/06/messageexampledapr-1024x403.png" decoding="async" loading="lazy" class="aligncenter size-full wp-image-20237" src="../Images/2010c14c247a3f8eb2a72760d370e56f.png" alt="messages sent in the chat app" srcset="https://blog.logrocket.com/wp-content/uploads/2020/06/messageexampledapr.png 1434w, https://blog.logrocket.com/wp-content/uploads/2020/06/messageexampledapr-300x118.png 300w, https://blog.logrocket.com/wp-content/uploads/2020/06/messageexampledapr-1024x403.png 1024w, https://blog.logrocket.com/wp-content/uploads/2020/06/messageexampledapr-768x302.png 768w" sizes="(max-width: 1434px) 100vw, 1434px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/06/messageexampledapr.png"/></noscript>
<p><img data-attachment-id="20238" data-permalink="https://blog.logrocket.com/making-a-chat-app-with-dapr/completechatapp/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/06/completechatapp.gif" data-orig-size="600,328" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="completechatapp" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/06/completechatapp-300x164.gif" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/06/completechatapp.gif" decoding="async" class="aligncenter size-full wp-image-20238 jetpack-lazy-image" src="../Images/e8da00bcc15344f14bb308d02d2ae384.png" alt="completed chat app highlighting messages sent between users" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2020/06/completechatapp.gif?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/06/completechatapp.gif"/></p><noscript><img data-lazy-fallback="1" data-attachment-id="20238" data-permalink="https://blog.logrocket.com/making-a-chat-app-with-dapr/completechatapp/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/06/completechatapp.gif" data-orig-size="600,328" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="completechatapp" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/06/completechatapp-300x164.gif" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/06/completechatapp.gif" decoding="async" loading="lazy" class="aligncenter size-full wp-image-20238" src="../Images/e8da00bcc15344f14bb308d02d2ae384.png" alt="completed chat app highlighting messages sent between users" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/06/completechatapp.gif"/></noscript>
<p>就这样，我们使用Dapr构建了一个简单的聊天应用程序。这个版本的聊天应用程序在本地运行，非常适合您熟悉Dapr CLI。如果您想将您的聊天应用程序部署到生产环境中，您可以使用Kubernetes集群来完成。你可以在Dapr文档中找到关于如何<a href="https://github.com/dapr/docs/blob/master/getting-started/environment-setup.md" target="_blank" rel="noopener noreferrer">设置环境</a>的说明。</p>
<h2>结论和下一步措施</h2>
<p>我们构建的示例聊天应用程序功能非常有限。您可以添加一些功能，例如用户选择用户名和启动会话的能力。此外，您可以广播已加入其他已连接客户端的用户。聊天框中的消息也可以改进，以显示发送者的信息和消息发送的时间。从这个例子中，我们可以看到使用Dapr编写弹性可伸缩的微服务相当容易。你可以在Dapr <a href="https://github.com/dapr" target="_blank" rel="noopener noreferrer"> GitHub </a> repo中找到更多的信息和例子。如果你想看这个例子的完整代码，你可以在GitHub的<a href="https://github.com/jkithome/dapr-node-subscriber" target="_blank" rel="noopener noreferrer">节点订户</a>和<a href="https://github.com/jkithome/dapr-chat-app-client" target="_blank" rel="noopener noreferrer">聊天客户端</a> repos上找到。</p><div class="code-block code-block-17">
<div class="blog-plug inline-plug react-plug" vwo-el-id="26283398190">
<h2 vwo-el-id="41600691720">使用LogRocket消除传统反应错误报告的噪音</h2>
<a href="https://lp.logrocket.com/blg/react-signup-issue-free" target="_blank" vwo-el-id="19356441070">LogRocket
</a><p>是一款React analytics解决方案，可保护您免受数百个误报错误警报的影响，只针对少数真正重要的项目。LogRocket告诉您React应用程序中实际影响用户的最具影响力的bug和UX问题。</p><a class="signup" href="https://lp.logrocket.com/blg/react-signup-general" target="_blank" rel="noopener noreferrer" vwo-el-id="19356441380">
<img class="first-react-image alignnone size-full wp-image-46 jetpack-lazy-image jetpack-lazy-image--handled" src="../Images/f300c244a1a1cf916df8b4cb02bec6c6.png" vwo-el-id="18272717540" data-lazy-loaded="1" data-original-src="https://files.readme.io/27c94e7-Image_2017-06-05_at_9.46.04_PM.png"/>
 </a>
<a class="signup" href="https://lp.logrocket.com/blg/react-signup-general" target="_blank" rel="noopener noreferrer" vwo-el-id="19356441690">
<img class="second-react-image alignnone size-full wp-image-46 jetpack-lazy-image jetpack-lazy-image--handled" src="../Images/d6f5a5dd739296c1dd7aab3d5e77eeb9.png" alt="LogRocket Dashboard Free Trial Banner" vwo-el-id="30720362350" data-lazy-loaded="1" data-original-src="https://blog.logrocket.com/wp-content/uploads/2017/03/1d0cd-1s_rmyo6nbrasp-xtvbaxfg.png"/>
</a>
<a href="https://lp.logrocket.com/blg/react-signup-issue-free" target="_blank" rel="noopener noreferrer" vwo-el-id="35866400580">LogRocket
</a><p>自动聚合客户端错误、反应错误边界、还原状态、缓慢的组件加载时间、JS异常、前端性能指标和用户交互。然后，LogRocket使用机器学习来通知您影响大多数用户的最具影响力的问题，并提供您修复它所需的上下文。</p><p vwo-el-id="28675661060">关注重要的React bug—<a class="signup" href="https://lp.logrocket.com/blg/react-signup-issue-free" target="_blank" rel="noopener noreferrer" vwo-el-id="40093418840">今天就试试LogRocket】。</a></p>
</div></div>

<p class="clearfix"/>
<p class="clearfix"/>
</article>

</div>    
</body>
</html>