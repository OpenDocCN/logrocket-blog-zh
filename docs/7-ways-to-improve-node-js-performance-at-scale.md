# 提高 Node.js 性能的 7 种方法

> 原文：<https://blog.logrocket.com/7-ways-to-improve-node-js-performance-at-scale/>

Node.js 是一个在浏览器外执行 JavaScript 代码的解决方案。JavaScript 在服务器端的多功能性和灵活性使您能够开发高性能的应用程序。

在本教程中，我们将探索 Node 的效率和性能，并展示它如何帮助您用更少的资源获得更好的结果。我们将主要关注缓存，使用负载平衡器和 WebSockets，并监控您的应用程序。本指南结束时，您将拥有构建大规模运行良好的 Node.js 应用程序所需的工具和方法。

### 模块打包程序和任务运行程序

在前端，装载到浏览器的东西必须尽可能的小。这尤其包括图像、JavaScript 和 CSS 文件。使这成为可能的过程包括模块打包器(例如， [webpack](http://webpack.js.org) 、[pack](https://parceljs.org/)、 [Rollup](https://rollupjs.org) )和任务运行器(例如， [Gulp](https://gulpjs.com/) 、 [Grunt](https://gruntjs.com/) 等)。).

模块捆绑器是用于将模块组及其依赖项处理成一个文件或一组文件的构建工具。在幕后，这一切都是使用 Node.js 实现的。这种缩小的输出可以部署到生产中。根据您使用的工具，缩小过程可能会有所不同，但在大多数情况下，您可以使用 JavaScript 的 ES6 修订版中包含的代码模块的标准化格式。

这允许复杂的转换，例如缩短多字符变量名或使用与原始代码等效的较短语法，以及将几个 JavaScript 文件合并成一个文件以减少网络请求的数量。这也适用于 CSS 缩小；多余的空白和注释被删除，以帮助浏览器更快地解析它。

### CSS 模块和预处理程序

在页面加载过程中减少浏览器请求的情况下，CSS 也不例外。CSS 预处理程序如 [PostCSS](https://postcss.org/) 、 [Sass](https://sass-lang.com/) 和 [LESS](http://lesscss.org/) 提供变量、函数和混合来简化 CSS 代码的维护，并降低重构的挑战性。此外，他们将所有文件编译成一个单一的。css 文件，这减少了浏览器为提供文件而必须往返的次数。

使用运行在 Node.js 上的现代工具，比如前面提到的 bundlers，可以将限定作用域的 CSS 名称转换成全局唯一名称。现在，将一个 CSS 模块加载到组件的本地范围就像使用任何其他 JavaScript 模块一样简单。

### 形象

向浏览器发送代码时，图像是另一个需要考虑的问题。一般来说，你的图像越亮越好。根据设备的不同，您可能希望使用压缩图像或提供不同的图像。我想到的一个例子是 [Gatsby](https://gatsbyjs.org) ，它由 Node.js 在幕后提供支持，并有一系列利用 Node 的[插件](https://www.gatsbyjs.org/plugins/)，其中一些插件是专门设计来在构建时将图像转换为较小的图像，并按需提供服务。

## 2.SSL/TLS 和 HTTP/2

在构建 Node.js 应用程序时，可以使用 HTTP/2 使 web 浏览更快、更容易，并最大限度地减少带宽使用。HTTP/2 侧重于提高性能和解决与 HTTP/1.x 相关的问题。

HTTP/2 的特性包括:

*   标头压缩–这将删除不必要的标头，并强制所有 HTTP 标头以压缩格式发送。
*   多路复用——这允许多个请求在一个 TCP 连接中同时检索资源和响应消息。

多路复用的目标是最小化对服务器的请求数量。创建 HTTP 连接所需的时间通常比传输数据本身所需的时间更昂贵。为了利用 HTTP/2，需要实现传输层安全(TLS)和安全套接字层(SSL)协议。Node.js 的核心实现[这里的](https://nodejs.org/api/http2.html)使得设置 HTTP/2 服务器变得非常容易。

## 3.贮藏

缓存是提高应用程序性能的常用技术。它在客户端和服务器端都完成了。客户端缓存是对 HTML 页面、CSS 样式表、JS 脚本和多媒体内容等内容的临时存储。客户端缓存通过将常用数据保存在浏览器或内容交付网络(CDN)上，有助于限制数据成本。客户端缓存的一个例子是浏览器将经常使用的数据保存在本地或存储在 CDN 上。这个想法是，当用户访问一个网站，然后返回，该网站不应该重新下载所有的资源了。

HTTP 通过缓存头使这成为可能。缓存头有两种形式。

1.  `Expires`指定必须再次请求资源的日期
2.  `Cache-Control: max-age`指定资源有效的秒数

除非资源有缓存头，否则浏览器只能在缓存过期日期过后重新请求资源。这种方法有其缺点。例如，当资源改变时会发生什么？不知何故，缓存必须被破坏。您可以通过向资源 URL 添加版本号的缓存破坏方法来解决这个问题。当 URL 改变时，资源被重新下载。使用 webpack 等 Node.js 工具很容易做到这一点。

即使我们启用了客户端缓存，应用服务器仍然需要为访问应用的每个不同用户呈现数据，因此需要在服务器端实现缓存。在 Node.js 中，可以使用 Redis 存储临时数据，这就是所谓的对象缓存。在大多数情况下，您可以结合客户端和服务器端缓存来优化性能。

## 4.优化数据处理方法

优化是性能的关键，因为它简化了系统流程，提高了应用程序的整体效率。您可能想知道，Node.js 应用程序中可以优化什么？首先看看数据是如何处理的。Node.js 程序可能会因为 CPU/IO 限制的操作而变慢，例如数据库查询或缓慢的 API 调用。

对于大多数 Node.js 应用程序，数据获取是通过 API 请求完成的，并返回一个响应。你如何优化它？一种常见的方法是分页，即将响应分成可以通过选择性响应请求浏览的批量内容。您可以使用分页来优化响应，同时维护传递给用户客户端的大量数据。

过滤是另一种有效的方法，具体来说，就是根据请求者本身的标准来限制结果。这不仅减少了发出的呼叫总数和显示的结果，而且使用户能够非常精确地决定是否根据他们的需求提供资源。这两个概念在 [REST API 设计](https://blog.logrocket.com/creating-a-rest-api-in-rust-with-warp/)中很常见。

欠蚀刻和过蚀刻与获取数据的方式有关。前者提供的数据比适合或对客户端有用的数据要多，而后者不能以足够的数据做出响应，通常需要单独调用另一个端点来完成数据收集。这两种情况都可能发生在客户端，并且可能是应用程序扩展性差的结果。GraphQL 对于这种问题很有用，因为服务器不需要猜测它需要什么；客户定义他们的请求，并得到他们所期望的。

## 5.负载平衡

构建能够处理大量传入连接的高性能应用程序是一个常见的挑战。常见的解决方案是分配流量以平衡连接。这种方法被称为负载平衡。幸运的是，Node.js 允许您复制一个应用程序实例来处理更多的连接。这可以在单个多核服务器上完成，也可以通过多个服务器完成。

要在多核服务器上扩展 Node.js 应用程序，您可以使用引入的集群模块，该模块产生称为 workers 的新进程(每个 CPU 内核一个),这些进程同时运行并连接到单个主进程，允许这些进程共享同一个服务器端口。这样，它就像一个大型的多线程 Node.js 服务器。您可以使用集群模块来实现负载平衡，并根据循环策略在环境的多个 CPU 核心上的所有工作线程之间分配传入的连接。

另一种方法是使用 PM2 进程管理器让应用程序永远保持活动状态。每当出现代码更改或错误时，重新加载应用程序有助于避免停机。PM2 具有集群特性，使您能够在所有内核上运行多个进程，而无需担心为实现本机集群模块而进行的任何代码更改。

单集群设置有其缺点，我们需要做好准备，从单服务器架构切换到多服务器架构，并使用反向代理进行负载平衡。NGINX 支持跨多个 Node.js 服务器的负载平衡和各种负载平衡方法，包括:

*   循环调度——一个新请求发送到列表中的下一个服务器
*   最少的连接—新请求会发送到活动连接最少的服务器
*   IP 哈希—新请求发送到分配给客户端 IP 地址哈希的服务器。

反向代理特性保护 Node.js 服务器不直接暴露于 internet 流量，并在使用多个应用服务器时为您提供了极大的灵活性。

## 6.安全客户端身份验证

大多数 web 应用程序需要保持状态，以给用户提供个性化的体验。如果用户可以登录到您的网站，您需要为他们举行会议。

* * *

### 更多来自 LogRocket 的精彩文章:

* * *

在实现有状态身份验证时，通常会生成一个随机的会话标识符来将会话细节存储在服务器上。要将有状态的解决方案扩展到跨多台服务器的负载平衡应用程序，您可以使用一个中央存储解决方案(如 Redis)来存储会话数据，或者使用 IP 哈希方法(在负载平衡中)来确保用户始终到达同一个 web 服务器。

这种有状态的方法有其缺点。例如，当服务器需要某种维护时，将用户限制在特定的服务器上会导致问题。

JWT 的无状态认证是另一种可伸缩的方法——可以说是更好的方法。这样做的好处是，无论哪台机器在为用户服务，数据总是可用的。典型的 JWT 实现包括在用户登录时生成一个令牌。这个标记是 JSON 对象的 base64 编码，包含必要的用户详细信息。令牌被发送回客户端，并用于验证每个 API 请求。

## 7.使用 WebSockets 进行有效的服务器通信

传统上，互联网是围绕 HTTP 请求/响应模型开发的。WebSockets 是 web 应用程序中 HTTP 通信的替代方案。它们在客户机和服务器之间提供了一个长期的双向通信通道。如果建立了通道，它将保持开放，在客户机和服务器之间提供非常快速和持久的连接。双方可以随时开始发送数据，延迟和开销都很低。

HTTP 对于偶尔的数据共享和涉及用户交互的客户端驱动的通信非常有用。有了网络套接字，服务器可以向客户端发送消息，而无需客户端的明确请求，从而允许它们同时相互通信。这对于实时和长时间的通信非常有用。 [ws](https://github.com/websockets/ws) 是一个流行的 Node.js 库，用于实现一个网络套接字服务器。在前端，JavaScript 用于建立与支持网络套接字的服务器的连接，然后可以监听事件。同时保持大量的开放连接需要一个高竞争力的体系结构和低成本的性能，这就是 WebSockets 提供的。

## 结论

在本指南中，我们回顾了 Node.js 对前端工具的影响、HTTP/2 如何增强 Node.js 的性能、特定的缓存解决方案以及可以用来增强 Node.js 性能的数据处理方法。然后，我们讨论了如何在 Node.js 应用程序上实现负载平衡以管理更多的连接，有状态和无状态客户端身份验证对可伸缩性的影响，最后，WebSockets 如何在客户端和服务器之间提供稳定的连接。现在，您已经拥有了利用 Node.js 性能和编写用户喜欢的高效应用程序所需的一切。

## 200 只![](img/61167b9d027ca73ed5aaf59a9ec31267.png)显示器出现故障，生产中网络请求缓慢

部署基于节点的 web 应用程序或网站是容易的部分。确保您的节点实例继续为您的应用程序提供资源是事情变得更加困难的地方。如果您对确保对后端或第三方服务的请求成功感兴趣，

[try LogRocket](https://lp.logrocket.com/blg/node-signup)

.

[![LogRocket Network Request Monitoring](img/cae72fd2a54c5f02a6398c4867894844.png)](https://lp.logrocket.com/blg/node-signup)[https://logrocket.com/signup/](https://lp.logrocket.com/blg/node-signup)

LogRocket 就像是网络和移动应用程序的 DVR，记录下用户与你的应用程序交互时发生的一切。您可以汇总并报告有问题的网络请求，以快速了解根本原因，而不是猜测问题发生的原因。

LogRocket 检测您的应用程序以记录基线性能计时，如页面加载时间、到达第一个字节的时间、慢速网络请求，还记录 Redux、NgRx 和 Vuex 操作/状态。

[Start monitoring for free](https://lp.logrocket.com/blg/node-signup)

.