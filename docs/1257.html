<html>
<head>
<title>Streaming video in Safari: Why is it so difficult? - LogRocket Blog</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>Safari中的流媒体视频:为什么这么难？- LogRocket博客</h1>
<blockquote>原文：<a href="https://blog.logrocket.com/streaming-video-in-safari/#0001-01-01">https://blog.logrocket.com/streaming-video-in-safari/#0001-01-01</a></blockquote><div><article class="article-post">
<h2>问题是</h2>
<p>我最近在我的产品<a href="https://www.sortal.io/"> Sortal </a>中实现了对视频的人工智能标记的支持。该功能的一部分是，你可以播放你上传的视频。我想，没问题——视频流看起来很简单。</p>
<p>事实上，它是如此简单(只有几行代码)，以至于我在我的书<em> <a href="http://bit.ly/2o0aDsP">自举微服务</a> </em>中选择了视频流作为例子的主题。</p>
<p>但当我们在Safari中进行测试时，我了解到了一个丑陋的事实。所以让我重新表述一下之前的断言:视频流对Chrome浏览器来说很简单，但对T2 Safari浏览器来说就不那么简单了。</p>
<p>为什么Safari这么难？如何才能让它在Safari中发挥作用？这些问题的答案在这篇博文中揭晓。</p>
<h2>你自己试试吧</h2>
<p>在我们开始一起看代码之前，请自己尝试一下！这篇博文附带的代码<a href="https://github.com/bootstrapping-microservices/video-streaming-example">可以在GitHub </a>上获得。您可以<a href="https://github.com/bootstrapping-microservices/video-streaming-example/archive/master.zip">下载代码</a>或者使用Git克隆存储库。你需要安装的<a href="https://nodejs.org/en/download/"> Node.js来试用它。</a></p>
<p>按照自述文件中的说明<a href="https://github.com/bootstrapping-microservices/video-streaming-example/blob/master/README.MD">启动服务器，并在浏览器中导航至<code><a href="http://localhost:3000" rel="nofollow">http://localhost:3000</a></code>。您将看到图1或图2，这取决于您是在Chrome还是Safari中查看页面。</a></p>
<p>请注意，在图2中，当在Safari中查看网页时，左侧的视频不起作用。然而，右边的例子确实有效，这篇文章解释了我如何为Safari实现视频流代码的工作版本。</p>
<figure id="attachment_27496" aria-describedby="caption-attachment-27496" class="wp-caption aligncenter"><img data-attachment-id="27496" data-permalink="https://blog.logrocket.com/streaming-video-in-safari/video-streaming-example-chrome-annotated/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/10/video-streaming-example-chrome-annotated.png" data-orig-size="730,369" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Video streaming example in Chrome" data-image-description="" data-image-caption="&lt;p&gt;Figure 1: Video streaming example viewed in Chrome.&lt;/p&gt;&#10;" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/10/video-streaming-example-chrome-annotated-300x152.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/10/video-streaming-example-chrome-annotated.png" decoding="async" class="size-full wp-image-27496 jetpack-lazy-image" src="../Images/6e5426809d68f2710c33581b0889a243.png" alt="Video Streaming Example in Chrome" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2020/10/video-streaming-example-chrome-annotated.png 730w, https://blog.logrocket.com/wp-content/uploads/2020/10/video-streaming-example-chrome-annotated-300x152.png 300w" data-lazy-sizes="(max-width: 730px) 100vw, 730px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2020/10/video-streaming-example-chrome-annotated.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/10/video-streaming-example-chrome-annotated.png"/><noscript><img data-lazy-fallback="1" data-attachment-id="27496" data-permalink="https://blog.logrocket.com/streaming-video-in-safari/video-streaming-example-chrome-annotated/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/10/video-streaming-example-chrome-annotated.png" data-orig-size="730,369" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Video streaming example in Chrome" data-image-description="" data-image-caption="&lt;p&gt;Figure 1: Video streaming example viewed in Chrome.&lt;/p&gt;&#10;" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/10/video-streaming-example-chrome-annotated-300x152.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/10/video-streaming-example-chrome-annotated.png" decoding="async" loading="lazy" class="size-full wp-image-27496" src="../Images/6e5426809d68f2710c33581b0889a243.png" alt="Video Streaming Example in Chrome" srcset="https://blog.logrocket.com/wp-content/uploads/2020/10/video-streaming-example-chrome-annotated.png 730w, https://blog.logrocket.com/wp-content/uploads/2020/10/video-streaming-example-chrome-annotated-300x152.png 300w" sizes="(max-width: 730px) 100vw, 730px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/10/video-streaming-example-chrome-annotated.png"/></noscript><figcaption id="caption-attachment-27496" class="wp-caption-text">Figure 1: Video streaming example viewed in Chrome.</figcaption></figure>
<figure id="attachment_27497" aria-describedby="caption-attachment-27497" class="wp-caption aligncenter"><img data-attachment-id="27497" data-permalink="https://blog.logrocket.com/streaming-video-in-safari/video-streaming-example-safari-annotated/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/10/video-streaming-example-safari-annotated.png" data-orig-size="730,322" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Video streaming example in Safari" data-image-description="" data-image-caption="&lt;p&gt;Figure 2: Video streaming example viewed in Safari. Notice that the basic video streaming on the left is not functional.&lt;/p&gt;&#10;" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/10/video-streaming-example-safari-annotated-300x132.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/10/video-streaming-example-safari-annotated.png" decoding="async" class="size-full wp-image-27497 jetpack-lazy-image" src="../Images/ba71e4eda30ab392318aa66ceaa08880.png" alt="Video Streaming Example in Safari" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2020/10/video-streaming-example-safari-annotated.png 730w, https://blog.logrocket.com/wp-content/uploads/2020/10/video-streaming-example-safari-annotated-300x132.png 300w" data-lazy-sizes="(max-width: 730px) 100vw, 730px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2020/10/video-streaming-example-safari-annotated.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/10/video-streaming-example-safari-annotated.png"/><noscript><img data-lazy-fallback="1" data-attachment-id="27497" data-permalink="https://blog.logrocket.com/streaming-video-in-safari/video-streaming-example-safari-annotated/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/10/video-streaming-example-safari-annotated.png" data-orig-size="730,322" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Video streaming example in Safari" data-image-description="" data-image-caption="&lt;p&gt;Figure 2: Video streaming example viewed in Safari. Notice that the basic video streaming on the left is not functional.&lt;/p&gt;&#10;" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/10/video-streaming-example-safari-annotated-300x132.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/10/video-streaming-example-safari-annotated.png" decoding="async" loading="lazy" class="size-full wp-image-27497" src="../Images/ba71e4eda30ab392318aa66ceaa08880.png" alt="Video Streaming Example in Safari" srcset="https://blog.logrocket.com/wp-content/uploads/2020/10/video-streaming-example-safari-annotated.png 730w, https://blog.logrocket.com/wp-content/uploads/2020/10/video-streaming-example-safari-annotated-300x132.png 300w" sizes="(max-width: 730px) 100vw, 730px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/10/video-streaming-example-safari-annotated.png"/></noscript><figcaption id="caption-attachment-27497" class="wp-caption-text">Figure 2: Video streaming example viewed in Safari. Notice that the basic video streaming on the left is not functional.</figcaption></figure>
<h2>基本视频流</h2>
<p>在Chrome中工作的视频流的基本形式在HTTP服务器中实现起来很简单。我们只是将整个视频文件从后端传输到前端，如图3所示。</p>
<figure id="attachment_27499" aria-describedby="caption-attachment-27499" class="wp-caption aligncenter"><img data-attachment-id="27499" data-permalink="https://blog.logrocket.com/streaming-video-in-safari/simple-streaming-flow/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/10/simple-streaming-flow.png" data-orig-size="728,467" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Simple video streaming flow" data-image-description="" data-image-caption="&lt;p&gt;Figure 3: Simple video streaming that works in Chrome.&lt;/p&gt;&#10;" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/10/simple-streaming-flow-300x192.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/10/simple-streaming-flow.png" decoding="async" class="size-full wp-image-27499 jetpack-lazy-image" src="../Images/2c7f3fdfad76aca8fe3baf36f57c50a3.png" alt="Simple Video Streaming Flow" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2020/10/simple-streaming-flow.png 728w, https://blog.logrocket.com/wp-content/uploads/2020/10/simple-streaming-flow-300x192.png 300w" data-lazy-sizes="(max-width: 728px) 100vw, 728px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2020/10/simple-streaming-flow.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/10/simple-streaming-flow.png"/><noscript><img data-lazy-fallback="1" data-attachment-id="27499" data-permalink="https://blog.logrocket.com/streaming-video-in-safari/simple-streaming-flow/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/10/simple-streaming-flow.png" data-orig-size="728,467" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Simple video streaming flow" data-image-description="" data-image-caption="&lt;p&gt;Figure 3: Simple video streaming that works in Chrome.&lt;/p&gt;&#10;" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/10/simple-streaming-flow-300x192.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/10/simple-streaming-flow.png" decoding="async" loading="lazy" class="size-full wp-image-27499" src="../Images/2c7f3fdfad76aca8fe3baf36f57c50a3.png" alt="Simple Video Streaming Flow" srcset="https://blog.logrocket.com/wp-content/uploads/2020/10/simple-streaming-flow.png 728w, https://blog.logrocket.com/wp-content/uploads/2020/10/simple-streaming-flow-300x192.png 300w" sizes="(max-width: 728px) 100vw, 728px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/10/simple-streaming-flow.png"/></noscript><figcaption id="caption-attachment-27499" class="wp-caption-text">Figure 3: Simple video streaming that works in Chrome.</figcaption></figure>
<h3>在前端</h3>
<p>为了在前端呈现视频，我们使用HTML5 video元素。没什么大不了的。清单1展示了它是如何工作的。这个版本只能在Chrome上使用。可以看到视频的<code>src</code>是由<code>/works-in-chrome</code>路由在后端处理的。</p>
<h5><span> <em>清单1:一个在Chrome </em> </span>中呈现流媒体视频的简单网页</h5>
<pre class="language-html">&lt;!doctype html&gt;
&lt;html&gt;
    &lt;head&gt;
        &lt;meta charset="utf-8"&gt;
        &lt;title&gt;Video streaming example&lt;/title&gt;
        &lt;/head&gt;
    &lt;body&gt; 
        &lt;video
            muted
            playsInline
            loop
            controls
            src="/works-in-chrome" 
            &gt;
        &lt;/video&gt;
    &lt;/body&gt;
&lt;/html&gt;
</pre>
<h3>在后端</h3>
<p>这个例子的后端是一个非常简单的HTTP服务器，构建在Node.js上运行的快速框架之上。这是执行<code>/works-in-chrome</code>路线的地方。</p>
<p>为了响应HTTP GET请求，我们将整个文件流式传输到浏览器。在这个过程中，我们设置了各种HTTP响应头。</p>
<p><code>content-type</code>头被设置为<code>video/mp4</code>,所以浏览器知道它正在接收一个视频。</p>
<p>然后我们<code>stat</code>文件来获取它的长度，并将其设置为<code>content-length</code>头，这样浏览器就知道它接收了多少数据。</p>
<h5><span> <em>清单2:带有简单视频流的Node.js Express web服务器，适用于Chrome </em> </span></h5>
<pre>const express = require("express");
const fs = require("fs");

const app = express();

const port = 3000;

app.use(express.static("public"));

const filePath = "./videos/SampleVideo_1280x720_1mb.mp4";

app.get("/works-in-chrome", (req, res) =&gt; {
    // Set content-type so the browser knows it's receiving a video.
    res.setHeader("content-type", "video/mp4"); 


    // Stat the video file to determine its length.
    fs.stat(filePath, (err, stat) =&gt; {
        if (err) {
            console.error(`File stat error for ${filePath}.`);
            console.error(err);
            res.sendStatus(500);
            return;
        }

        // Set content-length so the browser knows
        // how much data it is receiving.
        res.setHeader("content-length", stat.size);

        // Stream the video file directly from the 
        // backend file system.
        const fileStream = fs.createReadStream(filePath);
        fileStream.on("error", error =&gt; {
            console.log(`Error reading file ${filePath}.`);
            console.log(error);
            res.sendStatus(500);
        });

        // Pipe the file to the HTTP response.
        // We are sending the entire file to the 
        // frontend.
        fileStream.pipe(res);
    });
});

app.listen(port, () =&gt; {
    console.log(`Example app listening at http://localhost:${port}`)
});</pre>
<h2>但是在Safari里不行！</h2>
<p>不幸的是，我们不能只是将整个视频文件发送到Safari，并期望它能够工作。Chrome可以应对，但Safari拒绝玩游戏。</p>
<h3>少了什么？</h3>
<p>Safari不希望一次传送整个文件。这就是为什么流式传输整个文件的暴力策略不起作用。</p>
<p>Safari希望对文件的某些部分进行流式处理，以便以渐进的方式对其进行增量缓冲。它还希望对文件的任何部分进行随机、专门的访问。</p>
<p>这其实是有道理的。想象一下，一个用户想要将视频倒回一点——你不会想要重新开始整个文件流吧？</p>
<p>相反，Safari只是想退回一点，再次请求文件的那一部分。事实上，这在Chrome中也适用。尽管基本的流媒体视频可以在Chrome中工作，但Chrome确实可以发出HTTP范围请求，以便更有效地处理流媒体视频。</p>
<p>图4向您展示了这是如何工作的。我们需要修改我们的HTTP服务器，这样我们就可以根据浏览器的请求提供文件的随机访问部分，而不是将整个视频文件传输到前端。</p>
<figure id="attachment_27501" aria-describedby="caption-attachment-27501" class="wp-caption aligncenter"><img data-attachment-id="27501" data-permalink="https://blog.logrocket.com/streaming-video-in-safari/range-streaming-flow/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/10/range-streaming-flow.png" data-orig-size="730,554" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Range streaming flow" data-image-description="" data-image-caption="&lt;p&gt;Figure 4: For video streaming to work in Safari, we must support HTTP range requests that can retrieve a portion of the video file instead of the whole file.&lt;/p&gt;&#10;" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/10/range-streaming-flow-300x228.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/10/range-streaming-flow.png" decoding="async" class="size-full wp-image-27501 jetpack-lazy-image" src="../Images/18f3f78d414d7861c84ab3038b0522dd.png" alt="Range Streaming Flow" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2020/10/range-streaming-flow.png 730w, https://blog.logrocket.com/wp-content/uploads/2020/10/range-streaming-flow-300x228.png 300w" data-lazy-sizes="(max-width: 730px) 100vw, 730px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2020/10/range-streaming-flow.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/10/range-streaming-flow.png"/><noscript><img data-lazy-fallback="1" data-attachment-id="27501" data-permalink="https://blog.logrocket.com/streaming-video-in-safari/range-streaming-flow/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/10/range-streaming-flow.png" data-orig-size="730,554" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Range streaming flow" data-image-description="" data-image-caption="&lt;p&gt;Figure 4: For video streaming to work in Safari, we must support HTTP range requests that can retrieve a portion of the video file instead of the whole file.&lt;/p&gt;&#10;" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/10/range-streaming-flow-300x228.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/10/range-streaming-flow.png" decoding="async" loading="lazy" class="size-full wp-image-27501" src="../Images/18f3f78d414d7861c84ab3038b0522dd.png" alt="Range Streaming Flow" srcset="https://blog.logrocket.com/wp-content/uploads/2020/10/range-streaming-flow.png 730w, https://blog.logrocket.com/wp-content/uploads/2020/10/range-streaming-flow-300x228.png 300w" sizes="(max-width: 730px) 100vw, 730px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/10/range-streaming-flow.png"/></noscript><figcaption id="caption-attachment-27501" class="wp-caption-text">Figure 4: For video streaming to work in Safari, we must support HTTP range requests that can retrieve a portion of the video file instead of the whole file.</figcaption></figure>
<h3>支持HTTP范围请求</h3>
<p>具体来说，我们必须支持HTTP范围请求。但是我们如何实施呢？</p>
<p>令人惊讶的是，这方面的可读文档很少。当然，我们可以阅读HTTP规范，但是谁有时间和动机去做呢？(我会在本文末尾给你参考资料的链接。)</p>
<p>相反，请允许我向您介绍一下我的实现。它的关键是以前缀<code>"bytes="</code>开始的HTTP请求<code>range</code>头。</p>
<p>这个头是前端如何要求从视频文件中检索特定范围的字节。您可以在清单3中看到我们如何解析这个头的值来获得字节范围的开始和结束值。</p><div class="code-block code-block-54">
<hr/>
<h3>更多来自LogRocket的精彩文章:</h3>

<hr/></div>
<h5><span> <em>清单3:解析HTTP范围头</em> </span></h5>
<pre>const options = {};

let start;
let end;

const range = req.headers.range;
if (range) {
    const bytesPrefix = "bytes=";
    if (range.startsWith(bytesPrefix)) {
        const bytesRange = range.substring(bytesPrefix.length);
        const parts = bytesRange.split("-");
        if (parts.length === 2) {
            const rangeStart = parts[0] &amp;&amp; parts[0].trim();
            if (rangeStart &amp;&amp; rangeStart.length &gt; 0) {
                options.start = start = parseInt(rangeStart);
            }
            const rangeEnd = parts[1] &amp;&amp; parts[1].trim();
            if (rangeEnd &amp;&amp; rangeEnd.length &gt; 0) {
                options.end = end = parseInt(rangeEnd);
            }
        }
    }
}</pre>
<h3>响应HTTP HEAD请求</h3>
<p>HTTP HEAD请求是前端如何探测后端关于特定资源的信息。我们应该小心处理这件事。</p>
<p>Express框架还将HEAD请求发送到我们的HTTP GET处理程序，因此我们可以检查<code>req.method</code>并在我们做HEAD请求不必要的工作之前从请求处理程序返回<code>early </code>。</p>
<p>清单4显示了我们如何响应HEAD请求。我们不需要从文件中返回任何数据，但是我们需要配置响应头来告诉前端我们支持HTTP范围请求，并让它知道视频文件的完整大小。</p>
<p>这里使用的<code>accept-ranges</code>响应头表示这个请求处理程序可以响应HTTP范围请求。</p>
<h5><span> <em>清单4:响应HTTP HEAD请求</em> </span></h5>
<pre>if (req.method === "HEAD") {
    res.statusCode = 200;


// Inform the frontend that we accept HTTP 
// range requests.
    res.setHeader("accept-ranges", "bytes");

    // This is our chance to tell the frontend
    // the full size of the video file.
    res.setHeader("content-length", contentLength);

    res.end();
}
else {        
    // ... handle a normal HTTP GET request ...
}</pre>
<h3>完整文件与部分文件</h3>
<p>现在是棘手的部分。我们是发送整个文件还是发送文件的一部分？</p>
<p>只要稍加小心，我们就可以让请求处理程序支持这两种方法。您可以在清单5中看到，当它是一个范围请求并且那些变量被定义时，我们如何从开始和结束变量计算<code>retrievedLength</code>;否则，当它不是一个范围请求时，我们就使用<code>contentLength</code>(整个文件的大小)。</p>
<h5><span> <em>清单5:根据请求的文件部分确定内容长度</em> </span></h5>
<pre>let retrievedLength;
if (start !== undefined &amp;&amp; end !== undefined) {
    retrievedLength = (end+1) - start;
}
else if (start !== undefined) {
    retrievedLength = contentLength - start;
}
else if (end !== undefined) {
    retrievedLength = (end+1);
}
else {
    retrievedLength = contentLength;
}</pre>
<h3>发送状态代码和响应标头</h3>
<p>我们已经处理了头的请求。剩下要处理的就是HTTP GET请求了。</p>
<p>清单6显示了我们如何发送适当的成功状态代码和响应头。</p>
<p>根据这是对整个文件的请求还是对文件一部分的范围请求，状态代码会有所不同。如果是范围请求，状态码会是206(针对部分内容)；否则，我们使用常规的旧成功状态代码200。</p>
<h5><span> <em>清单6:发送响应头</em> </span></h5>
<pre>// Send status code depending on whether this is
// request for the full file or partial content.
res.statusCode = start !== undefined || end !== undefined ? 206 : 200;

res.setHeader("content-length", retrievedLength);

if (range !== undefined) {  
    // Conditionally informs the frontend what range of content
    // we are sending it.
    res.setHeader("content-range", 
           `bytes ${start || 0}-${end || (contentLength-1)}/${contentLength}`
       );
    res.setHeader("accept-ranges", "bytes");
}</pre>
<h3>流式传输文件的一部分</h3>
<p>现在是最简单的部分:流式传输文件的一部分。清单7中的代码与清单2中的基本视频流示例中的代码几乎相同。</p>
<p>现在不同的是，我们传入的是<code>options</code>对象。方便地，来自<a href="https://nodejs.org/api/fs.html">node . js’文件系统模块</a>的<code><a href="https://nodejs.org/api/fs.html#fs_fs_createreadstream_path_options">createReadStream</a></code>函数获取<code>options</code>对象中的<code>start</code>和<code>end</code>值，这使得能够从硬盘驱动器中读取文件的一部分。</p>
<p>在HTTP范围请求的情况下，清单3中前面的代码已经解析了来自头部的<code>start</code>和<code>end</code>值，我们将它们插入到了<code>options</code>对象中。</p>
<p>在普通HTTP GET请求(不是范围请求)的情况下，<code>start</code>和<code>end</code>不会被解析，也不会在<code>options</code>对象中，在这种情况下，我们只是读取整个文件。</p>
<h5><span> <em>清单7:流式传输文件的一部分</em> </span></h5>
<pre>const fileStream = fs.createReadStream(filePath, options);
fileStream.on("error", error =&gt; {
    console.log(`Error reading file ${filePath}.`);
    console.log(error);
    res.sendStatus(500);
});

fileStream.pipe(res);</pre>
<h3>把所有的放在一起</h3>
<p>现在，让我们将所有代码放入一个完整的请求处理程序，用于在Chrome和Safari中都能工作的流媒体视频。</p>
<p>清单8是从清单3到清单7的组合代码，因此您可以在上下文中看到全部内容。这个请求处理程序可以以两种方式工作。如果浏览器请求，它可以检索视频文件的一部分。否则，它将检索整个文件。</p>
<h5><span> <em>清单8:完整的HTTP请求处理程序</em> </span></h5>
<pre>app.get('/works-in-chrome-and-safari', (req, res) =&gt; {

    // Listing 3.
    const options = {};

    let start;
    let end;

    const range = req.headers.range;
    if (range) {
        const bytesPrefix = "bytes=";
        if (range.startsWith(bytesPrefix)) {
            const bytesRange = range.substring(bytesPrefix.length);
            const parts = bytesRange.split("-");
            if (parts.length === 2) {
                const rangeStart = parts[0] &amp;&amp; parts[0].trim();
                if (rangeStart &amp;&amp; rangeStart.length &gt; 0) {
                    options.start = start = parseInt(rangeStart);
                }
                const rangeEnd = parts[1] &amp;&amp; parts[1].trim();
                if (rangeEnd &amp;&amp; rangeEnd.length &gt; 0) {
                    options.end = end = parseInt(rangeEnd);
                }
            }
        }
    }

    res.setHeader("content-type", "video/mp4");

    fs.stat(filePath, (err, stat) =&gt; {
        if (err) {
            console.error(`File stat error for ${filePath}.`);
            console.error(err);
            res.sendStatus(500);
            return;
        }

        let contentLength = stat.size;

        // Listing 4.
        if (req.method === "HEAD") {
            res.statusCode = 200;
            res.setHeader("accept-ranges", "bytes");
            res.setHeader("content-length", contentLength);
            res.end();
        }
        else {       
            // Listing 5.
            let retrievedLength;
            if (start !== undefined &amp;&amp; end !== undefined) {
                retrievedLength = (end+1) - start;
            }
            else if (start !== undefined) {
                retrievedLength = contentLength - start;
            }
            else if (end !== undefined) {
                retrievedLength = (end+1);
            }
            else {
                retrievedLength = contentLength;
            }

            // Listing 6.
            res.statusCode = start !== undefined || end !== undefined ? 206 : 200;

            res.setHeader("content-length", retrievedLength);

            if (range !== undefined) {  
                res.setHeader("content-range", `bytes ${start || 0}-${end || (contentLength-1)}/${contentLength}`);
                res.setHeader("accept-ranges", "bytes");
            }

            // Listing 7.
            const fileStream = fs.createReadStream(filePath, options);
            fileStream.on("error", error =&gt; {
                console.log(`Error reading file ${filePath}.`);
                console.log(error);
                res.sendStatus(500);
            });


            fileStream.pipe(res);
        }
    });
});</pre>
<h3>更新的前端代码</h3>
<p>除了确保<code>video</code>元素指向可以处理HTTP范围请求的HTTP路由之外，前端代码不需要做任何修改。</p>
<p>清单9显示我们简单地将视频元素重新路由到一个名为<code>/works-in-chrome-and-safari</code>的路径。这个前端在Chrome和Safari中都可以工作。</p>
<h5><span> <em>清单9:更新前端代码</em> </span></h5>
<pre class="language-html">&lt;!doctype html&gt;
&lt;html&gt;
    &lt;head&gt;
        &lt;meta charset="utf-8"&gt;
        &lt;title&gt;Video streaming example&lt;/title&gt;
        &lt;/head&gt;
    &lt;body&gt; 
        &lt;video
            muted
            playsInline
            loop
            controls
            src="/works-in-chrome-and-safari" 
            &gt;
        &lt;/video&gt;
    &lt;/body&gt;
&lt;/html&gt;</pre>
<h2>结论</h2>
<p>尽管视频流在Chrome上很容易实现，但在Safari上却很难实现——至少如果你试图自己根据HTTP规范来实现的话。</p>
<p>幸运的是，我已经走过了这条路，这篇博客文章已经为你自己的流媒体视频实现打下了基础。</p>
<h2>资源</h2>

<p>使用<a class="signup" href="https://lp.logrocket.com/blg/signup" target="_blank" rel="noopener noreferrer"> LogRocket </a>消除传统错误报告的干扰</p><div class="code-block code-block-1">
<div class="blog-plug base-cta"><h2><a href="https://lp.logrocket.com/blg/signup" target="_blank" rel="noopener noreferrer"> LogRocket </a>是一个数字体验分析解决方案，它可以保护您免受数百个假阳性错误警报的影响，只针对几个真正重要的项目。LogRocket会告诉您应用程序中实际影响用户的最具影响力的bug和UX问题。</h2>
<a href="https://lp.logrocket.com/blg/signup" class="signup" target="_blank" rel="noopener noreferrer"><img class="alignnone size-full wp-image-46 jetpack-lazy-image" src="../Images/d6f5a5dd739296c1dd7aab3d5e77eeb9.png" alt="LogRocket Dashboard Free Trial Banner" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2017/03/1d0cd-1s_rmyo6nbrasp-xtvbaxfg.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2017/03/1d0cd-1s_rmyo6nbrasp-xtvbaxfg.png"/><noscript><img data-lazy-fallback="1" class="alignnone size-full wp-image-46" src="../Images/d6f5a5dd739296c1dd7aab3d5e77eeb9.png" alt="LogRocket Dashboard Free Trial Banner" data-original-src="https://blog.logrocket.com/wp-content/uploads/2017/03/1d0cd-1s_rmyo6nbrasp-xtvbaxfg.png"/></noscript></a>
<p>然后，使用具有深层技术遥测的会话重放来确切地查看用户看到了什么以及是什么导致了问题，就像你在他们身后看一样。</p>
<p>LogRocket自动聚合客户端错误、JS异常、前端性能指标和用户交互。然后LogRocket使用机器学习来告诉你哪些问题正在影响大多数用户，并提供你需要修复它的上下文。</p>
<p>专注于重要的bug-<a class="signup" href="https://lp.logrocket.com/blg/signup-issue-free" target="_blank" rel="noopener noreferrer">试试今天的log火箭</a>。</p>
<p>Focus on the bugs that matter — <a class="signup" href="https://lp.logrocket.com/blg/signup-issue-free" target="_blank" rel="noopener noreferrer">try LogRocket today</a>.</p></div></div>

<p class="clearfix"/>
<p class="clearfix"/>
</article>

</div>    
</body>
</html>