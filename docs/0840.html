<html>
<head>
<title>Getting started with Cloud Pub/Sub in Node - LogRocket Blog</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>Node - LogRocket博客中的云发布/订阅入门</h1>
<blockquote>原文：<a href="https://blog.logrocket.com/getting-started-with-cloud-pub-sub-in-node/#0001-01-01">https://blog.logrocket.com/getting-started-with-cloud-pub-sub-in-node/#0001-01-01</a></blockquote><div><article class="article-post">
<h2>介绍</h2>
<p>近年来，由于微服务的流行，EDA(事件驱动架构)正在兴起。微服务由独立部署的小型独立单元组成，这些单元相互独立通信，构成一个成熟的应用程序。由于这些服务的独特性和模块化，维护与它们的弹性通信可能是一件麻烦的事情。这就是为什么需要消息代理。</p>
<p>简单地说，消息代理是一个中介软件，它将消息从一个或多个服务中继到其他服务。这种软件的一个例子是<a href="https://cloud.google.com/pubsub/docs" target="_blank" rel="noopener noreferrer">云发布/订阅</a>。</p>
<p>Cloud Pub/Sub是一个由Google完全管理的消息代理，它使用发布者-订阅者模型将信息从一个服务传递到其他订阅服务。发布/订阅使团队可以轻松地在服务之间建立通信通道，而不必担心单个服务的正常运行时间、重试策略和等幂性。</p>
<p>在本文中，我们将了解如何在Node.js中使用Cloud Pub/Sub实现服务间通信。</p>
<h2>先决条件</h2>
<p>本教程使用以下内容:</p>
<ol>
<li>Node.js的基础知识</li>
<li><a href="https://yarnpkg.com/lang/en/docs/install/" target="_blank" rel="noopener noreferrer">安装纱线</a>或<a href="https://www.npmjs.com/" target="_blank" rel="noopener noreferrer"> NPM </a>(我们将使用纱线)</li>
<li>安装了Git </li>
<li>安装了Ngrok </li>
<li>一个谷歌账户</li>
<li>配置为运行Node.js的开发计算机</li>
</ol>
<h2>装置</h2>
<p>在选择的任何终端中运行以下命令来初始化项目目录:</p>
<pre>$ git clone -b boilerplate http://github.com/enkaypeter/cloud-pub-sub-tut/
$ cd cloud-pub-sub-tut &amp;&amp; yarn</pre>
<p>已安装的软件包:</p>
<ul>
<li><a href="http://expressjs.com/" target="_blank" rel="noopener noreferrer">express</a>——一个用于旋转RESTful APIs的轻量级Node.js web框架。我们将使用它来处理后端应用编程接口中的路由</li>
<li>当我们修改/编辑代码时，这个包将帮助我们自动重启我们的开发服务器</li>
<li><a href="https://www.npmjs.com/package/body-parser" target="_blank" rel="noopener noreferrer">body-parser</a>——一个中间件，用于将输入的请求输入解析到我们的<code>req.body</code>对象中</li>
<li>用于Node.js的HTTP请求记录器中间件。这将帮助我们在开发过程中调试我们的API</li>
<li><a href="https://helmetjs.github.io/docs/" target="_blank" rel="noopener noreferrer">头盔</a>——这是一个中间件的集合，我们的基于express的服务器通过设置符合<a href="https://expressjs.com/en/advanced/best-practice-security.html" target="_blank" rel="noopener noreferrer">最佳安全实践</a>的HTTP头</li>
<li>这个包将有助于在我们的服务器上实现跨源资源共享</li>
<li><a href="https://www.npmjs.com/package/dotenv" target="_blank" rel="noopener noreferrer"> dotenv </a> —这个包将使我们能够通过<code>process.env</code>对象从我们的节点应用程序访问在<code>.env</code>文件中定义的环境</li>
<li>google-cloud/pubsub  —这是Cloud Pub/Sub的Node.js客户端。我们将使用它来发布消息和订阅我们的发布/订阅控制台中定义的主题</li>
</ul>
<h2>为GCP上的Pub/Sub设置服务帐户</h2>
<p>为了在我们的节点应用程序中初始化发布/订阅，我们需要在我们的GCP(谷歌云平台)控制台上获得一个配置有发布/订阅访问的服务帐户。我们将通过以下步骤实现这一点:</p>
<ul>
<li>登录<a href="https://console.cloud.google.com/?_ga=2.203312849.1788645844.1586151143-601160769.1581123822&amp;_gac=1.61200094.1585461690.Cj0KCQjw6_vzBRCIARIsAOs54z5QL5ch9JGZ6Mrq2ARpWOOrAJS626LQzThM_Craor-AP4qMgrxP_7saAvdAEALw_wcB" target="_blank" rel="noopener noreferrer">谷歌云控制台</a>并选择一个项目，或者按照提示创建一个项目(如果您是第一次)</li>
<li>导航到<a href="https://console.cloud.google.com/cloudpubsub?_ga=2.173884899.1788645844.1586151143-601160769.1581123822&amp;_gac=1.15587396.1585461690.Cj0KCQjw6_vzBRCIARIsAOs54z5QL5ch9JGZ6Mrq2ARpWOOrAJS626LQzThM_Craor-AP4qMgrxP_7saAvdAEALw_wcB" target="_blank" rel="noopener noreferrer">发布/订阅部分</a>为您的项目启用API</li>
<li>转到<a href="https://console.cloud.google.com/iam-admin/serviceaccounts?_ga=2.173884899.1788645844.1586151143-601160769.1581123822&amp;_gac=1.15587396.1585461690.Cj0KCQjw6_vzBRCIARIsAOs54z5QL5ch9JGZ6Mrq2ARpWOOrAJS626LQzThM_Craor-AP4qMgrxP_7saAvdAEALw_wcB" target="_blank" rel="noopener noreferrer">服务帐户</a>的部分，选择一个项目并创建一个服务帐户，如下所示:</li>
</ul>
<p><img data-attachment-id="17999" data-permalink="https://blog.logrocket.com/getting-started-with-cloud-pub-sub-in-node/cloudinfo/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/05/cloudinfo.png" data-orig-size="1280,800" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="cloudinfo" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/05/cloudinfo-300x188.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/05/cloudinfo-1024x640.png" decoding="async" class="aligncenter size-full wp-image-17999 jetpack-lazy-image" src="../Images/375d10f480632cd62b1ecb2a4f1e3bf6.png" alt="" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2020/05/cloudinfo.png 1280w, https://blog.logrocket.com/wp-content/uploads/2020/05/cloudinfo-300x188.png 300w, https://blog.logrocket.com/wp-content/uploads/2020/05/cloudinfo-1024x640.png 1024w, https://blog.logrocket.com/wp-content/uploads/2020/05/cloudinfo-768x480.png 768w" data-lazy-sizes="(max-width: 1280px) 100vw, 1280px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2020/05/cloudinfo.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/05/cloudinfo.png"/></p><noscript><img data-lazy-fallback="1" data-attachment-id="17999" data-permalink="https://blog.logrocket.com/getting-started-with-cloud-pub-sub-in-node/cloudinfo/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/05/cloudinfo.png" data-orig-size="1280,800" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="cloudinfo" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/05/cloudinfo-300x188.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/05/cloudinfo-1024x640.png" decoding="async" loading="lazy" class="aligncenter size-full wp-image-17999" src="../Images/375d10f480632cd62b1ecb2a4f1e3bf6.png" alt="" srcset="https://blog.logrocket.com/wp-content/uploads/2020/05/cloudinfo.png 1280w, https://blog.logrocket.com/wp-content/uploads/2020/05/cloudinfo-300x188.png 300w, https://blog.logrocket.com/wp-content/uploads/2020/05/cloudinfo-1024x640.png 1024w, https://blog.logrocket.com/wp-content/uploads/2020/05/cloudinfo-768x480.png 768w" sizes="(max-width: 1280px) 100vw, 1280px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/05/cloudinfo.png"/></noscript>
<p>输入服务帐户名称，例如pub-sub-key，然后单击create。</p>
<ul>
<li>向服务帐户授予访问发布/订阅管理权限，如下所示:</li>
</ul>
<p><img data-attachment-id="18001" data-permalink="https://blog.logrocket.com/getting-started-with-cloud-pub-sub-in-node/pubadmingrantaccess/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/05/pubadmingrantaccess.png" data-orig-size="690,663" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="pubadmingrantaccess" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/05/pubadmingrantaccess-300x288.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/05/pubadmingrantaccess.png" decoding="async" class="aligncenter size-full wp-image-18001 jetpack-lazy-image" src="../Images/add79081d7b5477e5f05d6635469f200.png" alt="grant access to the pub admin" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2020/05/pubadmingrantaccess.png 690w, https://blog.logrocket.com/wp-content/uploads/2020/05/pubadmingrantaccess-300x288.png 300w" data-lazy-sizes="(max-width: 690px) 100vw, 690px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2020/05/pubadmingrantaccess.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/05/pubadmingrantaccess.png"/></p><noscript><img data-lazy-fallback="1" data-attachment-id="18001" data-permalink="https://blog.logrocket.com/getting-started-with-cloud-pub-sub-in-node/pubadmingrantaccess/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/05/pubadmingrantaccess.png" data-orig-size="690,663" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="pubadmingrantaccess" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/05/pubadmingrantaccess-300x288.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/05/pubadmingrantaccess.png" decoding="async" loading="lazy" class="aligncenter size-full wp-image-18001" src="../Images/add79081d7b5477e5f05d6635469f200.png" alt="grant access to the pub admin" srcset="https://blog.logrocket.com/wp-content/uploads/2020/05/pubadmingrantaccess.png 690w, https://blog.logrocket.com/wp-content/uploads/2020/05/pubadmingrantaccess-300x288.png 300w" sizes="(max-width: 690px) 100vw, 690px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/05/pubadmingrantaccess.png"/></noscript>Click on Continue to give grant access to the service account
<ul>
<li>单击Create Key，选择JSON选项，并下载JSON对象。我们将需要节点项目目录中的这个文件来验证发布/订阅客户端</li>
</ul>
<h2>术语的定义</h2>
<p>在这一节中，我们将定义贯穿本文的几个术语。我们还将看看从发布者到订阅者的典型消息流。</p>
<ul>
<li>消息—这是转发给特定主题上的订阅服务的数据实体</li>
<li>主题——和每一次谈话一样，都有一个交流的主题。主题是表示消息提要的主题</li>
<li>订阅——这是订阅者实体的联盟，接收关于特定主题的发布消息</li>
<li>订户—这是一个实体，它被设置为通过推或拉的方式接收和确认来自特定主题的消息</li>
<li>发布者——这是一个实体，它创建消息并将其广播给主题上的订阅服务</li>
</ul>
<p>为了正确理解消息是如何从发布者传递到订阅者的，我们来看看流程图<a href="https://cloud.google.com/pubsub/docs/overview" target="_blank" rel="noopener noreferrer">发布/订阅文档</a>:</p>
<p><img data-attachment-id="18007" data-permalink="https://blog.logrocket.com/getting-started-with-cloud-pub-sub-in-node/pub_sub_flow/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/05/pub_sub_flow.png" data-orig-size="736,429" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="pub_sub_flow" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/05/pub_sub_flow-300x175.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/05/pub_sub_flow.png" decoding="async" class="aligncenter size-full wp-image-18007 jetpack-lazy-image" src="../Images/c0e43c86396558357acc7f85e8c53f5c.png" alt="pub sub flow" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2020/05/pub_sub_flow.png 736w, https://blog.logrocket.com/wp-content/uploads/2020/05/pub_sub_flow-300x175.png 300w" data-lazy-sizes="(max-width: 736px) 100vw, 736px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2020/05/pub_sub_flow.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/05/pub_sub_flow.png"/></p><noscript><img data-lazy-fallback="1" data-attachment-id="18007" data-permalink="https://blog.logrocket.com/getting-started-with-cloud-pub-sub-in-node/pub_sub_flow/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/05/pub_sub_flow.png" data-orig-size="736,429" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="pub_sub_flow" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/05/pub_sub_flow-300x175.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/05/pub_sub_flow.png" decoding="async" loading="lazy" class="aligncenter size-full wp-image-18007" src="../Images/c0e43c86396558357acc7f85e8c53f5c.png" alt="pub sub flow" srcset="https://blog.logrocket.com/wp-content/uploads/2020/05/pub_sub_flow.png 736w, https://blog.logrocket.com/wp-content/uploads/2020/05/pub_sub_flow-300x175.png 300w" sizes="(max-width: 736px) 100vw, 736px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/05/pub_sub_flow.png"/></noscript>
<ol>
<li>发布者应用程序(如订单服务)向主题(订单主题)发送消息(订单对象)</li>
<li>发布/订阅确保消息保留在存储器中，直到订阅所述主题(orders_topic)的服务确认消息接收</li>
<li>Pub/Sub然后<a href="https://en.wikipedia.org/wiki/Fan-out_(software)" target="_blank" rel="noopener noreferrer">将消息扇出</a>到orders_topic中的所有订阅实体</li>
<li>然后，订户从发布/订阅接收消息。这可以通过推送到订户配置的端点来完成，也可以通过订户从Pub/Sub拉所述消息来完成</li>
<li>订阅者对收到的每条消息向发布/订阅发送确认，然后从消息队列中删除确认的消息</li>
</ol>
<h2>问题域和建议的解决方案</h2>
<p>在这一部分中，我们将陈述我们的问题领域和建议的解决方案(概念验证),随着我们的深入，我们将共同构建这些问题领域和建议的解决方案。</p>
<h3>问题域</h3>
<p>比如说一个具有多种服务的电子商务软件/解决方案。订单服务、交付服务和通知服务。订单服务接收用户的订单，对其进行处理，然后将其发送给交付服务进行处理。交付服务商随后将对其进行处理，并不时地向用户通知(通知服务)包裹的交付状态。</p>
<p>通过在这些服务之间进行定期HTTP调用来实现这种软件体系结构，将会在出现边缘情况(如服务停机、添加更多服务等)时导致异常的系统行为。被介绍。</p>
<h3>拟议解决方案</h3>
<p>作为消息代理的Google Pub/Sub可以接收来自订单服务的消息，并充当订单服务和其他服务(交付、通知)之间的中继。发布/订阅具有消息重试策略，有助于抑制由于服务停机/故障而导致的订单丢失。它还使团队能够向应用程序堆栈添加更多的服务，并通过使新的和现有的服务能够订阅一个或多个主题来保持整个系统的节奏。</p>
<h2>构建发布者和订阅者</h2>
<p>在本节中，我们将构建发布者和订阅者(推和拉)逻辑，它将包含三个入口点文件— orders.js(发布者)、delivery-sub.js(订阅者A)和notification-sub.js(订阅者B)。这三个文件表示我们微服务架构中的三个服务。每个服务都有各自的路由和控制器，但是共享同一个发布-订阅库。发布-订阅存储库包含可重用的发布-订阅功能，用于发布消息和接收发布的消息。下面是<a href="https://github.com/enkaypeter/cloud-pub-sub-tut/tree/boilerplate/src" target="_blank" rel="noopener noreferrer">样板文件分支</a>的图示:</p>
<p><img data-attachment-id="18012" data-permalink="https://blog.logrocket.com/getting-started-with-cloud-pub-sub-in-node/project-directory-structure/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/05/project-directory-structure.png" data-orig-size="302,546" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="project directory structure" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/05/project-directory-structure-166x300.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/05/project-directory-structure.png" decoding="async" class="aligncenter size-full wp-image-18012 jetpack-lazy-image" src="../Images/1ec11e9e79ee8ec79d2492e461b19f6f.png" alt="project directory structure" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2020/05/project-directory-structure.png 302w, https://blog.logrocket.com/wp-content/uploads/2020/05/project-directory-structure-166x300.png 166w" data-lazy-sizes="(max-width: 302px) 100vw, 302px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2020/05/project-directory-structure.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/05/project-directory-structure.png"/></p><noscript><img data-lazy-fallback="1" data-attachment-id="18012" data-permalink="https://blog.logrocket.com/getting-started-with-cloud-pub-sub-in-node/project-directory-structure/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/05/project-directory-structure.png" data-orig-size="302,546" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="project directory structure" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/05/project-directory-structure-166x300.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/05/project-directory-structure.png" decoding="async" loading="lazy" class="aligncenter size-full wp-image-18012" src="../Images/1ec11e9e79ee8ec79d2492e461b19f6f.png" alt="project directory structure" srcset="https://blog.logrocket.com/wp-content/uploads/2020/05/project-directory-structure.png 302w, https://blog.logrocket.com/wp-content/uploads/2020/05/project-directory-structure-166x300.png 166w" sizes="(max-width: 302px) 100vw, 302px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/05/project-directory-structure.png"/></noscript>
<h3>发布/子存储库</h3>
<p>这是我们定义所有功能的地方，这些功能将使我们能够执行所有与发布/订阅相关的任务，例如发布消息和监听推送或请求订阅:</p>
<pre>// src/repositories/pub-sub-repo.js

module.exports = {
    publishMessage: async (pubSubClient, topicName, payload) =&gt; {
        const dataBuffer = Buffer.from(JSON.stringify(payload));
        const messageId = await pubSubClient.topic(topicName).publish(dataBuffer);
        console.log(`Message ${messageId} published.`);
        return messageId;
    }
 ...
};</pre>
<p>上面的代码片段显示了接受三个参数的<code>publishMessage</code>函数，即<code>pubSubClient</code>、<code>topicName</code>和<code>payload</code>。此函数将JSON有效负载序列化到缓冲区中(这是发布/订阅所需的消息格式)，然后在执行时将其发布到指定的主题:</p>
<pre>// src/repositories/pub-sub-repo.js

module.exports = {
  ...

  listenForPullMessages: (pubSubClient, subscriptionName,  timeout) =&gt; {
      const subscription = pubSubClient.subscription(subscriptionName);
      let messageCount = 0;
      const messageHandler = message =&gt; {
          console.log(`Received message ${message.id}:`);
          console.log(`\tData: ${message.data}`);
          console.log(`\tAttributes: ${message.attributes}`);
          messageCount += 1;
          message.ack();
      };
      subscription.on('message', messageHandler);
      setTimeout(() =&gt; {
          subscription.removeListener('message', messageHandler);
          console.log(`${messageCount} message(s) received.`);
      }, timeout * 1000);
  }

  ...

};</pre>
<p>上面的代码片段显示了一个订阅者函数，它将消息广播到与主题相关的订阅。在执行时，此函数在t * 1000ms毫秒内侦听从发布者扇出的消息(如果t = 60收听者将收听60秒，相当于1分钟):</p>
<pre>// src/repositories/pub-sub-repo.js

module.exports = {
  ...

  listenForPushMessages: (payload) =&gt; {
    const message = Buffer.from(payload, 'base64').toString(
        'utf-8'
    );
    let parsedMessage = JSON.parse(message);
    console.log(parsedMessage);
    return parsedMessage;
  }

  ...

}</pre>
<p>上面的代码片段接受来自已配置的订户端点的消息，并将缓冲区解析为JSON格式，供各个订户使用。</p>
<h2>构建发布者</h2>
<p>我们的publisher的基本逻辑位于<code>src/controllers/orders-controllers.js</code>文件中。它充当订单服务，接受来自用户的订单，处理订单，然后向相关服务(交付和通知)发送消息，通知它们有新订单:</p>
<pre>// src/controllers/orders-controller.js

const { PubSub } = require("@google-cloud/pubsub");
const pubsubRepository = require("../repositories/pub-sub-repo");

const pubSubClient = new PubSub();
const topicName = "orders_topic";
const { publishMessage } = pubsubRepository;

module.exports = {
    ...

    createOrders: async (req, res) =&gt; {
        let ordersObj = req.body;
        let messageId = await publishMessage(pubSubClient, topicName, ordersObj);
        return res.status(200).json({
            success: true,
            message: `Message ${messageId} published :)`
        })
    }

};</pre>
<p>上面的代码片段显示了接受订单请求主体并将对象发布到orders_topic的<code>createOrders</code>方法。</p>
<h3>建立订户</h3>
<p>有两个订户代表两个独立的服务——传递和通知。我们将在本节中单独构建交付服务，因为可以为通知服务重新创建相同的步骤:</p>
<pre>// src/controllers/delivery-controller.js

const { PubSub  } = require("@google-cloud/pubsub");
const pubSubClient = new PubSub();
const subscriptionName = "delivery_sub";
const timeout = 60;
const pubsubRepository = require("../repositories/pub-sub-repo");
const { listenForPullMessages, listenForPushMessages } = pubsubRepository;
module.exports = {
    ...

    pullDelivery: (req, res) =&gt; {
        try {
            listenForPullMessages(pubSubClient, subscriptionName, timeout);            
        } catch (error) {
            return res.status(500).json({
                success: false,
                message: "Couldn't receive orders object :(",
                data: error
            })                        
        }

    },
    pushDelivery: async (req, res) =&gt; {
        try {
            let messageResponse = await listenForPushMessages(req.body.message.data);
            return res.status(200).json({
                success: true,
                message: "Message received successfully :)",
                data: messageResponse
            })

        } catch (error) {
            return res.status(500).json({
                success: false,
                message: "Couldn't receive orders object :(",
                data: error
            })                        
        }
    }
};</pre>
<p><code>pullDelivery</code>函数从接受三个参数的<code>pubsubRepository</code>中执行<code>listenForPushMessages</code>函数；<code>pubSubClient</code>，订阅的名称(通知服务将被称为notifications_sub)，以及60秒的超时。</p>
<p>由于是一个webhook，<code>pushDelivery</code>函数接受从pub/sub获得的消息作为参数传递给<code>listenForPushMessages</code>函数，以便反序列化到JSON中。</p>
<h2>将这些点连接起来</h2>
<p>在这一部分，我们将前往我们的谷歌云控制台，创建一个主题和订户。我们还将学习如何分别运行我们的三项服务来验证概念。</p>
<p>为了创建主题，我们将导航到云控制台上的<a href="https://console.cloud.google.com/cloudpubsub?_ga=2.261965389.1788645844.1586151143-601160769.1581123822&amp;_gac=1.187161818.1585461690.Cj0KCQjw6_vzBRCIARIsAOs54z5QL5ch9JGZ6Mrq2ARpWOOrAJS626LQzThM_Craor-AP4qMgrxP_7saAvdAEALw_wcB" target="_blank" rel="noopener noreferrer">发布/订阅部分</a>,并创建orders_topic，如下所示:</p>
<p><img data-attachment-id="18026" data-permalink="https://blog.logrocket.com/getting-started-with-cloud-pub-sub-in-node/createorderstopic/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/05/createorderstopic.png" data-orig-size="1274,644" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="createorderstopic" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/05/createorderstopic-300x152.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/05/createorderstopic-1024x518.png" decoding="async" class="aligncenter size-full wp-image-18026 jetpack-lazy-image" src="../Images/e556f53c6ceecf4538db9b319ac046b1.png" alt="create orders topic" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2020/05/createorderstopic.png 1274w, https://blog.logrocket.com/wp-content/uploads/2020/05/createorderstopic-300x152.png 300w, https://blog.logrocket.com/wp-content/uploads/2020/05/createorderstopic-1024x518.png 1024w, https://blog.logrocket.com/wp-content/uploads/2020/05/createorderstopic-768x388.png 768w" data-lazy-sizes="(max-width: 1274px) 100vw, 1274px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2020/05/createorderstopic.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/05/createorderstopic.png"/></p><noscript><img data-lazy-fallback="1" data-attachment-id="18026" data-permalink="https://blog.logrocket.com/getting-started-with-cloud-pub-sub-in-node/createorderstopic/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/05/createorderstopic.png" data-orig-size="1274,644" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="createorderstopic" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/05/createorderstopic-300x152.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/05/createorderstopic-1024x518.png" decoding="async" loading="lazy" class="aligncenter size-full wp-image-18026" src="../Images/e556f53c6ceecf4538db9b319ac046b1.png" alt="create orders topic" srcset="https://blog.logrocket.com/wp-content/uploads/2020/05/createorderstopic.png 1274w, https://blog.logrocket.com/wp-content/uploads/2020/05/createorderstopic-300x152.png 300w, https://blog.logrocket.com/wp-content/uploads/2020/05/createorderstopic-1024x518.png 1024w, https://blog.logrocket.com/wp-content/uploads/2020/05/createorderstopic-768x388.png 768w" sizes="(max-width: 1274px) 100vw, 1274px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/05/createorderstopic.png"/></noscript>
<p>单击“创建主题”后，您将转到新创建的orders_topic页面，在这里您将创建一个订阅，如下所示:</p>
<p><img data-attachment-id="18028" data-permalink="https://blog.logrocket.com/getting-started-with-cloud-pub-sub-in-node/ordertopicpage/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/05/ordertopicpage.png" data-orig-size="574,638" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="ordertopicpage" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/05/ordertopicpage-270x300.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/05/ordertopicpage.png" decoding="async" class="aligncenter size-full wp-image-18028 jetpack-lazy-image" src="../Images/ae9a1d158b31e0e56f0e108432f7acd2.png" alt="order topic page " data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2020/05/ordertopicpage.png 574w, https://blog.logrocket.com/wp-content/uploads/2020/05/ordertopicpage-270x300.png 270w" data-lazy-sizes="(max-width: 574px) 100vw, 574px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2020/05/ordertopicpage.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/05/ordertopicpage.png"/></p><noscript><img data-lazy-fallback="1" data-attachment-id="18028" data-permalink="https://blog.logrocket.com/getting-started-with-cloud-pub-sub-in-node/ordertopicpage/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/05/ordertopicpage.png" data-orig-size="574,638" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="ordertopicpage" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/05/ordertopicpage-270x300.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/05/ordertopicpage.png" decoding="async" loading="lazy" class="aligncenter size-full wp-image-18028" src="../Images/ae9a1d158b31e0e56f0e108432f7acd2.png" alt="order topic page " srcset="https://blog.logrocket.com/wp-content/uploads/2020/05/ordertopicpage.png 574w, https://blog.logrocket.com/wp-content/uploads/2020/05/ordertopicpage-270x300.png 270w" sizes="(max-width: 574px) 100vw, 574px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/05/ordertopicpage.png"/></noscript>
<p>HTTPS URL代表托管我们递送服务的主机URL。发布/订阅要求所有推送端点都部署在HTTPS上。对于我们的通知服务，我们将重复上面的步骤，用“notification_sub”替换订阅ID，用<code>{{HTTPS_URL}}/api/delivery/push</code>替换端点URL。</p>
<blockquote><p>为了获取{{HTTPS网址}}，我们将在下一部分使用<a href="https://ngrok.com/" target="_blank" rel="noopener noreferrer"> ngrok </a>部署我们的订户</p></blockquote>
<h3>运行我们的服务</h3>
<p>为了演示三个微服务，我们在项目目录中创建了三个入口点(orders.js、notifications-sub.js和delivery-sub.js ),而不是只有app.js文件。</p>
<p>这些文件已经在我们的<a href="https://github.com/enkaypeter/cloud-pub-sub-tut/tree/boilerplate/src" target="_blank" rel="noopener noreferrer">项目存储库</a>中被创建和引导。以下是我们订单服务的定义:</p>
<pre>// src/orders.js

const express = require('express');
const morgan = require('morgan');
const bodyParser = require('body-parser');
require('dotenv').config();
const app = express();
const ordersRoute = require('./routes/orders');
const helmet = require('helmet');
const cors = require('cors');
app.use(bodyParser.urlencoded({ extended: false }));
app.use(bodyParser.json());
const { MAIN_PORT, NODE_ENV } = process.env;
NODE_ENV !== "production" ? app.use(morgan('dev')) : app.use(morgan('combined'));
app.use(helmet());
app.use(cors());
app.use('/api/orders', ordersRoute);


app.listen(MAIN_PORT);
if (NODE_ENV !== "production" ) {
    console.log(`Orders service is running at http://localhost:${MAIN_PORT}`);
}</pre>
<blockquote><p>如果您仍然在样板分支中，请通过运行下面的命令切换到主分支</p></blockquote>
<pre>$ git fetch origin master &amp;&amp; git checkout master</pre>
<p>在运行我们的应用程序之前，我们需要创建我们的<code>.env</code>文件，并将我们的服务帐户密钥复制到我们的项目目录中。<code>.env</code>文件应该是这样的:</p>
<pre>MAIN_PORT=8001
PORT_1=8002
PORT_2=8003

GCP_PROJ_ID=PROJECT_ID
GOOGLE_APPLICATION_CREDENTIALS=FILENAME.json</pre>
<blockquote><p>其中，项目ID = GCP项目ID，文件名=服务帐户文件名，两者都是在“服务帐户设置”部分创建的。</p></blockquote>
<p>既然已经解决了这个问题，让我们设置六个终端来同时运行我们的三个服务。在使用iTerm2的Mac计算机上，您可以通过使用CMD+SHIFT+D将单个窗口分成水平的两半来创建六个终端。然后通过在每个水平的两半上使用CMD+D两次，将每个水平的两半垂直地分成三个位置。如果一切顺利，您的终端应该如下图所示:</p>
<p><img data-attachment-id="18040" data-permalink="https://blog.logrocket.com/getting-started-with-cloud-pub-sub-in-node/sixterminals/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/05/sixterminals.png" data-orig-size="1280,800" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="sixterminals" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/05/sixterminals-300x188.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/05/sixterminals-1024x640.png" decoding="async" class="aligncenter size-full wp-image-18040 jetpack-lazy-image" src="../Images/3ab430008cb4f88f7a50ffe29a03caa9.png" alt="iTerm2 to create six terminals" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2020/05/sixterminals.png 1280w, https://blog.logrocket.com/wp-content/uploads/2020/05/sixterminals-300x188.png 300w, https://blog.logrocket.com/wp-content/uploads/2020/05/sixterminals-1024x640.png 1024w, https://blog.logrocket.com/wp-content/uploads/2020/05/sixterminals-768x480.png 768w" data-lazy-sizes="(max-width: 1280px) 100vw, 1280px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2020/05/sixterminals.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/05/sixterminals.png"/></p><noscript><img data-lazy-fallback="1" data-attachment-id="18040" data-permalink="https://blog.logrocket.com/getting-started-with-cloud-pub-sub-in-node/sixterminals/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/05/sixterminals.png" data-orig-size="1280,800" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="sixterminals" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/05/sixterminals-300x188.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/05/sixterminals-1024x640.png" decoding="async" loading="lazy" class="aligncenter size-full wp-image-18040" src="../Images/3ab430008cb4f88f7a50ffe29a03caa9.png" alt="iTerm2 to create six terminals" srcset="https://blog.logrocket.com/wp-content/uploads/2020/05/sixterminals.png 1280w, https://blog.logrocket.com/wp-content/uploads/2020/05/sixterminals-300x188.png 300w, https://blog.logrocket.com/wp-content/uploads/2020/05/sixterminals-1024x640.png 1024w, https://blog.logrocket.com/wp-content/uploads/2020/05/sixterminals-768x480.png 768w" sizes="(max-width: 1280px) 100vw, 1280px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/05/sixterminals.png"/></noscript>
<p>接下来，我们将在终端的上半部分本地运行我们的服务，在每个部分运行以下命令，如下所示:</p>
<pre>//upper terminal 1 (order service)
$ yarn start:main
//upper terminal 2 (delivery service)
$ yarn start:delivery
//upper terminal 3 (notification service)
$ yarn start:notification</pre>
<p>然后在下半部分，我们将使用ngrok为本地主机服务器提供公共URL，在每个部分运行以下命令，如下所示:</p>
<pre>//upper terminal 1 (order service)
$ ngrok http 8001
//upper terminal 2 (delivery service)
$ ngrok http 8002
//upper terminal 3 (notification service)
$ ngrok http 8003</pre>
<p>运行上面代码片段中的命令应该会得到如下图所示的终端:<br/> <img data-attachment-id="18045" data-permalink="https://blog.logrocket.com/getting-started-with-cloud-pub-sub-in-node/terminalngrok/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/05/terminalngrok.png" data-orig-size="1280,800" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="terminalngrok" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/05/terminalngrok-300x188.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/05/terminalngrok-1024x640.png" decoding="async" class="aligncenter size-full wp-image-18045 jetpack-lazy-image" src="../Images/56e11951d48fc1d9df8f187e0964feea.png" alt="six terminals after ngrok commands are run" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2020/05/terminalngrok.png 1280w, https://blog.logrocket.com/wp-content/uploads/2020/05/terminalngrok-300x188.png 300w, https://blog.logrocket.com/wp-content/uploads/2020/05/terminalngrok-1024x640.png 1024w, https://blog.logrocket.com/wp-content/uploads/2020/05/terminalngrok-768x480.png 768w" data-lazy-sizes="(max-width: 1280px) 100vw, 1280px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2020/05/terminalngrok.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/05/terminalngrok.png"/></p><noscript><img data-lazy-fallback="1" data-attachment-id="18045" data-permalink="https://blog.logrocket.com/getting-started-with-cloud-pub-sub-in-node/terminalngrok/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/05/terminalngrok.png" data-orig-size="1280,800" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="terminalngrok" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/05/terminalngrok-300x188.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/05/terminalngrok-1024x640.png" decoding="async" loading="lazy" class="aligncenter size-full wp-image-18045" src="../Images/56e11951d48fc1d9df8f187e0964feea.png" alt="six terminals after ngrok commands are run" srcset="https://blog.logrocket.com/wp-content/uploads/2020/05/terminalngrok.png 1280w, https://blog.logrocket.com/wp-content/uploads/2020/05/terminalngrok-300x188.png 300w, https://blog.logrocket.com/wp-content/uploads/2020/05/terminalngrok-1024x640.png 1024w, https://blog.logrocket.com/wp-content/uploads/2020/05/terminalngrok-768x480.png 768w" sizes="(max-width: 1280px) 100vw, 1280px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/05/terminalngrok.png"/></noscript>
<p>下图显示了订单服务上的订单请求和响应示例:</p>
<p><img data-attachment-id="18049" data-permalink="https://blog.logrocket.com/getting-started-with-cloud-pub-sub-in-node/sampleorderrequest/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/05/sampleorderrequest.png" data-orig-size="1012,663" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="sampleorderrequest" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/05/sampleorderrequest-300x197.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/05/sampleorderrequest.png" decoding="async" class="aligncenter size-full wp-image-18049 jetpack-lazy-image" src="../Images/db8a74b67d68179950a64438504b9218.png" alt="" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2020/05/sampleorderrequest.png 1012w, https://blog.logrocket.com/wp-content/uploads/2020/05/sampleorderrequest-300x197.png 300w, https://blog.logrocket.com/wp-content/uploads/2020/05/sampleorderrequest-768x503.png 768w" data-lazy-sizes="(max-width: 1012px) 100vw, 1012px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2020/05/sampleorderrequest.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/05/sampleorderrequest.png"/></p><noscript><img data-lazy-fallback="1" data-attachment-id="18049" data-permalink="https://blog.logrocket.com/getting-started-with-cloud-pub-sub-in-node/sampleorderrequest/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/05/sampleorderrequest.png" data-orig-size="1012,663" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="sampleorderrequest" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/05/sampleorderrequest-300x197.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/05/sampleorderrequest.png" decoding="async" loading="lazy" class="aligncenter size-full wp-image-18049" src="../Images/db8a74b67d68179950a64438504b9218.png" alt="" srcset="https://blog.logrocket.com/wp-content/uploads/2020/05/sampleorderrequest.png 1012w, https://blog.logrocket.com/wp-content/uploads/2020/05/sampleorderrequest-300x197.png 300w, https://blog.logrocket.com/wp-content/uploads/2020/05/sampleorderrequest-768x503.png 768w" sizes="(max-width: 1012px) 100vw, 1012px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/05/sampleorderrequest.png"/></noscript>
<h2>结论</h2>
<p>在本教程中，我们学习了什么是云发布/订阅，以及如何构建一个简单的案例来演示它在面向服务/微服务架构中的用法。如果你想获得更多关于Cloud Pub/Sub的信息，你可以访问官方文档。更多的发布/订阅相关内容，你可以查看YouTube上的<a href="https://www.youtube.com/watch?v=cvu53CnZmGI&amp;list=PLIivdWyY5sqKwVLe4BLJ-vlh9r9zCdOse" target="_blank" rel="noopener noreferrer">发布/订阅简易版</a>系列。</p>
<p>本教程的源代码也可以在GitHub上找到。你可以随意复制它，叉它，或者提交一个问题。</p><div class="code-block code-block-23">
<div class="blog-plug inline-plug node-plug"><h2>200只<img src="../Images/61167b9d027ca73ed5aaf59a9ec31267.png" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2019/10/green-check.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" class=" jetpack-lazy-image" data-original-src="https://blog.logrocket.com/wp-content/uploads/2019/10/green-check.png"/> <noscript> <img data-lazy-fallback="1" src="../Images/61167b9d027ca73ed5aaf59a9ec31267.png" data-original-src="https://blog.logrocket.com/wp-content/uploads/2019/10/green-check.png"/> </noscript>显示器出现故障，生产中网络请求缓慢</h2><p>部署基于节点的web应用程序或网站是容易的部分。确保您的节点实例继续为您的应用程序提供资源是事情变得更加困难的地方。如果您对确保对后端或第三方服务的请求成功感兴趣，</p><a href="https://lp.logrocket.com/blg/node-signup" target="_blank">try LogRocket</a><p>. </p><a class="signup" href="https://lp.logrocket.com/blg/node-signup" target="_blank" rel="noopener noreferrer"><img src="../Images/cae72fd2a54c5f02a6398c4867894844.png" alt="LogRocket Network Request Monitoring" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2019/12/network-request-filter-2-1.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" class=" jetpack-lazy-image" data-original-src="https://blog.logrocket.com/wp-content/uploads/2019/12/network-request-filter-2-1.png"/><noscript><img data-lazy-fallback="1" src="../Images/cae72fd2a54c5f02a6398c4867894844.png" alt="LogRocket Network Request Monitoring" data-original-src="https://blog.logrocket.com/wp-content/uploads/2019/12/network-request-filter-2-1.png"/></noscript></a><a href="https://lp.logrocket.com/blg/node-signup" target="_blank" rel="noopener noreferrer">https://logrocket.com/signup/</a><p>LogRocket 就像是网络和移动应用程序的DVR，记录下用户与你的应用程序交互时发生的一切。您可以汇总并报告有问题的网络请求，以快速了解根本原因，而不是猜测问题发生的原因。</p><p>LogRocket检测您的应用程序以记录基线性能计时，如页面加载时间、到达第一个字节的时间、慢速网络请求，还记录Redux、NgRx和Vuex操作/状态。</p><a class="signup" href="https://lp.logrocket.com/blg/node-signup" target="_blank" rel="noopener noreferrer">Start monitoring for free</a><p>. </p></div>
</div>

<p class="clearfix"/>
<p class="clearfix"/>
</article>

</div>    
</body>
</html>