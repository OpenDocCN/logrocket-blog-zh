<html>
<head>
<title>Using serverless functions with Nuxt.js - LogRocket Blog</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>通过Nuxt.js - LogRocket Blog使用无服务器函数</h1>
<blockquote>原文：<a href="https://blog.logrocket.com/using-serverless-functions-with-nuxt-js/#0001-01-01">https://blog.logrocket.com/using-serverless-functions-with-nuxt-js/#0001-01-01</a></blockquote><div><article class="article-post">
<p>前端开发人员构建web应用程序的方式一直在不断变化。如今，您不需要了解如何管理服务器来构建和发布应用程序。这就是无服务器的意义所在。</p>
<p>假设你正在你的投资组合网站上建立一个联系表单。通常，当你的访问者对你的服务感兴趣时，你会希望他们给你发一封电子邮件。您可能想要编写一个API来连接到您首选的邮件服务提供商，然后启动一个服务器来运行您的API。</p>
<p>这种做法有什么问题吗？不会。但是，服务器是全天候工作的，它总是为请求做好准备。对于组合网站联系人表单，这种方法成本低，而且浪费服务器资源。像这样的用例是无服务器真正派上用场的地方。</p>
<h2 id="whatdoesserverlessmean">无服务器是什么意思？</h2>
<p>无服务器并不意味着没有服务器；这只是意味着您使用第三方服务，如AWS，来管理和设置服务器，因此您只需提供自治功能。这些通常被称为无服务器功能。这样，您的无服务器“服务器”只在有请求时才旋转，并且只对在此期间使用的资源收费。</p>
<h2 id="serverlessfunctionsinaction">Nuxt.js中的无服务器函数</h2>
<p>为了展示无服务器函数是如何工作的，我们将使用Nuxt.js和Netlify函数构建一个联系人表单。完整应用的演示可在<a href="https://contact-serverless.netlify.app">此处</a>获得。</p>
<p>要跟随本教程，您需要以下内容。</p>
<ul>
<li>使用Vue.js和Nuxt.js的经验</li>
<li>净收益账户</li>
<li>一个<a href="https://www.mailgun.com/" target="_blank" rel="noopener noreferrer"> Mailgun </a>账户</li>
</ul>
<h3 id="settingupanuxtjsproject">设置一个Nuxt.js项目</h3>
<p>让我们从创建一个新的Nuxt.js应用程序开始。为了设计应用程序，我们将使用<a href="https://vue.chakra-ui.com/" target="_blank" rel="noopener noreferrer"> Chakra UI </a>，这是一个简单的模块化和可访问的组件库，它提供了快速构建Vue.js应用程序的构建块。</p>
<pre>yarn create nuxt-app serverless-contact-form
</pre>
<p>当提示输入UI框架时，选择Chakra UI。对于Nuxt.js模块，选择Axios。</p>
<p>完成后，启动应用程序。</p>
<pre>cd serverless-contact-form
yarn dev
</pre>
<p>对于本教程的其余部分，我们将假设应用程序正在运行。</p>

<p>为了简单明了，我们将联系表单直接放在主页上。因此，让我们更新<code>pages</code>目录中的<code>index.vue</code>文件。</p>
<p>首先更新<code>template</code>部分，如下所示。</p>
<pre>// pages/index.vue

&lt;template&gt;
  &lt;div class="container"&gt;
    &lt;CBox
      v-bind="mainStyles[colorMode]"
      d="flex"
      w="100vw"
      h="100vh"
      flex-dir="column"
      justify-content="center"
    &gt;
      &lt;CHeading text-align="center" mb="4"&gt;
        Serverless contact form
      &lt;/CHeading&gt;

      &lt;CFlex justify="center" direction="column" align="center"&gt;
        &lt;CBox mb="3"&gt;
          &lt;CIconButton
            mr="3"
            :icon="colorMode === 'light' ? 'moon' : 'sun'"
            :aria-label="`Switch to ${
              colorMode === 'light' ? 'dark' : 'light'
            } mode`"
            @click="toggleColorMode"
          /&gt;
        &lt;/CBox&gt;

        &lt;CBox text-align="left" width="50%"&gt;
          &lt;form @submit.prevent="sendContactToLambdaFunction"&gt;
            &lt;CFormControl&gt;
              &lt;CFormLabel for="name"&gt;
                Name
              &lt;/CFormLabel&gt;
              &lt;CInput id="name" v-model="form.name" type="text" aria-describedby="name" /&gt;
            &lt;/CFormControl&gt;

            &lt;CFormControl&gt;
              &lt;CFormLabel for="email"&gt;
                Email
              &lt;/CFormLabel&gt;
              &lt;CInput id="email" v-model="form.email" type="email" aria-describedby="email-helper-text" /&gt;
              &lt;CFormHelperText id="email-helper-text"&gt;
                We'll never share your email.
              &lt;/CFormHelperText&gt;
            &lt;/CFormControl&gt;

            &lt;CFormControl&gt;
              &lt;CFormLabel for="message"&gt;
                Message
              &lt;/CFormLabel&gt;
              &lt;CTextarea v-model="form.message" placeholder="Type your message" /&gt;
            &lt;/CFormControl&gt;

            &lt;CBox mt="12" d="flex" flex-dir="column" align="center"&gt;
              &lt;CButton type="submit" right-icon="arrow-forward" width="20%" variant-color="vue" variant="outline"&gt;
                Submit
              &lt;/CButton&gt;
            &lt;/CBox&gt;
          &lt;/form&gt;
        &lt;/CBox&gt;
      &lt;/CFlex&gt;
    &lt;/CBox&gt;
  &lt;/div&gt;
&lt;/template&gt;
</pre>
<p>联系表单包含三个字段:<code>name</code>、<code>email</code>和<code>message</code>。一旦提交了表单，就会调用一个处理发送消息的<code>sendContactToLambdaFunction()</code>。</p>
<p>让我们也更新一下<code>script</code>部分。</p>
<pre>// pages/index.vue

&lt;script lang="js"&gt;
  import {
    CBox,
    CButton,
    CIconButton,
    CFlex,
    CHeading,
    CTextarea,
    CFormControl,
    CFormLabel,
    CInput,
    CFormHelperText
  } from '@chakra-ui/vue'

export default {
  name: 'App',
  inject: ['$chakraColorMode', '$toggleColorMode'],
  components: {
    CBox,
    CButton,
    CIconButton,
    CFlex,
    CHeading,
    CTextarea,
    CFormControl,
    CFormLabel,
    CInput,
    CFormHelperText
  },
  data () {
    return {
      mainStyles: {
        dark: {
          bg: 'gray.700',
          color: 'whiteAlpha.900'
        },
        light: {
          bg: 'white',
          color: 'gray.900'
        }
      },
      form: {
        name: '',
        email: '',
        message: ''
      }
    }
  },
  computed: {
    colorMode () {
      return this.$chakraColorMode()
    },
    theme () {
      return this.$chakraTheme()
    },
    toggleColorMode () {
      return this.$toggleColorMode
    }
  },
  methods: {
    async sendContactToLambdaFunction () {
      try {
        const response = await this.$axios.$post('/.netlify/functions/contact-mail', {
          name: this.form.name,
          email: this.form.email,
          message: this.form.message
        })

        this.$toast({
          title: 'Mail sent',
          description: response,
          status: 'success',
          duration: 10000,
          isClosable: true
        })

        this.form.name = ''
        this.form.email = ''
        this.form.message = ''
      } catch (error) {
        this.$toast({
          title: 'An error occured',
          description: error,
          status: 'error',
          duration: 10000,
          isClosable: true
        })
      }
    }
  }
}
&lt;/script&gt;
</pre>
<p>当被触发时，<code>async sendContactToLambdaFunction()</code>向我们的Netlify函数发出一个API请求(我们将在下一节讨论)。</p>
<p>如果我们打开浏览器，我们应该会看到类似这样的内容:</p>
<p><img data-attachment-id="28398" data-permalink="https://blog.logrocket.com/using-feature-flags-with-unleash-and-node-js/nuxt-serverless-contact-form-2/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/11/nuxt-serverless-contact-form-1.png" data-orig-size="720,382" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Nuxt.js serverless contact form" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/11/nuxt-serverless-contact-form-1-300x159.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/11/nuxt-serverless-contact-form-1.png" decoding="async" class="aligncenter size-full wp-image-28398 jetpack-lazy-image" src="../Images/faa6a1bdce2fd40bc32c2a54f3a31b3f.png" alt="Nuxt.js Serverless Contact Form" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2020/11/nuxt-serverless-contact-form-1.png 720w, https://blog.logrocket.com/wp-content/uploads/2020/11/nuxt-serverless-contact-form-1-300x159.png 300w" data-lazy-sizes="(max-width: 720px) 100vw, 720px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2020/11/nuxt-serverless-contact-form-1.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/11/nuxt-serverless-contact-form-1.png"/></p><noscript><img data-lazy-fallback="1" data-attachment-id="28398" data-permalink="https://blog.logrocket.com/using-feature-flags-with-unleash-and-node-js/nuxt-serverless-contact-form-2/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/11/nuxt-serverless-contact-form-1.png" data-orig-size="720,382" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Nuxt.js serverless contact form" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/11/nuxt-serverless-contact-form-1-300x159.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/11/nuxt-serverless-contact-form-1.png" decoding="async" loading="lazy" class="aligncenter size-full wp-image-28398" src="../Images/faa6a1bdce2fd40bc32c2a54f3a31b3f.png" alt="Nuxt.js Serverless Contact Form" srcset="https://blog.logrocket.com/wp-content/uploads/2020/11/nuxt-serverless-contact-form-1.png 720w, https://blog.logrocket.com/wp-content/uploads/2020/11/nuxt-serverless-contact-form-1-300x159.png 300w" sizes="(max-width: 720px) 100vw, 720px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/11/nuxt-serverless-contact-form-1.png"/></noscript>
<p>在这个阶段，我们已经准备好了UI和逻辑，但是还没有任何API端点。在最后一部分，我们将调用还不存在的<code>/.netlify/functions/contact-mail</code>。</p>
<p>在此之前，让我们花点时间了解一下什么是网络函数。</p>
<h2 id="whatarenetlifyfunctions">什么是网络功能？</h2>
<p>最流行的无服务器架构——或功能即服务(FaaS)——提供商是<a href="https://blog.logrocket.com/testing-node-serverless-applications-aws-lambda-functions/" target="_blank" rel="noopener noreferrer"> AWS Lambda </a>。但AWS不适合小规模应用。Netlify允许您在没有AWS帐户的情况下部署无服务器Lambda函数，并且管理直接在Netlify中处理。</p>
<p>Netlify还提供了一种在本地使用<a href="https://www.netlify.com/products/dev/" target="_blank" rel="noopener noreferrer"> Netlify Dev </a>测试无服务器功能的方法。让我们确保我们已经安装了它。</p>
<pre>// NPM
npm install netlify-cli -g

// Yarn
yarn add global netlify-cli
</pre>
<p>现在让我们在项目的根目录下创建一个<code>netlify.toml</code>文件。这个配置文件告诉Netlify如何构建和部署项目。</p>
<p>我们的本地开发环境也需要它。</p>
<pre>// netlify.toml

[dev]
   command = "yarn dev"
[build]
  command = "yarn generate"
  publish = "dist"
  functions = 'functions'  # directs netlify to where your functions directory is located

[[headers]]
  # Define which paths this specific [[headers]] block will cover.
  for = "/*"
    [headers.values]
    Access-Control-Allow-Origin = "*"
</pre>
<p>通过运行以下命令创建Netlify函数。</p><div class="code-block code-block-54">
<hr/>
<h3>更多来自LogRocket的精彩文章:</h3>

<hr/></div>
<pre>netlify functions:create contact-mail
</pre>
<p>然后，选择显示async/await用法和响应格式化选项的<code>[hello-world]</code>基本函数。这个命令将在项目的根目录下创建一个<code>functions</code>目录和一个<code>contact-mail.js</code>文件。</p>
<p>要在本地测试该函数，请运行:</p>
<pre>netlify dev
</pre>
<p>这将启动开发服务器。</p>
<p>然后:</p>
<pre>netlify functions:invoke contact-mail --no-identity
</pre>
<p>您应该得到这样的结果:</p>
<pre>{"message":"Hello World"}
</pre>
<h2 id="settingupmailgun">设置Mailgun</h2>
<p>为了处理电子邮件的发送，我们将使用<a href="https://www.mailgun.com/" target="_blank" rel="noopener noreferrer"> Mailgun </a>，它为测试提供了一个沙箱域。</p>
<p>抓住你的沙盒域以及你的API密钥从你的帐户仪表板。在<strong>发送&gt;域名下，</strong>你应该看到一个沙盒域名。选择API并复制API密钥、API基本URL和沙盒域。</p>
<p>接下来，安装必要的依赖项:</p>
<pre>yarn add dotenv mailgun-js
</pre>
<p>我们将使用<code>dotenv</code>来访问我们的本地环境变量。当部署我们的应用程序时，它将配置Netlify在生产中使用适当的细节。<code>mailgun-js</code>是用于与Mailgun API交互的Node.js模块。</p>
<p>在根目录下创建一个<code>.env</code>文件，并插入正确的值:</p>
<pre>// .env

MG_API_KEY=YOUR_API_KEY
MG_DOMAIN=YOUR_SANDBOX_DOMAIN
MG_HOST=YOUR_API_BASE_URL
TO_EMAIL_ADDRESS=ADDRESS_EMAIL_WILL_BE_SENT_TO
</pre>
<p>现在，让我们转到实际的函数逻辑。将下面的代码片段粘贴到<code>contact-mail.js</code>中。</p>
<pre>// functions/contact-mail.js

require('dotenv').config()

const { MG_API_KEY, MG_DOMAIN, MG_HOST, TO_EMAIL_ADDRESS } = process.env
const mailgun = require('mailgun-js')({ apiKey: MG_API_KEY, domain: MG_DOMAIN, url: MG_HOST})

exports.handler = async (event) =&gt; {
  if (event.httpMethod !== 'POST') {
    return {
      statusCode: 405,
      body: 'Method Not Allowed',
      headers: { 'Allow': 'POST' }
    }
  }

  const data = JSON.parse(event.body)

  if (!data.message || !data.name || !data.email) {
    return { statusCode: 422, body: 'Name, email, and message are required.' }
  }

  const mailgunData = {
    from: data.email,
    to: TO_EMAIL_ADDRESS,
    'h:Reply-To': data.email,
    subject: `New mail from ${data.name}`,
    html: `
    &lt;h4&gt; Email from ${data.name} ${data.email} &lt;/h4&gt;
    &lt;p&gt; ${data.message}&lt;/p&gt;
    `
  }

  try {
    await mailgun.messages().send(mailgunData)

    return {
      statusCode: 200,
      body: 'Your message was sent successfully!'
    }
  } catch (error) {
      return {
        statusCode: 422,
        body: `Error: ${error}`
      }
  }
}
</pre>
<p>让我们来看看这个函数的活动部分。首先，<code>require('dotenv').config()</code>让我们能够通过<code>process.env</code>访问环境变量。接下来，我们用所需的参数实例化Mailgun模块。</p>
<p>然后，我们对传入的请求执行一些验证。首先，传入的请求必须是一个<code>POST</code>请求。如果任何字段为空，服务器应该返回状态代码<code>422</code>(不可处理的实体)。</p>
<p>接下来，我们构建电子邮件正文。Mailgun接受<code>to</code>、<code>from</code>、<code>subject</code>、HTML和文本部分、附件等。</p>
<p>最后，我们将对象传递给<code>mailgun.messages.send()</code>，并从Mailgun返回错误或成功消息。</p>
<p>现在我们可以运行:</p>
<pre>netlify dev
</pre>
<p>这将启动函数和Nuxt.js应用程序的开发服务器。你不用担心前端和API端点如何协同工作；Netlify会为您处理这些细节。</p>
<p>您会注意到该函数运行在端口<code>8888</code>上，而Nuxt.js应用运行在端口<code>3000</code>上。Netlify Dev将合并它们，并在浏览器的端口<code>8888</code>上运行。</p>
<h2 id="testing">测试</h2>
<p>是时候检验我们所建造的东西了。您可以使用Postman或任何其他HTTP客户端，但是我们将使用Netlify Dev，因为它使我们能够执行<code>POST</code>请求。</p>
<p>运行以下命令。</p>
<pre>netlify functions:invoke contact-mail --no-identity --payload '{"email": "<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="593a3130363438193c21383429353c773a3634">[email protected]</a>", "name": "Chioma", "message": "hello this function works fine!"}'
</pre>
<p>您应该会在终端和邮箱中得到类似下面这样的响应。</p>
<pre>Your message was sent successfully! We'll be in touch.
</pre>
<p>当然，你也可以直接在浏览器里用app测试出来。</p>
<h2 id="deployingtonetlify">部署到网络</h2>
<p>最后，让我们部署我们的静态应用程序。运行下面的命令来生成<code>dist</code>目录。</p>
<pre>yarn generate
</pre>
<p>下一步是在Netlify上创建一个全新的网站。</p>
<pre>netlify init
</pre>
<p>在Netlify上进入你的站点仪表板，点击<strong>功能</strong>选项卡，你应该会看到你的<code>contact-mail.js</code>功能。</p>
<p><img data-attachment-id="28407" data-permalink="https://blog.logrocket.com/using-serverless-functions-with-nuxt-js/nuxt-contact-mail-function-2/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/11/nuxt-contact-mail-function-1.png" data-orig-size="635,148" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Nuxt.js contact mail function" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/11/nuxt-contact-mail-function-1-300x70.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/11/nuxt-contact-mail-function-1.png" decoding="async" class="aligncenter size-full wp-image-28407 jetpack-lazy-image" src="../Images/4dc571e444f217e70615125c660ce256.png" alt="Nuxt.js Contact Mail Function" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2020/11/nuxt-contact-mail-function-1.png 635w, https://blog.logrocket.com/wp-content/uploads/2020/11/nuxt-contact-mail-function-1-300x70.png 300w" data-lazy-sizes="(max-width: 635px) 100vw, 635px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2020/11/nuxt-contact-mail-function-1.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/11/nuxt-contact-mail-function-1.png"/></p><noscript><img data-lazy-fallback="1" data-attachment-id="28407" data-permalink="https://blog.logrocket.com/using-serverless-functions-with-nuxt-js/nuxt-contact-mail-function-2/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/11/nuxt-contact-mail-function-1.png" data-orig-size="635,148" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Nuxt.js contact mail function" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/11/nuxt-contact-mail-function-1-300x70.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/11/nuxt-contact-mail-function-1.png" decoding="async" loading="lazy" class="aligncenter size-full wp-image-28407" src="../Images/4dc571e444f217e70615125c660ce256.png" alt="Nuxt.js Contact Mail Function" srcset="https://blog.logrocket.com/wp-content/uploads/2020/11/nuxt-contact-mail-function-1.png 635w, https://blog.logrocket.com/wp-content/uploads/2020/11/nuxt-contact-mail-function-1-300x70.png 300w" sizes="(max-width: 635px) 100vw, 635px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/11/nuxt-contact-mail-function-1.png"/></noscript>
<p>在我们结束之前，让我们添加Netlify上的环境变量。进入<strong>设置&gt;构建&amp;部署&gt;环境</strong>，在你的<code>.env</code>中添加环境变量。</p>
<p>最后，重新部署应用程序以使更改生效。</p>
<h2 id="conclusion">结论</h2>
<p>在本教程中，我们通过使用Nuxt.js构建一个静态应用程序并使用Netlify函数设置API端点来探索无服务器。我们讨论了这种方法相对于使用传统服务器的优势。最后，我们介绍了如何使用Netlify Dev简单快速地构建和部署无服务器应用程序。</p>
<p>要了解更多信息，请查看官方的<a href="https://docs.netlify.com/functions/overview/" target="_blank" rel="noopener noreferrer">网络功能文档</a>。</p>
<p>这个项目的源代码可以在<a href="https://github.com/ammezie/serverless-contact-form" target="_blank" rel="noopener noreferrer"> GitHub </a>上找到。</p>

<p class="clearfix"/>
<p class="clearfix"/>
</article>

</div>    
</body>
</html>