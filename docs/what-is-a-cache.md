# 什么是缓存？

> 原文：<https://blog.logrocket.com/what-is-a-cache/>

你对什么是缓存有一个模糊的概念，但是想要真正地理解它吗？想了解如何使用缓存来使您的应用程序更快、更有弹性，甚至减少客户端的资源消耗吗？那么这篇文章就送给你了。

在本文中，我们将介绍什么是缓存，以及哪些类型的缓存与大多数前端开发人员相关。我们将讨论如何通过服务人员、浏览器本身和外部缓存(如 cdn 和后端)在 JavaScript 中缓存数据。最后，我们将看看缓存失效，并尝试对它是什么以及为什么它如此难以正确处理有一个基本的理解。

## 什么是缓存？🤔

在我们深入研究实现缓存的许多方法之前，我们应该先看一下什么是缓存的某种技术定义。简而言之，缓存是一种保存您之前收到的数据的方式，以便以后更容易检索。我通过一个例子来解释这个。

像大多数互联网用户一样，你可能在某个时间点下载了一个文件到你的电脑上。也许这是你和学校的几个朋友正在做的一份文件。因为它现在在你的电脑上，你可以随时访问它，而不用每次你想用它的时候都去拿一份新的拷贝。这种以更容易(或更便宜)的方式访问某些资源的功能是缓存的主要思想。

我们看到这种技术用在现代技术堆栈的大部分部分。我们将照片缓存在浏览器中，以便在后续访问中立即显示出来。我们将用户 JSON 对象缓存在某种状态管理库中，这样我们就不必在每次想要改变显示内容时向服务器询问用户名。我们甚至在浏览器中缓存整个网络应用程序，这样它们就可以在没有互联网连接的情况下工作(所谓的渐进式网络应用程序或 PWAs)。

## 那么，为什么不永远保存所有东西呢？

有了所有这些好处，你可能会问自己为什么我们不永远缓存所有东西！如果我们在本地已经有了新数据，为什么还要费心去获取新数据呢？事实证明，世界不是一成不变的，我们下载的数据有可能在未来发生变化。因此，无论何时缓存过期信息，我们都要冒处理这些信息的风险。

知道缓存什么以及缓存多长时间，是需要您真正考虑每条信息的使用情形以及立即反映变化有多重要的问题之一。这就是为什么我一直认为这是一门正确的艺术。说了这么多，我们将在本文的后面通过一些例子给你一些实用的提示。

## 不同类型的缓存

作为一名前端开发人员，随着您在栈中的进展，您将会看到相当多不同的缓存类型。下面是对每个缓存“层”的描述，以及它何时发光。

### JavaScript 缓存

您的代码将遇到的第一个缓存通常是您自己创建的缓存。也就是说，以某种方式将来自 API 的数据保存在内存中。

没有无效的简单缓存的一个非常简单的实现(放松，我们稍后将回到这意味着什么)可能是这样的:

```
let cache = {};
async function getCachedValue(key, callback) {
  if (cache.hasOwnProperty(key)) {
    return cache[key];
  }
  const result = await callback();
  cache[key] = result;
  return result;
}

```

这里，我们有一个“全局”缓存对象，它在对这个缓存函数的调用之间保持不变。我们检查缓存是否包含缓存键，如果包含，我们只需返回缓存的值。如果没有，我们调用提供的回调函数以某种方式获取一个值，将其放入缓存并返回给用户。

然后，您可以用一个键和一个回调函数调用该函数，该回调函数将异步获取相关数据:

```
const user = getCachedValue("user", async () => {
  const res = await fetch("/api/user");
  return res.json();
});

```

这里，我们将在第一次调用这个代码时获取用户。第二次，我们会在缓存中找到用户，并避免对服务器的额外调用。

有大量的图书馆在这方面提供帮助。我自己编写大部分 React 代码，在这个生态系统中， [SWR](https://swr.vercel.app) 和 [react-query](https://react-query.tanstack.com/) 是为你实现这样一个缓存的两个很好的论据(除了你需要的许多其他不错的特性)。

### HTTP 缓存

缓存是 web 浏览器最基本的特性之一，几十年来一直如此。这就是为什么它内置于从服务器向用户传输数据的协议中 HTTP。通过每个响应前的特殊头字段，服务器可以指示浏览器在特定时间段内缓存特定文件。特别是，它是您想要读入的`Cache-Control`头。

大多数用户听到缓存时都会想到这种缓存机制。你可能在某个时候听说过“清除你的缓存”这个术语，这是一种修复网站上一些奇怪的 bug 的方法，这就是他们所说的缓存。

通过 HTTP 缓存资源是改进站点的一个不可思议的工具。通过添加正确的缓存头，并可能为所有静态资源创建唯一的文件名，您可以在客户端无限期地缓存所有资源(直到有人告诉您的用户清除他们的缓存)。如果小心操作，甚至动态内容也可以被缓存。

我很想深入研究 HTTP 缓存技术，但是 MDN 在这方面的资源太全面了，所以不推荐。点击查看[。](https://developer.mozilla.org/en-US/docs/Web/HTTP/Caching)

### 服务工作者缓存

有时，您需要 HTTP 缓存的强大功能和 JavaScript 的可编程性。那是你能接触到所谓的服务人员的地方。服务工作器使您能够(除其他外)在本地缓存所有资源，但对何时缓存什么以及缓存多长时间有完全的编程控制。

服务人员充当所有网络请求的中介。每当您的 web 应用程序请求一个资源(比如说一个图像)时，您都可以拦截它，查找缓存的版本(或者回退)并返回它，所有这些都是在后台获取更新的版本。

结合简单的[清单文件](https://web.dev/add-manifest/)，服务人员甚至可以让您在初次访问后创建完整的网站离线体验。在一个数据覆盖不像你想象的那样普遍的世界里，这是一个非常有价值的特性！

让我最后补充一句告诫的话。由于服务人员非常强大，在可预见的未来，他们也有可能毁掉你的网站。因为它们是作为一个独立于站点其余部分的进程运行的，所以它会在一个版本和下一个版本之间保持不变。换句话说，你需要特别小心，确保你不会搞砸任何事情😅。

* * *

### 更多来自 LogRocket 的精彩文章:

* * *

幸运的是，有一些工具可以帮助您创建现成的服务工作者缓存。你可以将类似于 [Google 的工具箱](https://developers.google.com/web/tools/workbox)的工具插入到你的构建管道中，并为你生成一个。任务完成。

### 后端缓存

前端开发人员面临的最后一个缓存难题与前端毫无关系。相反，缓存发生在应用程序的服务器端。

但是为什么我们还需要后端缓存呢？服务器通常比最强大的客户端拥有更多的资源和网络稳定性，那么为什么还需要缓存呢？事实证明，服务器也会向其他服务请求数据。

以数据库查询为例。扫描一个有数百万条记录的数据库来找到与特定查询相关的记录可能需要几秒钟。后端工程师可能会选择将这些查询缓存一段时间，而不是一遍又一遍地做这些工作。我们控制之外的其他外部服务也可能是很好的缓存机会。

服务器端的缓存通常包括一个称为分布式缓存的概念，这使事情变得相当复杂。因为您可能运行不止一个服务器，并且一个请求可以被定向到这些服务器中的任何一个，所以您需要在它们之间有一个共享的缓存。使用类似于 [hazelcast](https://hazelcast.com/) 的工具，这已经变得更加容易，但是对于许多人来说仍然是一个绊脚石。

我不会深入讨论这种缓存的太多细节，因为我发现这超出了本文的范围。但是要知道这里也有很多东西要学！

## 从缓存中删除内容

有时，您不想再缓存某些内容。这通常有三个很好的理由。它可能已经变了，可能太旧了，或者可能用得不够勤。

### 很少使用的条目

让我们从删除不常使用的条目开始。为什么要吝啬于缓存很少使用的数据呢？嗯，因为空间的原因。简而言之，缓存只是保存数据的一种方式，其中一些数据可能以兆字节计相当大。有时，根据您系统的配置，您将会耗尽空间来重复保存数据。然后，我们需要以某种方式根据有用性对缓存条目进行排序，缓存资源的使用频率无疑是有用性的一个很好的度量。因此，如果我们试图向缓存中添加一个新条目，我们需要首先删除最少使用的条目。

有几种方法可以确定什么是最没用的条目——它可能是在给定时间间隔内被查找次数最少的条目，或者是最近最少使用的条目。选择哪种技术取决于您和您的具体需求。

### 旧条目

另一种控制缓存大小，同时确保数据足够新的方法是根据缓存条目在缓存中存在的时间来删除它们。您可能希望缓存图像的时间比您的用户数据长，因为图像很少改变，但是在某些时候，您可能还希望获取图像的新版本——以防万一。

如果请求缓存的资源，并且缓存的项目过期，则取而代之的是获取新的版本，旧的条目将被换出，使缓存再次保持新鲜。

### 缓存失效

我告诉过你我们会回到缓存失效。那到底是什么？

缓存失效是从缓存中删除缓存数据子集的艺术。如果您正在更新缓存中的数据，并且希望您的应用程序获取一个新版本，您通常希望这样做。

根据您进行缓存的位置，您也将有不同的方式来进行缓存。如果您正在以编程方式做一些事情(比如在 JavaScript 中)，您可以简单地删除缓存条目，并在后台请求一个新条目。

## 摘要

缓存很难，因为缓存是很多不同的东西。你可以在你的应用程序中缓存东西，通过 HTTP，通过服务人员，甚至在后端本身。对于许多人来说，什么时候该做不是很明显，但是希望这给了你一些它是如何工作的概念。最后，我们看了为什么你会想要从缓存中删除一些东西，以及做这件事的不同方法。

## 使用 [LogRocket](https://lp.logrocket.com/blg/signup) 消除传统错误报告的干扰

[![LogRocket Dashboard Free Trial Banner](img/d6f5a5dd739296c1dd7aab3d5e77eeb9.png)](https://lp.logrocket.com/blg/signup)

[LogRocket](https://lp.logrocket.com/blg/signup) 是一个数字体验分析解决方案，它可以保护您免受数百个假阳性错误警报的影响，只针对几个真正重要的项目。LogRocket 会告诉您应用程序中实际影响用户的最具影响力的 bug 和 UX 问题。

然后，使用具有深层技术遥测的会话重放来确切地查看用户看到了什么以及是什么导致了问题，就像你在他们身后看一样。

LogRocket 自动聚合客户端错误、JS 异常、前端性能指标和用户交互。然后 LogRocket 使用机器学习来告诉你哪些问题正在影响大多数用户，并提供你需要修复它的上下文。

关注重要的 bug—[今天就试试 LogRocket】。](https://lp.logrocket.com/blg/signup-issue-free)