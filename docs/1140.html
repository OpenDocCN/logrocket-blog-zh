<html>
<head>
<title>Switching from GraphQL to REST? Take a load off with Sofa - LogRocket Blog</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>从GraphQL切换到REST？用沙发日志博客放松一下</h1>
<blockquote>原文：<a href="https://blog.logrocket.com/switch-graphql-to-rest-with-sofa/#0001-01-01">https://blog.logrocket.com/switch-graphql-to-rest-with-sofa/#0001-01-01</a></blockquote><div><article class="article-post">
<p>从GraphQL切换到REST或将GraphQL AP转换为REST API有几个原因。举一个非常基本的例子，您可能想要适应偏好REST的API消费者。</p>
<p>GraphQL不是万能的解决方案。它旨在以声明的方式使您能够只选择您需要的信息或操作。这可能是福也可能是祸；要求太多东西会影响你的应用程序的性能。</p>
<p>随着用户群的增长，您可能希望将请求的内容存储在<a href="https://www.nginx.com/resources/glossary/reverse-proxy-server/" target="_blank" rel="noopener noreferrer">反向代理服务器</a>中，以减少服务器的流量。或者，您可能决定将经常访问的信息保存在靠近使用CDN的客户端的位置。</p>
<p>REST API通常公开许多端点，因此很容易配置web缓存来匹配某些URL模式、HTTP方法或特定资源。GraphQ不是这样的，它只公开一个端点来进行查询。由于每个查询都可能不同，因此配置web缓存更加困难。</p>
<p>这些只是利用GraphQL和REST的优点所带来的一些好处。但在实践中，你如何实现这种转变呢？</p>
<p>一种方法是使用REST端点重新实现GraphQL查询。另一种方法是实现一个HTTP代理服务器，它接受REST请求，然后在返回响应之前调用GraphQL API。</p>
<p>在本教程中，我将带您了解如何使用我的首选解决方案将GraphQL查询、变异和订阅转换为REST API: <a href="https://sofa-api.com/" target="_blank" rel="noopener noreferrer"> Sofa </a>。</p>
<h2 id="whygothesofaway">为什么是沙发？</h2>
<p>Sofa是安装在GraphQL服务器上的Node.js库。根据<a href="https://sofa-api.com/" target="_blank" rel="noopener noreferrer">官方文档</a>，Sofa“获取你的GraphQL模式，寻找可用的查询、变异和订阅，并将所有这些转化为REST API。”</p>
<p>使用Sofa将您的GraphQL API切换到REST可以让您的REST API在几分钟内工作，而不是几天、几周甚至几个月。Sofa简单地采用您现有的GraphQL模式并返回相应的REST端点，消除了重写代码库或编写代理服务器的需要。通过这种方式，您可以逐渐迁移到REST，而不会影响现有代码的内部实现。它是自动生成的，并带有最新的REST API文档。</p>
<h2 id="howsofaworks">沙发的工作原理</h2>
<p>让我们借助Sofa、GraphQL、Express来搭建一个小书作者API服务器。然后，我们将从中创建和阅读书籍和作者。</p>
<p>首先，初始化一个新的Node.js项目并安装所需的依赖项。</p>
<pre>mkdir sofa-api-example
cd sofa-api-example
npm init
npm install express typescript graphql express-graphql graphql-tools
</pre>
<p>使用下面的命令创建一个TypeScript配置文件(<code>tsconfig.json</code>)。</p>
<pre>npx tsc --init --rootDir src --outDir build \
--esModuleInterop --resolveJsonModule --lib es6 \
--module commonjs --allowJs true --noImplicitAny true
</pre>
<p>接下来，创建一个模式文件(<code>types.ts</code>)。</p>
<pre>// types.ts

export const typeDefs = `
  type Book {
    id: ID!
    title: String!
    author: [Author!]!
    summary: String
    genre: [Genre]
  }
  type Author {
    id: ID!
    firstname: String!
    lastname: String!
    dob: String
  }
  type Genre {
    id: ID!
    name: String!
  }
  input AuthorInput{
    firstname: String!
    lastname: String!
    dob: String
  }
  input BookInput{
    title: String!
    author: String!
    summary: String
    genre: String!
  }
  type Query {
    book(id: ID!): Book
    books: [Book!]
    author(id: ID!): Author
    authors: [Author!]
    genre(id: ID!): Genre
    genres: [Genre!]
  }
  type Mutation {
    addBook(book: BookInput!): Book
    addAuthor(author: AuthorInput!): Author
    addGenre(name: String!): Genre
  }
  type Subscription {
    onBook: Book
  }
  schema {
    query: Query
    mutation: Mutation
    subscription: Subscription
  }
`;
</pre>
<p>定义了模式之后，下一步是定义相应的解析器。</p>
<pre>// resolver.ts

import { books, authors, genres } from './data';
import Chance from 'chance';
const chance = new Chance();
import { PubSub } from 'graphql-subscriptions';
const pubsub = new PubSub();
const BOOK_ADDED = 'BOOK_ADDED';
export const resolvers = {
  Query: {
    book(_: any, { id }: any){
      return books.find(book =&gt; book.id === id)
    },
    books(){
      return books
    },
    author(_: any, { id }: any){
      return authors.find( author =&gt; author.id === id)
    },
    authors(){
      return authors;
    },
    genre(_: any, { id }: any){
      genres.find( genre =&gt; genre.id === id);
    },
    genres(){
      return genres
    }
  },
  Mutation: {
    addBook(_: any, bookInput: any) {
      const book = {...bookInput, id: chance.guid()}
      books.push(book)
      pubsub.publish(BOOK_ADDED, { onBook: book });
    },
    addAuthor(_: any, authorInput: any) {
      const author = {...authorInput, id: chance.guid()};
      authors.push(author);
      return author;
    },
    addGenre(_: any, name: string) {
      const genre = {name, id: chance.guid()};
      genres.push(genre);
      return genre;
    },
  },
  Subscription: {
    onBook: {
      subscribe: () =&gt; pubsub.asyncIterator([BOOK_ADDED]),
    },
  },
}
</pre>
<p>现在我们已经有了模式和解析器，让我们连接REST和GraphQL APIs。</p>
<pre>// index.ts

import { makeExecutableSchema } from '@graphql-tools/schema';
import express from 'express';
import bodyParser from 'body-parser';
import { graphqlHTTP } from 'express-graphql';
import { typeDefs } from './types';
import { resolvers } from './resovers'
import { useSofa, OpenAPI } from 'sofa-api';
import * as swaggerDocument from './swagger.json';
import * as path from 'path';
import * as swaggerUi from 'swagger-ui-express';
const app = express();
app.use(bodyParser.json());

const schema = makeExecutableSchema({
  typeDefs,
  resolvers,
});

app.use('/api',
  useSofa({
    schema,
  })
);

app.use(
  '/graphql',
  graphqlHTTP({
    schema,
    graphiql: true,
  })
);
const port = 4000;
app.listen(port, () =&gt; {
  console.log(`started server on port: ${port}`)
});
</pre>
<p>在上面的文件中，我们使用了来自<code>@graphql-tools/schema</code>模块的<code>makeExecutableSchema</code>来组合类型定义和解析器。接下来，我们创建了两个独立的API。第一个是我们使用<code>useSofa</code>中间件创建的REST API，它接受<code>schema</code>作为参数。它通过<code>/api</code>途径公开REST APIs。第二个是GraphQL API，通过<code>/graphql</code>途径公开。GraphQL API启用了GraphQL UI。</p>
<p>Sofa将所有GraphQL查询转换为<code>GET</code>端点，将变异转换为<code>POST</code>，并将订阅转换为webhooks。还可以定制用于特定查询或变异的HTTP动词。例如，如果在您的一个突变中需要一个<code>PUT</code>而不是<code>POST</code>方法，您可以做以下事情。</p>
<pre>api.use(
  '/api',
  sofa({
    schema,
    method: {
      'Mutation.addGenre': 'PUT',
    },
  })
);
</pre>
<p>现在让我们测试一些GraphQL查询和变异以及它们对应的REST端点。</p>
<h3>使用GraphQL添加作者</h3>
<p>请求:</p>
<pre>mutation{
  addAuthor(author: {firstname: "John", lastname: "Doe", dob:"2020-08-15"}){
    id
    firstname
    lastname
    dob
  }
}
</pre>
<p>回应:</p>
<pre>{
  "data": {
    "addAuthor": {
      "id": "cd9aada0-2c59-5f5a-9255-7835ecd19d76",
      "firstname": "John",
      "lastname": "Doe",
      "dob": "2020-08-15"
    }
  }
}
</pre>
<h3>使用REST添加作者</h3>
<p>请求:</p>
<pre>curl --header "Content-Type: application/json" \
  --request POST \
  --data '{"author":{"firstname": "John", "lastname": "Doe", "dob":"2020-08-15"}}' \
  http://localhost:4000/api/add-author
{"id":"fd8e1958-cc1f-52b4-8bc1-53710616fd0d","firstname":"John","lastname":"Doe","dob":"2020-08-15"}%
</pre>
<p>回应:</p>
<pre>{
   "id": "fd8e1958-cc1f-52b4-8bc1-53710616fd0d",
   "firstname": "John",
   "lastname": "Doe",
   "dob": "2020-08-15"
}
</pre>
<h3>使用GraphQL列出图书</h3>
<p>请求:</p>
<pre>{
  books{
    id
    title
    summary
    genre{
      name
    }
    author{
      firstname
      lastname
    }
  }
}
</pre>
<p>回应:</p>
<pre>{
  "data": {
    "books": [
      {
        "id": "b2ca39a8-e21b-547a-9da4-eff9e0f6e113",
        "title": "Di rujen fug nebitovo dodmikut.",
        "summary": "Za lo zenle mibajfem icudip zezucvod gun vuwtait nu mod asamockin obu ewubub zodez roragu.",
        "genre": [
          {
            "name": "ohva"
          },
          {
            "name": "hohutten"
          }
        ],
        "author": [
          {
            "firstname": "Eunice",
            "lastname": "Hunter"
          }
        ]
      },
      {
        "id": "d2075892-e44b-5a5c-ac75-62d5639655b1",
        "title": "Neti ud ciribnoc re ukse.",
        "summary": "Mazraz zoc maprogna gikmef se ve joge wavca vawavo upkeep hiut madtadla fude uwka lepekjij igimav.",
        "genre": [
          {
            "name": "ohva"
          },
          {
            "name": "dif"
          }
        ],
        "author": [
          {
            "firstname": "Steven",
            "lastname": "Fred"
          }
        ]
      },
</pre>
<h3>用REST列出图书</h3>
<p>请求:</p>
<pre>curl --header "Content-Type: application/json" \
  --request GET \
  http://localhost:4000/api/books
</pre>
<p>回应:</p>
<pre>[
  {
    "id": "b2ca39a8-e21b-547a-9da4-eff9e0f6e113",
    "title": "Di rujen fug nebitovo dodmikut.",
    "author": [
      {
        "id": "fc118537-2cc8-558c-abb6-0733bf1ddfd1"
      }
    ],
    "summary": "Za lo zenle mibajfem icudip zezucvod gun vuwtait nu mod asamockin obu ewubub zodez roragu.",
    "genre": [
      {
        "id": "6ad4d748-bf88-5a89-8ca0-d73e8de3ed18"
      },
      {
        "id": "492b4ae9-1c07-5f6f-b5a6-9258d24338e1"
      }
    ]
  },
  {
    "id": "d2075892-e44b-5a5c-ac75-62d5639655b1",
    "title": "Neti ud ciribnoc re ukse.",
    "author": [
      {
        "id": "31cbd90d-73a4-5649-a0ce-ad230f41e2f8"
      }
    ],
    "summary": "Mazraz zoc maprogna gikmef se ve joge wavca vawavo upkeep hiut madtadla fude uwka lepekjij igimav.",
    "genre": [
      {
        "id": "6ad4d748-bf88-5a89-8ca0-d73e8de3ed18"
      },
      {
        "id": "ff85e7bb-37bc-5875-9243-0b7fec42b286"
      }
    ]
  },
  {
    "id": "aafc2536-ef57-503a-bf18-309cdad3a835",
    "title": "Et urvowpi josrowus wervek wuce.",
    "author": [
      {
        "id": "fc118537-2cc8-558c-abb6-0733bf1ddfd1"
      }
    ],
    "summary": "Hoot ez poifufo hal urlirguw irpomol sozca zok agloh ak ra ovves kidme.",
    "genre": [
      {
        "id": "6ad4d748-bf88-5a89-8ca0-d73e8de3ed18"
      },
      {
        "id": "ff85e7bb-37bc-5875-9243-0b7fec42b286"
      }
    ]
  },
  {
    "id": "a6152ed4-430f-55cd-b750-ca5bac562640",
    "title": "Lofe melrazlov tu zu ra.",
    "author": [
      {
        "id": "fc118537-2cc8-558c-abb6-0733bf1ddfd1"
      }
    ],
    "summary": "Vibaduf nagad ocele rigo nirjo ermosno fu det cuh fa hej bopozbo hasna cufif monapmok ubaulewol luru.",
    "genre": [
      {
        "id": "492b4ae9-1c07-5f6f-b5a6-9258d24338e1"
      },
      {
        "id": "ff85e7bb-37bc-5875-9243-0b7fec42b286"
      }
    ]
  },
  {
    "id": "a5d9a306-edfa-5564-8c88-0f27ed7d1742",
    "title": "Ehinaj sowum ezufokew amwemah ifumuc.",
    "author": [
      {
        "id": "31cbd90d-73a4-5649-a0ce-ad230f41e2f8"
      }
    ],
    "summary": "Guvek mab itaanubo gogogsar duva pidi vu ropvum luvud hubguz lille odro dadespe suafaka sos.",
    "genre": [
      {
        "id": "6ad4d748-bf88-5a89-8ca0-d73e8de3ed18"
      },
      {
        "id": "ff85e7bb-37bc-5875-9243-0b7fec42b286"
      }
    ]
  },
  {
    "id": "8f507b93-a2c1-54c8-b660-0b40c411480c",
    "title": "Elihin lottev ew bi dernoza.",
    "author": [
      {
        "id": "8989180f-6b7b-5bc2-a367-fcd9b816ed26"
      }
    ],
    "summary": "Vo tazipnep ire joucamu uhjomet ebubekaja eziwenhib piw gatcokup keijsec uculive kajes hehud uv lano.",
    "genre": [
      {
        "id": "ff85e7bb-37bc-5875-9243-0b7fec42b286"
      },
      {
        "id": "85d3ee83-7594-5c8c-85c4-c33233e4323c"
      }
    ]
  },
  {
    "id": "8cf2e033-6823-56de-9424-bc4072c464e3",
    "title": "Jeztoz jisnifa worazet kanpede ti.",
    "author": [
      {
        "id": "8989180f-6b7b-5bc2-a367-fcd9b816ed26"
      }
    ],
    "summary": "Fu tazoj socdigzo hanemnep li da bopacfow lugic nam onekaam og ezurni ku liiz ce ha.",
    "genre": [
      {
        "id": "85d3ee83-7594-5c8c-85c4-c33233e4323c"
      },
      {
        "id": "6ad4d748-bf88-5a89-8ca0-d73e8de3ed18"
      }
    ]
  },
  {
    "id": "1b57d182-a083-589b-845d-03770c22f08f",
    "title": "Waj vudsadso ju umameto nokojjuk.",
    "author": [
      {
        "id": "992b2ec7-cd79-5a22-b0e7-d9fba294456d"
      }
    ],
    "summary": "Bi do ipi riwwifel wugaz fekel tejaak wot vudlavgo hasir giti paj soprakju.",
    "genre": [
      {
        "id": "85d3ee83-7594-5c8c-85c4-c33233e4323c"
      },
      {
        "id": "6ad4d748-bf88-5a89-8ca0-d73e8de3ed18"
      }
    ]
  },
  {
    "id": "0f348d87-15db-53e4-943a-925ba93ce806",
    "title": "Le da tiorloj nansuzve jeesosak.",
    "author": [
      {
        "id": "31cbd90d-73a4-5649-a0ce-ad230f41e2f8"
      }
    ],
    "summary": "Doowam cu tepaluj buv cer danorma sebovo obusoc ne nu hojefiw puov muhogre oke kucjuzpev tacet cuto kimab.",
    "genre": [
      {
        "id": "492b4ae9-1c07-5f6f-b5a6-9258d24338e1"
      },
      {
        "id": "ff85e7bb-37bc-5875-9243-0b7fec42b286"
      }
    ]
  },
  {
    "id": "d48cfe82-5e26-59de-9025-cdf19b4461a9",
    "title": "Ok izu udihap necfisa di.",
    "author": [
      {
        "id": "8989180f-6b7b-5bc2-a367-fcd9b816ed26"
      }
    ],
    "summary": "Re rueh wawule raigomo vijteco oso ceva tuh hup talac popozude zahatu.",
    "genre": [
      {
        "id": "ff85e7bb-37bc-5875-9243-0b7fec42b286"
      },
      {
        "id": "492b4ae9-1c07-5f6f-b5a6-9258d24338e1"
      }
    ]
  }
]
</pre>
<h2 id="generatingrestdocumentation">生成REST文档</h2>
<p>Sofa能够使用模式定义文件生成OpenAPI文档。为了为我们的author API自动生成文档，我们将使用<code>onRoute</code>选项扩展Sofa中间件。</p>
<pre>// index.ts

app.use('/api',
  useSofa({
    schema,
    onRoute(info) {
      openApi.addRoute(info, {
        basePath: '/api',
      });
    },
  })
);

openApi.save(path.join(__dirname, '/swagger.yml'));
openApi.save(path.join(__dirname, '/swagger.json'));
app.use('/api/docs', swaggerUi.serve, swaggerUi.setup(swaggerDocument));
</pre>
<p>文档通过使用<code>swagger-ui-express</code>中间件的<code>/api/docs</code>路径提供。</p>
<h2 id="conclusion">结论</h2>
<p>Sofa利用GraphQL的标准化模式和解析器将某些API概念映射回REST。它旨在帮助您加快API中REST的迁移或支持，并为您的用户提供不同的API类型。</p>
<p>我个人会推荐Sofa，因为它消除了编写新的控制器和端点甚至编写API文档的需要。</p>
<p>这篇文章的完整代码可以在GitHub上找到。</p><div class="code-block code-block-2">
<div class="blog-plug base-cta"><h2>使用<a class="signup" href="https://lp.logrocket.com/blg/signup" target="_blank" rel="noopener noreferrer"> LogRocket </a>消除传统错误报告的干扰</h2>
<a href="https://lp.logrocket.com/blg/signup" class="signup" target="_blank" rel="noopener noreferrer"><img class="alignnone size-full wp-image-46 jetpack-lazy-image" src="../Images/d6f5a5dd739296c1dd7aab3d5e77eeb9.png" alt="LogRocket Dashboard Free Trial Banner" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2017/03/1d0cd-1s_rmyo6nbrasp-xtvbaxfg.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2017/03/1d0cd-1s_rmyo6nbrasp-xtvbaxfg.png"/><noscript><img data-lazy-fallback="1" class="alignnone size-full wp-image-46" src="../Images/d6f5a5dd739296c1dd7aab3d5e77eeb9.png" alt="LogRocket Dashboard Free Trial Banner" data-original-src="https://blog.logrocket.com/wp-content/uploads/2017/03/1d0cd-1s_rmyo6nbrasp-xtvbaxfg.png"/></noscript></a>
<p><a href="https://lp.logrocket.com/blg/signup" target="_blank" rel="noopener noreferrer"> LogRocket </a>是一个数字体验分析解决方案，它可以保护您免受数百个假阳性错误警报的影响，只针对几个真正重要的项目。LogRocket会告诉您应用程序中实际影响用户的最具影响力的bug和UX问题。</p>
<p>然后，使用具有深层技术遥测的会话重放来确切地查看用户看到了什么以及是什么导致了问题，就像你在他们身后看一样。</p>
<p>LogRocket自动聚合客户端错误、JS异常、前端性能指标和用户交互。然后LogRocket使用机器学习来告诉你哪些问题正在影响大多数用户，并提供你需要修复它的上下文。</p>
<p>关注重要的bug—<a class="signup" href="https://lp.logrocket.com/blg/signup-issue-free" target="_blank" rel="noopener noreferrer">今天就试试LogRocket】。</a></p><div class="code-block code-block-24">
<div class="blog-plug inline-plug graphql-plug"><h2>监控生产中失败和缓慢的GraphQL请求</h2><p>虽然GraphQL有一些调试请求和响应的特性，但确保GraphQL可靠地为您的生产应用程序提供资源是一件比较困难的事情。如果您对确保对后端或第三方服务的网络请求成功感兴趣，</p><a href="https://lp.logrocket.com/blg/graphql-signup" target="_blank">try LogRocket</a><p>.</p><a class="signup" href="https://lp.logrocket.com/blg/graphql-signup" target="_blank" rel="noopener noreferrer"><img src="../Images/432a3823c85b3fb72a206e6236a29f48.png" data-lazy-src="https://files.readme.io/69aa835-Image_2019-11-09_at_1.28.05_PM.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" class=" jetpack-lazy-image" data-original-src="https://files.readme.io/69aa835-Image_2019-11-09_at_1.28.05_PM.png"/><noscript><img data-lazy-fallback="1" src="../Images/432a3823c85b3fb72a206e6236a29f48.png" data-original-src="https://files.readme.io/69aa835-Image_2019-11-09_at_1.28.05_PM.png"/></noscript><img class="alignnone size-full wp-image-46 jetpack-lazy-image" src="../Images/d6f5a5dd739296c1dd7aab3d5e77eeb9.png" alt="LogRocket Dashboard Free Trial Banner" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2017/03/1d0cd-1s_rmyo6nbrasp-xtvbaxfg.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2017/03/1d0cd-1s_rmyo6nbrasp-xtvbaxfg.png"/><noscript><img data-lazy-fallback="1" class="alignnone size-full wp-image-46" src="../Images/d6f5a5dd739296c1dd7aab3d5e77eeb9.png" alt="LogRocket Dashboard Free Trial Banner" data-original-src="https://blog.logrocket.com/wp-content/uploads/2017/03/1d0cd-1s_rmyo6nbrasp-xtvbaxfg.png"/></noscript></a><a href="https://lp.logrocket.com/blg/graphql-signup" target="_blank" rel="noopener noreferrer">https://logrocket.com/signup/</a><p>LogRocket 就像是网络和移动应用的DVR，记录下你网站上发生的每一件事。您可以汇总并报告有问题的GraphQL请求，以快速了解根本原因，而不是猜测问题发生的原因。此外，您可以跟踪Apollo客户机状态并检查GraphQL查询的键值对。</p><p>LogRocket检测您的应用程序以记录基线性能计时，如页面加载时间、到达第一个字节的时间、慢速网络请求，还记录Redux、NgRx和Vuex操作/状态。</p><a class="signup" href="https://lp.logrocket.com/blg/graphql-signup" target="_blank" rel="noopener noreferrer">Start monitoring for free</a><p>.</p></div>


</div>
</div></div>

<p class="clearfix"/>
<p class="clearfix"/>
</article>

</div>    
</body>
</html>