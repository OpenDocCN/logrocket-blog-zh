<html>
<head>
<title>Express middleware: A complete guide - LogRocket Blog</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>快速中间件:一个完整的指南</h1>
<blockquote>原文：<a href="https://blog.logrocket.com/express-middleware-a-complete-guide/#0001-01-01">https://blog.logrocket.com/express-middleware-a-complete-guide/#0001-01-01</a></blockquote><div><article class="article-post">
<p>在本指南中，我们将探索使用Express.js中间件的基础。我们将从头开始创建一个简单的Express API，然后向其中添加中间件，并演示如何使用每个工具。</p>
<p>我们将要讨论的Express中间件工具是您初始Express.js应用程序设置的必备工具。我们将向您展示如何开始使用它们，您可以根据您的应用程序的独特需求进一步配置它们。</p>
<p>我们将讨论以下内容:</p>

<p>为了简单起见，我们将在示例Express API中只创建一个端点。完整的代码可以在<a href="https://github.com/lelouchB/5-express-middlewares" target="_blank" rel="noopener"> GitHub </a>上找到。</p>
<h2 id="what-is-nodejs">Node.js是什么？</h2>
<p><a href="https://nodejs.org/en/"> Node.js </a>是一个开源的JavaScript运行时环境，构建在<a href="https://v8.dev/" target="_blank" rel="noopener"> Chrome的V8 JavaScript引擎</a>之上。</p>
<p>虽然Node.js可以处理简单的任务，如创建简单的服务器，但是更复杂的任务，如分别处理不同路由的请求或提供静态文件，就更加困难了。</p>
<h2 id="what-is-expressjs">什么是Express.js？</h2>
<p>Express.js是最流行和最广泛使用的节点web框架之一。事实上，在MERN，梅文和平均堆栈的“E”代表“快递”</p>
<p>根据官方<a href="https://expressjs.com/" target="_blank" rel="noopener"> Express.js文档</a>，“Express是Node.js的一个快速、非个性化、极简的web框架，”虽然Express是极简的，但它也非常灵活，这导致了各种中间件的开发，这些中间件可以与Express.js一起使用，以解决几乎任何你能想到的任务或问题。</p>
<h2 id="what-is-express-middleware">什么是Express中间件？</h2>
<p><a href="https://expressjs.com/en/guide/using-middleware.html" target="_blank" rel="noopener">中间件</a>是包含在请求-响应周期中执行的功能的软件，可以访问请求对象(req)和响应对象(res)。中间件在服务器接收请求和发送响应之间的窗口期间执行。</p>
<p><a href="https://expressjs.com/en/guide/using-middleware.html" target="_blank" rel="noopener"> Express中间件</a>包括应用层、路由器层和错误处理功能，可以内置或来自第三方。由于Express.js自身的功能有限，因此Express应用程序主要由多个中间件函数调用组成。</p>
<p>您可以为Express.js编写自己的中间件，但是大多数开发人员更喜欢使用和配置内置和第三方工具来完成常见任务。在本指南中，我们将向您展示如何使用五个最流行的Express中间件。但是首先，简要概述一下中间件在应用程序中是如何工作的。</p>
<h2 id="how-does-middleware-work">中间件是如何工作的？</h2>
<p>为了理解中间件是如何工作的，假设你有一个柠檬水摊，顾客自带柠檬，你来做柠檬水。你负责评估柠檬的来源和新鲜度，丢弃任何不合格的柠檬，最后，制作柠檬水。</p>
<p>为了减少你的工作量，你雇了一个工人——我们叫他拉里——来确保柠檬是有机种植的，没有任何有害化学物质。在这个类比中，Larry是在你和你的客户的柠檬之间起作用的中间件。</p>
<p>现在你盈利了，所以你雇佣了另外两个员工，卷毛和莫伊。拉里检查了柠檬的产地，把有机生长的柠檬递给卷毛，卷毛扔掉腐烂的柠檬，把好的递给莫伊。Moe检验它们的新鲜度，然后把新鲜的柠檬递给你。</p>
<p>现在你可以专注于制作柠檬水，增加你的利润。</p>
<p>把柠檬想象成你的HTTP请求，把柠檬水想象成服务器。在接受或拒绝请求之前，您可以像处理HTTP请求一样检查柠檬的来源。并非所有来自可信来源的请求都是好的，因此仍然需要对它们进行过滤。你的员工——拉里、卷毛和莫伊——就像你柠檬水计划的中间件。如果在任何阶段中间件确定请求是坏的，它有能力终止请求-响应循环。</p>
<p>一旦一个请求通过了应用程序中的所有中间件，它就会到达控制器函数——在我们的例子中，就是您(或者更具体地说，是制作柠檬水的行为)。</p>
<p><img data-attachment-id="30787" data-permalink="https://blog.logrocket.com/express-middleware-a-complete-guide/middleware-infographic/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/12/middleware-infographic.png" data-orig-size="730,411" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Middleware infographic" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/12/middleware-infographic-300x169.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/12/middleware-infographic.png" decoding="async" class="aligncenter size-full wp-image-30787 jetpack-lazy-image" src="../Images/d9e4d0d328898efec06421e03311a846.png" alt="A Visual Explanation of Middlewares" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2020/12/middleware-infographic.png 730w, https://blog.logrocket.com/wp-content/uploads/2020/12/middleware-infographic-300x169.png 300w" data-lazy-sizes="(max-width: 730px) 100vw, 730px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2020/12/middleware-infographic.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/12/middleware-infographic.png"/></p><noscript><img data-lazy-fallback="1" data-attachment-id="30787" data-permalink="https://blog.logrocket.com/express-middleware-a-complete-guide/middleware-infographic/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/12/middleware-infographic.png" data-orig-size="730,411" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Middleware infographic" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/12/middleware-infographic-300x169.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/12/middleware-infographic.png" decoding="async" loading="lazy" class="aligncenter size-full wp-image-30787" src="../Images/d9e4d0d328898efec06421e03311a846.png" alt="A Visual Explanation of Middlewares" srcset="https://blog.logrocket.com/wp-content/uploads/2020/12/middleware-infographic.png 730w, https://blog.logrocket.com/wp-content/uploads/2020/12/middleware-infographic-300x169.png 300w" sizes="(max-width: 730px) 100vw, 730px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/12/middleware-infographic.png"/></noscript>
<p>显然，这只是一个简单的例子。在现实生活中，您可能需要使用多个中间件来执行一个任务，比如让一个用户登录。</p>
<h2 id="setting-up-an-expressjs-api">设置Express.js API</h2>
<p>为了演示如何使用Express.js中间件，我们将<a href="https://blog.logrocket.com/creating-a-crud-api-with-node-express-and-grpc/" target="_blank" rel="noopener">创建一个具有单个端点的简单Express API </a>。</p>
<p>在终端中运行以下命令:</p>
<pre>mkdir express-api
cd express-api
npm init -y
</pre>
<p>最后一个命令将在项目的根目录下创建一个<code>package.json</code>文件。它看起来会像这样:</p>
<pre>{
"name": "express-api",
"version": "1.0.0",
"description": "",
"main": "index.js",
"scripts": {
"test": "echo \"Error: no test specified\" &amp;&amp; exit 1"
},
"keywords": [],
"author": "",
"license": "MIT"
}
</pre>
<p>运行以下命令安装<code>express</code>:</p>
<pre>npm install express
</pre>
<p>创建一个名为<code>index.js</code>的文件:</p>
<pre>touch index.js
</pre>
<p>将以下内容添加到<code>index.js</code>以创建一个简单的Express API:</p>
<pre>const express = require("express");
const app = express();

// Port
const port = 3000;

app.get("/", (req, res) =&gt; {
  res.json({
    message: "Hello Stranger! How are you?",
  });
});

// Listen
app.listen(port, () =&gt; {
  console.log(`Listening on port: ${port}`);
});
</pre>
<p>在项目的根目录下运行以下命令，将<code>nodemon</code>安装为一个开发依赖项。这是一个优秀的本地开发工具。</p>
<pre>npm install -D nodemon
</pre>
<p>有了<code>nodemon</code>，就不用手动重启Express.js服务器了；<code>nodemon</code>检测文件更改并自动重启服务器。</p>
<p>在你的<code>package.json</code>里修改<code>"scripts"</code>，像这样:</p>
<pre>"scripts": {
    "start": "node index.js",
    "dev": "nodemon index.js"
  },
</pre>
<p>您的<code>package.json</code>应该是这样的:</p>
<pre>{
  "name": "express-api",
  "version": "1.0.0",
  "description": "",
  "main": "index.js",
  "scripts": {
    "start": "node index.js",
    "dev": "nodemon index.js"
  },
  "keywords": [],
  "author": "Ashutosh K Singh",
  "license": "MIT",
  "dependencies": {
    "express": "^4.17.1"
  },
  "devDependencies": {
    "nodemon": "^2.0.6"
  }
}
</pre>
<p>运行以下命令启动Express服务器:</p>
<pre>npm run dev
</pre>
<p>一旦服务器启动，您将在终端中看到以下消息:</p>
<pre>[nodemon] 2.0.5
[nodemon] to restart at any time, enter `rs`
[nodemon] watching path(s): *.*
[nodemon] watching extensions: js,mjs,json
[nodemon] starting `node index.js`
Listening on port: 3000
</pre>
<p>转到<code><a href="http://localhost:3000" rel="nofollow">http://localhost:3000</a></code>，您将看到来自API的以下响应:</p>
<pre>{
  "message": "Hello Stranger! How are you?"
}
</pre>
<h2 id="using-express-middleware">使用Express中间件</h2>
<p>现在我们已经建立了一个简单的API，让我们详细看看五个顶级的Express.js中间件工具以及如何使用它们。我们将描述每一个中间件，它做什么，以及如何设置和使用我们的Express API。</p>
<h3 id="morgan"><code>morgan</code></h3>
<p><a href="https://www.npmjs.com/package/morgan" target="_blank" rel="noopener"> <code>morgan</code> </a>是Node.js的HTTP请求记录器中间件，为每个API请求生成日志。最棒的是，您可以使用预定义的格式，也可以根据需要创建新的格式。</p>
<p>要安装<a href="https://github.com/expressjs/morgan#morgan" target="_blank" rel="noopener"> <code>morgan</code> </a>，运行以下命令:</p>
<pre>npm install morgan
</pre>
<p><code>morgan</code>包含许多您可以使用的预定义格式。许多开发人员更喜欢使用标准的Apache通用日志输出<code>common</code>。</p>
<p>像这样修改你的<code>index.js</code>:</p>
<pre>const express = require("express");
const morgan = require("morgan")

const app = express();

// Middlewares
app.use(morgan("common"))


// Port
const port = 3000;

app.get("/", (req, res) =&gt; {
  res.json({
    message: "Hello Stranger! How are you?",
  });
});

// Listen
app.listen(port, ()=&gt;{
    console.log(`Listening on port: ${port}`)
})
</pre>
<p>完成了！转到<code><a href="http://localhost:3000" rel="nofollow">http://localhost:3000</a></code>，您会在运行服务器的终端中看到由<code>morgan</code>生成的日志:</p>
<pre>::ffff:127.0.0.1 - - [14/Oct/2020:09:21:16 +0000] "GET / HTTP/1.1" 304 -
</pre>
<p>这里有一个相同的截图:</p>
<p><img data-attachment-id="30789" data-permalink="https://blog.logrocket.com/express-middleware-a-complete-guide/screenshot-showing-morgan-log/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/12/screenshot-showing-morgan-log.png" data-orig-size="730,351" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Screenshot showing morgan log" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/12/screenshot-showing-morgan-log-300x144.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/12/screenshot-showing-morgan-log.png" decoding="async" class="aligncenter size-full wp-image-30789 jetpack-lazy-image" src="../Images/070a344d2da825038425d5d8947cb756.png" alt="Morgan log" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2020/12/screenshot-showing-morgan-log.png 730w, https://blog.logrocket.com/wp-content/uploads/2020/12/screenshot-showing-morgan-log-300x144.png 300w" data-lazy-sizes="(max-width: 730px) 100vw, 730px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2020/12/screenshot-showing-morgan-log.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/12/screenshot-showing-morgan-log.png"/></p><noscript><img data-lazy-fallback="1" data-attachment-id="30789" data-permalink="https://blog.logrocket.com/express-middleware-a-complete-guide/screenshot-showing-morgan-log/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/12/screenshot-showing-morgan-log.png" data-orig-size="730,351" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Screenshot showing morgan log" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/12/screenshot-showing-morgan-log-300x144.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/12/screenshot-showing-morgan-log.png" decoding="async" loading="lazy" class="aligncenter size-full wp-image-30789" src="../Images/070a344d2da825038425d5d8947cb756.png" alt="Morgan log" srcset="https://blog.logrocket.com/wp-content/uploads/2020/12/screenshot-showing-morgan-log.png 730w, https://blog.logrocket.com/wp-content/uploads/2020/12/screenshot-showing-morgan-log-300x144.png 300w" sizes="(max-width: 730px) 100vw, 730px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/12/screenshot-showing-morgan-log.png"/></noscript>
<p>值得注意的是，中间件工具是根据您定义它们的顺序来执行的。</p>
<h3 id="helmet">头盔</h3>
<p><a href="https://www.npmjs.com/package/helmet" target="_blank" rel="noopener">头盔</a>是一个安全中间件，通过设置各种HTTP头来保护Express.js应用。</p>
<p>为了更好地理解<a href="https://blog.logrocket.com/search-optimized-spas-react-helmet/" target="_blank" rel="noopener">头盔如何工作</a>，前往<code><a href="http://localhost:3000/" rel="nofollow">http://localhost:3000/</a></code>并通过按下Chrome中的<code>CTRL + Shift + J</code>或Firefox中的<code>CTRL + Shift + K</code>打开控制台。现在点击<strong>网络</strong>选项卡。</p>
<p><img data-attachment-id="30790" data-permalink="https://blog.logrocket.com/express-middleware-a-complete-guide/network-tab/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/12/network-tab.png" data-orig-size="730,123" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Network tab" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/12/network-tab-300x51.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/12/network-tab.png" decoding="async" class="aligncenter size-full wp-image-30790 jetpack-lazy-image" src="../Images/f2ef801383f2090792ac0d029da23072.png" alt="The Network Tab" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2020/12/network-tab.png 730w, https://blog.logrocket.com/wp-content/uploads/2020/12/network-tab-300x51.png 300w" data-lazy-sizes="(max-width: 730px) 100vw, 730px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2020/12/network-tab.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/12/network-tab.png"/></p><noscript><img data-lazy-fallback="1" data-attachment-id="30790" data-permalink="https://blog.logrocket.com/express-middleware-a-complete-guide/network-tab/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/12/network-tab.png" data-orig-size="730,123" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Network tab" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/12/network-tab-300x51.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/12/network-tab.png" decoding="async" loading="lazy" class="aligncenter size-full wp-image-30790" src="../Images/f2ef801383f2090792ac0d029da23072.png" alt="The Network Tab" srcset="https://blog.logrocket.com/wp-content/uploads/2020/12/network-tab.png 730w, https://blog.logrocket.com/wp-content/uploads/2020/12/network-tab-300x51.png 300w" sizes="(max-width: 730px) 100vw, 730px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/12/network-tab.png"/></noscript>
<p>如果<strong>网络</strong>标签是空的，在<strong>网络</strong>标签打开的情况下重新加载你的页面，你会看到它填满了条目。</p>
<p><img data-attachment-id="30791" data-permalink="https://blog.logrocket.com/express-middleware-a-complete-guide/network-tab-filling-up/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/12/network-tab-filling-up.png" data-orig-size="730,95" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Network tab filling up" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/12/network-tab-filling-up-300x39.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/12/network-tab-filling-up.png" decoding="async" class="aligncenter size-full wp-image-30791 jetpack-lazy-image" src="../Images/7975d5baa8280cb2b13839a4ed7d0d16.png" alt="Network Tab Filling Up" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2020/12/network-tab-filling-up.png 730w, https://blog.logrocket.com/wp-content/uploads/2020/12/network-tab-filling-up-300x39.png 300w" data-lazy-sizes="(max-width: 730px) 100vw, 730px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2020/12/network-tab-filling-up.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/12/network-tab-filling-up.png"/></p><noscript><img data-lazy-fallback="1" data-attachment-id="30791" data-permalink="https://blog.logrocket.com/express-middleware-a-complete-guide/network-tab-filling-up/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/12/network-tab-filling-up.png" data-orig-size="730,95" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Network tab filling up" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/12/network-tab-filling-up-300x39.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/12/network-tab-filling-up.png" decoding="async" loading="lazy" class="aligncenter size-full wp-image-30791" src="../Images/7975d5baa8280cb2b13839a4ed7d0d16.png" alt="Network Tab Filling Up" srcset="https://blog.logrocket.com/wp-content/uploads/2020/12/network-tab-filling-up.png 730w, https://blog.logrocket.com/wp-content/uploads/2020/12/network-tab-filling-up-300x39.png 300w" sizes="(max-width: 730px) 100vw, 730px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/12/network-tab-filling-up.png"/></noscript>
<p>您现在可以忽略<code>favicon</code>请求；我们稍后会谈到这一点。</p>
<p>点击<code>GET /</code>请求数据。关注<strong>响应头</strong>部分。</p>
<p><img data-attachment-id="30792" data-permalink="https://blog.logrocket.com/express-middleware-a-complete-guide/response-headers-dropdown/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/12/response-headers-dropdown.png" data-orig-size="730,379" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Response headers dropdown" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/12/response-headers-dropdown-300x156.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/12/response-headers-dropdown.png" decoding="async" class="aligncenter size-full wp-image-30792 jetpack-lazy-image" src="../Images/58278e78bda8972c58cb59a739516397.png" alt="Response Headers Dropdown Menu" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2020/12/response-headers-dropdown.png 730w, https://blog.logrocket.com/wp-content/uploads/2020/12/response-headers-dropdown-300x156.png 300w" data-lazy-sizes="(max-width: 730px) 100vw, 730px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2020/12/response-headers-dropdown.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/12/response-headers-dropdown.png"/></p><noscript><img data-lazy-fallback="1" data-attachment-id="30792" data-permalink="https://blog.logrocket.com/express-middleware-a-complete-guide/response-headers-dropdown/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/12/response-headers-dropdown.png" data-orig-size="730,379" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Response headers dropdown" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/12/response-headers-dropdown-300x156.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/12/response-headers-dropdown.png" decoding="async" loading="lazy" class="aligncenter size-full wp-image-30792" src="../Images/58278e78bda8972c58cb59a739516397.png" alt="Response Headers Dropdown Menu" srcset="https://blog.logrocket.com/wp-content/uploads/2020/12/response-headers-dropdown.png 730w, https://blog.logrocket.com/wp-content/uploads/2020/12/response-headers-dropdown-300x156.png 300w" sizes="(max-width: 730px) 100vw, 730px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/12/response-headers-dropdown.png"/></noscript>
<p>您可能看不到任何漏洞，但是，就您的API目前的情况而言，攻击者和黑客可以很容易地利用它——尤其是<code>X-Powered-By: Express</code>字段，它向全世界广播该应用程序正在运行Express.js。</p>
<p>头盔是11个小中间件的集合，它们一起保护你的应用免受众所周知的漏洞和攻击。</p>
<p>运行以下命令安装<a href="https://helmetjs.github.io/" target="_blank" rel="noopener"> <code>helmet</code> </a>:</p>
<pre>npm install --save helmet
</pre>
<p>像这样更新<code>index.js</code>文件以包含<code>helmet</code>中间件:</p>
<pre>const express = require("express");
const morgan = require("morgan")
const helmet = require("helmet");
const app = express();


// Middlewares
app.use(morgan("common"))
app.use(helmet());
// Port
const port = 3000;

app.get("/", (req, res) =&gt; {
  res.json({
    message: "Hello Stranger! How are you?",
  });
});
// Listen
app.listen(port, () =&gt; {
  console.log(`Listening on port: ${port}`);
});
</pre>
<p>再次打开<code><a href="http://localhost:3000/" rel="nofollow">http://localhost:3000/</a></code>，刷新页面，打开<strong>开发者工具</strong>中<strong>网络</strong>标签下的<strong>响应头</strong>部分。</p>
<p><img data-attachment-id="30793" data-permalink="https://blog.logrocket.com/express-middleware-a-complete-guide/response-headers-under-network/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/12/response-headers-under-network.png" data-orig-size="730,439" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Response headers under network" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/12/response-headers-under-network-300x180.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/12/response-headers-under-network.png" decoding="async" class="aligncenter size-full wp-image-30793 jetpack-lazy-image" src="../Images/7d0188ffedb5cfe5f76a7ff94451367f.png" alt="Response Headers Under Network Tab" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2020/12/response-headers-under-network.png 730w, https://blog.logrocket.com/wp-content/uploads/2020/12/response-headers-under-network-300x180.png 300w" data-lazy-sizes="(max-width: 730px) 100vw, 730px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2020/12/response-headers-under-network.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/12/response-headers-under-network.png"/></p><noscript><img data-lazy-fallback="1" data-attachment-id="30793" data-permalink="https://blog.logrocket.com/express-middleware-a-complete-guide/response-headers-under-network/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/12/response-headers-under-network.png" data-orig-size="730,439" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Response headers under network" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/12/response-headers-under-network-300x180.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/12/response-headers-under-network.png" decoding="async" loading="lazy" class="aligncenter size-full wp-image-30793" src="../Images/7d0188ffedb5cfe5f76a7ff94451367f.png" alt="Response Headers Under Network Tab" srcset="https://blog.logrocket.com/wp-content/uploads/2020/12/response-headers-under-network.png 730w, https://blog.logrocket.com/wp-content/uploads/2020/12/response-headers-under-network-300x180.png 300w" sizes="(max-width: 730px) 100vw, 730px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/12/response-headers-under-network.png"/></noscript>
<p>正如您这次看到的，在<strong>响应头中有新的条目，</strong>和<code>X-Powered-By: Express</code>字段已经消失。</p>
<p>您还可以配置<code>helmet()</code>函数来禁用这样的中间件。</p>
<pre>// This disables the `referrerPolicy` middleware but keeps the rest.
app.use(
    helmet({
        referrerPolicy: false,
    })
  );
</pre>
<h3 id="cors"><code>cors</code></h3>
<p><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS" target="_blank" rel="noopener"> CORS </a>代表跨产地资源共享。它用于在Express.js应用程序中启用和配置CORS。</p>
<p>假设您有一个全栈应用，在端口3000上运行React前端，在端口8000上运行Express后端服务器。一个请求来自客户端(即React前端)到后端Express服务器，但是您的请求很可能会失败，因为它来自不同于Express服务器的源。</p>
<p><img data-attachment-id="30794" data-permalink="https://blog.logrocket.com/express-middleware-a-complete-guide/cors-error/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/12/cors-error.png" data-orig-size="730,143" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Cors error" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/12/cors-error-300x59.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/12/cors-error.png" decoding="async" class="aligncenter size-full wp-image-30794 jetpack-lazy-image" src="../Images/4c975bbd35aefaaea7f1847615d1391a.png" alt="A Cors Error" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2020/12/cors-error.png 730w, https://blog.logrocket.com/wp-content/uploads/2020/12/cors-error-300x59.png 300w" data-lazy-sizes="(max-width: 730px) 100vw, 730px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2020/12/cors-error.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/12/cors-error.png"/></p><noscript><img data-lazy-fallback="1" data-attachment-id="30794" data-permalink="https://blog.logrocket.com/express-middleware-a-complete-guide/cors-error/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/12/cors-error.png" data-orig-size="730,143" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Cors error" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/12/cors-error-300x59.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/12/cors-error.png" decoding="async" loading="lazy" class="aligncenter size-full wp-image-30794" src="../Images/4c975bbd35aefaaea7f1847615d1391a.png" alt="A Cors Error" srcset="https://blog.logrocket.com/wp-content/uploads/2020/12/cors-error.png 730w, https://blog.logrocket.com/wp-content/uploads/2020/12/cors-error-300x59.png 300w" sizes="(max-width: 730px) 100vw, 730px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/12/cors-error.png"/></noscript>
<p>您需要告诉服务器接受这个请求，即使它来自不同的来源。这就是<a href="https://www.npmjs.com/package/cors" target="_blank" rel="noopener"> <code>cors</code> </a>的用武之地。</p>
<p>运行以下命令安装<code>cors</code>:</p>
<pre>npm install --save cors
</pre>
<p>更新<code>index.js</code>这样:</p>
<pre>const express = require("express");
const morgan = require("morgan")
const helmet = require("helmet");
const cors = require("cors");
const app = express();


// Middlewares
app.use(morgan("common"))
app.use(helmet());
app.use(cors())

// Port
const port = 3000;

app.get("/", (req, res) =&gt; {
  res.json({
    message: "Hello Stranger! How are you?",
  });
});
// Listen
app.listen(port, () =&gt; {
  console.log(`Listening on port: ${port}`);
});
</pre>
<p>上面的代码<code>app.use(cors())</code>允许来自任何来源的请求，但这可能会使您的应用程序面临安全漏洞，除非您有一个公共API来接受来自任何来源的请求。</p>
<p>让我们考虑一下上面这个带有React和Express的全栈app的例子。您可以创建一个允许域的白名单，并检查请求是否来自白名单中的域，而不是允许来自任何来源的请求。</p>
<pre>// whitelist
const whitelist = ['http://localhost:3000', 'http://localhost:3001']
const corsOptions = {
  origin: function (origin, callback) {
    if (whitelist.indexOf(origin) !== -1) {
      callback(null, true)
    } else {
      callback(new Error('Not allowed by CORS'))
    }
  }
}
app.use(cors(corsOptions));
</pre>
<p><img data-attachment-id="30796" data-permalink="https://blog.logrocket.com/express-middleware-a-complete-guide/whitelisted-domain/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/12/whitelisted-domain.png" data-orig-size="730,230" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Whitelisted domain" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/12/whitelisted-domain-300x95.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/12/whitelisted-domain.png" decoding="async" class="aligncenter size-full wp-image-30796 jetpack-lazy-image" src="../Images/5b47f43790e171d1db1d5292aab8ae66.png" alt="Showing Now as a Whitelisted Domain" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2020/12/whitelisted-domain.png 730w, https://blog.logrocket.com/wp-content/uploads/2020/12/whitelisted-domain-300x95.png 300w" data-lazy-sizes="(max-width: 730px) 100vw, 730px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2020/12/whitelisted-domain.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/12/whitelisted-domain.png"/></p><noscript><img data-lazy-fallback="1" data-attachment-id="30796" data-permalink="https://blog.logrocket.com/express-middleware-a-complete-guide/whitelisted-domain/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/12/whitelisted-domain.png" data-orig-size="730,230" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Whitelisted domain" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/12/whitelisted-domain-300x95.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/12/whitelisted-domain.png" decoding="async" loading="lazy" class="aligncenter size-full wp-image-30796" src="../Images/5b47f43790e171d1db1d5292aab8ae66.png" alt="Showing Now as a Whitelisted Domain" srcset="https://blog.logrocket.com/wp-content/uploads/2020/12/whitelisted-domain.png 730w, https://blog.logrocket.com/wp-content/uploads/2020/12/whitelisted-domain-300x95.png 300w" sizes="(max-width: 730px) 100vw, 730px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/12/whitelisted-domain.png"/></noscript>
<p>您可以在MDN网络文档上了解更多关于CORS的信息。</p>
<h3 id="express-rate-limit">快速速率限制</h3>
<p><a href="https://www.npmjs.com/package/express-rate-limit#usage" target="_blank" rel="noopener"> Express限速</a>是Express.js的基本限速中间件，顾名思义，限制来自同一个IP地址的重复API请求。</p>
<p>下面是如何安装<code>express-rate-limit</code>:</p>
<pre>npm install --save express-rate-limit
</pre>
<p>接下来，将这个中间件导入到<code>index.js</code>并创建一个名为<code>limiter</code>的变量来配置<code>express-rate-limit</code>。</p>
<pre>const rateLimit = require("express-rate-limit");

const limiter = rateLimit({
    windowMs: 15 * 60 * 1000, // 15 minutes
    max: 100 // limit each IP to 100 requests per windowMs
  });
</pre>
<p>上面的代码将每个IP地址在15分钟内的请求限制为100个。</p>
<p>更新<code>index.js</code>这样:</p>
<pre>const express = require("express");
const morgan = require("morgan")
const helmet = require("helmet");
const cors = require("cors");
const rateLimit = require("express-rate-limit");

const limiter = rateLimit({
    windowMs: 15 * 60 * 1000, // 15 minutes
    max: 100 // limit each IP to 100 requests per windowMs
  });

const app = express();


// Middlewares
app.use(morgan("common"))
app.use(helmet());
app.use(cors())
app.use(limiter); //  apply to all requests

// Port
const port = 3000;

app.get("/", (req, res) =&gt; {
  res.json({
    message: "Hello Stranger! How are you?",
  });
});
// Listen
app.listen(port, () =&gt; {
  console.log(`Listening on port: ${port}`);
});
</pre>
<p>为了更好地展示如何使用<code>express-rate-limit</code>，更改<code>limit</code>，如下所示:</p>
<pre>const limiter = rateLimit({
    windowMs: 60 * 1000, // 1 minute
    max: 2, // limit each IP to 2 requests per windowMs
    message: "Too many accounts created from this IP, please try again after a minute"
  });
</pre>
<p>前往<code><a href="http://localhost:3000/" rel="nofollow">http://localhost:3000/</a></code>，刷新页面三四次。</p>
<p><img data-attachment-id="30797" data-permalink="https://blog.logrocket.com/express-middleware-a-complete-guide/refreshing-page/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/12/refreshing-page.gif" data-orig-size="600,325" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Refreshing page" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/12/refreshing-page-300x163.gif" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/12/refreshing-page.gif" decoding="async" class="aligncenter size-full wp-image-30797 jetpack-lazy-image" src="../Images/a9683dedb1b3402673c2b727f8229db0.png" alt="Refreshing the page multiple times" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2020/12/refreshing-page.gif?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/12/refreshing-page.gif"/></p><noscript><img data-lazy-fallback="1" data-attachment-id="30797" data-permalink="https://blog.logrocket.com/express-middleware-a-complete-guide/refreshing-page/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/12/refreshing-page.gif" data-orig-size="600,325" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Refreshing page" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/12/refreshing-page-300x163.gif" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/12/refreshing-page.gif" decoding="async" loading="lazy" class="aligncenter size-full wp-image-30797" src="../Images/a9683dedb1b3402673c2b727f8229db0.png" alt="Refreshing the page multiple times" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/12/refreshing-page.gif"/></noscript>
<p>由于<code>morgan</code>仍然有效，所以可以在终端中看到日志。</p>
<pre>::1 - - [14/Nov/2020:08:15:58 +0000] "GET / HTTP/1.1" 304 -
::1 - - [14/Nov/2020:08:15:59 +0000] "GET / HTTP/1.1" 304 -
::1 - - [14/Nov/2020:08:15:59 +0000] "GET / HTTP/1.1" 429 71
</pre>
<p><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/429" target="_blank" rel="noopener"> 429状态码</a>表示用户在给定的时间内发送了过多的请求(“速率限制”)。</p>
<p>您还可以配置<code>express-rate-limit</code>来应用于特定的请求或者不是所有的请求。</p>
<pre>//  apply to all requests
app.use(limiter); 

// only apply to requests that begin with /api/
app.use("/api/", limiter);
</pre>
<p>以下是其他一些值得一试的限速中间件:</p>

<h3 id="serve-favicon"><code>serve-favicon</code></h3>
<p><a href="https://www.npmjs.com/package/serve-favicon" target="_blank" rel="noopener"> <code>serve-favicon</code> </a>是一个最受欢迎的服务中间件。你可能还记得当我们打开头盔部分的<strong>网络</strong>标签时失败的favicon请求。</p>
<p><img data-attachment-id="30798" data-permalink="https://blog.logrocket.com/express-middleware-a-complete-guide/failed-favicon-request/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/12/failed-favicon-request.png" data-orig-size="730,85" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Failed favicon request" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/12/failed-favicon-request-300x35.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/12/failed-favicon-request.png" decoding="async" class="aligncenter size-full wp-image-30798 jetpack-lazy-image" src="../Images/98db225e55220eb5cda650e5f65aceac.png" alt="A failed favicon request" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2020/12/failed-favicon-request.png 730w, https://blog.logrocket.com/wp-content/uploads/2020/12/failed-favicon-request-300x35.png 300w" data-lazy-sizes="(max-width: 730px) 100vw, 730px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2020/12/failed-favicon-request.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/12/failed-favicon-request.png"/></p><noscript><img data-lazy-fallback="1" data-attachment-id="30798" data-permalink="https://blog.logrocket.com/express-middleware-a-complete-guide/failed-favicon-request/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/12/failed-favicon-request.png" data-orig-size="730,85" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Failed favicon request" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/12/failed-favicon-request-300x35.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/12/failed-favicon-request.png" decoding="async" loading="lazy" class="aligncenter size-full wp-image-30798" src="../Images/98db225e55220eb5cda650e5f65aceac.png" alt="A failed favicon request" srcset="https://blog.logrocket.com/wp-content/uploads/2020/12/failed-favicon-request.png 730w, https://blog.logrocket.com/wp-content/uploads/2020/12/failed-favicon-request-300x35.png 300w" sizes="(max-width: 730px) 100vw, 730px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/12/failed-favicon-request.png"/></noscript>
<p>A <a href="https://en.wikipedia.org/wiki/Favicon"> f </a> <a href="https://en.wikipedia.org/wiki/Favicon"> avicon </a>是一个小图标，经常出现在地址栏页面标题的左侧。例如，下面是LogRocket博客的图标:</p>
<p><img data-attachment-id="30799" data-permalink="https://blog.logrocket.com/express-middleware-a-complete-guide/logrocket-favicon/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/12/logrocket-favicon.png" data-orig-size="632,172" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Logrocket favicon" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/12/logrocket-favicon-300x82.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/12/logrocket-favicon.png" decoding="async" class="aligncenter size-full wp-image-30799 jetpack-lazy-image" src="../Images/d2aa730da3b668a8e210d807b9869be2.png" alt="The Logrocket Favicon" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2020/12/logrocket-favicon.png 632w, https://blog.logrocket.com/wp-content/uploads/2020/12/logrocket-favicon-300x82.png 300w" data-lazy-sizes="(max-width: 632px) 100vw, 632px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2020/12/logrocket-favicon.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/12/logrocket-favicon.png"/></p><noscript><img data-lazy-fallback="1" data-attachment-id="30799" data-permalink="https://blog.logrocket.com/express-middleware-a-complete-guide/logrocket-favicon/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/12/logrocket-favicon.png" data-orig-size="632,172" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Logrocket favicon" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/12/logrocket-favicon-300x82.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/12/logrocket-favicon.png" decoding="async" loading="lazy" class="aligncenter size-full wp-image-30799" src="../Images/d2aa730da3b668a8e210d807b9869be2.png" alt="The Logrocket Favicon" srcset="https://blog.logrocket.com/wp-content/uploads/2020/12/logrocket-favicon.png 632w, https://blog.logrocket.com/wp-content/uploads/2020/12/logrocket-favicon-300x82.png 300w" sizes="(max-width: 632px) 100vw, 632px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/12/logrocket-favicon.png"/></noscript>
<p>要安装<code>serve-favicon</code>:</p>
<pre>npm install serve-favicon
</pre>
<p>在项目的根目录中，您还需要一个favicon文件。你可以从<a href="https://github.com/lelouchB/5-express-middlewares/blob/main/favicon.ico" target="_blank" rel="noopener"> GitHub </a>获取样本图标。</p>
<p>像这样更新<code>index.js</code>文件:</p>
<pre>const express = require("express");
const morgan = require("morgan")
const helmet = require("helmet");
const cors = require("cors");
const rateLimit = require("express-rate-limit");
var favicon = require('serve-favicon')


const limiter = rateLimit({
    windowMs: 15 *60 * 1000, // 15 minutes
    max: 100, // limit each IP to 100 requests per windowMs
    message: "Too many accounts created from this IP, please try again after a minute"
  });

const app = express();

// Serve Favicon
app.use(favicon('favicon.ico'))

// Middlewares
app.use(morgan("common"))
app.use(helmet());
app.use(cors())
app.use(limiter); //  apply to all requests

// Port
const port = 3000;

app.get("/", (req, res) =&gt; {
  res.json({
    message: "Hello Stranger! How are you?",
  });
});
// Listen
app.listen(port, () =&gt; {
  console.log(`Listening on port: ${port}`);
});
</pre>
<p>如果您的收藏夹图标出现在<code>public</code>文件夹中，您可以使用<code>path</code>。</p>
<pre>var path = require('path')
 ...

// Serve Favicon
app.use(favicon(path.join(__dirname, 'public', 'favicon.ico')))
...
</pre>
<p>头转向<code><a href="http://localhost:3000/" rel="nofollow">http://localhost:3000/</a></code>；您将看到页面上有一个图标。</p>
<p><img data-attachment-id="30801" data-permalink="https://blog.logrocket.com/express-middleware-a-complete-guide/favicon/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/12/favicon.png" data-orig-size="730,157" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Favicon" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/12/favicon-300x65.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/12/favicon.png" decoding="async" class="aligncenter size-full wp-image-30801 jetpack-lazy-image" src="../Images/0977e98168b939eef7582197c9f74f87.png" alt="Showing the Favicon Location" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2020/12/favicon.png 730w, https://blog.logrocket.com/wp-content/uploads/2020/12/favicon-300x65.png 300w" data-lazy-sizes="(max-width: 730px) 100vw, 730px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2020/12/favicon.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/12/favicon.png"/></p><noscript><img data-lazy-fallback="1" data-attachment-id="30801" data-permalink="https://blog.logrocket.com/express-middleware-a-complete-guide/favicon/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/12/favicon.png" data-orig-size="730,157" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Favicon" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/12/favicon-300x65.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/12/favicon.png" decoding="async" loading="lazy" class="aligncenter size-full wp-image-30801" src="../Images/0977e98168b939eef7582197c9f74f87.png" alt="Showing the Favicon Location" srcset="https://blog.logrocket.com/wp-content/uploads/2020/12/favicon.png 730w, https://blog.logrocket.com/wp-content/uploads/2020/12/favicon-300x65.png 300w" sizes="(max-width: 730px) 100vw, 730px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/12/favicon.png"/></noscript>
<p>现在打开<strong>网络</strong>标签，重新加载页面。</p>
<p><img data-attachment-id="30802" data-permalink="https://blog.logrocket.com/express-middleware-a-complete-guide/refreshed-network-page-showing-favicon/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/12/refreshed-network-page-showing-favicon.png" data-orig-size="730,287" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Refreshed network page showing favicon" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/12/refreshed-network-page-showing-favicon-300x118.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/12/refreshed-network-page-showing-favicon.png" decoding="async" class="aligncenter size-full wp-image-30802 jetpack-lazy-image" src="../Images/a56e9fe87e427d7bd134c3e23e4f6fcf.png" alt="A Refreshed Network Page Showing the Favicon" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2020/12/refreshed-network-page-showing-favicon.png 730w, https://blog.logrocket.com/wp-content/uploads/2020/12/refreshed-network-page-showing-favicon-300x118.png 300w" data-lazy-sizes="(max-width: 730px) 100vw, 730px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2020/12/refreshed-network-page-showing-favicon.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/12/refreshed-network-page-showing-favicon.png"/></p><noscript><img data-lazy-fallback="1" data-attachment-id="30802" data-permalink="https://blog.logrocket.com/express-middleware-a-complete-guide/refreshed-network-page-showing-favicon/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/12/refreshed-network-page-showing-favicon.png" data-orig-size="730,287" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Refreshed network page showing favicon" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/12/refreshed-network-page-showing-favicon-300x118.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/12/refreshed-network-page-showing-favicon.png" decoding="async" loading="lazy" class="aligncenter size-full wp-image-30802" src="../Images/a56e9fe87e427d7bd134c3e23e4f6fcf.png" alt="A Refreshed Network Page Showing the Favicon" srcset="https://blog.logrocket.com/wp-content/uploads/2020/12/refreshed-network-page-showing-favicon.png 730w, https://blog.logrocket.com/wp-content/uploads/2020/12/refreshed-network-page-showing-favicon-300x118.png 300w" sizes="(max-width: 730px) 100vw, 730px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/12/refreshed-network-page-showing-favicon.png"/></noscript>
<p><code>serve-favicon</code>还将favicon缓存在内存中，通过减少磁盘访问来提高性能。</p>
<p>默认情况下，<code>serve-favicon</code>会将图标缓存一年。</p>
<pre>Cache-Control: public, max-age=31536000
</pre>
<p>你也可以通过在<code>favicon</code>中传递一个属性为<code>maxAge</code>的选项对象来改变<code>Cache-Control</code>。</p>
<pre>// Serve Favicon
app.use(
  favicon("favicon.ico", {
    maxAge: 500 * 60 * 60 * 24 * 1000,
  })
);
</pre>
<h2 id="conclusion">结论</h2>
<p>在本文中，我们讨论了如何使用五个Express.js中间件。当然，您可能希望为您的Express API探索其他中间件，但是我们在本指南中研究的工具可以用于几乎任何应用程序，并提供了Express中间件可以增强您的API的优秀快照。</p><div class="code-block code-block-23">
<div class="blog-plug inline-plug node-plug"><h2>200只<img src="../Images/61167b9d027ca73ed5aaf59a9ec31267.png" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2019/10/green-check.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" class=" jetpack-lazy-image" data-original-src="https://blog.logrocket.com/wp-content/uploads/2019/10/green-check.png"/> <noscript> <img data-lazy-fallback="1" src="../Images/61167b9d027ca73ed5aaf59a9ec31267.png" data-original-src="https://blog.logrocket.com/wp-content/uploads/2019/10/green-check.png"/> </noscript>显示器出现故障，生产中网络请求缓慢</h2><p>部署基于节点的web应用程序或网站是容易的部分。确保您的节点实例继续为您的应用程序提供资源是事情变得更加困难的地方。如果您对确保对后端或第三方服务的请求成功感兴趣，</p><a href="https://lp.logrocket.com/blg/node-signup" target="_blank">try LogRocket</a><p>. </p><a class="signup" href="https://lp.logrocket.com/blg/node-signup" target="_blank" rel="noopener noreferrer"><img src="../Images/cae72fd2a54c5f02a6398c4867894844.png" alt="LogRocket Network Request Monitoring" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2019/12/network-request-filter-2-1.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" class=" jetpack-lazy-image" data-original-src="https://blog.logrocket.com/wp-content/uploads/2019/12/network-request-filter-2-1.png"/><noscript><img data-lazy-fallback="1" src="../Images/cae72fd2a54c5f02a6398c4867894844.png" alt="LogRocket Network Request Monitoring" data-original-src="https://blog.logrocket.com/wp-content/uploads/2019/12/network-request-filter-2-1.png"/></noscript></a><a href="https://lp.logrocket.com/blg/node-signup" target="_blank" rel="noopener noreferrer">https://logrocket.com/signup/</a><p>LogRocket 就像是网络和移动应用程序的DVR，记录下用户与你的应用程序交互时发生的一切。您可以汇总并报告有问题的网络请求，以快速了解根本原因，而不是猜测问题发生的原因。</p><p>LogRocket检测您的应用程序以记录基线性能计时，如页面加载时间、到达第一个字节的时间、慢速网络请求，还记录Redux、NgRx和Vuex操作/状态。</p><a class="signup" href="https://lp.logrocket.com/blg/node-signup" target="_blank" rel="noopener noreferrer">Start monitoring for free</a><p>. </p></div>
</div>

<p class="clearfix"/>
<p class="clearfix"/>
</article>

</div>    
</body>
</html>