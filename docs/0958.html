<html>
<head>
<title>Treating GraphQL directives as middleware - LogRocket Blog</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>将GraphQL指令视为中间件</h1>
<blockquote>原文：<a href="https://blog.logrocket.com/treating-graphql-directives-as-middleware/#0001-01-01">https://blog.logrocket.com/treating-graphql-directives-as-middleware/#0001-01-01</a></blockquote><div><article class="article-post">
<p>如果您使用过Express.js，Node.js web应用程序框架，那么您应该知道中间件的概念。Express应用程序本质上是一系列中间件函数调用，其中中间件函数可以运行任何代码，修改请求和响应对象，终止执行，并将执行传递给堆栈中的下一个中间件函数。</p>
<p>下面的代码演示了一个中间件函数，它接收请求对象<code>req</code>，响应对象<code>res</code>，以及应用程序请求-响应周期中的下一个中间件函数<code>next</code>:</p>
<pre class="json">var express = require('express')
var app = express()

// Middleware function which prints the requested URL and calls the next function
app.use(function (req, res, next) {
  console.log('Request URL:', req.originalUrl)
  next()
})</pre>
<p>中间件有助于有效地组织代码库，将逻辑分成处理单个任务的块，这些块可以在同一项目中针对不同的请求重用(也可以通过库跨项目重用)，从而实现代码模块化和关注点的清晰分离。</p>
<p>它的主要用例是跨应用程序实现那些功能，例如:</p>
<ul>
<li>批准</li>
<li>度量的提取和存储</li>
<li>贮藏</li>
<li>排除故障</li>
<li>回退操作</li>
<li>输入验证</li>
<li>记录</li>
<li>输出操作</li>
</ul>
<h2>GraphQL中的字段解析中间件</h2>
<p>一些GraphQL服务器已经结合了中间件的概念，将在现场解析器级别应用。中间件使我们能够通过一系列简单的解析器功能来解析领域，而不是应用执行大量业务逻辑的单个解析器功能。</p>
<p>基于Express，<a href="https://github.com/prisma-labs/graphql-yoga"> graphql-yoga </a>支持开箱即用的现场解析器中间件，通过<a href="https://github.com/prisma-labs/graphql-middleware"> graphql-middleware </a>包实现。</p>
<p>在下面的<a href="https://github.com/prisma-labs/graphql-middleware#how-does-it-work">代码中，字段<code>hello</code>是用这个解析器实现的:</a></p>
<pre class="json">const typeDefs = `
type Query {
  hello(name: String): String
}
`
const resolvers = {
  Query: {
    hello: (root, args, context, info) =&gt; {
      console.log(`3. resolver: hello`)
      return `Hello ${args.name ? args.name : 'world'}!`
    },
  },
}</pre>
<p>解析器可以增加中间件功能，该功能在解析场之前和/或之后执行任意逻辑:</p>
<pre class="json">const { GraphQLServer } = require('graphql-yoga')

const logInput = async (resolve, root, args, context, info) =&gt; {
  console.log(`1. logInput: ${JSON.stringify(args)}`)
  const result = await resolve(root, args, context, info)
  console.log(`5. logInput`)
  return result
}

const logResult = async (resolve, root, args, context, info) =&gt; {
  console.log(`2. logResult`)
  const result = await resolve(root, args, context, info)
  console.log(`4. logResult: ${JSON.stringify(result)}`)
  return result
}

const server = new GraphQLServer({
  typeDefs,
  resolvers,
  middlewares: [logInput, logResult],
})
server.start(() =&gt; console.log('Server is running on http://localhost:4000'))</pre>
<p>现在，解析查询<code>{ hello(name: "Bob") }</code>产生一个洋葱形状的流:</p>
<figure id="attachment_20829" aria-describedby="caption-attachment-20829" class="wp-caption aligncenter"><img data-attachment-id="20829" data-permalink="https://blog.logrocket.com/treating-graphql-directives-as-middleware/middleware-functions-output/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/06/middleware-functions-output.png" data-orig-size="600,666" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Output from middleware functions" data-image-description="" data-image-caption="&lt;p&gt;Output from executing middleware functions with graphql-middleware.&lt;/p&gt;&#10;" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/06/middleware-functions-output-270x300.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/06/middleware-functions-output.png" decoding="async" class="size-full wp-image-20829 jetpack-lazy-image" src="../Images/d706d43f00a95efa85b4712e242b265a.png" alt="Output From Executing Middleware Functions With graphql-middleware" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2020/06/middleware-functions-output.png 600w, https://blog.logrocket.com/wp-content/uploads/2020/06/middleware-functions-output-270x300.png 270w" data-lazy-sizes="(max-width: 600px) 100vw, 600px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2020/06/middleware-functions-output.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/06/middleware-functions-output.png"/><noscript><img data-lazy-fallback="1" data-attachment-id="20829" data-permalink="https://blog.logrocket.com/treating-graphql-directives-as-middleware/middleware-functions-output/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/06/middleware-functions-output.png" data-orig-size="600,666" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Output from middleware functions" data-image-description="" data-image-caption="&lt;p&gt;Output from executing middleware functions with graphql-middleware.&lt;/p&gt;&#10;" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/06/middleware-functions-output-270x300.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/06/middleware-functions-output.png" decoding="async" loading="lazy" class="size-full wp-image-20829" src="../Images/d706d43f00a95efa85b4712e242b265a.png" alt="Output From Executing Middleware Functions With graphql-middleware" srcset="https://blog.logrocket.com/wp-content/uploads/2020/06/middleware-functions-output.png 600w, https://blog.logrocket.com/wp-content/uploads/2020/06/middleware-functions-output-270x300.png 270w" sizes="(max-width: 600px) 100vw, 600px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/06/middleware-functions-output.png"/></noscript><figcaption id="caption-attachment-20829" class="wp-caption-text">Output from executing middleware functions with graphql-middleware.</figcaption></figure>
<p>基于Scala的GraphQL服务器<a href="https://sangria-graphql.org"> Sangria </a>也<a href="https://sangria-graphql.org/learn/#middleware">支持开箱即用的中间件</a>，提供函数<code>beforeField</code>和<code>afterField</code>在字段解析前后执行任意代码:</p>
<figure id="attachment_20831" aria-describedby="caption-attachment-20831" class="wp-caption aligncenter"><img data-attachment-id="20831" data-permalink="https://blog.logrocket.com/treating-graphql-directives-as-middleware/middleware-functions-sangria/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/06/middleware-functions-sangria.png" data-orig-size="730,254" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Executing middleware in Sangria" data-image-description="" data-image-caption="&lt;p&gt;Executing middleware functions in Sangria.&lt;/p&gt;&#10;" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/06/middleware-functions-sangria-300x104.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/06/middleware-functions-sangria.png" decoding="async" class="size-full wp-image-20831 jetpack-lazy-image" src="../Images/3486d76bd9e9cffc5b68abd58ef1e2de.png" alt="Executing Middleware Functions In Sangria" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2020/06/middleware-functions-sangria.png 730w, https://blog.logrocket.com/wp-content/uploads/2020/06/middleware-functions-sangria-300x104.png 300w" data-lazy-sizes="(max-width: 730px) 100vw, 730px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2020/06/middleware-functions-sangria.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/06/middleware-functions-sangria.png"/><noscript><img data-lazy-fallback="1" data-attachment-id="20831" data-permalink="https://blog.logrocket.com/treating-graphql-directives-as-middleware/middleware-functions-sangria/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/06/middleware-functions-sangria.png" data-orig-size="730,254" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Executing middleware in Sangria" data-image-description="" data-image-caption="&lt;p&gt;Executing middleware functions in Sangria.&lt;/p&gt;&#10;" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/06/middleware-functions-sangria-300x104.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/06/middleware-functions-sangria.png" decoding="async" loading="lazy" class="size-full wp-image-20831" src="../Images/3486d76bd9e9cffc5b68abd58ef1e2de.png" alt="Executing Middleware Functions In Sangria" srcset="https://blog.logrocket.com/wp-content/uploads/2020/06/middleware-functions-sangria.png 730w, https://blog.logrocket.com/wp-content/uploads/2020/06/middleware-functions-sangria-300x104.png 300w" sizes="(max-width: 730px) 100vw, 730px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/06/middleware-functions-sangria.png"/></noscript><figcaption id="caption-attachment-20831" class="wp-caption-text">Executing middleware functions in Sangria.</figcaption></figure>
<p>其他为中间件提供支持的GraphQL服务器包括<a href="https://graphql-dotnet.github.io/docs/getting-started/field-middleware/"> GraphQL。网</a>、<a href="https://hotchocolate.io/docs/middleware">热巧克力</a>、<a href="https://ariadnegraphql.org/docs/middleware">阿里阿德涅</a>、<a href="https://lighthouse-php.com/4.12/custom-directives/field-directives.html#fieldmiddleware">灯塔</a>。</p>
<h2>作为中间件执行指令？</h2>
<p>上一节中描述的中间件功能用于增加字段的分辨率。然而GraphQL已经有了一个满足同样功能的特性:指令。既然他们达到了相同的目标，自然会问:为什么需要中间件？为什么不用指令来代替呢？</p>
<p>graph QL-中间件<a href="https://github.com/prisma-labs/graphql-middleware#how-does-graphql-middleware-compare-to-directives">答案</a>:</p>
<blockquote><p>GraphQL中间件和指令以完全不同的方式处理同样的问题。GraphQL中间件允许您在代码中实现所有的中间件逻辑，而指令则鼓励您将模式与功能混合使用。</p></blockquote>
<p>这个回答引发了另一个问题:既然中间件作为一种设计模式自然满足了指令期望满足的功能，那么GraphQL服务器难道不会从将指令实现为中间件中受益吗？</p>
<p>也就是说，使用这样的查询:</p>
<pre class="json">query {
  field @directive1 @directive2
}</pre>
<p>让指令<code>@directive1</code>和<code>@directive2</code>成为中间件，接收解析字段的值，执行它们的任意逻辑，并将结果传递给下一个指令，这有意义吗？</p>
<p>让我们找出答案。</p>
<h3>对比中间件和管道</h3>
<p>一般来说，中间件执行流程如下所示:</p>
<figure id="attachment_21010" aria-describedby="caption-attachment-21010" class="wp-caption aligncenter"><img data-attachment-id="21010" data-permalink="https://blog.logrocket.com/treating-graphql-directives-as-middleware/middleware/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/06/middleware.png" data-orig-size="1322,242" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="middleware" data-image-description="" data-image-caption="&lt;p&gt;Middleware execution flow.&lt;/p&gt;&#10;" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/06/middleware-300x55.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/06/middleware-1024x187.png" decoding="async" class="size-full wp-image-21010 jetpack-lazy-image" src="../Images/81a7c0a67547adad2952b5a49cecc9a7.png" alt="Middleware execution flow." data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2020/06/middleware.png 1322w, https://blog.logrocket.com/wp-content/uploads/2020/06/middleware-300x55.png 300w, https://blog.logrocket.com/wp-content/uploads/2020/06/middleware-1024x187.png 1024w, https://blog.logrocket.com/wp-content/uploads/2020/06/middleware-768x141.png 768w" data-lazy-sizes="(max-width: 1322px) 100vw, 1322px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2020/06/middleware.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/06/middleware.png"/><noscript><img data-lazy-fallback="1" data-attachment-id="21010" data-permalink="https://blog.logrocket.com/treating-graphql-directives-as-middleware/middleware/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/06/middleware.png" data-orig-size="1322,242" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="middleware" data-image-description="" data-image-caption="&lt;p&gt;Middleware execution flow.&lt;/p&gt;&#10;" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/06/middleware-300x55.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/06/middleware-1024x187.png" decoding="async" loading="lazy" class="size-full wp-image-21010" src="../Images/81a7c0a67547adad2952b5a49cecc9a7.png" alt="Middleware execution flow." srcset="https://blog.logrocket.com/wp-content/uploads/2020/06/middleware.png 1322w, https://blog.logrocket.com/wp-content/uploads/2020/06/middleware-300x55.png 300w, https://blog.logrocket.com/wp-content/uploads/2020/06/middleware-1024x187.png 1024w, https://blog.logrocket.com/wp-content/uploads/2020/06/middleware-768x141.png 768w" sizes="(max-width: 1322px) 100vw, 1322px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/06/middleware.png"/></noscript><figcaption id="caption-attachment-21010" class="wp-caption-text">Middleware execution flow.</figcaption></figure>
<p>现在，这个执行流程并不完全适合执行指令，因为指令是按照它们的<a href="https://spec.graphql.org/draft/#sel-HAFjBRBAABKBPv2d">建立的顺序从左到右</a>执行的。因此，我们不能让<code>@directive1</code>在执行<code>@directive2</code>之后更新字段值，而在U形转弯之后可以这样做。</p>
<p>因此，指令执行不能直接作为中间件来实现。我们需要的不是一个U形转弯，而是一个单向执行流程，如下所示:</p>
<figure id="attachment_21011" aria-describedby="caption-attachment-21011" class="wp-caption aligncenter"><img data-attachment-id="21011" data-permalink="https://blog.logrocket.com/treating-graphql-directives-as-middleware/pipeline/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/06/pipeline.png" data-orig-size="1522,242" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="pipeline" data-image-description="" data-image-caption="&lt;p&gt;One-way execution flow.&lt;/p&gt;&#10;" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/06/pipeline-300x48.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/06/pipeline-1024x163.png" decoding="async" class="size-full wp-image-21011 jetpack-lazy-image" src="../Images/060657e147a60f80906ee2e59adb135f.png" alt="One-way execution flow" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2020/06/pipeline.png 1522w, https://blog.logrocket.com/wp-content/uploads/2020/06/pipeline-300x48.png 300w, https://blog.logrocket.com/wp-content/uploads/2020/06/pipeline-1024x163.png 1024w, https://blog.logrocket.com/wp-content/uploads/2020/06/pipeline-768x122.png 768w" data-lazy-sizes="(max-width: 1522px) 100vw, 1522px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2020/06/pipeline.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/06/pipeline.png"/><noscript><img data-lazy-fallback="1" data-attachment-id="21011" data-permalink="https://blog.logrocket.com/treating-graphql-directives-as-middleware/pipeline/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/06/pipeline.png" data-orig-size="1522,242" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="pipeline" data-image-description="" data-image-caption="&lt;p&gt;One-way execution flow.&lt;/p&gt;&#10;" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/06/pipeline-300x48.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/06/pipeline-1024x163.png" decoding="async" loading="lazy" class="size-full wp-image-21011" src="../Images/060657e147a60f80906ee2e59adb135f.png" alt="One-way execution flow" srcset="https://blog.logrocket.com/wp-content/uploads/2020/06/pipeline.png 1522w, https://blog.logrocket.com/wp-content/uploads/2020/06/pipeline-300x48.png 300w, https://blog.logrocket.com/wp-content/uploads/2020/06/pipeline-1024x163.png 1024w, https://blog.logrocket.com/wp-content/uploads/2020/06/pipeline-768x122.png 768w" sizes="(max-width: 1522px) 100vw, 1522px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/06/pipeline.png"/></noscript><figcaption id="caption-attachment-21011" class="wp-caption-text">One-way execution flow.</figcaption></figure>
<p>满足这个执行流程的设计模式被称为<a href="https://en.wikipedia.org/wiki/Chain-of-responsibility_pattern">责任链模式</a>:</p>
<figure id="attachment_21012" aria-describedby="caption-attachment-21012" class="wp-caption aligncenter"><img data-attachment-id="21012" data-permalink="https://blog.logrocket.com/treating-graphql-directives-as-middleware/w3sdesign_chain_of_responsibility_design_pattern_uml/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/06/W3sDesign_Chain_of_Responsibility_Design_Pattern_UML.jpg" data-orig-size="700,240" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="W3sDesign_Chain_of_Responsibility_Design_Pattern_UML" data-image-description="" data-image-caption="&lt;p&gt;Chain-of-responsibility execution flow.&lt;/p&gt;&#10;" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/06/W3sDesign_Chain_of_Responsibility_Design_Pattern_UML-300x103.jpg" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/06/W3sDesign_Chain_of_Responsibility_Design_Pattern_UML.jpg" decoding="async" class="size-full wp-image-21012 jetpack-lazy-image" src="../Images/39112bafb927a3686ab04f308e362093.png" alt="Chain-of-responsibility execution flow" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2020/06/W3sDesign_Chain_of_Responsibility_Design_Pattern_UML.jpg 700w, https://blog.logrocket.com/wp-content/uploads/2020/06/W3sDesign_Chain_of_Responsibility_Design_Pattern_UML-300x103.jpg 300w" data-lazy-sizes="(max-width: 700px) 100vw, 700px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2020/06/W3sDesign_Chain_of_Responsibility_Design_Pattern_UML.jpg?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/06/W3sDesign_Chain_of_Responsibility_Design_Pattern_UML.jpg"/><noscript><img data-lazy-fallback="1" data-attachment-id="21012" data-permalink="https://blog.logrocket.com/treating-graphql-directives-as-middleware/w3sdesign_chain_of_responsibility_design_pattern_uml/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/06/W3sDesign_Chain_of_Responsibility_Design_Pattern_UML.jpg" data-orig-size="700,240" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="W3sDesign_Chain_of_Responsibility_Design_Pattern_UML" data-image-description="" data-image-caption="&lt;p&gt;Chain-of-responsibility execution flow.&lt;/p&gt;&#10;" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/06/W3sDesign_Chain_of_Responsibility_Design_Pattern_UML-300x103.jpg" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/06/W3sDesign_Chain_of_Responsibility_Design_Pattern_UML.jpg" decoding="async" loading="lazy" class="size-full wp-image-21012" src="../Images/39112bafb927a3686ab04f308e362093.png" alt="Chain-of-responsibility execution flow" srcset="https://blog.logrocket.com/wp-content/uploads/2020/06/W3sDesign_Chain_of_Responsibility_Design_Pattern_UML.jpg 700w, https://blog.logrocket.com/wp-content/uploads/2020/06/W3sDesign_Chain_of_Responsibility_Design_Pattern_UML-300x103.jpg 300w" sizes="(max-width: 700px) 100vw, 700px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/06/W3sDesign_Chain_of_Responsibility_Design_Pattern_UML.jpg"/></noscript><figcaption id="caption-attachment-21012" class="wp-caption-text">Chain-of-responsibility execution flow.</figcaption></figure>
<p>相应的结构称为管道，可以很容易地适用于执行指令:</p>
<ul>
<li>管道的输入是字段解析器提供的字段值</li>
<li>每个指令执行其逻辑，并将结果传递给管道中的下一个指令</li>
<li>管道的输出将是已解析的字段值，已经过所有指令的处理</li>
</ul>
<p>看起来是这样的:</p>
<figure id="attachment_21017" aria-describedby="caption-attachment-21017" class="wp-caption aligncenter"><img data-attachment-id="21017" data-permalink="https://blog.logrocket.com/treating-graphql-directives-as-middleware/directive-pipeline-diagram/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/06/directive-pipeline-diagram.png" data-orig-size="1522,242" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="directive-pipeline-diagram" data-image-description="" data-image-caption="&lt;p&gt;Directive pipeline.&lt;/p&gt;&#10;" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/06/directive-pipeline-diagram-300x48.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/06/directive-pipeline-diagram-1024x163.png" decoding="async" class="size-full wp-image-21017 jetpack-lazy-image" src="../Images/e14dd1db04e45c2eb4a3d11d5ae9946d.png" alt="Directive pipeline" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2020/06/directive-pipeline-diagram.png 1522w, https://blog.logrocket.com/wp-content/uploads/2020/06/directive-pipeline-diagram-300x48.png 300w, https://blog.logrocket.com/wp-content/uploads/2020/06/directive-pipeline-diagram-1024x163.png 1024w, https://blog.logrocket.com/wp-content/uploads/2020/06/directive-pipeline-diagram-768x122.png 768w" data-lazy-sizes="(max-width: 1522px) 100vw, 1522px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2020/06/directive-pipeline-diagram.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/06/directive-pipeline-diagram.png"/><noscript><img data-lazy-fallback="1" data-attachment-id="21017" data-permalink="https://blog.logrocket.com/treating-graphql-directives-as-middleware/directive-pipeline-diagram/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/06/directive-pipeline-diagram.png" data-orig-size="1522,242" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="directive-pipeline-diagram" data-image-description="" data-image-caption="&lt;p&gt;Directive pipeline.&lt;/p&gt;&#10;" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/06/directive-pipeline-diagram-300x48.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/06/directive-pipeline-diagram-1024x163.png" decoding="async" loading="lazy" class="size-full wp-image-21017" src="../Images/e14dd1db04e45c2eb4a3d11d5ae9946d.png" alt="Directive pipeline" srcset="https://blog.logrocket.com/wp-content/uploads/2020/06/directive-pipeline-diagram.png 1522w, https://blog.logrocket.com/wp-content/uploads/2020/06/directive-pipeline-diagram-300x48.png 300w, https://blog.logrocket.com/wp-content/uploads/2020/06/directive-pipeline-diagram-1024x163.png 1024w, https://blog.logrocket.com/wp-content/uploads/2020/06/directive-pipeline-diagram-768x122.png 768w" sizes="(max-width: 1522px) 100vw, 1522px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/06/directive-pipeline-diagram.png"/></noscript><figcaption id="caption-attachment-21017" class="wp-caption-text">Directive pipeline.</figcaption></figure>
<p>这种设计比中间件简单，并且可以达到同样的效果:如果<code>@directive1</code>需要在返回的路上执行一些逻辑(即<code>afterField</code>逻辑)，我们可以通过位于字段末端的<code>@directive3</code>来执行这个逻辑:</p>
<pre class="json">query {
  field @directive1 @directive2 @directive3
}</pre>
<p>中间件允许我们随时终止流程，这也可以通过管道来实现。</p>
<p>在某些情况下，在某个中间阶段终止是有意义的，比如当一个指令<code>@validate</code>指示某个验证失败，并且查询不能被执行时。这种逻辑可以通过在流水线中的阶段之间传递布尔标志<code>skipExecution</code>来实现，该标志在运行其逻辑之前由每个指令检查，并且可以在任何阶段由任何指令设置为<code>true</code>。</p>
<p>总之，使用管道比使用中间件更适合执行GraphQL指令。接下来，让我们设计管道来充分利用GraphQL。</p>
<h2>设计指令管道</h2>
<p>在我的上一篇文章<a href="https://blog.logrocket.com/graphql-directives-are-underrated/"> <em> GraphQL指令被低估</em> </a>中，我声明，由于指令潜在的无限力量，良好支持定制指令的GraphQL服务器将引领GraphQL走向未来。</p>
<p>在这种理念的推动下，对于PoP的GraphQL(我自己的PHP graph QL服务器)，我决定将查询解析过程放在指令管道的顶部。因此，该指令可以被视为一个低级组件，使开发人员能够根据需要操纵GraphQL服务器的响应。</p>
<p>让我们看看这种架构是如何工作的，以及它为什么如此强大。</p>
<h3>指令作为查询解析的构造块</h3>
<p>最初，我们考虑让GraphQL服务器通过某种机制解析该字段，然后将该值作为输入传递给指令管道。</p>
<p>然而，用一个机制来处理所有事情要简单得多:调用字段解析器(验证字段和解析字段)已经可以通过指令管道完成了。在这种情况下，指令管道是用于解析查询的唯一机制。</p>
<p>因此，GraphQL服务器提供了两个特殊的指令:</p>
<ul>
<li><code><a href="https://github.com/getpop/component-model/blob/57a27af3841da284ea59c6f7ff3a9b4c0befa472/src/DirectiveResolvers/ValidateDirectiveResolver.php">@validate</a></code>调用字段解析器来验证字段是否可以被解析(例如，语法是否正确，字段是否存在等)。)</li>
<li>如果成功，<code><a href="https://github.com/getpop/component-model/blob/b2ef9fe693c69a6d4c4b549519eb236f527b841d/src/DirectiveResolvers/ResolveValueAndMergeDirectiveResolver.php">@resolveValueAndMerge</a></code>然后调用字段解析器来解析字段，并将值合并到响应对象中</li>
</ul>
<p>这两个是特殊的“系统类型”指令:它们只为GraphQL引擎保留，并且它们隐含在每个字段中。相比之下，标准指令是显式的:它们由用户添加到查询中。</p>
<p>通过使用这两个指令，该查询:</p>
<pre class="json">query {
  field1
  field2 @directiveA
}</pre>
<p>将被解析为:</p>
<pre class="json">query {
  field1 @validate @resolveValueAndMerge
  field2 @validate @resolveValueAndMerge @directiveA
}</pre>
<p>管道现在看起来像这样(请注意，管道接收字段作为输入，而不是它的初始解析值):</p>
<figure id="attachment_20975" aria-describedby="caption-attachment-20975" class="wp-caption aligncenter"><img data-attachment-id="20975" data-permalink="https://blog.logrocket.com/treating-graphql-directives-as-middleware/directive-pipeline-validate-resolvevalueandmerge-2/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/06/directive-pipeline-validate-resolvevalueandmerge-1.png" data-orig-size="1522,242" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Directive pipeline with @validate and @resolveValueAndMerge" data-image-description="" data-image-caption="&lt;p&gt;Directive pipeline with @validate and @resolveValueAndMerge.&lt;/p&gt;&#10;" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/06/directive-pipeline-validate-resolvevalueandmerge-1-300x48.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/06/directive-pipeline-validate-resolvevalueandmerge-1-1024x163.png" decoding="async" class="size-full wp-image-20975 jetpack-lazy-image" src="../Images/74515c5f8723b3137f4530059457ca1d.png" alt="Directive pipeline with @validate and @resolveValueAndMerge" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2020/06/directive-pipeline-validate-resolvevalueandmerge-1.png 1522w, https://blog.logrocket.com/wp-content/uploads/2020/06/directive-pipeline-validate-resolvevalueandmerge-1-300x48.png 300w, https://blog.logrocket.com/wp-content/uploads/2020/06/directive-pipeline-validate-resolvevalueandmerge-1-1024x163.png 1024w, https://blog.logrocket.com/wp-content/uploads/2020/06/directive-pipeline-validate-resolvevalueandmerge-1-768x122.png 768w" data-lazy-sizes="(max-width: 1522px) 100vw, 1522px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2020/06/directive-pipeline-validate-resolvevalueandmerge-1.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/06/directive-pipeline-validate-resolvevalueandmerge-1.png"/><noscript><img data-lazy-fallback="1" data-attachment-id="20975" data-permalink="https://blog.logrocket.com/treating-graphql-directives-as-middleware/directive-pipeline-validate-resolvevalueandmerge-2/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/06/directive-pipeline-validate-resolvevalueandmerge-1.png" data-orig-size="1522,242" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Directive pipeline with @validate and @resolveValueAndMerge" data-image-description="" data-image-caption="&lt;p&gt;Directive pipeline with @validate and @resolveValueAndMerge.&lt;/p&gt;&#10;" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/06/directive-pipeline-validate-resolvevalueandmerge-1-300x48.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/06/directive-pipeline-validate-resolvevalueandmerge-1-1024x163.png" decoding="async" loading="lazy" class="size-full wp-image-20975" src="../Images/74515c5f8723b3137f4530059457ca1d.png" alt="Directive pipeline with @validate and @resolveValueAndMerge" srcset="https://blog.logrocket.com/wp-content/uploads/2020/06/directive-pipeline-validate-resolvevalueandmerge-1.png 1522w, https://blog.logrocket.com/wp-content/uploads/2020/06/directive-pipeline-validate-resolvevalueandmerge-1-300x48.png 300w, https://blog.logrocket.com/wp-content/uploads/2020/06/directive-pipeline-validate-resolvevalueandmerge-1-1024x163.png 1024w, https://blog.logrocket.com/wp-content/uploads/2020/06/directive-pipeline-validate-resolvevalueandmerge-1-768x122.png 768w" sizes="(max-width: 1522px) 100vw, 1522px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/06/directive-pipeline-validate-resolvevalueandmerge-1.png"/></noscript><figcaption id="caption-attachment-20975" class="wp-caption-text">Directive pipeline with @validate and @resolveValueAndMerge.</figcaption></figure>
<h3>管道槽</h3>
<p>指令通常在<code>@resolveValueAndMerge</code>之后执行，因为它们很可能涉及更新已解析字段的值。但是，在<code>@validate</code>之前，或者在<code>@validate</code>和<code>@resolveValueAndMerge</code>之间，还有其他指令必须执行。</p>
<p>例如:</p>
<ul>
<li>为了测量解析一个字段所花费的时间，指令<code>@traceExecutionTime</code>可以通过将子指令<code>@startTracingExecutionTime</code>放置在流水线的开始处和将子指令<code>@endTracingExecutionTime</code>放置在流水线的末端来获得解析该字段之前和之后的当前时间</li>
<li>在执行<code>@resolveValueAndMerge</code>之前，指令<code>@cache</code>必须检查被请求的字段是否被缓存并返回该响应</li>
</ul>
<p>然后，管道将提供三个不同的插槽，指令将指示必须在哪个插槽中执行:</p>
<ul>
<li><code>"beginning"</code>槽–在验证发生之前</li>
<li><code>"middle"</code>槽——验证之后，现场解析之前</li>
<li><code>"end"</code>槽–场分辨率之后</li>
</ul>
<p>指令管道现在看起来像这样:</p>
<figure id="attachment_21020" aria-describedby="caption-attachment-21020" class="wp-caption aligncenter"><img data-attachment-id="21020" data-permalink="https://blog.logrocket.com/treating-graphql-directives-as-middleware/slot-directive-pipeline-diagram/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/06/slot-directive-pipeline-diagram.png" data-orig-size="1522,242" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="slot-directive-pipeline-diagram" data-image-description="" data-image-caption="&lt;p&gt;Directive pipeline with slots.&lt;/p&gt;&#10;" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/06/slot-directive-pipeline-diagram-300x48.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/06/slot-directive-pipeline-diagram-1024x163.png" decoding="async" class="size-full wp-image-21020 jetpack-lazy-image" src="../Images/100288d5450426e2981cf11753128632.png" alt="Directive pipeline with slots" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2020/06/slot-directive-pipeline-diagram.png 1522w, https://blog.logrocket.com/wp-content/uploads/2020/06/slot-directive-pipeline-diagram-300x48.png 300w, https://blog.logrocket.com/wp-content/uploads/2020/06/slot-directive-pipeline-diagram-1024x163.png 1024w, https://blog.logrocket.com/wp-content/uploads/2020/06/slot-directive-pipeline-diagram-768x122.png 768w" data-lazy-sizes="(max-width: 1522px) 100vw, 1522px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2020/06/slot-directive-pipeline-diagram.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/06/slot-directive-pipeline-diagram.png"/><noscript><img data-lazy-fallback="1" data-attachment-id="21020" data-permalink="https://blog.logrocket.com/treating-graphql-directives-as-middleware/slot-directive-pipeline-diagram/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/06/slot-directive-pipeline-diagram.png" data-orig-size="1522,242" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="slot-directive-pipeline-diagram" data-image-description="" data-image-caption="&lt;p&gt;Directive pipeline with slots.&lt;/p&gt;&#10;" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/06/slot-directive-pipeline-diagram-300x48.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/06/slot-directive-pipeline-diagram-1024x163.png" decoding="async" loading="lazy" class="size-full wp-image-21020" src="../Images/100288d5450426e2981cf11753128632.png" alt="Directive pipeline with slots" srcset="https://blog.logrocket.com/wp-content/uploads/2020/06/slot-directive-pipeline-diagram.png 1522w, https://blog.logrocket.com/wp-content/uploads/2020/06/slot-directive-pipeline-diagram-300x48.png 300w, https://blog.logrocket.com/wp-content/uploads/2020/06/slot-directive-pipeline-diagram-1024x163.png 1024w, https://blog.logrocket.com/wp-content/uploads/2020/06/slot-directive-pipeline-diagram-768x122.png 768w" sizes="(max-width: 1522px) 100vw, 1522px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/06/slot-directive-pipeline-diagram.png"/></noscript><figcaption id="caption-attachment-21020" class="wp-caption-text">Directive pipeline with slots.</figcaption></figure>
<p>请注意指令<code><a href="https://github.com/getpop/engine/blob/b52f147c7d66d6677aad31b87794219fd9a1d92d/src/DirectiveResolvers/SkipDirectiveResolver.php">@skip</a></code>和<code><a href="https://github.com/getpop/engine/blob/b52f147c7d66d6677aad31b87794219fd9a1d92d/src/DirectiveResolvers/IncludeDirectiveResolver.php">@include</a></code>是如何如此容易地满足给定的架构的:在<code>"middle"</code>槽中，它们可以通过将标志<code>skipExecution</code>设置为<code>true</code>来通知指令<code>@resolveValueAndMerge</code>(以及流水线中稍后阶段的所有指令)不要执行。</p>
<figure id="attachment_21024" aria-describedby="caption-attachment-21024" class="wp-caption aligncenter"><img data-attachment-id="21024" data-permalink="https://blog.logrocket.com/treating-graphql-directives-as-middleware/diagram-skip-directive-pipeline/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/06/diagram-skip-directive-pipeline.png" data-orig-size="1402,302" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="diagram-skip-directive-pipeline" data-image-description="" data-image-caption="&lt;p&gt;@skip directive in the pipeline.&lt;/p&gt;&#10;" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/06/diagram-skip-directive-pipeline-300x65.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/06/diagram-skip-directive-pipeline-1024x221.png" decoding="async" class="size-full wp-image-21024 jetpack-lazy-image" src="../Images/fdfd0c6933bf28dfe888fb5138e130e3.png" alt="@skip directive in the pipeline" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2020/06/diagram-skip-directive-pipeline.png 1402w, https://blog.logrocket.com/wp-content/uploads/2020/06/diagram-skip-directive-pipeline-300x65.png 300w, https://blog.logrocket.com/wp-content/uploads/2020/06/diagram-skip-directive-pipeline-1024x221.png 1024w, https://blog.logrocket.com/wp-content/uploads/2020/06/diagram-skip-directive-pipeline-768x165.png 768w" data-lazy-sizes="(max-width: 1402px) 100vw, 1402px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2020/06/diagram-skip-directive-pipeline.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/06/diagram-skip-directive-pipeline.png"/><noscript><img data-lazy-fallback="1" data-attachment-id="21024" data-permalink="https://blog.logrocket.com/treating-graphql-directives-as-middleware/diagram-skip-directive-pipeline/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/06/diagram-skip-directive-pipeline.png" data-orig-size="1402,302" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="diagram-skip-directive-pipeline" data-image-description="" data-image-caption="&lt;p&gt;@skip directive in the pipeline.&lt;/p&gt;&#10;" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/06/diagram-skip-directive-pipeline-300x65.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/06/diagram-skip-directive-pipeline-1024x221.png" decoding="async" loading="lazy" class="size-full wp-image-21024" src="../Images/fdfd0c6933bf28dfe888fb5138e130e3.png" alt="@skip directive in the pipeline" srcset="https://blog.logrocket.com/wp-content/uploads/2020/06/diagram-skip-directive-pipeline.png 1402w, https://blog.logrocket.com/wp-content/uploads/2020/06/diagram-skip-directive-pipeline-300x65.png 300w, https://blog.logrocket.com/wp-content/uploads/2020/06/diagram-skip-directive-pipeline-1024x221.png 1024w, https://blog.logrocket.com/wp-content/uploads/2020/06/diagram-skip-directive-pipeline-768x165.png 768w" sizes="(max-width: 1402px) 100vw, 1402px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/06/diagram-skip-directive-pipeline.png"/></noscript><figcaption id="caption-attachment-21024" class="wp-caption-text">@skip directive in the pipeline.</figcaption></figure>
<h3>在单个调用中对多个字段执行指令</h3>
<p>到目前为止，我们已经考虑了输入到指令管道的单个字段。然而，在一个典型的GraphQL查询中，我们会收到几个要执行指令的字段。例如，在下面的查询中，对字段<code>"field1"</code>和<code>"field2"</code>执行指令<code>@upperCase</code>:</p>
<pre class="json">query {
  field1 @upperCase
  field2 @upperCase
  field3
}</pre>
<p>此外，由于GraphQL引擎将系统指令<code>@validate</code>和<code>@resolveValueAndMerge</code>添加到查询中的每个字段，因此该查询:</p>
<pre class="json">query {
  field1
  field2
  field3
}</pre>
<p>解析为以下查询:</p>
<pre class="json">query {
  field1 @validate @resolveValueAndMerge
  field2 @validate @resolveValueAndMerge
  field3 @validate @resolveValueAndMerge
}</pre>
<p>然后，系统指令将总是接收所有字段作为输入。</p>
<p>因此，我们可以设计指令管道来接收多个字段作为输入，而不是一次只接收一个。</p>
<p>这种体系结构更有效，因为对所有字段只执行一次指令比对每个字段执行一次更快，而且会产生相同的结果。例如，在验证用户是否登录以授予对模式的访问权时，操作只能执行一次。运行以下代码:</p>
<pre class="json">if (isUserLoggedIn()) {
  resolveFields([$field1, $field2, $field3]);
}</pre>
<p>比运行以下代码更有效:</p>
<pre class="json">if (isUserLoggedIn()) {
  resolveField($field1);
}
if (isUserLoggedIn()) {
  resolveField($field2);
}
if (isUserLoggedIn()) {
  resolveField($field3);
}</pre>
<p>在调用本地函数(如<code>isUserLoggedIn</code>)时，这可能看起来没什么大不了的，但在与外部服务交互时，这可能会产生很大的影响，如通过GraphQL解析REST端点。在这些情况下，一次而不是多次执行一个功能会决定是否能够提供某种功能。</p>
<p>让我们看一个例子。当通过<code>@translate</code>指令与Google Translate交互时，GraphQL API必须通过网络建立连接。然后，执行这段代码将尽可能快:</p>
<pre class="json">googleTranslateFields([$field1, $field2, $field3]);</pre>
<p>相反，多次单独执行函数会产生更长的延迟，从而导致更长的响应时间，降低API的性能。对于翻译三个字符串(其中字段是要翻译的字符串)，这可能不是很大的区别，但是对于100个或更多的字符串，这肯定会有影响:</p>
<pre class="json">googleTranslateField($field1);
googleTranslateField($field2);
googleTranslateField($field3);</pre>
<p>此外，对所有输入执行一次函数可能比对每个字段单独执行函数产生更好的响应。再次以谷歌翻译为例，我们提供给服务的数据越多，翻译就越精确。</p>
<p>例如，当执行下面的代码时:</p>
<pre class="json">googleTranslate("fork");
googleTranslate("road");
googleTranslate("sign");</pre>
<p>对于第一次独立执行，谷歌不知道<code>"fork"</code>的上下文，所以它很可能用fork作为吃饭的器具，作为分支的道路，或者作为另一个意思来回答。但是，如果我们改为执行:</p>
<pre class="json">googleTranslate(["fork", "road", "sign"]);</pre>
<p>从这些大量的信息中，Google可以推断出<code>"fork"</code>指的是一条道路的分支，并返回精确的翻译。</p>
<p>正是由于这些原因，管道中的指令应该一起接收输入字段，然后每个指令可以决定在这些输入上运行其逻辑的最佳方式——每个输入一次执行，包含所有输入的一次执行，或者介于两者之间的任何方式。管道现在看起来像这样:</p>
<figure id="attachment_21027" aria-describedby="caption-attachment-21027" class="wp-caption aligncenter"><img data-attachment-id="21027" data-permalink="https://blog.logrocket.com/treating-graphql-directives-as-middleware/diagram-multiple-fields-directive-pipeline-1/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/06/diagram-multiple-fields-directive-pipeline-1.png" data-orig-size="1522,242" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="diagram-multiple-fields-directive-pipeline-1" data-image-description="" data-image-caption="&lt;p&gt;Receiving multiple fields as input in the directive pipeline.&lt;/p&gt;&#10;" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/06/diagram-multiple-fields-directive-pipeline-1-300x48.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/06/diagram-multiple-fields-directive-pipeline-1-1024x163.png" decoding="async" class="size-full wp-image-21027 jetpack-lazy-image" src="../Images/072ce09f0e4f06ecc3918f7aef6b1934.png" alt="Receiving multiple fields as input in the directive pipeline" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2020/06/diagram-multiple-fields-directive-pipeline-1.png 1522w, https://blog.logrocket.com/wp-content/uploads/2020/06/diagram-multiple-fields-directive-pipeline-1-300x48.png 300w, https://blog.logrocket.com/wp-content/uploads/2020/06/diagram-multiple-fields-directive-pipeline-1-1024x163.png 1024w, https://blog.logrocket.com/wp-content/uploads/2020/06/diagram-multiple-fields-directive-pipeline-1-768x122.png 768w" data-lazy-sizes="(max-width: 1522px) 100vw, 1522px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2020/06/diagram-multiple-fields-directive-pipeline-1.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/06/diagram-multiple-fields-directive-pipeline-1.png"/><noscript><img data-lazy-fallback="1" data-attachment-id="21027" data-permalink="https://blog.logrocket.com/treating-graphql-directives-as-middleware/diagram-multiple-fields-directive-pipeline-1/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/06/diagram-multiple-fields-directive-pipeline-1.png" data-orig-size="1522,242" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="diagram-multiple-fields-directive-pipeline-1" data-image-description="" data-image-caption="&lt;p&gt;Receiving multiple fields as input in the directive pipeline.&lt;/p&gt;&#10;" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/06/diagram-multiple-fields-directive-pipeline-1-300x48.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/06/diagram-multiple-fields-directive-pipeline-1-1024x163.png" decoding="async" loading="lazy" class="size-full wp-image-21027" src="../Images/072ce09f0e4f06ecc3918f7aef6b1934.png" alt="Receiving multiple fields as input in the directive pipeline" srcset="https://blog.logrocket.com/wp-content/uploads/2020/06/diagram-multiple-fields-directive-pipeline-1.png 1522w, https://blog.logrocket.com/wp-content/uploads/2020/06/diagram-multiple-fields-directive-pipeline-1-300x48.png 300w, https://blog.logrocket.com/wp-content/uploads/2020/06/diagram-multiple-fields-directive-pipeline-1-1024x163.png 1024w, https://blog.logrocket.com/wp-content/uploads/2020/06/diagram-multiple-fields-directive-pipeline-1-768x122.png 768w" sizes="(max-width: 1522px) 100vw, 1522px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/06/diagram-multiple-fields-directive-pipeline-1.png"/></noscript><figcaption id="caption-attachment-21027" class="wp-caption-text">Receiving multiple fields as input in the directive pipeline.</figcaption></figure>
<h3>对整个查询执行单个指令管道</h3>
<p>刚才，我们了解到每个指令执行多个字段是有意义的——只要所有字段都应用了相同的指令，这就很好。当指令不同时，会导致更大的复杂性，使其难以实现，并会减少一些已获得的好处。</p>
<p>让我们看看这是如何发生的。考虑以下查询:</p>
<pre class="json">query {
  field1 @directiveA
  field2
  field3
}</pre>
<p>上面的指令相当于这个指令:</p>
<pre class="json">query {
  field1 @validate @resolveValueAndMerge @directiveA
  field2 @validate @resolveValueAndMerge
  field3 @validate @resolveValueAndMerge
}</pre>
<p>在这个场景中，字段<code>field2</code>和<code>field3</code>有相同的一组指令，而<code>field1</code>有不同的一组指令。然后，我们必须生成两个不同的管道来解析查询:</p>
<figure id="attachment_21030" aria-describedby="caption-attachment-21030" class="wp-caption aligncenter"><img data-attachment-id="21030" data-permalink="https://blog.logrocket.com/treating-graphql-directives-as-middleware/two-distinct-field-directive-pipelines/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/06/two-distinct-field-directive-pipelines.png" data-orig-size="1202,562" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="two-distinct-field-directive-pipelines" data-image-description="" data-image-caption="&lt;p&gt;The query requires two directive pipelines to be resolved&lt;/p&gt;&#10;" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/06/two-distinct-field-directive-pipelines-300x140.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/06/two-distinct-field-directive-pipelines-1024x479.png" decoding="async" class="size-full wp-image-21030 jetpack-lazy-image" src="../Images/ef6dea43db43193f866549a444fd47b6.png" alt="The query requires two directive pipelines to be resolved" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2020/06/two-distinct-field-directive-pipelines.png 1202w, https://blog.logrocket.com/wp-content/uploads/2020/06/two-distinct-field-directive-pipelines-300x140.png 300w, https://blog.logrocket.com/wp-content/uploads/2020/06/two-distinct-field-directive-pipelines-1024x479.png 1024w, https://blog.logrocket.com/wp-content/uploads/2020/06/two-distinct-field-directive-pipelines-768x359.png 768w" data-lazy-sizes="(max-width: 1202px) 100vw, 1202px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2020/06/two-distinct-field-directive-pipelines.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/06/two-distinct-field-directive-pipelines.png"/><noscript><img data-lazy-fallback="1" data-attachment-id="21030" data-permalink="https://blog.logrocket.com/treating-graphql-directives-as-middleware/two-distinct-field-directive-pipelines/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/06/two-distinct-field-directive-pipelines.png" data-orig-size="1202,562" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="two-distinct-field-directive-pipelines" data-image-description="" data-image-caption="&lt;p&gt;The query requires two directive pipelines to be resolved&lt;/p&gt;&#10;" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/06/two-distinct-field-directive-pipelines-300x140.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/06/two-distinct-field-directive-pipelines-1024x479.png" decoding="async" loading="lazy" class="size-full wp-image-21030" src="../Images/ef6dea43db43193f866549a444fd47b6.png" alt="The query requires two directive pipelines to be resolved" srcset="https://blog.logrocket.com/wp-content/uploads/2020/06/two-distinct-field-directive-pipelines.png 1202w, https://blog.logrocket.com/wp-content/uploads/2020/06/two-distinct-field-directive-pipelines-300x140.png 300w, https://blog.logrocket.com/wp-content/uploads/2020/06/two-distinct-field-directive-pipelines-1024x479.png 1024w, https://blog.logrocket.com/wp-content/uploads/2020/06/two-distinct-field-directive-pipelines-768x359.png 768w" sizes="(max-width: 1202px) 100vw, 1202px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/06/two-distinct-field-directive-pipelines.png"/></noscript><figcaption id="caption-attachment-21030" class="wp-caption-text">The query requires two directive pipelines to be resolved</figcaption></figure>
<p>当所有字段都有一组唯一的指令时，这种效果会更加明显。考虑这个查询:</p>
<pre class="json">query {
  field1 @directiveA
  field2 @directiveB @directiveC
  field3 @directiveC
}</pre>
<p>相当于这个:</p>
<pre class="json">query {
  field1 @validate @resolveValueAndMerge @directiveA
  field2 @validate @resolveValueAndMerge @directiveB @directiveC
  field3 @validate @resolveValueAndMerge @directiveC
}</pre>
<p>在这种情况下，我们将有三个管道来处理三个字段，如下所示:</p>
<figure id="attachment_21032" aria-describedby="caption-attachment-21032" class="wp-caption aligncenter"><img data-attachment-id="21032" data-permalink="https://blog.logrocket.com/treating-graphql-directives-as-middleware/three-unique-field-directive-pipelines/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/06/three-unique-field-directive-pipelines.png" data-orig-size="1522,882" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="three-unique-field-directive-pipelines" data-image-description="" data-image-caption="&lt;p&gt;The query requires three directive pipelines to be resolved&lt;/p&gt;&#10;" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/06/three-unique-field-directive-pipelines-300x174.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/06/three-unique-field-directive-pipelines-1024x593.png" decoding="async" class="size-full wp-image-21032 jetpack-lazy-image" src="../Images/56d703ad7b2822c162407cc879d0ae03.png" alt="The query requires three directive pipelines to be resolved" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2020/06/three-unique-field-directive-pipelines.png 1522w, https://blog.logrocket.com/wp-content/uploads/2020/06/three-unique-field-directive-pipelines-300x174.png 300w, https://blog.logrocket.com/wp-content/uploads/2020/06/three-unique-field-directive-pipelines-1024x593.png 1024w, https://blog.logrocket.com/wp-content/uploads/2020/06/three-unique-field-directive-pipelines-768x445.png 768w" data-lazy-sizes="(max-width: 1522px) 100vw, 1522px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2020/06/three-unique-field-directive-pipelines.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/06/three-unique-field-directive-pipelines.png"/><noscript><img data-lazy-fallback="1" data-attachment-id="21032" data-permalink="https://blog.logrocket.com/treating-graphql-directives-as-middleware/three-unique-field-directive-pipelines/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/06/three-unique-field-directive-pipelines.png" data-orig-size="1522,882" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="three-unique-field-directive-pipelines" data-image-description="" data-image-caption="&lt;p&gt;The query requires three directive pipelines to be resolved&lt;/p&gt;&#10;" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/06/three-unique-field-directive-pipelines-300x174.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/06/three-unique-field-directive-pipelines-1024x593.png" decoding="async" loading="lazy" class="size-full wp-image-21032" src="../Images/56d703ad7b2822c162407cc879d0ae03.png" alt="The query requires three directive pipelines to be resolved" srcset="https://blog.logrocket.com/wp-content/uploads/2020/06/three-unique-field-directive-pipelines.png 1522w, https://blog.logrocket.com/wp-content/uploads/2020/06/three-unique-field-directive-pipelines-300x174.png 300w, https://blog.logrocket.com/wp-content/uploads/2020/06/three-unique-field-directive-pipelines-1024x593.png 1024w, https://blog.logrocket.com/wp-content/uploads/2020/06/three-unique-field-directive-pipelines-768x445.png 768w" sizes="(max-width: 1522px) 100vw, 1522px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/06/three-unique-field-directive-pipelines.png"/></noscript><figcaption id="caption-attachment-21032" class="wp-caption-text">The query requires three directive pipelines to be resolved</figcaption></figure>
<p>在这种情况下，即使指令<code>@validate</code>和<code>@resolveValueAndMerge</code>应用于三个字段，它们也将彼此独立地执行，因为它们是通过三个不同的指令管道执行的——这使我们回到了一次对一个项目执行一个指令的情况。</p>
<p>这个问题的解决方案是避免生产多条管道，而是为所有油田处理一条管道。因此，我们不能再将字段作为输入传递给管道，因为不是来自一个管道的所有指令都将与同一组字段交互；相反，每个指令必须接收自己的字段列表作为自己的输入。</p>
<p>然后，对于这个查询:</p>
<pre class="json">query {
  field1 @directiveA
  field2
  field3
}</pre>
<p>指令<code>@validate</code>和<code>@resolveValueAndMerge</code>将得到所有三个字段作为输入，<code>directiveA</code>将只得到<code>"field1"</code>:</p>
<figure id="attachment_21036" aria-describedby="caption-attachment-21036" class="wp-caption aligncenter"><img data-attachment-id="21036" data-permalink="https://blog.logrocket.com/treating-graphql-directives-as-middleware/1st-single-multiple-fields-slot-directive-pipeline/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/06/1st-single-multiple-fields-slot-directive-pipeline.png" data-orig-size="1202,422" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="1st-single-multiple-fields-slot-directive-pipeline" data-image-description="" data-image-caption="&lt;p&gt;Single directive pipeline to resolve all fields.&lt;/p&gt;&#10;" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/06/1st-single-multiple-fields-slot-directive-pipeline-300x105.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/06/1st-single-multiple-fields-slot-directive-pipeline-1024x360.png" decoding="async" class="size-full wp-image-21036 jetpack-lazy-image" src="../Images/f8ca575232a65d29b64b6631624e8a12.png" alt="Single directive pipeline to resolve all fields" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2020/06/1st-single-multiple-fields-slot-directive-pipeline.png 1202w, https://blog.logrocket.com/wp-content/uploads/2020/06/1st-single-multiple-fields-slot-directive-pipeline-300x105.png 300w, https://blog.logrocket.com/wp-content/uploads/2020/06/1st-single-multiple-fields-slot-directive-pipeline-1024x360.png 1024w, https://blog.logrocket.com/wp-content/uploads/2020/06/1st-single-multiple-fields-slot-directive-pipeline-768x270.png 768w" data-lazy-sizes="(max-width: 1202px) 100vw, 1202px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2020/06/1st-single-multiple-fields-slot-directive-pipeline.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/06/1st-single-multiple-fields-slot-directive-pipeline.png"/><noscript><img data-lazy-fallback="1" data-attachment-id="21036" data-permalink="https://blog.logrocket.com/treating-graphql-directives-as-middleware/1st-single-multiple-fields-slot-directive-pipeline/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/06/1st-single-multiple-fields-slot-directive-pipeline.png" data-orig-size="1202,422" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="1st-single-multiple-fields-slot-directive-pipeline" data-image-description="" data-image-caption="&lt;p&gt;Single directive pipeline to resolve all fields.&lt;/p&gt;&#10;" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/06/1st-single-multiple-fields-slot-directive-pipeline-300x105.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/06/1st-single-multiple-fields-slot-directive-pipeline-1024x360.png" decoding="async" loading="lazy" class="size-full wp-image-21036" src="../Images/f8ca575232a65d29b64b6631624e8a12.png" alt="Single directive pipeline to resolve all fields" srcset="https://blog.logrocket.com/wp-content/uploads/2020/06/1st-single-multiple-fields-slot-directive-pipeline.png 1202w, https://blog.logrocket.com/wp-content/uploads/2020/06/1st-single-multiple-fields-slot-directive-pipeline-300x105.png 300w, https://blog.logrocket.com/wp-content/uploads/2020/06/1st-single-multiple-fields-slot-directive-pipeline-1024x360.png 1024w, https://blog.logrocket.com/wp-content/uploads/2020/06/1st-single-multiple-fields-slot-directive-pipeline-768x270.png 768w" sizes="(max-width: 1202px) 100vw, 1202px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/06/1st-single-multiple-fields-slot-directive-pipeline.png"/></noscript><figcaption id="caption-attachment-21036" class="wp-caption-text">Single directive pipeline to resolve all fields.</figcaption></figure>
<p><span>对于这个查询:</span></p>
<pre class="json">query {
  field1 @directiveA
  field2 @directiveB @directiveC
  field3 @directiveC
}</pre>
<p>指令<code>@validate</code>和<code>@resolveValueAndMerge</code>将获得所有三个字段作为输入；<code>directiveA</code>只会得到<code>"field1"</code>；<code>directiveB</code>只会得到<code>"field2"</code>；而<code>directiveC</code>会得到<code>"field2"</code>和<code>"field3"</code>:</p>
<figure id="attachment_21040" aria-describedby="caption-attachment-21040" class="wp-caption aligncenter"><img data-attachment-id="21040" data-permalink="https://blog.logrocket.com/treating-graphql-directives-as-middleware/2nd-single-multiple-fields-slot-directive-pipeline/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/06/2nd-single-multiple-fields-slot-directive-pipeline.png" data-orig-size="1522,422" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="2nd-single-multiple-fields-slot-directive-pipeline" data-image-description="" data-image-caption="&lt;p&gt;Another single directive pipeline to resolve all fields.&lt;/p&gt;&#10;" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/06/2nd-single-multiple-fields-slot-directive-pipeline-300x83.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/06/2nd-single-multiple-fields-slot-directive-pipeline-1024x284.png" decoding="async" class="size-full wp-image-21040 jetpack-lazy-image" src="../Images/04843e387c5a6b761e3a708e97b6b02b.png" alt="Another single directive pipeline to resolve all fields" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2020/06/2nd-single-multiple-fields-slot-directive-pipeline.png 1522w, https://blog.logrocket.com/wp-content/uploads/2020/06/2nd-single-multiple-fields-slot-directive-pipeline-300x83.png 300w, https://blog.logrocket.com/wp-content/uploads/2020/06/2nd-single-multiple-fields-slot-directive-pipeline-1024x284.png 1024w, https://blog.logrocket.com/wp-content/uploads/2020/06/2nd-single-multiple-fields-slot-directive-pipeline-768x213.png 768w" data-lazy-sizes="(max-width: 1522px) 100vw, 1522px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2020/06/2nd-single-multiple-fields-slot-directive-pipeline.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/06/2nd-single-multiple-fields-slot-directive-pipeline.png"/><noscript><img data-lazy-fallback="1" data-attachment-id="21040" data-permalink="https://blog.logrocket.com/treating-graphql-directives-as-middleware/2nd-single-multiple-fields-slot-directive-pipeline/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/06/2nd-single-multiple-fields-slot-directive-pipeline.png" data-orig-size="1522,422" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="2nd-single-multiple-fields-slot-directive-pipeline" data-image-description="" data-image-caption="&lt;p&gt;Another single directive pipeline to resolve all fields.&lt;/p&gt;&#10;" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/06/2nd-single-multiple-fields-slot-directive-pipeline-300x83.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/06/2nd-single-multiple-fields-slot-directive-pipeline-1024x284.png" decoding="async" loading="lazy" class="size-full wp-image-21040" src="../Images/04843e387c5a6b761e3a708e97b6b02b.png" alt="Another single directive pipeline to resolve all fields" srcset="https://blog.logrocket.com/wp-content/uploads/2020/06/2nd-single-multiple-fields-slot-directive-pipeline.png 1522w, https://blog.logrocket.com/wp-content/uploads/2020/06/2nd-single-multiple-fields-slot-directive-pipeline-300x83.png 300w, https://blog.logrocket.com/wp-content/uploads/2020/06/2nd-single-multiple-fields-slot-directive-pipeline-1024x284.png 1024w, https://blog.logrocket.com/wp-content/uploads/2020/06/2nd-single-multiple-fields-slot-directive-pipeline-768x213.png 768w" sizes="(max-width: 1522px) 100vw, 1522px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/06/2nd-single-multiple-fields-slot-directive-pipeline.png"/></noscript><figcaption id="caption-attachment-21040" class="wp-caption-text">Another single directive pipeline to resolve all fields.</figcaption></figure>
<h3>按ID控制指令的执行</h3>
<p>到目前为止，某个阶段的指令可以通过标志<code>skipExecution</code>影响后面阶段指令的执行。然而，这个标志对于所有情况来说都不够细化。</p>
<p>例如，考虑一个<code>@cache</code>指令，它放在<code>"end"</code>槽中存储字段值，这样下次查询字段时，可以通过放在<code>"middle"</code>槽中的指令<code>@getCache</code>从缓存中检索它的值:</p>
<figure id="attachment_21148" aria-describedby="caption-attachment-21148" class="wp-caption aligncenter"><img data-attachment-id="21148" data-permalink="https://blog.logrocket.com/treating-graphql-directives-as-middleware/cache-single-multiple-fields-slot-directive-pipeline/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/06/cache-single-multiple-fields-slot-directive-pipeline.png" data-orig-size="1282,422" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="cache-single-multiple-fields-slot-directive-pipeline" data-image-description="" data-image-caption="&lt;p&gt;Pipeline with @getCache and @cache directives.&lt;/p&gt;&#10;" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/06/cache-single-multiple-fields-slot-directive-pipeline-300x99.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/06/cache-single-multiple-fields-slot-directive-pipeline-1024x337.png" decoding="async" class="size-full wp-image-21148 jetpack-lazy-image" src="../Images/ff0d963658eea500b8611e74b6664030.png" alt="Pipeline with @getCache and @cache directives" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2020/06/cache-single-multiple-fields-slot-directive-pipeline.png 1282w, https://blog.logrocket.com/wp-content/uploads/2020/06/cache-single-multiple-fields-slot-directive-pipeline-300x99.png 300w, https://blog.logrocket.com/wp-content/uploads/2020/06/cache-single-multiple-fields-slot-directive-pipeline-1024x337.png 1024w, https://blog.logrocket.com/wp-content/uploads/2020/06/cache-single-multiple-fields-slot-directive-pipeline-768x253.png 768w" data-lazy-sizes="(max-width: 1282px) 100vw, 1282px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2020/06/cache-single-multiple-fields-slot-directive-pipeline.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/06/cache-single-multiple-fields-slot-directive-pipeline.png"/><noscript><img data-lazy-fallback="1" data-attachment-id="21148" data-permalink="https://blog.logrocket.com/treating-graphql-directives-as-middleware/cache-single-multiple-fields-slot-directive-pipeline/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/06/cache-single-multiple-fields-slot-directive-pipeline.png" data-orig-size="1282,422" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="cache-single-multiple-fields-slot-directive-pipeline" data-image-description="" data-image-caption="&lt;p&gt;Pipeline with @getCache and @cache directives.&lt;/p&gt;&#10;" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/06/cache-single-multiple-fields-slot-directive-pipeline-300x99.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/06/cache-single-multiple-fields-slot-directive-pipeline-1024x337.png" decoding="async" loading="lazy" class="size-full wp-image-21148" src="../Images/ff0d963658eea500b8611e74b6664030.png" alt="Pipeline with @getCache and @cache directives" srcset="https://blog.logrocket.com/wp-content/uploads/2020/06/cache-single-multiple-fields-slot-directive-pipeline.png 1282w, https://blog.logrocket.com/wp-content/uploads/2020/06/cache-single-multiple-fields-slot-directive-pipeline-300x99.png 300w, https://blog.logrocket.com/wp-content/uploads/2020/06/cache-single-multiple-fields-slot-directive-pipeline-1024x337.png 1024w, https://blog.logrocket.com/wp-content/uploads/2020/06/cache-single-multiple-fields-slot-directive-pipeline-768x253.png 768w" sizes="(max-width: 1282px) 100vw, 1282px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/06/cache-single-multiple-fields-slot-directive-pipeline.png"/></noscript><figcaption id="caption-attachment-21148" class="wp-caption-text">Pipeline with @getCache and @cache directives.</figcaption></figure>
<blockquote><p><strong>注意:</strong>:类似于系统指令，<code>@getCache</code>是隐式的，由<code>@cache</code>自动添加，所以一定不能添加到查询中。稍后会有更多的介绍。</p></blockquote>
<p>当<a href="https://leoloso.com/posts/cache-and-logtime-directives/#heading-@cache-directive">执行该查询</a>时:</p>
<pre class="json">{
  posts(limit: 2) {
    title @translate @cache
  }
}</pre>
<p>服务器将检索并缓存两条记录。然后，我们执行相同的查询，但是应用于四个记录:</p>
<pre class="json">{
  posts(limit: 4) {
    title @translate @cache
  }
}</pre>
<p>当执行第二个查询时，第一个查询的两个记录已经被缓存，但是另外两个记录没有被缓存。然而，为了使用标志<code>skipExecution</code>，我们需要所有四个记录都已经被缓存。如果我们可以从缓存中检索前两条记录，并且只解析另外两条记录，那就更好了。</p>
<p>所以我们再次更新了管道的设计。我们转储<code>skipExecution</code>标志，而是将每个字段的对象id列表传递给每个指令，其中指令必须通过<code>fieldIDs</code>对象输入来应用:</p>
<pre class="json">{
  field1: [ID11, ID12, ...],
  field2: [ID21, ID22, ...],
  ...
  fieldN: [IDN1, IDN2, ...],
}</pre>
<p>变量<code>fieldIDs</code>对于每个指令是唯一的，并且每个指令可以在后面的阶段为所有指令修改<code>fieldIDs</code>的实例。然后，<code>skipExecution</code>可以在一个ID接一个ID的基础上精细地完成，只需从<code>fieldIDs</code>中为堆栈中所有即将到来的指令删除ID。</p>
<p>管道现在看起来像这样:</p>
<figure id="attachment_21045" aria-describedby="caption-attachment-21045" class="wp-caption aligncenter"><img data-attachment-id="21045" data-permalink="https://blog.logrocket.com/treating-graphql-directives-as-middleware/id-single-multiple-fields-slot-directive-pipeline/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/06/id-single-multiple-fields-slot-directive-pipeline.png" data-orig-size="1202,422" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="id-single-multiple-fields-slot-directive-pipeline" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/06/id-single-multiple-fields-slot-directive-pipeline-300x105.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/06/id-single-multiple-fields-slot-directive-pipeline-1024x360.png" decoding="async" class="wp-image-21045 size-full jetpack-lazy-image" src="../Images/19816c730409d4b81da564a2f3e6e7dd.png" alt="Passing the IDs per field to each directive" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2020/06/id-single-multiple-fields-slot-directive-pipeline.png 1202w, https://blog.logrocket.com/wp-content/uploads/2020/06/id-single-multiple-fields-slot-directive-pipeline-300x105.png 300w, https://blog.logrocket.com/wp-content/uploads/2020/06/id-single-multiple-fields-slot-directive-pipeline-1024x360.png 1024w, https://blog.logrocket.com/wp-content/uploads/2020/06/id-single-multiple-fields-slot-directive-pipeline-768x270.png 768w" data-lazy-sizes="(max-width: 1202px) 100vw, 1202px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2020/06/id-single-multiple-fields-slot-directive-pipeline.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/06/id-single-multiple-fields-slot-directive-pipeline.png"/><noscript><img data-lazy-fallback="1" data-attachment-id="21045" data-permalink="https://blog.logrocket.com/treating-graphql-directives-as-middleware/id-single-multiple-fields-slot-directive-pipeline/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/06/id-single-multiple-fields-slot-directive-pipeline.png" data-orig-size="1202,422" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="id-single-multiple-fields-slot-directive-pipeline" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/06/id-single-multiple-fields-slot-directive-pipeline-300x105.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/06/id-single-multiple-fields-slot-directive-pipeline-1024x360.png" decoding="async" loading="lazy" class="wp-image-21045 size-full" src="../Images/19816c730409d4b81da564a2f3e6e7dd.png" alt="Passing the IDs per field to each directive" srcset="https://blog.logrocket.com/wp-content/uploads/2020/06/id-single-multiple-fields-slot-directive-pipeline.png 1202w, https://blog.logrocket.com/wp-content/uploads/2020/06/id-single-multiple-fields-slot-directive-pipeline-300x105.png 300w, https://blog.logrocket.com/wp-content/uploads/2020/06/id-single-multiple-fields-slot-directive-pipeline-1024x360.png 1024w, https://blog.logrocket.com/wp-content/uploads/2020/06/id-single-multiple-fields-slot-directive-pipeline-768x270.png 768w" sizes="(max-width: 1202px) 100vw, 1202px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/06/id-single-multiple-fields-slot-directive-pipeline.png"/></noscript><figcaption id="caption-attachment-21045" class="wp-caption-text">Passing the IDs per field to each directive.</figcaption></figure>
<p>在前面的示例中，当执行翻译两条记录的第一个查询时，管道如下所示:</p>
<figure id="attachment_21047" aria-describedby="caption-attachment-21047" class="wp-caption aligncenter"><img data-attachment-id="21047" data-permalink="https://blog.logrocket.com/treating-graphql-directives-as-middleware/1st-id-single-multiple-fields-slot-directive-pipeline/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/06/1st-id-single-multiple-fields-slot-directive-pipeline.png" data-orig-size="1282,422" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="1st-id-single-multiple-fields-slot-directive-pipeline" data-image-description="" data-image-caption="&lt;p&gt;Passing the IDs per field to each directive for the first query&lt;/p&gt;&#10;" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/06/1st-id-single-multiple-fields-slot-directive-pipeline-300x99.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/06/1st-id-single-multiple-fields-slot-directive-pipeline-1024x337.png" decoding="async" class="size-full wp-image-21047 jetpack-lazy-image" src="../Images/a2ed04889221320350633f74ed352795.png" alt="Passing the IDs per field to each directive for the first query" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2020/06/1st-id-single-multiple-fields-slot-directive-pipeline.png 1282w, https://blog.logrocket.com/wp-content/uploads/2020/06/1st-id-single-multiple-fields-slot-directive-pipeline-300x99.png 300w, https://blog.logrocket.com/wp-content/uploads/2020/06/1st-id-single-multiple-fields-slot-directive-pipeline-1024x337.png 1024w, https://blog.logrocket.com/wp-content/uploads/2020/06/1st-id-single-multiple-fields-slot-directive-pipeline-768x253.png 768w" data-lazy-sizes="(max-width: 1282px) 100vw, 1282px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2020/06/1st-id-single-multiple-fields-slot-directive-pipeline.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/06/1st-id-single-multiple-fields-slot-directive-pipeline.png"/><noscript><img data-lazy-fallback="1" data-attachment-id="21047" data-permalink="https://blog.logrocket.com/treating-graphql-directives-as-middleware/1st-id-single-multiple-fields-slot-directive-pipeline/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/06/1st-id-single-multiple-fields-slot-directive-pipeline.png" data-orig-size="1282,422" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="1st-id-single-multiple-fields-slot-directive-pipeline" data-image-description="" data-image-caption="&lt;p&gt;Passing the IDs per field to each directive for the first query&lt;/p&gt;&#10;" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/06/1st-id-single-multiple-fields-slot-directive-pipeline-300x99.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/06/1st-id-single-multiple-fields-slot-directive-pipeline-1024x337.png" decoding="async" loading="lazy" class="size-full wp-image-21047" src="../Images/a2ed04889221320350633f74ed352795.png" alt="Passing the IDs per field to each directive for the first query" srcset="https://blog.logrocket.com/wp-content/uploads/2020/06/1st-id-single-multiple-fields-slot-directive-pipeline.png 1282w, https://blog.logrocket.com/wp-content/uploads/2020/06/1st-id-single-multiple-fields-slot-directive-pipeline-300x99.png 300w, https://blog.logrocket.com/wp-content/uploads/2020/06/1st-id-single-multiple-fields-slot-directive-pipeline-1024x337.png 1024w, https://blog.logrocket.com/wp-content/uploads/2020/06/1st-id-single-multiple-fields-slot-directive-pipeline-768x253.png 768w" sizes="(max-width: 1282px) 100vw, 1282px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/06/1st-id-single-multiple-fields-slot-directive-pipeline.png"/></noscript><figcaption id="caption-attachment-21047" class="wp-caption-text">Passing the IDs per field to each directive for the first query</figcaption></figure>
<p>当执行翻译四个记录的第二个查询时，指令<code>@getCache</code>获得所有四个记录的id，但是<code>@resolveValueAndMerge</code>和<code>@cache</code>将只接收最后两个记录的id(它们没有被缓存):</p>
<figure id="attachment_21048" aria-describedby="caption-attachment-21048" class="wp-caption aligncenter"><img data-attachment-id="21048" data-permalink="https://blog.logrocket.com/treating-graphql-directives-as-middleware/2nd-id-single-multiple-fields-slot-directive-pipeline/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/06/2nd-id-single-multiple-fields-slot-directive-pipeline.png" data-orig-size="1282,422" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="2nd-id-single-multiple-fields-slot-directive-pipeline" data-image-description="" data-image-caption="&lt;p&gt;Passing the IDs per field to each directive for the second query&lt;/p&gt;&#10;" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/06/2nd-id-single-multiple-fields-slot-directive-pipeline-300x99.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/06/2nd-id-single-multiple-fields-slot-directive-pipeline-1024x337.png" decoding="async" class="size-full wp-image-21048 jetpack-lazy-image" src="../Images/1943574f5842cd605a49e82f053031f0.png" alt="Passing the IDs per field to each directive for the second query" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2020/06/2nd-id-single-multiple-fields-slot-directive-pipeline.png 1282w, https://blog.logrocket.com/wp-content/uploads/2020/06/2nd-id-single-multiple-fields-slot-directive-pipeline-300x99.png 300w, https://blog.logrocket.com/wp-content/uploads/2020/06/2nd-id-single-multiple-fields-slot-directive-pipeline-1024x337.png 1024w, https://blog.logrocket.com/wp-content/uploads/2020/06/2nd-id-single-multiple-fields-slot-directive-pipeline-768x253.png 768w" data-lazy-sizes="(max-width: 1282px) 100vw, 1282px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2020/06/2nd-id-single-multiple-fields-slot-directive-pipeline.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/06/2nd-id-single-multiple-fields-slot-directive-pipeline.png"/><noscript><img data-lazy-fallback="1" data-attachment-id="21048" data-permalink="https://blog.logrocket.com/treating-graphql-directives-as-middleware/2nd-id-single-multiple-fields-slot-directive-pipeline/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/06/2nd-id-single-multiple-fields-slot-directive-pipeline.png" data-orig-size="1282,422" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="2nd-id-single-multiple-fields-slot-directive-pipeline" data-image-description="" data-image-caption="&lt;p&gt;Passing the IDs per field to each directive for the second query&lt;/p&gt;&#10;" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/06/2nd-id-single-multiple-fields-slot-directive-pipeline-300x99.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/06/2nd-id-single-multiple-fields-slot-directive-pipeline-1024x337.png" decoding="async" loading="lazy" class="size-full wp-image-21048" src="../Images/1943574f5842cd605a49e82f053031f0.png" alt="Passing the IDs per field to each directive for the second query" srcset="https://blog.logrocket.com/wp-content/uploads/2020/06/2nd-id-single-multiple-fields-slot-directive-pipeline.png 1282w, https://blog.logrocket.com/wp-content/uploads/2020/06/2nd-id-single-multiple-fields-slot-directive-pipeline-300x99.png 300w, https://blog.logrocket.com/wp-content/uploads/2020/06/2nd-id-single-multiple-fields-slot-directive-pipeline-1024x337.png 1024w, https://blog.logrocket.com/wp-content/uploads/2020/06/2nd-id-single-multiple-fields-slot-directive-pipeline-768x253.png 768w" sizes="(max-width: 1282px) 100vw, 1282px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/06/2nd-id-single-multiple-fields-slot-directive-pipeline.png"/></noscript><figcaption id="caption-attachment-21048" class="wp-caption-text">Passing the IDs per field to each directive for the second query</figcaption></figure>
<h3>把这一切联系在一起</h3>
<p>这是指令管道的最终设计:</p>
<figure id="attachment_21049" aria-describedby="caption-attachment-21049" class="wp-caption aligncenter"><img data-attachment-id="21049" data-permalink="https://blog.logrocket.com/treating-graphql-directives-as-middleware/multiple-fields-slot-directive-pipeline/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/06/multiple-fields-slot-directive-pipeline.png" data-orig-size="1522,422" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="multiple-fields-slot-directive-pipeline" data-image-description="" data-image-caption="&lt;p&gt;Final design of the directive pipeline.&lt;/p&gt;&#10;" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/06/multiple-fields-slot-directive-pipeline-300x83.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/06/multiple-fields-slot-directive-pipeline-1024x284.png" decoding="async" class="size-full wp-image-21049 jetpack-lazy-image" src="../Images/c23b56bda6104a3e50b01d70ffc74877.png" alt="Final design of the directive pipeline" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2020/06/multiple-fields-slot-directive-pipeline.png 1522w, https://blog.logrocket.com/wp-content/uploads/2020/06/multiple-fields-slot-directive-pipeline-300x83.png 300w, https://blog.logrocket.com/wp-content/uploads/2020/06/multiple-fields-slot-directive-pipeline-1024x284.png 1024w, https://blog.logrocket.com/wp-content/uploads/2020/06/multiple-fields-slot-directive-pipeline-768x213.png 768w" data-lazy-sizes="(max-width: 1522px) 100vw, 1522px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2020/06/multiple-fields-slot-directive-pipeline.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/06/multiple-fields-slot-directive-pipeline.png"/><noscript><img data-lazy-fallback="1" data-attachment-id="21049" data-permalink="https://blog.logrocket.com/treating-graphql-directives-as-middleware/multiple-fields-slot-directive-pipeline/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/06/multiple-fields-slot-directive-pipeline.png" data-orig-size="1522,422" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="multiple-fields-slot-directive-pipeline" data-image-description="" data-image-caption="&lt;p&gt;Final design of the directive pipeline.&lt;/p&gt;&#10;" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/06/multiple-fields-slot-directive-pipeline-300x83.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/06/multiple-fields-slot-directive-pipeline-1024x284.png" decoding="async" loading="lazy" class="size-full wp-image-21049" src="../Images/c23b56bda6104a3e50b01d70ffc74877.png" alt="Final design of the directive pipeline" srcset="https://blog.logrocket.com/wp-content/uploads/2020/06/multiple-fields-slot-directive-pipeline.png 1522w, https://blog.logrocket.com/wp-content/uploads/2020/06/multiple-fields-slot-directive-pipeline-300x83.png 300w, https://blog.logrocket.com/wp-content/uploads/2020/06/multiple-fields-slot-directive-pipeline-1024x284.png 1024w, https://blog.logrocket.com/wp-content/uploads/2020/06/multiple-fields-slot-directive-pipeline-768x213.png 768w" sizes="(max-width: 1522px) 100vw, 1522px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/06/multiple-fields-slot-directive-pipeline.png"/></noscript><figcaption id="caption-attachment-21049" class="wp-caption-text">Final design of the directive pipeline.</figcaption></figure>
<p>总而言之，这些是它的特点:</p>
<ul>
<li>通过指令<code>@validate</code>和<code>@resolveValueAndMerge</code>从指令管道内调用字段解析器</li>
<li>指令可以放在三个槽中的任何一个上:<code>"beginning"</code>，在<code>@validate</code>之前；<code>"middle"</code>，在<code>@validate</code>和<code>@resolveValueAndMerge</code>之间；和<code>"end"</code>，在<code>@resolveValueAndMerge</code>之后</li>
<li>指令在一次调用中解析多个字段</li>
<li>单个管道包含查询中涉及的所有指令</li>
<li>每个指令通过变量<code>fieldIDs</code>接收它自己的一组id来解析每个字段</li>
<li>指令可以在流水线的稍后阶段修改所有指令的变量<code>fieldIDs</code></li>
</ul>
<h2>通过指令和字段比较中间件</h2>
<p>基于指令的中间件至少和基于字段的中间件一样好，因为它可以实现所有相同的功能。此外，它提供了几个特性，这些特性需要黑客攻击或额外的复杂性才能用基于领域的中间件来实现。</p>
<p>我们来看看这些。</p>
<h3>自动/手动执行</h3>
<p>如前所述，graphql-middleware项目声明“指令鼓励您将模式与功能相结合。”</p>
<p>这对SDL优先的GraphQL服务器来说是正确的，但对代码优先的GraphQL服务器来说就不一定了(我在之前的一篇文章中解释了它们之间的区别)。对于后一种方法，我们可以直接在查询中执行指令，而不必在模式中定义它。</p>
<p><a href="https://graphql-by-pop.com"> GraphQL by PoP </a>遵循代码优先的方法。它提供了声明<a href="https://graphql-by-pop.com/docs/dynamic-schema/ifttt-through-directives.html"> IFTTT (If This，Then That)规则</a>自动执行指令的可能性:</p>

<p>正如我们前面看到的，最后一条规则被指令<code>@cache</code>用来隐式地将<code>@getCache</code>添加到管道的开头。</p>
<p>有了这些规则，我们可以在不修改模式的情况下自动向查询中添加某个指令，同时还可以在需要时手动添加该指令。相比之下，我们不能通过查询来指示执行特定的字段解析器中间件功能，至少在没有黑客攻击的情况下是这样的。</p>
<p>例如，一个<code><a href="https://leoloso.com/posts/cache-and-logtime-directives/#heading-@traceexecutiontime-directive">@traceExecutionTime</a></code>指令(这里实现的<a href="https://github.com/PoPSchema/trace-tools/blob/8eb5a34faf8b35e3179d311e33ac26251cc82cf5/src/DirectiveResolvers/EndTraceExecutionTimeDirectiveResolver.php">是</a>)可以帮助以一种精细的方式分析API的性能:</p>
<ol>
<li>通过设置由<code>"any"</code>类型上的<code>"any"</code>字段触发的IFTTT规则，让它对查询中的所有字段自动执行</li>
<li>通过设置相应的IFTTT规则，让它为单个字段或指令自动执行</li>
<li>在需要评估的字段的查询中手动定义<code>@traceExecutionTime</code>指令</li>
</ol>
<h3>一次在多个字段上执行</h3>
<p>如前所述，有些操作不能为每个字段独立执行，否则API的质量会下降太多。作为一个例子，我提到了一个连接到Google翻译服务的<code>@translate</code>指令。</p>
<p>使用指令管道，我们可以执行一个包含所有相关字段作为输入的调用。然后，指令<code><a href="https://github.com/PoPSchema/translate-directive/blob/89698ff600fbbeb6639a71a5ae16530ead0dadf9/src/DirectiveResolvers/AbstractTranslateDirectiveResolver.php">@translate</a></code>可以在一个请求中一起翻译几十个字符串<a href="https://newapi.getpop.org/graphiql/?query=query%20%7B%0A%20%20posts%20%7B%0A%20%20%20%20id%0A%20%20%20%20title%0A%20%20%20%20titleES%3A%20title%20%40translate(from%3A%22en%22%2C%20to%3A%22es%22)%0A%20%20%7D%0A%7D">。</a></p>
<p>这也可以使用基于字段的中间件来实现，但是我们负责实现额外的逻辑(批处理/延迟)，并且代码会更加复杂和难以维护。</p>
<h3>低级功能</h3>
<p>作为一个设计决策，GraphQL引擎直接依赖于指令管道来解析查询。因此，指令被视为低级组件，可以访问存储响应的对象。</p>
<p>因此，任何自定义指令都有权修改GraphQL响应。一个明显的用例是指令<code><a href="https://graphql-by-pop.com/docs/operational/remove-if-null.html">@removeIfNull</a></code>(这里实现了<a href="https://github.com/GraphQLByPoP/graphql/blob/3c1ae32f641b5540a7538e3df5d7d6ffeb93d53f/src/DirectiveResolvers/RemoveIfNullDirectiveResolver.php"/>)，它允许我们在查询中指出我们是否宁愿忽略来自一个字段的响应，而不是接收一个<code>null</code>值(关于这个特性的规范中有一个<a href="https://github.com/graphql/graphql-spec/issues/476">问题)。</a></p>
<h2>履行</h2>
<p>设计架构很有趣，但解释其底层代码却不有趣，所以我只提供了生成指令管道的<a href="https://github.com/getpop/component-model/blob/ea3a4b74d197ba319607516a655942f521acf99f/src/TypeResolvers/AbstractTypeResolver.php#L947">逻辑和</a><a href="https://github.com/getpop/component-model/blob/b2ef9fe693c69a6d4c4b549519eb236f527b841d/src/DirectiveResolvers/DirectiveResolverInterface.php#L113">指令接口</a>的链接。</p>
<p>关于指令接口，请注意函数<code>resolveDirective</code>接收的参数:</p>
<pre class="json">public function resolveDirective(
  TypeResolverInterface $typeResolver,
  array &amp;$idsDataFields,
  array &amp;$succeedingPipelineIDsDataFields,
  array &amp;$succeedingPipelineDirectiveResolverInstances,
  array &amp;$resultIDItems,
  array &amp;$unionDBKeyIDs,
  array &amp;$dbItems,
  array &amp;$previousDBItems,
  array &amp;$variables,
  array &amp;$messages,
  array &amp;$dbErrors,
  array &amp;$dbWarnings,
  array &amp;$dbDeprecations,
  array &amp;$dbNotices,
  array &amp;$dbTraces,
  array &amp;$schemaErrors,
  array &amp;$schemaWarnings,
  array &amp;$schemaDeprecations,
  array &amp;$schemaNotices,
  array &amp;$schemaTraces
): void;</pre>
<p>这些参数证明了该指令的低级本质。关于前面解释的设计决策，我们有一些参数:</p>
<ul>
<li><code>$idsDataFields</code>–指令要处理的每个字段的id列表</li>
<li><code>$succeedingPipelineIDsDataFields</code>–在流水线的稍后阶段由指令处理的每个字段的id列表</li>
<li><code>$resultIDItems</code>–响应对象</li>
</ul>
<p>其他参数可以:访问查询变量和定义动态变量(由<code><a href="https://github.com/GraphQLByPoP/graphql/blob/3c1ae32f641b5540a7538e3df5d7d6ffeb93d53f/src/DirectiveResolvers/ExportDirectiveResolver.php">@export</a></code>指令完成)；跨指令传递带有自定义数据的消息；引发错误和警告；识别和显示折旧；<a href="https://graphql-by-pop.com/docs/operational/proactive-feedback.html">给用户传递通知</a>；和存储指标。</p>
<h2>结论</h2>
<p>指令是GraphQL最强大的特性之一，但前提是GraphQL服务器对它们提供良好的支持。</p>
<p>在本文中，我们将中间件确定为一个起点，从这个起点设计一个合适的架构来执行GraphQL中的指令，但是我们最终决定使用责任链设计模式，基于称为“管道”的结构。</p>
<p>有了这个决定，我们一步一步地浏览了为设计一个充分利用GraphQL的指令管道所做的决定。</p>
<h2>继续多看</h2>
<p>本文是正在进行的关于概念化、设计和实现GraphQL服务器的系列文章的一部分。该系列的前几篇文章是:</p>
<ol>
<li><em> <a href="https://blog.logrocket.com/designing-graphql-server-optimal-performance/" target="_blank" rel="nofollow noopener noreferrer">设计GraphQL服务器以获得最佳性能</a> </em></li>
<li><em> <a href="https://blog.logrocket.com/simplifying-the-graphql-data-model/" target="_blank" rel="nofollow noopener noreferrer">简化GraphQL数据模型</a> </em></li>
<li><em><a href="https://blog.logrocket.com/code-first-vs-schema-first-development-graphql/" target="_blank" rel="nofollow noopener noreferrer">graph QL中模式优先与代码优先的开发</a> </em></li>
<li><em> <a href="https://blog.logrocket.com/speeding-up-changes-to-the-graphql-schema/" target="_blank" rel="nofollow noopener noreferrer">加速对GraphQL模式的修改</a> </em></li>
<li><em><a href="https://blog.logrocket.com/versioning-fields-graphql/">graph QL中的版本控制字段</a> </em></li>
<li><em> <a href="https://blog.logrocket.com/graphql-directives-are-underrated/"> GraphQL指令被低估</a> </em></li>
</ol>
<p> </p><div class="code-block code-block-24">
<div class="blog-plug inline-plug graphql-plug"><h2>监控生产中失败和缓慢的GraphQL请求</h2><p>虽然GraphQL有一些调试请求和响应的特性，但确保GraphQL可靠地为您的生产应用程序提供资源是一件比较困难的事情。如果您对确保对后端或第三方服务的网络请求成功感兴趣，</p><a href="https://lp.logrocket.com/blg/graphql-signup" target="_blank">try LogRocket</a><p>.</p><a class="signup" href="https://lp.logrocket.com/blg/graphql-signup" target="_blank" rel="noopener noreferrer"><img src="../Images/432a3823c85b3fb72a206e6236a29f48.png" data-lazy-src="https://files.readme.io/69aa835-Image_2019-11-09_at_1.28.05_PM.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" class=" jetpack-lazy-image" data-original-src="https://files.readme.io/69aa835-Image_2019-11-09_at_1.28.05_PM.png"/><noscript><img data-lazy-fallback="1" src="../Images/432a3823c85b3fb72a206e6236a29f48.png" data-original-src="https://files.readme.io/69aa835-Image_2019-11-09_at_1.28.05_PM.png"/></noscript><img class="alignnone size-full wp-image-46 jetpack-lazy-image" src="../Images/d6f5a5dd739296c1dd7aab3d5e77eeb9.png" alt="LogRocket Dashboard Free Trial Banner" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2017/03/1d0cd-1s_rmyo6nbrasp-xtvbaxfg.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2017/03/1d0cd-1s_rmyo6nbrasp-xtvbaxfg.png"/><noscript><img data-lazy-fallback="1" class="alignnone size-full wp-image-46" src="../Images/d6f5a5dd739296c1dd7aab3d5e77eeb9.png" alt="LogRocket Dashboard Free Trial Banner" data-original-src="https://blog.logrocket.com/wp-content/uploads/2017/03/1d0cd-1s_rmyo6nbrasp-xtvbaxfg.png"/></noscript></a><a href="https://lp.logrocket.com/blg/graphql-signup" target="_blank" rel="noopener noreferrer">https://logrocket.com/signup/</a><p>LogRocket 就像是网络和移动应用的DVR，记录下你网站上发生的每一件事。您可以汇总并报告有问题的GraphQL请求，以快速了解根本原因，而不是猜测问题发生的原因。此外，您可以跟踪Apollo客户机状态并检查GraphQL查询的键值对。</p><p>LogRocket检测您的应用程序以记录基线性能计时，如页面加载时间、到达第一个字节的时间、慢速网络请求，还记录Redux、NgRx和Vuex操作/状态。</p><a class="signup" href="https://lp.logrocket.com/blg/graphql-signup" target="_blank" rel="noopener noreferrer">Start monitoring for free</a><p>.</p></div>


</div>

<p class="clearfix"/>
<p class="clearfix"/>
</article>

</div>    
</body>
</html>