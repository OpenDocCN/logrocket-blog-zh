<html>
<head>
<title>Optimizing static pages in your Next.js apps with Prisma - LogRocket Blog</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>使用Prisma - LogRocket博客优化Next.js应用程序中的静态页面</h1>
<blockquote>原文：<a href="https://blog.logrocket.com/optimizing-static-pages-next-js-prisma/#0001-01-01">https://blog.logrocket.com/optimizing-static-pages-next-js-prisma/#0001-01-01</a></blockquote><div><article class="article-post">
<p>我使用<a href="https://nextjs.org"> Next.js </a>构建应用程序已经有一段时间了，它所提供的开发者体验一直让我感到惊讶。使用Next.js很容易构建一个高性能的服务器端呈现(SSR)应用程序。</p>
<p>在<a href="https://nextjs.org/blog/next-9-3">9.3</a>版本中，Next引入了一些令人惊叹的功能，包括:</p>

<p>在这篇文章中，我们将主要讨论下一代SSG支持，以及为什么将Next.js应用程序与Prisma集成会使这一功能更加强大。本文中的所有代码片段都可以在<a href="https://github.com/ghoshnirmalya/prisma-next.js"> GitHub </a>上获得。</p>
<h2>为什么要用Prisma搭配Next.js？</h2>
<p>Prisma是一个开源的数据库工具包。它通过提供一个类型安全的API来帮助我们查询数据库。<a href="https://github.com/prisma/prisma-client-js"> Prisma Client </a>是一个自动生成的查询构建器，提供对我们数据库的类型安全访问。</p>
<h3>将Prisma与Next.js集成</h3>
<p>将Prisma客户端与Next.js集成非常容易。我们需要首先安装<a href="https://github.com/prisma/prisma-client-js">依赖项</a>:</p>
<pre>yarn add @prisma/client</pre>
<p>接下来，我们需要<a href="https://www.prisma.io/docs/reference/tools-and-interfaces/prisma-cli/command-reference#init">初始化Prisma </a>。从项目根目录运行以下命令:</p>
<pre>npx prisma init</pre>
<p>这将生成以下文件:</p>
<figure id="attachment_19327" aria-describedby="caption-attachment-19327" class="wp-caption aligncenter"><img data-attachment-id="19327" data-permalink="https://blog.logrocket.com/optimizing-static-pages-next-js-prisma/initializing-prisma/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/05/initializing-prisma.png" data-orig-size="730,230" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Initializing Prisma in our app" data-image-description="" data-image-caption="&lt;p&gt;Initializing Prisma in our app.&lt;/p&gt;&#10;" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/05/initializing-prisma-300x95.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/05/initializing-prisma.png" decoding="async" class="size-full wp-image-19327 jetpack-lazy-image" src="../Images/57b59a085efd63956a20be1a39e3df1c.png" alt="Initializing Prisma In Our App" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2020/05/initializing-prisma.png 730w, https://blog.logrocket.com/wp-content/uploads/2020/05/initializing-prisma-300x95.png 300w" data-lazy-sizes="(max-width: 730px) 100vw, 730px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2020/05/initializing-prisma.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/05/initializing-prisma.png"/><noscript><img data-lazy-fallback="1" data-attachment-id="19327" data-permalink="https://blog.logrocket.com/optimizing-static-pages-next-js-prisma/initializing-prisma/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/05/initializing-prisma.png" data-orig-size="730,230" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Initializing Prisma in our app" data-image-description="" data-image-caption="&lt;p&gt;Initializing Prisma in our app.&lt;/p&gt;&#10;" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/05/initializing-prisma-300x95.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/05/initializing-prisma.png" decoding="async" loading="lazy" class="size-full wp-image-19327" src="../Images/57b59a085efd63956a20be1a39e3df1c.png" alt="Initializing Prisma In Our App" srcset="https://blog.logrocket.com/wp-content/uploads/2020/05/initializing-prisma.png 730w, https://blog.logrocket.com/wp-content/uploads/2020/05/initializing-prisma-300x95.png 300w" sizes="(max-width: 730px) 100vw, 730px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/05/initializing-prisma.png"/></noscript><figcaption id="caption-attachment-19327" class="wp-caption-text">Initializing Prisma in our app.</figcaption></figure>
<ol>
<li><code>schema.prisma</code>–带有数据库连接和Prisma客户端生成器的Prisma模式</li>
<li><code>.env</code>–用于定义环境变量的dotenv文件(用于我们的数据库连接)</li>
</ol>
<p>我们将在应用程序中使用SQLite，所以让我们修改一下我们的<code>.env</code>文件:</p>
<pre>// prisma/.env

DATABASE_URL="file:./dev.db"</pre>
<p>让我们也修改我们的模式文件来添加两个模型:</p>
<ol>
<li>邮政<ol>
<li><code>id</code></li>
<li><code>title</code></li>
<li><code>content</code></li>
<li><code>published</code></li>
<li><code>author</code></li>
<li><code>authorId</code></li>
</ol>
</li>
<li>用户<ol>
<li><code>id</code></li>
<li><code>email</code></li>
<li><code>name</code></li>
<li><code>posts</code></li>
</ol>
</li>
</ol>
<pre>// prisma/schema.prisma

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model Post {
  id        Int     @id @default(autoincrement())
  title     String
  content   String?
  published Boolean @default(false)
  author    User?   @relation(fields: [authorId], references: [id])
  authorId  Int?
}

model User {
  id    Int     @id @default(autoincrement())
  email String  @unique
  name  String?
  posts Post[]
}
</pre>
<p>接下来，我们需要<a href="https://www.prisma.io/docs/reference/tools-and-interfaces/prisma-cli/command-reference#migrations-experimental">迁移我们的数据库</a>。为此，我们将运行以下命令:</p>
<pre>npx prisma migrate save --experimental &amp;&amp; npx prisma migrate up --experimental</pre>
<p>现在，我们的Prisma目录将如下所示:</p>
<figure id="attachment_19328" aria-describedby="caption-attachment-19328" class="wp-caption aligncenter"><img data-attachment-id="19328" data-permalink="https://blog.logrocket.com/optimizing-static-pages-next-js-prisma/prisma-directory-structure/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/05/prisma-directory-structure.png" data-orig-size="730,347" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Prisma directory structure" data-image-description="" data-image-caption="&lt;p&gt;Our directory structure after running migrations.&lt;/p&gt;&#10;" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/05/prisma-directory-structure-300x143.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/05/prisma-directory-structure.png" decoding="async" class="size-full wp-image-19328 jetpack-lazy-image" src="../Images/9aeb28d6705944240cb601d6f0405f62.png" alt="Prisma Directory Structure" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2020/05/prisma-directory-structure.png 730w, https://blog.logrocket.com/wp-content/uploads/2020/05/prisma-directory-structure-300x143.png 300w" data-lazy-sizes="(max-width: 730px) 100vw, 730px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2020/05/prisma-directory-structure.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/05/prisma-directory-structure.png"/><noscript><img data-lazy-fallback="1" data-attachment-id="19328" data-permalink="https://blog.logrocket.com/optimizing-static-pages-next-js-prisma/prisma-directory-structure/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/05/prisma-directory-structure.png" data-orig-size="730,347" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Prisma directory structure" data-image-description="" data-image-caption="&lt;p&gt;Our directory structure after running migrations.&lt;/p&gt;&#10;" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/05/prisma-directory-structure-300x143.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/05/prisma-directory-structure.png" decoding="async" loading="lazy" class="size-full wp-image-19328" src="../Images/9aeb28d6705944240cb601d6f0405f62.png" alt="Prisma Directory Structure" srcset="https://blog.logrocket.com/wp-content/uploads/2020/05/prisma-directory-structure.png 730w, https://blog.logrocket.com/wp-content/uploads/2020/05/prisma-directory-structure-300x143.png 300w" sizes="(max-width: 730px) 100vw, 730px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/05/prisma-directory-structure.png"/></noscript><figcaption id="caption-attachment-19328" class="wp-caption-text">Our directory structure after running migrations.</figcaption></figure>
<p>接下来，我们需要<a href="https://www.prisma.io/docs/reference/tools-and-interfaces/prisma-client/generating-prisma-client">生成我们的Prisma客户端</a>。我们可以使用以下命令来实现这一点:</p>
<pre>npx prisma generate</pre>
<p>请注意，我们需要在更改Prisma模式后运行<code>prisma generate</code>命令来更新生成的Prisma客户端代码。另外，当我们安装<code><a href="https://github.com/prisma/prisma-client-js">@prisma/client</a></code> npm模块时，<code>prisma generate</code>会被自动调用。</p>
<p>现在我们可以在代码中使用Prisma，如下所示:</p>
<pre>// pages/get-static-props/index.js

import { PrismaClient } from "@prisma/client";
import { Stack, Box, Link } from "@chakra-ui/core";
import _Link from "next/link";

const IndexPage = ({ posts }) =&gt; {
  return (
    &lt;Stack spacing={4}&gt;
      {posts.map((post) =&gt; {
        return (
          &lt;Box key={post.id}&gt;
            &lt;_Link
              href="/get-static-props/[postId]"
              as={`/get-static-props/${post.id}`}
            &gt;
              &lt;Link&gt;{post.title}&lt;/Link&gt;
            &lt;/_Link&gt;
          &lt;/Box&gt;
        );
      })}
    &lt;/Stack&gt;
  );
};

export async function getStaticProps() {
  const prisma = new PrismaClient();
  const posts = await prisma.post.findMany();

  return {
    props: {
      posts,
    },
  };
}

export default IndexPage;</pre>
<p>我们可以使用以下命令通过<a href="https://www.prisma.io/docs/reference/tools-and-interfaces/prisma-cli/command-reference#studio-experimental"> Prisma Studio </a>查看我们的数据:</p>
<pre>npx prisma studio --experimental</pre>
<p>如果我们现在访问<code><a href="http://localhost:5555/" rel="nofollow">http://localhost:5555/</a></code>，我们应该能够看到工作室。</p>
<figure id="attachment_19331" aria-describedby="caption-attachment-19331" class="wp-caption aligncenter"><img data-attachment-id="19331" data-permalink="https://blog.logrocket.com/optimizing-static-pages-next-js-prisma/prisma-studio/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/05/prisma-studio.png" data-orig-size="730,355" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Prisma Studio" data-image-description="" data-image-caption="&lt;p&gt;Previewing Prisma Studio.&lt;/p&gt;&#10;" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/05/prisma-studio-300x146.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/05/prisma-studio.png" decoding="async" class="size-full wp-image-19331 jetpack-lazy-image" src="../Images/88379d9d1d4ec46fbea12559f2e1dfe4.png" alt="Prisma Studio" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2020/05/prisma-studio.png 730w, https://blog.logrocket.com/wp-content/uploads/2020/05/prisma-studio-300x146.png 300w" data-lazy-sizes="(max-width: 730px) 100vw, 730px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2020/05/prisma-studio.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/05/prisma-studio.png"/><noscript><img data-lazy-fallback="1" data-attachment-id="19331" data-permalink="https://blog.logrocket.com/optimizing-static-pages-next-js-prisma/prisma-studio/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/05/prisma-studio.png" data-orig-size="730,355" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Prisma Studio" data-image-description="" data-image-caption="&lt;p&gt;Previewing Prisma Studio.&lt;/p&gt;&#10;" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/05/prisma-studio-300x146.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/05/prisma-studio.png" decoding="async" loading="lazy" class="size-full wp-image-19331" src="../Images/88379d9d1d4ec46fbea12559f2e1dfe4.png" alt="Prisma Studio" srcset="https://blog.logrocket.com/wp-content/uploads/2020/05/prisma-studio.png 730w, https://blog.logrocket.com/wp-content/uploads/2020/05/prisma-studio-300x146.png 300w" sizes="(max-width: 730px) 100vw, 730px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/05/prisma-studio.png"/></noscript><figcaption id="caption-attachment-19331" class="wp-caption-text">Previewing Prisma Studio.</figcaption></figure>
<p>从这里，我们可以通过这个界面管理数据。</p>
<h2>什么是静态网站生成？</h2>
<p>在构建web应用程序时，我们可以选择让我们的应用程序静态生成，或者在服务器端呈现。</p>
<p>在9.3版本发布之前，任何用Next.js构建的应用都可以选择进入<a href="https://nextjs.org/blog/next-9#automatic-static-optimization">自动静态优化</a>。任何没有使用<code><a href="https://nextjs.org/docs/api-reference/data-fetching/getInitialProps">getInitialProps</a></code>的阻塞请求的页面都将被自动优化，并且该页面将被呈现为静态HTML。</p>
<p>然而，不可能为动态路由生成静态页面。有了<code><a href="https://nextjs.org/docs/basic-features/data-fetching#getstaticprops-static-generation">getStaticProps</a></code>和<code><a href="https://nextjs.org/docs/basic-features/data-fetching#getserversideprops-server-side-rendering">getServerSideProps</a></code>，现在可以用Next.js做SSG了</p>
<h2><code>getStaticProps</code></h2>
<p>如果我们导出一个名为<code>getStaticProps</code>的<code>async</code>函数，Next.js将在构建期间获取该页面的数据，并将其作为JSON存储在页面中。当我们希望在从API获取数据的同时呈现静态页面时，这很有用。</p>
<p>例如，如果我们在页面中定义了一个<code>getStaticProps</code>异步函数，它可以在构建时获取数据，并将数据作为props发送给组件。</p>
<pre>// pages/get-static-props/index.js

export async function getStaticProps() {
  const prisma = new PrismaClient();
  const posts = await prisma.post.findMany({
    include: { author: true },
  });
  return {
    props: { // This will be sent to the component as props
      posts, 
    },
  };
}</pre>
<p>在组件中，我们可以访问作为道具的<code>posts</code>数据:</p>
<pre>// pages/get-static-props/index.js

const GetStaticPropsIndexPage = ({ posts }) =&gt; {
  return (
    &lt;Stack spacing={4}&gt;
      {posts.map((post) =&gt; {
        return (
          &lt;Box key={post.id}&gt;
            &lt;Heading mb={4} size="md"&gt;
              {post.title}
            &lt;/Heading&gt;
          &lt;/Box&gt;
        );
      })}
    &lt;/Stack&gt;
  );
};</pre>
<p>以上内容将按预期呈现:</p>
<figure id="attachment_19332" aria-describedby="caption-attachment-19332" class="wp-caption aligncenter"><img data-attachment-id="19332" data-permalink="https://blog.logrocket.com/optimizing-static-pages-next-js-prisma/fetching-data-getstaticprops/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/05/fetching-data-getstaticprops.png" data-orig-size="730,354" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Fetching data using getStaticProps" data-image-description="" data-image-caption="&lt;p&gt;Fetching data using getStaticProps.&lt;/p&gt;&#10;" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/05/fetching-data-getstaticprops-300x145.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/05/fetching-data-getstaticprops.png" decoding="async" class="size-full wp-image-19332 jetpack-lazy-image" src="../Images/6aa23c23471031d56a73e600eab8eabd.png" alt="Fetching Data Using getStaticProps" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2020/05/fetching-data-getstaticprops.png 730w, https://blog.logrocket.com/wp-content/uploads/2020/05/fetching-data-getstaticprops-300x145.png 300w" data-lazy-sizes="(max-width: 730px) 100vw, 730px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2020/05/fetching-data-getstaticprops.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/05/fetching-data-getstaticprops.png"/><noscript><img data-lazy-fallback="1" data-attachment-id="19332" data-permalink="https://blog.logrocket.com/optimizing-static-pages-next-js-prisma/fetching-data-getstaticprops/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/05/fetching-data-getstaticprops.png" data-orig-size="730,354" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Fetching data using getStaticProps" data-image-description="" data-image-caption="&lt;p&gt;Fetching data using getStaticProps.&lt;/p&gt;&#10;" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/05/fetching-data-getstaticprops-300x145.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/05/fetching-data-getstaticprops.png" decoding="async" loading="lazy" class="size-full wp-image-19332" src="../Images/6aa23c23471031d56a73e600eab8eabd.png" alt="Fetching Data Using getStaticProps" srcset="https://blog.logrocket.com/wp-content/uploads/2020/05/fetching-data-getstaticprops.png 730w, https://blog.logrocket.com/wp-content/uploads/2020/05/fetching-data-getstaticprops-300x145.png 300w" sizes="(max-width: 730px) 100vw, 730px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/05/fetching-data-getstaticprops.png"/></noscript><figcaption id="caption-attachment-19332" class="wp-caption-text">Fetching data using getStaticProps.</figcaption></figure>
<p><code>getStaticProps</code>将在构建期间生成以下JSON:</p>
<figure id="attachment_19334" aria-describedby="caption-attachment-19334" class="wp-caption aligncenter"><img data-attachment-id="19334" data-permalink="https://blog.logrocket.com/optimizing-static-pages-next-js-prisma/generated-json/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/05/generated-json.png" data-orig-size="730,777" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Our generated JSON" data-image-description="" data-image-caption="&lt;p&gt;JSON generated at build time.&lt;/p&gt;&#10;" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/05/generated-json-282x300.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/05/generated-json.png" decoding="async" class="size-full wp-image-19334 jetpack-lazy-image" src="../Images/c2c87534499775efd7c1f2e0a1bace4f.png" alt="Our Generated JSON" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2020/05/generated-json.png 730w, https://blog.logrocket.com/wp-content/uploads/2020/05/generated-json-282x300.png 282w" data-lazy-sizes="(max-width: 730px) 100vw, 730px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2020/05/generated-json.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/05/generated-json.png"/><noscript><img data-lazy-fallback="1" data-attachment-id="19334" data-permalink="https://blog.logrocket.com/optimizing-static-pages-next-js-prisma/generated-json/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/05/generated-json.png" data-orig-size="730,777" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Our generated JSON" data-image-description="" data-image-caption="&lt;p&gt;JSON generated at build time.&lt;/p&gt;&#10;" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/05/generated-json-282x300.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/05/generated-json.png" decoding="async" loading="lazy" class="size-full wp-image-19334" src="../Images/c2c87534499775efd7c1f2e0a1bace4f.png" alt="Our Generated JSON" srcset="https://blog.logrocket.com/wp-content/uploads/2020/05/generated-json.png 730w, https://blog.logrocket.com/wp-content/uploads/2020/05/generated-json-282x300.png 282w" sizes="(max-width: 730px) 100vw, 730px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/05/generated-json.png"/></noscript><figcaption id="caption-attachment-19334" class="wp-caption-text">JSON generated at build time.</figcaption></figure>
<p>现在，如果我们访问<code><a href="http://localhost:3000/get-static-props/1" rel="nofollow">http://localhost:3000/get-static-props/1</a></code>，我们将看到以下页面:</p>
<figure id="attachment_19335" aria-describedby="caption-attachment-19335" class="wp-caption aligncenter"><img data-attachment-id="19335" data-permalink="https://blog.logrocket.com/optimizing-static-pages-next-js-prisma/first-post-page/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/05/first-post-page.png" data-orig-size="730,353" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="First post page" data-image-description="" data-image-caption="&lt;p&gt;Our first post page.&lt;/p&gt;&#10;" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/05/first-post-page-300x145.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/05/first-post-page.png" decoding="async" class="size-full wp-image-19335 jetpack-lazy-image" src="../Images/00f441ea7beea157ed547ac7cf1b5120.png" alt="Our First Post Page" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2020/05/first-post-page.png 730w, https://blog.logrocket.com/wp-content/uploads/2020/05/first-post-page-300x145.png 300w" data-lazy-sizes="(max-width: 730px) 100vw, 730px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2020/05/first-post-page.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/05/first-post-page.png"/><noscript><img data-lazy-fallback="1" data-attachment-id="19335" data-permalink="https://blog.logrocket.com/optimizing-static-pages-next-js-prisma/first-post-page/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2020/05/first-post-page.png" data-orig-size="730,353" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="First post page" data-image-description="" data-image-caption="&lt;p&gt;Our first post page.&lt;/p&gt;&#10;" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2020/05/first-post-page-300x145.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2020/05/first-post-page.png" decoding="async" loading="lazy" class="size-full wp-image-19335" src="../Images/00f441ea7beea157ed547ac7cf1b5120.png" alt="Our First Post Page" srcset="https://blog.logrocket.com/wp-content/uploads/2020/05/first-post-page.png 730w, https://blog.logrocket.com/wp-content/uploads/2020/05/first-post-page-300x145.png 300w" sizes="(max-width: 730px) 100vw, 730px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/05/first-post-page.png"/></noscript><figcaption id="caption-attachment-19335" class="wp-caption-text">Our first post page.</figcaption></figure>
<p>要查看这个页面，我们必须添加另一个名为<code><a href="https://nextjs.org/docs/basic-features/data-fetching#getstaticpaths-static-generation">getStaticPaths</a></code>的<code>async</code>函数:</p>
<pre>// pages/get-static-props/[postId].js

export async function getStaticProps(ctx) {
  const prisma = new PrismaClient();
  const post = await prisma.post.findOne({
    where: {
      id: parseInt(ctx.params.postId),
    },
  });
  return {
    props: {
      post,
    },
  };
}
export async function getStaticPaths() {
  return {
    paths: [{ params: { postId: "1" } }],
    fallback: false,
  };
}</pre>
<p>Next.js将在构建时使用<code>pages/get-static-props/[postId].js</code>中的页面组件静态生成<code>/1</code>。如果我们现在访问<code><a href="http://localhost:3000/get-static-props/1" rel="nofollow">http://localhost:3000/get-static-props/1</a></code>并刷新页面，我们就能够查看页面。然而，如果我们对<code><a href="http://localhost:3000/get-static-props/2" rel="nofollow">http://localhost:3000/get-static-props/2</a></code>做同样的事情，我们会得到404。</p>
<p>为了解决这个问题，我们需要将postId <code>2</code>也添加到<code>paths</code>数组中:</p>
<pre>paths: [{ params: { postId: "1" } }, { params: { postId: "2" } }],</pre>
<p>现在，<code><a href="http://localhost:3000/get-static-props/2" rel="nofollow">http://localhost:3000/get-static-props/2</a></code>页面可以正常加载了。</p>
<h2><code>getServerSideProps</code></h2>
<p>如果我们在页面中导出一个名为<code>getServerSideProps</code>的<code>async</code>函数，Next.js将使用<code>getServerSideProps</code>返回的数据在每次请求时预渲染页面。<code>getServerSideProps</code>每次我们加载页面时都会被调用，但是代码只在服务器上执行，不像<code>getInitialProps</code>。</p>
<pre>// pages/get-server-side-props/index.js

export async function getServerSideProps() {
  const prisma = new PrismaClient();
  const posts = await prisma.post.findMany();
  return {
    props: {
      posts,
    },
  };
}</pre>
<p>我们也可以在http://localhost:3000/get-server-side-props/1获取单个帖子:</p>
<pre>// pages/get-server-side-props/index.js

export async function getServerSideProps(ctx) {
  const prisma = new PrismaClient();
  const post = await prisma.post.findOne({
    where: {
      id: parseInt(ctx.params.postId),
    },
  });
  return {
    props: {
      post,
    },
  };
}</pre>
<h2>结论</h2>
<p>在这篇文章中，我们学习了如何使用像<code>getStaticProps</code>、<code>getServerSideProps</code>和Prisma这样的高级特性使我们的Next.js应用程序更快。到目前为止，我们一直使用<code>getInitialProps</code>，这将使页面预渲染。但是，任何后续的页面重定向都将在客户端获取新数据。</p>
<p>有了<code>getServerSideProps</code>，每次数据都会在服务器上提取，甚至在页面重定向上。使用<code>getStaticProps</code>，在构建时获取数据；不会在客户端调用。因此，SSG页面变得非常快。</p><div class="code-block code-block-30">
<div class="blog-plug inline-plug next-plug"><h2><a href="https://lp.logrocket.com/blg/nextjs-signup" target="_blank"> LogRocket </a>:全面了解生产Next.js应用</h2><p>调试下一个应用程序可能会很困难，尤其是当用户遇到难以重现的问题时。如果您对监视和跟踪状态、自动显示JavaScript错误、跟踪缓慢的网络请求和组件加载时间感兴趣，</p><a href="https://lp.logrocket.com/blg/nextjs-signup" target="_blank">try LogRocket</a><p>. </p><a class="signup" href="https://lp.logrocket.com/blg/nextjs-signup" target="_blank" rel="noopener noreferrer"><img class="alignnone size-full wp-image-46 jetpack-lazy-image" src="../Images/f300c244a1a1cf916df8b4cb02bec6c6.png" data-lazy-src="https://files.readme.io/27c94e7-Image_2017-06-05_at_9.46.04_PM.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://files.readme.io/27c94e7-Image_2017-06-05_at_9.46.04_PM.png"/><noscript><img data-lazy-fallback="1" class="alignnone size-full wp-image-46" src="../Images/f300c244a1a1cf916df8b4cb02bec6c6.png" data-original-src="https://files.readme.io/27c94e7-Image_2017-06-05_at_9.46.04_PM.png"/></noscript></a><a class="signup" href="https://lp.logrocket.com/blg/nextjs-signup" target="_blank" rel="noopener noreferrer"><img class="alignnone size-full wp-image-46 jetpack-lazy-image" src="../Images/d6f5a5dd739296c1dd7aab3d5e77eeb9.png" alt="LogRocket Dashboard Free Trial Banner" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2017/03/1d0cd-1s_rmyo6nbrasp-xtvbaxfg.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2017/03/1d0cd-1s_rmyo6nbrasp-xtvbaxfg.png"/><noscript><img data-lazy-fallback="1" class="alignnone size-full wp-image-46" src="../Images/d6f5a5dd739296c1dd7aab3d5e77eeb9.png" alt="LogRocket Dashboard Free Trial Banner" data-original-src="https://blog.logrocket.com/wp-content/uploads/2017/03/1d0cd-1s_rmyo6nbrasp-xtvbaxfg.png"/></noscript></a><p>LogRocket 就像是网络和移动应用的DVR，记录下你的Next.js应用上发生的一切。您可以汇总并报告问题发生时应用程序的状态，而不是猜测问题发生的原因。LogRocket还可以监控应用程序的性能，报告客户端CPU负载、客户端内存使用等指标。</p><p>LogRocket Redux中间件包为您的用户会话增加了一层额外的可见性。LogRocket记录Redux存储中的所有操作和状态。</p><p>让您调试Next.js应用的方式现代化— <a class="signup" href="https://lp.logrocket.com/blg/nextjs-signup" target="_blank" rel="noopener noreferrer">开始免费监控</a>。</p></div></div>

<p class="clearfix"/>
<p class="clearfix"/>
</article>

</div>    
</body>
</html>