<html>
<head>
<title>Using Codemod to upgrade your React version - LogRocket Blog</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>使用Codemod升级你的React版本</h1>
<blockquote>原文：<a href="https://blog.logrocket.com/how-to-use-codemod-to-upgrade-your-react-version/#0001-01-01">https://blog.logrocket.com/how-to-use-codemod-to-upgrade-your-react-version/#0001-01-01</a></blockquote><div><article class="article-post">
<p>重构大规模的代码库可能是混乱的、昂贵的和乏味的，这就是为什么许多工程团队认为根本不值得做，尤其是在处理一个不受欢迎但仍然“有效”的模式时</p>
<p>例如，一个不受欢迎的模式可能是您编写的一个函数，它最好被拆分成多个方法，一个带有几个可选参数的函数更容易使用，或者一个应该返回包含更多信息的结构而不是当前的布尔值的函数。</p>
<h2>codedom简介</h2>
<p>进入<a href="https://github.com/facebook/codemod" target="_blank" rel="noopener noreferrer"> Codemod </a>，这是一个为协助大规模代码库重构而构建的Python工具。它甚至可以部分自动化该过程，尽管人工监督和偶尔的手动干预仍然是必要的。</p>
<p>它由脸书的开发人员构建，作为开源软件发布，任何人都可以用它来以理智和系统的方式对成熟的代码库进行彻底的改变。</p>
<p>您可以使用您喜欢的Python包管理器安装Codemod，如下所示:</p>
<pre>pip install codemod
</pre>
<p>您还可以使用sudo在系统范围内安装该软件包:</p>
<pre>sudo -H pip install codemod
</pre>
<p>让我们用一个简单的例子来演示Codemod的用处。假设我们不想使用<code>&lt;font&gt;</code>标签。我们将启动命令行并运行以下命令:</p>
<pre>codemod -m -d /Users/janedoe/reponame --extensions php,html \ 
'&lt;font color="?(.?)"?&gt;(.*?)&lt;/font&gt;' \ 
'&lt;span style="color: \1;"&gt;\2&lt;/span&gt;'</pre>
<p>对于每个正则表达式匹配，一个彩色的diff将显示在终端上。然后会提示您接受更改(也就是说，用一个<code>&lt;span&gt;</code>标记替换那个<code>&lt;font&gt;</code>标记的实例)，拒绝它，或者在编辑器中编辑给定的行。</p>
<p>这样，使用Codemod重构代码库就像在您最喜欢的文字处理器中执行查找和替换一样。</p>
<h2>案例研究:使用Codemod升级到较新的React版本</h2>
<p>让我们假设你和你的工程师团队已经使用React构建了一个产品的前端。它工作得很好，运行得很平稳，并且涉众希望当前的产品保持原样，没有任何重大的中断。</p>
<p>当您开始构建该产品时，React的最新版本是16.5。但是现在您已经了解了<a href="https://reactjs.org/docs/concurrent-mode-suspense.html">悬念</a>，这是一个简洁的组件，允许您“等待”一些特定的代码——包括数据、图像、脚本和其他异步加载的元素——来加载，同时，指定要显示的加载状态(例如，微调器或屏幕上的一些文本)。</p>
<p>这里有一个简单的例子来展示一个悬念用例:</p>
<pre>const demoPage = React.lazy(() =&gt; import('./demoPage'));
// Display a spinner while the page is loading 
&lt;Suspense fallback={&lt;Spinner /&gt;}&gt; &lt;DemoPage /&gt; &lt;/Suspense&gt;</pre>
<p>问题是，悬念只在React版本及更高版本中可用，而您的整个产品都是基于16.5版本构建的。更不用说，如果你用一个更新来打破一切，你的产品所有者和其他利益相关者将会非常愤怒。</p>
<p>所以，情况是没有希望的。你注定要永远使用旧版本，直到React发展到别无选择，只能彻底改造，投入时间和大量资源进行重构，对吗？</p>
<p>不对。我们可以使用Codemod来促进无痛升级，同时仍然保持关注和监督变化。</p>
<h3>安装<a href="https://github.com/facebook/jscodeshift" target="_blank" rel="noopener noreferrer"> jscodeshift </a>和React-Codemod</h3>
<p>脸书提供了多个Codemod脚本，开发者可以用它们来启动重构。</p>
<h3>将React升级到版本16.9</h3>
<p>首先，运行以下命令:</p>
<pre>npm install --save <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="d6a4b3b7b5a296bab7a2b3a5a2">[email protected]</a>
</pre>
<p>或者，您也可以使用纱线:</p>
<pre>yarn upgrade <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="562433373522163a3722332522">[email protected]</a>
</pre>
<p>太好了！我们现在已经安装了React 16.9，可以充分利用悬念。</p>
<p>然而，尽管React 16.9不包括任何重大更改，但有几个不安全的生命周期方法被重命名:</p>
<ul>
<li><code>componentWillMount</code> → <code>UNSAFE_componentWillMount</code></li>
<li><code>componentWillReceiveProps</code> → <code>UNSAFE_componentWillReceiveProps</code></li>
<li><code>componentWillUpdate</code> → <code>UNSAFE_componentWillUpdate</code></li>
</ul>
<p>那现在怎么办？</p>
<h3>安装React-Codemod</h3>
<p>运行以下命令:</p>
<pre>npm i react-codemod</pre>
<p>这将安装React-Codemod，这是一个Codemod脚本集合，用于专门为更新React APIs而创建的jscodeshift。一旦你安装了它，你可以使用各种脸书提供的脚本来帮助你运行干净的重构。</p>
<p>如果您的应用程序使用许多不安全的生命周期方法，您可以使用这个<a href="https://github.com/reactjs/react-codemod"> Codemod </a>进行快速方便的重构，而不是费力地手动编辑它们以匹配新名称:</p>
<pre>cd your_app_respository
npx react-codemod rename-unsafe-lifecycles</pre>
<p>上面将会启动一个交互式提示，您可以使用它来查找并替换所有出现的旧的生命周期方法命名约定。</p>
<h2>jscodeshift快速介绍</h2>
<p>没有对jscodeshift的介绍，关于React-Codemod的讨论是不完整的。虽然我们不必使用jscodeshift来升级到React 16.9，但在使用React Codemod脚本和一般JavaScript时，它是一个重要的工具包。该工具通过在多个JavaScript(或TypeScript)文件上运行Codemod来工作。</p>
<p>然而，jscodeshift远远超出了通常的查找并替换Codemod脚本，使开发人员能够对代码库进行自动的重大更新。更新可以包括改变函数签名，然后在每个被调用的函数实例中重写代码。</p>
<p>您可以通过在命令行上运行以下命令来安装jscodeshift:</p>
<pre>npm install -g jscodeshift
</pre>
<p>下面的例子是一个简单的用例，用“bar”替换所有出现的变量“foo”</p><div class="code-block code-block-54">
<hr/>
<h3>更多来自LogRocket的精彩文章:</h3>

<hr/></div>
<pre>/**
 * Using jscodeshift to replace all occurrences of variable "foo" with "bar"
 */
module.exports = function(file, api) {
  return api
    .jscodeshift(file.source)
    .findVariableDeclarators("foo")
    .renameTo("bar")
    .toSource();
};</pre>
<h2>结论</h2>
<p>React是一个快速发展的库，对于开发团队来说，在保持产品和代码库完整性的同时保持更新是至关重要的。在本文中，我们探索了Codemod，这是一个Python工具，它的脚本提供了一种交互式方法来重构和升级大型代码库。</p>
<p>我们还回顾了React-Codemod，这是一个npm包，包含专门用于升级React APIs的脚本。最后，我们介绍了jscodeshift，这是一个基于Codemod的工具包，具有更强大的自动化功能。</p>
<p>通过利用这些额外的工具，您可以使重构代码和React版本升级变得简单而轻松，使您的团队能够享受前沿的更新，而不会损害您的代码库或降低开发速度。</p><div class="code-block code-block-17">
<div class="blog-plug inline-plug react-plug" vwo-el-id="26283398190">
<h2 vwo-el-id="41600691720">使用LogRocket消除传统反应错误报告的噪音</h2>
<a href="https://lp.logrocket.com/blg/react-signup-issue-free" target="_blank" vwo-el-id="19356441070">LogRocket
</a><p>是一款React analytics解决方案，可保护您免受数百个误报错误警报的影响，只针对少数真正重要的项目。LogRocket告诉您React应用程序中实际影响用户的最具影响力的bug和UX问题。</p><a class="signup" href="https://lp.logrocket.com/blg/react-signup-general" target="_blank" rel="noopener noreferrer" vwo-el-id="19356441380">
<img class="first-react-image alignnone size-full wp-image-46 jetpack-lazy-image jetpack-lazy-image--handled" src="../Images/f300c244a1a1cf916df8b4cb02bec6c6.png" vwo-el-id="18272717540" data-lazy-loaded="1" data-original-src="https://files.readme.io/27c94e7-Image_2017-06-05_at_9.46.04_PM.png"/>
</a>
<a class="signup" href="https://lp.logrocket.com/blg/react-signup-general" target="_blank" rel="noopener noreferrer" vwo-el-id="19356441690">
<img class="second-react-image alignnone size-full wp-image-46 jetpack-lazy-image jetpack-lazy-image--handled" src="../Images/d6f5a5dd739296c1dd7aab3d5e77eeb9.png" alt="LogRocket Dashboard Free Trial Banner" vwo-el-id="30720362350" data-lazy-loaded="1" data-original-src="https://blog.logrocket.com/wp-content/uploads/2017/03/1d0cd-1s_rmyo6nbrasp-xtvbaxfg.png"/>
</a>
<a href="https://lp.logrocket.com/blg/react-signup-issue-free" target="_blank" rel="noopener noreferrer" vwo-el-id="35866400580">LogRocket
</a><p>自动聚合客户端错误、反应错误边界、还原状态、缓慢的组件加载时间、JS异常、前端性能指标和用户交互。然后，LogRocket使用机器学习来通知您影响大多数用户的最具影响力的问题，并提供您修复它所需的上下文。</p><p vwo-el-id="28675661060">关注重要的React bug—<a class="signup" href="https://lp.logrocket.com/blg/react-signup-issue-free" target="_blank" rel="noopener noreferrer" vwo-el-id="40093418840">今天就试试LogRocket】。</a></p>
</div></div>

<p class="clearfix"/>
<p class="clearfix"/>
</article>

</div>    
</body>
</html>