<html>
<head>
<title>End-to-end testing in NestJS with TypeORM </title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>使用TypeORM在NestJS中进行端到端测试</h1>
<blockquote>原文：<a href="https://blog.logrocket.com/end-end-testing-nestjs-typeorm/#0001-01-01">https://blog.logrocket.com/end-end-testing-nestjs-typeorm/#0001-01-01</a></blockquote><div><article class="article-post">
<p>质量保证策略是软件开发的一个关键方面。高端测试，比如单元测试和端到端测试，是QA策略的重要方面。</p>
<p>在这篇文章中，我们的重点将是在<a href="https://nestjs.com/" rel="noopener"> NestJS </a>中创建端到端测试。NestJS自带Jest和Supertest来创建单元测试。我们将探索测试驱动开发和开发单元测试背后的思维过程。</p>
<p>我们将使用单元测试来指导API中产品创建特性的开发，而端到端测试将模拟应用程序的最终用户。在我们的应用程序中，TypeORM 和<a href="https://www.postgresql.org/" rel="noopener"> PostgreSQL </a>提供了数据库连接。</p>
<p>NestJS为构建服务器端应用程序提供了一个框架。NestJS依赖于TypeScript和依赖注入，使开发人员能够编写测试。NestJS CLI scaffolds项目支持创建控制器和服务，并在创建服务器或控制器时生成测试文件。</p>
<p><em>向前跳转:</em></p>

<h2 id="what-test-driven-development">什么是测试驱动开发？</h2>
<p>测试驱动开发(TDD)使开发人员能够在测试的指导下构建软件。这使得快速测试、编码和重构成为可能。Kent Beck 在20世纪90年代晚期开发了TDD。</p>
<p>遵循测试驱动开发有三个简单的规则:</p>
<ol>
<li>为下一个功能编写一个测试</li>
<li>在测试通过之前，代码必须是有效的</li>
<li>重构对于确保新旧代码结构良好至关重要</li>
</ol>
<p>实践时，测试驱动开发提供了很大的优势。使用TDD的开发人员必须对代码的接口建模，这使得接口与实现分离。测试是从类的公共接口的角度创建的，这意味着关键的焦点是类的行为而不是实现。</p>
<p>在生产管道中，这些测试几乎在每个构建上运行，确保代码的行为。如果一个团队成员对代码进行了修改，从而改变了行为，那么测试就会失败，发出出错的信号。这节省了调试时间。</p>
<p>下图强调了测试驱动开发背后的理念:</p>
<p><img data-attachment-id="138584" data-permalink="https://blog.logrocket.com/end-end-testing-nestjs-typeorm/attachment/tdd-cycle/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/10/tdd-cycle.png" data-orig-size="730,1290" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="tdd-cycle" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/10/tdd-cycle-170x300.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/10/tdd-cycle-579x1024.png" decoding="async" class="aligncenter wp-image-138584 size-full jetpack-lazy-image" src="../Images/e661483797934202e0e5d05af60bca0b.png" alt="The TDD cycle" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2022/10/tdd-cycle.png 730w, https://blog.logrocket.com/wp-content/uploads/2022/10/tdd-cycle-170x300.png 170w, https://blog.logrocket.com/wp-content/uploads/2022/10/tdd-cycle-579x1024.png 579w" data-lazy-sizes="(max-width: 730px) 100vw, 730px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2022/10/tdd-cycle.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/10/tdd-cycle.png"/></p><noscript><img data-lazy-fallback="1" data-attachment-id="138584" data-permalink="https://blog.logrocket.com/end-end-testing-nestjs-typeorm/attachment/tdd-cycle/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/10/tdd-cycle.png" data-orig-size="730,1290" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="tdd-cycle" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/10/tdd-cycle-170x300.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/10/tdd-cycle-579x1024.png" decoding="async" loading="lazy" class="aligncenter wp-image-138584 size-full" src="../Images/e661483797934202e0e5d05af60bca0b.png" alt="The TDD cycle" srcset="https://blog.logrocket.com/wp-content/uploads/2022/10/tdd-cycle.png 730w, https://blog.logrocket.com/wp-content/uploads/2022/10/tdd-cycle-170x300.png 170w, https://blog.logrocket.com/wp-content/uploads/2022/10/tdd-cycle-579x1024.png 579w" sizes="(max-width: 730px) 100vw, 730px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/10/tdd-cycle.png"/></noscript>
<p>要使用TDD，“红”、“绿”和“重构”循环是强制性的。该循环将一直运行，直到新特性准备好并且所有测试都通过。</p>
<p>让我们探索TDD方法背后的步骤。</p>
<h2 id="test-driven-development-steps">测试驱动的开发步骤</h2>
<h3 id="think">1.想</h3>
<p>TDD的要点是创建小的测试并编写迫使测试通过的代码。迭代过程一直持续到特征完成。在“思考”步骤中，重要的是想象并注意代码应该表现出什么行为。需要最少代码行的最小增量是关键——您可以创建一个小的测试单元，直到行为以这种方式出现。</p>
<h3 id="red-bar">2.红色酒吧</h3>
<p>在红色条中，存在的单元测试应该覆盖行为的当前增量。测试可以包含尚不存在的方法和类名。类接口的设计是从类用户的角度创建的。</p>
<p>一旦测试就绪，并且您运行了整个套件，新的测试应该会失败。在大多数TDD测试工具中，失败的测试会产生一个红条，在这里我们可以深入了解失败的原因。</p>
<h3 id="green-bar">3.绿色条</h3>
<p>在这一步中，我们将重点放在编写生产就绪代码以通过测试。一旦测试运行，我们的结果应该是一个绿色的进度条，这取决于正在使用的TDD测试工具。绿条步骤提供了另一个机会来对照现实检查我们的意图。</p>
<h2 id="creating-application">创建我们的应用程序</h2>
<p>用<a href="https://docs.nestjs.com/cli/overview" rel="noopener"> NestJS CLI </a>创建一个NestJS项目。我们将创建一个产品管理应用程序。</p>
<h3 id="prerequisites">先决条件</h3>
<ul>
<li>npm :用于向公共npm注册中心发布和安装软件包</li>
<li><a href="https://nodejs.org/en/" rel="noopener"> Node.js </a> v ≥ 12，v 13除外</li>
</ul>
<h3 id="install-nest-js-cli">安装NestJS CLI</h3>
<p>运行以下命令安装NestJS CLI:</p>
<pre class="language-bash hljs">$ npm install -g @nestjs/cli</pre>
<h3 id="creating-unit-tests">创建我们的单元测试</h3>
<p>我们将要测试的代码库可以在GitHub库中找到。克隆并导航到项目的根目录。</p>
<p>根据包管理器，运行以下命令。</p>
<p>对于纱线:</p>
<pre class="language-bash hljs">$ yarn</pre>
<p>对于国家预防机制:</p>
<pre class="language-bash hljs">$ npm install</pre>
<p>安装完依赖项后，使用下面的命令启动项目。</p>
<pre class="language-bash hljs">$ yarn start:dev</pre>
<p>如果没有依赖问题或错误，项目应该在终端中开始:</p>
<p><img data-attachment-id="138587" data-permalink="https://blog.logrocket.com/end-end-testing-nestjs-typeorm/attachment/project-terminal/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/10/project-terminal.png" data-orig-size="730,204" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="project-terminal" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/10/project-terminal-300x84.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/10/project-terminal.png" decoding="async" class="aligncenter wp-image-138587 size-full jetpack-lazy-image" src="../Images/af788f999133bb8a7b331b7a8c8b76ce.png" alt="Project starting in the terminal" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2022/10/project-terminal.png 730w, https://blog.logrocket.com/wp-content/uploads/2022/10/project-terminal-300x84.png 300w" data-lazy-sizes="(max-width: 730px) 100vw, 730px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2022/10/project-terminal.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/10/project-terminal.png"/></p><noscript><img data-lazy-fallback="1" data-attachment-id="138587" data-permalink="https://blog.logrocket.com/end-end-testing-nestjs-typeorm/attachment/project-terminal/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/10/project-terminal.png" data-orig-size="730,204" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="project-terminal" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/10/project-terminal-300x84.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/10/project-terminal.png" decoding="async" loading="lazy" class="aligncenter wp-image-138587 size-full" src="../Images/af788f999133bb8a7b331b7a8c8b76ce.png" alt="Project starting in the terminal" srcset="https://blog.logrocket.com/wp-content/uploads/2022/10/project-terminal.png 730w, https://blog.logrocket.com/wp-content/uploads/2022/10/project-terminal-300x84.png 300w" sizes="(max-width: 730px) 100vw, 730px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/10/project-terminal.png"/></noscript>
<h2 id="developing-product-api-tdd">用TDD开发我们的产品API</h2>
<p>产品控制器处理产品的创建并检索产品。</p>
<p>使用终端，使用CLI工具创建产品控制器和服务。控制器和服务现在可以使用测试文件了。</p>
<pre class="language-bash hljs">$ nest g controller product
$ nest g service product</pre>
<p>当使用Nest CLI创建控制器和服务时，会创建一个附带的测试文件:</p>
<p><img data-attachment-id="138590" data-permalink="https://blog.logrocket.com/end-end-testing-nestjs-typeorm/attachment/test-file/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/10/test-file.png" data-orig-size="730,727" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="test-file" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/10/test-file-300x300.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/10/test-file.png" decoding="async" class="aligncenter wp-image-138590 size-full jetpack-lazy-image" src="../Images/fc58177df7792314076830f84823bd50.png" alt="Accompanying test file" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2022/10/test-file.png 730w, https://blog.logrocket.com/wp-content/uploads/2022/10/test-file-300x300.png 300w, https://blog.logrocket.com/wp-content/uploads/2022/10/test-file-150x150.png?crop=1 150w" data-lazy-sizes="(max-width: 730px) 100vw, 730px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2022/10/test-file.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/10/test-file.png"/></p><noscript><img data-lazy-fallback="1" data-attachment-id="138590" data-permalink="https://blog.logrocket.com/end-end-testing-nestjs-typeorm/attachment/test-file/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/10/test-file.png" data-orig-size="730,727" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="test-file" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/10/test-file-300x300.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/10/test-file.png" decoding="async" loading="lazy" class="aligncenter wp-image-138590 size-full" src="../Images/fc58177df7792314076830f84823bd50.png" alt="Accompanying test file" srcset="https://blog.logrocket.com/wp-content/uploads/2022/10/test-file.png 730w, https://blog.logrocket.com/wp-content/uploads/2022/10/test-file-300x300.png 300w, https://blog.logrocket.com/wp-content/uploads/2022/10/test-file-150x150.png?crop=1 150w" sizes="(max-width: 730px) 100vw, 730px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/10/test-file.png"/></noscript>
<p>我们希望产品控制者的第一个行为是创造新产品的能力。为了考虑产品表中的数据结构，让我们创建一个产品接口和实体对象。</p>
<p>在终端窗口中写入以下内容:</p>
<pre class="language-bash hljs">$ mkdir src/product/models
$ touch src/product/models/product.interface.ts
$ touch src/product/models/product.entity.ts
$ code src/product/models/product.entity.ts</pre>
<p>最后一个脚本在代码编辑器中打开<code>product.entity.ts</code>文件。将以下代码复制并粘贴到文件中:</p>
<pre class="language-typescript hljs">import {
  Column,
  CreateDateColumn,
  Entity,
  ManyToOne,
  PrimaryGeneratedColumn,
} from "typeorm";
import { UserEntity } from "../../auth/models/user.entity";

@Entity("product")
export class ProductEntity {
  @PrimaryGeneratedColumn()
  id: number;

  @Column({ default: "" })
  body: string;

  @CreateDateColumn()
  createdAt: Date;

  @ManyToOne(() =&gt; UserEntity, (userEntity) =&gt; userEntity.products)
  creator: UserEntity;
}
</pre>
<p>用下面的命令在代码编辑器中打开<code>product.entity.ts</code>文件:</p>
<pre class="language-bash hljs">$ code src/product/models/product.interface.ts</pre>
<p>将下面的代码块粘贴到<code>product.interface.ts</code>文件中:</p>
<pre class="language-typescript hljs">import { User } from "src/auth/models/user.class";

export interface Product {
  id?: number;
  body?: string;
  createdAt: Date;
  creator?: User;
}
</pre>
<h3 id="create-product-feature">创建产品特征</h3>
<p>在我们创建产品创建路线之前，需要有一个单元测试。这个单元测试确认了函数的实现。</p>
<p>在终端窗口中，运行以下命令，在代码编辑器中打开测试文件:</p>
<pre class="language-bash hljs">$ code src/product/controllers/product.controller.spec.ts</pre>
<p>我们的第一个测试需要确认产品创建服务创建了一个产品。测试模拟<code>UserService</code>和<code>ProductService</code>。Jest创建了服务中函数实现的模拟。</p>
<p>在<code>product.controller.spec.ts</code>中实现的<code>describe</code>块可用。打造产品服务的<code>mockImplementation</code>；这是<code>createProduct</code>实现的宿主。这个<code>createProduct</code>方法接受一个请求并返回一个创建的产品和ID。</p><div class="code-block code-block-54">
<hr/>
<h3>更多来自LogRocket的精彩文章:</h3>

<hr/></div>
<p>为了帮助模仿HTTP对象，我们将使用<code><a href="https://www.npmjs.com/package/node-mocks-http" rel="noopener">node-mocks-http library</a></code>。将以下代码添加到我们的<code>product.controller.spec.ts</code>文件中:</p>
<pre class="language-typescript hljs">import { Test, TestingModule } from "@nestjs/testing";
import { DeleteResult, UpdateResult } from "typeorm";
import { User } from "../../auth/models/user.class";
import { JwtGuard } from "../../auth/guards/jwt.guard";
import { UserService } from "../../auth/services/user.service";
import { ProductController } from "./product.controller";
import { ProductService } from "../services/product.service";
import { Product } from "../models/product.interface";

const httpMocks = require("node-mocks-http");

describe("ProductController", () =&gt; {
  let productController: ProductController;

  const mockRequest = httpMocks.createRequest();
  mockRequest.user = new User();
  mockRequest.user = "DUE";

 const mockProduct: Product = {
    body: "nivea",
    createdAt: new Date(),
    creator: mockRequest.user,
  };

  const mockProductService = {
    createProduct: jest
      .fn()
      .mockImplementation((user: User, product: Product) =&gt; {
        return {
          id: 1,
          ...product,
        };
      })
  };
  const mockUserService = {};

  // create fake module
  beforeEach(async () =&gt; {
    const moduleRef: TestingModule = await Test.createTestingModule({
      controllers: [ProductController],
      providers: [
        ProductService,
        { provide: UserService, useValue: mockUserService },
        {
          provide: JwtGuard,
          useValue: jest.fn().mockImplementation(() =&gt; true),
        },
      ],
    })
      .overrideProvider(ProductService)
      .useValue(mockProductService)
      .compile();

    productController = moduleRef.get&lt;ProductController&gt;(ProductController);
  });
});
</pre>
<p>为了结束单元测试，需要设置动作及其响应。将以下代码粘贴在<code>describe</code>函数的末尾。</p>
<pre class="language-typescript hljs"> it("should create a product", () =&gt; {
    expect(productController.create(mockProduct, mockRequest)).toEqual({
      id: expect.any(Number),
      ...mockProduct,
    });
  });
</pre>
<p>在<code>product.controller.ts</code>文件中，设置<code>create</code>方法。导入依赖项、产品界面和产品实体。</p>
<pre class="language-typescript hljs">import { Body, Controller, Post, Request, UseGuards } from "@nestjs/common";
import { Observable } from "rxjs";

import { JwtGuard } from "../auth/guards/jwt.guard";
import { Product } from "../product/models/product.interface";
import { ProductService } from "../product/services/product.service";

@Controller("product")
export class ProductController {
  constructor(private productService: ProductService) {}
  @UseGuards(JwtGuard)
  @Post()
  create(@Body() product: Product, @Request() req): Observable&lt;Product&gt; {
    return this.productService.createProduct(req.user, product);
  }
}
</pre>
<h3 id="run-first-unit-test">运行第一个单元测试</h3>
<p>在新的终端窗口中，使用以下命令运行创建的测试:</p>
<pre class="language-bash hljs">$ yarn test product.controller</pre>
<p>测试应该会失败，因为实现还没有完成。这为我们如何利用TDD来改进我们的开发和捕获bug提供了洞察力。我们的测试失败了，因为这个方法不在<code>product.service.ts</code>文件中。</p>
<p><img data-attachment-id="138593" data-permalink="https://blog.logrocket.com/end-end-testing-nestjs-typeorm/attachment/failing-test-2/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/10/failing-test.png" data-orig-size="730,106" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="failing-test" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/10/failing-test-300x44.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/10/failing-test.png" decoding="async" class="aligncenter wp-image-138593 size-full jetpack-lazy-image" src="../Images/2169599dac54cb37142ebef89d031d48.png" alt="Failing test" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2022/10/failing-test.png 730w, https://blog.logrocket.com/wp-content/uploads/2022/10/failing-test-300x44.png 300w" data-lazy-sizes="(max-width: 730px) 100vw, 730px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2022/10/failing-test.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/10/failing-test.png"/></p><noscript><img data-lazy-fallback="1" data-attachment-id="138593" data-permalink="https://blog.logrocket.com/end-end-testing-nestjs-typeorm/attachment/failing-test-2/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/10/failing-test.png" data-orig-size="730,106" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="failing-test" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/10/failing-test-300x44.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/10/failing-test.png" decoding="async" loading="lazy" class="aligncenter wp-image-138593 size-full" src="../Images/2169599dac54cb37142ebef89d031d48.png" alt="Failing test" srcset="https://blog.logrocket.com/wp-content/uploads/2022/10/failing-test.png 730w, https://blog.logrocket.com/wp-content/uploads/2022/10/failing-test-300x44.png 300w" sizes="(max-width: 730px) 100vw, 730px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/10/failing-test.png"/></noscript>
<p>在终端窗口中，打开<code>product.service.ts</code>文件并粘贴下面的代码块:</p>
<pre class="language-typescript hljs">import { Inject, Injectable } from "@nestjs/common";
import { InjectRepository } from "@nestjs/typeorm";
import { from, Observable } from "rxjs";
import { DeleteResult, Repository, UpdateResult } from "typeorm";

import { User } from "src/auth/models/user.class";
import { ProductEntity } from "../models/product.entity";
import { Product } from "../models/product.interface";

@Injectable()
export class ProductService {
  constructor(
    @InjectRepository(ProductEntity)
    private readonly productRepository: Repository&lt;ProductEntity&gt;
  ) {}

  createProduct(user: User, product: Product): Observable&lt;Product&gt; {
    product.creator = user;
    return from(this.productRepository.save(product));
  }
}
</pre>
<p>在终端窗口中，使用以下命令重新运行<code>product.controller</code>测试:</p>
<pre class="language-bash hljs">$ yarn test product.controller</pre>
<p>通过在我们的服务类中添加<code>createProduct</code>方法来解决这个问题。</p>
<p><img data-attachment-id="138597" data-permalink="https://blog.logrocket.com/end-end-testing-nestjs-typeorm/attachment/fixing-issue/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/10/fixing-issue.png" data-orig-size="730,205" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="fixing-issue" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/10/fixing-issue-300x84.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/10/fixing-issue.png" decoding="async" class="aligncenter wp-image-138597 size-full jetpack-lazy-image" src="../Images/300923f6278345405a8c2593e1349f93.png" alt="Fixing the issue" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2022/10/fixing-issue.png 730w, https://blog.logrocket.com/wp-content/uploads/2022/10/fixing-issue-300x84.png 300w" data-lazy-sizes="(max-width: 730px) 100vw, 730px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2022/10/fixing-issue.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/10/fixing-issue.png"/></p><noscript><img data-lazy-fallback="1" data-attachment-id="138597" data-permalink="https://blog.logrocket.com/end-end-testing-nestjs-typeorm/attachment/fixing-issue/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/10/fixing-issue.png" data-orig-size="730,205" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="fixing-issue" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/10/fixing-issue-300x84.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/10/fixing-issue.png" decoding="async" loading="lazy" class="aligncenter wp-image-138597 size-full" src="../Images/300923f6278345405a8c2593e1349f93.png" alt="Fixing the issue" srcset="https://blog.logrocket.com/wp-content/uploads/2022/10/fixing-issue.png 730w, https://blog.logrocket.com/wp-content/uploads/2022/10/fixing-issue-300x84.png 300w" sizes="(max-width: 730px) 100vw, 730px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/10/fixing-issue.png"/></noscript>
<p>这个周期对于开发应用程序中的新功能来说更长。这个循环保证了创建的方法是经过深思熟虑的。</p>
<h3 id="creating-create-product-feature-nest-js-application">使用NestJS应用程序创建创建产品功能</h3>
<p>Create Product route有一个用于保护的AuthGuard，因此为了测试它，我们需要创建一个用户和登录凭证。登录后，令牌会对创建产品的用户进行身份验证。</p>
<p>下面的截图显示了如何注册和登录用户。</p>
<p><img data-attachment-id="138601" data-permalink="https://blog.logrocket.com/end-end-testing-nestjs-typeorm/attachment/register-login-user/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/10/register-login-user.png" data-orig-size="730,473" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="register-login-user" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/10/register-login-user-300x194.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/10/register-login-user.png" decoding="async" class="aligncenter wp-image-138601 size-full jetpack-lazy-image" src="../Images/d7d17520ccafafb13b6db38cb8388726.png" alt="Register and login a user" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2022/10/register-login-user.png 730w, https://blog.logrocket.com/wp-content/uploads/2022/10/register-login-user-300x194.png 300w" data-lazy-sizes="(max-width: 730px) 100vw, 730px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2022/10/register-login-user.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/10/register-login-user.png"/></p><noscript><img data-lazy-fallback="1" data-attachment-id="138601" data-permalink="https://blog.logrocket.com/end-end-testing-nestjs-typeorm/attachment/register-login-user/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/10/register-login-user.png" data-orig-size="730,473" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="register-login-user" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/10/register-login-user-300x194.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/10/register-login-user.png" decoding="async" loading="lazy" class="aligncenter wp-image-138601 size-full" src="../Images/d7d17520ccafafb13b6db38cb8388726.png" alt="Register and login a user" srcset="https://blog.logrocket.com/wp-content/uploads/2022/10/register-login-user.png 730w, https://blog.logrocket.com/wp-content/uploads/2022/10/register-login-user-300x194.png 300w" sizes="(max-width: 730px) 100vw, 730px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/10/register-login-user.png"/></noscript>
<p>如何注册用户:</p>
<p><img data-attachment-id="138603" data-permalink="https://blog.logrocket.com/end-end-testing-nestjs-typeorm/attachment/how-register-user/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/10/how-register-user.png" data-orig-size="730,411" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="how-register-user" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/10/how-register-user-300x169.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/10/how-register-user.png" decoding="async" class="aligncenter wp-image-138603 size-full jetpack-lazy-image" src="../Images/ea149a2f97f3d783939b6a93995669c6.png" alt="how to register the user" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2022/10/how-register-user.png 730w, https://blog.logrocket.com/wp-content/uploads/2022/10/how-register-user-300x169.png 300w" data-lazy-sizes="(max-width: 730px) 100vw, 730px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2022/10/how-register-user.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/10/how-register-user.png"/></p><noscript><img data-lazy-fallback="1" data-attachment-id="138603" data-permalink="https://blog.logrocket.com/end-end-testing-nestjs-typeorm/attachment/how-register-user/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/10/how-register-user.png" data-orig-size="730,411" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="how-register-user" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/10/how-register-user-300x169.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/10/how-register-user.png" decoding="async" loading="lazy" class="aligncenter wp-image-138603 size-full" src="../Images/ea149a2f97f3d783939b6a93995669c6.png" alt="how to register the user" srcset="https://blog.logrocket.com/wp-content/uploads/2022/10/how-register-user.png 730w, https://blog.logrocket.com/wp-content/uploads/2022/10/how-register-user-300x169.png 300w" sizes="(max-width: 730px) 100vw, 730px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/10/how-register-user.png"/></noscript>
<p>用户登录后，检索令牌并使用它来创建产品。</p>
<p><img data-attachment-id="138606" data-permalink="https://blog.logrocket.com/end-end-testing-nestjs-typeorm/attachment/create-product/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/10/create-product.png" data-orig-size="730,486" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="create-product" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/10/create-product-300x200.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/10/create-product.png" decoding="async" class="aligncenter wp-image-138606 size-full jetpack-lazy-image" src="../Images/99dfa4e44de757f4ff2d22841181579a.png" alt="Create a product" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2022/10/create-product.png 730w, https://blog.logrocket.com/wp-content/uploads/2022/10/create-product-300x200.png 300w" data-lazy-sizes="(max-width: 730px) 100vw, 730px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2022/10/create-product.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/10/create-product.png"/></p><noscript><img data-lazy-fallback="1" data-attachment-id="138606" data-permalink="https://blog.logrocket.com/end-end-testing-nestjs-typeorm/attachment/create-product/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/10/create-product.png" data-orig-size="730,486" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="create-product" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/10/create-product-300x200.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/10/create-product.png" decoding="async" loading="lazy" class="aligncenter wp-image-138606 size-full" src="../Images/99dfa4e44de757f4ff2d22841181579a.png" alt="Create a product" srcset="https://blog.logrocket.com/wp-content/uploads/2022/10/create-product.png 730w, https://blog.logrocket.com/wp-content/uploads/2022/10/create-product-300x200.png 300w" sizes="(max-width: 730px) 100vw, 730px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/10/create-product.png"/></noscript>
<p><strong>创建产品</strong>功能运行顺畅。👌</p>
<h3 id="creating-get-product-feature">创建获取产品特征</h3>
<p>在这里，我们将探索我们刚刚用来创建Get Product特性的TDD技术。“获取产品”功能允许根据输入值检索产品。</p>
<p>在<code>product.controller.spec.ts</code>文件中，传播一个单元测试来测试检索项目的行为。</p>
<p>在<code>product.controller.spec.ts</code>文件中，创建一个新的模拟请求，作为请求中预期对象的表示，然后创建一个<code>mockProducts</code>变量。</p>
<pre class="language-typescript hljs">const mockProducts: Product[] = [
    mockProduct,
    { ...mockProduct, body: "Vanilla" },
    { ...mockProduct, body: "Ice" },
  ];
</pre>
<p><code>mockProductService</code>对象拥有一个新方法，可以在检索期间接收值。</p>
<pre class="language-typescript hljs">  const mockProductService = {
    createProduct: jest
      .fn()
      .mockImplementation((user: User, product: Product) =&gt; {
        return {
          id: 1,
          ...product,
        };
      }),
    findProducts: jest
      .fn()
      .mockImplementation((numberToTake: number, numberToSkip: number) =&gt; {
        const productsAfterSkipping = mockProducts.slice(numberToSkip);
        const filteredProducts = productsAfterSkipping.slice(0, numberToTake);
        return filteredProducts;
      }),
  };
</pre>
<p>下一步是定义我们想要运行的测试。我们的<code>take</code>和<code>skip</code>值分别是<code>2</code>和<code>1</code>。这些值用作参数。</p>
<pre class="language-typescript hljs"> it("should get 2 products, skipping the first", () =&gt; 
    expect(productController.findSelected(2, 1)).toEqual(mockProducts.slice(1));
  });
</pre>
<p>运行测试。它应该会失败，因为控制器中没有必要的方法。</p>
<p>在<code>product.controller.ts</code>文件中，创建<code>GET</code>路线:</p>
<pre class="language-typescript hljs">import {
  Body,
  Controller,
  Get,
  Param,
  Post,
  Query,
  Req,
  Request,
  Res,
  UseGuards,
} from "@nestjs/common";
import { Observable } from "rxjs";
import { JwtGuard } from "../../auth/guards/jwt.guard";
import { Product } from "../models/product.interface";
import { ProductService } from "../services/product.service";

@Controller("product")
export class ProductController {
  constructor(private productService: ProductService) {}

  @UseGuards(JwtGuard)
  @Post()
  create(@Body() product: Product, @Request() req): Observable&lt;Product&gt; {
    return this.productService.createProduct(req.user, product);
  }

  @UseGuards(JwtGuard)
  @Get()
  findSelected(
    @Query("take") take: number = 1,
    @Query("skip") skip: number = 1
  ): Observable&lt;Product[]&gt; {
    take = take &gt; 20 ? 20 : take;
    return this.productService.findProducts(take, skip);
  }
}
</pre>
<p>在<code>product.service.ts</code>文件中，定义<code>findProduct</code>方法；<code>findSelected</code>路线调用这个方法。</p>
<pre class="language-typescript hljs">import { Inject, Injectable } from "@nestjs/common";
import { InjectRepository } from "@nestjs/typeorm";
import { from, Observable } from "rxjs";
import  Repository} from "typeorm";

import { User } from "src/auth/models/user.class";
import { ProductEntity } from "../models/product.entity";
import { Product } from "../models/product.interface";

@Injectable()
export class ProductService {
  constructor(
    @InjectRepository(ProductEntity)
    private readonly productRepository: Repository&lt;ProductEntity&gt;
  ) {}

  createProduct(user: User, product: Product): Observable&lt;Product&gt; {
    product.creator = user;
    return from(this.productRepository.save(product));
  }

  findProducts(take: number = 10, skip: number = 0): Observable&lt;Product[]&gt; {
    return from(
      this.productRepository
        .createQueryBuilder("product")
        .innerJoinAndSelect("product.creator", "creator")
        .orderBy("product.createdAt", "DESC")
        .take(take)
        .skip(skip)
        .getMany()
    );
  }
} 
</pre>
<p>在终端窗口中，运行<code>product.controller.spec</code>测试。</p>
<pre class="language-bash hljs">$ yarn test product.controller</pre>
<p>我们的测试成功通过。</p>
<p><img data-attachment-id="138609" data-permalink="https://blog.logrocket.com/end-end-testing-nestjs-typeorm/attachment/sucess/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/10/sucess.png" data-orig-size="730,229" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="sucess" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/10/sucess-300x94.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/10/sucess.png" decoding="async" class="aligncenter wp-image-138609 size-full jetpack-lazy-image" src="../Images/445f4ff39d25ec0ce66f91ca6ddd84c4.png" alt="Successfully passing" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2022/10/sucess.png 730w, https://blog.logrocket.com/wp-content/uploads/2022/10/sucess-300x94.png 300w" data-lazy-sizes="(max-width: 730px) 100vw, 730px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2022/10/sucess.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/10/sucess.png"/></p><noscript><img data-lazy-fallback="1" data-attachment-id="138609" data-permalink="https://blog.logrocket.com/end-end-testing-nestjs-typeorm/attachment/sucess/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/10/sucess.png" data-orig-size="730,229" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="sucess" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/10/sucess-300x94.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/10/sucess.png" decoding="async" loading="lazy" class="aligncenter wp-image-138609 size-full" src="../Images/445f4ff39d25ec0ce66f91ca6ddd84c4.png" alt="Successfully passing" srcset="https://blog.logrocket.com/wp-content/uploads/2022/10/sucess.png 730w, https://blog.logrocket.com/wp-content/uploads/2022/10/sucess-300x94.png 300w" sizes="(max-width: 730px) 100vw, 730px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/10/sucess.png"/></noscript>
<h3 id="retrieving-product-nest-js-application">使用NestJS应用程序检索产品</h3>
<p>令牌在收到成功登录后对路由进行身份验证。这条路线可以检索已创建产品的列表。</p>
<p><img data-attachment-id="138614" data-permalink="https://blog.logrocket.com/end-end-testing-nestjs-typeorm/attachment/the-route/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/10/the-route.png" data-orig-size="730,497" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="the-route" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/10/the-route-300x204.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/10/the-route.png" decoding="async" class="aligncenter wp-image-138614 size-full jetpack-lazy-image" src="../Images/7ad688e74f01d23e02ee146a0a5a6d80.png" alt="the route" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2022/10/the-route.png 730w, https://blog.logrocket.com/wp-content/uploads/2022/10/the-route-300x204.png 300w" data-lazy-sizes="(max-width: 730px) 100vw, 730px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2022/10/the-route.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/10/the-route.png"/></p><noscript><img data-lazy-fallback="1" data-attachment-id="138614" data-permalink="https://blog.logrocket.com/end-end-testing-nestjs-typeorm/attachment/the-route/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/10/the-route.png" data-orig-size="730,497" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="the-route" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/10/the-route-300x204.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/10/the-route.png" decoding="async" loading="lazy" class="aligncenter wp-image-138614 size-full" src="../Images/7ad688e74f01d23e02ee146a0a5a6d80.png" alt="the route" srcset="https://blog.logrocket.com/wp-content/uploads/2022/10/the-route.png 730w, https://blog.logrocket.com/wp-content/uploads/2022/10/the-route-300x204.png 300w" sizes="(max-width: 730px) 100vw, 730px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/10/the-route.png"/></noscript>
<h2 id="what-end-to-end-tests">什么是端到端测试？</h2>
<p>端到端测试套件使开发人员能够测试软件产品。该测试的最终目标是确保应用程序的行为符合预期。</p>
<p>模拟用户如何在端到端测试套件中与应用程序交互是关键。该模拟使开发人员能够确认系统在测试中是如何运行的。我们将为认证控制器建立一个端到端的测试套件。</p>
<h2 id="end-to-end-tests-nest-js">NestJS中的端到端测试</h2>
<p>默认情况下，NestJS提供E2E测试。为了创建应用程序的实例，我们依赖Supertest。<a href="https://www.npmjs.com/package/supertest"> Supertest </a>支持在我们的应用程序中检测端点并创建请求。</p>
<p>创建E2E测试时，有两种方法可供探索:</p>
<ol>
<li>模拟所有测试模块，然后调用控制器和服务</li>
<li>用数据库测试端点</li>
</ol>
<p>我们的方法支持对API端点的直接请求。</p>
<h2 id="creating-end-to-end-tests-auth-controller">在身份验证控制器上创建端到端测试</h2>
<p>在auth controller中，注册用户和登录的E2E测试的实现是关键。一个文件保存了我们需要的E2E测试。</p>
<p>在根目录中，找到测试文件夹，并创建一个<code>auth.e2e-spec.ts</code>文件。<code>authController</code>的<code>describe</code>方法和认证URL将与我们的E2E测试一起保存在这个文件中。</p>
<pre class="language-bash hljs">$ touch test/auth.e2e-spec.ts
$ code test/auth.e2e-spec.ts</pre>
<p>将下面的代码块粘贴到<code>auth.e2e-spec.ts</code>文件中:</p>
<pre class="language-typescript hljs">import { HttpStatus } from '@nestjs/common';

import * as jwt from 'jsonwebtoken';
import * as request from 'supertest';

import { User } from '../src/auth/models/user.class';

describe('AuthController (e2e)', () =&gt; {
      const authUrl = `http://localhost:3000/api/auth`;
});
</pre>
<p>测试注册服务和控制器，以检查注册后的<code>user</code>对象。</p>
<p>下面的代码块是要测试的<code>registerAccount</code>方法。</p>
<pre class="language-typescript hljs"> doesUserExist(email: string): Observable&lt;boolean&gt; {
    return from(this.userRepository.findOne({ email })).pipe(
      switchMap((user: User) =&gt; {
        return of(!!user);
      })
    );
  }

registerAccount(user: User): Observable&lt;User&gt; {
    const { givenName, familyName, email, password } = user;

    return this.doesUserExist(email).pipe(
      tap((doesUserExist: boolean) =&gt; {
        if (doesUserExist)
          throw new HttpException(
            "A user has already been created with this email address",
            HttpStatus.BAD_REQUEST
          );
      }),
      switchMap(() =&gt; {
        return this.hashPassword(password).pipe(
          switchMap((hashedPassword: string) =&gt; {
            return from(
              this.userRepository.save({
                givenName,
                familyName,
                email,
                password: hashedPassword,
              })
            ).pipe(
              map((user: User) =&gt; {
                delete user.password;
                return user;
              })
            );
          })
        );
      })
    );
  }
</pre>
<p>上面的代码片段提供了注册用户所需变量的信息。返回的用户对象表示在客户端应用程序中收到的响应。</p>
<p>在<code>describe</code>块中，有一个嵌套的<code>describe</code>块，用于定位<code>'/auth/register/'</code>端点。在<code>it</code>块中，创建一个请求，并作为响应的一部分返回mockUser对象。<code>expect</code>变量是检查响应有效性的关键。</p>
<pre class="language-typescript hljs">import { HttpStatus } from "@nestjs/common";

import * as jwt from "jsonwebtoken";
import * as request from "supertest";

import { User } from "../src/auth/models/user.class";

describe("AuthController (e2e)", () =&gt; {
  const authUrl = `http://localhost:6000/auth`;

  const mockUser: User = {
    givenName: "givenName",
    familyName: "familyName",
    email: "<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="e3868e828a8fa38b8c8e97828a8fcd808c8e">[email protected]</a>",
    password: "password",
  };

  describe("/auth/register (POST)", () =&gt; {
    it("it should register a user and return the new user object", () =&gt; {
      return request(authUrl)
        .post("/register")
        .set("Accept", "application/json")
        .send(mockUser)
        .expect((response: request.Response) =&gt; {
          const {
            id,
            givenName,
            familyName,
            password,
            email,
            imagePath,
            role,
          } = response.body;

          expect(typeof id).toBe("number"),
            expect(givenName).toEqual(mockUser.givenName),
            expect(familyName).toEqual(mockUser.familyName),
            expect(email).toEqual(mockUser.email),
            expect(password).toBeUndefined();
          expect(imagePath).toBeNull();
          expect(role).toEqual("user");
        })
        .expect(HttpStatus.CREATED);
    });
  });
});
</pre>
<p>运行测试:</p>
<pre class="language-bash hljs">$ yarn run test:e2e</pre>
<p>端点上的测试结果如下。</p>
<p><img data-attachment-id="138627" data-permalink="https://blog.logrocket.com/end-end-testing-nestjs-typeorm/attachment/result-4/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/10/result-1.png" data-orig-size="730,252" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="endpoint-result" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/10/result-1-300x104.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/10/result-1.png" decoding="async" class="wp-image-138627 size-full aligncenter jetpack-lazy-image" src="../Images/654d89027f5774a869898a8414d9e34e.png" alt="endpoint-result" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2022/10/result-1.png 730w, https://blog.logrocket.com/wp-content/uploads/2022/10/result-1-300x104.png 300w" data-lazy-sizes="(max-width: 730px) 100vw, 730px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2022/10/result-1.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/10/result-1.png"/></p><noscript><img data-lazy-fallback="1" data-attachment-id="138627" data-permalink="https://blog.logrocket.com/end-end-testing-nestjs-typeorm/attachment/result-4/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/10/result-1.png" data-orig-size="730,252" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="endpoint-result" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/10/result-1-300x104.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/10/result-1.png" decoding="async" loading="lazy" class="wp-image-138627 size-full aligncenter" src="../Images/654d89027f5774a869898a8414d9e34e.png" alt="endpoint-result" srcset="https://blog.logrocket.com/wp-content/uploads/2022/10/result-1.png 730w, https://blog.logrocket.com/wp-content/uploads/2022/10/result-1-300x104.png 300w" sizes="(max-width: 730px) 100vw, 730px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/10/result-1.png"/></noscript>
<h3 id="test-registration-service-ensure-new-users-registered-existing-email">测试注册服务，以确保新用户没有使用现有的电子邮件注册</h3>
<p>创建另一个<code>it</code>函数来检查注册时使用现有电子邮件是否会触发错误请求。</p>
<pre class="language-typescript hljs">it('it should not register a new user if the passed email already exists', () =&gt; {
      return request(authUrl)
        .post('/register')
        .set('Accept', 'application/json')
        .send(mockUser)
        .expect(HttpStatus.BAD_REQUEST);
    });
</pre>
<p>运行测试:</p>
<pre class="language-bash hljs">$ yarn run test:e2e</pre>
<p>我们的测试触发并返回以下结果:</p>
<p><img data-attachment-id="138623" data-permalink="https://blog.logrocket.com/end-end-testing-nestjs-typeorm/attachment/result-test-3/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/10/result-test-2.png" data-orig-size="730,344" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="result-test" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/10/result-test-2-300x141.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/10/result-test-2.png" decoding="async" class="alignnone wp-image-138623 size-full jetpack-lazy-image" src="../Images/96efedf9f5cc8d5e3ecef6c7a13f871f.png" alt="Result of running the test" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2022/10/result-test-2.png 730w, https://blog.logrocket.com/wp-content/uploads/2022/10/result-test-2-300x141.png 300w" data-lazy-sizes="(max-width: 730px) 100vw, 730px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2022/10/result-test-2.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/10/result-test-2.png"/></p><noscript><img data-lazy-fallback="1" data-attachment-id="138623" data-permalink="https://blog.logrocket.com/end-end-testing-nestjs-typeorm/attachment/result-test-3/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/10/result-test-2.png" data-orig-size="730,344" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="result-test" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/10/result-test-2-300x141.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/10/result-test-2.png" decoding="async" loading="lazy" class="alignnone wp-image-138623 size-full" src="../Images/96efedf9f5cc8d5e3ecef6c7a13f871f.png" alt="Result of running the test" srcset="https://blog.logrocket.com/wp-content/uploads/2022/10/result-test-2.png 730w, https://blog.logrocket.com/wp-content/uploads/2022/10/result-test-2-300x141.png 300w" sizes="(max-width: 730px) 100vw, 730px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/10/result-test-2.png"/></noscript>
<h2>结论</h2>
<p>实现的测试正在运行，并且一个新的质量保证层是可用的。在NestJS中需要注意的一个关键点是将依赖项作为相对路径导入。我希望这篇文章能够成为在您的应用程序中创建大量E2E测试的可靠指南。</p><div class="code-block code-block-21">
<div class="blog-plug inline-plug typescript-plug"><h2><a class="signup" href="https://lp.logrocket.com/blg/typescript-signup" target="_blank" rel="noopener noreferrer"> LogRocket </a>:全面了解您的网络和移动应用</h2>
<a href="https://lp.logrocket.com/blg/typescript-signup" class="signup" target="_blank" rel="noopener noreferrer"><img class="alignnone size-full wp-image-46 jetpack-lazy-image" src="../Images/d6f5a5dd739296c1dd7aab3d5e77eeb9.png" alt="LogRocket Dashboard Free Trial Banner" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2017/03/1d0cd-1s_rmyo6nbrasp-xtvbaxfg.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2017/03/1d0cd-1s_rmyo6nbrasp-xtvbaxfg.png"/><noscript><img data-lazy-fallback="1" class="alignnone size-full wp-image-46" src="../Images/d6f5a5dd739296c1dd7aab3d5e77eeb9.png" alt="LogRocket Dashboard Free Trial Banner" data-original-src="https://blog.logrocket.com/wp-content/uploads/2017/03/1d0cd-1s_rmyo6nbrasp-xtvbaxfg.png"/></noscript></a>
<p>LogRocket 是一个前端应用程序监控解决方案，可以让您回放问题，就像问题发生在您自己的浏览器中一样。LogRocket不需要猜测错误发生的原因，也不需要向用户询问截图和日志转储，而是让您重放会话以快速了解哪里出错了。它可以与任何应用程序完美配合，不管是什么框架，并且有插件可以记录来自Redux、Vuex和@ngrx/store的额外上下文。</p>
<p>除了记录Redux操作和状态，LogRocket还记录控制台日志、JavaScript错误、堆栈跟踪、带有头+正文的网络请求/响应、浏览器元数据和自定义日志。它还使用DOM来记录页面上的HTML和CSS，甚至为最复杂的单页面和移动应用程序重新创建像素级完美视频。</p>
<a class="signup" href="https://lp.logrocket.com/blg/typescript-signup" target="_blank" rel="noopener noreferrer">Try it for free</a><p>.</p></div>
</div>

<p class="clearfix"/>
<p class="clearfix"/>
</article>

</div>    
</body>
</html>