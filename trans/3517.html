<html>
<head>
<title>Creating separate monorepo CI/CD pipelines with GitHub Actions </title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>使用GitHub操作创建单独的monorepo CI/CD管道</h1>
<blockquote>原文：<a href="https://blog.logrocket.com/creating-separate-monorepo-ci-cd-pipelines-github-actions/#0001-01-01">https://blog.logrocket.com/creating-separate-monorepo-ci-cd-pipelines-github-actions/#0001-01-01</a></blockquote><div><article class="article-post">
<p>您是否正在构建微服务，但仍想使用monorepo？让我来帮你吧！使用monorepo是在一个代码库中管理多个相关项目的一种便捷方式。</p>
<p>这篇博客演示了如何为monorepo中的子项目创建单独的CD管道，这使得为小型或早期微服务应用程序使用monorepo更加可行，并尽可能长时间地继续使用monorepo。</p>
<p>这篇博文中包含了一系列工作示例代码，您可以将这些代码放入您自己的GitHub帐户，亲自尝试自动化部署管道。</p>
<p><em>向前跳转:</em></p>

<h2 id="microservices-enable-easy-independent-deployment">微服务支持简单、独立的部署</h2>
<p>我们为什么要用微服务？微服务可能适合您的项目有许多原因，但最重要的原因之一是使用微服务降低了我们的部署风险。</p>
<p>当您部署一个monolith时，您冒着破坏整个东西的风险，并且让您的客户没有一个可用的产品(直到您可以修复它)。这对你公司的财务和声誉都没有好处。</p>
<p>当您部署微服务时，您有可能只破坏应用程序的一小部分，因为一个微服务只是应用程序的一小部分。您可能会破坏的部分很小——通常甚至不面向客户——因此它所代表的风险也更小。</p>
<p>小问题也比大问题更容易修复(压力也更小)，因此将损坏的微服务回滚到工作状态通常比回滚整体更容易。</p>
<p>为了实现这一点，我们的微服务必须有独立的部署管道。也就是说，每个微服务必须能够与其他微服务分开部署。</p>
<p>相反，如果你有一个部署管道可以一次部署所有的微服务——那么，这并不比拥有一个整体好多少。为了充分利用微服务，每个微服务都需要自己独立的持续部署(CD)管道。</p>
<figure id="attachment_138664" aria-describedby="caption-attachment-138664" class="wp-caption aligncenter"><img data-attachment-id="138664" data-permalink="https://blog.logrocket.com/creating-separate-monorepo-ci-cd-pipelines-github-actions/attachment/normal-microservices-project/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/10/normal-microservices-project.png" data-orig-size="730,521" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="normal-microservices-project" data-image-description="" data-image-caption="&lt;p&gt;A normal microservices project with separate code repositories and independent CI/CD pipelines&lt;/p&gt;&#10;" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/10/normal-microservices-project-300x214.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/10/normal-microservices-project.png" decoding="async" class="wp-image-138664 size-full jetpack-lazy-image" src="../Images/8ac0c11d3bb4e226dea62da050f82790.png" alt="Normal microservices project" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2022/10/normal-microservices-project.png 730w, https://blog.logrocket.com/wp-content/uploads/2022/10/normal-microservices-project-300x214.png 300w" data-lazy-sizes="(max-width: 730px) 100vw, 730px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2022/10/normal-microservices-project.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/10/normal-microservices-project.png"/><noscript><img data-lazy-fallback="1" data-attachment-id="138664" data-permalink="https://blog.logrocket.com/creating-separate-monorepo-ci-cd-pipelines-github-actions/attachment/normal-microservices-project/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/10/normal-microservices-project.png" data-orig-size="730,521" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="normal-microservices-project" data-image-description="" data-image-caption="&lt;p&gt;A normal microservices project with separate code repositories and independent CI/CD pipelines&lt;/p&gt;&#10;" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/10/normal-microservices-project-300x214.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/10/normal-microservices-project.png" decoding="async" loading="lazy" class="wp-image-138664 size-full" src="../Images/8ac0c11d3bb4e226dea62da050f82790.png" alt="Normal microservices project" srcset="https://blog.logrocket.com/wp-content/uploads/2022/10/normal-microservices-project.png 730w, https://blog.logrocket.com/wp-content/uploads/2022/10/normal-microservices-project-300x214.png 300w" sizes="(max-width: 730px) 100vw, 730px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/10/normal-microservices-project.png"/></noscript><figcaption id="caption-attachment-138664" class="wp-caption-text">Figure 1: A normal microservices project with separate code repositories and independent CI/CD pipelines</figcaption></figure>

<p>我们可以使用带有微服务的monorepo吗？当然，我们当然可以。事实上，使用包含所有微服务的monorepo是开始新的微服务项目的一种非常方便和直接的方式。我已经用这种方式启动了多个新的微服务项目。</p>
<p>传统上，问题是monorepo有一个CD管道，当代码更改被推送到代码库时，这个管道被调用。所以，无论哪个微服务发生变化，都会部署所有的微服务。</p>
<p>在应用程序的早期，当所有的微服务都在开发并频繁变化时，这并不太糟糕。但是随着应用程序的成熟，您需要能够单独部署微服务—这不仅是因为部署所有微服务非常耗时(尤其是当微服务的数量开始爆炸时)，还因为您希望减轻、最小化和控制您的部署风险。</p>
<h3 id="scaling-cd-pipelines-microservices">扩展CD管道和微服务</h3>
<p>通常会有这样的时候——达到一定的成熟度，或者微服务太多——微服务的单个CD管道会成为应用程序可伸缩性的主要障碍。可惜这个时候往往微服务来的特别快！</p>
<p>在这一点上，我们通常会通过将稳定的微服务拉出到它们自己的代码库中来开始重构，在那里它们可以拥有自己的CD管道。在我们将微服务分离到它们自己的代码库中之后，我们可能会将它们重新组合到一个metarepo中(详见<a href="https://www.npmjs.com/package/meta">元包</a>)。</p>
<p>Metarepos结合了monorepo的便利性和独立代码库的灵活性。但是，拥有独立的代码库增加了复杂性，如果我们能尽可能长时间地坚持使用更简单的monorepo会更好。</p>
<p>分拆单一回购还有其他原因。对于一个成长中的公司来说，拆分成独立的存储库可以让你在一个成长中的开发团队中进行扩展。</p>
<p>但是如果你想要的只是单独的CD管道，那么能够更长时间地坚持使用更简单的monorepo并且能够为每个子项目拥有单独的CD管道不是很好吗？</p>
<p>好消息是这是有可能的。你可以有多个CD管道——至少你可以使用GitHub操作——这允许我们在更长的时间内保持monorepo的简单性。</p>
<figure id="attachment_138668" aria-describedby="caption-attachment-138668" class="wp-caption aligncenter"><img data-attachment-id="138668" data-permalink="https://blog.logrocket.com/creating-separate-monorepo-ci-cd-pipelines-github-actions/attachment/metarepo-vs-monorepo/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/10/metarepo-vs-monorepo.png" data-orig-size="730,338" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="metarepo-vs-monorepo" data-image-description="" data-image-caption="&lt;p&gt; Comparing a metarepo to a monorepo&lt;/p&gt;&#10;" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/10/metarepo-vs-monorepo-300x139.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/10/metarepo-vs-monorepo.png" decoding="async" class="wp-image-138668 size-full jetpack-lazy-image" src="../Images/d732f5cdae2ec56f1063d40082a33bb5.png" alt="Metarepo vs Monorepo" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2022/10/metarepo-vs-monorepo.png 730w, https://blog.logrocket.com/wp-content/uploads/2022/10/metarepo-vs-monorepo-300x139.png 300w" data-lazy-sizes="(max-width: 730px) 100vw, 730px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2022/10/metarepo-vs-monorepo.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/10/metarepo-vs-monorepo.png"/><noscript><img data-lazy-fallback="1" data-attachment-id="138668" data-permalink="https://blog.logrocket.com/creating-separate-monorepo-ci-cd-pipelines-github-actions/attachment/metarepo-vs-monorepo/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/10/metarepo-vs-monorepo.png" data-orig-size="730,338" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="metarepo-vs-monorepo" data-image-description="" data-image-caption="&lt;p&gt; Comparing a metarepo to a monorepo&lt;/p&gt;&#10;" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/10/metarepo-vs-monorepo-300x139.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/10/metarepo-vs-monorepo.png" decoding="async" loading="lazy" class="wp-image-138668 size-full" src="../Images/d732f5cdae2ec56f1063d40082a33bb5.png" alt="Metarepo vs Monorepo" srcset="https://blog.logrocket.com/wp-content/uploads/2022/10/metarepo-vs-monorepo.png 730w, https://blog.logrocket.com/wp-content/uploads/2022/10/metarepo-vs-monorepo-300x139.png 300w" sizes="(max-width: 730px) 100vw, 730px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/10/metarepo-vs-monorepo.png"/></noscript><figcaption id="caption-attachment-138668" class="wp-caption-text">Figure 2: Comparing a metarepo to a monorepo</figcaption></figure>
<h2 id="creating-separate-ci-cd-pipelines-github-actions">在GitHub操作中创建单独的CI/CD管道</h2>
<p>当我们在<a href="https://github.com/"> GitHub </a>上托管我们的代码时，我们可以使用<a href="https://github.com/features/actions"> GitHub动作</a>来创建工作流，当代码被推送到我们的代码库时，这些工作流会被自动调用。我们可以使用这些来创建持续集成(CI)和持续部署(CD)的管道。</p>
<p>为了更简单，我喜欢把它解释为“在云中自动运行一个shell脚本”在脚本中指定命令，然后每当GitHub Actions检测到您的代码发生更改时，就会自动执行该脚本。</p>
<p>每个工作流的输出都显示在GitHub Actions用户界面中；下面的图3显示了一个例子。它收集并显示每个工作流调用的输出和状态(<code>success</code>或<code>failure</code>)。通常，当工作流失败时，GitHub会自动向团队发送电子邮件，通知他们有人破坏了某些东西。</p>
<figure id="attachment_138670" aria-describedby="caption-attachment-138670" class="wp-caption aligncenter"><img data-attachment-id="138670" data-permalink="https://blog.logrocket.com/creating-separate-monorepo-ci-cd-pipelines-github-actions/attachment/workflow/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/10/workflow.png" data-orig-size="730,440" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="workflow" data-image-description="" data-image-caption="&lt;p&gt;An example of workflow history in GitHub Actions&lt;/p&gt;&#10;" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/10/workflow-300x181.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/10/workflow.png" decoding="async" class="wp-image-138670 size-full jetpack-lazy-image" src="../Images/2d849888868cbb145ac36ab4c7354e1d.png" alt="Workflow history example" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2022/10/workflow.png 730w, https://blog.logrocket.com/wp-content/uploads/2022/10/workflow-300x181.png 300w" data-lazy-sizes="(max-width: 730px) 100vw, 730px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2022/10/workflow.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/10/workflow.png"/><noscript><img data-lazy-fallback="1" data-attachment-id="138670" data-permalink="https://blog.logrocket.com/creating-separate-monorepo-ci-cd-pipelines-github-actions/attachment/workflow/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/10/workflow.png" data-orig-size="730,440" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="workflow" data-image-description="" data-image-caption="&lt;p&gt;An example of workflow history in GitHub Actions&lt;/p&gt;&#10;" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/10/workflow-300x181.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/10/workflow.png" decoding="async" loading="lazy" class="wp-image-138670 size-full" src="../Images/2d849888868cbb145ac36ab4c7354e1d.png" alt="Workflow history example" srcset="https://blog.logrocket.com/wp-content/uploads/2022/10/workflow.png 730w, https://blog.logrocket.com/wp-content/uploads/2022/10/workflow-300x181.png 300w" sizes="(max-width: 730px) 100vw, 730px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/10/workflow.png"/></noscript><figcaption id="caption-attachment-138670" class="wp-caption-text">Figure 3: An example of workflow history in GitHub Actions</figcaption></figure>
<p>为了热身，让我们看看基本的工作流配置是什么样子的。下面的示例代码显示了为Node.js项目运行自动化测试的工作流。在一个代码库中，我们可以有任意多的工作流，所以下面的工作流可能只是特定代码库中的一个。</p>
<figure id="attachment_138672" aria-describedby="caption-attachment-138672" class="wp-caption aligncenter"><img data-attachment-id="138672" data-permalink="https://blog.logrocket.com/creating-separate-monorepo-ci-cd-pipelines-github-actions/attachment/workflow-configuration-running-automated-tests/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/10/workflow-configuration-running-automated-tests.png" data-orig-size="730,781" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="workflow-configuration-running-automated-tests" data-image-description="" data-image-caption="&lt;p&gt;An example of workflow configuration for running automated tests in a Node.js project&lt;/p&gt;&#10;" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/10/workflow-configuration-running-automated-tests-280x300.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/10/workflow-configuration-running-automated-tests.png" decoding="async" class="wp-image-138672 size-full jetpack-lazy-image" src="../Images/68531a60ef17a94b241c3c852e1a9e0f.png" alt="workflow configuration for running automated tests" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2022/10/workflow-configuration-running-automated-tests.png 730w, https://blog.logrocket.com/wp-content/uploads/2022/10/workflow-configuration-running-automated-tests-280x300.png 280w" data-lazy-sizes="(max-width: 730px) 100vw, 730px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2022/10/workflow-configuration-running-automated-tests.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/10/workflow-configuration-running-automated-tests.png"/><noscript><img data-lazy-fallback="1" data-attachment-id="138672" data-permalink="https://blog.logrocket.com/creating-separate-monorepo-ci-cd-pipelines-github-actions/attachment/workflow-configuration-running-automated-tests/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/10/workflow-configuration-running-automated-tests.png" data-orig-size="730,781" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="workflow-configuration-running-automated-tests" data-image-description="" data-image-caption="&lt;p&gt;An example of workflow configuration for running automated tests in a Node.js project&lt;/p&gt;&#10;" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/10/workflow-configuration-running-automated-tests-280x300.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/10/workflow-configuration-running-automated-tests.png" decoding="async" loading="lazy" class="wp-image-138672 size-full" src="../Images/68531a60ef17a94b241c3c852e1a9e0f.png" alt="workflow configuration for running automated tests" srcset="https://blog.logrocket.com/wp-content/uploads/2022/10/workflow-configuration-running-automated-tests.png 730w, https://blog.logrocket.com/wp-content/uploads/2022/10/workflow-configuration-running-automated-tests-280x300.png 280w" sizes="(max-width: 730px) 100vw, 730px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/10/workflow-configuration-running-automated-tests.png"/></noscript><figcaption id="caption-attachment-138672" class="wp-caption-text">An example of workflow configuration for running automated tests in a Node.js project</figcaption></figure>
<h2 id="example-project">示例项目</h2>
<p>这篇文章附带了一个工作示例，你可以自己尝试一下。示例项目是包含两个微服务的monorepo。每一个都有自己独立的CD管道，将微服务部署到Kubernetes集群。</p>
<p>代码<a href="https://github.com/ashleydavis/nodejs-microservices-example">可在GitHub </a>上获得。克隆示例回购的本地副本，如下所示:</p>
<pre class="language-bash hljs">git clone https://github.com/ashleydavis/nodejs-microservices-example.git
</pre>
<p>你也可以<a href="https://github.com/ashleydavis/nodejs-microservices-example/archive/refs/heads/main.zip">下载zip文件</a>，或者，如果你只是想<a href="https://github.com/ashleydavis/nodejs-microservices-example/actions">看看GitHub Actions工作流历史是什么样子的</a>，我已经链接到了GitHub中的例子。</p>
<p>下面，图4提供了示例项目的概述。它显示了与两个微服务项目相关的工作流配置，以及将它们部署到Kubernetes的配置。</p>
<figure id="attachment_138676" aria-describedby="caption-attachment-138676" class="wp-caption aligncenter"><img data-attachment-id="138676" data-permalink="https://blog.logrocket.com/creating-separate-monorepo-ci-cd-pipelines-github-actions/attachment/ex-project-structure/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/10/ex-project-structure.png" data-orig-size="730,477" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="ex-project-structure" data-image-description="" data-image-caption="&lt;p&gt;The structure of the example project&lt;/p&gt;&#10;" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/10/ex-project-structure-300x196.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/10/ex-project-structure.png" decoding="async" class="wp-image-138676 size-full jetpack-lazy-image" src="../Images/69ae53490a28539f6a5efb618c7885c8.png" alt="Example project structure" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2022/10/ex-project-structure.png 730w, https://blog.logrocket.com/wp-content/uploads/2022/10/ex-project-structure-300x196.png 300w" data-lazy-sizes="(max-width: 730px) 100vw, 730px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2022/10/ex-project-structure.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/10/ex-project-structure.png"/><noscript><img data-lazy-fallback="1" data-attachment-id="138676" data-permalink="https://blog.logrocket.com/creating-separate-monorepo-ci-cd-pipelines-github-actions/attachment/ex-project-structure/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/10/ex-project-structure.png" data-orig-size="730,477" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="ex-project-structure" data-image-description="" data-image-caption="&lt;p&gt;The structure of the example project&lt;/p&gt;&#10;" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/10/ex-project-structure-300x196.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/10/ex-project-structure.png" decoding="async" loading="lazy" class="wp-image-138676 size-full" src="../Images/69ae53490a28539f6a5efb618c7885c8.png" alt="Example project structure" srcset="https://blog.logrocket.com/wp-content/uploads/2022/10/ex-project-structure.png 730w, https://blog.logrocket.com/wp-content/uploads/2022/10/ex-project-structure-300x196.png 300w" sizes="(max-width: 730px) 100vw, 730px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/10/ex-project-structure.png"/></noscript><figcaption id="caption-attachment-138676" class="wp-caption-text"><span>Figure 4: </span>The structure of the example project</figcaption></figure>
<h2 id="prerequisites">先决条件</h2>
<p>运行示例项目需要什么？</p>
<p>嗯，那要看你想怎么经营了！</p>
<p>如果您希望在开发计算机上本地运行微服务应用程序，您将需要:</p>

<p>如果您想通过从开发计算机运行部署脚本来将其部署到Kubernetes，您将需要:</p>

<p>如果您想让GitHub Actions工作流程自己运行，您需要:</p>

<p>在这篇文章的其余部分，我们将更详细地研究这些例子。</p>
<h2 id="running-app-locally-development">在本地运行应用程序进行开发</h2>
<p>如果你想在开发中尝试在本地运行这个微服务应用，你只需要安装<a href="https://www.docker.com/products/docker-desktop/"> Docker Desktop </a>。</p>
<p><a href="https://github.com/ashleydavis/nodejs-microservices-example/blob/main/docker-compose.yml">清单1 </a>展示了使这成为可能的Docker合成文件。您可以看到它如何启动多个“服务”:一个用于MongoDB数据库服务器，一个用于我们的每个微服务。它还启动了一个将测试数据加载到我们的数据库中的服务(名为<code>db-fixture</code>)。</p>
<figure id="attachment_138679" aria-describedby="caption-attachment-138679" class="wp-caption aligncenter"><img data-attachment-id="138679" data-permalink="https://blog.logrocket.com/creating-separate-monorepo-ci-cd-pipelines-github-actions/attachment/docker-compose-file/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/10/docker-compose-file.png" data-orig-size="730,1697" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="docker-compose-file" data-image-description="" data-image-caption="&lt;p&gt;Listing 1 (docker-compose.yaml). Docker Compose file for running the example microservices application on our development computer&lt;/p&gt;&#10;" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/10/docker-compose-file-129x300.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/10/docker-compose-file-440x1024.png" decoding="async" class="wp-image-138679 size-full jetpack-lazy-image" src="../Images/8d89c9151a7eb0fbae81966fdd7090d1.png" alt="Docker Compose file" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2022/10/docker-compose-file.png 730w, https://blog.logrocket.com/wp-content/uploads/2022/10/docker-compose-file-129x300.png 129w, https://blog.logrocket.com/wp-content/uploads/2022/10/docker-compose-file-440x1024.png 440w, https://blog.logrocket.com/wp-content/uploads/2022/10/docker-compose-file-661x1536.png 661w" data-lazy-sizes="(max-width: 730px) 100vw, 730px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2022/10/docker-compose-file.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/10/docker-compose-file.png"/><noscript><img data-lazy-fallback="1" data-attachment-id="138679" data-permalink="https://blog.logrocket.com/creating-separate-monorepo-ci-cd-pipelines-github-actions/attachment/docker-compose-file/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/10/docker-compose-file.png" data-orig-size="730,1697" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="docker-compose-file" data-image-description="" data-image-caption="&lt;p&gt;Listing 1 (docker-compose.yaml). Docker Compose file for running the example microservices application on our development computer&lt;/p&gt;&#10;" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/10/docker-compose-file-129x300.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/10/docker-compose-file-440x1024.png" decoding="async" loading="lazy" class="wp-image-138679 size-full" src="../Images/8d89c9151a7eb0fbae81966fdd7090d1.png" alt="Docker Compose file" srcset="https://blog.logrocket.com/wp-content/uploads/2022/10/docker-compose-file.png 730w, https://blog.logrocket.com/wp-content/uploads/2022/10/docker-compose-file-129x300.png 129w, https://blog.logrocket.com/wp-content/uploads/2022/10/docker-compose-file-440x1024.png 440w, https://blog.logrocket.com/wp-content/uploads/2022/10/docker-compose-file-661x1536.png 661w" sizes="(max-width: 730px) 100vw, 730px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/10/docker-compose-file.png"/></noscript><figcaption id="caption-attachment-138679" class="wp-caption-text">Listing 1 (<a href="https://github.com/ashleydavis/nodejs-microservices-example/blob/main/docker-compose.yml">docker-compose.yaml</a>). Docker Compose file for running the example microservices application on our development computer</figcaption></figure>
<p>要运行它，首先将目录更改为代码库的本地副本:</p>
<pre class="language-bash hljs">cd nodejs-microservices-example
</pre>
<p>然后，在Docker Compose下启动本地微服务应用程序:</p>
<pre class="language-bash hljs">docker compose up --build
</pre>
<p>运行后，您可以通过打开web浏览器并导航到<code><a href="http://localhost:4000/">http://localhost:4000/</a></code>来测试它。你应该看到“你好电脑！”打印在网页上。这很简单，但它向您展示了网关微服务正在为一个网页提供服务。</p>
<p>在route <code>/api/data</code>下有一个示例REST API可以通过gateway微服务获得；将您的浏览器导航到<code><a href="http://localhost:4000/api/data">http://localhost:4000/api/data</a></code>以查看其输出。</p>
<p>网关微服务将REST API请求转发给工人微服务，您可以在<code><a href="http://localhost:4001/api/data">http://localhost:4001/api/data</a></code>直接访问工人微服务。注意，在开发中运行微服务应用程序时，我们只能像这样直接访问worker微服务。当我们将应用程序部署到Kubernetes时，它被配置为只有gateway微服务可以从外部访问，而worker微服务只能在Kubernetes集群中访问。</p>
<p>当微服务应用程序在本地运行时，您可以随意尝试代码。它是为<a href="https://blog.logrocket.com/complete-guide-full-stack-live-reload/">实时重载</a>配置的，因此您对每个微服务的代码所做的任何更改都会导致该微服务自动重载以合并您的更改。</p>
<p>完成后，您可以关闭本地微服务应用程序:</p>
<pre class="language-bash hljs">docker compose down
</pre>
<p>Docker Compose是启动和停止本地微服务应用程序的一种非常方便的方式。</p>
<h2 id="deploy-kubernetes-development-computer">从您的开发计算机部署到Kubernetes</h2>
<p>在创建自动化部署管道之前(比如说，使用GitHub操作)，最好先练习一下我们将要自动化的命令。</p>
<p>如果您想从自己的开发计算机上运行这些命令，您需要:</p>

<p>当然，您不需要这样做。您可以直接跳到在GitHub操作中使用这个例子(如果是这样，跳到下一节)。但是您很容易遇到问题，比如Kubernetes集群的认证问题。如果我们试图在GitHub操作下解决这些问题，那么调试起来会很困难而且很慢。</p>
<p>通过首先从我们的本地开发计算机上练习部署，可以更快更容易地试验和解决问题。在我们尝试在GitHub Actions中自动化部署脚本之前，这为我们的成功做好了准备。</p>
<h3 id="deploying-database">部署数据库</h3>
<p>让我们从部署一个MongoDB数据库到我们的Kubernetes集群开始。这是一个简单的起点，因为我们不必为它构建Docker映像(我们重用DockerHub 上可用的<a href="https://hub.docker.com/_/mongo">预构建映像)，并且我们不必为部署参数化Kubernetes配置文件。</a></p>
<figure id="attachment_138681" aria-describedby="caption-attachment-138681" class="wp-caption aligncenter"><img data-attachment-id="138681" data-permalink="https://blog.logrocket.com/creating-separate-monorepo-ci-cd-pipelines-github-actions/attachment/deploy-database/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/10/deploy-database.png" data-orig-size="730,1045" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="deploy-database" data-image-description="" data-image-caption="&lt;p&gt;Listing 2 (scripts/kubernetes/db.yaml). Kubernetes Yaml configuration file to deploy the database&lt;/p&gt;&#10;" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/10/deploy-database-210x300.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/10/deploy-database-715x1024.png" decoding="async" class="wp-image-138681 size-full jetpack-lazy-image" src="../Images/e1e34216ba23de03bbc9cf1753b289dc.png" alt="Deploying the database" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2022/10/deploy-database.png 730w, https://blog.logrocket.com/wp-content/uploads/2022/10/deploy-database-210x300.png 210w, https://blog.logrocket.com/wp-content/uploads/2022/10/deploy-database-715x1024.png 715w" data-lazy-sizes="(max-width: 730px) 100vw, 730px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2022/10/deploy-database.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/10/deploy-database.png"/><noscript><img data-lazy-fallback="1" data-attachment-id="138681" data-permalink="https://blog.logrocket.com/creating-separate-monorepo-ci-cd-pipelines-github-actions/attachment/deploy-database/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/10/deploy-database.png" data-orig-size="730,1045" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="deploy-database" data-image-description="" data-image-caption="&lt;p&gt;Listing 2 (scripts/kubernetes/db.yaml). Kubernetes Yaml configuration file to deploy the database&lt;/p&gt;&#10;" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/10/deploy-database-210x300.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/10/deploy-database-715x1024.png" decoding="async" loading="lazy" class="wp-image-138681 size-full" src="../Images/e1e34216ba23de03bbc9cf1753b289dc.png" alt="Deploying the database" srcset="https://blog.logrocket.com/wp-content/uploads/2022/10/deploy-database.png 730w, https://blog.logrocket.com/wp-content/uploads/2022/10/deploy-database-210x300.png 210w, https://blog.logrocket.com/wp-content/uploads/2022/10/deploy-database-715x1024.png 715w" sizes="(max-width: 730px) 100vw, 730px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/10/deploy-database.png"/></noscript><figcaption id="caption-attachment-138681" class="wp-caption-text">Listing 2 (<a href="https://github.com/ashleydavis/nodejs-microservices-example/blob/main/scripts/kubernetes/db.yaml">scripts/kubernetes/db.yaml</a>). Kubernetes Yaml configuration file to deploy the database</figcaption></figure>
<p>我们使用Kubectl部署这个配置:</p>
<pre class="language-bash hljs">kubectl apply -f ./scripts/kubernetes/db.yaml
</pre>
<p>现在，让我们部署我们的两个微服务。这并不那么简单，因为它们的部署配置需要参数，我们必须在部署它们之前填补这些配置中的空白。</p>
<h3 id="expanding-templated-configuration">扩展我们的模板化配置</h3>
<p>我创建了自己的工具，名为<a href="https://www.npmjs.com/package/figit/v/0.0.8"> Figit </a>，用于扩展模板化配置。Figit是一个运行在Node.js下的命令行工具，我们向Figit输入YAML文件，它从环境变量中填充参数。</p>
<p>为什么我们甚至需要参数化我们的配置文件？首先，能够在不同的环境中重用我们的配置文件是件好事。但是在这篇博文中，我们将使用它来“插入”容器注册表的URL和每个Docker图像的版本。</p>
<p>您可以在<a href="https://github.com/ashleydavis/nodejs-microservices-example/blob/main/scripts/kubernetes/worker.yaml">清单3 </a>中看到，worker微服务的配置类似于数据库的配置(来自清单2)，除了我们参数化了对Docker映像的引用。清单3突出显示了这一部分，因此您可以很容易地看到它。</p>
<figure id="attachment_138684" aria-describedby="caption-attachment-138684" class="wp-caption aligncenter"><img data-attachment-id="138684" data-permalink="https://blog.logrocket.com/creating-separate-monorepo-ci-cd-pipelines-github-actions/attachment/deploy-worker-microservice/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/10/deploy-worker-microservice.png" data-orig-size="730,1036" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="deploy-worker-microservice" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/10/deploy-worker-microservice-211x300.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/10/deploy-worker-microservice-722x1024.png" decoding="async" class="wp-image-138684 size-full jetpack-lazy-image" src="../Images/275592d656608159393e754e37cebc17.png" alt="Deploying the worker microservice" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2022/10/deploy-worker-microservice.png 730w, https://blog.logrocket.com/wp-content/uploads/2022/10/deploy-worker-microservice-211x300.png 211w, https://blog.logrocket.com/wp-content/uploads/2022/10/deploy-worker-microservice-722x1024.png 722w" data-lazy-sizes="(max-width: 730px) 100vw, 730px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2022/10/deploy-worker-microservice.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/10/deploy-worker-microservice.png"/><noscript><img data-lazy-fallback="1" data-attachment-id="138684" data-permalink="https://blog.logrocket.com/creating-separate-monorepo-ci-cd-pipelines-github-actions/attachment/deploy-worker-microservice/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/10/deploy-worker-microservice.png" data-orig-size="730,1036" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="deploy-worker-microservice" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/10/deploy-worker-microservice-211x300.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/10/deploy-worker-microservice-722x1024.png" decoding="async" loading="lazy" class="wp-image-138684 size-full" src="../Images/275592d656608159393e754e37cebc17.png" alt="Deploying the worker microservice" srcset="https://blog.logrocket.com/wp-content/uploads/2022/10/deploy-worker-microservice.png 730w, https://blog.logrocket.com/wp-content/uploads/2022/10/deploy-worker-microservice-211x300.png 211w, https://blog.logrocket.com/wp-content/uploads/2022/10/deploy-worker-microservice-722x1024.png 722w" sizes="(max-width: 730px) 100vw, 730px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/10/deploy-worker-microservice.png"/></noscript><figcaption id="caption-attachment-138684" class="wp-caption-text">Listing 3 (<a href="https://github.com/ashleydavis/nodejs-microservices-example/blob/main/scripts/kubernetes/worker.yaml">scripts/kubernetes/worker.yaml</a>). Kubernetes Yaml configuration file to deploy the worker microservice</figcaption></figure>
<p>在部署之前，我们必须展开清单3中的配置模板。为此，我们需要设置环境变量<code>CONTAINER_REGISTRY</code>和<code>VERSION</code>:</p>
<pre class="language-bash hljs">export CONTAINER_REGISTRY=&lt;url-to-your-container-registry&gt;
export VERSION=1
</pre>
<p>或者在Windows上，像这样:</p>
<pre class="language-bash hljs">set CONTAINER_REGISTRY=&lt;url-to-your-container-registry&gt;
set VERSION=1
</pre>
<p>现在我们可以对扩展进行试运行，看看结果。要运行<code>figit</code>，我们必须安装Node.js依赖项:</p>
<pre class="language-bash hljs">npm install
</pre>
<p>现在，我们可以展开YAML配置模板并查看结果:</p>
<pre class="language-bash hljs">npx figit ./scripts/kubernetes/worker.yaml
</pre>
<p>终端的输出应该显示配置中的<code>CONTAINER_REGISTRY</code>和<code>VERSION</code>已经被替换为环境变量的值。</p>
<h3 id="building-publishing-microservices">构建和发布微服务</h3>
<p>示例项目包括为每个微服务构建和发布Docker映像的shell脚本。</p>
<p>要构建每个微服务:</p>
<pre class="language-bash hljs">./scripts/build-image.sh worker
./scripts/build-image.sh gateway
</pre>
<p>不过，这些shell脚本不能在Windows上运行。如果您想在Windows上尝试一下，您可能想在WSL2下使用Linux终端或者直接调用<code>docker build</code>命令(查看shell脚本中的命令细节)。</p>
<p>要发布，您必须首先使用容器注册表的用户名和密码设置一些环境变量:</p>
<pre class="language-bash hljs">export REGISTRY_UN=&lt;container-registry-username&gt;
export REGISTRY_PW=&lt;container-registry-password&gt;
</pre>
<p>在Windows上，使用<code>set</code>命令而不是<code>export</code>。</p>
<p>然后，要将微服务的映像发布到容器注册表，请使用以下命令:</p>
<pre class="language-bash hljs">./scripts/publish-image.sh worker
./scripts/publish-image.sh gateway
</pre>
<p>随着微服务的构建和发布，我们现在可以部署它们了。</p>
<h3 id="deploying-microservices">部署微服务</h3>
<p>让我们将微服务部署到Kubernetes。为此，我们必须使用<code>figit</code>来扩展配置模板，并将扩展的配置传输到<code>kubectl</code>，将我们的微服务部署到Kubernetes集群:</p>
<pre class="language-yaml hljs">npx figit ./scripts/kubernetes/worker.yaml --output yaml | kubectl apply -f -

npx figit ./scripts/kubernetes/gateway.yaml --output yaml | kubectl apply -f -
</pre>
<p>为了检查部署，调用<code>kubectl get pods</code>和<code>kubectl get deployments </code>来查看我们对Kubernetes的部署是否成功。</p>
<p>一切进展顺利，我们的微服务现在应该在Kubernetes中运行。worker微服务是隐藏的，不可访问，但gateway微服务对全世界开放，因此我们可以从我们的web浏览器测试它。要找到IP地址，调用<code>kubectl get services</code>，在列表中查找<code>gateway</code>。将您的web浏览器导航到该IP地址，查看网关微服务的网页。</p>
<p>如果您想要更改代码并尝试部署某个微服务的更新版本，请确保在构建、发布和部署微服务之前增加您的<code>VERSION</code>环境变量。</p>
<h3 id="cleaning-kubernetes-cluster">清理Kubernetes集群</h3>
<p>这是我们部署的一次练习，以确保我们的部署流程在自动化之前能够正常工作。一会儿我们将在GitHub Actions下设置真正的部署。</p>
<p>首先，我们应该清理我们的Kubernetes集群，并删除我们在练习运行中部署的微服务:</p>
<pre class="language-yaml hljs">npx figit ./scripts/kubernetes/worker.yaml --output yaml | kubectl delete -f -

npx figit ./scripts/kubernetes/gateway.yaml --output yaml | kubectl delete -f -
</pre>
<h2 id="implementing-separate-cd-pipelines-github-actions">用GitHub动作实现独立的CD管道</h2>
<p>现在，最重要的是！在这最后一部分，我们使用GitHub Actions自动部署我们的微服务。</p>
<p>要亲自尝试，您需要:</p>

<p>最重要的部分是如何将每个GitHub Actions工作流限定到monorepo中每个子项目的子目录中。您可以在清单4 的<a href="https://github.com/ashleydavis/nodejs-microservices-example/blob/main/scripts/kubernetes/worker.yaml">中看到这是如何指定的。这使得monorepo中的每个微服务都有自己独立的CD管道。</a></p>
<p>您可以向这个monorepo添加任意多的微服务，但是它们都需要自己的工作流配置，其范围是monorepo中的子目录。</p>
<figure id="attachment_138687" aria-describedby="caption-attachment-138687" class="wp-caption aligncenter"><img data-attachment-id="138687" data-permalink="https://blog.logrocket.com/creating-separate-monorepo-ci-cd-pipelines-github-actions/attachment/github-actions-workflow-configuration/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/10/github-actions-workflow-configuration.png" data-orig-size="730,525" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="github-actions-workflow-configuration" data-image-description="" data-image-caption="&lt;p&gt;Listing 4 (extract from scripts/kubernetes/worker.yaml). The GitHub Actions workflow configuration for the worker microservice is scoped to its subdirectory in the monorepo&lt;/p&gt;&#10;" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/10/github-actions-workflow-configuration-300x216.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/10/github-actions-workflow-configuration.png" decoding="async" class="wp-image-138687 size-full jetpack-lazy-image" src="../Images/c0cecbc43a107c906dfff30d36454be0.png" alt="GitHub Actions workflow configuration" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2022/10/github-actions-workflow-configuration.png 730w, https://blog.logrocket.com/wp-content/uploads/2022/10/github-actions-workflow-configuration-300x216.png 300w" data-lazy-sizes="(max-width: 730px) 100vw, 730px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2022/10/github-actions-workflow-configuration.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/10/github-actions-workflow-configuration.png"/><noscript><img data-lazy-fallback="1" data-attachment-id="138687" data-permalink="https://blog.logrocket.com/creating-separate-monorepo-ci-cd-pipelines-github-actions/attachment/github-actions-workflow-configuration/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/10/github-actions-workflow-configuration.png" data-orig-size="730,525" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="github-actions-workflow-configuration" data-image-description="" data-image-caption="&lt;p&gt;Listing 4 (extract from scripts/kubernetes/worker.yaml). The GitHub Actions workflow configuration for the worker microservice is scoped to its subdirectory in the monorepo&lt;/p&gt;&#10;" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/10/github-actions-workflow-configuration-300x216.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/10/github-actions-workflow-configuration.png" decoding="async" loading="lazy" class="wp-image-138687 size-full" src="../Images/c0cecbc43a107c906dfff30d36454be0.png" alt="GitHub Actions workflow configuration" srcset="https://blog.logrocket.com/wp-content/uploads/2022/10/github-actions-workflow-configuration.png 730w, https://blog.logrocket.com/wp-content/uploads/2022/10/github-actions-workflow-configuration-300x216.png 300w" sizes="(max-width: 730px) 100vw, 730px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/10/github-actions-workflow-configuration.png"/></noscript><figcaption id="caption-attachment-138687" class="wp-caption-text">Listing 4 (extract from <a href="https://github.com/ashleydavis/nodejs-microservices-example/blob/main/scripts/kubernetes/worker.yaml">scripts/kubernetes/worker.yaml</a>). The GitHub Actions workflow configuration for the worker microservice is scoped to its subdirectory in the monorepo</figcaption></figure>
<h3 id="kubernetes-deployment-workflow-github-actions">GitHub操作的Kubernetes部署工作流</h3>
<p>上面的清单4 只是为了突出重要部分的摘录。<a href="https://github.com/ashleydavis/nodejs-microservices-example/blob/main/scripts/kubernetes/worker.yaml">下面的清单5 </a>展示了worker微服务的CD管道的完整工作流配置，包括:</p>
<ul>
<li>从GitHub Secrets设置环境变量；</li>
<li>建立和发布码头工人形象；</li>
<li>配置Kubectl，然后；</li>
<li>扩展Kubernetes部署配置模板并将worker微服务部署到Kubernetes</li>
</ul>
<figure id="attachment_138689" aria-describedby="caption-attachment-138689" class="wp-caption aligncenter"><img data-attachment-id="138689" data-permalink="https://blog.logrocket.com/creating-separate-monorepo-ci-cd-pipelines-github-actions/attachment/complete-github-actions-workflow-configuration/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/10/complete-GitHub-Actions-workflow-configuration.png" data-orig-size="730,953" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="complete-GitHub-Actions-workflow-configuration" data-image-description="" data-image-caption="&lt;p&gt;Listing 5 (the full scripts/kubernetes/worker.yaml). The complete GitHubActions workflow configuration for the worker microservice&lt;/p&gt;&#10;" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/10/complete-GitHub-Actions-workflow-configuration-230x300.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/10/complete-GitHub-Actions-workflow-configuration.png" decoding="async" class="wp-image-138689 size-full jetpack-lazy-image" src="../Images/02941bda9836c640eae1aa5bf1ffc0aa.png" alt="complete GitHubActions workflow configuration" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2022/10/complete-GitHub-Actions-workflow-configuration.png 730w, https://blog.logrocket.com/wp-content/uploads/2022/10/complete-GitHub-Actions-workflow-configuration-230x300.png 230w" data-lazy-sizes="(max-width: 730px) 100vw, 730px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2022/10/complete-GitHub-Actions-workflow-configuration.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/10/complete-GitHub-Actions-workflow-configuration.png"/><noscript><img data-lazy-fallback="1" data-attachment-id="138689" data-permalink="https://blog.logrocket.com/creating-separate-monorepo-ci-cd-pipelines-github-actions/attachment/complete-github-actions-workflow-configuration/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/10/complete-GitHub-Actions-workflow-configuration.png" data-orig-size="730,953" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="complete-GitHub-Actions-workflow-configuration" data-image-description="" data-image-caption="&lt;p&gt;Listing 5 (the full scripts/kubernetes/worker.yaml). The complete GitHubActions workflow configuration for the worker microservice&lt;/p&gt;&#10;" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/10/complete-GitHub-Actions-workflow-configuration-230x300.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/10/complete-GitHub-Actions-workflow-configuration.png" decoding="async" loading="lazy" class="wp-image-138689 size-full" src="../Images/02941bda9836c640eae1aa5bf1ffc0aa.png" alt="complete GitHubActions workflow configuration" srcset="https://blog.logrocket.com/wp-content/uploads/2022/10/complete-GitHub-Actions-workflow-configuration.png 730w, https://blog.logrocket.com/wp-content/uploads/2022/10/complete-GitHub-Actions-workflow-configuration-230x300.png 230w" sizes="(max-width: 730px) 100vw, 730px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/10/complete-GitHub-Actions-workflow-configuration.png"/></noscript><figcaption id="caption-attachment-138689" class="wp-caption-text">Listing 5 (the full <a href="https://github.com/ashleydavis/nodejs-microservices-example/blob/main/scripts/kubernetes/worker.yaml">scripts/kubernetes/worker.yaml</a>). The complete GitHubActions workflow configuration for the worker microservice</figcaption></figure>
<p>关于在GitHub动作中使用<code>kubectl-action</code>的更多信息，请<a href="https://github.com/marketplace/actions/kubernetes-cli-kubectl">参见文档</a>。</p>
<h3 id="setting-secrets-configuration-github-secrets">在GitHub Secrets中设置秘密和其他配置</h3>
<p>为了能够在GitHub Actions中运行每个微服务的工作流，我们必须将所需的环境变量添加到代码存储库的GitHub Secrets中。这些是我们之前在本地计算机上练习部署时设置的环境变量<code>CONTAINER_REGISTRY</code>、<code>REGISTRY_UN</code>和<code>REGISTRY_PW</code>。</p>
<p>不过，不要担心设置<code>VERSION</code>——这是在工作流配置中根据对代码库的最新更改的提交散列自动设置的。这是一个很好的方法来确保我们的Docker图像总是有一个新的版本号，我们不必担心手动增加它们。</p>
<p>图5显示了如何在代码库中设置GitHub秘密。</p>
<figure id="attachment_138691" aria-describedby="caption-attachment-138691" class="wp-caption aligncenter"><img data-attachment-id="138691" data-permalink="https://blog.logrocket.com/creating-separate-monorepo-ci-cd-pipelines-github-actions/attachment/configuring-workflow-github-secrets/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/10/configuring-workflow-github-secrets.png" data-orig-size="730,403" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="configuring-workflow-github-secrets" data-image-description="" data-image-caption="&lt;p&gt;Figure 5: Configuring your GitHub Actions workflow via GitHub Secrets&lt;/p&gt;&#10;" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/10/configuring-workflow-github-secrets-300x166.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/10/configuring-workflow-github-secrets.png" decoding="async" class="wp-image-138691 size-full jetpack-lazy-image" src="../Images/048037cbdbd8c7e4a7ce379d485196a6.png" alt="configuring workflow via GitHub secrets" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2022/10/configuring-workflow-github-secrets.png 730w, https://blog.logrocket.com/wp-content/uploads/2022/10/configuring-workflow-github-secrets-300x166.png 300w" data-lazy-sizes="(max-width: 730px) 100vw, 730px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2022/10/configuring-workflow-github-secrets.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/10/configuring-workflow-github-secrets.png"/><noscript><img data-lazy-fallback="1" data-attachment-id="138691" data-permalink="https://blog.logrocket.com/creating-separate-monorepo-ci-cd-pipelines-github-actions/attachment/configuring-workflow-github-secrets/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/10/configuring-workflow-github-secrets.png" data-orig-size="730,403" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="configuring-workflow-github-secrets" data-image-description="" data-image-caption="&lt;p&gt;Figure 5: Configuring your GitHub Actions workflow via GitHub Secrets&lt;/p&gt;&#10;" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/10/configuring-workflow-github-secrets-300x166.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/10/configuring-workflow-github-secrets.png" decoding="async" loading="lazy" class="wp-image-138691 size-full" src="../Images/048037cbdbd8c7e4a7ce379d485196a6.png" alt="configuring workflow via GitHub secrets" srcset="https://blog.logrocket.com/wp-content/uploads/2022/10/configuring-workflow-github-secrets.png 730w, https://blog.logrocket.com/wp-content/uploads/2022/10/configuring-workflow-github-secrets-300x166.png 300w" sizes="(max-width: 730px) 100vw, 730px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/10/configuring-workflow-github-secrets.png"/></noscript><figcaption id="caption-attachment-138691" class="wp-caption-text">Figure 5: Configuring your GitHub Actions workflow via GitHub Secrets</figcaption></figure>
<h3 id="invoking-deployments-manually-GitHub-UI">通过GitHub UI手动调用部署</h3>
<p>还有最后一件值得一提的事情:我们可以对GitHub Actions工作流配置做一个小小的更新，允许我们手动调用它。这在某些情况下非常有用，即使微服务的代码没有改变，也可以点击一个按钮来调用微服务的部署。</p>
<p>这样做的一个原因是当我们想通过GitHub Secrets重新配置一个环境变量时。更改环境变量的值不会自动触发重新部署，所以当我们这样做时，我们需要在部署管道中手动触发它。</p>
<p><a href="https://github.com/ashleydavis/nodejs-microservices-example/blob/main/scripts/kubernetes/worker.yaml">清单6 </a>显示了我们需要添加的内容，以便能够手动调用GitHub Actions工作流。在图6中，您可以看到我们如何通过GitHub Actions UI调用工作流来重新部署worker微服务。</p>
<figure id="attachment_138693" aria-describedby="caption-attachment-138693" class="wp-caption aligncenter"><img data-attachment-id="138693" data-permalink="https://blog.logrocket.com/creating-separate-monorepo-ci-cd-pipelines-github-actions/attachment/workflow-configured-manually-invocation/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/10/workflow-configured-manually-invocation.png" data-orig-size="730,442" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="workflow-configured-manually-invocation" data-image-description="" data-image-caption="&lt;p&gt;Listing 6 (extract from scripts/kubernetes/worker.yaml). A GitHub Actions workflow configured for manually invocation&lt;/p&gt;&#10;" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/10/workflow-configured-manually-invocation-300x182.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/10/workflow-configured-manually-invocation.png" decoding="async" class="wp-image-138693 size-full jetpack-lazy-image" src="../Images/06e11a9bc41a52d91e0a24ba01f77127.png" alt="workflow configured for manually invocation" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2022/10/workflow-configured-manually-invocation.png 730w, https://blog.logrocket.com/wp-content/uploads/2022/10/workflow-configured-manually-invocation-300x182.png 300w" data-lazy-sizes="(max-width: 730px) 100vw, 730px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2022/10/workflow-configured-manually-invocation.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/10/workflow-configured-manually-invocation.png"/><noscript><img data-lazy-fallback="1" data-attachment-id="138693" data-permalink="https://blog.logrocket.com/creating-separate-monorepo-ci-cd-pipelines-github-actions/attachment/workflow-configured-manually-invocation/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/10/workflow-configured-manually-invocation.png" data-orig-size="730,442" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="workflow-configured-manually-invocation" data-image-description="" data-image-caption="&lt;p&gt;Listing 6 (extract from scripts/kubernetes/worker.yaml). A GitHub Actions workflow configured for manually invocation&lt;/p&gt;&#10;" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/10/workflow-configured-manually-invocation-300x182.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/10/workflow-configured-manually-invocation.png" decoding="async" loading="lazy" class="wp-image-138693 size-full" src="../Images/06e11a9bc41a52d91e0a24ba01f77127.png" alt="workflow configured for manually invocation" srcset="https://blog.logrocket.com/wp-content/uploads/2022/10/workflow-configured-manually-invocation.png 730w, https://blog.logrocket.com/wp-content/uploads/2022/10/workflow-configured-manually-invocation-300x182.png 300w" sizes="(max-width: 730px) 100vw, 730px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/10/workflow-configured-manually-invocation.png"/></noscript><figcaption id="caption-attachment-138693" class="wp-caption-text">Listing 6 (extract from <a href="https://github.com/ashleydavis/nodejs-microservices-example/blob/main/scripts/kubernetes/worker.yaml">scripts/kubernetes/worker.yaml</a>). A GitHub Actions workflow configured for manually invocation</figcaption></figure>
<figure id="attachment_138697" aria-describedby="caption-attachment-138697" class="wp-caption aligncenter"><img data-attachment-id="138697" data-permalink="https://blog.logrocket.com/creating-separate-monorepo-ci-cd-pipelines-github-actions/attachment/github-ui/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/10/github-ui.png" data-orig-size="730,323" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="github-ui" data-image-description="" data-image-caption="&lt;p&gt;Figure 6: Manually invoking a GitHub Actions workflow (the CD pipeline for a microservice) through the GitHub UI&lt;/p&gt;&#10;" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/10/github-ui-300x133.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/10/github-ui.png" decoding="async" class="wp-image-138697 size-full jetpack-lazy-image" src="../Images/6e5362fa2a1a1a3532db38499d589637.png" alt="GitHub UI" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2022/10/github-ui.png 730w, https://blog.logrocket.com/wp-content/uploads/2022/10/github-ui-300x133.png 300w" data-lazy-sizes="(max-width: 730px) 100vw, 730px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2022/10/github-ui.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/10/github-ui.png"/><noscript><img data-lazy-fallback="1" data-attachment-id="138697" data-permalink="https://blog.logrocket.com/creating-separate-monorepo-ci-cd-pipelines-github-actions/attachment/github-ui/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/10/github-ui.png" data-orig-size="730,323" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="github-ui" data-image-description="" data-image-caption="&lt;p&gt;Figure 6: Manually invoking a GitHub Actions workflow (the CD pipeline for a microservice) through the GitHub UI&lt;/p&gt;&#10;" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/10/github-ui-300x133.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/10/github-ui.png" decoding="async" loading="lazy" class="wp-image-138697 size-full" src="../Images/6e5362fa2a1a1a3532db38499d589637.png" alt="GitHub UI" srcset="https://blog.logrocket.com/wp-content/uploads/2022/10/github-ui.png 730w, https://blog.logrocket.com/wp-content/uploads/2022/10/github-ui-300x133.png 300w" sizes="(max-width: 730px) 100vw, 730px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/10/github-ui.png"/></noscript><figcaption id="caption-attachment-138697" class="wp-caption-text">Figure 6: Manually invoking a GitHub Actions workflow (the CD pipeline for a microservice) through the GitHub UI</figcaption></figure>
<h2 id="trying-github-actions">亲自尝试GitHub操作</h2>
<p>现在您可以自己尝试GitHub操作了。在您这样做之前，您应该认真学习前面的部分，练习从您的开发计算机部署到Kubernetes。从本地计算机部署到Kubernetes有助于解决在GitHub操作下运行时更难解决的所有问题，因为您无法直接访问运行部署管道的计算机。</p>
<p>为此，您需要自己的GitHub帐户，然后为示例项目派生<a href="https://github.com/ashleydavis/nodejs-microservices-example">repo。</a></p>
<p>现在，将GitHub秘密添加到您的分叉存储库中，以设置<code>CONTAINER_REGISTRY</code>、<code>CONTAINER_UN</code>、<code>CONTAINER_PW</code>和<code>KUBE_CONFIG</code>。前面提到了前三个环境变量；新的<code>KUBE_CONFIG</code>是base64编码的Kubernetes配置，它配置<code>kubectl</code>来访问您的Kubernetes集群。</p>
<p>这很容易生成。如果您已经在本地配置了<code>kubectl</code>,您可以像这样编码您的本地配置:</p>
<pre class="language-bash hljs">cat ~/.kube/config | base64
</pre>
<p>然后从您的终端复制base64编码的配置，并将其放在<code>KUBE_CONFIG</code> secret中。</p>
<p>基本就是这样！</p>
<p>现在，您有两种方法来触发微服务的部署管道:</p>
<ol>
<li>为其中一个微服务推送代码更改</li>
<li>通过GitHub用户界面手动触发工作流</li>
</ol>
<p>当然，很多事情都可能出错——如果您以前没有做过，那么仅仅配置到Kubernetes的连接就很困难。这就是为什么在让您的部署管道在GitHub Actions中工作之前，您应该在本地进行实践。</p>
<h2>摘要</h2>
<p>使用monorepo是启动微服务项目的一种便捷方式，但通常，在很长时间内，我们必须将其分成多个repo，以便我们可以为我们的微服务创建独立的部署管道，从而获得微服务架构模式的全部好处。</p>
<p>然而，这篇博文展示了一种不同的方法。我们已经展示了如何使用GitHub Actions在monorepo中为微服务创建单独的CD管道，这意味着我们可以继续使用我们的monorepo，以及它提供的持续便利，更深入地进入我们的微服务项目的生命周期。</p><div class="code-block code-block-4">
<div class="blog-plug base-cta"><h2>使用<a class="signup" href="https://lp.logrocket.com/blg/signup" target="_blank" rel="noopener noreferrer"> LogRocket </a>消除传统错误报告的干扰</h2>
<a href="https://lp.logrocket.com/blg/signup" class="signup" target="_blank" rel="noopener noreferrer"><img class="alignnone size-full wp-image-46 jetpack-lazy-image" src="../Images/d6f5a5dd739296c1dd7aab3d5e77eeb9.png" alt="LogRocket Dashboard Free Trial Banner" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2017/03/1d0cd-1s_rmyo6nbrasp-xtvbaxfg.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2017/03/1d0cd-1s_rmyo6nbrasp-xtvbaxfg.png"/><noscript><img data-lazy-fallback="1" class="alignnone size-full wp-image-46" src="../Images/d6f5a5dd739296c1dd7aab3d5e77eeb9.png" alt="LogRocket Dashboard Free Trial Banner" data-original-src="https://blog.logrocket.com/wp-content/uploads/2017/03/1d0cd-1s_rmyo6nbrasp-xtvbaxfg.png"/></noscript></a>
<p><a href="https://lp.logrocket.com/blg/signup" target="_blank" rel="noopener noreferrer"> LogRocket </a>是一个数字体验分析解决方案，它可以保护您免受数百个假阳性错误警报的影响，只针对几个真正重要的项目。LogRocket会告诉您应用程序中实际影响用户的最具影响力的bug和UX问题。</p>
<p>然后，使用具有深层技术遥测的会话重放来确切地查看用户看到了什么以及是什么导致了问题，就像你在他们身后看一样。</p>
<p>LogRocket自动聚合客户端错误、JS异常、前端性能指标和用户交互。然后LogRocket使用机器学习来告诉你哪些问题正在影响大多数用户，并提供你需要修复它的上下文。</p>
<p>关注重要的bug—<a class="signup" href="https://lp.logrocket.com/blg/signup-issue-free" target="_blank" rel="noopener noreferrer">今天就试试LogRocket】。</a></p></div></div>

<p class="clearfix"/>
<p class="clearfix"/>
</article>

</div>    
</body>
</html>