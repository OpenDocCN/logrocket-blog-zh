<html>
<head>
<title>Reduce cumulative layout shift in Docusaurus with fontaine </title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>用fontaine减少Docusaurus的累积布局偏移</h1>
<blockquote>原文：<a href="https://blog.logrocket.com/docusaurus-using-fontaine-reduce-cumulative-layout-shift/#0001-01-01">https://blog.logrocket.com/docusaurus-using-fontaine-reduce-cumulative-layout-shift/#0001-01-01</a></blockquote><div><article class="article-post">
<p>自定义字体的使用会给你的网站带来累积的布局变化。这篇文章展示了如何使用<a href="https://github.com/unjs/fontaine">枫丹白露</a>来减少与<a href="https://blog.logrocket.com/easy-documentation-with-docusaurus/"> Docusaurus </a>网站的冲突，并将涵盖:</p>

<h2 id="what-is-cumulative-layout-shift">什么是累积布局偏移？</h2>
<p>累积布局偏移(CLS)是一种衡量网页内容不稳定性的指标。这是一个核心网络指标。</p>
<p>你可能知道它叫“jank”。当一个页面加载并且文本移动时，你看到的是jank，这是一个很大的烦恼。在主题为的<a href="https://web.dev/cls/">这篇文章中有关于它的精彩描述；我在这里引用一下:</a></p>
<blockquote><p>你是否曾经在网上阅读一篇文章时，页面上的内容突然发生了变化？没有警告，文本移动，你已经失去了你的位置。或者更糟:你正要点击一个链接或一个按钮，但是在你手指落地的瞬间——嘣——链接移动了，你最终点击了别的东西！</p></blockquote>
<p>简而言之，这就是jank它让最终用户非常沮丧，也是我们作为开发人员应该尽力避免的问题！</p>
<p>在这篇文章的其余部分，我通常称CLS为詹克，因为这是一个更贴切的称呼。</p>
<h2 id="what-jank-looks-like">“jank”长什么样</h2>
<p>我的博客使用了一种叫做<a href="https://fonts.google.com/specimen/Poppins"> Poppins </a>的自定义字体。虽然很可爱，使用字体介绍jank到我的网站。在手机上特别明显。这是jank在行动中的gif:</p>
<p><img data-attachment-id="141172" data-permalink="https://blog.logrocket.com/docusaurus-using-fontaine-reduce-cumulative-layout-shift/attachment/my-jank-3/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/11/my-jank-3.gif" data-orig-size="730,766" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="my-jank" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/11/my-jank-3-286x300.gif" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/11/my-jank-3.gif" decoding="async" class="aligncenter wp-image-141172 size-full jetpack-lazy-image" src="../Images/5642cd35346b8f8e2a3b1cabe691c511.png" alt="My Jank" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2022/11/my-jank-3.gif?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/11/my-jank-3.gif"/></p><noscript><img data-lazy-fallback="1" data-attachment-id="141172" data-permalink="https://blog.logrocket.com/docusaurus-using-fontaine-reduce-cumulative-layout-shift/attachment/my-jank-3/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/11/my-jank-3.gif" data-orig-size="730,766" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="my-jank" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/11/my-jank-3-286x300.gif" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/11/my-jank-3.gif" decoding="async" loading="lazy" class="aligncenter wp-image-141172 size-full" src="../Images/5642cd35346b8f8e2a3b1cabe691c511.png" alt="My Jank" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/11/my-jank-3.gif"/></noscript>
<p>当自定义字体到达时，您看到文本是如何移动的了吗？在第一行，我们可以看到:</p>
<ul>
<li>在一行上呈现四个单词的后退字体:<em>“二头肌:静态网络应用”</em></li>
</ul>
<p>…或者:</p>
<ul>
<li>自定义字体(Poppins)在一行上呈现三个单词:<em>“二头肌:静态网页”</em></li>
</ul>
<p>它非常引人注目——如此引人注目，你甚至可以用一个数字来表示它。</p>
<p>这个数字就是CLS分数，你可以用<a href="https://developer.chrome.com/docs/lighthouse/overview/">灯塔</a>来确定。CLS分数是页面上发生的布局变化的总和。分数越高，jank就越多。对于上一页，累积布局移动被记录为<strong> 0.019 </strong>。</p>
<p>这可不好。</p>
<p>我采取了一些措施来减少遇到的问题，如<a href="../2021-12-29-preload-fonts-with-docusaurus/index.md">字体预加载</a>，但问题仍然存在——特别是在移动网络上，加载速度下降，自定义字体加载需要更长的时间。</p>
<p>我宁愿放弃进一步改进事情。但是后来…</p>
<h2 id="fontaine">介绍方丹</h2>
<p>一天晚上，我漫不经心地浏览Twitter，突然看到丹尼尔·罗发来的一条推文，称T2发布了一款名为fontaine的新工具:</p>
<p><img data-attachment-id="140816" data-permalink="https://blog.logrocket.com/docusaurus-using-fontaine-reduce-cumulative-layout-shift/attachment/screenshot-tweet-about-fontaine-copy/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/11/screenshot-tweet-about-fontaine-copy.png" data-orig-size="730,1079" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="screenshot-tweet-about-fontaine copy" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/11/screenshot-tweet-about-fontaine-copy-203x300.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/11/screenshot-tweet-about-fontaine-copy-693x1024.png" decoding="async" class="aligncenter wp-image-140816 size-full jetpack-lazy-image" src="../Images/37890a60a4a0313a6988978fbd014621.png" alt="Screenshot Tweet About Fontaine" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2022/11/screenshot-tweet-about-fontaine-copy.png 730w, https://blog.logrocket.com/wp-content/uploads/2022/11/screenshot-tweet-about-fontaine-copy-203x300.png 203w, https://blog.logrocket.com/wp-content/uploads/2022/11/screenshot-tweet-about-fontaine-copy-693x1024.png 693w" data-lazy-sizes="(max-width: 730px) 100vw, 730px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2022/11/screenshot-tweet-about-fontaine-copy.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/11/screenshot-tweet-about-fontaine-copy.png"/></p><noscript><img data-lazy-fallback="1" data-attachment-id="140816" data-permalink="https://blog.logrocket.com/docusaurus-using-fontaine-reduce-cumulative-layout-shift/attachment/screenshot-tweet-about-fontaine-copy/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/11/screenshot-tweet-about-fontaine-copy.png" data-orig-size="730,1079" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="screenshot-tweet-about-fontaine copy" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/11/screenshot-tweet-about-fontaine-copy-203x300.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/11/screenshot-tweet-about-fontaine-copy-693x1024.png" decoding="async" loading="lazy" class="aligncenter wp-image-140816 size-full" src="../Images/37890a60a4a0313a6988978fbd014621.png" alt="Screenshot Tweet About Fontaine" srcset="https://blog.logrocket.com/wp-content/uploads/2022/11/screenshot-tweet-about-fontaine-copy.png 730w, https://blog.logrocket.com/wp-content/uploads/2022/11/screenshot-tweet-about-fontaine-copy-203x300.png 203w, https://blog.logrocket.com/wp-content/uploads/2022/11/screenshot-tweet-about-fontaine-copy-693x1024.png 693w" sizes="(max-width: 730px) 100vw, 730px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/11/screenshot-tweet-about-fontaine-copy.png"/></noscript>
<p>我很好奇。我想尝试一下。我想看看使用这个工具是否能减少我博客上的恶作剧。</p>
<h2 id="using-fontaine-with-docusaurus">对Docusaurus使用fontaine</h2>
<p>我把方丹作为一个附属品添加到我的博客中:</p>
<pre class="bash language-bash">yarn add -D fontaine
</pre>
<p>然后我打开我的<code>docusaurus.config.js</code>文件，写了一个小插件来使用fontaine:</p>
<pre class="js language-js">const fontaine = require('fontaine');

// ...

/** @type {import('@docusaurus/types').Config} */
const config = {
  // ...

  plugins: [
    // ...
    function fontainePlugin(_context, _options) {
      return {
        name: 'fontaine-plugin',
        configureWebpack(_config, _isServer) {
          return {
            plugins: [
              fontaine.fontaineTransform.webpack({
                fallbacks: [
                  'system-ui',
                  '-apple-system',
                  'BlinkMacSystemFont',
                  'Segoe UI',
                  'Roboto',
                  'Oxygen',
                  'Ubuntu',
                  'Cantarell',
                  'Open Sans',
                  'Helvetica Neue',
                  'sans-serif',
                ],
                // You may need to resolve assets like `/fonts/Poppins-Bold.ttf` to a particular directory
                resolvePath: (id) =&gt; '../fonts/' + id,
              }),
            ],
          };
        },
      };
    },
    // ...
  ],
  // ...
};
</pre>
<p>这最初似乎没有什么不同，所以我把它作为一份正在进行的公关工作，尽我所能写下我的发现。丹尼尔好心来看一下。他发现了两个问题:</p>
<ul>
<li>fontaine在处理CSS变量的方式上有一个错误，为此<a href="https://github.com/unjs/fontaine/commit/a708bb07ccc48f385c67ccc3b1eed280d8ee47fc">他实现了一个修复</a></li>
<li>Docusaurus通过CSS变量的机制使用自定义字体。这种间接性使fontaine感到困惑，因为它无法读取这些变量。为了适应这种情况，我们需要更新我的CSS变量，将覆盖字体系列添加到CSS变量中:</li>
</ul>
<pre class="diff language-diff">-  --ifm-font-family-base: 'Poppins';
+  --ifm-font-family-base: 'Poppins', 'Poppins override';
</pre>
<p>在幕后，方丹创造了一个“Poppins override”<code>@font-face</code>规则。通过手动将这个override字体系列添加到我们的CSS变量中，我们使我们的站点使用回退的“Poppins override”<code>@font-face</code>规则和finding生成的正确字体度量。</p>
<p>值得强调的是，对于方丹的典型用户来说，这并不是他们需要做的事情。这只对Docusaurus用户有必要，因为他们通过CSS变量使用自定义字体。使用fontaine对大多数用户来说是非常即插即用的。</p>
<p>丹尼尔很友好地提出了一份包含这两个调整的公关。当我合并该PR时，我看到了以下内容:</p>
<p><img data-attachment-id="141177" data-permalink="https://blog.logrocket.com/docusaurus-using-fontaine-reduce-cumulative-layout-shift/attachment/my-jank-fixed-1-2/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/11/my-jank-fixed-1-1.gif" data-orig-size="730,766" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="my-jank-fixed-1" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/11/my-jank-fixed-1-1-286x300.gif" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/11/my-jank-fixed-1-1.gif" decoding="async" class="aligncenter wp-image-141177 size-full jetpack-lazy-image" src="../Images/cb0e708351a5c8cf4fa32f890f78b8c4.png" alt="My Jank Fixed" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2022/11/my-jank-fixed-1-1.gif?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/11/my-jank-fixed-1-1.gif"/></p><noscript><img data-lazy-fallback="1" data-attachment-id="141177" data-permalink="https://blog.logrocket.com/docusaurus-using-fontaine-reduce-cumulative-layout-shift/attachment/my-jank-fixed-1-2/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/11/my-jank-fixed-1-1.gif" data-orig-size="730,766" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="my-jank-fixed-1" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/11/my-jank-fixed-1-1-286x300.gif" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/11/my-jank-fixed-1-1.gif" decoding="async" loading="lazy" class="aligncenter wp-image-141177 size-full" src="../Images/cb0e708351a5c8cf4fa32f890f78b8c4.png" alt="My Jank Fixed" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/11/my-jank-fixed-1-1.gif"/></noscript>
<p>看那个！你可以看到字体加载，但没有更多的字从一行跳到另一行。这是一个巨大的进步！</p>
<h2 id="conclusion">结论</h2>
<p>如果你想提高你的CLS分数，方丹是一个很好的工具。</p>
<p>这篇文章演示了如何在Docusaurus中使用它，但是请注意，这是一个普遍有用的工具，您可以在Vite、Next.js和其他工具中使用它——它并不特定于Docusaurus。</p>
<p>在使用fontaine之前，我的博客的累积布局偏移记录为0.019。合并后，相同的分数记录为0。这是好消息！</p>
<p>我非常感谢丹尼尔帮助我的博客。他超越了一切，所以谢谢你，丹尼尔！</p>
<p>证明了方丹是建立在多么伟大的理念之上；在我写这篇文章的时间里，<a href="https://nextjs.org/blog/next-13#nextfont"> <code>@next/font</code> </a>已经宣布，这是基于类似的想法。</p><div class="code-block code-block-17">
<div class="blog-plug inline-plug react-plug" vwo-el-id="26283398190">
<h2 vwo-el-id="41600691720">使用LogRocket消除传统反应错误报告的噪音</h2>
<a href="https://lp.logrocket.com/blg/react-signup-issue-free" target="_blank" vwo-el-id="19356441070">LogRocket
</a><p>是一款React analytics解决方案，可保护您免受数百个误报错误警报的影响，只针对少数真正重要的项目。LogRocket告诉您React应用程序中实际影响用户的最具影响力的bug和UX问题。</p><a class="signup" href="https://lp.logrocket.com/blg/react-signup-general" target="_blank" rel="noopener noreferrer" vwo-el-id="19356441380">
<img class="first-react-image alignnone size-full wp-image-46 jetpack-lazy-image jetpack-lazy-image--handled" src="../Images/f300c244a1a1cf916df8b4cb02bec6c6.png" vwo-el-id="18272717540" data-lazy-loaded="1" data-original-src="https://files.readme.io/27c94e7-Image_2017-06-05_at_9.46.04_PM.png"/>
</a>
<a class="signup" href="https://lp.logrocket.com/blg/react-signup-general" target="_blank" rel="noopener noreferrer" vwo-el-id="19356441690">
<img class="second-react-image alignnone size-full wp-image-46 jetpack-lazy-image jetpack-lazy-image--handled" src="../Images/d6f5a5dd739296c1dd7aab3d5e77eeb9.png" alt="LogRocket Dashboard Free Trial Banner" vwo-el-id="30720362350" data-lazy-loaded="1" data-original-src="https://blog.logrocket.com/wp-content/uploads/2017/03/1d0cd-1s_rmyo6nbrasp-xtvbaxfg.png"/>
</a>
<a href="https://lp.logrocket.com/blg/react-signup-issue-free" target="_blank" rel="noopener noreferrer" vwo-el-id="35866400580">LogRocket
</a><p>自动聚合客户端错误、反应错误边界、还原状态、缓慢的组件加载时间、JS异常、前端性能指标和用户交互。然后，LogRocket使用机器学习来通知您影响大多数用户的最具影响力的问题，并提供您修复它所需的上下文。</p><p vwo-el-id="28675661060">关注重要的React bug—<a class="signup" href="https://lp.logrocket.com/blg/react-signup-issue-free" target="_blank" rel="noopener noreferrer" vwo-el-id="40093418840">今天就试试LogRocket】。</a></p>
</div></div>

<p class="clearfix"/>
<p class="clearfix"/>
</article>

</div>    
</body>
</html>