<html>
<head>
<title>Continuous deployment of React Native app with Azure DevOps - LogRocket Blog</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>使用 Azure DevOps 持续部署 React 原生应用程序- LogRocket 博客</h1>
<blockquote>原文：<a href="https://blog.logrocket.com/continuous-deployment-of-react-native-app-with-azure-devops/#0001-01-01">https://blog.logrocket.com/continuous-deployment-of-react-native-app-with-azure-devops/#0001-01-01</a></blockquote><div><article class="article-post">
<h2>在 React Native 中部署您的应用</h2>
<p>部署是软件开发工作流程的一部分，很容易实现自动化。自动化部署可以消除许多错误，让您专注于重要的事情。</p>
<p>在 React Native 中，你通常必须在两个平台上部署应用程序:Android 和 iOS。两个平台使用不同的语言和构建工具。在本教程中，我们将通过<a href="https://azure.microsoft.com/en-us/services/devops/" target="_blank" rel="noopener"> Azure DevOps </a>在<a href="https://appcenter.ms/" target="_blank" rel="noopener"> App Center </a>上构建一个 React 原生应用的持续部署管道。</p>
<h2>设置您的 React 本地项目</h2>
<p>首先，您需要设置一个 React 原生项目。遵循<a href="https://reactnative.dev/docs/environment-setup" target="_blank" rel="noopener"> React Native 的官方安装指南</a>并使用以下命令引导项目:</p>
<pre>npx react-native init MyProject
</pre>
<p>以上命令完成后，使用以下命令导航到新创建的项目目录:</p>
<pre>cd MyProject
</pre>
<p>然后，使用<code>yarn android</code>构建项目——如果你安装了 Android 或者如果你想在 iOS 上测试它，使用<code>yarn ios</code>。构建完成后，您应该会看到以下屏幕:</p>
<p><img data-attachment-id="37759" data-permalink="https://blog.logrocket.com/continuous-deployment-of-react-native-app-with-azure-devops/welcome-to-react-screen/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2021/03/welcome-to-react-screen.png" data-orig-size="397,750" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Welcome to React screen" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2021/03/welcome-to-react-screen-159x300.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2021/03/welcome-to-react-screen.png" decoding="async" class="aligncenter size-full wp-image-37759 jetpack-lazy-image" src="../Images/aacb81ad0c6d77c2a3cea5736f1f9aab.png" alt="Welcome to React Screen" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2021/03/welcome-to-react-screen.png 397w, https://blog.logrocket.com/wp-content/uploads/2021/03/welcome-to-react-screen-159x300.png 159w" data-lazy-sizes="(max-width: 397px) 100vw, 397px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2021/03/welcome-to-react-screen.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2021/03/welcome-to-react-screen.png"/></p><noscript><img data-lazy-fallback="1" data-attachment-id="37759" data-permalink="https://blog.logrocket.com/continuous-deployment-of-react-native-app-with-azure-devops/welcome-to-react-screen/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2021/03/welcome-to-react-screen.png" data-orig-size="397,750" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Welcome to React screen" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2021/03/welcome-to-react-screen-159x300.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2021/03/welcome-to-react-screen.png" decoding="async" loading="lazy" class="aligncenter size-full wp-image-37759" src="../Images/aacb81ad0c6d77c2a3cea5736f1f9aab.png" alt="Welcome to React Screen" srcset="https://blog.logrocket.com/wp-content/uploads/2021/03/welcome-to-react-screen.png 397w, https://blog.logrocket.com/wp-content/uploads/2021/03/welcome-to-react-screen-159x300.png 159w" sizes="(max-width: 397px) 100vw, 397px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2021/03/welcome-to-react-screen.png"/></noscript>
<p>现在我们需要将代码推送到 Azure DevOps。前往 Azure DevOps，在那里使用官方指南创建一个新项目。</p>
<p>我们需要将项目代码推送到这个项目的 Git repo。在项目目录中，运行以下命令:</p>
<pre>git remote add origin &lt;YOUR_AZURE_DEVOPS_REPO_URL&gt;
git push -u origin --all
</pre>
<p>一旦您的代码被推送到 Azure DevOps，我们需要在编写部署脚本之前注意一些事情。首先，我们需要更改 Android 的 gradle 文件，以便它可以将来自命令行的构建参数作为参数。然后，我们需要将所有的 Android/iOS 证书和密钥上传到 Azure DevOps。在回购中保守秘密从来都不是一个好的做法。</p>
<h2>在 Android 中更改 gradle 文件</h2>
<p>在您的<code>android/build.gradle</code>文件中执行以下更改:</p>
<pre>diff --git a/android/build.gradle b/android/build.gradle
index ed5a568..5cfd558 100644
--- a/android/build.gradle
+++ b/android/build.gradle
@@ -1,11 +1,25 @@
 // Top-level build file where you can add configuration options common to all sub-projects/modules.

 buildscript {
+
+    def getMyVersionCode = { -&gt;
+        def code = project.hasProperty('versionCode') ? versionCode.toInteger() : 1
+        println "VersionCode is set to $code"
+        return code
+    }
+
+    def getMyVersionName = { -&gt;
+        def name = project.hasProperty('versionName') ? versionName : "1.0"
+        println "VersionName is set to $name"
+        return name
+    }
     ext {
         buildToolsVersion = "29.0.2"
         minSdkVersion = 16
         compileSdkVersion = 29
-        targetSdkVersion = 29
+        targetSdkVersion = 29       
+        versionName = getMyVersionName()
+        versionCode = getMyVersionCode()
     }
     repositories {
         google()
</pre>
<p>接下来，在您的<code>android/app/build.gradle</code>文件中添加以下更改:</p>
<pre>diff --git a/android/app/build.gradle b/android/app/build.gradle
index 64f4347..5774b17 100644
--- a/android/app/build.gradle
+++ b/android/app/build.gradle
@@ -132,8 +132,8 @@ android {
         applicationId "com.myproject"
         minSdkVersion rootProject.ext.minSdkVersion
         targetSdkVersion rootProject.ext.targetSdkVersion
-        versionCode 1
-        versionName "1.0"
+        versionCode rootProject.ext.versionCode
+        versionName rootProject.ext.versionName
     }
     splits {
         abi {
</pre>
<h2>向 Azure DevOps 添加秘密</h2>
<p>首先，按照<a href="https://reactnative.dev/docs/signed-apk-android#generating-an-upload-key" target="_blank" rel="noopener"> React Native 的官方指南创建一个生产签名密钥</a>，并获得一个<code>.keystore</code>文件和凭证。其次，使用您的 Apple 帐户生成 iOS 凭据(预置描述文件和签名证书)。进入<strong> Azure DevOps →您的项目→管道→库</strong>，创建一个新的变量组，如下图所示:</p>
<p><img data-attachment-id="37760" data-permalink="https://blog.logrocket.com/continuous-deployment-of-react-native-app-with-azure-devops/variable-group-highlighted/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2021/03/variable-group-highlighted.png" data-orig-size="730,404" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Variable group highlighted" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2021/03/variable-group-highlighted-300x166.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2021/03/variable-group-highlighted.png" decoding="async" class="aligncenter size-full wp-image-37760 jetpack-lazy-image" src="../Images/efe6a7b874cd3e4403c9f9ac5d81998c.png" alt="Variable Group Highlighted" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2021/03/variable-group-highlighted.png 730w, https://blog.logrocket.com/wp-content/uploads/2021/03/variable-group-highlighted-300x166.png 300w" data-lazy-sizes="(max-width: 730px) 100vw, 730px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2021/03/variable-group-highlighted.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2021/03/variable-group-highlighted.png"/></p><noscript><img data-lazy-fallback="1" data-attachment-id="37760" data-permalink="https://blog.logrocket.com/continuous-deployment-of-react-native-app-with-azure-devops/variable-group-highlighted/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2021/03/variable-group-highlighted.png" data-orig-size="730,404" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Variable group highlighted" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2021/03/variable-group-highlighted-300x166.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2021/03/variable-group-highlighted.png" decoding="async" loading="lazy" class="aligncenter size-full wp-image-37760" src="../Images/efe6a7b874cd3e4403c9f9ac5d81998c.png" alt="Variable Group Highlighted" srcset="https://blog.logrocket.com/wp-content/uploads/2021/03/variable-group-highlighted.png 730w, https://blog.logrocket.com/wp-content/uploads/2021/03/variable-group-highlighted-300x166.png 300w" sizes="(max-width: 730px) 100vw, 730px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2021/03/variable-group-highlighted.png"/></noscript>
<p><img data-attachment-id="37761" data-permalink="https://blog.logrocket.com/continuous-deployment-of-react-native-app-with-azure-devops/variables-section-highlighted/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2021/03/variables-section-highlighted.png" data-orig-size="730,416" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Variables section highlighted" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2021/03/variables-section-highlighted-300x171.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2021/03/variables-section-highlighted.png" decoding="async" class="aligncenter size-full wp-image-37761 jetpack-lazy-image" src="../Images/0bc8c69e57b9433f517e291764e42d5e.png" alt="Variables Section Highlighted" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2021/03/variables-section-highlighted.png 730w, https://blog.logrocket.com/wp-content/uploads/2021/03/variables-section-highlighted-300x171.png 300w" data-lazy-sizes="(max-width: 730px) 100vw, 730px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2021/03/variables-section-highlighted.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2021/03/variables-section-highlighted.png"/></p><noscript><img data-lazy-fallback="1" data-attachment-id="37761" data-permalink="https://blog.logrocket.com/continuous-deployment-of-react-native-app-with-azure-devops/variables-section-highlighted/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2021/03/variables-section-highlighted.png" data-orig-size="730,416" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Variables section highlighted" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2021/03/variables-section-highlighted-300x171.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2021/03/variables-section-highlighted.png" decoding="async" loading="lazy" class="aligncenter size-full wp-image-37761" src="../Images/0bc8c69e57b9433f517e291764e42d5e.png" alt="Variables Section Highlighted" srcset="https://blog.logrocket.com/wp-content/uploads/2021/03/variables-section-highlighted.png 730w, https://blog.logrocket.com/wp-content/uploads/2021/03/variables-section-highlighted-300x171.png 300w" sizes="(max-width: 730px) 100vw, 730px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2021/03/variables-section-highlighted.png"/></noscript>
<p>接下来进入<strong> Azure DevOps →你的项目→ Pipelines →库</strong>上传 iOS 签名证书和 provision profile，以及 Android 的签名密钥，如下图截图所示:</p>
<p><img data-attachment-id="37762" data-permalink="https://blog.logrocket.com/continuous-deployment-of-react-native-app-with-azure-devops/secure-file-button/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2021/03/secure-file-button.png" data-orig-size="730,417" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Secure file button" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2021/03/secure-file-button-300x171.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2021/03/secure-file-button.png" decoding="async" class="aligncenter size-full wp-image-37762 jetpack-lazy-image" src="../Images/330a137f96df5cd5a6533968fa6d7b20.png" alt="Secure File Button" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2021/03/secure-file-button.png 730w, https://blog.logrocket.com/wp-content/uploads/2021/03/secure-file-button-300x171.png 300w" data-lazy-sizes="(max-width: 730px) 100vw, 730px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2021/03/secure-file-button.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2021/03/secure-file-button.png"/></p><noscript><img data-lazy-fallback="1" data-attachment-id="37762" data-permalink="https://blog.logrocket.com/continuous-deployment-of-react-native-app-with-azure-devops/secure-file-button/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2021/03/secure-file-button.png" data-orig-size="730,417" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Secure file button" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2021/03/secure-file-button-300x171.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2021/03/secure-file-button.png" decoding="async" loading="lazy" class="aligncenter size-full wp-image-37762" src="../Images/330a137f96df5cd5a6533968fa6d7b20.png" alt="Secure File Button" srcset="https://blog.logrocket.com/wp-content/uploads/2021/03/secure-file-button.png 730w, https://blog.logrocket.com/wp-content/uploads/2021/03/secure-file-button-300x171.png 300w" sizes="(max-width: 730px) 100vw, 730px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2021/03/secure-file-button.png"/></noscript>
<h2>编写 Azure 部署管道脚本</h2>
<p>现在，我们都设置了必要的配置。让我们开始编写 Azure 管道脚本。</p>
<p>在项目的根目录下，创建一个新文件:</p>
<pre>touch azure-pipelines.yml
</pre>
<p>在这个文件中，首先，我们将告诉脚本应该何时执行。我将在主分支上的每次提交时触发它。有许多方法可以触发脚本。基于分支名称，或者当新标签被推送时，等等。可能性是无穷的。在官方文件中有一个你可以使用的触发器的综合<a href="https://docs.microsoft.com/en-us/azure/devops/pipelines/build/triggers?view=azure-devops" target="_blank" rel="noopener">列表。将以下几行添加到文件中:</a></p>
<pre>trigger:
  branches:
    include:
      - master
</pre>
<p>之后，我们需要定义我们将使用我们刚刚在<strong>管道→库</strong>中设置的环境变量和安全文件。在当前文件的末尾添加以下几行:</p>
<pre>variables:
  - group: Mobile # change it to the name you have set
</pre>
<p>现在让我们告诉操作系统我们想要运行这个脚本。因为 iOS 只能在 MacOS 上构建，而 Android 可以在所有平台上构建，所以最好只使用 MacOS，因为它可以适应两种平台。在当前文件的末尾添加以下几行:</p>
<pre>pool:
  vmImage: 'macos-latest'
</pre>
<p>请一个接一个地遵循这些步骤:</p>
<ol>
<li><strong>结帐</strong>:回购的结帐代码。<pre>- checkout: self     persistCredentials: true     clean: true</pre></li>
<li><strong>安装节点</strong>:安装所需版本的<a href="https://nodejs.org/" target="_blank" rel="noopener"> Node.js </a>。<pre>- task: <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="ce80a1aaab9aa1a1a28efe">[email protected]</a>     displayName: 'Install Node'     inputs:       versionSpec: '12.19.0' # you can use your desired version here</pre></li>
<li><strong>安装依赖项</strong>:安装<code>package.json</code>中列出的依赖项。<pre>- script: yarn install     displayName: Install Dependencies</pre></li>
<li><strong>碰撞版本并设置变量</strong>:碰撞<code>package.json</code>中的<code>version</code>，并将该版本设置为环境变量，作为构建版本在后面的步骤中使用。<pre>- script: |       # Disable autocommit on version bump        yarn config set version-sign-git-tag false       yarn config set version-git-tag false       yarn config set version-commit-hooks false       # Checkout branch where the build is triggered       git checkout $(Build.SourceBranchName)       # Extract existing version of package.json       oldVer=$(jq -r ".version" package.json)       # Bump version       yarn version --patch       # Add bumped version to staging       git add *       # Extract new version of package.json       newVer=$(jq -r ".version" package.json)       # Set environment variables       echo "##vso[task.setvariable variable=OLD_VERSION]$oldVer"       echo "##vso[task.setvariable variable=NEW_VERSION]$newVer"     displayName: 'Bump version and set variables'</pre></li>
<li><strong>凹凸 iOS 版本</strong>:iOS 项目中的凹凸版本。<pre>- task: <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="d1b8bea2fcb3a4bfb5bdb4fca7b4a3a2b8bebf91e0">[email protected]</a>     displayName: 'Bump iOS version'     inputs:       sourcePath: 'ios/MyProject/Info.plist'       versionCodeOption: 'buildid'       versionCode: '$(Build.BuildId)'       versionName: '$(NEW_VERSION)'       printFile: false</pre></li>
<li><strong>构建未签名的 APK </strong>:构建未签名的 APK。签名将在下一步完成。您可以看到我们是如何将<code>NEW_VERSION</code>作为参数传递给 Gradle 构建脚本的。<pre>- task: <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="9ed9ecfffaf2fbdeac">[email protected]</a>     displayName: 'Build APK'     inputs:       gradleWrapperFile: 'android/gradlew'       workingDirectory: 'android/'       options: '-PversionName=$(NEW_VERSION) -PversionCode=$(Build.BuildId)'       tasks: 'assembleRelease'       publishJUnitResults: false       javaHomeOption: 'JDKVersion'       jdkVersionOption: '1.8'       gradleOptions: '-Xmx3072m'       sonarQubeRunAnalysis: false</pre></li>
<li><strong>签署 APK </strong>:使用我们存储在<strong>管道→库</strong>中的密钥库文件和密码签署 APK。<code>AndroidKeyStorePassword</code>、<code>AndroidKeyAlias</code>、<code>AndroidKeyAliasPassword</code>来自图书馆。确保这些名称与您在库中设置相匹配。<pre>- task: <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="fbba959f8994929fa8929c9592959cbbc8">[email protected]</a>     displayName: 'Sign APK'     inputs:       apkFiles: 'android/app/build/outputs/apk/release/*.apk'       apksignerKeystoreFile: 'mobile-prod.keystore'       apksignerKeystorePassword: '$(AndroidKeyStorePassword)'       apksignerKeystoreAlias: '$(AndroidKeyAlias)'       apksignerKeyPassword: '$(AndroidKeyAliasPassword)'       zipalign: true</pre></li>
<li><strong>将 APK 发布到工件</strong>:对于前面步骤中生成的 APK，我们需要将其发布到工件，因为我们需要在后面的步骤中访问它，以便将其上传到应用程序中心。<pre>- task: <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="500025323c3923381225393c341122243936313324231061">[email protected]</a>     displayName: 'Publish APK to artifacts'     inputs:       PathtoPublish: 'android/app/build/outputs/apk/release'       ArtifactName: 'android'       publishLocation: 'Container'</pre></li>
<li><strong>上传 APK 到应用中心</strong>:上传 APK 到应用中心。在这里，<code>appSlug</code>可以在 app Center 上从你的 App 的网址中找到，<code>distributionGroupId</code>可以在 App Center 上从你的 App 的分发组中找到。<pre>- task: <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="66271616250308120314220f1512140f041312032655">[email protected]</a>     displayName: 'Upload APK to AppCenter'     inputs:       serverEndpoint: 'App Center'       appSlug: 'hnadeem/MyProject-Android'       appFile: 'android/app/build/outputs/apk/release/app-release-unsigned.apk'       releaseNotesOption: 'file'       isMandatory: true       destinationType: 'groups'       distributionGroupId: 'f940ccde-a812-4ade-98d8-76c3ab1d0c2e'       isSilent: true</pre></li>
<li><strong> Bump commit </strong>:目前为止，我们已经在<code>package.json</code>、Android、iOS 项目中更新了版本。现在我们需要提交这些更改。<pre>- script: |       tag="mobile_$(NEW_VERSION)"       echo "New tag $tag"       git add *       git commit -m "Update version from $(OLD_VERSION) to $(NEW_VERSION)"       git tag $tag       git pull --rebase origin $(Build.SourceBranchName)       git push origin $(Build.SourceBranchName)       git push --tags     displayName: Bump commit</pre></li>
<li><strong>安装苹果证书</strong>:从我们在<strong>管道→库</strong>上传的证书来看，我们需要在构建 iOS app 之前安装签名证书。<code>AppleCertificatePassword</code>来自图书馆。请确保此名称与您在资源库中设置的名称相匹配。<pre>- task: <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="064f687572676a6a4776766a63456374726f606f656772634634">[email protected]</a>     displayName: Install Apple Certificate     inputs:       certSecureFile: 'MobileProd.p12'       certPwd: '$(AppleCertificatePassword)'       keychain: 'temp'       deleteCert: true</pre></li>
<li><strong>安装苹果预置描述文件</strong>:根据我们在<strong>管道→库</strong>上传的证书，我们需要在构建 iOS 应用之前安装预置描述文件。<pre>- task: <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="20694e5354414c4c6150504c4570524f564953494f4e494e4770524f46494c456011">[email protected]</a>     displayName: 'Install Apple Provisioning Profile'     inputs:       provisioningProfileLocation: 'secureFiles'       provProfileSecureFile: 'MyProject.mobileprovision'       removeProfile: true</pre></li>
<li><strong>安装 CocoaPods </strong>:安装完前面步骤中的所有依赖项后，我们还需要安装 pod。<pre>- task: <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="24674b474b45744b40576414">[email protected]</a>     displayName: 'Install CocoaPods'     inputs:       workingDirectory: 'ios'</pre></li>
<li><strong>构建 IPA </strong>:对于构建 iOS，您可以看到我们如何使用<code>APPLE_CERTIFICATE_SIGNING_IDENTITY</code>和<code>APPLE_PROV_PROFILE_UUID</code>，它们是由 Azure DevOps 基于我们之前提供证书的步骤自动填充的。<pre>- task: <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="a5fdc6cac1c0e590">[email protected]</a>     displayName: 'Build IPA'     inputs:       actions: 'build'       configuration: 'Release'       sdk: 'iphoneos'       xcWorkspacePath: 'ios/MyProject.xcworkspace'       scheme: 'MyProject'       packageApp: true       exportPath: 'output'       signingOption: 'manual'       signingIdentity: '$(APPLE_CERTIFICATE_SIGNING_IDENTITY)'       provisioningProfileUuid: '$(APPLE_PROV_PROFILE_UUID)'</pre></li>
<li><strong>复制 IPA </strong>:在发布到工件之前，我们需要将 IPA 复制到暂存目录。<pre>- task: <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="41022e313807282d24320173">[email protected]</a>     displayName: 'Copy IPA'     inputs:       contents: '**/*.ipa'       targetFolder: '$(build.artifactStagingDirectory)'       overWrite: true       flattenFolders: true</pre></li>
<li><strong>将 IPA 发布到工件</strong>:对于前面步骤中生成的 IPA，我们需要将其发布到工件，因为我们需要在后面的步骤中访问它，以便将其上传到 App Center。<pre>- task: <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="a5f5d0c7c9ccd6cde7d0ccc9c1e4d7d1ccc3c4c6d1d6e594">[email protected]</a>     displayName: 'Publish IPA to artifacts'     inputs:       PathtoPublish: '$(build.artifactStagingDirectory)'       ArtifactName: 'ios'       publishLocation: 'Container'</pre></li>
<li><strong>上传 IPA 到应用中心</strong>:上传 APK 到应用中心。在这里，<code>appSlug</code>可以在 app Center 上从你的 App 的网址中找到，<code>distributionGroupId</code>可以在 App Center 上你的 App 的分发组中找到。<pre>- task: <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="97d6e7e7d4f2f9e3f2e5d3fee4e3e5fef5e2e3f2d7a4">[email protected]</a>     displayName: 'Upload IPA to AppCenter'     inputs:       serverEndpoint: 'App Center'       appSlug: 'hnadeem/MyProject-iOS'       appFile: 'output/MyProject.ipa'       releaseNotesOption: 'file'       isMandatory: true       destinationType: 'groups'       distributionGroupId: '058a4704-ea24-4877-a2f0-bdfaff9335dc'       isSilent: true</pre></li>
</ol>
<p>脚本部分大概就是这样！这是本教程的完整<code>azure-pipelines.yml</code>:</p>
<pre>trigger:
  branches:
    include:
      - master
variables:
  - group: Mobile # change it to the name you have set
pool:
  vmImage: 'macos-latest'
steps:
  - checkout: self
    persistCredentials: true
    clean: true
  - task: <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="733d1c1716271c1c1f3343">[email protected]</a>
    displayName: 'Install Node'
    inputs:
      versionSpec: '12.19.0' # you can use your desired version here
  - script: yarn install
    displayName: Install Dependencies
  - script: |
      # Disable autocommit on version bump 
      yarn config set version-sign-git-tag false
      yarn config set version-git-tag false
      yarn config set version-commit-hooks false
      # Checkout branch where the build is triggered
      git checkout $(Build.SourceBranchName)
      # Extract existing version of package.json
      oldVer=$(jq -r ".version" package.json)
      # Bump version
      yarn version --patch
      # Add bumped version to staging
      git add *
      # Extract new version of package.json
      newVer=$(jq -r ".version" package.json)
      # Set environment variables
      echo "##vso[task.setvariable variable=OLD_VERSION]$oldVer"
      echo "##vso[task.setvariable variable=NEW_VERSION]$newVer"
    displayName: 'Bump version and set variables'
  - task: <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="c9a0a6bae4abbca7ada5ace4bfacbbbaa0a6a789f8">[email protected]</a>
    displayName: 'Bump iOS version'
    inputs:
      sourcePath: 'ios/MyProject/Info.plist'
      versionCodeOption: 'buildid'
      versionCode: '$(Build.BuildId)'
      versionName: '$(NEW_VERSION)'
      printFile: false
  - task: <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="0e497c6f6a626b4e3c">[email protected]</a>
    displayName: 'Build APK'
    inputs:
      gradleWrapperFile: 'android/gradlew'
      workingDirectory: 'android/'
      options: '-PversionName=$(NEW_VERSION) -PversionCode=$(Build.BuildId)'
      tasks: 'assembleRelease'
      publishJUnitResults: false
      javaHomeOption: 'JDKVersion'
      jdkVersionOption: '1.8'
      gradleOptions: '-Xmx3072m'
      sonarQubeRunAnalysis: false
  - task: <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="dd9cb3b9afb2b4b98eb4bab3b4b3ba9dee">[email protected]</a>
    displayName: 'Sign APK'
    inputs:
      apkFiles: 'android/app/build/outputs/apk/release/*.apk'
      apksignerKeystoreFile: 'mobile-prod.keystore'
      apksignerKeystorePassword: '$(AndroidKeyStorePassword)'
      apksignerKeystoreAlias: '$(AndroidKeyAlias)'
      apksignerKeyPassword: '$(AndroidKeyAliasPassword)'
      zipalign: true
  - task: <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="633316010f0a100b21160a0f072211170a05020017102352">[email protected]</a>
    displayName: 'Publish APK to artifacts'
    inputs:
      PathtoPublish: 'android/app/build/outputs/apk/release'
      ArtifactName: 'android'
      publishLocation: 'Container'
  - task: <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="fbba8b8bb89e958f9e89bf92888f8992998e8f9ebbc8">[email protected]</a>
    displayName: 'Upload APK to AppCenter'
    inputs:
      serverEndpoint: 'App Center'
      appSlug: 'hnadeem/MyProject-Android'
      appFile: 'android/app/build/outputs/apk/release/app-release-unsigned.apk'
      releaseNotesOption: 'file'
      isMandatory: true
      destinationType: 'groups'
      distributionGroupId: 'f940ccde-a812-4ade-98d8-76c3ab1d0c2e'
      isSilent: true
  - script: |
      tag="mobile_$(NEW_VERSION)"
      echo "New tag $tag"
      git add *
      git commit -m "Update version from $(OLD_VERSION) to $(NEW_VERSION)"
      git tag $tag
      git pull --rebase origin $(Build.SourceBranchName)
      git push origin $(Build.SourceBranchName)
      git push --tags
    displayName: Bump commit
  - task: <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="9fd6f1ecebfef3f3deefeff3fadcfaedebf6f9f6fcfeebfadfad">[email protected]</a>
    displayName: Install Apple Certificate
    inputs:
      certSecureFile: 'MobileProd.p12'
      certPwd: '$(AppleCertificatePassword)'
      keychain: 'temp'
      deleteCert: true
  - task: <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="cd84a3beb9aca1a18cbdbda1a89dbfa2bba4bea4a2a3a4a3aa9dbfa2aba4a1a88dfc">[email protected]</a>
    displayName: 'Install Apple Provisioning Profile'
    inputs:
      provisioningProfileLocation: 'secureFiles'
      provProfileSecureFile: 'MyProject.mobileprovision'
      removeProfile: true
  - task: <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="5f1c303c303e0f303b2c1f6f">[email protected]</a>
    displayName: 'Install CocoaPods'
    inputs:
      workingDirectory: 'ios'
  - task: <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="6d350e0209082d58">[email protected]</a>
    displayName: 'Build IPA'
    inputs:
      actions: 'build'
      configuration: 'Release'
      sdk: 'iphoneos'
      xcWorkspacePath: 'ios/MyProject.xcworkspace'
      scheme: 'MyProject'
      packageApp: true
      exportPath: 'output'
      signingOption: 'manual'
      signingIdentity: '$(APPLE_CERTIFICATE_SIGNING_IDENTITY)'
      provisioningProfileUuid: '$(APPLE_PROV_PROFILE_UUID)'
  - task: <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="e9aa869990af80858c9aa9db">[email protected]</a>
    displayName: 'Copy IPA'
    inputs:
      contents: '**/*.ipa'
      targetFolder: '$(build.artifactStagingDirectory)'
      overWrite: true
      flattenFolders: true
  - task: <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="6e3e1b0c02071d062c1b07020a2f1c1a07080f0d1a1d2e5f">[email protected]</a>
    displayName: 'Publish IPA to artifacts'
    inputs:
      PathtoPublish: '$(build.artifactStagingDirectory)'
      ArtifactName: 'ios'
      publishLocation: 'Container'
  - task: <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="e4a59494a7818a908196a08d9790968d86919081a4d7">[email protected]</a>
    displayName: 'Upload IPA to AppCenter'
    inputs:
      serverEndpoint: 'App Center'
      appSlug: 'hnadeem/MyProject-iOS'
      appFile: 'output/MyProject.ipa'
      releaseNotesOption: 'file'
      isMandatory: true
      destinationType: 'groups'
      distributionGroupId: '058a4704-ea24-4877-a2f0-bdfaff9335dc'
      isSilent: true
</pre>
<p>现在是时候将我们的提交推送到主分支，以查看这个部署脚本的运行情况。</p>
<p>这里您可以看到作业在主分支上运行，并且发布了两个工件。</p>
<p><img data-attachment-id="37764" data-permalink="https://blog.logrocket.com/continuous-deployment-of-react-native-app-with-azure-devops/job-success-artifacts/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2021/03/job-success-artifacts.png" data-orig-size="730,379" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Job success and artifacts" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2021/03/job-success-artifacts-300x156.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2021/03/job-success-artifacts.png" decoding="async" class="aligncenter size-full wp-image-37764 jetpack-lazy-image" src="../Images/379d0177e00aff54660cdf01debdba71.png" alt="Job Success and Artifacts" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2021/03/job-success-artifacts.png 730w, https://blog.logrocket.com/wp-content/uploads/2021/03/job-success-artifacts-300x156.png 300w" data-lazy-sizes="(max-width: 730px) 100vw, 730px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2021/03/job-success-artifacts.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2021/03/job-success-artifacts.png"/></p><noscript><img data-lazy-fallback="1" data-attachment-id="37764" data-permalink="https://blog.logrocket.com/continuous-deployment-of-react-native-app-with-azure-devops/job-success-artifacts/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2021/03/job-success-artifacts.png" data-orig-size="730,379" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Job success and artifacts" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2021/03/job-success-artifacts-300x156.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2021/03/job-success-artifacts.png" decoding="async" loading="lazy" class="aligncenter size-full wp-image-37764" src="../Images/379d0177e00aff54660cdf01debdba71.png" alt="Job Success and Artifacts" srcset="https://blog.logrocket.com/wp-content/uploads/2021/03/job-success-artifacts.png 730w, https://blog.logrocket.com/wp-content/uploads/2021/03/job-success-artifacts-300x156.png 300w" sizes="(max-width: 730px) 100vw, 730px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2021/03/job-success-artifacts.png"/></noscript>
<h2>结论</h2>
<p>这是一篇关于如何在 Azure DevOps 上为 React 原生项目建立持续部署管道的简短教程。使用持续部署，您将摆脱人为错误并节省大量时间。任何新的开发人员都将能够开始项目工作，而不必担心部署问题。</p><div class="code-block code-block-18">
<div class="blog-plug inline-plug react-native-plug"><h2><a href="https://lp.logrocket.com/blg/react-native-signup"> LogRocket </a>:即时重现 React 原生应用中的问题。</h2><a class="signup" href="https://lp.logrocket.com/blg/react-native-signup" target="_blank" rel="noopener noreferrer"><img class="alignnone size-full wp-image-46 jetpack-lazy-image" src="../Images/110055665562c1e02069b3698e6cc671.png" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2021/10/react-native-plug_v2-2.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2021/10/react-native-plug_v2-2.png"/><noscript><img data-lazy-fallback="1" class="alignnone size-full wp-image-46" src="../Images/110055665562c1e02069b3698e6cc671.png" data-original-src="https://blog.logrocket.com/wp-content/uploads/2021/10/react-native-plug_v2-2.png"/></noscript></a><p><a href="https://lp.logrocket.com/blg/react-native-signup" target="_blank" rel="noopener noreferrer"> LogRocket </a>是一款 React 原生监控解决方案，可帮助您即时重现问题、确定 bug 的优先级并了解 React 原生应用的性能。</p><p>LogRocket 还可以向你展示用户是如何与你的应用程序互动的，从而帮助你提高转化率和产品使用率。LogRocket 的产品分析功能揭示了用户不完成特定流程或不采用新功能的原因。</p><p>开始主动监控您的 React 原生应用— <a class="signup" href="https://lp.logrocket.com/blg/react-native-signup" target="_blank" rel="noopener noreferrer">免费试用 LogRocket】。</a></p></div>
</div>

<p class="clearfix"/>
<p class="clearfix"/>
</article>

</div>    
</body>
</html>