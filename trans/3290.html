<html>
<head>
<title>Create a URL shortener with Cloudflare Workers - LogRocket Blog</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>使用Cloudflare Workers - LogRocket博客创建一个URL shortener</h1>
<blockquote>原文：<a href="https://blog.logrocket.com/creating-url-shortener-cloudflare-workers/#0001-01-01">https://blog.logrocket.com/creating-url-shortener-cloudflare-workers/#0001-01-01</a></blockquote><div><article class="article-post">
<p>你曾经使用过像<a href="https://bitly.com" target="_blank" rel="noopener"> Bitly </a>或<a href="https://tinyurl.com/app" target="_blank" rel="noopener"> TinyURL </a>这样的工具来缩短长链接吗？或者，您是否想知道这些服务是如何工作的？也许你想建立一个网址缩短器，但是没有时间或者合适的工具去做。无论如何，如果你对这个话题感兴趣，这篇文章非常适合你。</p>
<p>在本帖中，我们将展示如何使用<a href="https://workers.cloudflare.com" target="_blank" rel="noopener"> Cloudflare Workers </a>构建一个基本的URL shortener服务。我们将提供有关URL shortener服务如何工作的详细信息，介绍Cloudflare Workers的几个功能，并逐步说明如何开始使用Cloudflare Workers。</p>
<p><em>向前跳转:</em></p>

<p>我们开始吧！</p>
<h2 id="what-is-cloudflare-workers">什么是Cloudflare Workers？</h2>
<p>Cloudflare Workers是一项允许您将无服务器代码部署到Cloudflare网络的服务。Cloudflare network或Edge是一个遍布全球的web服务器网络。Cloudflare Workers的一个优点是，您不必担心代码的伸缩性。此外，您不必担心代码所在的时区；Workers中的代码在部署后几秒钟内就会传遍全球。</p>
<p>最重要的是，Cloudflare Workers提供了一个简单的键值数据存储，称为KV。在本教程中，我们将结合使用Cloudflare Workers和KV storage来缩短我们的URL。</p>
<h2 id="project-overview-url-shortener-service">项目概述:网址缩写服务</h2>
<p>我们将从构建一个简单的、非动态的URL缩写器开始，在这里你可以硬编码你想要重定向到的网站。这将作为学习如何使用<a href="https://developers.cloudflare.com/workers/wrangler/" target="_blank" rel="noopener"> Wrangler </a> (Cloudflare的官方CLI工具)的介绍，并将演示工人领域的基本概念。</p>
<p>接下来，我们将增加一些趣味，增加对动态URL的支持。基本上，我们将与Cloudflare Workers KV store进行交互，并输入URL的简短版本和我们想要重定向到的实际URL。KV存储中的数据将类似于以下结构:</p>
<pre class="language-javascript hljs">'short-url': 'https://my-cool-website.com'
'submit': 'https://my-cool-site.org/blog/ideas/submit'
</pre>
<p>最后，我们将把我们的代码部署到生产环境中，并在全球范围内看到它的运行。</p>
<p>你已经兴奋了吗？太好了，我们跳进去吧！</p>
<h2 id="setting-up-the-environment">设置环境</h2>
<p>要阅读本文，您需要以下内容:</p>
<ul>
<li>Node.js和npm</li>
<li>牧马人</li>
<li>curl(或您选择的浏览器)来测试URL shortener</li>
</ul>
<p>我使用<a href="https://asdf-vm.com/" target="_blank" rel="noopener"> asdf工具</a>来管理我的本地依赖项，但是你可以使用任何你喜欢的版本管理器。在撰写本文时，这里是我的节点和npm版本:</p>
<pre class="language-javascript hljs">$ node --version
v18.5.0
$ npm --version
8.12.1
</pre>
<p>牧马人是一个命令行构建工具，最近，它获得了2.0版本。对于这个职位的目的，牧马人将满足我们所有的需求。在未来，我们可能会使用<a href="https://blog.logrocket.com/ditch-wrangler-cli-miniflare/" target="_blank" rel="noopener"> Miniflare，它是牧马人</a>的一个更强大、功能更丰富的兄弟。但是，现在让我们通过npm在全球范围内安装牧马人:</p>
<pre class="language-javascript hljs">$ npm install -g <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="334441525d545f564173011d031d0102">[email protected]</a>
</pre>
<p>在撰写本文时，最新的牧马人版本是2.0.21，所以我们将使用该版本。</p>
<p>酷毙了。现在我们已经有了所有的依赖项，我们可以使用Wrangler CLI来生成我们的starter Cloudflare Worker。</p>
<h2 id="generating-the-project">生成项目</h2>
<p>牧马人CLI工具将证明在这里非常有用。</p>
<p>首先，让我们运行一个命令来正确启动和设置我们的项目:</p>
<pre class="language-javascript hljs">$ wrangler init short-it
</pre>
<p>该命令将询问几个问题。现在，我们将对所有这些问题回答“是”(通过键入<strong> y </strong>):</p>
<pre class="language-javascript hljs">$ wrangler init short-it
 ⛅️ wrangler 2.0.21
--------------------
Using npm as package manager.
✨ Created short-it/wrangler.toml
Would you like to use git to manage this Worker? (y/n)
✨ Initialized git repository at short-it
No package.json found. Would you like to create one? (y/n)
✨ Created short-it/package.json
Would you like to use TypeScript? (y/n)
✨ Created short-it/tsconfig.json
Would you like to create a Worker at short-it/src/index.ts?
  None
❯ Fetch handler
  Scheduled handler
✨ Created short-it/src/index.ts

added 62 packages, and audited 63 packages in 1s

1 package is looking for funding
  run `npm fund` for details

found 0 vulnerabilities
✨ Installed @cloudflare/workers-types and typescript into devDependencies

To start developing your Worker, run `cd short-it &amp;&amp; npm start`
To publish your Worker to the Internet, run `npm run deploy`
</pre>
<p>如果您对牧马人的所有问题都做出了肯定的回答，那么您将获得一个项目名称<code>short-it</code>，其中包含以下内容:</p>
<ul>
<li>目录，这意味着您已经准备好将它推送给您的Git提供者了</li>
<li><code>package.json</code>文件</li>
<li><code>tsconfig.json</code>包含所有类型脚本配置的文件</li>
<li>用一些简单明了的逻辑提交文件，以获得我们员工的回应</li>
</ul>
<p>太棒了。让我们看看这东西有没有用！</p>
<p>让我们<code>cd</code>进入<code>short-it</code>目录，在本地开发模式下启动牧马人:</p>
<pre class="language-javascript hljs">$ cd short-it
$ wrangler dev --local
</pre>
<p>这应该会在http://localhost:8787/ 上运行我们的Worker。如果我们访问localhost，我们应该会看到一个简单的“Hello World！”消息:</p>
<figure id="attachment_128988" aria-describedby="caption-attachment-128988" class="wp-caption aligncenter"><img data-attachment-id="128988" data-permalink="https://blog.logrocket.com/creating-url-shortener-cloudflare-workers/attachment/hello-world-message/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/08/hello-world-message.png" data-orig-size="730,502" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Hello world message" data-image-description="" data-image-caption="&lt;p&gt;Generated Worker is displaying a “Hello World!” message.&lt;/p&gt;&#10;" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/08/hello-world-message-300x206.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/08/hello-world-message.png" decoding="async" class="size-full wp-image-128988 jetpack-lazy-image" src="../Images/f2b11ff4282f14e8ea1b6cf06ebaa6b2.png" alt="Hello World Message" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2022/08/hello-world-message.png 730w, https://blog.logrocket.com/wp-content/uploads/2022/08/hello-world-message-300x206.png 300w" data-lazy-sizes="(max-width: 730px) 100vw, 730px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2022/08/hello-world-message.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/08/hello-world-message.png"/><noscript><img data-lazy-fallback="1" data-attachment-id="128988" data-permalink="https://blog.logrocket.com/creating-url-shortener-cloudflare-workers/attachment/hello-world-message/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/08/hello-world-message.png" data-orig-size="730,502" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Hello world message" data-image-description="" data-image-caption="&lt;p&gt;Generated Worker is displaying a “Hello World!” message.&lt;/p&gt;&#10;" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/08/hello-world-message-300x206.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/08/hello-world-message.png" decoding="async" loading="lazy" class="size-full wp-image-128988" src="../Images/f2b11ff4282f14e8ea1b6cf06ebaa6b2.png" alt="Hello World Message" srcset="https://blog.logrocket.com/wp-content/uploads/2022/08/hello-world-message.png 730w, https://blog.logrocket.com/wp-content/uploads/2022/08/hello-world-message-300x206.png 300w" sizes="(max-width: 730px) 100vw, 730px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/08/hello-world-message.png"/></noscript><figcaption id="caption-attachment-128988" class="wp-caption-text">Generated Worker is displaying a “Hello World!” message.</figcaption></figure>
<p>耶！我们成功了。但是怎么做呢？让我们仔细看看。</p>
<h2 id="how-does-cloudflare-workers-work">Cloudflare工作人员是如何工作的？</h2>
<p>我们在本地从生成的Worker中获得了第一条消息，但是这到底是如何工作的呢？</p>
<p>让我们仔细查看生成的<code>src/index.ts</code>文件，以便更好地理解那里发生了什么。</p>
<pre class="language-javascript hljs">// src/index.ts

/**
 * Welcome to Cloudflare Workers! This is your first worker.
 *
 * - Run `wrangler dev src/index.ts` in your terminal to start a development server
 * - Open a browser tab at http://localhost:8787/ to see your worker in action
 * - Run `wrangler publish src/index.ts --name my-worker` to publish your worker
 *
 * Learn more at https://developers.cloudflare.com/workers/
 */

export interface Env {
  // Example binding to KV. Learn more at https://developers.cloudflare.com/workers/runtime-apis/kv/
  // MY_KV_NAMESPACE: KVNamespace;
  //
  // Example binding to Durable Object. Learn more at https://developers.cloudflare.com/workers/runtime-apis/durable-objects/
  // MY_DURABLE_OBJECT: DurableObjectNamespace;
  //
  // Example binding to R2. Learn more at https://developers.cloudflare.com/workers/runtime-apis/r2/
  // MY_BUCKET: R2Bucket;
}

export default {
  async fetch(
    request: Request,
    env: Env,
    ctx: ExecutionContext
  ): Promise&lt;Response&gt; {
    return new Response("Hello World!");
  },
};
</pre>
<p>上面的代码包括我们环境的定义(<code>Env</code>接口)和一些与<code>ENV</code>接口相关的注释。</p>
<p>由于接口超出了本文的范围，我们将忽略这部分代码，只关注主要逻辑:</p>
<pre class="language-javascript hljs">// src/index.ts

export default {
  async fetch(
    request: Request,
    env: Env,
    ctx: ExecutionContext
  ): Promise&lt;Response&gt; {
    return new Response("Hello World!");
  },
};
</pre>
<p>这里发生的是我们的<code>index.ts</code>导出一个<code>fetch</code>函数。这是一个类似于<a href="https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API/Using_web_workers" target="_blank" rel="noopener"> Web Workers </a>的界面。事实上,“Cloudflare Workers”这个名称就是从这个接口产生的。Cloudflare Workers类似于Web Workers，只是它运行在Cloudflare基础架构上，而不是浏览器上。</p>
<p>在上面的代码中，<code>fetch</code>函数返回一个带有“Hello World！”的新的<code>Response</code>对象文字。所以当我们运行我们的Worker时，这个<code>fetch</code>函数被调用。然后，被调用的<code>fetch</code>函数返回“Hello World！”响应，这是我们在浏览器中(或通过任何用于调用Worker的工具)获得的。</p>
<p>好了，我们已经搞清楚了Cloudflare Workers的基本情况。我们可以满怀信心地继续前进。如果您不熟悉TypeScript，不要担心；我们将只是简单地使用它的特性。想象这是一个轻量级的TypeScript世界。</p>
<p>太好了，让我们继续前进吧！</p>
<h2 id="adding-a-first-redirect">添加第一个重定向</h2>
<p>我们将慢慢开始研究我们的逻辑。首先，我们会让我们的URL shortener将用户重定向到一个不同的网站。这将是后面变化的基础。</p>
<p>目前，我们会让用户在访问我们的本地员工时，转到https://http.cat/网站的一个页面。</p>
<p>如果你不熟悉<a href="https://http.cat/" target="_blank" rel="noopener">https://http.cat/</a>，这是一个有趣的网站，显示不同HTTP状态的各种猫图片。例如，如果用户向我们的工作人员向<a href="http://localhost:8787/404" rel="nofollow">http://localhost:8787/404</a>发出请求，他们将被定向到【https://http.cat/404】的。</p>
<p>为了实现这个重定向，我们将编辑<code>src/index.ts</code>，如下所示:</p>
<pre class="language-javascript hljs">// src/index.ts
// ...

const basePath = "https://http.cat";

export default {
  async fetch(
    request: Request,
    _env: Env,
    _ctx: ExecutionContext
  ): Promise&lt;Response&gt; {
    const url = new URL(request.url);

    const { pathname } = url;

    const redirectURL = basePath + pathname;

    if (pathname === "/") {
      return new Response("Hello World from our awesome Worker!");
    }

    return Response.redirect(redirectURL, 301);
  },
};
</pre>
<p>现在，如果我们访问http://localhost:8787 ,我们会收到一条更新的消息:“你好，世界，来自我们伟大的工作者！”，如下图所示:</p>
<figure id="attachment_128990" aria-describedby="caption-attachment-128990" class="wp-caption aligncenter"><img data-attachment-id="128990" data-permalink="https://blog.logrocket.com/creating-url-shortener-cloudflare-workers/attachment/hello-world-from-awesome-worker/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/08/hello-world-from-awesome-worker.png" data-orig-size="730,502" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Hello world from awesome worker" data-image-description="" data-image-caption="&lt;p&gt;Worker displaying an updated  “Hello world” message.&lt;/p&gt;&#10;" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/08/hello-world-from-awesome-worker-300x206.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/08/hello-world-from-awesome-worker.png" decoding="async" class="size-full wp-image-128990 jetpack-lazy-image" src="../Images/6ae1697341aa9c44e43ec7dc1a667a58.png" alt="Hello World From Awesome Worker" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2022/08/hello-world-from-awesome-worker.png 730w, https://blog.logrocket.com/wp-content/uploads/2022/08/hello-world-from-awesome-worker-300x206.png 300w" data-lazy-sizes="(max-width: 730px) 100vw, 730px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2022/08/hello-world-from-awesome-worker.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/08/hello-world-from-awesome-worker.png"/><noscript><img data-lazy-fallback="1" data-attachment-id="128990" data-permalink="https://blog.logrocket.com/creating-url-shortener-cloudflare-workers/attachment/hello-world-from-awesome-worker/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/08/hello-world-from-awesome-worker.png" data-orig-size="730,502" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Hello world from awesome worker" data-image-description="" data-image-caption="&lt;p&gt;Worker displaying an updated  “Hello world” message.&lt;/p&gt;&#10;" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/08/hello-world-from-awesome-worker-300x206.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/08/hello-world-from-awesome-worker.png" decoding="async" loading="lazy" class="size-full wp-image-128990" src="../Images/6ae1697341aa9c44e43ec7dc1a667a58.png" alt="Hello World From Awesome Worker" srcset="https://blog.logrocket.com/wp-content/uploads/2022/08/hello-world-from-awesome-worker.png 730w, https://blog.logrocket.com/wp-content/uploads/2022/08/hello-world-from-awesome-worker-300x206.png 300w" sizes="(max-width: 730px) 100vw, 730px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/08/hello-world-from-awesome-worker.png"/></noscript><figcaption id="caption-attachment-128990" class="wp-caption-text">Worker displaying an updated “Hello world” message.</figcaption></figure>
<p>但是，如果我们尝试去<a href="http://localhost:8787/404" rel="nofollow">http://localhost:8787/404</a>，我们会被重定向到https://http.cat/404<a href="https://http.cat/404" target="_blank" rel="noopener"/>。</p>
<figure id="attachment_128993" aria-describedby="caption-attachment-128993" class="wp-caption aligncenter"><img data-attachment-id="128993" data-permalink="https://blog.logrocket.com/creating-url-shortener-cloudflare-workers/attachment/user-redirected/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/08/user-redirected.gif" data-orig-size="588,376" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="User redirected" data-image-description="" data-image-caption="&lt;p&gt;User is redirected to the http.cat/404 website.&lt;/p&gt;&#10;" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/08/user-redirected-300x192.gif" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/08/user-redirected.gif" decoding="async" class="size-full wp-image-128993 jetpack-lazy-image" src="../Images/18317c9ad25a6f5c59c30e06df5e47c7.png" alt="User Redirected" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2022/08/user-redirected.gif?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/08/user-redirected.gif"/><noscript><img data-lazy-fallback="1" data-attachment-id="128993" data-permalink="https://blog.logrocket.com/creating-url-shortener-cloudflare-workers/attachment/user-redirected/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/08/user-redirected.gif" data-orig-size="588,376" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="User redirected" data-image-description="" data-image-caption="&lt;p&gt;User is redirected to the http.cat/404 website.&lt;/p&gt;&#10;" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/08/user-redirected-300x192.gif" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/08/user-redirected.gif" decoding="async" loading="lazy" class="size-full wp-image-128993" src="../Images/18317c9ad25a6f5c59c30e06df5e47c7.png" alt="User Redirected" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/08/user-redirected.gif"/></noscript><figcaption id="caption-attachment-128993" class="wp-caption-text">User is redirected to the http.cat/404 website.</figcaption></figure>
<p>太好了，我们第一次重定向成功了。现在，让我们的网址缩短器实际上缩短一些网址。</p>
<h2 id="shortening-the-url">缩短URL</h2>
<p>现在，我们将添加一个小的数据结构来存储我们缩短的URL。我们可以这样做:</p>
<pre class="language-javascript hljs">const shortURLs = {
  "/blog": "https://pragmaticpineapple.com/",
  "/twitter": "https://twitter.com/nikolalsvk",
  "/github": "https://github.com/nikolalsvk",
} as Record&lt;any, string&gt;;

export default {
  async fetch(
    request: Request,
    _env: Env,
    _ctx: ExecutionContext
  ): Promise&lt;Response&gt; {
    const url = new URL(request.url);

    const { pathname } = url;

    const redirectURL = shortURLs[pathname];

    if (!redirectURL) {
      return new Response(
        `There is no defined URL for the path: '${pathname}', sorry :(`
      );
    }

    return Response.redirect(redirectURL, 301);
  },
};
</pre>
<p>这里，我们添加了几个简短的URL:</p>

<p>你可以把它改成你喜欢的任何东西，只是为了看看它是如何工作的。现在，当我访问http://localhost:8787/blog 时，我被重定向到我的博客所在的一个更长的URL。结果如下:</p>
<figure id="attachment_128995" aria-describedby="caption-attachment-128995" class="wp-caption aligncenter"><img data-attachment-id="128995" data-permalink="https://blog.logrocket.com/creating-url-shortener-cloudflare-workers/attachment/redirects-to-blog/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/08/redirects-to-blog.gif" data-orig-size="588,376" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Redirects to blog" data-image-description="" data-image-caption="&lt;p&gt;Visiting /blog redirects to the actual blog page.&lt;/p&gt;&#10;" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/08/redirects-to-blog-300x192.gif" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/08/redirects-to-blog.gif" decoding="async" class="size-full wp-image-128995 jetpack-lazy-image" src="../Images/c022903be4eb6d69e513efedb6d3c14a.png" alt="Redirects to Blog" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2022/08/redirects-to-blog.gif?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/08/redirects-to-blog.gif"/><noscript><img data-lazy-fallback="1" data-attachment-id="128995" data-permalink="https://blog.logrocket.com/creating-url-shortener-cloudflare-workers/attachment/redirects-to-blog/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/08/redirects-to-blog.gif" data-orig-size="588,376" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Redirects to blog" data-image-description="" data-image-caption="&lt;p&gt;Visiting /blog redirects to the actual blog page.&lt;/p&gt;&#10;" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/08/redirects-to-blog-300x192.gif" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/08/redirects-to-blog.gif" decoding="async" loading="lazy" class="size-full wp-image-128995" src="../Images/c022903be4eb6d69e513efedb6d3c14a.png" alt="Redirects to Blog" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/08/redirects-to-blog.gif"/></noscript><figcaption id="caption-attachment-128995" class="wp-caption-text">Visiting /blog redirects to the actual blog page.</figcaption></figure>
<p>但是，如果我们请求某个路径，比如<a href="http://localhost:8787/missing" rel="nofollow">http://localhost:8787/missing</a>，我们会得到下面的错误消息:“没有为该路径定义的URL:'/missing '，对不起:(”。</p>
<figure id="attachment_128997" aria-describedby="caption-attachment-128997" class="wp-caption aligncenter"><img data-attachment-id="128997" data-permalink="https://blog.logrocket.com/creating-url-shortener-cloudflare-workers/attachment/error-message-missing/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/08/error-message-missing.png" data-orig-size="686,472" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Error message missing" data-image-description="" data-image-caption="&lt;p&gt;Visiting /missing displays an error message.&lt;/p&gt;&#10;" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/08/error-message-missing-300x206.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/08/error-message-missing.png" decoding="async" class="size-full wp-image-128997 jetpack-lazy-image" src="../Images/d6aaa341dad5063896da9576279586dd.png" alt="Error Message Missing" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2022/08/error-message-missing.png 686w, https://blog.logrocket.com/wp-content/uploads/2022/08/error-message-missing-300x206.png 300w" data-lazy-sizes="(max-width: 686px) 100vw, 686px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2022/08/error-message-missing.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/08/error-message-missing.png"/><noscript><img data-lazy-fallback="1" data-attachment-id="128997" data-permalink="https://blog.logrocket.com/creating-url-shortener-cloudflare-workers/attachment/error-message-missing/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/08/error-message-missing.png" data-orig-size="686,472" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Error message missing" data-image-description="" data-image-caption="&lt;p&gt;Visiting /missing displays an error message.&lt;/p&gt;&#10;" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/08/error-message-missing-300x206.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/08/error-message-missing.png" decoding="async" loading="lazy" class="size-full wp-image-128997" src="../Images/d6aaa341dad5063896da9576279586dd.png" alt="Error Message Missing" srcset="https://blog.logrocket.com/wp-content/uploads/2022/08/error-message-missing.png 686w, https://blog.logrocket.com/wp-content/uploads/2022/08/error-message-missing-300x206.png 300w" sizes="(max-width: 686px) 100vw, 686px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/08/error-message-missing.png"/></noscript><figcaption id="caption-attachment-128997" class="wp-caption-text">Visiting /missing displays an error message.</figcaption></figure>
<p>太棒了，现在我们已经准备好把硬编码的URL和它们的缩写版本转移到某个地方了。幸运的是，我们正在使用Cloudflare Workers，它提供了一个简单的名为KV的键值存储。</p>
<h2 id="adding-storage">添加存储</h2>
<p>在为我们的项目实际创建KV之前，我们首先需要通过Wrangler登录Cloudflare Workers。这是必要的，因为Wrangler稍后需要联系Cloudflare，以便为我们创建KV实例。</p>
<h3 id="logging-into-cloudflare">登录到Cloudflare</h3>
<p>要登录到Cloudflare，请使用以下命令:</p>
<pre class="language-javascript hljs">$ wrangler login
</pre>
<p>将会打开一个浏览器，要求您登录Cloudflare。不用担心；这个免费计划涵盖了我们在这个教程中需要的所有东西，并且不会要求你付费。请继续注册，或者如果您已经有帐户，请登录。</p>
<p>接下来，Cloudflare会询问您是否要授权给牧马人。同意后，您应该会看到以下屏幕:</p>
<figure id="attachment_128999" aria-describedby="caption-attachment-128999" class="wp-caption aligncenter"><img data-attachment-id="128999" data-permalink="https://blog.logrocket.com/creating-url-shortener-cloudflare-workers/attachment/wrangler-cli-tool/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/08/wrangler-cli-tool.png" data-orig-size="730,479" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Wrangler CLI tool" data-image-description="" data-image-caption="&lt;p&gt;The Wrangler CLI tool is now properly connected.&lt;/p&gt;&#10;" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/08/wrangler-cli-tool-300x197.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/08/wrangler-cli-tool.png" decoding="async" class="size-full wp-image-128999 jetpack-lazy-image" src="../Images/083b13681ee95a282f49fff424ac4580.png" alt="Wrangler CLI Tool" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2022/08/wrangler-cli-tool.png 730w, https://blog.logrocket.com/wp-content/uploads/2022/08/wrangler-cli-tool-300x197.png 300w" data-lazy-sizes="(max-width: 730px) 100vw, 730px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2022/08/wrangler-cli-tool.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/08/wrangler-cli-tool.png"/><noscript><img data-lazy-fallback="1" data-attachment-id="128999" data-permalink="https://blog.logrocket.com/creating-url-shortener-cloudflare-workers/attachment/wrangler-cli-tool/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/08/wrangler-cli-tool.png" data-orig-size="730,479" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Wrangler CLI tool" data-image-description="" data-image-caption="&lt;p&gt;The Wrangler CLI tool is now properly connected.&lt;/p&gt;&#10;" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/08/wrangler-cli-tool-300x197.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/08/wrangler-cli-tool.png" decoding="async" loading="lazy" class="size-full wp-image-128999" src="../Images/083b13681ee95a282f49fff424ac4580.png" alt="Wrangler CLI Tool" srcset="https://blog.logrocket.com/wp-content/uploads/2022/08/wrangler-cli-tool.png 730w, https://blog.logrocket.com/wp-content/uploads/2022/08/wrangler-cli-tool-300x197.png 300w" sizes="(max-width: 730px) 100vw, 730px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/08/wrangler-cli-tool.png"/></noscript><figcaption id="caption-attachment-128999" class="wp-caption-text">The Wrangler CLI tool is now properly connected.</figcaption></figure>
<p>注册过程中不应该出现任何问题。但是，如果你在任何时候遇到困难，你可以按照<a href="https://developers.cloudflare.com/fundamentals/account-and-billing/account-setup/" target="_blank" rel="noopener"> Cloudflare的指南创建一个账户</a>。</p>
<p>厉害！现在您已经注册并登录了，让我们检查一下所有的东西是否都连接好了。</p>
<p>使用以下命令:</p>
<pre class="language-javascript hljs">$ wrangler whoami
 ⛅️ wrangler 2.0.21
--------------------
Getting User settings...
👋 You are logged in with an OAuth Token, associated with the email '<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="c6a8afada9aaa7b5a3a7b686a1aba7afaae8a5a9ab">[email protected]</a>'!
┌──────────────────────┬──────────────────────────────────┐
│ Account Name         │ Account ID.                      │
├──────────────────────┼──────────────────────────────────┤
│ Nikola Đuza Personal │ 98a16dfefca0e2ee27e1e79ba590d973 │
└──────────────────────┴──────────────────────────────────┘
</pre>
<p>很好，我们已经准备好创建一个KV名称空间了。</p>
<h3 id="creating-a-kv-namespace">创建KV名称空间</h3>
<p>KV命名空间可以看作是Cloudflare网络上KV up的一个实例。我们将创建两个KV名称空间:一个用于我们的应用程序将生活和工作的生产环境，另一个用于预览环境。在测试和开发URL shortener时，我们将使用预览名称空间。</p>
<p>我们将使用以下命令通过Wrangler创建KV名称空间:</p>
<pre class="language-javascript hljs">$ wrangler kv:namespace create SHORT_URLS
🌀 Creating namespace with title "short-it-SHORT_URLS"
✨ Success!
Add the following to your configuration file in your kv_namespaces array:
{ binding = "SHORT_URLS", id = "029d374ebd984e19b0bb98e37ab1a95e" }

$ wrangler kv:namespace create SHORT_URLS --preview
 ⛅️ wrangler 2.0.21
--------------------
🌀 Creating namespace with title "short-it-SHORT_URLS_preview"
✨ Success!
Add the following to your configuration file in your kv_namespaces array:
{ binding = "SHORT_URLS", preview_id = "99a72876e5f84cf58de722b1c2080604" }
</pre>
<p>在运行这两个命令并创建了两个名称空间之后，我们需要告诉Wrangler在运行<code>wrangler dev</code>时使用这些名称空间。</p>
<p>我们将把关于KV名称空间的信息添加到项目根目录下的<code>wrangler.toml</code>文件中。它应该是这样的:</p>
<pre class="language-javascript hljs">name = "short-it"
main = "src/index.ts"
compatibility_date = "2022-07-15"

kv_namespaces = [
  { binding = "SHORT_URLS", id = "029d374ebd984e19b0bb98e37ab1a95e", preview_id = "99a72876e5f84cf58de722b1c2080604" }
]
</pre>
<p><code>wrangler.toml</code>文件是一个配置文件，它告诉<code>wrangler</code>关于我们项目的某些信息。现在，我们已经准备好向KV添加一些数据。</p>
<h3 id="adding-data-to-the-kv">向KV添加数据</h3>
<p>我们的下一步是将数据播种到KV。请记住，我们有两个名称空间，因此我们必须运行两个命令来将数据放在这两个地方。让我们将<code>/blog</code>条目添加到KV:</p>
<pre class="language-javascript hljs">$ wrangler kv:key put --binding SHORT_URLS "/blog" "https://pragmaticpineapple.com/" --preview false
 ⛅️ wrangler 2.0.21
--------------------
Writing the value "https://pragmaticpineapple.com/" to key "/blog" on namespace 029d374ebd984e19b0bb98e37ab1a95e.

$ wrangler kv:key put --binding SHORT_URLS "/blog" "https://pragmaticpineapple.com/" --preview
 ⛅️ wrangler 2.0.21
--------------------
Writing the value "https://pragmaticpineapple.com/" to key "/blog" on namespace 99a72876e5f84cf58de722b1c2080604.
</pre>
<p>太棒了。现在我们在KV中有一个条目。接下来，让我们添加从KV读取并重定向用户的逻辑。</p>
<h3 id="reading-from-the-kv">KV读数</h3>
<p>我们将快速删除旧的硬编码短URL，并添加对KV的调用，如下所示:</p>
<pre class="language-javascript hljs">// src/index.ts
export interface Env {
  SHORT_URLS: KVNamespace;
}

export default {
  async fetch(
    request: Request,
    env: Env,
    _ctx: ExecutionContext
  ): Promise&lt;Response&gt; {
    const url = new URL(request.url);

    const { pathname } = url;

    const redirectURL = await env.SHORT_URLS.get(pathname);

    if (!redirectURL) {
      return new Response(
        `There is no defined URL for the path: '${pathname}', sorry :(`
      );
    }

    return Response.redirect(redirectURL, 301);
  },
};
</pre>
<p>这里我们添加<code>SHORT_URLS</code>作为<code>KVNamespace</code>类型。这将允许我们调用KV方法来获得正确的数据。这次我们使用<code>await env.SHORT_URLS.get(pathname)</code>，而不是带有URL的硬编码对象。</p>
<p>对<code>env.SHORT_URLS.get(pathname)</code>的调用试图从KV获取密钥。如果它回报承诺，我们必须<code>await</code>。但是，如果给定的<code>pathname</code>有值，那么用户会被重定向到该URL。</p>
<p>现在，当我们访问<a href="http://localhost:8787/blog" rel="nofollow">http://localhost:8787/blog</a>时，我们将被重定向到我们放在KV中的实际博客URL。它看起来会像这样:</p>
<figure id="attachment_129001" aria-describedby="caption-attachment-129001" class="wp-caption aligncenter"><img data-attachment-id="129001" data-permalink="https://blog.logrocket.com/creating-url-shortener-cloudflare-workers/attachment/still-redirects-blog/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/08/still-redirects-blog.gif" data-orig-size="588,376" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Still redirects blog" data-image-description="" data-image-caption="&lt;p&gt;Visiting /blog still redirects us to the actual blog page.&lt;/p&gt;&#10;" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/08/still-redirects-blog-300x192.gif" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/08/still-redirects-blog.gif" decoding="async" class="size-full wp-image-129001 jetpack-lazy-image" src="../Images/59e4acbb317ae74b448d15d3d971fad5.png" alt="Still Redirects Blog" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2022/08/still-redirects-blog.gif?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/08/still-redirects-blog.gif"/><noscript><img data-lazy-fallback="1" data-attachment-id="129001" data-permalink="https://blog.logrocket.com/creating-url-shortener-cloudflare-workers/attachment/still-redirects-blog/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/08/still-redirects-blog.gif" data-orig-size="588,376" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Still redirects blog" data-image-description="" data-image-caption="&lt;p&gt;Visiting /blog still redirects us to the actual blog page.&lt;/p&gt;&#10;" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/08/still-redirects-blog-300x192.gif" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/08/still-redirects-blog.gif" decoding="async" loading="lazy" class="size-full wp-image-129001" src="../Images/59e4acbb317ae74b448d15d3d971fad5.png" alt="Still Redirects Blog" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/08/still-redirects-blog.gif"/></noscript><figcaption id="caption-attachment-129001" class="wp-caption-text">Visiting /blog still redirects us to the actual blog page.</figcaption></figure>
<p>但是，如果我们现在尝试访问我们硬编码的任何其他URL，我们将得到一条消息，说明这些URL缺少重定向:</p>
<figure id="attachment_129003" aria-describedby="caption-attachment-129003" class="wp-caption aligncenter"><img data-attachment-id="129003" data-permalink="https://blog.logrocket.com/creating-url-shortener-cloudflare-workers/attachment/url-missing-redirect/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/08/url-missing-redirect.gif" data-orig-size="588,376" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="URL missing redirect" data-image-description="" data-image-caption="&lt;p&gt;Visiting /twitter results in a message indicating the URL is missing a redirect.&lt;/p&gt;&#10;" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/08/url-missing-redirect-300x192.gif" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/08/url-missing-redirect.gif" decoding="async" class="size-full wp-image-129003 jetpack-lazy-image" src="../Images/3bb5f377e1edef762f520d0e025c025f.png" alt="URL Missing Redirect" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2022/08/url-missing-redirect.gif?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/08/url-missing-redirect.gif"/><noscript><img data-lazy-fallback="1" data-attachment-id="129003" data-permalink="https://blog.logrocket.com/creating-url-shortener-cloudflare-workers/attachment/url-missing-redirect/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/08/url-missing-redirect.gif" data-orig-size="588,376" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="URL missing redirect" data-image-description="" data-image-caption="&lt;p&gt;Visiting /twitter results in a message indicating the URL is missing a redirect.&lt;/p&gt;&#10;" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/08/url-missing-redirect-300x192.gif" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/08/url-missing-redirect.gif" decoding="async" loading="lazy" class="size-full wp-image-129003" src="../Images/3bb5f377e1edef762f520d0e025c025f.png" alt="URL Missing Redirect" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/08/url-missing-redirect.gif"/></noscript><figcaption id="caption-attachment-129003" class="wp-caption-text">Visiting /twitter results in a message indicating the URL is missing a redirect.</figcaption></figure>
<p>让我们使用以下命令快速将Twitter的缩写URL添加到KV中:</p>
<pre class="language-javascript hljs">$ wrangler kv:key put --binding SHORT_URLS "/twitter" "https://twitter.com/nikolalsvk" --preview false
⛅️ wrangler 2.0.21
--------------------
Writing the value "https://twitter.com/nikolalsvk" to key "/twitter" on namespace 029d374ebd984e19b0bb98e37ab1a95e.

$ wrangler kv:key put --binding SHORT_URLS "/twitter" "https://twitter.com/nikolalsvk" --preview
 ⛅️ wrangler 2.0.21
--------------------
Writing the value "https://twitter.com/nikolalsvk" to key "/twitter" on namespace 99a72876e5f84cf58de722b1c2080604.
</pre>
<p>现在，当我们刷新<a href="http://localhost:8787/twitter" rel="nofollow">http://localhost:8787/twitter</a>时，我们应该被重定向到Twitter帐户。</p>
<figure id="attachment_129005" aria-describedby="caption-attachment-129005" class="wp-caption aligncenter"><img data-attachment-id="129005" data-permalink="https://blog.logrocket.com/creating-url-shortener-cloudflare-workers/attachment/twitter-loading/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/08/twitter-loading.gif" data-orig-size="588,376" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Twitter loading" data-image-description="" data-image-caption="&lt;p&gt;Twitter loads after we added the shortened URL to the KV.&lt;/p&gt;&#10;" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/08/twitter-loading-300x192.gif" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/08/twitter-loading.gif" decoding="async" class="size-full wp-image-129005 jetpack-lazy-image" src="../Images/eae6ea2c03624a2cb74329afae514bd9.png" alt="Twitter Loading" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2022/08/twitter-loading.gif?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/08/twitter-loading.gif"/><noscript><img data-lazy-fallback="1" data-attachment-id="129005" data-permalink="https://blog.logrocket.com/creating-url-shortener-cloudflare-workers/attachment/twitter-loading/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/08/twitter-loading.gif" data-orig-size="588,376" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Twitter loading" data-image-description="" data-image-caption="&lt;p&gt;Twitter loads after we added the shortened URL to the KV.&lt;/p&gt;&#10;" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/08/twitter-loading-300x192.gif" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/08/twitter-loading.gif" decoding="async" loading="lazy" class="size-full wp-image-129005" src="../Images/eae6ea2c03624a2cb74329afae514bd9.png" alt="Twitter Loading" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/08/twitter-loading.gif"/></noscript><figcaption id="caption-attachment-129005" class="wp-caption-text">Twitter loads after we added the shortened URL to the KV.</figcaption></figure>
<p>厉害了，现在我们有两个短网址:<code>/blog</code>和<code>/twitter</code>。让我们尝试部署我们的服务，并在生产中看到它。</p>
<h2 id="deploying-cloudflare-workers">部署Cloudflare工作人员</h2>
<p>Cloudflare Workers部署步骤相当简单。我们将利用<code>wrangler publish</code>，就像这样:</p>
<pre class="language-javascript hljs">$ wrangler publish
 ⛅️ wrangler 2.0.21
--------------------
Retrieving cached values for userId from node_modules/.cache/wrangler
Your worker has access to the following bindings:
- KV Namespaces:
  - SHORT_URLS: 029d374ebd984e19b0bb98e37ab1a95e
Total Upload: 0.45 KiB / gzip: 0.29 KiB
Worker ID: short-it
Worker ETag: f8395cab29edf297137631b803b14c32daaae982758c23e3019b700e2468c277
Uploaded short-it (2.14 sec)
Published short-it (6.33 sec)
  short-it.nikolalsvk.workers.dev
</pre>
<p>现在，这些服务已经在https://short-it . nikolalsvk . workers . dev上线。耶！</p>
<p>如果你按照本教程学习，你的服务应该位于URL <a href="https://short-it.YOUR_SUBDOMAIN.workers.dev" rel="nofollow"> https://short-it的某个地方。YOUR_SUBDOMAIN.workers.dev </a>，这取决于您为<code>YOUR_SUBDOMAIN</code>选择的内容。</p>
<p>此时，我们的Worker脚本已在全球部署在Cloudflare Edge网络上。这意味着，如果世界各地的朋友和陌生人访问https://short-it.nikolalsvk.workers.dev/twitter，他们会以惊人的速度被重定向到我们的Twitter账户。</p>
<h2 id="wrapping-up">包扎</h2>
<p>感谢您跟随我们的旅程，使用Cloudflare Workers创建简单的URL shortener服务。在本文中，我们介绍了Cloudflare上下文中的Worker的概念。我们还演示了如何在Cloudflare的KV存储中创建和管理数据。</p>
<p>我们能够使用牧马人平稳地执行所有这些，这提供了一个很好的开发人员体验。但是，最重要的是，我们设法创建、测试和部署了我们的小型服务，它可以在世界的各个角落快速运行。</p>
<p>在类似的技术或服务中实现这一点可能需要大量的金钱和努力。然而，Cloudflare支持每天100，000个请求的大量免费层。因此，你可以缩短许多网址，并在进入付费计划之前有许多访问。</p>
<p>本文中的所有代码都可以在<a href="https://github.com/nikolalsvk/short-it" target="_blank" rel="noopener"> GitHub repo </a>中获得(如果你喜欢的话，请给它打星号)。shortener服务在<a href="https://short-it.nikolalsvk.workers.dev" rel="nofollow">https://short-it . nikolalsvk . workers . dev</a>上线。</p>
<p>如果你喜欢这篇文章，请考虑与你的朋友和同事分享。</p>
<p>下次见，干杯！</p><div class="code-block code-block-2">
<div class="blog-plug base-cta"><h2>使用<a class="signup" href="https://lp.logrocket.com/blg/signup" target="_blank" rel="noopener noreferrer"> LogRocket </a>消除传统错误报告的干扰</h2>
<a href="https://lp.logrocket.com/blg/signup" class="signup" target="_blank" rel="noopener noreferrer"><img class="alignnone size-full wp-image-46 jetpack-lazy-image" src="../Images/d6f5a5dd739296c1dd7aab3d5e77eeb9.png" alt="LogRocket Dashboard Free Trial Banner" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2017/03/1d0cd-1s_rmyo6nbrasp-xtvbaxfg.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2017/03/1d0cd-1s_rmyo6nbrasp-xtvbaxfg.png"/><noscript><img data-lazy-fallback="1" class="alignnone size-full wp-image-46" src="../Images/d6f5a5dd739296c1dd7aab3d5e77eeb9.png" alt="LogRocket Dashboard Free Trial Banner" data-original-src="https://blog.logrocket.com/wp-content/uploads/2017/03/1d0cd-1s_rmyo6nbrasp-xtvbaxfg.png"/></noscript></a>
<p><a href="https://lp.logrocket.com/blg/signup" target="_blank" rel="noopener noreferrer"> LogRocket </a>是一个数字体验分析解决方案，它可以保护您免受数百个假阳性错误警报的影响，只针对几个真正重要的项目。LogRocket会告诉您应用程序中实际影响用户的最具影响力的bug和UX问题。</p>
<p>然后，使用具有深层技术遥测的会话重放来确切地查看用户看到了什么以及是什么导致了问题，就像你在他们身后看一样。</p>
<p>LogRocket自动聚合客户端错误、JS异常、前端性能指标和用户交互。然后LogRocket使用机器学习来告诉你哪些问题正在影响大多数用户，并提供你需要修复它的上下文。</p>
<p>关注重要的bug—<a class="signup" href="https://lp.logrocket.com/blg/signup-issue-free" target="_blank" rel="noopener noreferrer">今天就试试LogRocket】。</a></p></div></div>

<p class="clearfix"/>
<p class="clearfix"/>
</article>

</div>    
</body>
</html>