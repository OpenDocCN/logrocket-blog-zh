<html>
<head>
<title>Understanding API key authentication in Node.js </title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>了解Node.js中的API密钥认证</h1>
<blockquote>原文：<a href="https://blog.logrocket.com/understanding-api-key-authentication-node-js/#0001-01-01">https://blog.logrocket.com/understanding-api-key-authentication-node-js/#0001-01-01</a></blockquote><div><article class="article-post">
<p>使用Node.js构建API时，有不同的认证选项。其中包括JSON Web令牌、OAuth、API密匙等等。在本文中，我们将学习如何使用API密钥来认证Node.js API。</p>
<p>如果您想要设置一个限制或者跟踪特定用户使用API的频率，那么使用API键是有优势的。通过使用API密钥，用户无需担心用户名和密码的多重身份验证。您的API用户将能够在应用程序上自动获取数据。</p>
<p>在本教程中，我们将使用Node.js创建一个API。然后，我们将创建一个身份验证系统，每当用户在应用程序上注册时，该系统都会创建一个API密钥。使用新创建的API键，用户将能够访问API上的所有路线。</p>
<p>你可以在<a href="https://github.com/khabdrick/api-key-nodejs"> GitHub </a>上找到完整的代码。要阅读本文，您需要:</p>
<ul>
<li>Node.js的基础知识</li>
<li><a href="https://nodejs.org/en/download/">节点</a> <a href="https://nodejs.org/en/download/">。js </a>安装在您的机器上</li>
</ul>
<h2 id="tableofcontents">目录</h2>

<h2 id="initial-project-setup">初始项目设置</h2>
<p>首先，我们将处理运行应用程序的所有安装和初始设置。我们将使用<a href="https://expressjs.com/"> Express </a>来开发API，使用<a href="https://nodemon.io/"> Nodemon </a>来运行API服务器，并实时监听代码中的变化。</p>
<p>我们必须安装它们，但是首先，为您的项目创建一个文件夹，并运行以下命令为您的项目创建一个<code>package.json</code>文件:</p>
<pre class="language-bash hljs">$ npm init -y
</pre>
<p>现在，用下面的代码更新您的<code>package.json</code>文件中的<code>"scripts"</code>模块，以便我们能够用Nodemon运行服务器:</p>
<pre class="language-javascript hljs">...
"scripts": {
    "test": "echo \"Error: no test specified\" &amp;&amp; exit 1",
    "dev": "nodemon Server.js"
  }
...
</pre>
<p>在本文的后面，我们将创建<code>Server.js</code>文件，从中运行服务器。现在，通过运行以下命令安装Nodemon和Express:</p>
<pre>npm install express nodemon
</pre>
<h2 id="build-authentication-system">构建认证系统</h2>
<p>身份验证系统接收给定的用户名并创建用户数据，其中包含用户名、API密钥和特定日期的使用次数。我们需要这个计数，这样我们就可以限制用户在某一天使用API的次数。</p>
<p>我们将从创建一个名为<code>genAPIKey()</code>的函数开始，该函数在创建新用户时生成API。该函数将在<code>A-Z</code>和<code>0-9</code>中生成一个包含30个字符的<code>base-36</code>字符串，它将代表API键。首先，您可以创建一个名为<code>apiAuth.js</code>的新JavaScript文件，并粘贴以下代码:</p>
<pre class="language-javascript hljs">const genAPIKey = () =&gt; {
  //create a base-36 string that contains 30 chars in a-z,0-9
  return [...Array(30)]
    .map((e) =&gt; ((Math.random() * 36) | 0).toString(36))
    .join('');
};
</pre>
<p>接下来，我们将开发一个在输入用户名时创建用户数据的函数。我们将把这个新用户存储在一个数组中，所以我们需要一些初始数据来开始。创建一个名为<code>initialData.js</code>的新文件，并粘贴以下代码:</p>
<pre class="language-javascript hljs">const users = [
  {
    _id: 1587912,
    api_key: "rwuy6434tgdgjhtiojiosi838tjue3",
    username: "username",
    usage: [{ date: "2022-10-10", count: 17 }],
  },
];
const Countries = [
  { _id: 1, name: "Nigeria" },
  { _id: 2, name: "China" },
];
module.exports = { users, Countries };
</pre>
<p>现在，我们将开发通过在<code>apiAuth.js</code>文件中粘贴以下代码来创建用户的函数:</p>
<pre>const users = require('./initialData').users; // import initial data
...

const createUser = (_username, req) =&gt; {
  let today = new Date().toISOString().split('T')[0];
  let user = {
    _id: Date.now(),
    api_key: genAPIKey(),
    username: _username,
    usage: [{ date: today, count: 0 }],
  };

  console.log('add user');
  users.push(user);
  return user;
};
</pre>
<p>接下来，我们将开发一个验证API密钥的函数，以便您可以访问API的指定部分。该函数将注册的API密钥与请求中的<code>x-api-key</code>进行比较。</p>
<p>如果请求通过，每天的计数会增加，如果您达到了每天的最大请求数，您会收到一个错误。将以下代码粘贴到您的<code>apiAuth.js</code>文件中:</p>
<pre>const authenticateKey = (req, res, next) =&gt; {
  let api_key = req.header("x-api-key"); //Add API key to headers
  let account = users.find((user) =&gt; user.api_key == api_key);
  // find() returns an object or undefined
  if (account) {
    //If API key matches
    //check the number of times the API has been used in a particular day
    let today = new Date().toISOString().split("T")[0];
    let usageCount = account.usage.findIndex((day) =&gt; day.date == today);
    if (usageCount &gt;= 0) {
      //If API is already used today
      if (account.usage[usageCount].count &gt;= MAX) {
        //stop if the usage exceeds max API calls
        res.status(429).send({
          error: {
            code: 429,
            message: "Max API calls exceeded.",
          },
        });
      } else {
        //have not hit todays max usage
        account.usage[usageCount].count++;
        console.log("Good API call", account.usage[usageCount]);
        next();
      }
    } else {
      //Push todays's date and count: 1 if there is a past date
      account.usage.push({ date: today, count: 1 });
      //ok to use again
      next();
    }
  } else {
    //Reject request if API key doesn't match
    res.status(403).send({ error: { code: 403, message: "You not allowed." } });
  }
};
module.exports = { createUser, authenticateKey };
</pre>
<p>我们正在导出以便<code>Server.js</code>可以使用这些函数。</p>
<h2 id="develop-routes-for-server">为服务器开发路由</h2>
<p>在本节中，我们将创建在应用API键检查时用于访问API中的数据的路由。我们将创建端点来注册用户，将国家添加到国家列表中，并获取国家列表。添加或获取国家/地区的请求将需要API密钥认证。</p>
<p>首先，创建一个名为<code>Server.js</code>的新文件，并粘贴下面的代码。该代码包含我们稍后将使用的导入，以及将在主页上输出的内容:</p>
<pre>const express = require('express');
const app = express();
const port = 4000;
const API = require('./apiAuth');

// Get initial data for users and countries
const { users, Countries } = require('./initialData');
//handle json body request
app.use(express.json());

app.get('/', (req, res) =&gt; {
  //home page
  res.status(200).send({ data: { message: 'You can get list of countires at /api/country.' } });
});
</pre>
<p>使用我们之前开发的<code>createUser()</code>函数，我们将创建一个向用户列表添加新用户并生成用户数据的路由。将以下代码粘贴到您的<code>Server.js</code>文件中:</p>
<pre>...
app.post('/api/register', (req, res) =&gt; {
  //create a new with "user:Username"
  let username = req.body.username;
  let user = API.createUser(username, req);
  res.status(201).send({ data: user });
});
</pre>
<p>现在，我们将开发创建和获取国家的路线。在这个路径中，我们将包含我们之前开发的<code>authenticateKey()</code>函数，以便在请求头中发送的API密钥可以被认证，并且请求可以被计数。然后，我们将最终设置服务器应该监听的端口。将以下代码粘贴到您的<code>Server.js</code>文件中:</p>
<pre>app.get('/api/country', API.authenticateKey, (req, res) =&gt; {
  //get list of all Countries   
  let today = new Date().toISOString().split('T')[0];
  console.log(today);
  res.status(200).send({
    data: Countries,
  });
});
app.post('/api/country', API.authenticateKey, (req, res) =&gt; {
  //add a new country
  let country = {
    _id: Date.now(),
    name: req.body.country,
  };
  Countries.push(country);
  res.status(201).send({
    data: country,
  });
});

app.listen(port, function (err) {
  if (err) {
    console.error('Failure to launch server');
    return;
  }
  console.log(`Listening on port ${port}`);
});
</pre>
<p>现在，我们已经完成了本教程的编码部分，我们可以进入测试了。我们将使用<a href="https://curl.se/"> cURL </a>测试API端点。在测试之前，打开您的终端并运行以下命令来启动服务器:</p>
<pre>npm run dev
</pre>
<p>打开另一个终端窗口，运行以下命令创建一个新用户。一旦命令运行，您将获得一些用户数据，其中一个包括API键:</p>
<pre>curl -d "user:User1" -X POST http://127.0.0.1:4000/api/register -w "\n"
</pre>
<p><img data-attachment-id="142346" data-permalink="https://blog.logrocket.com/understanding-api-key-authentication-node-js/attachment/create-new-user-api-key/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/11/create-new-user-api-key.png" data-orig-size="730,82" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="create-new-user-api-key" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/11/create-new-user-api-key-300x34.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/11/create-new-user-api-key.png" decoding="async" class="aligncenter wp-image-142346 size-full jetpack-lazy-image" src="../Images/a6f916ef169815e7947cd652b6402067.png" alt="Create New User API Key" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2022/11/create-new-user-api-key.png 730w, https://blog.logrocket.com/wp-content/uploads/2022/11/create-new-user-api-key-300x34.png 300w" data-lazy-sizes="(max-width: 730px) 100vw, 730px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2022/11/create-new-user-api-key.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/11/create-new-user-api-key.png"/></p><noscript><img data-lazy-fallback="1" data-attachment-id="142346" data-permalink="https://blog.logrocket.com/understanding-api-key-authentication-node-js/attachment/create-new-user-api-key/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/11/create-new-user-api-key.png" data-orig-size="730,82" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="create-new-user-api-key" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/11/create-new-user-api-key-300x34.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/11/create-new-user-api-key.png" decoding="async" loading="lazy" class="aligncenter wp-image-142346 size-full" src="../Images/a6f916ef169815e7947cd652b6402067.png" alt="Create New User API Key" srcset="https://blog.logrocket.com/wp-content/uploads/2022/11/create-new-user-api-key.png 730w, https://blog.logrocket.com/wp-content/uploads/2022/11/create-new-user-api-key-300x34.png 300w" sizes="(max-width: 730px) 100vw, 730px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/11/create-new-user-api-key.png"/></noscript>
<p>现在您已经创建了一个用户，您可以使用国家端点。让我们尝试使用提供给我们的API键来检索列表中的国家。您可以通过运行下面的命令来做到这一点。确保用您自己的API密钥替换下面命令中的<code>2agp59nwu8nrszm4p6kfriekoeo0s1</code>:</p>
<pre>curl http://127.0.0.1:4000/api/country -H "x-api-key: 2agp59nwu8nrszm4p6kfriekoeo0s1" -w  "\n"
</pre>
<p><img data-attachment-id="142344" data-permalink="https://blog.logrocket.com/understanding-api-key-authentication-node-js/attachment/retrieve-country-endpoints/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/11/retrieve-country-endpoints.png" data-orig-size="730,82" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="retrieve-country-endpoints" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/11/retrieve-country-endpoints-300x34.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/11/retrieve-country-endpoints.png" decoding="async" class="aligncenter wp-image-142344 size-full jetpack-lazy-image" src="../Images/4d9f554b54cff229d5ce9bd2351a9c35.png" alt="Retrieve Country Endpoints" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2022/11/retrieve-country-endpoints.png 730w, https://blog.logrocket.com/wp-content/uploads/2022/11/retrieve-country-endpoints-300x34.png 300w" data-lazy-sizes="(max-width: 730px) 100vw, 730px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2022/11/retrieve-country-endpoints.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/11/retrieve-country-endpoints.png"/></p><noscript><img data-lazy-fallback="1" data-attachment-id="142344" data-permalink="https://blog.logrocket.com/understanding-api-key-authentication-node-js/attachment/retrieve-country-endpoints/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/11/retrieve-country-endpoints.png" data-orig-size="730,82" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="retrieve-country-endpoints" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/11/retrieve-country-endpoints-300x34.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/11/retrieve-country-endpoints.png" decoding="async" loading="lazy" class="aligncenter wp-image-142344 size-full" src="../Images/4d9f554b54cff229d5ce9bd2351a9c35.png" alt="Retrieve Country Endpoints" srcset="https://blog.logrocket.com/wp-content/uploads/2022/11/retrieve-country-endpoints.png 730w, https://blog.logrocket.com/wp-content/uploads/2022/11/retrieve-country-endpoints-300x34.png 300w" sizes="(max-width: 730px) 100vw, 730px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/11/retrieve-country-endpoints.png"/></noscript>
<h2 id="conclusion">结论</h2>
<p>在本教程中，我们用Node.js创建了一个API，并开发了一个身份验证系统，每当用户注册时，该系统都会生成一个API密钥。使用新创建的API键，用户能够访问API上的所有路线，并且可以跟踪API的使用情况。</p>
<p>您可以通过向使用数据库存储数据的Node.js API添加API密钥身份验证来构建您在本文中获得的知识。除了用户身份验证之外，您还可以使用API密匙来获得本文介绍部分提到的优势。</p><div class="code-block code-block-23">
<div class="blog-plug inline-plug node-plug"><h2>200只<img src="../Images/61167b9d027ca73ed5aaf59a9ec31267.png" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2019/10/green-check.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" class=" jetpack-lazy-image" data-original-src="https://blog.logrocket.com/wp-content/uploads/2019/10/green-check.png"/> <noscript> <img data-lazy-fallback="1" src="../Images/61167b9d027ca73ed5aaf59a9ec31267.png" data-original-src="https://blog.logrocket.com/wp-content/uploads/2019/10/green-check.png"/> </noscript>显示器出现故障，生产中网络请求缓慢</h2><p>部署基于节点的web应用程序或网站是容易的部分。确保您的节点实例继续为您的应用程序提供资源是事情变得更加困难的地方。如果您对确保对后端或第三方服务的请求成功感兴趣，</p><a href="https://lp.logrocket.com/blg/node-signup" target="_blank">try LogRocket</a><p>. </p><a class="signup" href="https://lp.logrocket.com/blg/node-signup" target="_blank" rel="noopener noreferrer"><img src="../Images/cae72fd2a54c5f02a6398c4867894844.png" alt="LogRocket Network Request Monitoring" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2019/12/network-request-filter-2-1.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" class=" jetpack-lazy-image" data-original-src="https://blog.logrocket.com/wp-content/uploads/2019/12/network-request-filter-2-1.png"/><noscript><img data-lazy-fallback="1" src="../Images/cae72fd2a54c5f02a6398c4867894844.png" alt="LogRocket Network Request Monitoring" data-original-src="https://blog.logrocket.com/wp-content/uploads/2019/12/network-request-filter-2-1.png"/></noscript></a><a href="https://lp.logrocket.com/blg/node-signup" target="_blank" rel="noopener noreferrer">https://logrocket.com/signup/</a><p>LogRocket 就像是网络和移动应用程序的DVR，记录下用户与你的应用程序交互时发生的一切。您可以汇总并报告有问题的网络请求，以快速了解根本原因，而不是猜测问题发生的原因。</p><p>LogRocket检测您的应用程序以记录基线性能计时，如页面加载时间、到达第一个字节的时间、慢速网络请求，还记录Redux、NgRx和Vuex操作/状态。</p><a class="signup" href="https://lp.logrocket.com/blg/node-signup" target="_blank" rel="noopener noreferrer">Start monitoring for free</a><p>. </p></div>
</div>

<p class="clearfix"/>
<p class="clearfix"/>
</article>

</div>    
</body>
</html>