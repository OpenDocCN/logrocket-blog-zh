<html>
<head>
<title>Using dangerouslySetInnerHTML in a React application - LogRocket Blog</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>在 React 应用程序中使用 dangerouslySetInnerHTML</h1>
<blockquote>原文：<a href="https://blog.logrocket.com/using-dangerouslysetinnerhtml-in-a-react-application/#0001-01-01">https://blog.logrocket.com/using-dangerouslysetinnerhtml-in-a-react-application/#0001-01-01</a></blockquote><div><article class="article-post">
<p>本文介绍了在 React 应用程序中使用<code>dangerouslySetInnerHTML</code>属性的原因，它相当于浏览器 DOM 中的<code>innerHTML</code>属性。</p>
<h2>什么是<code>dangerouslySetInnerHTML</code>？</h2>
<p><code>dangerouslySetInnerHTML</code>是一个属性，可以在 React 应用程序中的 HTML 元素上使用，以编程方式设置它们的内容。您可以直接在元素上使用这个属性，而不是使用选择器来获取 HTML 元素，然后设置它的<code>innerHTML</code>。</p>
<p>当使用<code>dangerouslySetInnerHTML</code>时，React 也知道该特定元素的内容是动态的，并且对于该节点的子节点，它简单地跳过与虚拟 DOM 的比较以获得一些额外的性能。</p>
<p>正如该属性的名称所暗示的，使用它可能很危险，因为它使您的代码容易受到跨站点脚本(XSS)攻击。这就成了一个问题，尤其是当您从第三方数据源获取数据或呈现用户提交的内容时。</p>
<h2>何时使用<code>dangerouslySetInnerHTML</code></h2>
<p>需要设置 DOM 元素的 HTML 内容的一个用例是用来自富文本编辑器的数据填充<code>&lt;div&gt;</code>元素。假设您有一个网页，人们可以在其中提交评论，并且您允许他们使用富文本编辑器。在这种情况下，富文本编辑器的输出很可能是带有标签如<code>&lt;p&gt;</code>、<code>&lt;b&gt;</code>和<code>&lt;img&gt;</code>的 HTML。</p>
<p>考虑下面的代码片段，它将呈现字符串，而不知道其中的<code>&lt;b&gt;</code>标记——这意味着输出将只是字符串本身，没有任何粗体文本，如下所示:lorem &lt; b &gt; ipsum &lt; /b &gt;。</p>
<pre>const App = () =&gt; {
  const data = 'lorem &lt;b&gt;ipsum&lt;/b&gt;';

  return (
    &lt;div&gt;
      {data}
    &lt;/div&gt;
  );
}

export default App;
</pre>
<p>但是当使用<code>dangerouslySetInnerHTML</code>时，React 会意识到 HTML 标签并正确地呈现它们。这一次，输出将使用粗体文本正确呈现(例如，lorem <strong> ipsum </strong>)。</p>
<pre>const App = () =&gt; {
  const data = 'lorem &lt;b&gt;ipsum&lt;/b&gt;';

  return (
    &lt;div
      dangerouslySetInnerHTML={{__html: data}}
    /&gt;
  );
}

export default App;
</pre>
<p>注意，它应该是一个将<code>__html</code>键传递给<code>dangerouslySetInnerHTML</code>的对象。除此之外，您使用<code>dangerouslySetInnerHTML</code>属性的元素不应该有任何子元素，因此使用<code>&lt;div&gt;</code>元素作为自结束标记。</p>
<p>传递对象的要求只是防止开发人员在没有浏览文档和意识到潜在危险的情况下使用它的另一种保护措施。</p>
<h2>使用<code>dangerouslySetInnerHTML</code>时的消毒</h2>
<p>上述示例在渲染时不会造成危险。但是，在某些情况下，HTML 元素可能会执行脚本。</p>
<p>考虑下面的例子，其中 JavaScript 事件被附加到 HTML 元素。虽然这些都是无害的例子，但它们是概念的证明，展示了 HTML 元素如何被利用来运行恶意脚本。</p>
<pre>const App = () =&gt; {
  const data = `lorem &lt;b onmouseover="alert('mouseover');"&gt;ipsum&lt;/b&gt;`;

  return (
    &lt;div
      dangerouslySetInnerHTML={{__html: data}}
    /&gt;
  );
}

export default App;


const App = () =&gt; {
  const data = `lorem ipsum &lt;img src="" onerror="alert('message');" /&gt;`;

  return (
    &lt;div
      dangerouslySetInnerHTML={{__html: data}}
    /&gt;
  );
}

export default App;
</pre>
<p>幸运的是，HTML 有净化工具，可以检测 HTML 代码中潜在的恶意部分，然后输出干净安全的版本。最受欢迎的 HTML 杀毒软件是 DOMPurify。</p>
<p>让我们用它的<a href="https://cure53.de/purify" target="_blank" rel="noopener">在线演示</a>来净化上面提到的 HTML 代码，看看它是如何检测和过滤掉执行时可能有危险的代码部分的。</p>
<pre>Original
lorem &lt;b onmouseover="alert('mouseover');"&gt;ipsum&lt;/b&gt;

Sanitized
lorem &lt;b&gt;ipsum&lt;/b&gt;
</pre>
<pre>Original
lorem ipsum &lt;img src="" onerror="alert('message');" /&gt;

Sanitized
lorem ipsum &lt;img src=""&gt;
</pre>
<p>即使我们信任数据的来源，使用杀毒软件也是一个好习惯。使用 DOMPurify 包，上面的一个例子如下:</p>
<pre>import DOMPurify from 'dompurify'

const App = () =&gt; {
  const data = `lorem &lt;b onmouseover="alert('mouseover');"&gt;ipsum&lt;/b&gt;`
  const sanitizedData = () =&gt; ({
    __html: DOMPurify.sanitize(data)
  })

  return (
    &lt;div
      dangerouslySetInnerHTML={sanitizedData()}
    /&gt;
  );
}

export default App;
</pre>
<p><code>sanitizedData</code>函数返回一个带有<code>__html</code>键的对象，该对象有一个从<code>DOMPurify.sanitize</code>函数返回的值。</p>
<p>正如所料，当我们悬停在粗体文本上时，不会执行任何警告功能。</p>
<p>注意，因为 DOMPurify 需要一个 DOM 树，而节点环境没有，您要么必须使用<code>jsdom</code>包来创建一个<code>window</code>对象并用它初始化<code>DOMPurify</code>，要么单独使用<code>isomorphic-dompurify</code>包，它封装了<code>DOMPurify</code>和<code>jsdom</code>包。</p>
<p>如果你倾向于第一种选择，你可以参考下面来自<code>DOMPurify</code>文档的片段。</p>
<pre>const createDOMPurify = require('dompurify');
const { JSDOM } = require('jsdom');

const window = new JSDOM('').window;
const DOMPurify = createDOMPurify(window);

const clean = DOMPurify.sanitize(dirty);
</pre>
<h2>结论</h2>
<p>总之，<code>dangerouslySetInnerHTML</code>不过是 React 中<code>innerHTML</code>的替代品，应该小心使用。尽管其名称暗示了其使用中的危险，但是通过使用开发良好的杀毒程序来采取必要的措施可以确保代码是干净的，并且在 React 节点中呈现时不会运行意外的脚本。</p><div class="code-block code-block-17">
<div class="blog-plug inline-plug react-plug" vwo-el-id="26283398190">
<h2 vwo-el-id="41600691720">使用 LogRocket 消除传统反应错误报告的噪音</h2>
<a href="https://lp.logrocket.com/blg/react-signup-issue-free" target="_blank" vwo-el-id="19356441070">LogRocket
</a><p>是一款 React analytics 解决方案，可保护您免受数百个误报错误警报的影响，只针对少数真正重要的项目。LogRocket 告诉您 React 应用程序中实际影响用户的最具影响力的 bug 和 UX 问题。</p><a class="signup" href="https://lp.logrocket.com/blg/react-signup-general" target="_blank" rel="noopener noreferrer" vwo-el-id="19356441380">
<img class="first-react-image alignnone size-full wp-image-46 jetpack-lazy-image jetpack-lazy-image--handled" src="../Images/f300c244a1a1cf916df8b4cb02bec6c6.png" vwo-el-id="18272717540" data-lazy-loaded="1" data-original-src="https://files.readme.io/27c94e7-Image_2017-06-05_at_9.46.04_PM.png"/>
</a>
<a class="signup" href="https://lp.logrocket.com/blg/react-signup-general" target="_blank" rel="noopener noreferrer" vwo-el-id="19356441690">
<img class="second-react-image alignnone size-full wp-image-46 jetpack-lazy-image jetpack-lazy-image--handled" src="../Images/d6f5a5dd739296c1dd7aab3d5e77eeb9.png" alt="LogRocket Dashboard Free Trial Banner" vwo-el-id="30720362350" data-lazy-loaded="1" data-original-src="https://blog.logrocket.com/wp-content/uploads/2017/03/1d0cd-1s_rmyo6nbrasp-xtvbaxfg.png"/>
</a>
<a href="https://lp.logrocket.com/blg/react-signup-issue-free" target="_blank" rel="noopener noreferrer" vwo-el-id="35866400580">LogRocket
</a><p>自动聚合客户端错误、反应错误边界、还原状态、缓慢的组件加载时间、JS 异常、前端性能指标和用户交互。然后，LogRocket 使用机器学习来通知您影响大多数用户的最具影响力的问题，并提供您修复它所需的上下文。</p><p vwo-el-id="28675661060">关注重要的 React bug—<a class="signup" href="https://lp.logrocket.com/blg/react-signup-issue-free" target="_blank" rel="noopener noreferrer" vwo-el-id="40093418840">今天就试试 LogRocket】。</a></p>
</div></div>

<p class="clearfix"/>
<p class="clearfix"/>
</article>

</div>    
</body>
</html>