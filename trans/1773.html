<html>
<head>
<title>Filtering QuerySets dynamically in Django - LogRocket Blog</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>在 Django - LogRocket 博客中动态过滤查询集</h1>
<blockquote>原文：<a href="https://blog.logrocket.com/filtering-querysets-dynamically-in-django/#0001-01-01">https://blog.logrocket.com/filtering-querysets-dynamically-in-django/#0001-01-01</a></blockquote><div><article class="article-post">
<h2>介绍</h2>
<p>要构建一个允许过滤和分页的列表页面，您必须将一些独立的东西组合在一起。Django 的对象关系映射器(ORM)和内置的分页类使开发人员在不了解如何处理数据库和 SQL 的情况下也能轻松提高工作效率。在本指南中，您将学习如何使用 AJAX 动态过滤查询集。</p>
<p>对于本文中的例子，我在这里按国家<a href="https://www.kaggle.com/leonardopena/top-50-spotify-songs-by-each-country">取了 Spotify 上排名前 50 的歌曲的数据集</a>。你也可以从<a href="https://github.com/krazygaurav/qs-filter-django/blob/master/top50contry.csv">这里</a>下载相同的数据集。像往常一样，本指南中使用的代码可以在 GitHub 上获得。您可以在本指南的末尾找到链接。</p>
<h2>入门指南</h2>
<p>首先，像这样开始一个新的 Django 项目:</p>
<pre>django-admin startproject my_proj
</pre>
<p>然后，创建一个示例应用程序:</p>
<pre>cd my_proj
python manage.py startapp my_app
</pre>
<p>更新<code>settings.py</code>:</p>
<pre>INSTALLED_APPS += [
    'my_app'
]
</pre>
<p>以下是您将在指南中遵循的目录结构:</p>
<pre>├── db.sqlite3
├── manage.py
├── my_app/
│   ├── __init__.py
│   ├── admin.py
│   ├── apps.py
│   ├── migrations/
│   ├── models.py
│   ├── templates/
│   │   ├── base.html
│   │   └── index.html
│   ├── tests.py
│   └── views.py
├── my_proj/
│   ├── __init__.py
│   ├── asgi.py
│   ├── settings.py
│   ├── urls.py
│   └── wsgi.py
└── top50contry.csv
└── requirements.txt
</pre>
<h2>数据准备</h2>
<p>在跳转到实际代码之前，我们首先需要将所有数据推送到数据库。</p>
<p>我已经创建了一个名为<code>TopSongPoularity</code>的基本模型来存储来自数据集的必要信息。</p>
<p>下面是<code>my_app</code>的<code>models.py</code>:</p>
<pre>## my_app/models.py

from django.db import models

class TopSongPoularity(models.Model):
    title = models.CharField(max_length = 220)
    artist = models.CharField(max_length = 220)
    top_genre = models.CharField(max_length = 220)
    year = models.IntegerField()
    pop = models.IntegerField()
    duration = models.IntegerField()
    country = models.CharField(max_length = 100)

    def __str__(self):
        return self.title
</pre>
<p>现在您已经创建了模型，通过以下方式将其迁移到数据库:</p>
<pre>python manage.py makemigrations
python manage.py migrate
</pre>
<p>接下来，我们必须将所有 CSV 数据推送到数据库，因此我们将使用 shell 来执行一个脚本:</p>
<pre>python manage.py shell
</pre>
<p>在 shell 中运行以下脚本，将 CSV 数据推送到数据库:</p>
<pre>#Django Shell
import csv
from datetime import datetime

from my_app.models import TopSongPoularity

with open('top50contry.csv', 'r') as fin:
    reader = csv.reader(fin)
    headers = next(reader, None)
    for row in reader:
        obj = {
            "title": row[1],
            "artist": row[2],
            "top_genre": row[3],
            "year": int(row[4]),
            "pop": int(row[15]),
            "duration": int(row[12]),
            "country": row[16]
        }
        TopSongPoularity.objects.create(**obj)
</pre>
<h2>创建视图</h2>
<p>接下来，我们来写观点。<code>ListTopSongs</code>是一个基于类的视图(CBV ),它继承了<code>View</code>类。在该类的<code>get()</code>方法中，它接受查询参数并相应地过滤查询集。在 QuerySet 被过滤后，它调用<code>get_paginated_context()</code>来获取序列化格式的分页数据。</p>
<p><code>getCountries()</code>是一个基于函数的视图(FBV ),它返回数据库中所有唯一国家的 JSON 输出:</p>
<pre>#my_app/views.py
import json

from django.core.paginator import Paginator
from django.core.serializers import serialize
from django.http import JsonResponse
from django.shortcuts import render
from django.views import View

from .models import TopSongPoularity

def index(request):
    return render(request, "index.html", {})

class ListTopSongs(View):
    # set default page limit as 10
    page_limit = 10 # default

    '''
    Helper method to get the pagination context
    out of queryset of given page number with limit.
    Args: 
        queryset: Filtered queryset object
        page: a number representing the page number
        limit: the result count, per page.

    Returns the JSON of queryset for the given page, 
        with pagination meta info.
    '''
    def get_paginated_context(self, queryset, page, limit):
        if not page:    page = 1 # if no page provided, set 1

        # if limit specified, set the page limit
        if limit:   
            self.page_limit = limit  

        # instantiate the paginator object with queryset and page limit
        paginator = Paginator(queryset, self.page_limit)
        # get the page object
        page_obj = paginator.get_page(page)
        # serialize the objects to json
        serialized_page = serialize("json", page_obj.object_list)
        # get only required fields from the serialized_page json.
        serialized_page = [obj["fields"] for obj in json.loads(serialized_page)]

        # return the context.
        return {
            "data": serialized_page,
            "pagination": {
                "page": page,
                "limit": limit,
                "has_next": page_obj.has_next(),
                "has_prev": page_obj.has_previous(),
                "total": queryset.count()
            }
        }

    '''
    GET method for this View.
    '''
    def get(self, request, *args, **kwargs):
        # fetch the query params
        page = request.GET.get('page')
        limit = request.GET.get('limit')
        country = request.GET.get('country')
        start = request.GET.get('start')
        end = request.GET.get('end')

        sort_by = request.GET.get('sort_by')
        # get all results from DB.
        queryset = TopSongPoularity.objects.all()

        '''filter the queryset object based on query params'''
        # 1. on basis of country
        if country and country != "all":
            queryset = queryset.filter(country=country)
        # 2. On basis of date (start and end date)
        if start and end:
            if start != "0" and end != "0":
                queryset = queryset.filter(
                    year__gte = start, 
                    year__lte = end
                )

        # 3. Sorting the filtered queryset
        if sort_by and sort_by != "0":
            queryset = queryset.order_by(sort_by)

        # return the serialized output by 
        # calling method 'get_paginated_context'
        to_return = self.get_paginated_context(queryset, page, limit)
        return JsonResponse(to_return, status = 200)

def getCountries(request):
    # get Countries from the database 
    # excluding null and blank values
    if request.method == "GET" and request.is_ajax():
        country = TopSongPoularity.objects.all().\
                values_list('country').distinct()
        country = [c[0] for c in list(country)]

        return JsonResponse({
            "country": country, 
        }, status = 200)
</pre>
<h2>创建 URL</h2>
<p>现在，让我们路由视图:</p>
<pre>#my_proj/urls.py
from django.urls import path
from my_app.views import ListTopSongs, index, getCountries

urlpatterns = [
    path('api/get/top_songs', ListTopSongs.as_view()),
    path('api/get/countries', getCountries, name = "get_countries"),
    path('', index)
]
</pre>
<h2>创建模板</h2>
<p>既然后端代码已经完成，让我们转到前端。</p>
<p>我使用了一个基本模板(<code>base.html</code>)，如下所示，它包括引导和 jQuery 库:</p>
<pre>&lt;!--templates/base.html--&gt;
&lt;!--doctype HTML--&gt;
&lt;html&gt;
&lt;head&gt;
    &lt;meta charset="utf-8" /&gt;
    &lt;meta http-equiv="X-UA-Compatible" content="IE=edge"&gt;
    &lt;meta property="og:locale" content="en_US" /&gt;
    &lt;meta charset="utf-8" /&gt;
    &lt;meta http-equiv="X-UA-Compatible" content="IE=edge"&gt;
    &lt;meta name="viewport" content="width=device-width, initial-scale=1"&gt;

    &lt;title&gt;Log rocket&lt;/title&gt;
    &lt;!-- css cdn includes --&gt;
    &lt;link rel="stylesheet" href = "https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"&gt;
    {% block style %}
    {% endblock style %}
&lt;/head&gt;

&lt;body&gt;
    {% block content %}
    {% endblock %}
    &lt;script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"&gt;&lt;/script&gt;
    &lt;script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"&gt;&lt;/script&gt;
    {% block javascript %}
    {% endblock javascript %}
&lt;/body&gt;

&lt;/html&gt;
</pre>
<p>现在让我们创建<code>index.html</code>来显示带有过滤器的表格。这个模板文件继承了<code>base.html</code>并创建了一个带有表头和空表体的表格。最后，它还包含“下一页”和“上一页”两个按钮。</p>
<p><code>index.html</code>的剩余部分，即 JavaScript 部分，解释如下:</p>
<pre>&lt;!--templates/index.html--&gt;
{% extends 'base.html' %}

{% block content %}
&lt;section&gt;
    &lt;div class="container-fluid"&gt;
        &lt;div class="row"&gt;
            &lt;div class="col-sm-2 col-2"&gt;
                &lt;div class="form-group"&gt;
                    &lt;label for="country"&gt;Country&lt;/label&gt;
                    &lt;select class="form-control" id="countries" url={% url 'get_countries' %}&gt;
                    &lt;/select&gt;
                &lt;/div&gt;
            &lt;/div&gt;
            &lt;div class="col-sm-2 col-2"&gt;
                &lt;div class="form-group"&gt;
                    &lt;label for="year"&gt;Year&lt;/label&gt;
                    &lt;select class="form-control" id="year"&gt;
                        &lt;option value="0" start=0 end=0&gt;All years&lt;/option&gt;
                        &lt;option value="1" start=2019 end=2020&gt;2019-2020&lt;/option&gt;
                        &lt;option value="2" start=2018 end=2019&gt;2018-2019&lt;/option&gt;
                        &lt;option value="3" start=2016 end=2018&gt;2016-2018&lt;/option&gt;
                        &lt;option value="4" start=2010 end=2016&gt;2010-2016&lt;/option&gt;
                        &lt;option value="5" start=1900 end=2010&gt;1900-2010&lt;/option&gt;
                    &lt;/select&gt;
                &lt;/div&gt;
            &lt;/div&gt;

            &lt;div class="col-sm-2 col-2"&gt;
                &lt;div class="form-group"&gt;
                    &lt;label for="sort"&gt;Sort By&lt;/label&gt;
                    &lt;select class="form-control" id="sort"&gt;
                        &lt;option value="0"&gt;No option selected&lt;/option&gt;
                        &lt;option value="duration"&gt;Duration&lt;/option&gt;
                        &lt;option value="pop"&gt;Pop&lt;/option&gt;
                        &lt;option value="year"&gt;Year&lt;/option&gt;
                    &lt;/select&gt;
                &lt;/div&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/div&gt;
&lt;/section&gt;

&lt;section&gt;
    &lt;div class="container"&gt;
        &lt;div class="row justify-content-center table-responsive"&gt;
            &lt;div id="result-count" class="text-right"&gt;
                &lt;span class='font-weight-bold'&gt;&lt;/span&gt; results found.
            &lt;/div&gt;
            &lt;div id="page-count" class="text-right"&gt;Page:
                &lt;span class='font-weight-bold'&gt;&lt;/span&gt;
            &lt;/div&gt;

            &lt;table class="table table-light table-bordered table-hover" id="hero_table" data-toggle="table"&gt;
                &lt;thead class="thead-dark"&gt;
                    &lt;tr&gt;
                        &lt;th data-field="title"&gt;Title&lt;/th&gt;
                        &lt;th data-field="country"&gt;Country&lt;/th&gt;
                        &lt;th data-field="top_genre"&gt;Top Genre&lt;/th&gt;
                        &lt;th data-field="artist"&gt;Artist&lt;/th&gt;
                        &lt;th data-field="duration"&gt;Duration&lt;/th&gt;
                        &lt;th data-field="pop"&gt;Pop&lt;/th&gt;
                        &lt;th data-field="year"&gt;Year&lt;/th&gt;
                    &lt;/tr&gt;
                &lt;/thead&gt;
                &lt;tbody id="table_body"&gt;
                &lt;/tbody&gt;
            &lt;/table&gt;
        &lt;/div&gt;
        &lt;div class="row justify-content-center"&gt;
            &lt;nav aria-label="navigation"&gt;
                &lt;ul class="pagination"&gt;
                    &lt;li class="page-item"&gt;
                        &lt;button class="btn btn-primary page-link" id = "previous"&gt;Previous&lt;/button&gt;
                    &lt;/li&gt;
                    &lt;li class="page-item pull-right"&gt;
                        &lt;button class="btn btn-primary page-link" id="next"&gt;Next&lt;/button&gt;
                    &lt;/li&gt;
                &lt;/ul&gt;
            &lt;/nav&gt;
        &lt;/div&gt;
    &lt;/div&gt;
&lt;/section&gt;
{% endblock content %}
</pre>
<h2>创建客户端脚本</h2>
<p>本指南的最后一部分是使用 AJAX 连接前端和后端。请参考下面代码片段中提到的注释:</p>
<pre>&lt;!---templates/index.html---&gt;
{% block javascript %}
&lt;script&gt;
    // maintaining the state of each variable.
    var current_page = 1; // maintains the current page
    var page_limit = 10; // the limit of results shown on page.
    var sort_by = ""; // maintains the select option for sort_by
    var country = ""; // maintains the select option for country
    var start_year = ""; // maintains the select option for start_yr
    var end_year = ""; // maintains the select option for end_yr

    function get_list_url(page) {
        // returns the consructed url with query params.
        return `api/get/top_songs?page=${page}&amp;limit=${page_limit}&amp;country=${country}&amp;sort_by=${sort_by}&amp;start=${start_year}&amp;end=${end_year}`;
    }

    function getCountries() {
        // call the ajax and populates the country select options
        $.ajax({
            method: 'GET',
            url: $("#countries").attr("url"),
            success: function (response) {
                countries_option = "&lt;option value='all' selected&gt;All Countries&lt;/option&gt;";
                $.each(response["country"], function (a, b) {
                    countries_option += "&lt;option&gt;" + b + "&lt;/option&gt;"
                });
                $("#countries").html(countries_option)
            },
            error: function (response) {
                console.log(response)
            }
        });
    }

    // On select change of the country select, call the getAPIData
    $("#countries").on("change", function (e) {
        current_page = 1;
        country = this.value
        getAPIData(get_list_url(current_page));
    });
    // On select change of the year select, call the getAPIData
    $("#year").on("change", function (e) {
        current_page = 1;
        start_year = $(this).find(':selected').attr("start");
        end_year = $(this).find(':selected').attr("end");
        getAPIData(get_list_url(current_page));
    })
    // On select change of the sort select, call the getAPIData with sortby.
    $("#sort").on("change", function (e) {
        current_page = 1;
        sort_by = this.value
        getAPIData(get_list_url(current_page));
    })

    // Helper method that popluates the html table with next and prev
    // url, and current page number.
    function putTableData(response) {
        // creating table row for each response and
        // pushing to the html cntent of table body of table_body table
        let row;
        $("#table_body").html("");
        if (response["data"].length &gt; 0) {
            $.each(response["data"], function (a, b) {
                row = "&lt;tr&gt; &lt;td&gt;" + b.title + "&lt;/td&gt;" +
                    "&lt;td&gt;" + b.country + "&lt;/td&gt;" +
                    "&lt;td&gt;" + b.top_genre + "&lt;/td&gt;" +
                    "&lt;td&gt;" + b.artist + "&lt;/td&gt;" +
                    "&lt;td&gt;" + b.duration + "&lt;/td&gt;" +
                    "&lt;td&gt;" + b.pop + "&lt;/td&gt;" +
                    "&lt;td&gt;" + b.year + "&lt;/td&gt;" +
                    $("#table_body").append(row);
            });
        }
        else{
            // if there is no results found!
           $("#table_body").html("No results found."); 
        }
        if (response.pagination.has_prev) {
            // sets the previous page url.
            $("#previous").attr("data-url", get_list_url(current_page - 1));
            $("#previous").attr("disabled", false);
        } else {
            // if there is no prev page available, disable the btn.
            $("#previous").attr("disabled", true);
        }
        if (response.pagination.has_next) {
            // sets the next page url.
            $("#next").attr("data-url", get_list_url(current_page + 1));
            $("#next").attr("disabled", false);
        } else {
            // if there is no next page available, disable the btn.
            $("#next").attr("disabled", true)
        }
    }

    // On click of next/prev button, call the getAPIData with the given url.
    $(".page-link").click(function (e) {
        e.preventDefault();
        let url = $(this).attr("data-url");
        getAPIData(url);
    })

    // Main method which calls AJAX to get the data from backend.
    function getAPIData(url) {
        $.ajax({
            method: 'GET',
            url: url,
            success: function (response) {
                current_page = parseInt(response.pagination.page)
                putTableData(response);
                // put the total result count.
                $("#result-count span").html(response.pagination.total)
                $("#page-count span").html(response.pagination.page)
            },
            error: function (response) {
                $("#hero_table").hide();
            }
        });
    }

    //on page load, call this two methods.
    getAPIData(get_list_url(current_page));
    getCountries()
&lt;/script&gt;
{% endblock javascript %}
</pre>
<h2>结论</h2>
<p>在本指南中，您已经学习了如何使用 AJAX 以及如何与后端异步通信。过滤表格数据是一个需要处理的常见场景，我希望本指南能让您更好地理解如何处理数据过滤。</p>
<p>如果您愿意，您也可以使用 REST 框架，如<a href="https://www.django-rest-framework.org/"> Django REST framework </a>来简化事情。</p>
<p>如果您在遵循指南的过程中遇到任何问题，您可以随时查看我的<a href="https://github.com/krazygaurav/qs-filter-django"> Github 库</a>来查看整个项目。</p><div class="code-block code-block-1">
<div class="blog-plug base-cta"><h2>使用<a class="signup" href="https://lp.logrocket.com/blg/signup" target="_blank" rel="noopener noreferrer"> LogRocket </a>消除传统错误报告的干扰</h2>
<a href="https://lp.logrocket.com/blg/signup" class="signup" target="_blank" rel="noopener noreferrer"><img class="alignnone size-full wp-image-46 jetpack-lazy-image" src="../Images/d6f5a5dd739296c1dd7aab3d5e77eeb9.png" alt="LogRocket Dashboard Free Trial Banner" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2017/03/1d0cd-1s_rmyo6nbrasp-xtvbaxfg.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2017/03/1d0cd-1s_rmyo6nbrasp-xtvbaxfg.png"/><noscript><img data-lazy-fallback="1" class="alignnone size-full wp-image-46" src="../Images/d6f5a5dd739296c1dd7aab3d5e77eeb9.png" alt="LogRocket Dashboard Free Trial Banner" data-original-src="https://blog.logrocket.com/wp-content/uploads/2017/03/1d0cd-1s_rmyo6nbrasp-xtvbaxfg.png"/></noscript></a>
<p><a href="https://lp.logrocket.com/blg/signup" target="_blank" rel="noopener noreferrer"> LogRocket </a>是一个数字体验分析解决方案，它可以保护您免受数百个假阳性错误警报的影响，只针对几个真正重要的项目。LogRocket 会告诉您应用程序中实际影响用户的最具影响力的 bug 和 UX 问题。</p>
<p>然后，使用具有深层技术遥测的会话重放来确切地查看用户看到了什么以及是什么导致了问题，就像你在他们身后看一样。</p>
<p>LogRocket 自动聚合客户端错误、JS 异常、前端性能指标和用户交互。然后 LogRocket 使用机器学习来告诉你哪些问题正在影响大多数用户，并提供你需要修复它的上下文。</p>
<p>关注重要的 bug—<a class="signup" href="https://lp.logrocket.com/blg/signup-issue-free" target="_blank" rel="noopener noreferrer">今天就试试 LogRocket】。</a></p></div></div>

<p class="clearfix"/>
<p class="clearfix"/>
</article>

</div>    
</body>
</html>