<html>
<head>
<title>Understanding smart pointers in Rust - LogRocket Blog</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>理解Rust - LogRocket博客中的智能指针</h1>
<blockquote>原文：<a href="https://blog.logrocket.com/smart-pointers-rust/#0001-01-01">https://blog.logrocket.com/smart-pointers-rust/#0001-01-01</a></blockquote><div><article class="article-post">
<p>当管理堆或栈上的数据时，开发人员可以使用传统的指针方法。然而，使用这些指针方法也有缺点，比如当动态分配的对象没有被及时垃圾收集时，会导致内存泄漏。好消息是，有更好的内存管理方法可以自动处理垃圾收集，并且没有运行时开销，它们被称为智能指针。</p>
<p><a href="https://www.rust-lang.org/" target="_blank" rel="noopener"> Rust </a>是一种开源、低级、面向对象、静态类型的编程语言，具有高效的内存管理，可确保高性能和安全性。它具有广泛的功能，许多组织使用这些功能来构建高度安全和强大的应用程序，包括web、移动、游戏和网络应用程序。</p>
<p>本文将让您了解什么是智能指针，它们的用例，以及它们在Rust中的实现。包含的代码示例将向您介绍Rust的各种类型的智能指针。</p>
<p>向前跳:</p>

<h2 id="smart-pointers">什么是智能指针？</h2>
<p>智能指针是<a href="https://en.wikipedia.org/wiki/Abstract_data_type" target="_blank" rel="noopener">抽象数据类型</a>，其行为类似于编程中的常规<a href="https://docs.microsoft.com/en-us/cpp/cpp/pointers-cpp?view=msvc-170" target="_blank" rel="noopener">指针</a>(存储值的内存地址的变量)，加上额外的功能，如析构函数和重载运算符。它们还包括自动内存管理来解决像内存泄漏这样的问题。</p>
<p>当开发人员将包含动态分配数据的内存与智能指针链接时，它们会被自动释放或清理。</p>
<p>一些智能指针用例包括:</p>
<ul>
<li>自动释放数据和析构对象</li>
<li>检查超出界限的数据或变量</li>
<li>减少与使用常规指针相关的错误</li>
<li>在释放数据后保持程序的效率</li>
<li>跟踪程序的数据/对象/变量的所有内存地址</li>
<li>在程序应用中管理网络连接</li>
</ul>
<h2 id="smart-pointers-rust">智能指针如何在Rust中工作</h2>
<p>Rust通过一个名为<a href="https://doc.rust-lang.org/book/ch04-01-what-is-ownership.html" target="_blank" rel="noopener">所有权</a>的系统(或一组规则)来实现内存管理，它包含在应用程序的程序中，并在程序成功编译之前由编译器检查，不会导致任何停机。</p>
<p>通过使用<a href="https://doc.rust-lang.org/std/keyword.struct.html" target="_blank" rel="noopener">结构</a>，Rust执行智能指针。在前面提到的智能指针的附加功能中，它们还具有拥有值本身的功能。</p>
<p>接下来，您将了解一些有助于定制Rust中智能指针操作的特征。</p>
<h2 id="deref-trait"><code>Deref</code>特质</h2>
<p><a href="https://doc.rust-lang.org/std/ops/trait.Deref.html" target="_blank" rel="noopener"> <code>Deref</code> </a>特征用于有效的解引用，使得能够容易地访问存储在智能指针后面的数据。您可以使用<code>Deref</code>特征将智能指针视为引用。</p>
<p>解引用一个操作符意味着使用一元操作符<code>*</code>作为从一元引用操作符<code>&amp;</code>标记为“referencing”的指针导出的内存地址的前缀表达式可以是可变的(<code>&amp;mut</code>)或不可变的(<code>*mut</code>)。对内存地址使用解引用操作符将从指针返回值的位置。</p>
<p>因此，<code>Deref</code>特征只是定制了解引用操作符的行为。</p>
<p>下面是对<code>Deref</code>特征的说明:</p>
<pre class="language-rust hljs">fn main() {
        let first_data = 20;
        let second_data = &amp;first_data;
        
        if first_data == *second_data {
                println!("The values are equal");
      } else {
             println!("The values are not equal");
     }
}
</pre>
<p>上面代码块中的函数实现了以下内容:</p>
<ul>
<li>将<code>20</code>的值存储在<code>first_data</code>变量中</li>
<li><code>second_data</code>变量使用引用操作符<code>&amp;</code>来存储<code>first_data</code>变量的内存地址</li>
<li>检查<code>first_data</code>的值是否等于<code>second_data</code>的值的条件。在<code>second_data</code>上使用解引用操作符<code>*</code>来获取存储在指针内存地址中的值</li>
</ul>
<p>下面的屏幕截图显示了代码的输出:</p>
<p><img data-attachment-id="128887" data-permalink="https://blog.logrocket.com/smart-pointers-rust/attachment/deref-trait-output-code/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/08/deref-trait-output-code.png" data-orig-size="730,194" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Code output of Deref trait" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/08/deref-trait-output-code-300x80.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/08/deref-trait-output-code.png" decoding="async" class="aligncenter size-full wp-image-128887 jetpack-lazy-image" src="../Images/acab0110175ad2d54825b87551263570.png" alt="Code Output Of Deref Trait" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2022/08/deref-trait-output-code.png 730w, https://blog.logrocket.com/wp-content/uploads/2022/08/deref-trait-output-code-300x80.png 300w" data-lazy-sizes="(max-width: 730px) 100vw, 730px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2022/08/deref-trait-output-code.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/08/deref-trait-output-code.png"/></p><noscript><img data-lazy-fallback="1" data-attachment-id="128887" data-permalink="https://blog.logrocket.com/smart-pointers-rust/attachment/deref-trait-output-code/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/08/deref-trait-output-code.png" data-orig-size="730,194" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Code output of Deref trait" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/08/deref-trait-output-code-300x80.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/08/deref-trait-output-code.png" decoding="async" loading="lazy" class="aligncenter size-full wp-image-128887" src="../Images/acab0110175ad2d54825b87551263570.png" alt="Code Output Of Deref Trait" srcset="https://blog.logrocket.com/wp-content/uploads/2022/08/deref-trait-output-code.png 730w, https://blog.logrocket.com/wp-content/uploads/2022/08/deref-trait-output-code-300x80.png 300w" sizes="(max-width: 730px) 100vw, 730px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/08/deref-trait-output-code.png"/></noscript>
<h2 id="drop-trait"><code>Drop</code>特质</h2>
<p><a href="https://doc.rust-lang.org/std/ops/trait.Drop.html" target="_blank" rel="noopener"> <code>Drop</code> </a>特征类似于<code>Deref</code>特征，但用于析构，Rust通过清理程序不再使用的资源来自动实现。因此，<code>Drop</code>特征被用在一个指针上，它存储未使用的值，然后释放该值所占用的内存空间。</p>
<p>要使用<code>Drop</code>特征，您需要用一个可变引用实现<code>drop()</code>方法，该方法对不再需要或超出范围的值执行销毁，定义如下:</p>
<pre class="language-rust hljs">fn drop(&amp;mut self) {};
</pre>
<p>为了更好地理解<code>Drop</code>特征是如何工作的，请看下面的例子:</p>
<pre class="language-rust hljs">struct Consensus  {
        small_town: i32
}

impl Drop for Consensus {
        fn drop(&amp;mut self) {
                println!("This instance of Consensus has being dropped: {}", self.small_town);
}
}

fn main() {
        let _first_instance = Consensus{small_town: 10};
        let _second_instance = Consensus{small_town: 8};

        println!("Created instances of Consensus");
}
The code above implements the following:</pre>
<ul>
<li>创建一个包含名为<code>small_town</code>的32位有符号整数类型值的结构</li>
<li>包含带有可变引用的<code>drop()</code>方法的<code>Drop</code>特征是通过struct上的<a href="https://doc.rust-lang.org/std/keyword.impl.html" target="_blank" rel="noopener"> <code>impl</code> </a>关键字实现的。当<code>main()</code>函数中的实例超出范围时(即当<code>main()</code>函数中的代码结束运行时)，将<code>println!</code>语句中的消息打印到控制台</li>
<li><code>main()</code>函数简单地创建了两个<code>Consensus</code>实例，并在创建后将<code>println!</code>中的消息打印到屏幕上</li>
</ul>
<p>下面的截图显示了代码的输出:<img data-attachment-id="128890" data-permalink="https://blog.logrocket.com/smart-pointers-rust/attachment/drop-trait-output-code/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/08/drop-trait-output-code.png" data-orig-size="730,274" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Output code of Drop trait" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/08/drop-trait-output-code-300x113.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/08/drop-trait-output-code.png" decoding="async" class="aligncenter size-full wp-image-128890 jetpack-lazy-image" src="../Images/fb93b64479410ee0faa8902627c5125f.png" alt="Output Code Of Drop Trait" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2022/08/drop-trait-output-code.png 730w, https://blog.logrocket.com/wp-content/uploads/2022/08/drop-trait-output-code-300x113.png 300w" data-lazy-sizes="(max-width: 730px) 100vw, 730px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2022/08/drop-trait-output-code.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/08/drop-trait-output-code.png"/></p><noscript><img data-lazy-fallback="1" data-attachment-id="128890" data-permalink="https://blog.logrocket.com/smart-pointers-rust/attachment/drop-trait-output-code/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/08/drop-trait-output-code.png" data-orig-size="730,274" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Output code of Drop trait" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/08/drop-trait-output-code-300x113.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/08/drop-trait-output-code.png" decoding="async" loading="lazy" class="aligncenter size-full wp-image-128890" src="../Images/fb93b64479410ee0faa8902627c5125f.png" alt="Output Code Of Drop Trait" srcset="https://blog.logrocket.com/wp-content/uploads/2022/08/drop-trait-output-code.png 730w, https://blog.logrocket.com/wp-content/uploads/2022/08/drop-trait-output-code-300x113.png 300w" sizes="(max-width: 730px) 100vw, 730px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/08/drop-trait-output-code.png"/></noscript>
<h2 id="smart-pointers-types">Rust中智能指针的类型及其用例</h2>
<p>Rust中存在几种类型的智能指针。在本节中，您将通过代码示例了解其中的一些类型及其用例。它们包括:</p>

<h2 id="reference-counted-smart-pointer"><code>Rc&lt;T&gt;</code>智能指针</h2>
<p><code><a href="https://doc.rust-lang.org/book/ch15-04-rc.html" target="_blank" rel="noopener">Rc&lt;T&gt;</a></code>代表引用计数智能指针类型。在Rust中，每个值每次都有一个所有者，一个值有多个所有者违反了<a href="https://doc.rust-lang.org/book/ch04-01-what-is-ownership.html#ownership-rules" target="_blank" rel="noopener">所有权规则</a>。但是，当您声明一个值并在代码中的多个地方使用它时，引用计数类型允许您为变量创建多个引用。</p>
<p>顾名思义，引用计数智能指针类型记录了代码中每个变量的引用次数。当引用的计数返回零时，它们就不再被使用，智能指针会清除它们。</p>
<p>在下面的示例中，您将创建三个列表，它们与一个列表共享所有权。第一个列表将有两个值，第二个和第三个列表将第一个列表作为它们的第二个值。这意味着后两个列表将与第一个列表共享所有权。首先，您将在<code>use</code>语句中包含<a href="https://doc.rust-lang.org/stable/std/rc/struct.Rc.html" target="_blank" rel="noopener"> <code>Rc&lt;T&gt;</code>前奏</a>，这将允许您访问代码中可用的所有RC方法。</p>
<p>然后你会:</p>
<ul>
<li>用关键字<code>enum</code>和<code>List{}</code>定义一个列表</li>
<li>用<code>Cons()</code>创建一对构造来保存引用计数值的列表</li>
<li>为定义的列表声明另一个<code>use</code>语句</li>
<li>创建一个main函数来实现以下内容:<ul>
<li>构建新的引用计数列表作为第一个列表</li>
<li>通过将第一个列表的引用作为参数传递来创建第二个列表。使用<a href="https://doc.rust-lang.org/std/clone/trait.Clone.html" target="_blank" rel="noopener"> <code>clone()</code> </a>函数，创建一个新的指针，指向第一个列表中值的分配</li>
<li>通过调用<code><a href="https://docs.rs/rc/0.1.1/rc/fn.strong_count.html" target="_blank" rel="noopener">Rc::strong_count()</a></code>函数，在每个列表后打印参考计数</li>
</ul>
</li>
</ul>
<p>在您喜欢的代码编辑器中键入以下代码:</p>
<pre class="language-rust hljs">use std::rc::Rc;
 
enum List {
   Cons(i32, Rc&lt;List&gt;), Nil,
}
 
use List::{Cons, Nil};
 
fn main() {
   let _first_list = Rc::new(Cons(10, Rc::new(Cons(20, Rc::new(Nil)))));
   println!("The count after creating _first_list is {}", Rc::strong_count(&amp;_first_list));
   let _second_list = Cons(8, Rc::clone(&amp;_first_list));
   println!("The count after creating _second_list is {}", Rc::strong_count(&amp;_first_list));
   { 
       let _third_list = Cons(9, Rc::clone(&amp;_first_list));
       println!("The count after creating _third_list is {}", Rc::strong_count(&amp;_first_list));
   }
 
   println!("The count after _third_list goes out of scope is {}", Rc::strong_count(&amp;_first_list));
}
</pre>
<p>运行代码后，结果将如下所示:</p>
<p><img data-attachment-id="128892" data-permalink="https://blog.logrocket.com/smart-pointers-rust/attachment/reference-counted-smart-pointer/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/08/reference-counted-smart-pointer.png" data-orig-size="730,275" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Reference counter smart pointer" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/08/reference-counted-smart-pointer-300x113.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/08/reference-counted-smart-pointer.png" decoding="async" class="aligncenter size-full wp-image-128892 jetpack-lazy-image" src="../Images/c8873bc090693d5f3417f9298aadfbf0.png" alt="Reference Counter Smart Pointer" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2022/08/reference-counted-smart-pointer.png 730w, https://blog.logrocket.com/wp-content/uploads/2022/08/reference-counted-smart-pointer-300x113.png 300w" data-lazy-sizes="(max-width: 730px) 100vw, 730px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2022/08/reference-counted-smart-pointer.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/08/reference-counted-smart-pointer.png"/></p><noscript><img data-lazy-fallback="1" data-attachment-id="128892" data-permalink="https://blog.logrocket.com/smart-pointers-rust/attachment/reference-counted-smart-pointer/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/08/reference-counted-smart-pointer.png" data-orig-size="730,275" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Reference counter smart pointer" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/08/reference-counted-smart-pointer-300x113.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/08/reference-counted-smart-pointer.png" decoding="async" loading="lazy" class="aligncenter size-full wp-image-128892" src="../Images/c8873bc090693d5f3417f9298aadfbf0.png" alt="Reference Counter Smart Pointer" srcset="https://blog.logrocket.com/wp-content/uploads/2022/08/reference-counted-smart-pointer.png 730w, https://blog.logrocket.com/wp-content/uploads/2022/08/reference-counted-smart-pointer-300x113.png 300w" sizes="(max-width: 730px) 100vw, 730px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/08/reference-counted-smart-pointer.png"/></noscript>
<h2 id="box-smart-pointer"><code>Box&lt;T&gt;</code>智能指针</h2>
<p>在Rust中，数据分配通常在堆栈中完成。然而，Rust中的一些方法和智能指针类型使您能够在堆中分配数据。其中一种类型是<a href="https://doc.rust-lang.org/book/ch15-01-box.html" target="_blank" rel="noopener"> <code>Box&lt;T&gt;</code>智能指针</a>；“&lt; T &gt;代表数据类型。要使用Box智能指针在堆中存储一个值，您可以将这段代码:<code>Box::new()</code>括起来。例如，假设您在堆中存储一个值:</p>
<pre class="language-rust hljs">fn main() {
        let stack_data = 20;
        let hp_data = Box::new(stack_data); // points to the data in the heap
        println!("hp_data = {}", hp_data);  // output will be 20.
}
</pre>
<p>从上面的代码块中，请注意:</p>
<ul>
<li>值<code>stack_data</code>存储在一个堆中</li>
<li>盒子智能指针<code>hp_data</code>存储在堆栈中</li>
</ul>
<p>此外，通过在<code>hp_data</code>前面使用星号(*)，可以很容易地取消对存储在堆中的数据的引用。代码的输出将是:</p>
<p><img data-attachment-id="128894" data-permalink="https://blog.logrocket.com/smart-pointers-rust/attachment/box-smart-pointer-code-output/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/08/box-smart-pointer-code-output.png" data-orig-size="730,226" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Output code of Box smart pointer" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/08/box-smart-pointer-code-output-300x93.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/08/box-smart-pointer-code-output.png" decoding="async" class="aligncenter size-full wp-image-128894 jetpack-lazy-image" src="../Images/73a2050b401a7d3e63877e09e350b6cb.png" alt="Output Code Of Box Smart Pointer" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2022/08/box-smart-pointer-code-output.png 730w, https://blog.logrocket.com/wp-content/uploads/2022/08/box-smart-pointer-code-output-300x93.png 300w" data-lazy-sizes="(max-width: 730px) 100vw, 730px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2022/08/box-smart-pointer-code-output.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/08/box-smart-pointer-code-output.png"/></p><noscript><img data-lazy-fallback="1" data-attachment-id="128894" data-permalink="https://blog.logrocket.com/smart-pointers-rust/attachment/box-smart-pointer-code-output/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/08/box-smart-pointer-code-output.png" data-orig-size="730,226" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Output code of Box smart pointer" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/08/box-smart-pointer-code-output-300x93.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/08/box-smart-pointer-code-output.png" decoding="async" loading="lazy" class="aligncenter size-full wp-image-128894" src="../Images/73a2050b401a7d3e63877e09e350b6cb.png" alt="Output Code Of Box Smart Pointer" srcset="https://blog.logrocket.com/wp-content/uploads/2022/08/box-smart-pointer-code-output.png 730w, https://blog.logrocket.com/wp-content/uploads/2022/08/box-smart-pointer-code-output-300x93.png 300w" sizes="(max-width: 730px) 100vw, 730px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/08/box-smart-pointer-code-output.png"/></noscript>
<h2 id="refcell-smart-pointer"><code>RefCell&lt;T&gt;</code>智能指针</h2>
<p><code>RefCell&lt;T&gt;</code>是一种智能指针类型，它在运行时而不是编译时执行借用规则。在编译时，Rust中的开发人员可能会遇到“借用检查器”的问题，由于不符合Rust的所有权规则，他们的代码仍然没有编译。</p>
<p>将带有值的变量绑定到另一个变量并使用第二个变量会在Rust中产生错误。Rust中的<a href="https://doc.rust-lang.org/book/ch04-01-what-is-ownership.html" target="_blank" rel="noopener">所有权规则</a>确保每个值都有一个所有者。在绑定的所有权被移动后，你就不能使用它了，因为Rust会为每个绑定创建一个引用，除非使用<a href="https://doc.rust-lang.org/std/marker/trait.Copy.html" target="_blank" rel="noopener"> <code>Copy</code>特征</a>。</p>
<p>Rust中的借用规则需要借用所有权作为引用，可以有一个或多个对资源的引用(<code>&amp;T</code>)或者一个可变引用(<code>&amp;mut T</code>)。</p>
<p>然而，Rust中一个叫做“内部可变性”的设计模式允许你用不可变的引用来改变这个数据。<code>RefCell&lt;T&gt;</code>使用这种“内部可变性”设计模式，在数据中使用<a href="https://doc.rust-lang.org/stable/nomicon/index.html" target="_blank" rel="noopener">不安全代码</a>，并在运行时实施借用规则。</p>
<p>使用<code>RefCell&lt;T&gt;</code>，可以在运行时检查可变和不可变借位。因此，如果您的代码中有几个不可变引用的数据，使用<code>RefCell&lt;T&gt;</code>，您仍然可以改变数据。</p>
<p>在前面的<code>Rc&lt;T&gt;</code>部分，您使用了一个实现多个共享所有权的例子。在下面的例子中，您将通过在定义<code>Cons</code>时将<code>Rc&lt;T&gt;</code>包裹在<code>RefCell&lt;T&gt;</code>周围来修改<code>Rc&lt;T&gt;</code>代码示例:</p>
<pre class="language-rust hljs">#[derive(Debug)]
enum List {
  Cons(Rc&lt;RefCell&lt;i32&gt;&gt;, Rc&lt;List&gt;), Nil,
}
use List::{Cons, Nil};
use std::cell::RefCell;
use std::rc::Rc;
fn main() {
   let data = Rc::new(RefCell::new(10));
 
   let _first_list = Rc::new(Cons(Rc::clone(&amp;data), Rc::new(Nil)));
 
   let _second_list = Cons(Rc::new(RefCell::new(9)), Rc::clone(&amp;_first_list));
 
   let _third_list = Cons(Rc::new(RefCell::new(10)), Rc::clone(&amp;_first_list));
 
   *data.borrow_mut() += 20;
 
   println!("first list after = {:?}", _first_list);
   println!("second list after = {:?}", _second_list);
   println!("third list after = {:?}", _third_list);
}
</pre>
<p>上面的代码实现了以下内容:</p>
<ul>
<li>用在<code>Cons</code>中定义的<code>Rc&lt;RefCell&lt;i32&gt;&gt;</code>创建<code>data</code></li>
<li>创建共享所有权为<code>data</code>的<code>_first_list</code></li>
<li>创建另外两个列表，<code>_second_list</code>和<code>_third_list</code>，它们与<code>_first_list</code>共享所有权</li>
<li>对数据调用<a href="https://doc.rust-lang.org/std/borrow/trait.BorrowMut.html" target="_blank" rel="noopener"> <code>borrow_mut()</code> </a>函数(该函数返回<code><a href="https://doc.rust-lang.org/std/cell/struct.RefMut.html" target="_blank" rel="noopener">RefMut&lt;T&gt;</a></code>智能指针),并使用解引用操作符<code>*</code>解引用<code>Rc&lt;T&gt;</code>,从RefCell获取内部值，并对该值进行变异</li>
</ul>
<p>请注意，如果您没有将<a href="https://doc.rust-lang.org/rust-by-example/hello/print/print_debug.html" target="_blank" rel="noopener"> <code>#[derive(Debug)]</code> </a>作为代码的第一行，您将会遇到以下错误:</p>
<p><img data-attachment-id="128896" data-permalink="https://blog.logrocket.com/smart-pointers-rust/attachment/debug-error/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/08/debug-error.png" data-orig-size="730,482" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Debug error" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/08/debug-error-300x198.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/08/debug-error.png" decoding="async" class="aligncenter size-full wp-image-128896 jetpack-lazy-image" src="../Images/72bd83c2232da52713e470154936782e.png" alt="Debug Error" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2022/08/debug-error.png 730w, https://blog.logrocket.com/wp-content/uploads/2022/08/debug-error-300x198.png 300w" data-lazy-sizes="(max-width: 730px) 100vw, 730px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2022/08/debug-error.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/08/debug-error.png"/></p><noscript><img data-lazy-fallback="1" data-attachment-id="128896" data-permalink="https://blog.logrocket.com/smart-pointers-rust/attachment/debug-error/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/08/debug-error.png" data-orig-size="730,482" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Debug error" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/08/debug-error-300x198.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/08/debug-error.png" decoding="async" loading="lazy" class="aligncenter size-full wp-image-128896" src="../Images/72bd83c2232da52713e470154936782e.png" alt="Debug Error" srcset="https://blog.logrocket.com/wp-content/uploads/2022/08/debug-error.png 730w, https://blog.logrocket.com/wp-content/uploads/2022/08/debug-error-300x198.png 300w" sizes="(max-width: 730px) 100vw, 730px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/08/debug-error.png"/></noscript>
<p>一旦代码运行，第一个列表、第二个列表和第三个列表的值将发生变化:</p>
<p><img data-attachment-id="128898" data-permalink="https://blog.logrocket.com/smart-pointers-rust/attachment/mutated-list/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/08/mutated-list.png" data-orig-size="730,188" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Mutated list" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/08/mutated-list-300x77.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/08/mutated-list.png" decoding="async" class="aligncenter size-full wp-image-128898 jetpack-lazy-image" src="../Images/9149d61e6ea0f8f5df30ffcc2fe10d51.png" alt="Mutated List" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2022/08/mutated-list.png 730w, https://blog.logrocket.com/wp-content/uploads/2022/08/mutated-list-300x77.png 300w" data-lazy-sizes="(max-width: 730px) 100vw, 730px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2022/08/mutated-list.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/08/mutated-list.png"/></p><noscript><img data-lazy-fallback="1" data-attachment-id="128898" data-permalink="https://blog.logrocket.com/smart-pointers-rust/attachment/mutated-list/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/08/mutated-list.png" data-orig-size="730,188" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Mutated list" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/08/mutated-list-300x77.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/08/mutated-list.png" decoding="async" loading="lazy" class="aligncenter size-full wp-image-128898" src="../Images/9149d61e6ea0f8f5df30ffcc2fe10d51.png" alt="Mutated List" srcset="https://blog.logrocket.com/wp-content/uploads/2022/08/mutated-list.png 730w, https://blog.logrocket.com/wp-content/uploads/2022/08/mutated-list-300x77.png 300w" sizes="(max-width: 730px) 100vw, 730px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/08/mutated-list.png"/></noscript>
<h2 id="conclusion">结论</h2>
<p>在本文的结尾，您已经了解了智能指针，包括它们的用例。我们介绍了智能指针如何在Rust中工作以及它们的特征(<code>Deref</code>特征和<code>Drop</code>特征)。您还了解了Rust中的一些智能指针类型和用例，包括<code>Rc&lt;T&gt;</code>、<code>Box&lt;T&gt;</code>和<code>RefCell&lt;T&gt;</code>。</p><div class="code-block code-block-29">
<div class="blog-plug inline-plug rust-plug"><h2><a href="https://lp.logrocket.com/blg/rust-signup" target="_blank">log rocket</a>:Rust应用的web前端的全面可见性</h2><p>调试Rust应用程序可能很困难，尤其是当用户遇到难以重现的问题时。如果您对监控和跟踪Rust应用程序的性能、自动显示错误、跟踪缓慢的网络请求和加载时间感兴趣，</p><a href="https://lp.logrocket.com/blg/rust-signup" target="_blank">try LogRocket</a><p>. </p><a class="signup" href="https://lp.logrocket.com/blg/rust-signup" target="_blank" rel="noopener noreferrer"><img class="alignnone size-full wp-image-46 jetpack-lazy-image" src="../Images/d6f5a5dd739296c1dd7aab3d5e77eeb9.png" alt="LogRocket Dashboard Free Trial Banner" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2017/03/1d0cd-1s_rmyo6nbrasp-xtvbaxfg.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2017/03/1d0cd-1s_rmyo6nbrasp-xtvbaxfg.png"/><noscript><img data-lazy-fallback="1" class="alignnone size-full wp-image-46" src="../Images/d6f5a5dd739296c1dd7aab3d5e77eeb9.png" alt="LogRocket Dashboard Free Trial Banner" data-original-src="https://blog.logrocket.com/wp-content/uploads/2017/03/1d0cd-1s_rmyo6nbrasp-xtvbaxfg.png"/></noscript></a><p>LogRocket 就像是网络和移动应用程序的DVR，记录你的Rust应用程序上发生的一切。您可以汇总并报告问题发生时应用程序的状态，而不是猜测问题发生的原因。LogRocket还可以监控应用的性能，报告客户端CPU负载、客户端内存使用等指标。</p><p>现代化调试Rust应用的方式— <a class="signup" href="https://lp.logrocket.com/blg/rust-signup" target="_blank" rel="noopener noreferrer">开始免费监控</a>。</p></div>


</div>

<p class="clearfix"/>
<p class="clearfix"/>
</article>

</div>    
</body>
</html>