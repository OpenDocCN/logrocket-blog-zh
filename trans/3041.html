<html>
<head>
<title>Using Edge Functions in Supabase: A complete guide - LogRocket Blog</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>在 Supabase 中使用 Edge 函数:完整指南</h1>
<blockquote>原文：<a href="https://blog.logrocket.com/using-edge-functions-supabase-complete-guide/#0001-01-01">https://blog.logrocket.com/using-edge-functions-supabase-complete-guide/#0001-01-01</a></blockquote><div><article class="article-post">
<p>无服务器计算是软件开发界的一个热门话题，这是有充分理由的！它承诺了一种更高效、更经济的方式来构建和运行可弹性伸缩的应用程序。</p>
<p>Supabase 是一个无服务器的云平台，允许开发者在没有服务器的情况下构建复杂的网络和移动应用。Supabase 最近推出了 Edge Functions ,作为那些寻找简单方法将无服务器功能添加到应用程序中的人的一个选项。Edge 功能是用 TypeScript 编写的，可以通过 Supabase CLI 分发和部署到 29 个地理区域，以覆盖全球用户。</p>
<p>在撰写本文时，Edge 功能仍处于 Supabase 的试验阶段，可能会有突破性的变化。尽管如此，这个特性作为一种在没有大量服务器资源的情况下构建更强大功能的手段，正迅速受到开发人员的欢迎。</p>
<p>但是，边缘函数是如何工作的呢？那么，如何编写无服务器代码呢？在本文中，我们将涵盖所有这一切，甚至更多！</p>
<p><em>向前跳转:</em></p>

<p>在进一步讨论之前，我们先来探讨一下 Edge 函数是如何工作的，以及 Supabase 是如何管理运行函数代码的平台的。</p>
<h2 id="understanding-the-supabase-edge-functions-platform">了解 Supabase Edge 功能平台</h2>
<p>Supabase Edge 功能在安全<a href="https://deno.land" target="_blank" rel="noopener"> Deno </a>环境中执行。使用<a href="https://deno.com/deploy" target="_blank" rel="noopener"> Deno Deploy 托管服务</a>，它们在几秒钟内就可以部署到世界各地，无需任何人工干预。这些都由 Supabase 处理，因此您可以完全专注于应用程序的逻辑，而不用担心底层技术。</p>
<p>当 Supabase Edge 功能接收到传入的请求时，该请求首先到达“中继”。该中继充当请求的 API 网关，并对报头中传递的 JWT 进行身份验证。它还提供了一些额外的功能，如日志和速率限制。</p>
<p>在收到对某个函数的请求后，中继检索关于该函数的信息以及一个惟一的标识符，称为部署 ID，并将其传递给 Deno Deploy 平台。该平台安全地执行功能代码，并将响应传回中继器，然后由最终用户接收。</p>
<p>现在，让我们创建并部署一个示例 Edge 函数。</p>
<h2 id="getting-started">入门指南</h2>
<p>要开始使用 Supabase Edge 功能，您需要首先安装 Supabase CLI 并设置一个项目。请遵循以下步骤:</p>
<ol>
<li>安装 Supabase CLI: <code>npm install -g supabase</code></li>
<li>使用命令登录到 CLI:<code>supabase login</code></li>
<li>使用命令:<code>supabase init</code>初始化 Supabase 项目</li>
<li>将您的本地项目链接到远程 Supabase 项目，就像这样:<code>supabase link</code> <code>--project-ref &lt;your-project-ref&gt;</code></li>
</ol>
<h2 id="creating-edge-functions">创建边缘函数</h2>
<p>要使用 Supabase 创建新的 Edge 函数，请在项目中运行以下命令:</p>
<pre class="language-bash hljs">supabase functions new hello
</pre>
<p>这里，我们正在创建一个名为<code>hello</code>的函数。</p>
<p>这将在您的 Supabase 文件夹中创建一个样板函数代码，位于:<code>/functions/hello/index.ts</code>。</p>
<pre class="language-typescript hljs">import { serve } from "https://deno.land/<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="4437302004746a7577756a74">[email protected]</a>/http/server.ts";

console.log("Hello from Functions!");

serve(async (req) =&gt; {
  const { name } = await req.json();
  const data = {
    message: `Hello ${name}!`,
  };

  return new Response(JSON.stringify(data), {
    headers: { "Content-Type": "application/json" },
  });
});
</pre>
<p>正如您在上面的代码块中所看到的，默认的功能代码非常简单，随时可以部署。<code>serve</code>函数创建一个 HTTP 服务器，并开始监听传入的请求。</p>
<h2 id="deploying-edge-functions">部署边缘功能</h2>
<p>要使用 Supabase 部署 Edge 功能，请运行以下命令:</p>
<pre class="language-bash hljs">supabase functions deploy hello
</pre>
<p><code>functions deploy</code>命令将打包您的函数代码，并将其部署到远程 Supabase 项目。在 Supabase 仪表板中的 Invoke 下，单击带有您的项目名称的 URL(见下文)以了解更多详细信息。</p>
<p><img data-attachment-id="115762" data-permalink="https://blog.logrocket.com/using-edge-functions-supabase-complete-guide/url-project-name/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/06/url-project-name.png" data-orig-size="730,260" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="URL project name" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/06/url-project-name-300x107.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/06/url-project-name.png" decoding="async" class="aligncenter size-full wp-image-115762 jetpack-lazy-image" src="../Images/a207d83917c954604eb2937870d6e71b.png" alt="URL Project Name" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2022/06/url-project-name.png 730w, https://blog.logrocket.com/wp-content/uploads/2022/06/url-project-name-300x107.png 300w" data-lazy-sizes="(max-width: 730px) 100vw, 730px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2022/06/url-project-name.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/06/url-project-name.png"/></p><noscript><img data-lazy-fallback="1" data-attachment-id="115762" data-permalink="https://blog.logrocket.com/using-edge-functions-supabase-complete-guide/url-project-name/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/06/url-project-name.png" data-orig-size="730,260" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="URL project name" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/06/url-project-name-300x107.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/06/url-project-name.png" decoding="async" loading="lazy" class="aligncenter size-full wp-image-115762" src="../Images/a207d83917c954604eb2937870d6e71b.png" alt="URL Project Name" srcset="https://blog.logrocket.com/wp-content/uploads/2022/06/url-project-name.png 730w, https://blog.logrocket.com/wp-content/uploads/2022/06/url-project-name-300x107.png 300w" sizes="(max-width: 730px) 100vw, 730px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/06/url-project-name.png"/></noscript>
<p>您可以从终端复制<code>curl</code>请求来测试您的功能。</p>
<p><img data-attachment-id="115765" data-permalink="https://blog.logrocket.com/using-edge-functions-supabase-complete-guide/supabase-curl/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/06/supabase-curl.png" data-orig-size="730,494" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Supabase curl" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/06/supabase-curl-300x203.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/06/supabase-curl.png" decoding="async" class="aligncenter size-full wp-image-115765 jetpack-lazy-image" src="../Images/c165404166101b6375a55720973f881c.png" alt="Supabase Curl" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2022/06/supabase-curl.png 730w, https://blog.logrocket.com/wp-content/uploads/2022/06/supabase-curl-300x203.png 300w" data-lazy-sizes="(max-width: 730px) 100vw, 730px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2022/06/supabase-curl.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/06/supabase-curl.png"/></p><noscript><img data-lazy-fallback="1" data-attachment-id="115765" data-permalink="https://blog.logrocket.com/using-edge-functions-supabase-complete-guide/supabase-curl/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/06/supabase-curl.png" data-orig-size="730,494" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Supabase curl" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/06/supabase-curl-300x203.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/06/supabase-curl.png" decoding="async" loading="lazy" class="aligncenter size-full wp-image-115765" src="../Images/c165404166101b6375a55720973f881c.png" alt="Supabase Curl" srcset="https://blog.logrocket.com/wp-content/uploads/2022/06/supabase-curl.png 730w, https://blog.logrocket.com/wp-content/uploads/2022/06/supabase-curl-300x203.png 300w" sizes="(max-width: 730px) 100vw, 730px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/06/supabase-curl.png"/></noscript>
<h2 id="running-edge-functions-locally">本地运行边缘功能</h2>
<p>要在本地开发和运行 Edge 功能，您需要使用 Docker 在本地机器上设置 Supabase。您可以查看本指南以获得在您的系统上设置 Supabase 的帮助。</p>
<p>通过运行以下命令启动 Supabase 项目:</p>
<pre class="language-bash hljs">supabase start
</pre>
<p>接下来，启动<code>hello</code>功能，就像这样:</p>
<pre class="language-bash hljs">supabase functions serve hello
</pre>
<p>该命令将为该功能启动一个本地服务器，并将侦听本地主机端口 54321。</p>
<p>要调用该函数，从您的终端发出一个<code>curl</code>请求:</p>
<pre class="language-bash hljs">curl --request POST 'http://localhost:54321/functions/v1/hello' \
  --header 'Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIiwicm9sZSI6ImFub24ifQ.625_WdcF3KHqz5amU0x2X5WWHP-OEs_4qj0ssLNHzTs' \
  --header 'Content-Type: application/json' \
  --data '{ "name":"Vijit" }'
</pre>
<p>认证的报头中需要有<code>Bearer</code>标记。它可以是你的项目的<code>ANON</code>键、<code>SERVICE_ROLE</code>键或者用户的 JWT 令牌。</p>
<h2 id="real-world-use-case">真实世界用例</h2>
<p>Supabase Edge 函数能帮你做的不仅仅是搭建一个简单的 CRUD app 它们还使您能够连接到任何数据库，实时处理数据，甚至构建复杂的工作流。</p>
<p>让我们来看一个实际的用例。我们将创建一个新的 Edge 函数<code>send-message</code>，它将<a href="https://www.twilio.com/blog/sending-sms-messages-deno-typescript-twilio-messaging" target="_blank" rel="noopener">使用<a href="https://www.twilio.com/sms" target="_blank" rel="noopener"> Twilio 消息 API </a>发送短信</a>。</p>
<p>要创建<code>send-message</code>函数，运行以下命令:</p>
<pre class="language-bash hljs">supabase functions new send-message
</pre>
<p>您将在<code>/functions/send-message/index.ts</code>找到默认功能代码</p>
<p>要使用 Twilio 消息传递 API，您需要 Twilio 帐户 SID 密钥、认证令牌和用于发送 SMS 的虚拟号码。</p>
<p>在项目中创建一个<code>.env</code>文件，并将以下值添加到该文件中:</p>
<pre class="language-xml hljs">// .env
TWILIO_ACCOUNT_SID=
TWILIO_AUTH_TOKEN=
TWILIO_PHONE_NUMBER=
</pre>
<p><em> <strong>注意，</strong>确保不要在您的代码中暴露这些凭证，或者将<code>.env</code> <em>文件添加到您的 GitHub 历史中。</em> </em></p><div class="code-block code-block-54">
<hr/>
<h3>更多来自 LogRocket 的精彩文章:</h3>

<hr/></div>
<p>接下来，定义一个接口来表示 SMS 有效负载:</p>
<pre class="language-typescript hljs">// ./send-message/types/sms.interface.ts 
export interface Sms {
  [index: string]: string;
  From: string;
  To: string;
  Body: string;
}
</pre>
<p>现在，创建一个助手类<code>TwilioSms</code>来使用 Twilio 消息传递 API 发送 SMS。类构造函数将接受帐户 SID 和 auth 令牌。</p>
<p>SID 和 auth 令牌一起编码，并将作为 API 请求中的授权头传递。</p>
<pre class="language-typescript hljs">// ./send-message/helpers/twilio-sms.ts 
import * as base64 from "https://denopkg.com/chiefbiiko/base64/mod.ts";
import { Sms } from "../types/sms.interface.ts";

export class TwilioSms {
  private authorizationHeader: string;

  constructor(private accountSID: string, authToken: string) {
    this.authorizationHeader =
      "Basic " +
      base64.fromUint8Array(
        new TextEncoder().encode(accountSID + ":" + authToken)
      );
  }

  async sendSms(payload: Sms): Promise&lt;any&gt; {
    const res = await fetch(
      "https://api.twilio.com/2010-04-01/Accounts/" +
        this.accountSID +
        "/Messages.json",
      {
        method: "POST",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8",
          Authorization: this.authorizationHeader,
        },
        body: new URLSearchParams(payload).toString(),
      }
    );

    const data = await res.json();

    return data;
  }
}
</pre>
<p>在主函数处理程序中，您需要使用<code>Deno.env.get()</code>方法加载环境变量，并从助手中导入<code>TwilioSms</code>类。</p>
<p>接下来，使用<code>sendSms()</code>方法将文本消息发送到请求正文中指定的给定手机号码。</p>
<pre class="language-typescript hljs">// ./send-message/index.ts 
import { serve } from "https://deno.land/<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="b4c7c0d0f4849a8587859a84">[email protected]</a>/http/server.ts";

import { TwilioSms } from "./helpers/twilio-sms.ts";

const accountSid = Deno.env.get("TWILIO_ACCOUNT_SID") || "";
const authToken = Deno.env.get("TWILIO_AUTH_TOKEN") || "";
const fromMobile = Deno.env.get("TWILIO_PHONE_NUMBER") || "";

serve(async (req) =&gt; {
  const { textMessage, toMobile } = await req.json();

  const twilioClient = new TwilioSms(accountSid, authToken);

  const message = await twilioClient.sendSms({
    Body: textMessage,
    From: fromMobile,
    To: toMobile,
  });

  console.log({ message });

  const data = {
    isSuccess: false,
  };

  if (message.status === "queued") {
    data.isSuccess = true;
  }

  return new Response(JSON.stringify(data), {
    headers: { "Content-Type": "application/json" },
  });
});
</pre>
<p>要在本地测试该函数，运行<code>supabase functions serve</code>命令并在<code>--env-file</code>参数中传递<code>.env</code>文件路径，以便该函数可以访问环境变量。</p>
<pre class="language-bash hljs">supabase functions serve send-message --env-file ./supabase/.env
</pre>
<p>现在，使用<code>curl</code>命令调用该函数。</p>
<pre class="language-bash hljs">curl -i --location --request POST 'http://localhost:54321/functions/v1/' \
  --header 'Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIiwicm9sZSI6ImFub24ifQ.625_WdcF3KHqz5amU0x2X5WWHP-OEs_4qj0ssLNHzTs' \
  --header 'Content-Type: application/json' \
  --data '{ "textMessage":"Hello Developer!", "toMobile": "+91XXXXXXXXXX" }'
</pre>
<p>要将本地环境变量推送到远程 Supabase 项目，运行<code>supabase secrets set</code>命令:</p>
<pre class="language-bash hljs">supabase secrets set --env-file ./supabase/.env
</pre>
<p>一旦您的功能经过本地测试并准备好部署，运行<code>supabase functions deploy</code>命令:</p>
<pre class="language-bash hljs">supabase functions deploy send-message
</pre>
<h2 id="limitations">限制</h2>
<p>Supabase Edge 功能提供了许多好处，但是对于您可以使用这项新功能做什么，仍然有一些限制。对于数据密集型且执行起来可能很耗时的服务，您应该选择使用 Supabase 的<a href="https://supabase.com/docs/guides/database/functions" target="_blank" rel="noopener">数据库功能</a>。</p>
<p>在撰写本文时，Edge 功能仍处于试验阶段，在未来的更新中会有突破性的变化。边缘功能目前无法建立到端口 25、465 或 587 的出站连接。另外，这个特性只支持 POST 请求，不支持 HTML 响应。最后，在本地开发中，一次只能提供一个边缘功能。</p>
<h2 id="conclusion">结论</h2>
<p>Supabase Edge 功能是扩展应用程序功能的绝佳解决方案。通过使用它们，您可以向您的应用程序添加通常需要单独的服务器端应用程序的功能。</p>
<p>在本文中，我们研究了 Supabase Edge 函数如何工作，并研究了如何创建、部署和运行 Edge 函数。我们还浏览了一个真实的使用案例，使用 Edge 功能在没有服务器的情况下发送 SMS。</p>
<p>如果你正在寻找一种方法来为你的应用添加定制功能，而不必自己管理基础设施，Supabase Edge 功能绝对值得一试。我希望这篇文章能帮助你开始使用 Supabase 和 Edge 函数来构建你自己的应用程序。</p><div class="code-block code-block-2">
<div class="blog-plug base-cta"><h2>使用<a class="signup" href="https://lp.logrocket.com/blg/signup" target="_blank" rel="noopener noreferrer"> LogRocket </a>消除传统错误报告的干扰</h2>
<a href="https://lp.logrocket.com/blg/signup" class="signup" target="_blank" rel="noopener noreferrer"><img class="alignnone size-full wp-image-46 jetpack-lazy-image" src="../Images/d6f5a5dd739296c1dd7aab3d5e77eeb9.png" alt="LogRocket Dashboard Free Trial Banner" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2017/03/1d0cd-1s_rmyo6nbrasp-xtvbaxfg.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2017/03/1d0cd-1s_rmyo6nbrasp-xtvbaxfg.png"/><noscript><img data-lazy-fallback="1" class="alignnone size-full wp-image-46" src="../Images/d6f5a5dd739296c1dd7aab3d5e77eeb9.png" alt="LogRocket Dashboard Free Trial Banner" data-original-src="https://blog.logrocket.com/wp-content/uploads/2017/03/1d0cd-1s_rmyo6nbrasp-xtvbaxfg.png"/></noscript></a>
<p><a href="https://lp.logrocket.com/blg/signup" target="_blank" rel="noopener noreferrer"> LogRocket </a>是一个数字体验分析解决方案，它可以保护您免受数百个假阳性错误警报的影响，只针对几个真正重要的项目。LogRocket 会告诉您应用程序中实际影响用户的最具影响力的 bug 和 UX 问题。</p>
<p>然后，使用具有深层技术遥测的会话重放来确切地查看用户看到了什么以及是什么导致了问题，就像你在他们身后看一样。</p>
<p>LogRocket 自动聚合客户端错误、JS 异常、前端性能指标和用户交互。然后 LogRocket 使用机器学习来告诉你哪些问题正在影响大多数用户，并提供你需要修复它的上下文。</p>
<p>关注重要的 bug—<a class="signup" href="https://lp.logrocket.com/blg/signup-issue-free" target="_blank" rel="noopener noreferrer">今天就试试 LogRocket】。</a></p></div></div>

<p class="clearfix"/>
<p class="clearfix"/>
</article>

</div>    
</body>
</html>