<html>
<head>
<title>How to develop charts in your Django admin with Chart.js </title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>如何使用Chart.js在Django admin中开发图表</h1>
<blockquote>原文：<a href="https://blog.logrocket.com/develop-charts-django-admin-chart-js/#0001-01-01">https://blog.logrocket.com/develop-charts-django-admin-chart-js/#0001-01-01</a></blockquote><div><article class="article-post">
<p>Django web框架提供了一个内置的管理界面来管理web应用程序的数据。然而，默认情况下，<a href="https://docs.djangoproject.com/en/4.1/ref/contrib/admin/"> Django管理接口</a>只提供该数据的列表视图，能够过滤、排序和搜索数据。但是，有时，以图形格式显示数据会很有帮助，例如，使用图表。</p>
<p>在本文中，我们将学习如何使用<a href="https://www.chartjs.org/"> Chart.js </a>向Django管理界面添加图表，这是一个用于创建图表的流行JavaScript库。首先，我们将通过创建一个呈现图表的新管理视图来更新Django管理。然后，我们将使用Chart.js通过应用程序提供的数据创建图表。</p>
<p><a href="https://blog.logrocket.com/comparing-most-popular-javascript-charting-libraries/#chart-js"> Chart.js提供了广泛的图表类型</a>，包括条形图、折线图和饼图，以及定制选项，帮助您创建符合您需求的完美图表。一旦创建了图表，它将被嵌入Django管理页面，并随着应用程序中的数据变化而自动更新，使您能够获得对数据的新见解，并做出更明智的决策。</p>
<p><em>向前跳转:</em></p>

<h2 id="develop-django-application">开发Django应用程序</h2>
<p>首先，我们将开发用于测试图表的模型。对于本教程，我们将构建一个博客应用程序，用户可以在其中创建文章并将它们保存在数据库中。因为我们将只与Django管理员一起工作，所以我们将只为这个应用程序创建模型。</p>
<p>首先，创建一个名为<code>django-chartjs</code>的项目文件夹。然后，通过运行以下命令创建虚拟环境:</p>
<pre class="language-python hljs">python3 -m venv venv
</pre>
<p>按如下方式激活虚拟环境:</p>
<pre class="language-python hljs">python3 -m venv/bin/activate
</pre>
<p>现在，安装Django:</p>
<pre class="language-python hljs">$(venv) pip install django
</pre>
<p>现在我们已经安装了Django，我们将通过运行以下命令创建一个新的Django项目:</p>
<pre class="language-python hljs">django-admin startproject project .
python3 manage.py startapp app 
</pre>
<p>将您刚刚创建的应用程序添加到您的<code>settings.py</code>文件中:</p>
<pre class="language-python hljs">INSTALLED_APPS = [
   ...
    "django.contrib.staticfiles",
    "app"
]
</pre>
<h3 id="developing-models">开发模型</h3>
<p>正如我前面提到的，我们的应用程序将允许作者创建新的文章。因此，我们将有两个模型，一个用于作者，一个用于文章细节。打开您的<code>app/models.py</code>文件并粘贴以下代码:</p>
<pre class="language-python hljs">from django.db import models
class Writer(models.Model):
    name = models.CharField(max_length=200)
    createdDate = models.DateTimeField(auto_now_add=True)
    def __str__(self):
        return u'%s' % (self.name)

class Article(models.Model):
    text_title = models.CharField(max_length=50, null=True, blank=True)
    text = models.TextField(max_length=200, null=True, blank=True)
    refWriter = models.ForeignKey(Writer, on_delete=models.CASCADE)
    createdDate = models.DateTimeField(auto_now_add=True)
    def __str__(self):
        return u'[%s] : %s' % (self.refWriter,self.text_title)
</pre>
<p>要设置数据库，请运行以下迁移命令:</p>
<pre class="language-python hljs">python manage.py makemigrations
python manage.py migrate
</pre>
<h2 id="customizing-admin-templates">自定义管理模板</h2>
<p>安装Django时，会在虚拟环境中创建一个文件夹，其中包含构建Django应用程序所需的所有文件，包括管理页面的HTML。要编辑Django管理页面，您需要将虚拟环境中的<code>Django</code>文件夹中的HTML文件放到您的Django项目中。</p>
<p>这样做将覆盖虚拟环境中<code>Django</code>文件夹中的admin HTML文件。因为我们将在列表页面上工作，我们将需要<code>venv/lib/python3.10/site-packages/django/contrib/admin/templates/admin/change_list.html</code>文件。</p>
<p>首先，在项目的根目录下，创建一个带有<code>templates/admin/</code>路径的目录。在刚刚创建的admin目录中，创建一个名为<code>change_list.html</code>的新文件。</p>
<p>现在，复制<code>venv/lib/python3.10/site-packages/django/contrib/admin/templates/admin/change_list.html to templates/admin/change_list.html</code>中的内容。</p>
<p>我们需要将<code>templates/</code>添加到Django项目的基本目录中，以便Django知道这个目录。一旦完成，管理页面将利用<code>templates/admin/change_list.html</code>。用下面的代码更新你的<code>settings.py</code>文件:</p>
<pre class="language-python hljs">import os
...
TEMPLATES = [
    {
        "BACKEND": "django.template.backends.django.DjangoTemplates",
        "DIRS": [
            BASE_DIR,
            os.path.join(BASE_DIR, 'templates') 
        ],
...
</pre>
<h3 id="update-admin-py-file">更新<code>Admin.py</code>文件</h3>
<p>我们希望更新writer list页面，以显示基于按日期创建的writer数量的图表。</p>
<p>在呈现<code>change_list.html</code>页面时，Django使用了一种叫做<code>changelist_view()</code>的方法。我们可以在<code>WriterAdmin</code>类中覆盖这个方法，稍后我们将创建这个类来实现业务逻辑。</p>
<p>现在，让我们更新<code>app/admin.py</code>文件来实现这个逻辑，并在JSON中获得相应的数据。将以下代码粘贴到您的<code>admin.py</code>文件中:</p>
<pre class="language-python hljs">from django.contrib import admin
from app.models import *
from django.db.models.functions import TruncDay
from django.db.models import Count
from django.core.serializers.json import DjangoJSONEncoder
import json

# Register your models here.
class WriterAdmin(admin.ModelAdmin):
    # change_list.html
    def changelist_view(self, request, extra_context=None):
        # Aggregate new authors per day
        chart_data = (
            Writer.objects.annotate(date=TruncDay("createdDate"))
            .values("date")
            .annotate(y=Count("id"))
            .order_by("-date")
        )
        # Serialize and attach the chart data to the template context
        as_json = json.dumps(list(chart_data), cls=DjangoJSONEncoder)
        print("Json %s"%as_json)
        extra_context = extra_context or {"chart_data": as_json}
        # Call the superclass changelist_view to render the page

        return super().changelist_view(request, extra_context=extra_context)

admin.site.register(Writer, WriterAdmin)
admin.site.register(Article)</pre>
<p>上面的代码是Django管理视图，它每天聚集新的作者，并将数据作为JSON对象附加到模板上下文。<code>WriterAdmin</code>类覆盖了<code>changelist_view</code>方法来将图表数据添加到上下文中，并且调用了<code>super().changelist_view</code>方法来呈现页面。<code>Writer</code>和<code>Article</code>型号也在管理站点注册。</p>
<h2 id="configure-chart-js-django">在Django上配置Chart.js</h2>
<p>为了配置Chart.js以显示所需的图表，我们首先引入Chart.js的JavaScript和CSS文件。将以下代码粘贴到您在<code>templates/admin/change_list.html</code>中看到的第一个<code>{{ block.super }}</code>标签下面:</p>
<pre class="language-python hljs">&lt;link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.min.css"/&gt;
&lt;script src= "https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.bundle.min.js"&gt; &lt;/script&gt;
</pre>
<h2 id="display-chart-chart-js">用Chart.js显示图表</h2>
<p>现在，我们将使用从<code>admin.py</code>文件中检索的数据来实现显示我们想要的图表的逻辑。我们将在文档中添加一个事件监听器，等待触发<code>DOMContentLoaded</code>事件。</p>
<p>一旦事件触发，它将检索HTML canvas元素的2D上下文，该元素带有从Django模板传入的ID和变量。然后，它将<code>chartData</code>中的日期解析成JavaScript <code>Date</code>对象。最后，它使用2D上下文、<code>chartData</code>和一些配置选项创建一个新的Chart.js图表，比如图表类型、背景颜色、刻度和刻度选项。</p>
<p>图表将呈现在ID为<code>myChart</code>的canvas元素上，我们将在后面实现。要实现这一点，将以下代码粘贴到最后一个<code>{% endblock %}</code>模板标签之上:</p>
<pre class="language-python hljs"> &lt;script&gt;
    document.addEventListener('DOMContentLoaded', () =&gt; {
        const ctx = document.getElementById('myChart').getContext('2d');
        const chartData = {{ chart_data | safe }};

        // Parse the dates to JS
        chartData.forEach((d) =&gt; {d.x = new Date(d.date);});

        // Add your javascript chart presentation below this comment
        var myChart = new Chart(ctx, {
          type: 'bar',
          data: {
              datasets: [{
                  label: 'number of writers',
                  data: chartData,
                  backgroundColor: 'rgba(61,61,131,0.5)',
              }]
          },
          options: {
              responsive: true,
              scales: {
                  xAxes: [{
                      type: 'time',
                      time: {
                          unit: 'day',
                          round: 'day',
                          displayFormats: {
                              day: 'MMM D',
                          },
                      },
                  }, ],
                  yAxes: [{
                      ticks: {
                          beginAtZero: true,
                      },
                  }, ],
              }
          }
      });

    });
    &lt;/script&gt;
</pre>
<p>将以下代码粘贴到您希望图表显示的位置。对于本教程，我们将把下面的代码粘贴到<code>templates/admin/change_list.html</code>中的<br/> <code>&lt;div id="content-main"&gt;</code>标签之上，从而把它放在作者列表之上:</p>
<pre class="language-python hljs">&lt;canvas id="myChart" width="400" height="50"&gt;&lt;/canvas&gt;
</pre>
<p>现在所有的配置都已完成，您需要一个超级用户来访问项目的管理页面。您可以使用以下命令创建超级用户:</p>
<pre class="language-python hljs">python manage.py createsuperuser
</pre>
<p>通过运行以下命令启动Django应用程序:</p>
<pre class="language-python hljs">python manage.py runserver
</pre>
<p>您可以使用您的超级用户详细信息访问<code><a href="http://127.0.0.1:8000/admin" rel="nofollow">http://127.0.0.1:8000/admin</a></code>上的管理员。用不同的日期创建新的作者，您会看到一个图表，显示某一天创建的用户数量:</p>
<p><img data-attachment-id="160503" data-permalink="https://blog.logrocket.com/develop-charts-django-admin-chart-js/attachment/access-django-admin-chart-js/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2023/02/access-django-admin-chart-js.png" data-orig-size="730,229" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="access-django-admin-chart-js" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2023/02/access-django-admin-chart-js-300x94.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2023/02/access-django-admin-chart-js.png" decoding="async" class="aligncenter wp-image-160503 size-full jetpack-lazy-image" src="../Images/0fac7b4ec1d885dfee08dcc5e9fb78c9.png" alt="Access Django Admin ChartJS" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2023/02/access-django-admin-chart-js.png 730w, https://blog.logrocket.com/wp-content/uploads/2023/02/access-django-admin-chart-js-300x94.png 300w" data-lazy-sizes="(max-width: 730px) 100vw, 730px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2023/02/access-django-admin-chart-js.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2023/02/access-django-admin-chart-js.png"/></p><noscript><img data-lazy-fallback="1" data-attachment-id="160503" data-permalink="https://blog.logrocket.com/develop-charts-django-admin-chart-js/attachment/access-django-admin-chart-js/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2023/02/access-django-admin-chart-js.png" data-orig-size="730,229" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="access-django-admin-chart-js" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2023/02/access-django-admin-chart-js-300x94.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2023/02/access-django-admin-chart-js.png" decoding="async" loading="lazy" class="aligncenter wp-image-160503 size-full" src="../Images/0fac7b4ec1d885dfee08dcc5e9fb78c9.png" alt="Access Django Admin ChartJS" srcset="https://blog.logrocket.com/wp-content/uploads/2023/02/access-django-admin-chart-js.png 730w, https://blog.logrocket.com/wp-content/uploads/2023/02/access-django-admin-chart-js-300x94.png 300w" sizes="(max-width: 730px) 100vw, 730px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2023/02/access-django-admin-chart-js.png"/></noscript>
<h2 id="conclusion">结论</h2>
<p>在本文中，我们学习了如何使用<a href="https://blog.logrocket.com/using-chart-js-react/"> Chart.js向Django管理界面添加图表，这是一个作为JavaScript包</a>提供的图表库。通过创建一个新的管理视图，您可以使用Chart.js创建各种图表类型，并根据您的需要定制它们。</p>
<p>该图表将被嵌入Django管理页面，并将根据不断变化的数据自动更新，为明智的决策提供新的见解。</p><div class="code-block code-block-4">
<div class="blog-plug base-cta"><h2>使用<a class="signup" href="https://lp.logrocket.com/blg/signup" target="_blank" rel="noopener noreferrer"> LogRocket </a>消除传统错误报告的干扰</h2>
<a href="https://lp.logrocket.com/blg/signup" class="signup" target="_blank" rel="noopener noreferrer"><img class="alignnone size-full wp-image-46 jetpack-lazy-image" src="../Images/d6f5a5dd739296c1dd7aab3d5e77eeb9.png" alt="LogRocket Dashboard Free Trial Banner" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2017/03/1d0cd-1s_rmyo6nbrasp-xtvbaxfg.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2017/03/1d0cd-1s_rmyo6nbrasp-xtvbaxfg.png"/><noscript><img data-lazy-fallback="1" class="alignnone size-full wp-image-46" src="../Images/d6f5a5dd739296c1dd7aab3d5e77eeb9.png" alt="LogRocket Dashboard Free Trial Banner" data-original-src="https://blog.logrocket.com/wp-content/uploads/2017/03/1d0cd-1s_rmyo6nbrasp-xtvbaxfg.png"/></noscript></a>
<p><a href="https://lp.logrocket.com/blg/signup" target="_blank" rel="noopener noreferrer"> LogRocket </a>是一个数字体验分析解决方案，它可以保护您免受数百个假阳性错误警报的影响，只针对几个真正重要的项目。LogRocket会告诉您应用程序中实际影响用户的最具影响力的bug和UX问题。</p>
<p>然后，使用具有深层技术遥测的会话重放来确切地查看用户看到了什么以及是什么导致了问题，就像你在他们身后看一样。</p>
<p>LogRocket自动聚合客户端错误、JS异常、前端性能指标和用户交互。然后LogRocket使用机器学习来告诉你哪些问题正在影响大多数用户，并提供你需要修复它的上下文。</p>
<p>关注重要的bug—<a class="signup" href="https://lp.logrocket.com/blg/signup-issue-free" target="_blank" rel="noopener noreferrer">今天就试试LogRocket】。</a></p></div></div>

<p class="clearfix"/>
<p class="clearfix"/>
</article>

</div>    
</body>
</html>