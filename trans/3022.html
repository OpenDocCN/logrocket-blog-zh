<html>
<head>
<title>Integrating WalletConnect into Vue.js DApps - LogRocket Blog</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>将 WalletConnect 集成到 Vue.js DApps - LogRocket 博客中</h1>
<blockquote>原文：<a href="https://blog.logrocket.com/integrating-walletconnect-vue-js-dapps/#0001-01-01">https://blog.logrocket.com/integrating-walletconnect-vue-js-dapps/#0001-01-01</a></blockquote><div><article class="article-post">
<p>分散式应用程序(DApps)的主要功能之一是连接钱包的能力，这反过来允许用户与 DApp 上的交易进行交互。它抽象了交换网络、提供签名者等功能，以及为用户提供某种形式的身份验证的其他特性。连接钱包也可作为网关，允许用户使用其钱包地址作为授权身份，通过 DApp 在区块链上执行和读取操作。</p>
<p><a href="https://walletconnect.com/" target="_blank" rel="noopener"> WalletConnect </a>是一个免费的开源协议，可以将我们的 DApps 连接到多个钱包，包括<a href="https://blog.logrocket.com/understanding-resolving-metamask-error-codes/" target="_blank" rel="noopener"> MetaMask </a>，Trust Wallet，Rainbow 等等。该协议通过在 DApp 和钱包之间建立连接来抽象这个过程，在整个会话期间保持它们的同步。</p>
<p>在本文中，我们将使用 WalletConnect 将我们的钱包应用程序链接到我们的 DApp，在前端使用 Vue.js。需要注意的一点是，WalletConnect 可以在任何兼容 wallet-connect 的 DApp、链和钱包(保管和非保管)上使用。</p>
<p>你可以在这里找到本教程的<a href="https://github.com/Atanda1/vue-wallet-connect" target="_blank" rel="noopener">源代码，以及我们将在这里</a>构建的应用程序的<a href="https://60xdzn.csb.app/" target="_blank" rel="noopener">演示。</a></p>
<p><img data-attachment-id="114954" data-permalink="https://blog.logrocket.com/integrating-walletconnect-vue-js-dapps/project-demo/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/06/Project-demo-.gif" data-orig-size="600,1333" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Project demo" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/06/Project-demo--135x300.gif" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/06/Project-demo--461x1024.gif" decoding="async" class="size-full wp-image-114954 aligncenter jetpack-lazy-image" src="../Images/67dc9c07ee5795a7d4d439dd2cc14e8e.png" alt="Project demo " data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2022/06/Project-demo-.gif?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/06/Project-demo-.gif"/></p><noscript><img data-lazy-fallback="1" data-attachment-id="114954" data-permalink="https://blog.logrocket.com/integrating-walletconnect-vue-js-dapps/project-demo/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/06/Project-demo-.gif" data-orig-size="600,1333" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Project demo" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/06/Project-demo--135x300.gif" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/06/Project-demo--461x1024.gif" decoding="async" loading="lazy" class="size-full wp-image-114954 aligncenter" src="../Images/67dc9c07ee5795a7d4d439dd2cc14e8e.png" alt="Project demo " data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/06/Project-demo-.gif"/></noscript>
<h3>内容</h3>

<h2 id="getting-started-vue-app">Vue.js 应用程序入门</h2>
<p>首先，让我们使用 Vue CLI 来启动项目。如果您的系统上已经安装了 Vue CLI，您可以直接创建 Vue 项目。</p>
<p>您可以使用以下命令进行全局安装:</p>
<pre class="language-shell hljs">npm install -g @vue/cli
</pre>
<p>我们现在可以使用 Vue CLI 来创建我们的项目。使用以下命令创建一个新项目:</p>
<pre class="language-shell hljs">vue create vue-wallet-connect
</pre>
<p>您需要选择一个预设。选择<code>Manually select features</code>，然后选择如下所示的选项:</p>
<p><img data-attachment-id="114957" data-permalink="https://blog.logrocket.com/integrating-walletconnect-vue-js-dapps/vue-setup-config/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/06/Vue-setup-config.png" data-orig-size="730,278" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Vue setup config" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/06/Vue-setup-config-300x114.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/06/Vue-setup-config.png" decoding="async" class="size-full wp-image-114957 aligncenter jetpack-lazy-image" src="../Images/5c093a3e2b46f19d1e9852f49838d5ce.png" alt="Vue setup config" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2022/06/Vue-setup-config.png 730w, https://blog.logrocket.com/wp-content/uploads/2022/06/Vue-setup-config-300x114.png 300w" data-lazy-sizes="(max-width: 730px) 100vw, 730px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2022/06/Vue-setup-config.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/06/Vue-setup-config.png"/></p><noscript><img data-lazy-fallback="1" data-attachment-id="114957" data-permalink="https://blog.logrocket.com/integrating-walletconnect-vue-js-dapps/vue-setup-config/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/06/Vue-setup-config.png" data-orig-size="730,278" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Vue setup config" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/06/Vue-setup-config-300x114.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/06/Vue-setup-config.png" decoding="async" loading="lazy" class="size-full wp-image-114957 aligncenter" src="../Images/5c093a3e2b46f19d1e9852f49838d5ce.png" alt="Vue setup config" srcset="https://blog.logrocket.com/wp-content/uploads/2022/06/Vue-setup-config.png 730w, https://blog.logrocket.com/wp-content/uploads/2022/06/Vue-setup-config-300x114.png 300w" sizes="(max-width: 730px) 100vw, 730px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/06/Vue-setup-config.png"/></noscript>
<p>创建项目后，导航到新项目文件夹:</p>
<pre class="language-shell hljs">cd vue-wallet-connect
</pre>
<p>我们将在 Vue 应用中使用<a href="https://blog.logrocket.com/building-dapp-ethers-js/" target="_blank" rel="noopener"> Ethers.js </a>来直接与区块链互动，同时连接我们的钱包:</p>
<pre class="language-shell hljs">npm i ethers
</pre>
<p>这里，我们将 WalletConnect 库安装到您的项目中:</p>
<pre class="language-shell hljs">npm install --save web3 @walletconnect/web3-provider
</pre>
<p>接下来，要在 Vue 3 中直接使用 WalletConnect 库，我们需要安装<code><a href="https://www.npmjs.com/package/node-polyfill-webpack-plugin" target="_blank" rel="noopener">node-polyfill-webpack-plugin</a></code>:</p>
<pre class="language-shell hljs">npm i node-polyfill-webpack-plugin
</pre>
<p>我们正在安装它，因为我们的项目使用 webpack v5，其中 polyfill 节点核心模块已被删除。因此，我们安装它来访问项目中的这些模块。</p>
<p>现在，打开<code>vue.config.js</code>文件，用这段代码替换它:</p>
<pre class="language-javascript hljs">const { defineConfig } = require("@vue/cli-service");
const NodePolyfillPlugin = require("node-polyfill-webpack-plugin");
module.exports = defineConfig({
  transpileDependencies: true,
  configureWebpack: {
    plugins: [new NodePolyfillPlugin()],
    optimization: {
      splitChunks: {
        chunks: "all",
      },
    },
  },
});
</pre>
<p>完成后，您现在可以启动服务器:</p>
<pre class="language-shell hljs">npm run serve
</pre>
<h2 id="building-ui">构建用户界面</h2>
<p>让我们进入 components 文件夹，创建一个名为<code>StatusContainer.vue</code>的新文件。这个组件包含我们的主页。</p>
<p>It it，我们有我们的欢迎信息，帮助我们连接的<strong>连接钱包</strong>按钮，以及我们的<strong>断开连接</strong>按钮来断开我们与钱包的连接。最后，当我们成功连接到钱包时，会显示<strong>已连接</strong>按钮:</p>
<pre class="language-javascript hljs">&lt;template&gt;
  &lt;div class="hello"&gt;
    &lt;h1&gt;Welcome to Your Vue.js Dapp&lt;/h1&gt;
    &lt;div &gt;
       &lt;button class="button"&gt;Connected&lt;/button&gt;
       &lt;button class="disconnect__button"&gt;Disconnect&lt;/button&gt;
    &lt;/div&gt;

    &lt;button class="button"&gt; Connect Wallet&lt;/button&gt;
  &lt;/div&gt;
&lt;/template&gt;
&lt;script&gt;
export default {
  name: 'StatusContainer'
}
&lt;/script&gt;
</pre>
<p>完成后，打开<code>App.vue</code>文件并导入<code>StatusContainer</code>组件，如下所示:</p>
<pre class="language-javascript hljs">&lt;template&gt;
  &lt;status-container/&gt;
&lt;/template&gt;
&lt;script&gt;

import StatusContainer from './components/StatusContainer.vue'
export default {
  name: 'App',
  components: {
    StatusContainer
  }
}
&lt;/script&gt;
&lt;style&gt;
@import url('https://fonts.googleapis.com/css2?family=Sora:<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="4334242b3703727373">[email protected]</a>&amp;display=swap');
#app {
  font-family: 'Sora', sans-serif;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  text-align: center;
  color: #2c3e50;
  margin-top: 60px;
}
.button {
      background-color: #1c82ff;
    border: none;
    color: #ffffff;
    font-family: "Sora";
    border-radius: 3rem;
    padding: 2rem 3rem;
    font-weight: 600;
    font-size: 2rem;
    margin: 1rem 1rem 1rem auto;
    width: 40%;
}
.disconnect__button {
     background-color: red;
    border: none;
    color: #ffffff;
    font-family: "Sora";
    border-radius: 3rem;
    padding: 1rem 1.3rem;
    font-weight: 600;
    font-size: 1rem;
    margin: 8rem 1rem 1rem auto;
    width: 20%;
}
&lt;/style&gt;
</pre>
<p>在我们的样式标签中，我们现在为之前创建的按钮添加样式:<code>.button</code>和<code>.disconnect__button</code>。此外，我们从谷歌字体中导入了黑脸田鸡自定义字体，并将其用作我们的<code>font-family</code>。</p>
<h2 id="instantiating-walletconnect">实例化 WalletConnect</h2>
<p>我们将需要一个 RPC 提供者来实例化我们的 WalletConnect 库。对于这个例子，我们将使用<a href="https://blog.logrocket.com/alchemy-vs-infura-which-node-provider-best/" target="_blank" rel="noopener"> Infura </a>。打开 Infura，创建一个新项目，并抓取<strong>项目 ID </strong>。</p>
<p><img data-attachment-id="114960" data-permalink="https://blog.logrocket.com/integrating-walletconnect-vue-js-dapps/infura-project/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/06/Infura-project-.png" data-orig-size="730,546" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Infura project" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/06/Infura-project--300x224.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/06/Infura-project-.png" decoding="async" class="size-full wp-image-114960 aligncenter jetpack-lazy-image" src="../Images/f5d9a5a59823f30de0de303f9aba3a65.png" alt="Infura project " data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2022/06/Infura-project-.png 730w, https://blog.logrocket.com/wp-content/uploads/2022/06/Infura-project--300x224.png 300w" data-lazy-sizes="(max-width: 730px) 100vw, 730px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2022/06/Infura-project-.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/06/Infura-project-.png"/></p><noscript><img data-lazy-fallback="1" data-attachment-id="114960" data-permalink="https://blog.logrocket.com/integrating-walletconnect-vue-js-dapps/infura-project/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/06/Infura-project-.png" data-orig-size="730,546" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Infura project" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/06/Infura-project--300x224.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/06/Infura-project-.png" decoding="async" loading="lazy" class="size-full wp-image-114960 aligncenter" src="../Images/f5d9a5a59823f30de0de303f9aba3a65.png" alt="Infura project " srcset="https://blog.logrocket.com/wp-content/uploads/2022/06/Infura-project-.png 730w, https://blog.logrocket.com/wp-content/uploads/2022/06/Infura-project--300x224.png 300w" sizes="(max-width: 730px) 100vw, 730px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/06/Infura-project-.png"/></noscript>
<p>现在，在 src 文件夹下创建一个新的<code>walletConnect</code>文件夹:<code>src/walletConnect</code>。在这个文件夹中，让我们创建一个<code>provider.js</code>文件。在这里，我们导入 WalletConnect 库，使用我们的 Infura ID 实例化它，并导出它用于其他文件。</p>
<p><code>src/walletConnect/provider.js</code>会是这样的:</p>
<pre class="language-javascript hljs">import WalletConnectProvider from "@walletconnect/web3-provider";
export const provider = new WalletConnectProvider({
  infuraId: process.env.VUE_APP_INFURA_ID,
});
</pre>
<p>Infura ID 应该用作环境变量。因此，将以下内容添加到您的<code>.env</code>文件中:</p>
<pre class="language-shell hljs">VUE_APP_INFURA_ID={{INFURA__ID}}
</pre>
<h2 id="adding-functionality-using-composables">使用组件添加功能</h2>
<p>创建接口并成功实例化库之后，下一步是实现我们的功能。为此，我们将使用 Vue composables，因为它允许我们在应用程序中的任何组件中使用我们的状态和操作，类似于我们对<a href="https://blog.logrocket.com/complex-vue-3-state-management-pinia/" target="_blank" rel="noopener"> Pinia </a>和 Vuex 的使用。</p>
<h3>创建可组合的</h3>
<p>在<code>src</code>文件夹内，添加<code>src/composables/connect</code>。在<code>connect</code>文件夹中，让我们创建一个<code>index.js</code>文件。</p>
<p>这里，我们导入了<code>reactive</code>和<code>watch</code>，我们将在这个文件中使用它们。让我们创建名为<code>defaultState</code>的状态对象:</p>
<pre class="language-javascript hljs">import { reactive, watch } from "vue";

const defaultState = {
  address: "",
  chainId: "",
  status: false,
};

const state = defaultState
</pre>
<p>为了保持我们的状态一致，我们将状态与本地存储中的项目同步。让我们将此项命名为<code>"userState"</code>，并将其赋给一个名为<code>STATE_NAME</code>的变量。这样做是为了避免在多个地方重复<code>"userState"</code>时出错:</p>
<pre class="language-javascript hljs">const STATE_NAME = "userState";
</pre>
<p>现在，一旦我们的状态发生任何变化，我们就使用<code>watch</code>来更新我们的本地存储:</p>
<pre class="language-javascript hljs">watch(
  () =&gt; state,
  () =&gt; {
    localStorage.setItem(STATE_NAME, JSON.stringify(state));
  },
  { deep: true }
);
</pre>
<p>接下来，我们创建一个<code>getDefaultState</code>函数，它检查本地存储中的<code>STATE_NAME</code>项是否存在，并将本地存储项分配给状态。如果我们的本地存储项不存在，它将把<code>defaultState</code>分配给<code>state</code>。</p>
<p>现在，我们可以删除<code>const state = defaultState</code>并使用<code>reactive</code>来分配<code>const state = reactive(getDefaultState());</code>:</p>
<pre class="language-javascript hljs">const getDefaultState = () =&gt; {
  if (localStorage.getItem(STATE_NAME) !== null) {
    return JSON.parse(localStorage.getItem(STATE_NAME));
  }
  return defaultState;
};
const state = reactive(getDefaultState());
</pre>
<p>最后，我们导出我们的状态。我们还添加了一个<code>if</code>语句来检查我们的本地存储项是否不存在。如果没有，它会创建该项并将<code>state</code>分配给本地存储:</p>
<pre class="language-javascript hljs"> export default () =&gt; {
  if (localStorage.getItem(STATE_NAME) === null) {
    localStorage.setItem(STATE_NAME, JSON.stringify(state));
  }
  return {
    state,
  };
};
</pre>
<p>现在，我们的状态总是与本地存储同步，确保一致性。</p>
<p>我们来看看<code>src/composables/connect/index.js</code>:</p>
<pre class="language-javascript hljs">import { reactive, watch } from "vue";

const defaultState = {
  address: "",
  chainId: "",
  status: false,
};

const STATE_NAME = "userState";
const getDefaultState = () =&gt; {
  if (localStorage.getItem(STATE_NAME) !== null) {
    return JSON.parse(localStorage.getItem(STATE_NAME));
  }
  return defaultState;
};
const state = reactive(getDefaultState());

watch(
  () =&gt; state,
  () =&gt; {
    localStorage.setItem(STATE_NAME, JSON.stringify(state));
  },
  { deep: true }
);
export default () =&gt; {
  if (localStorage.getItem(STATE_NAME) === null) {
    localStorage.setItem(STATE_NAME, JSON.stringify(state));
  }
  return {
    state,
  };
};
</pre>
<h2 id="creating-actions">创建操作</h2>
<p>我们的操作包括将在我们的应用程序中使用的功能。我们将创建三个函数:</p>
<ul>
<li><code>connectWalletConnect</code>，触发 WalletConnect 模式连接钱包</li>
<li><code>autoConnect</code>，它在 DApp 连接后处理 WalletConnect 会话内的一致性，因此当 DApp 连接且您刷新页面时，用户的会话仍处于活动状态</li>
<li><code>disconnectWallet</code>，断开 DApp 与钱包的连接，并结束用户的会话</li>
</ul>
<p>让我们直接进入代码！</p>
<h3 id="connectwalletconnect"><code>connectWalletConnect</code></h3>
<p>仍然在我们的<code>connect</code>文件夹(<code>src/composables/connect</code>)中，创建<code>connectWalletConnect</code>文件。首先，我们从<code>ethers</code>导入我们的索引文件<code>providers</code>，以及我们之前在<code>src/walletConnect/provider.js</code>文件中创建的<code>provider</code>:</p>
<pre class="language-javascript hljs">import { providers } from "ethers";
import connect from "./index";
import { provider } from "../../walletConnect/provider";

const connectWalletConnect = async () =&gt; {
  try {
    const { state } = connect();
    //  Enable session (triggers QR Code modal)
    await provider.enable();
    const web3Provider = new providers.Web3Provider(provider);
    const signer = await web3Provider.getSigner();
    const address = await signer.getAddress();
    state.status = true;
    state.address = address;
    state.chainId = await provider.request({ method: "eth_chainId" });

    provider.on("disconnect", (code, reason) =&gt; {
      console.log(code, reason);
      console.log("disconnected");
      state.status = false;
      state.address = "";
      localStorage.removeItem("userState");
    });

    provider.on("accountsChanged", (accounts) =&gt; {
       if (accounts.length &gt; 0) {
        state.address = accounts[0];
      }
    });

    provider.on("chainChanged", (chainId) =&gt; {
      state.chainId = chainId
    });
  } catch (error) {
    console.log(error);
  }
};
export default connectWalletConnect;</pre>
<p>接下来，我们有一个<code>try-catch</code>语句。在我们的<code>try</code>语句中，我们从<code>connect()</code>获取状态，并弹出我们的 QR 模式进行连接。一旦连接上，我们就将我们的<code>address</code>和<code>chainId</code>分配给状态属性，并使我们的<code>state.status</code>读为<code>true</code>。</p>
<p>然后我们用<code>provider</code> : <code>disconnect</code>、<code>accountsChanged</code>和<code>chainChainged</code>观看三个事件。</p>
<ul>
<li>一旦用户直接断开钱包连接，就会触发<code>disconnect</code></li>
<li>如果用户切换钱包中的账户，则触发<code>accountsChanged</code>。如果<code>account</code>数组的长度大于零，我们将<code>state.address</code>赋给数组中的第一个地址(<code>accounts[0]</code>，这是当前地址</li>
<li>如果用户切换他们的链/网络，则触发<code>chainChainged</code>。例如，如果他们将他们的链从以太坊 mainnet 切换到 rinkeby testnet，我们的应用程序会将<code>state.chainId</code>从<code>1</code>更改为<code>4</code></li>
</ul>
<p>然后，我们的<code>catch</code>语句简单地将任何错误记录到控制台。</p>
<p>回到<code>connect</code>文件夹中的<code>index.js</code>文件，导入<code>connectWalletConnect</code>动作。在这里，我们创建一个<code>actions</code>对象并用我们的<code>state</code>导出它:</p>
<pre class="language-javascript hljs">import { reactive, watch } from "vue";
import connectWalletConnect from "./connectWalletConnect";

const STATE_NAME = "userState";
const defaultState = {
  address: "",
  chainId: "",
  status: false,
};
const getDefaultState = () =&gt; {
  if (localStorage.getItem(STATE_NAME) !== null) {
    return JSON.parse(localStorage.getItem(STATE_NAME));
  }
  return defaultState;
};
const state = reactive(getDefaultState());
const actions = {
  connectWalletConnect,
};
watch(
  () =&gt; state,
  () =&gt; {
    localStorage.setItem(STATE_NAME, JSON.stringify(state));
  },
  { deep: true }
);
export default () =&gt; {
  if (localStorage.getItem(STATE_NAME) === null) {
    localStorage.setItem(STATE_NAME, JSON.stringify(state));
  }
  return {
    state,
    ...actions,
  };
};</pre>
<h3 id="autoconnect"><code>autoConnect</code></h3>
<p>让我们继续到<code>autoConnect.js</code>，和我们的<code>actions</code>。类似于<code>connectWalletConnect</code>，创建一个<code>autoConnect.js</code>文件。我们导入索引文件并使用<code>connect()</code>对其进行析构以获得我们的<code>state</code>和<code>connectWalletConnect</code>:</p>
<pre class="language-javascript hljs">import connect from "./index";

const autoConnect = () =&gt; {
  const { state, connectWalletConnect } = connect();
  if (state.status) {
    if (localStorage.getItem("walletconnect") == null) {
      console.log("disconnected");
      console.log("disconnected");
      state.status = false;
      state.address = "";
      localStorage.removeItem("userState");
    }
    if (localStorage.getItem("walletconnect")) {
      (async () =&gt; {
        console.log("start");
        connectWalletConnect();
      })();
    }
  }
};
export default autoConnect;
</pre>
<p>您应该知道的一件事是，一旦 WalletConnect 成功连接到 DApp，所有关于该钱包的信息(包括地址和链 ID)都存储在本地存储中一个名为<code>walletconnect</code>的项目下。一旦会话断开，它就会被自动删除。</p>
<p><code>autoConnect</code>检查我们的<code>state.status</code>是否为真。如果是，我们检查本地存储中是否有一个<code>walletConnect</code>项目。如果它不在本地存储中，我们删除我们状态中的所有现有数据和本地存储中的<code>userState</code>项。</p>
<p>然而，如果<code>walletconnect</code>存在于您的本地存储中，我们有一个异步函数，它通过触发<code>connectWalletConnect();</code>为我们的 DApp“重新激活”现有会话。因此，如果我们刷新页面，连接仍然有效，可以监听我们的<code>provider</code>事件。</p>
<h3 id="disconnectwallet"><code>disconnectWallet</code></h3>
<p>再来看我们的最后一个动作:<code>disconnectWallet</code>。此操作允许我们从 DApp 本身结束会话。</p>
<p>首先，我们导入提供者和州。然后，我们使用<code>provider.disconnect();</code>来断开会话，之后我们将状态重置回默认值，并删除本地存储中的<code>"userState"</code>项:</p>
<pre class="language-javascript hljs">import { provider } from "../../walletConnect/provider";
import connect from "./index";
const disconnectWallet = async () =&gt; {
    const { state } = connect();
    await provider.disconnect();
    state.status = false;
    state.address = "";
    localStorage.removeItem("userState");
  }
export default disconnectWallet;
</pre>
<p>我们现在可以回到我们的<code>src/composables/connect/index.js</code>并像这样更新<code>actions</code>对象:</p>
<pre class="language-javascript hljs">const actions = {
  connectWalletConnect,
  autoConnect,
  disconnectWallet
};
</pre>
<h2 id="implementing-logic-components">在我们的组件中实现逻辑</h2>
<p>让我们打开我们的<code>StatusContainer</code>组件，并将组件中的逻辑连接到接口。像往常一样，导入您的可组合文件并析构它以获得动作(连接和断开)和我们的状态:</p>
<pre class="language-javascript hljs">&lt;script&gt;
import connect from '../composables/connect/index';
export default {
  name: 'StatusContainer',
  setup: () =&gt; {
    const { connectWalletConnect, disconnectWallet, state } = connect();
    const connectUserWallet = async () =&gt; {
      await connectWalletConnect();
    };

    const disconnectUser = async() =&gt; {
      await disconnectWallet()
    }
    return {
      connectUserWallet,
      disconnectUser,
      state
    }
  }
}
&lt;/script&gt;
</pre>
<p>然后我们返回要在模板中使用的函数(<code>disconnectUser</code>、<code>connectUserWallet</code>)和<code>state</code>:</p>
<pre class="language-javascript hljs"> &lt;template&gt;
  &lt;div class="hello"&gt;
    &lt;h1&gt;Welcome to Your Vue.js Dapp&lt;/h1&gt;
    &lt;div v-if="state.status"&gt;
       &lt;button  @click="connectUserWallet" class="button"&gt;Connected&lt;/button&gt;
       &lt;h3&gt;Address: {{state.address}}&lt;/h3&gt;
       &lt;h3&gt;ChainId: {{state.chainId}}&lt;/h3&gt;
       &lt;button  @click="disconnectUser" class="disconnect__button"&gt;Disconnect&lt;/button&gt;
    &lt;/div&gt;

    &lt;button v-else @click="connectUserWallet" class="button"&gt; Connect Wallet&lt;/button&gt;
  &lt;/div&gt;
&lt;/template&gt;
</pre>
<p>首先，我们使用<code>v-if</code>有条件地显示事物，使用<code>state.status</code>。如果我们已连接并且<code>state.status</code>为真，我们显示<strong>已连接</strong>按钮、用户<code>address</code>和<code>chainId</code>。此外，我们将显示一个<strong>断开</strong>按钮，该按钮触发我们的<code>disconnectUser</code>功能。</p>
<p><img data-attachment-id="114962" data-permalink="https://blog.logrocket.com/integrating-walletconnect-vue-js-dapps/disconnecting-the-user-from-current-session/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/06/Disconnecting-the-user-from-current-session..gif" data-orig-size="600,1333" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Disconnecting the user from current session." data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/06/Disconnecting-the-user-from-current-session.-135x300.gif" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/06/Disconnecting-the-user-from-current-session.-461x1024.gif" decoding="async" class="size-full wp-image-114962 aligncenter jetpack-lazy-image" src="../Images/fa25f84f0e1afd8a1c52ef0036586e44.png" alt="Disconnecting the user from current session." data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2022/06/Disconnecting-the-user-from-current-session..gif?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/06/Disconnecting-the-user-from-current-session..gif"/></p><noscript><img data-lazy-fallback="1" data-attachment-id="114962" data-permalink="https://blog.logrocket.com/integrating-walletconnect-vue-js-dapps/disconnecting-the-user-from-current-session/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/06/Disconnecting-the-user-from-current-session..gif" data-orig-size="600,1333" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Disconnecting the user from current session." data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/06/Disconnecting-the-user-from-current-session.-135x300.gif" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/06/Disconnecting-the-user-from-current-session.-461x1024.gif" decoding="async" loading="lazy" class="size-full wp-image-114962 aligncenter" src="../Images/fa25f84f0e1afd8a1c52ef0036586e44.png" alt="Disconnecting the user from current session." data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/06/Disconnecting-the-user-from-current-session..gif"/></noscript>
<p>如果用户没有连接并且<code>state.status</code>是<code>false</code>，我们只显示<strong>连接钱包</strong>按钮，当我们点击时触发我们的<code>connectUserWallet</code>功能。</p>
<p><img data-attachment-id="114964" data-permalink="https://blog.logrocket.com/integrating-walletconnect-vue-js-dapps/connecting-wallet/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/06/Connecting-wallet.gif" data-orig-size="600,1333" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Connecting wallet" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/06/Connecting-wallet-135x300.gif" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/06/Connecting-wallet-461x1024.gif" decoding="async" class="size-full wp-image-114964 aligncenter jetpack-lazy-image" src="../Images/61e5933480323f145325b78987ded4a0.png" alt="Connecting wallet" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2022/06/Connecting-wallet.gif?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/06/Connecting-wallet.gif"/></p><noscript><img data-lazy-fallback="1" data-attachment-id="114964" data-permalink="https://blog.logrocket.com/integrating-walletconnect-vue-js-dapps/connecting-wallet/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/06/Connecting-wallet.gif" data-orig-size="600,1333" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Connecting wallet" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/06/Connecting-wallet-135x300.gif" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/06/Connecting-wallet-461x1024.gif" decoding="async" loading="lazy" class="size-full wp-image-114964 aligncenter" src="../Images/61e5933480323f145325b78987ded4a0.png" alt="Connecting wallet" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/06/Connecting-wallet.gif"/></noscript>
<h2 id="adding-auto-connect">添加自动连接</h2>
<p>让我们进入我们的<code>App.vue</code>组件，并将我们的<code>autoConnect</code>逻辑添加到组件中。类似于我们之前所做的，我们导入我们的可组合组件，然后析构它以获得<code>autoConnect</code>动作。使用 Vue 的<code>onMounted</code>，我们将启动<code>autoConnect()</code>功能。如前所述，即使我们刷新页面，我们也可以通过钱包收听实时事件:</p>
<pre class="language-javascript hljs">&lt;script&gt;
import StatusContainer from './components/StatusContainer.vue'
import connect from './composables/connect/index';
import {onMounted} from "vue";
export default {
  name: 'App',
  components: {
    StatusContainer
  },
  setup: () =&gt; {
    const { autoConnect} = connect();
     onMounted(async () =&gt; {
      await autoConnect()
    })
  }
}
&lt;/script&gt;
</pre>
<h2>结论</h2>
<p>如果你一路走到这里，恭喜你！<strong>🎉</strong></p>
<p>在本文中，我们逐步介绍了在 Vue DApps 中实现 WalletConnect 的细节。从使用正确的配置设置我们的项目和构建我们的界面，到编写必要的逻辑以确保我们的应用程序始终与钱包同步。</p><div class="code-block code-block-20">
<div class="blog-plug inline-plug vue-inline"><h2>像用户一样体验您的 Vue 应用</h2><p>调试 Vue.js 应用程序可能会很困难，尤其是当用户会话期间有几十个(如果不是几百个)突变时。如果您对监视和跟踪生产中所有用户的 Vue 突变感兴趣，</p><a href="https://lp.logrocket.com/blg/vue-signup" target="_blank">try LogRocket</a><p>. </p><a class="signup" href="https://lp.logrocket.com/blg/vue-signup" target="_blank" rel="noopener noreferrer"><img class="alignnone size-full wp-image-46 jetpack-lazy-image" src="../Images/0d269845910c723dd7df26adab9289cb.png" alt="LogRocket Dashboard Free Trial Banner" data-lazy-src="https://files.readme.io/00591d0-687474703a2f2f692e696d6775722e636f6d2f6a3049327856572e706e67.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://files.readme.io/00591d0-687474703a2f2f692e696d6775722e636f6d2f6a3049327856572e706e67.png"/><noscript><img data-lazy-fallback="1" class="alignnone size-full wp-image-46" src="../Images/0d269845910c723dd7df26adab9289cb.png" alt="LogRocket Dashboard Free Trial Banner" data-original-src="https://files.readme.io/00591d0-687474703a2f2f692e696d6775722e636f6d2f6a3049327856572e706e67.png"/></noscript></a><a href="https://lp.logrocket.com/blg/vue-signup" target="_blank" rel="noopener noreferrer">https://logrocket.com/signup/</a><p>LogRocket 就像是网络和移动应用程序的 DVR，记录你的 Vue 应用程序中发生的一切，包括网络请求、JavaScript 错误、性能问题等等。您可以汇总并报告问题发生时应用程序的状态，而不是猜测问题发生的原因。</p><p>LogRocket Vuex 插件将 Vuex 突变记录到 LogRocket 控制台，为您提供导致错误的环境，以及出现问题时应用程序的状态。</p><p>现代化您调试 Vue 应用的方式- <a class="signup" href="https://lp.logrocket.com/blg/vue-signup" target="_blank" rel="noopener noreferrer">开始免费监控</a>。</p></div>


</div>

<p class="clearfix"/>
<p class="clearfix"/>
</article>

</div>    
</body>
</html>