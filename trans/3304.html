<html>
<head>
<title>Improve repo management with moon - LogRocket Blog</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>利用moon - LogRocket博客改进回购管理</h1>
<blockquote>原文：<a href="https://blog.logrocket.com/improve-repo-management-moon/#0001-01-01">https://blog.logrocket.com/improve-repo-management-moon/#0001-01-01</a></blockquote><div><article class="article-post">
<blockquote><p>Node.js和Git是本教程的先决条件。</p></blockquote>
<p>软件开发不仅包括编写源代码，还包括确保我们正在开发的源代码能够得到有效的管理和版本控制。</p>
<p>通过适当的版本控制，我们可以绘制源代码的历史；轻松地来回指出导致某些问题出现的变化；修复它们；与他人合作；拓展业务，追求一个项目可以走的另一个平行方向；诸如此类。</p>
<p>随着版本控制系统出现的所有这些可能性，有效地管理存储库变得非常重要，因为当管理不当时，解决方案很容易产生新的问题，特别是当项目扩大时。</p>
<p>想象一个简单的JavaScript项目，它随着更多特性的加入而增长。它的依赖性随着时间的推移而增加。同样，它的脚本的数量随着它们的独立依赖性一起增加，开发、预览、测试、格式化、林挺、构建和可能的持续集成被合并。</p>
<p>一个人可以管理大量的这种多重回购，这很容易变得难以管理，因此你可能会决定走单一回购路线。如果你不能正确管理这样的回购，这可能不是最好的解决方案。</p>
<p>所有这些挑战引发了对工具的需求，这些工具可以帮助我们适当地管理常规包管理器所不能提供的源代码库。</p>
<p>moon就是这样一个工具，它有助于充分自动化地有效管理源代码库。让我们进一步了解一下:</p>

<h2 id="what-is-moon">月亮是什么？</h2>
<p>moon是基于JavaScript的项目的存储库管理、组织、编排和通知工具——或者更简单地说，是用Rust编写的JavaScript生态系统的构建系统。</p>
<p>moon中的许多概念在很大程度上受到Bazel和其他流行构建系统的启发，但却是为JavaScript生态系统量身定制的。</p>
<p>由于是用Rust编写的，moon只支持显式编译的目标，目前是:</p>
<ul>
<li>Linux 64位GNU(x86 _ 64-未知-linux-gnu)</li>
<li>Linux 64位musl (x86_64-unknown-linux-musl)</li>
<li>macOS 64位英特尔(x86_64-apple-darwin)</li>
<li>macOS 64位芯片(aarch64-apple-darwin)</li>
<li>Windows 64位(x86_64-pc-windows-msvc)</li>
</ul>
<h2 id="moons-essential-features">月亮的基本特征</h2>
<p>像其他构建系统一样，moon提供了许多特性，使得它在处理存储库时比常规的包管理器更有效。以下是这些功能的要点:</p>

<h2 id="managing-a-repo-with-moon">管理与moon的回购</h2>
<p>我们需要看到moon的工作——即管理一个存储库——以充分理解上面讨论的特性。我将通过管理包含前端客户端和后端服务器的monorepo存储库来演示这些特性。我选择单一回购，因为通过它，我们可以利用moon的最大潜力，覆盖比多重回购更多的功能。</p>
<h3 id="setting-up-moon-for-repository-management">为存储库管理设置moon</h3>
<p>我们可以设置moon来管理一个新项目，或者将现有的回购迁移到monorepo设置中。因为前者很容易设置，所以我们将关注后者。</p>
<p>以下说明将向我们展示如何迁移目前在以下多回购设置中管理的电子商务商店:</p>

<p>如您所见，这两个存储库都不是最终项目。客户端是一个裸露的Vue 3脚手架，服务器是一个express-prisma REST API示例。我故意这样做，以便我们可以看到如何将我们的项目迁移到monorepo设置，同时保持我们的Git历史完整。之后，我们将看看如何继续在monorepo中的两个项目上工作。</p>
<p>要使用moon来管理我们的monorepo，我们需要首先建立一个新的monorepo存储库。</p>
<pre class="language-shell hljs">git init estore &amp;&amp; cd estore
</pre>
<p>在我们的repo目录中，通过运行以下脚本添加一个<code>package.json</code>文件。</p>
<pre class="language-shell hljs"># npm
npm init

#pnpm
pnpm init
</pre>
<p>然后，添加一个. gitignore文件，存放现有文件，并进行第一次提交。</p>
<pre class="language-shell hljs">git commit -m "First commit"
</pre>
<h3 id="migrating-existing-repositories-with-their-histories">迁移现有存储库及其历史记录</h3>
<p>在我们的回购协议中，我们将把我们的两个项目，即<a href="https://github.com/xinnks/estore-client" target="_blank" rel="noopener"> estore-client </a>和<a href="https://github.com/xinnks/estore-server" target="_blank" rel="noopener"> estore-server </a>，放在一个<code>apps/</code>目录下。</p>
<p>因此，我们最初将使用<code>mkdir apps</code>在monorepo中创建该文件夹。而且，由于我们已经将我们的monorepo目录命名为<code>estore</code>，我们将从我们的项目中删除<code>estore</code>前缀，保留<code>client</code>和<code>server</code>。</p>
<p>为了维护当前两个项目(服务器和客户机)的历史，我们将对它们的存储库执行以下操作，同时将它们添加到我们的<code>estore</code> repo中。</p>
<p>从客户端开始，首先，在我们要迁移的应用程序的repo中设置一个<code>git remote</code>。</p>
<pre class="language-shell hljs">git remote add client <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="1c7b75685c7b756874697e327f7371">[email protected]</a>:xinnks/estore-client
</pre>
<p><em>注意，在继续之前，为了避免任何问题，请确保合并这些远程存储库中任何打开的PRs。</em></p>
<p>然后，我们将从远程获取代码，而无需检出分支。</p>
<pre class="language-shell hljs">git fetch client
</pre>
<p>之后，我们将运行下面的脚本，在<code>--prefix</code>标志的帮助下，将远程的主分支Git历史复制到<code>apps/client</code>目录。</p>
<pre class="language-shell hljs">git read-tree --prefix=apps/client -u client/master
</pre>
<p>预览我们与<code>git status</code>的<code>estore</code>回购的状态，我们得到下面的日志。</p>
<pre class="language-shell hljs">On branch master
Changes to be committed:
  (use "git restore --staged &lt;file&gt;..." to unstage)
        new file:   apps/client/.eslintrc.js
        new file:   apps/client/.gitignore
        new file:   apps/client/.prettierignore
        new file:   apps/client/.prettietrc.json
        new file:   apps/client/.vscode/extensions.json
        new file:   apps/client/LICENSE
        new file:   apps/client/README.md
        new file:   apps/client/index.html
        new file:   apps/client/package.json
        new file:   apps/client/pnpm-lock.yaml
        new file:   apps/client/project.yml
        new file:   apps/client/public/vite.svg
        new file:   apps/client/src/App.vue
        new file:   apps/client/src/assets/vue.svg
        new file:   apps/client/src/components/HelloWorld.vue
        new file:   apps/client/src/main.js
        new file:   apps/client/src/style.css
        new file:   apps/client/vite.config.js
</pre>
<p>我们将通过实施变更来完成这一步。</p>
<pre class="language-shell hljs"># Stage changes
git commit -m "feat: Add client app" apps/client
</pre>
<p>预览我们的回购历史，我们会看到之前对<code>client</code>的所有提交都是<code>estore</code>历史的一部分。</p>
<p><img data-attachment-id="129572" data-permalink="https://blog.logrocket.com/improve-repo-management-moon/attachment/incremented-history/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/09/incremented-history.jpeg" data-orig-size="550,757" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Incremented history" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/09/incremented-history-218x300.jpeg" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/09/incremented-history.jpeg" decoding="async" class="aligncenter size-full wp-image-129572 jetpack-lazy-image" src="../Images/f27e0bce91bdb5514223fddf138fdf83.png" alt="Incremented History" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2022/09/incremented-history.jpeg 550w, https://blog.logrocket.com/wp-content/uploads/2022/09/incremented-history-218x300.jpeg 218w" data-lazy-sizes="(max-width: 550px) 100vw, 550px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2022/09/incremented-history.jpeg?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/09/incremented-history.jpeg"/></p><noscript><img data-lazy-fallback="1" data-attachment-id="129572" data-permalink="https://blog.logrocket.com/improve-repo-management-moon/attachment/incremented-history/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/09/incremented-history.jpeg" data-orig-size="550,757" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Incremented history" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/09/incremented-history-218x300.jpeg" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/09/incremented-history.jpeg" decoding="async" loading="lazy" class="aligncenter size-full wp-image-129572" src="../Images/f27e0bce91bdb5514223fddf138fdf83.png" alt="Incremented History" srcset="https://blog.logrocket.com/wp-content/uploads/2022/09/incremented-history.jpeg 550w, https://blog.logrocket.com/wp-content/uploads/2022/09/incremented-history-218x300.jpeg 218w" sizes="(max-width: 550px) 100vw, 550px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/09/incremented-history.jpeg"/></noscript>
<p>在这个具体的例子中，我们可以看到<a href="https://github.com/xinnks/estore-client" target="_blank" rel="noopener"> estore-client的</a>历史先于monorepo的<strong>首次提交</strong>，因为后者是在前者之后创建和提交的。</p>
<p>对<a href="https://github.com/xinnks/estore-server" target="_blank" rel="noopener">restore-server</a>存储库重复这些步骤，将其远程<strong>服务器命名为</strong>。</p>
<p>完成后，我们会得到这样的结果。</p>
<p><img data-attachment-id="129574" data-permalink="https://blog.logrocket.com/improve-repo-management-moon/attachment/completed-history-remote-repositories/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/09/completed-history-remote-repositories.png" data-orig-size="621,943" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Completed history remote repositories" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/09/completed-history-remote-repositories-198x300.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/09/completed-history-remote-repositories.png" decoding="async" class="aligncenter size-full wp-image-129574 jetpack-lazy-image" src="../Images/5e012e71a59946660aaf2336a22742c7.png" alt="Completed History Remote Repositories" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2022/09/completed-history-remote-repositories.png 621w, https://blog.logrocket.com/wp-content/uploads/2022/09/completed-history-remote-repositories-198x300.png 198w" data-lazy-sizes="(max-width: 621px) 100vw, 621px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2022/09/completed-history-remote-repositories.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/09/completed-history-remote-repositories.png"/></p><noscript><img data-lazy-fallback="1" data-attachment-id="129574" data-permalink="https://blog.logrocket.com/improve-repo-management-moon/attachment/completed-history-remote-repositories/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/09/completed-history-remote-repositories.png" data-orig-size="621,943" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Completed history remote repositories" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/09/completed-history-remote-repositories-198x300.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/09/completed-history-remote-repositories.png" decoding="async" loading="lazy" class="aligncenter size-full wp-image-129574" src="../Images/5e012e71a59946660aaf2336a22742c7.png" alt="Completed History Remote Repositories" srcset="https://blog.logrocket.com/wp-content/uploads/2022/09/completed-history-remote-repositories.png 621w, https://blog.logrocket.com/wp-content/uploads/2022/09/completed-history-remote-repositories-198x300.png 198w" sizes="(max-width: 621px) 100vw, 621px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/09/completed-history-remote-repositories.png"/></noscript>
<p>现在，我们准备在<code>estore</code>内初始化月球。</p>
<h3 id="installing-the-moon-cli">安装moon CLI</h3>
<p>moon的CLI在<code>@moonrepo/cli</code> npm包中的单个二进制文件中提供。建议全局安装CLI，以简化从任何目录运行其命令，而不是仅依赖于<code>package.json</code>脚本。</p>
<p>无论您使用什么样的软件包管理器，都应该使用npm来完成全局安装。</p>
<pre class="language-shell hljs">npm install -g @moonrepo/cli
</pre>
<p>接下来，在您的repo上添加CLI，如下所示。</p>
<pre class="language-shell hljs"># yarn
yarn add --dev @moonrepo/cli

# npm
npm install --save-dev @moonrepo/cli

# pnpm
pnpm add -D @moonrepo/cli -w
</pre>
<p>当使用全局二进制时，moon确保使用与在<code>package.json</code>中的回购的<code>dependencies</code>部分中定义的版本相同的版本。</p>
<p>对于CI(持续集成)这样的场景，可以通过下面的<code>package.json</code>脚本运行moon。</p>
<pre class="language-json hljs">{
  "scripts": {
    // ...
    "moon": "moon",
    // Yarn 2+
    "moon": "$(yarn bin moon)"
  }
}
</pre>
<p>但是这样的设置需要启动Node.js和包管理器来执行Rust二进制文件。在这种情况下，建议使用全局二进制设置。</p>
<p>此外，这种设置不适用于包工作区，除非脚本从存储库根目录运行。</p>
<p>安装了moon CLI后，我们现在可以用这个脚本在repo中初始化moon。</p>
<pre class="language-shell hljs">moon init
</pre>
<p>会出现一个提示，询问我们正在初始化moon的目录以及我们正在使用的<br/>包管理器。</p>
<h3 id="workspaces">工作区</h3>
<p>工作区是一个目录，它包含项目、管理工具链、运行任务，并与VCS存储库相耦合。moon对工作区有一流的支持。虽然不是必需的，但是设置它们符合moon的理念。</p>
<p>工作空间的根由一个<code>.moon</code>目录和一个<code>package.json</code>文件表示。</p>
<p>为了在我们的项目中利用工作区，我们需要根据我们所使用的包管理器的配置来启用它们。下面是各种配置。</p>
<p>对于纱线/npm (package.json)</p>
<pre class="language-json hljs">{
  "workspaces": ["apps/"]
}
</pre>
<p>对于pnpm (pnpm-workspace.yaml)</p>
<pre class="language-yaml hljs">packages:
  - 'apps/'
</pre>
<h3 id="configuring-workspaces-in-moon">在moon中配置工作空间</h3>
<p>我们可以通过编辑包含在新创建的<code>.moon</code>目录中的<code>workspaces.yml</code>文件来配置我们的工作空间，该目录是在我们运行<code>moon init</code>命令之后创建的。</p>
<p>以下是我们可以在该文件中设置的设置列表。</p>
<p>我们将根据我们项目的布局来配置它。</p>
<h4 id="nodejs">节点. js</h4>
<p>在<code>.moon/workspace.yml</code>文件的<code>node</code>部分，我们可以定义运行moon命令时使用的Node.js版本。这是非常重要的，因为它在可能的不同开发团队之间加强了一致性，这些团队在同一个工作区存储库中从事不同的项目。</p>
<pre class="language-yaml hljs">node:
  version: '16.16.0'
</pre>
<p><em>注意，</em> <code>node.version</code> <em>设置需要明确的语义版本。它不支持版本范围。moon还建议使用一个</em> <a href="https://nodejs.org/en/about/releases/" target="_blank" rel="noopener"> <em>主动LTS </em> </a> <em> Node.js版本。</em></p>
<h4 id="package-manager">包管理器</h4>
<p>moon使用npm作为默认的包管理器。要改变这一点并将包管理器设置为我们选择的一个，我们需要更新<code>workspace.yml</code>中的<code>node.packageManager</code>。我们可以将这个值设置为<code>npm</code>、<code>yarn</code>或<code>pnpm</code>。</p>
<pre class="language-yaml hljs">node:
  version: '16.16.0'
  packageManager: 'pnpm'
</pre>
<p>通常情况下，moon会安装最新版本的软件包管理器，但它从来没有持续更新过。这就是为什么建议为它定义一个显式的语义版本，就像我们对Node.js版本所做的那样。</p>
<p>这确保了我们工具链的一致性。即使你选择了<code>npm</code>作为你的包管理器，也应该这样做。</p>
<pre class="language-yaml hljs">  node:
    version: '16.16.0'
    packageManager: 'pnpm'
    pnpm:
      version: '7.8.0'
</pre>
<p>在设置了节点和程序包管理器版本之后，运行以下脚本来验证是否安装了这两个版本。</p>
<pre class="language-shell hljs">  moon --log debug setup
</pre>
<p>该命令将根据配置下载并安装工具链所需的工具。</p>
<h4 id="version-control-system">版本控制系统</h4>
<p>moon需要一个版本控制系统来进行区分、散列和版本比较。默认情况下，使用Git，因此可以跳过这个设置。</p>
<p>但是为了一致性，也设置这个。我们可以通过<code>vcs</code>设置来做到这一点。</p>
<pre class="language-yaml hljs">  vcs:
    manager: 'git'
    defaultBranch: 'master'
</pre>
<p><em>注意，</em> <em> SVN目前是实验性的，因此可能无法正常工作。</em></p>
<h3 id="projects-in-moon">月球项目</h3>
<p>项目可以是来自应用程序、库或工具的任何东西。每个都有自己的构建层、单独的任务和自定义配置。</p>
<p>配置好我们的工作空间后，我们可以在它下面存放尽可能多的项目。</p>
<p>此时，我们在<code>apps</code>目录中有了<code>client</code>和<code>server</code>项目，但是在我们将它们映射到<code>workspaces</code>文件中的<code>projects</code>设置之前，它们无法从moon访问。</p>
<p><code>projects</code>设置是在我们的工作空间中找到的所有项目(或文件系统globs)的映射。我们以<code>key: value</code>格式列出我们的项目，其中键是项目的惟一ID，值是项目相对于工作区根目录的文件路径。</p>
<p>目前，在<code>workspaces.yml</code>中，您会发现一个示例项目<code>example: 'apps/example</code>。删除这个并添加<code>client</code>和<code>server</code>项目以及它们各自的文件路径来反映我们的两个项目，如下所示。</p>
<pre class="language-yaml hljs">  projects:
    server: 'apps/server'
    client: 'apps/client'
</pre>
<p>运行<code>moon project &lt;project-key&gt;</code>记录在公共和本地月球配置中设置的项目配置。如果我们得到一个错误，这意味着我们没有正确地映射我们的项目。</p>
<p>这是我们在回购上运行<code>moon project client</code>时的预期输出。</p>
<pre class="language-shell hljs">  CLIENT 

ID: client
Source: apps/client
Root: ~/Projects/estore/apps/client
Language: JavaScript
Type: Application
Name: client
Description: Estore front-end client application
Owner: @estore/client
Maintainers:
 - &lt;client.project.maintainer&gt;
Channel: #moon

 TASKS 

build: vite build
dev: vite --port 3000
format: prettier --write .
install: pnpm install
lint: eslint --ext .js,.vue --ignore-path .gitignore --fix src

 FILE GROUPS 

assets:
 - src/assets/*
 - **/*.{scss,css}
 - **/*.mdx
configs:
 - *.{js,json}
sources:
 - src/**/*
 - types/**/*
tests:
 - tests/**/*.test.*
 - **/__tests__/**/*
</pre>
<h3 id="configuring-projects-in-moon">在moon中配置项目</h3>
<p>moon中的项目可以通过每个项目目录下的<code>.moon/project.yml</code>或<code>moon.yml</code>配置文件进行配置。</p>
<p><code>.moon/project.yml</code>文件在配置工作区内所有项目继承的组和任务时非常有用。这是我们可以放置诸如林挺、类型检查和格式化等常见任务的地方。</p>
<p>项目特定的<code>moon.yml</code>文件在定义和配置项目特有的文件组、任务和依赖关系时非常有用。</p>
<p>这两个配置文件是可选的，既可以单独使用，也可以一起使用。在我们的例子中，我们将同时使用它们。</p>
<p>从<code>.moon</code>中的全局配置文件开始，添加我们的两个项目，给它们的id分别为<code>client</code>和<code>server</code>。</p>
<pre class="language-yaml hljs">projects:
  client: 'apps/client'
  server: 'apps/server'
</pre>
<p>更新Node.js、包管理器和VCS设置。</p>
<pre class="language-yaml hljs">node:
  version: '16.16.0'
  # Any of "npm" (default), "pnpm", or "yarn".
  packageManager: 'pnpm'
  # The version of the package manager (above) to use.
  pnpm:
    version: '7.8.0'
vcs:
  # The manager/binary to use when managing the repository.
  # Accepts "git", or "svn". Defaults to "git".
  manager: 'git'
</pre>
<h3 id="configuring-tasks">配置任务</h3>
<p>与上面解释的两个配置文件一样，我们可以将全局任务放在<code>.moon/workspace.yml</code>中。在我们的项目中，就像在许多其他项目中一样，可以作为任务放在这里的脚本是诸如林挺和格式化之类的脚本，因为这些可能是大多数项目的同义词。</p>
<p>因此，我们将通过添加这些任务来更新该文件。</p>
<pre class="language-yaml hljs">tasks:
  # Name of the task.
  format:
    # The name of the binary/command on your system.
    command: 'prettier'
    # List of arguments to pass on the command line when executing the task.
    args: '--write .'
    # The type of command to run, and where to locate it.
    # Accepts "node" (default) or "system".
    type: 'node'
  lint:
    command: 'eslint'
    args:
      - --ignore-path
      - .gitignore
      - --fix
      - src
    type: 'node'
</pre>
<p>从上面的配置中，我们可以看到任务有一个名称、参数(<code>args</code>)和一个类型。稍后我们会看到更多的选项，关于任务选项的完整列表，你可以在moon的<a href="https://moonrepo.dev/docs/create-task" target="_blank" rel="noopener">文档</a>中看到。</p>
<p>正如在moon的特性中提到的，在这里，我们将介绍任务的粒度配置。</p>
<p>我们也将把单个项目脚本转换成月球任务。</p>
<p>从<code>server</code>项目开始。</p>
<pre class="language-yaml hljs"># apps/server/moon.yml

---
type: "application"
language: javascript
project:
  name: "server"
  description: "Estore's back-end server application"
  channel: "#moon"
  owner: "@estore/server"
  maintainers: ["server.project.leader"]
tasks:
  lint:
    command: "eslint"
    args:
      - --ext
      - .js
    type: "node"
    options:
      mergeArgs: "prepend"
  seed:
    command: node
    args:
      - prisma/seed
    deps:
      - "~:init"
    type: node
  init:
    command: pnpm
    args:
      - dlx
      - prisma
      - migrate
      - dev
      - "--name"
      - init
    type: node
  dev:
    command: nodemon
    deps:
      - "~:seed"
      - "~:lint"
      - "~:format"
    options:
      outputStyle: "stream"
    type: node
  serve:
    command: node
    args:
      - "src/index.js"
      - "NODE_ENV=production"
    deps:
      - "~:init"
    type: node
</pre>
<p>在这个配置文件中，我们可以看到更多的任务选项。</p>
<p>这里，设置为<code>"stream"</code>的<code>options.outputStyle</code>允许在任务运行时，将输出日志从正在运行的任务直接传输到控制台。</p>
<p><code>deps</code>设置允许我们使用一个或多个任务作为另一个任务的依赖项。</p>
<p>设置为<code>"prepend"</code>的<code>options.mergeArgs</code>，将这个任务中的参数作为前缀添加到全局项目配置<code>.moon/project.yml</code>中的对应项。因此，在这个特定项目上运行时，<code>"lint"</code>任务的完整脚本如下。</p>
<pre class="language-yaml hljs">lint:
    # The name of the binary/command on your system.
    command: 'prettier'
    # List of arguments to pass on the command line when executing the task.
    args:
      - --ext
      - .js
      - --ignore-path
      - .gitignore
      - --fix
      - src
    # The type of command to run, and where to locate it.
    # Accepts "node" (default) or "system".
    type: 'node'
</pre>
<p>这对于一个相同的任务，在这里是<code>"lint"</code>，可能需要应用于不同的文件类型，这取决于它运行的项目。</p>
<p>这个配置文件还为我们提供了一个通过<code>project</code>设置来设置项目元数据的层，如下例所示。</p>
<p>使用以下设置完成<code>client</code>项目配置。</p>
<pre class="language-yaml hljs">type: "application"
project:
  name: "client"
  description: "Estore's front-end client application"
  channel: "#moon"
  owner: "@estore/client"
  maintainers: ["client.project.lead"]
language: javascript
tasks:
  lint:
    command: 'eslint'
    args:
      - --ext
      - .js,.vue
    type: 'node'
    options:
      mergeArgs: 'prepend'
  dev:
    command: vite
    args: "--port 3000"
    deps:
      - "~:lint"
      - "~:format"
    options:
      runInCI: false
      outputStyle: "stream"
    type: node
  build:
    command: vite
    args:
      - build
    deps:
      - "~:lint"
      - "~:format"
    type: node
  preview:
    command: vite
    args:
      - preview
    type: node
</pre>
<p>观察上面的配置，我们可以看到应用于客户端项目的<code>"lint"</code>任务的变更。</p>
<p>正如我们在<code>estore</code>中看到的，两个项目中都存在依赖关系，有些依赖关系是一个项目独有的。我们可以更新<code>package.json</code>文件，将全局依赖项添加到工作空间根的<code>package.json</code>中，并将它们从项目特定的<code>package.json</code>文件中移除。</p>
<p>我们现在可以运行<code>npm install</code>来安装依赖项。而且，如果我们已经正确地配置了我们的工作空间，依赖项将被安装在它们适当的位置:工作空间根上的全局依赖项，以及各个项目根内的项目特定的依赖项。</p>
<p>然后，我们可以继续修改我们的项目，以达到可行的消费水平。完整的源代码可以在<a href="https://github.com/xinnks/estore" target="_blank" rel="noopener"> estore的GitHub库</a>中找到。</p>
<p>之后，准备并提交变更。选择一种提交提交的方式，这种方式简化了对独立项目的Git历史的识别，但同时显示了作为一个整体的存储库中连贯的流程。(或者，您可以只使用来自<code>estore</code>存储库的代码)</p>
<p>当一切都设置好后，我们可以用<code>moon run</code>命令执行配置的任务。</p>
<p>任务可以通过两种方式执行:</p>
<p>a.项目范围内有<code>moon run &lt;project-id&gt;:&lt;task-name&gt;</code></p>
<p>从我们的存储库中，我们可以使用这种格式的命令在<code>apps/client</code>中运行<code>build</code>任务，如下所示。</p>
<pre class="language-shell hljs">moon run client:build</pre>
<p>b.我们还可以使用这个moon命令:<code>moon run :&lt;task-name&gt;</code>在monorepo中全局运行要在所有项目中执行的任务。在我们的例子中，我们可以以这种方式运行lint和format任务，这样两个项目都被格式化和lint</p>
<pre class="language-shell hljs">moon run :format 
</pre>
<p>要查看依赖任务的运行情况，请尝试在我们的工作区上运行<code>moon run client:dev</code>。由于这个命令依赖于lint和format命令，您将看到这两个任务也与dev任务一起运行。</p>
<p>尽管moon相对较新，但它在管理回购方面做得很好。正如我们在上面的例子中看到的，moon有一个平滑的学习曲线。观察它的发展，从它活跃的开发团队中看到它的特性，它展示了前进的希望。</p>
<p>请务必访问moon的<a href="https://github.com/moonrepo/moon/releases" target="_blank" rel="noopener">变更日志</a>来查看项目中加入的新功能。目前，新功能每两周添加一次。</p>
<h2 id="h2summary">摘要</h2>
<p>在这篇全面介绍moon特性和概念的文章中，我们使用了一个真实的例子(在这种情况下，是一个电子商务web应用程序的开发)，涵盖了以下内容:</p>
<ul>
<li>什么是月亮及其基本特征</li>
<li>如何从多回购协议设置中设置单回购协议，并使用moon对其进行管理</li>
<li>如何在moon中配置工作空间并在monorepo设置中管理多个项目</li>
<li>如何创建月球任务，并与他们的各种选择，以实现高效的结果</li>
</ul>
<p>像许多其他构建系统一样，moon具有诸如任务缓存和只在受影响的代码上运行的特性，可以被认为对所有类型的项目(多回购和单回购)都有用，因为这些特性提供了包管理器等常规工具所没有的效率。</p>
<p>我们承认monorepo设置引入了对组织和我们如何看待代码的改变，因为它不仅仅是代码和工具。反过来，我们获得了一些优势，如增加一致性、减少创建新项目的开销、执行大规模重构、促进代码共享和协作等。总的来说，它们促进了复杂项目中的高效工作。</p>
<p>在这一点上，尽管相对来说还处于起步阶段，但moon提供了其他构建系统目前没有提供的以下工具:</p>
<ul>
<li>一个集成的<a href="https://moonrepo.dev/docs/concepts/toolchain" target="_blank" rel="noopener">工具链</a>,确保在所有机器上使用相同版本的Node.js、包管理器(npm、yarn、pnpm)和其他工具，确保一致和可复制的构建</li>
<li>跨工作空间的简单任务声明和继承。全局任务可以定义为在一个工作区内的所有项目上运行，并且可以根据单个项目的需要进一步修改。我们已经在estore示例中看到了这方面的演示</li>
<li>常见JavaScript问题的自动化，例如<code>package.json</code>依赖项和<code>tsconfig.json</code>项目引用</li>
<li><a href="https://moonrepo.dev/docs/guides/ci" target="_blank" rel="noopener">持续集成(CI)的一流支持</a></li>
</ul>
<p>月球和其他主流建筑系统的比较可以在这里找到。</p>
<p>要深入了解和研究更多关于月球、它的概念、它所提供的东西和更多的例子，你可以访问<a href="https://moonrepo.dev/" target="_blank" rel="noopener">月球的官方文件</a>。</p><div class="code-block code-block-27">
<div class="blog-plug inline-plug vanilla-javascript-cta"><h2>通过理解上下文，更容易地调试JavaScript错误</h2>
<p>调试代码总是一项单调乏味的任务。但是你越了解自己的错误，就越容易改正。</p>
<p>LogRocket 让你以新的独特的方式理解这些错误。我们的前端监控解决方案跟踪用户与您的JavaScript前端的互动，让您能够准确找出导致错误的用户行为。</p>
<a href="https://lp.logrocket.com/blg/javascript-signup" class="signup" target="_blank" rel="noopener noreferrer"><img class="alignnone size-full wp-image-46 jetpack-lazy-image" src="../Images/cbfed9be3defcb505e662574769a7636.png" alt="LogRocket Dashboard Free Trial Banner" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2020/06/reproduce-javascript-errors.gif?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/06/reproduce-javascript-errors.gif"/><noscript><img data-lazy-fallback="1" class="alignnone size-full wp-image-46" src="../Images/cbfed9be3defcb505e662574769a7636.png" alt="LogRocket Dashboard Free Trial Banner" data-original-src="https://blog.logrocket.com/wp-content/uploads/2020/06/reproduce-javascript-errors.gif"/></noscript></a>
<p>LogRocket记录控制台日志、页面加载时间、堆栈跟踪、慢速网络请求/响应(带有标题+正文)、浏览器元数据和自定义日志。理解您的JavaScript代码的影响从来没有这么简单过！</p><div class="code-block code-block-29">
<div class="blog-plug inline-plug rust-plug"><h2><a href="https://lp.logrocket.com/blg/rust-signup" target="_blank">log rocket</a>:Rust应用的web前端的全面可见性</h2><p>调试Rust应用程序可能很困难，尤其是当用户遇到难以重现的问题时。如果您对监控和跟踪Rust应用程序的性能、自动显示错误、跟踪缓慢的网络请求和加载时间感兴趣，</p><a href="https://lp.logrocket.com/blg/rust-signup" target="_blank">try LogRocket</a><p>. </p><a class="signup" href="https://lp.logrocket.com/blg/rust-signup" target="_blank" rel="noopener noreferrer"><img class="alignnone size-full wp-image-46 jetpack-lazy-image" src="../Images/d6f5a5dd739296c1dd7aab3d5e77eeb9.png" alt="LogRocket Dashboard Free Trial Banner" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2017/03/1d0cd-1s_rmyo6nbrasp-xtvbaxfg.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2017/03/1d0cd-1s_rmyo6nbrasp-xtvbaxfg.png"/><noscript><img data-lazy-fallback="1" class="alignnone size-full wp-image-46" src="../Images/d6f5a5dd739296c1dd7aab3d5e77eeb9.png" alt="LogRocket Dashboard Free Trial Banner" data-original-src="https://blog.logrocket.com/wp-content/uploads/2017/03/1d0cd-1s_rmyo6nbrasp-xtvbaxfg.png"/></noscript></a><p>LogRocket 就像是网络和移动应用程序的DVR，记录你的Rust应用程序上发生的一切。您可以汇总并报告问题发生时应用程序的状态，而不是猜测问题发生的原因。LogRocket还可以监控应用的性能，报告客户端CPU负载、客户端内存使用等指标。</p><p>现代化调试Rust应用的方式— <a class="signup" href="https://lp.logrocket.com/blg/rust-signup" target="_blank" rel="noopener noreferrer">开始免费监控</a>。</p></div>


</div>
<a class="signup" href="https://lp.logrocket.com/blg/javascript-signup" target="_blank" rel="noopener noreferrer">Try it for free</a><p>.</p></div>


</div>

<p class="clearfix"/>
<p class="clearfix"/>
</article>

</div>    
</body>
</html>