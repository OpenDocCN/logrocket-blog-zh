<html>
<head>
<title>Understanding partial hydration in Gatsby 5 </title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>了解盖茨比5中的部分水合作用</h1>
<blockquote>原文：<a href="https://blog.logrocket.com/understanding-partial-hydration-gatsby-5/#0001-01-01">https://blog.logrocket.com/understanding-partial-hydration-gatsby-5/#0001-01-01</a></blockquote><div><article class="article-post">
<p>在撰写本文时，Gatsby的最新版本v5附带了部分水合功能。仍处于测试阶段，部分水合使您能够有选择地向完全静态的应用程序添加交互性，从而提高前端性能，同时仍保留客户端应用程序的优势。</p>
<p>在基于React的应用程序和网站中，所有的JavaScript代码都必须在页面变得可交互之前下载，这尤其会影响到交互的<a href="https://developer.chrome.com/en/docs/lighthouse/performance/interactive/">时间</a> (TTI)指标。但是，由于Gatsby的部分水合，开发人员现在可以只水合React组件的必要JavaScript代码，从而减少JavaScript包的大小并提高页面速度。</p>
<p>在React中，<a href="https://www.gatsbyjs.com/docs/conceptual/react-hydration/">水合</a>是使用客户端JavaScript向服务器呈现的HTML添加应用程序状态和交互性的过程。Gatsby通过利用React服务器组件生成服务器组件的输出来实现部分水合，从页面级开始，一直到孤立的组件。在本文中，我们将探索Gatsby和React应用程序中的部分水合。</p>

<h2 id="motivation-partial-hydration">部分水合背后的动机</h2>
<p>大多数Gatsby网站都是基于内容的，只需要几个部分是交互式的。然而，为了确保点击事件、效果和状态改变正确工作，我们必须下载处理这些事件的JavaScript。不幸的是，这种行为会导致大量未使用的JavaScript代码被下载，使您的网站速度更慢、成本更高。在这里，部分水合作用就派上了用场。</p>
<p>根据Gatsby文档，部分水合对于具有交互组件的页面是有用的，其中一些组件需要页面上的交互性，而一些可以静态呈现，例如，具有大量静态内容和一些交互表单和按钮的产品页面。</p>
<p>看看下面这张来自Gatsby网站的图表。它解释了部分水合和完全水合之间的差异。</p>
<p>在这个虚构的页面中，组件大部分是静态的，除了carousel，它是一个交互式组件。通常，当这个页面被加载时，我们会为静态的、不需要的站点部分请求JavaScript代码。然而，对于部分水合，我们只要求交互式组件的JavaScript代码:</p>
<p><img data-attachment-id="151537" data-permalink="https://blog.logrocket.com/understanding-partial-hydration-gatsby-5/attachment/gatsby-full-vs-partial-hydration/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/12/gatsby-full-vs-partial-hydration.png" data-orig-size="786,340" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="gatsby-full-vs-partial-hydration" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/12/gatsby-full-vs-partial-hydration-300x130.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/12/gatsby-full-vs-partial-hydration.png" decoding="async" class="aligncenter wp-image-151537 size-full jetpack-lazy-image" src="../Images/d34592ebf4617078299ca0ff2c0e118f.png" alt="Gatsby Full vs Partial Hydration" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2022/12/gatsby-full-vs-partial-hydration.png 786w, https://blog.logrocket.com/wp-content/uploads/2022/12/gatsby-full-vs-partial-hydration-300x130.png 300w, https://blog.logrocket.com/wp-content/uploads/2022/12/gatsby-full-vs-partial-hydration-768x332.png 768w" data-lazy-sizes="(max-width: 786px) 100vw, 786px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2022/12/gatsby-full-vs-partial-hydration.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/12/gatsby-full-vs-partial-hydration.png"/></p><noscript><img data-lazy-fallback="1" data-attachment-id="151537" data-permalink="https://blog.logrocket.com/understanding-partial-hydration-gatsby-5/attachment/gatsby-full-vs-partial-hydration/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/12/gatsby-full-vs-partial-hydration.png" data-orig-size="786,340" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="gatsby-full-vs-partial-hydration" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/12/gatsby-full-vs-partial-hydration-300x130.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/12/gatsby-full-vs-partial-hydration.png" decoding="async" loading="lazy" class="aligncenter wp-image-151537 size-full" src="../Images/d34592ebf4617078299ca0ff2c0e118f.png" alt="Gatsby Full vs Partial Hydration" srcset="https://blog.logrocket.com/wp-content/uploads/2022/12/gatsby-full-vs-partial-hydration.png 786w, https://blog.logrocket.com/wp-content/uploads/2022/12/gatsby-full-vs-partial-hydration-300x130.png 300w, https://blog.logrocket.com/wp-content/uploads/2022/12/gatsby-full-vs-partial-hydration-768x332.png 768w" sizes="(max-width: 786px) 100vw, 786px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/12/gatsby-full-vs-partial-hydration.png"/></noscript>
<h2 id="what-interactive-components">什么是交互组件？</h2>
<p>交互组件是包含<code>useEffect</code>、<code>useState</code>、<code>createContext</code>或事件处理程序的组件。类组件与服务器组件不兼容，也应该标记为交互式的。</p>
<h2 id="how-use-partial-hydration">《盖茨比》中如何使用部分水合</h2>
<p>让我们通过一个例子来学习如何使用部分水合作用。要开始，安装最新版本的Gatsby和实验版本的React和<code>react-dom</code>:</p>
<pre class="language-javascript hljs">npm install <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="89eee8fdfaebf0c9e7ecf1fd">[email protected]</a> <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="ed9f888c8e99ad88959d889f84808883998c81">[email protected]</a> <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="ed9f888c8e99c0898280ad88959d889f84808883998c81">[email protected]</a>
</pre>
<p>接下来，继续启用<code>gatsby-config</code>文件中的<code>PARTIAL_HYDRATION</code>标志:</p>
<pre class="language-javascript hljs">//gatsby.config.js

flags: {
  PARTIAL_HYDRATION: true,
},
</pre>
<p>默认情况下，Gatsby 5将每个组件视为一个服务器组件，从顶层页面开始，为每个页面生成React服务器组件(RSC)文件。因此，要告诉Gatsby启用组件的部分水合，您必须在组件的顶部添加指令<a href="https://github.com/reactjs/rfcs/blob/main/text/0227-server-module-conventions.md"><code>"use client"</code></a>，一个RSC约定:</p>
<pre class="language-javascript hljs">// Component.js
"use client";

export function MyInteractiveComponent() {
  const [myState, setState] = useState(null);
  useEffect(() =&gt; { setTimeout(() =&gt; setState(‘interactive’) }, 3000)

  return &lt;div&gt;{myState}&lt;/div&gt;
}
</pre>
<p>使用<code>"use client"</code>指令，组件将成为一个特殊的引用对象。不能在该文件中直接访问该对象，但是可以将它传递给React，就像它是一个普通组件一样。然后，React将知道将引用对象发送到客户机，客户机将在服务器上呈现为客户机组件。</p>
<p>你可以在<a href="https://github.com/gatsbyjs/gatsby-partial-hydration-starter">部分水合启动器</a> GitHub库中看到实现部分水合的完整例子。如果您导航到<code><a href="https://github.com/gatsbyjs/gatsby-partial-hydration-starter/blob/main/src/components/demo.js">src/components/demo.js</a></code>文件，如下所示，您可以看到一个客户端部分水合的快速示例:</p>
<pre class="language-javascript hljs">/**
 * To mark a component as client side, you add the "use client" directive.
 * @see {@link https://github.com/reactjs/rfcs/blob/serverconventions-rfc2/text/0000-server-module-conventions.md}
 */
"use client"

import React, { useCallback, useState } from "react"

export function Demo() {
  const [counter, setCounter] = useState(0)
  const onClick = useCallback(() =&gt; {
    setCounter(counter =&gt; counter + 1)
  }, [])
  return (
    &lt;div style={{ marginTop: "10px", marginBottom: "10px" }}&gt;
      &lt;p style={{ margin: 0 }}&gt;Current counter: {counter}&lt;/p&gt;
      &lt;button onClick={onClick}&gt;Add counter&lt;/button&gt;
    &lt;/div&gt;
  )
}
</pre>
<p>在上面的代码块中，我们有一个带有按钮的简单组件，它将使用<code>useState</code>增加计数器。这个组件是交互式的，因为它使用了<code>useState</code>。该组件被导入并在<code><a href="https://github.com/gatsbyjs/gatsby-partial-hydration-starter/blob/main/src/pages/using-partial-hydration.js">src/pages/using-partial-hydration.js</a></code>文件中使用，如下图所示:</p>
<pre class="language-javascript hljs">import * as React from "react"
import { Link } from "gatsby"
import Layout from "../components/layout"
import Seo from "../components/seo"
import { Demo } from "../components/demo"

function usingPartialHydration() {
  return (
    &lt;Layout&gt;
      &lt;h1&gt;
        Gatsby supports &lt;b&gt;Partial Hydration&lt;/b&gt;
      &lt;/h1&gt;
      &lt;p&gt;
        You can now mark components as client side. This will reduce Javascript
        shipped to the user.
      &lt;/p&gt;
      &lt;p&gt;
        The component below is such a component, if you check the Network Tab
        after a "gatsby build". You will see that we only load the component
        code and non of the layout
      &lt;/p&gt;
      {/* Usage of the client component */}
      &lt;Demo /&gt;
      &lt;p&gt;
        Checkout &lt;a href="https://gatsby.dev/v5-partial-hydration"&gt;the RFC&lt;/a&gt;{" "}
        to learn more.
      &lt;/p&gt;
      &lt;Link to="/"&gt;Go back to the homepage&lt;/Link&gt;
    &lt;/Layout&gt;
  )
}
export const Head = () =&gt; &lt;Seo title="Using TypeScript" /&gt;

export default usingPartialHydration
</pre>
<p>除了<code>Demo</code>组件之外，这个<code>page</code>组件主要由一个内容填充页面组成。当Gatsby试图构建这个页面时，它将为该页面生成一个RSC文件。它不是在浏览器中获取<code>page</code>组件JavaScript文件，而是请求一个<code>page-data-rsc.json</code>文件。JSON文件是UI的描述，任何客户端组件都作为一个包引用包含在内，以获取组件的实际代码。</p>
<p>目前，部分水合作用只在你为生产而建造时有效，即<code>gatsby build</code>或<code>gatsby serve</code>，而不是<code>gatsby develop</code>。当您运行<code>gatsby build</code>进行生产构建时，您应该在命令的输出中看到以下几行，这表示客户端组件在生产构建期间被部分水合:</p>
<pre class="language-javascript hljs">success Building Partial Hydration renderer - 0.530s
...
success Building partial HTML for pages - 0.040s - 6/6 149.35/s
</pre>
<h2 id="known-issues">部分水合的已知问题</h2>
<p>在撰写本文时，《盖茨比》中的部分水合作用仍处于测试阶段。让我们回顾一下你可能会遇到的一些目前已知的部分水合作用的问题。</p>
<h3 id="styling-libraries">样式库</h3>
<p>当启用部分水合时，像<code>emotion</code>和<code>styled-components</code> <a href="https://github.com/gatsbyjs/gatsby/discussions/36608#discussioncomment-3820128">这样的样式库目前不工作</a>。在撰写本文时，还不支持React服务器组件。</p>
<h3 id="gatsby-plugin-offline"><code>gatsby-plugin-offline</code></h3>
<p><a href="https://www.gatsbyjs.com/plugins/gatsby-plugin-offline/"> <code>gatsby-plugin-offline</code> </a>是用来让一个盖茨比的网站离线工作，更能抵御恶劣的网络连接。在部分水化的测试阶段，<code>gatsby-plugin-offline</code>不被支持，并且已经有<a href="https://github.com/gatsbyjs/gatsby/discussions/36608#discussioncomment-4027442">的报道称</a>的盖茨比站点建设失败。</p>
<h2 id="conclusion">结论</h2>
<p>为您的Gatsby站点设置部分水合将带来良好的用户体验，并显著提高页面加载速度。向客户端交付更少的JavaScript代码将直接影响您的性能分数，最显著的是交互测量的时间。</p>
<p>重要的是要记住，部分水合作用仍处于测试阶段。因此，在生产中使用它要自担风险，因为将来可能会有一些突破性的变化。</p>
<p>要了解更多关于盖茨比5的部分水合作用，请查看<a href="https://github.com/gatsbyjs/gatsby/discussions/36608"> RFC </a>和<a href="https://www.gatsbyjs.com/docs/conceptual/partial-hydration/">概念指南</a>。我希望你喜欢这个教程，并快乐编码！</p><div class="code-block code-block-17">
<div class="blog-plug inline-plug react-plug" vwo-el-id="26283398190">
<h2 vwo-el-id="41600691720">使用LogRocket消除传统反应错误报告的噪音</h2>
<a href="https://lp.logrocket.com/blg/react-signup-issue-free" target="_blank" vwo-el-id="19356441070">LogRocket
</a><p>是一款React analytics解决方案，可保护您免受数百个误报错误警报的影响，只针对少数真正重要的项目。LogRocket告诉您React应用程序中实际影响用户的最具影响力的bug和UX问题。</p><a class="signup" href="https://lp.logrocket.com/blg/react-signup-general" target="_blank" rel="noopener noreferrer" vwo-el-id="19356441380">
<img class="first-react-image alignnone size-full wp-image-46 jetpack-lazy-image jetpack-lazy-image--handled" src="../Images/f300c244a1a1cf916df8b4cb02bec6c6.png" vwo-el-id="18272717540" data-lazy-loaded="1" data-original-src="https://files.readme.io/27c94e7-Image_2017-06-05_at_9.46.04_PM.png"/>
</a>
<a class="signup" href="https://lp.logrocket.com/blg/react-signup-general" target="_blank" rel="noopener noreferrer" vwo-el-id="19356441690">
<img class="second-react-image alignnone size-full wp-image-46 jetpack-lazy-image jetpack-lazy-image--handled" src="../Images/d6f5a5dd739296c1dd7aab3d5e77eeb9.png" alt="LogRocket Dashboard Free Trial Banner" vwo-el-id="30720362350" data-lazy-loaded="1" data-original-src="https://blog.logrocket.com/wp-content/uploads/2017/03/1d0cd-1s_rmyo6nbrasp-xtvbaxfg.png"/>
</a>
<a href="https://lp.logrocket.com/blg/react-signup-issue-free" target="_blank" rel="noopener noreferrer" vwo-el-id="35866400580">LogRocket
</a><p>自动聚合客户端错误、反应错误边界、还原状态、缓慢的组件加载时间、JS异常、前端性能指标和用户交互。然后，LogRocket使用机器学习来通知您影响大多数用户的最具影响力的问题，并提供您修复它所需的上下文。</p><p vwo-el-id="28675661060">关注重要的React bug—<a class="signup" href="https://lp.logrocket.com/blg/react-signup-issue-free" target="_blank" rel="noopener noreferrer" vwo-el-id="40093418840">今天就试试LogRocket】。</a></p>
</div></div>

<p class="clearfix"/>
<p class="clearfix"/>
</article>
 
</div>    
</body>
</html>