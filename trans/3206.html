<html>
<head>
<title>Web3 data querying with The Graph and subgraphs - LogRocket Blog</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>用图和子图进行Web3数据查询</h1>
<blockquote>原文：<a href="https://blog.logrocket.com/web3-data-querying-the-graph-subgraphs/#0001-01-01">https://blog.logrocket.com/web3-data-querying-the-graph-subgraphs/#0001-01-01</a></blockquote><div><article class="article-post">
<p>图表是组织区块链数据的索引协议。它使用一个<a href="https://blog.logrocket.com/tag/graphql/"> GraphQL </a> API来提供比发送RPC调用的传统方法更容易的对链上信息的访问。</p>
<p>网络用子图组织数据；由社区创建的开源API，用于从索引器、管理器和代理器中检索数据。</p>
<p>在本文中，我们将了解如何使用图和子图进行Web3数据查询。</p>

<h2 id="indexers-operate-the-network-nodes">索引器操作网络节点</h2>
<p>索引器操作网络的节点，这些节点索引数据并为查询服务。</p>
<p>由于图网络使用一种利益证明算法，索引器利用图令牌(GRT)来提供索引和查询处理服务。反过来，索引员可以赚取查询费和索引奖励。</p>
<p>他们基于子图的策化信号选择要索引的子图。使用索引器数据的应用程序可以设置他们希望哪些索引器处理他们的查询的参数，以及他们对查询费用定价的偏好。</p>
<h3 id="curators-signal-high-quality-subgraphs">策展人展示高质量的子图</h3>
<p><a href="https://thegraph.com/docs/en/curating/" target="_blank" rel="noopener">管理员</a>通过发信号通知应该由图网络索引的子图来组织来自子图的数据。</p>
<p>他们使用图策展共享(GCS)来实现这一点，这允许他们在子图上进行等价投资。</p>
<p>策展人持有GRT股份，这使他们能够铸造GC。每个子图都有一条结合曲线，它决定了GRT的价格和可以铸造的股票数量之间的关系。</p>
<p>根据图表的文档，策展被认为是有风险的，只应在彻底研究和调查所涉及的权衡之后进行。</p>
<h3 id="delegators-secure-the-network-bt-staking">授权者通过饥饿来保护网络</h3>
<p><a href="https://thegraph.com/docs/en/delegating/" target="_blank" rel="noopener">委托人</a>将GRT委托给一个或多个索引器，以帮助保护网络，而无需自己运行节点。</p>
<p>委托人赚取部分索引器的查询费和奖励，这取决于索引器和委托人的股份，以及索引器对每个查询收取的价格。</p>
<p>向索引器分配更多的股份允许处理更多的潜在查询。Graph的文档声称，作为委托人比作为馆长风险更小，因为他们不会受到GRT价格波动的影响，因为GCS的股票正在燃烧。</p>
<h2 id="the-graph-foundation">图表基金会</h2>
<p>该图由Graph Foundation开发和维护。为了确保网络和更大的社区继续改善，基金会向从事协议基础设施、工具、dApps、子图和社区建设的社区成员分发赠款(称为图赠款)。</p>
<h3 id="three-different-graph-services">三种不同的图形服务</h3>
<p>如果您没有托管自己的子图，有三种不同的方式与图形交互:</p>
<ul>
<li><strong>图形浏览器</strong>:浏览不同的子图，并与图形协议交互</li>
<li><strong>子图工作室</strong>:使用以太坊Mainnet创建、管理和发布子图和API键</li>
<li>托管服务(Hosted Service):使用以太坊之外的其他网络，如Avalanche、Harmony、Fantom和Celo，创建、管理和发布子图和API密钥</li>
</ul>
<p>托管服务不需要加密钱包，可以使用GitHub帐户。图形浏览器和子图工作室都将要求你连接一个钱包，如MetaMask或比特币基地。</p>
<h2 id="create-project-on-hosted-service">在托管服务上创建项目</h2>
<p>在托管服务上创建帐户后，单击导航栏上的“我的仪表板”查看您的仪表板。</p>
<p><img data-attachment-id="126031" data-permalink="https://blog.logrocket.com/web3-data-querying-the-graph-subgraphs/attachment/hosted-service-my-dashboard/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/07/hosted-service-my-dashboard.png" data-orig-size="730,427" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="hosted-service-my-dashboard" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/07/hosted-service-my-dashboard-300x175.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/07/hosted-service-my-dashboard.png" decoding="async" class="aligncenter wp-image-126031 size-full jetpack-lazy-image" src="../Images/a930ef145bc548f580bdc96ee5589406.png" alt="Hosted Service My Dashboard" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2022/07/hosted-service-my-dashboard.png 730w, https://blog.logrocket.com/wp-content/uploads/2022/07/hosted-service-my-dashboard-300x175.png 300w" data-lazy-sizes="(max-width: 730px) 100vw, 730px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2022/07/hosted-service-my-dashboard.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/07/hosted-service-my-dashboard.png"/></p><noscript><img data-lazy-fallback="1" data-attachment-id="126031" data-permalink="https://blog.logrocket.com/web3-data-querying-the-graph-subgraphs/attachment/hosted-service-my-dashboard/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/07/hosted-service-my-dashboard.png" data-orig-size="730,427" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="hosted-service-my-dashboard" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/07/hosted-service-my-dashboard-300x175.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/07/hosted-service-my-dashboard.png" decoding="async" loading="lazy" class="aligncenter wp-image-126031 size-full" src="../Images/a930ef145bc548f580bdc96ee5589406.png" alt="Hosted Service My Dashboard" srcset="https://blog.logrocket.com/wp-content/uploads/2022/07/hosted-service-my-dashboard.png 730w, https://blog.logrocket.com/wp-content/uploads/2022/07/hosted-service-my-dashboard-300x175.png 300w" sizes="(max-width: 730px) 100vw, 730px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/07/hosted-service-my-dashboard.png"/></noscript>
<p>单击“添加子图”创建子图。</p>
<p><img data-attachment-id="126033" data-permalink="https://blog.logrocket.com/web3-data-querying-the-graph-subgraphs/attachment/hosted-service-create-a-subgraph/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/07/hosted-service-create-a-subgraph.png" data-orig-size="730,429" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="hosted-service-create-a-subgraph" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/07/hosted-service-create-a-subgraph-300x176.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/07/hosted-service-create-a-subgraph.png" decoding="async" class="aligncenter wp-image-126033 size-full jetpack-lazy-image" src="../Images/01c9a2b2f933a5b02721eeb82ca05196.png" alt="Hosted Service Create A Subgraph" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2022/07/hosted-service-create-a-subgraph.png 730w, https://blog.logrocket.com/wp-content/uploads/2022/07/hosted-service-create-a-subgraph-300x176.png 300w" data-lazy-sizes="(max-width: 730px) 100vw, 730px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2022/07/hosted-service-create-a-subgraph.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/07/hosted-service-create-a-subgraph.png"/></p><noscript><img data-lazy-fallback="1" data-attachment-id="126033" data-permalink="https://blog.logrocket.com/web3-data-querying-the-graph-subgraphs/attachment/hosted-service-create-a-subgraph/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/07/hosted-service-create-a-subgraph.png" data-orig-size="730,429" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="hosted-service-create-a-subgraph" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/07/hosted-service-create-a-subgraph-300x176.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/07/hosted-service-create-a-subgraph.png" decoding="async" loading="lazy" class="aligncenter wp-image-126033 size-full" src="../Images/01c9a2b2f933a5b02721eeb82ca05196.png" alt="Hosted Service Create A Subgraph" srcset="https://blog.logrocket.com/wp-content/uploads/2022/07/hosted-service-create-a-subgraph.png 730w, https://blog.logrocket.com/wp-content/uploads/2022/07/hosted-service-create-a-subgraph-300x176.png 300w" sizes="(max-width: 730px) 100vw, 730px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/07/hosted-service-create-a-subgraph.png"/></noscript>
<p>为子图添加名称和副标题。填写完子图信息后，向下滚动到页面底部，点击“创建子图”。</p>
<p><img data-attachment-id="126035" data-permalink="https://blog.logrocket.com/web3-data-querying-the-graph-subgraphs/attachment/hosted-service-name-install-deploy/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/07/hosted-service-name-install-deploy.png" data-orig-size="730,378" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="hosted-service-name-install-deploy" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/07/hosted-service-name-install-deploy-300x155.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/07/hosted-service-name-install-deploy.png" decoding="async" class="wp-image-126035 size-full aligncenter jetpack-lazy-image" src="../Images/3abbd3a9cd2a3d93faf7683a9f51f73a.png" alt="Hosted Service Name Install Deploy" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2022/07/hosted-service-name-install-deploy.png 730w, https://blog.logrocket.com/wp-content/uploads/2022/07/hosted-service-name-install-deploy-300x155.png 300w" data-lazy-sizes="(max-width: 730px) 100vw, 730px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2022/07/hosted-service-name-install-deploy.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/07/hosted-service-name-install-deploy.png"/></p><noscript><img data-lazy-fallback="1" data-attachment-id="126035" data-permalink="https://blog.logrocket.com/web3-data-querying-the-graph-subgraphs/attachment/hosted-service-name-install-deploy/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/07/hosted-service-name-install-deploy.png" data-orig-size="730,378" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="hosted-service-name-install-deploy" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/07/hosted-service-name-install-deploy-300x155.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/07/hosted-service-name-install-deploy.png" decoding="async" loading="lazy" class="wp-image-126035 size-full aligncenter" src="../Images/3abbd3a9cd2a3d93faf7683a9f51f73a.png" alt="Hosted Service Name Install Deploy" srcset="https://blog.logrocket.com/wp-content/uploads/2022/07/hosted-service-name-install-deploy.png 730w, https://blog.logrocket.com/wp-content/uploads/2022/07/hosted-service-name-install-deploy-300x155.png 300w" sizes="(max-width: 730px) 100vw, 730px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/07/hosted-service-name-install-deploy.png"/></noscript>
<p>通过在托管服务上设置子图，我们可以创建项目文件。创建一个新目录，初始化一个<code>package.json</code>，并安装依赖项。</p>
<pre class="language-dart hljs">mkdir graphrocket
cd graphrocket
yarn init -y
yarn add -D @graphprotocol/graph-cli @graphprotocol/graph-ts
</pre>
<p>在托管服务上复制项目仪表板上可用的访问令牌。在<code>yarn graph auth --product hosted-service</code>命令后粘贴令牌。</p>
<pre class="language-yarn hljs">yarn graph auth --product hosted-service YOURTOKEN
</pre>
<p>为TypeScript和Git创建配置文件。</p><div class="code-block code-block-54">
<hr/>
<h3>更多来自LogRocket的精彩文章:</h3>

<hr/></div>
<pre class="language-ts hljs">echo '{"extends": "@graphprotocol/graph-ts/types/tsconfig.base.json"}' &gt; tsconfig.json
echo '.DS_Store\nnode_modules' &gt; .gitignore
</pre>
<p>以太坊区块链上的智能合约公开了一个应用程序二进制接口(或ABI ),作为客户端应用程序和以太坊区块链之间的接口。我们的子图需要这个。</p>
<p>用cURL下载合同的ABI，并保存到一个名为<code>Token.json</code>的文件中。</p>
<pre class="language-js hljs">curl "http://api.etherscan.io/api?module=contract&amp;action=getabi&amp;address=0xe7c29cba93ef8017c7824dd0f25923c38d08065c&amp;format=raw" &gt; Token.json
</pre>
<p>创建三个项目文件，包括:</p>
<ul>
<li><code>token.ts</code>用于将以太坊事件数据翻译成方案中定义的实体的汇编脚本代码</li>
<li><code>subgraph.yaml</code>对于子图清单的YAML配置</li>
<li><code>schema.graphql</code>用于定义为子图存储的数据以及如何通过GraphQL查询它的GraphQL模式</li>
</ul>
<pre class="language-js hljs">echo &gt; token.ts
echo &gt; schema.graphql
echo &gt; subgraph.yaml
</pre>
<h3 id="define-token-and-use-entities">定义<code>Token</code>和<code>User</code>实体</h3>
<p>在<code>schema.graphql</code>中，我们定义了两种类型，<code>Token</code>和<code>User</code>。</p>
<pre class="language-js hljs"># schema.graphql

type Token @entity {}
type User @entity {}
</pre>
<p><code>Token</code>有一个<code>name</code>和其他信息，比如创建时间、内容URI和IPFS文件路径。它还包括关于<code>creator</code>和<code>owner</code>的信息。</p>
<pre class="language-js hljs"># schema.graphql

type Token @entity {
  id: ID!
  tokenID: BigInt!
  contentURI: String
  tokenIPFSPath: String
  name: String!
  createdAtTimestamp: BigInt!
  creator: User!
  owner: User!
}
</pre>
<p><code>creator</code>和<code>owner</code>是<code>User</code>类型。他们有一个<code>id</code>，他们拥有一个<code>tokens</code>数组，他们拥有一个<code>tokens</code>数组<code>created</code>。</p>
<pre class="language-js hljs"># schema.graphql

type User @entity {
  id: ID!
  tokens: [Token!]! @derivedFrom(field: "owner")
  created: [Token!]! @derivedFrom(field: "creator")
}
</pre>
<p><code>@derivedFrom</code>启用反向查找，这意味着我们不存储关系的两端，以提高索引和查询性能。对于一对多关系，关系应该存储在“一”方，而“多”方则从“一”方派生而来。</p>
<h3 id="create-subgraph">创建子图</h3>
<p><code>subgraph.yaml</code>文件将包含我们的子图的定义。从使用的规范版本和<code>schema.graphql</code>中实体类型的文件路径开始。</p>
<pre class="language-yaml hljs"># subgraph.yaml

specVersion: 0.0.4
schema:
  file: ./schema.graphql
</pre>
<p>接下来是包含我们的数据源的网络。<code>dataSources.source</code>需要智能合同的地址和ABI。</p>
<pre class="language-yaml hljs"># subgraph.yaml

dataSources:
  - kind: ethereum
    name: Token
    network: mainnet
    source:
      address: "0x3B3ee1931Dc30C1957379FAc9aba94D1C48a5405"
      abi: Token
      startBlock: 11648721
</pre>
<p><code>dataSources.mapping.entities</code>定义数据源写入存储的实体，由<code>schema.graphql</code>中的模式指定。</p>
<pre class="language-yaml hljs"># subgraph.yaml

mapping:
  kind: ethereum/events
  apiVersion: 0.0.5
  language: wasm/assemblyscript
  entities:
    - Token
    - User
</pre>
<p><code>dataSources.mapping.abis</code>取源合同ABI的<code>name</code>和<code>file</code>地点。</p>
<pre class="language-yaml hljs"># subgraph.yaml

abis:
  - name: Token
    file: ./Token.json
</pre>
<p><code>dataSources.mapping.eventHandlers</code>列出子图对其做出反应的智能合约事件，以及映射中的处理程序，这些处理程序将这些事件转换为存储中的实体。</p>
<pre class="language-yaml hljs"># subgraph.yaml

eventHandlers:
  - event: TokenIPFSPathUpdated(indexed uint256,indexed string,string)
    handler: handleTokenIPFSPathUpdated
  - event: Transfer(indexed address,indexed address,indexed uint256)
    handler: handleTransfer
file: ./token.ts
</pre>
<p>完成<code>subgraph.yaml</code>文件:</p>
<pre class="language-yaml hljs"># subgraph.yaml

specVersion: 0.0.4
schema:
  file: ./schema.graphql
dataSources:
  - kind: ethereum
    name: Token
    network: mainnet
    source:
      address: "0x3B3ee1931Dc30C1957379FAc9aba94D1C48a5405"
      abi: Token
      startBlock: 11648721
    mapping:
      kind: ethereum/events
      apiVersion: 0.0.5
      language: wasm/assemblyscript
      entities:
        - Token
        - User
      abis:
        - name: Token
          file: ./Token.json
      eventHandlers:
        - event: TokenIPFSPathUpdated(indexed uint256,indexed string,string)
          handler: handleTokenIPFSPathUpdated
        - event: Transfer(indexed address,indexed address,indexed uint256)
          handler: handleTransfer
      file: ./token.ts
</pre>
<h3 id="generate-types">生成类型</h3>
<p>为ABI和子图架构生成AssemblyScript类型。</p>
<pre class="language-yarn hljs">yarn graph codegen
</pre>
<h3 id="write-mappings">写入映射</h3>
<p>导入生成的类型和生成的模式，创建两个函数:<code>handleTransfer</code>和<code>handleTokenURIUpdated</code>。</p>
<p>当创建、传输或更新新令牌时，会触发一个事件，映射会将数据保存到子图中。</p>
<pre class="language-ts hljs">// token.ts

import {
  TokenIPFSPathUpdated as TokenIPFSPathUpdatedEvent,
  Transfer as TransferEvent,
  Token as TokenContract,
} from "./generated/Token/Token"
import {
  Token, User
} from './generated/schema'

export function handleTransfer(event: TransferEvent): void {}

export function handleTokenURIUpdated(event: TokenIPFSPathUpdatedEvent): void {}
</pre>
<p><code>handleTransfer</code>加载<code>tokenId</code>并设置<code>owner</code>。</p>
<pre class="language-ts hljs">// token.ts

export function handleTransfer(event: TransferEvent): void {
  let token = Token.load(event.params.tokenId.toString())
  if (!token) {
    token = new Token(event.params.tokenId.toString())
    token.creator = event.params.to.toHexString()
    token.tokenID = event.params.tokenId

    let tokenContract = TokenContract.bind(event.address)
    token.contentURI = tokenContract.tokenURI(event.params.tokenId)
    token.tokenIPFSPath = tokenContract.getTokenIPFSPath(event.params.tokenId)
    token.name = tokenContract.name()
    token.createdAtTimestamp = event.block.timestamp
  }
  token.owner = event.params.to.toHexString()
  token.save()

  let user = User.load(event.params.to.toHexString())
  if (!user) {
    user = new User(event.params.to.toHexString())
    user.save()
  }
}
</pre>
<p><code>handleTokenURIUpdated</code>随时更新<code>tokenIPFSPath</code>的变化。</p>
<pre class="language-ts hljs">// token.ts

export function handleTokenURIUpdated(event: TokenIPFSPathUpdatedEvent): void {
  let token = Token.load(event.params.tokenId.toString())
  if (!token) return
  token.tokenIPFSPath = event.params.tokenIPFSPath
  token.save()
}
</pre>
<h2 id="deploy-subgraph">部署子图</h2>
<p>构建要部署的项目:</p>
<pre class="language-yarn hljs">yarn graph build
</pre>
<p>包括您自己的GitHub用户名，后跟您的子图名称:</p>
<pre class="language-yarn hljs">yarn graph deploy --product hosted-service USERNAME/logrocketgraph
</pre>
<p>终端将返回一个URL，其中包含子图的浏览器和发送查询的API端点。</p>
<pre class="language-js hljs">Deployed to https://thegraph.com/explorer/subgraph/ajcwebdev/logrocketgraph

Subgraph endpoints:
Queries (HTTP):     https://api.thegraph.com/subgraphs/name/ajcwebdev/logrocketgraph
</pre>
<p>您需要等待您的子图与区块链的当前状态同步。一旦同步完成，运行以下查询以降序显示按<code>id</code>排序的前两个令牌。</p>
<pre>{
  tokens(first: 2, orderBy: id, orderDirection: desc) {
    id
    tokenID
    contentURI
    tokenIPFSPath
  }
}
</pre>
<p>这将输出以下内容:</p>
<pre>{
  "data": {
    "tokens": [
      {
        "id": "99999",
        "tokenID": "99999",
        "contentURI": "https://ipfs.foundation.app/ipfs/QmdDdmRAw8zgmN9iE23oz14a55oHGWtqBrR1RbFcFq4Abn/metadata.json",
        "tokenIPFSPath": "QmdDdmRAw8zgmN9iE23oz14a55oHGWtqBrR1RbFcFq4Abn/metadata.json"
      },
      {
        "id": "99998",
        "tokenID": "99998",
        "contentURI": "https://ipfs.foundation.app/ipfs/QmZwZ5ChjHNwAS5rFDGkom2GpZvTau6xzr8M7gro5HqQhB/metadata.json",
        "tokenIPFSPath": "QmZwZ5ChjHNwAS5rFDGkom2GpZvTau6xzr8M7gro5HqQhB/metadata.json"
      }
    ]
  }
}
</pre>
<p>以下是对第一个用户及其相关内容的查询:</p>
<pre>{
  users(first: 1, orderBy: id, orderDirection: desc) {
    id
    tokens {
      contentURI
    }
  }
}
</pre>
<p>这将输出以下内容:</p>
<pre>{
  "data": {
    "users": [
      {
        "id": "0xfffff449f1a35eb0facca8d4659d8e15cf2f77ba",
        "tokens": [
          {
            "contentURI": "https://ipfs.foundation.app/ipfs/QmVkXqo2hmC2j18udhZG1KavxaTGrnEX7uuddEbghPKCUW/metadata.json"
          },
          {
            "contentURI": "https://ipfs.foundation.app/ipfs/QmTSEgtJmptBCpEJKubK6xDZFiCMEHgGQjhrUAsJSXwzKZ/metadata.json"
          },
          {
            "contentURI": "https://ipfs.foundation.app/ipfs/QmPzSJGhheyyA7MZMYz7VngnZWN8TinH75PTP7M1HAedti/metadata.json"
          },
          {
            "contentURI": "https://ipfs.foundation.app/ipfs/QmeroC2cWfdN31hLd3JpBQMbbWqnQdUdGx94FGUR4AGBUP/metadata.json"
          },
          {
            "contentURI": "https://ipfs.foundation.app/ipfs/QmQVkhqEsZvsstfDp6QAPXB4TkxFnpeAc9BWu2eQo6QvZD/metadata.json"
          },
          {
            "contentURI": "https://ipfs.foundation.app/ipfs/QmRax3fw4skHp95i2v3BzroMoKQVHqAkwbov8FyPdesk3j/metadata.json"
          },
          {
            "contentURI": "https://ipfs.foundation.app/ipfs/QmViGRnvHFBZ6CWHoxZGJoU9iwnoGwZfqj2vgDN3dgsGv4/metadata.json"
          },
          {
            "contentURI": "https://ipfs.foundation.app/ipfs/QmdRBPxDF1tUzm1Pczyme24vguUjW28cLwM4n9MvtxAWX6/metadata.json"
          }
        ]
      }
    ]
  }
}
</pre>
<p>对最近创建的两个NFT的查询。</p>
<pre>{
  tokens(
    first: 2,
    orderBy: createdAtTimestamp,
    orderDirection: desc
  ) {
    id
    tokenID
    contentURI
    createdAtTimestamp
  }
}
</pre>
<p>这将输出以下内容:</p>
<pre>{
  "data": {
    "tokens": [
      {
        "id": "133012",
        "tokenID": "133012",
        "contentURI": "https://ipfs.foundation.app/ipfs/QmSmk85TjpaegCmHDRWZQqMz18vJtACZdugVx5a1tmfjpv/metadata.json",
        "createdAtTimestamp": "1656792769"
      },
      {
        "id": "133011",
        "tokenID": "133011",
        "contentURI": "https://ipfs.foundation.app/ipfs/QmU6RFcKFDteUTipg5tg4NFkWKApdVbo9oq9UYMtSmcWVe/metadata.json",
        "createdAtTimestamp": "1653825764"
      }
    ]
  }
}
</pre>
<p>您还可以使用HTTP端点，并通过cURL直接发送GraphQL查询。</p>
<pre>curl \
  --header 'content-type: application/json' \
  --url 'https://api.thegraph.com/subgraphs/name/ajcwebdev/logrocketgraph' \
  --data '{"query":"{ tokens(first: 1) { contentURI tokenIPFSPath } }"}'
</pre>
<h2 id="conclusion"><strong>结论</strong></h2>
<p>在本文中，我们看到了如何创建一个GraphQL端点来公开以太坊区块链上包含的某些信息。通过编写包含实体的模式，我们定义了将由子图索引的信息。</p>
<p>在Web3中，区块链网络的数量和多样性继续激增。拥有一种标准化的、被广泛采用的查询语言将使开发人员能够以更高的效率迭代和测试他们的应用程序。</p><div class="code-block code-block-26">
<div class="blog-plug inline-plug blockchain-plug"><h2>加入像Bitso和Coinsquare这样的组织，他们使用LogRocket主动监控他们的Web3应用</h2><p>影响用户在您的应用中激活和交易的能力的客户端问题会极大地影响您的底线。如果您对监控UX问题、自动显示JavaScript错误、跟踪缓慢的网络请求和组件加载时间感兴趣，</p><a target="_blank" href="https://lp.logrocket.com/blg/web3-signup">try LogRocket</a><p>.</p><a class="signup" href="https://lp.logrocket.com/blg/web3-signup" target="_blank" rel="noopener noreferrer"><img class="alignnone size-full wp-image-46 jetpack-lazy-image" src="../Images/dacb06c713aec161ffeaffae5bd048cd.png" alt="LogRocket Dashboard Free Trial Banner" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2019/12/cpu-memory-usage.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2019/12/cpu-memory-usage.png"/><noscript><img data-lazy-fallback="1" class="alignnone size-full wp-image-46" src="../Images/dacb06c713aec161ffeaffae5bd048cd.png" alt="LogRocket Dashboard Free Trial Banner" data-original-src="https://blog.logrocket.com/wp-content/uploads/2019/12/cpu-memory-usage.png"/></noscript></a><a href="https://lp.logrocket.com/blg/web3-signup" target="_blank" rel="noopener noreferrer">https://logrocket.com/signup/</a><p>LogRocket 就像是网络和移动应用的DVR，记录你的网络应用或网站上发生的一切。您可以汇总和报告关键的前端性能指标，重放用户会话和应用程序状态，记录网络请求，并自动显示所有错误，而不是猜测问题发生的原因。</p><p>现代化您调试web和移动应用的方式— <a class="signup" href="https://lp.logrocket.com/blg/web3-signup" target="_blank" rel="noopener noreferrer">开始免费监控</a>。</p></div>
</div>

<p class="clearfix"/>
<p class="clearfix"/>
</article>

</div>    
</body>
</html>