<html>
<head>
<title>Data retrieval in GraphQL with react-apollo - LogRocket Blog</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>用 react-apollo - LogRocket Blog 在 GraphQL 中进行数据检索</h1>
<blockquote>原文：<a href="https://blog.logrocket.com/data-retrieval-in-graphql-with-react-apollo/#0001-01-01">https://blog.logrocket.com/data-retrieval-in-graphql-with-react-apollo/#0001-01-01</a></blockquote><div><article class="article-post">
<p>在本文中，我们将探索如何在 Apollo 客户端中使用 GraphQL 查询语言来高效无缝地从服务器获取数据。阅读结束时，你将学会如何使用和安装 GraphQL 和 Apollo 客户端，以及如何在<code>react-apollo</code>中执行<code>query</code>和<code>mutation</code>操作的两种不同方法。</p>
<h2 id="h2graphql">GraphQL</h2>
<p>GraphQL 是一种查询语言，它使用一个定义好的系统来描述用户应该如何从 API 请求数据。GraphQL 要求用户指定需要传输的确切数据——通常来自服务器——然后这些数据将被加载到客户端。</p>
<p>在我们了解如何使用 Apollo 执行特定的查询操作之前，我们将回顾一些可以在 GraphQL 查询库中执行的基本操作。</p>
<h3 id="h41query">1.询问</h3>
<p>一个<a href="https://blog.logrocket.com/client-side-query-customization-in-graphql/"> GraphQL 查询操作</a>与从服务器端获取基本数据有关。</p>
<pre>  {
    query getItems {
      Items {
        id
        chair
        stool
       }
     }
  }</pre>
<p>上面是一个名为<code>getItems</code>的 GraphQL 查询，它获取了<code>id</code>、<code>chair</code>和<code>stool</code>。</p>
<h3 id="h42mutation">2.变化</h3>
<p>添加<code>mutation</code>关键字在 GraphQL 应用程序中执行基本的<a href="https://blog.logrocket.com/crud-with-node-graphql-react/"> CRUD(创建、读取、更新和删除)操作</a>。</p>
<pre>{
    mutation addUser(name: String!, email: String!){
      addUser(name: $name, email: $email){
        id
        name
        email
        created_at
      }
    }
  }</pre>
<p>当指定了用户名和电子邮件时，上面的<code>addUser</code>变异返回用户的<code>name</code>、<code>id</code>、<code>email</code>和<code>create_at</code>字段。</p>
<h3 id="h43subscription">3.签署</h3>
<p>这是一个基于事件的操作，当执行特定事件时，数据从服务器传输到客户端。要在 GraphQL 中创建订阅，我们需要将订阅类型添加到我们的模式中:</p>
<pre>const typeDefs = gql`
  type Subscription {
    bookAdded: Book
  }`
</pre>
<p>下一步是创建一个<code>resolver</code>。<code>Pubsub</code>在这种情况下从一个突变内部被通知一个事件。</p>
<pre>const BOOK_ADDED = 'BOOK_ADDED';

const resolvers = {
  Subscription: {
    bookAdded: {
      subscribe: () =&gt; pubsub.asyncIterator([BOOK_ADDED]),
    },
  },

  Mutation: {
    addBook(root, args, context) {
      pubsub.publish(BOOK_ADDED, { bookAdded: args });
      return postController.addBook(args);
    },
  },
};
</pre>
<p>订阅由变异内部的一个<code>publish</code>调用触发。</p>
<h2 id="h2apollo">阿波罗</h2>
<p><a href="https://github.com/ApolloAuto/apollo"> Apollo </a>在 GraphQL 应用程序中充当本地和远程数据存储的状态管理库。借助 Apollo 可以执行的一些基本操作包括:获取、本地状态存储和缓存。Apollo 客户端还有一个与 React 的内置集成<a href="https://github.com/apollographql"/>，这使得开发变得更加容易。</p>
<p>Apollo 客户端的一些基本功能包括:</p>
<h3>声明性数据提取</h3>
<p>Apollo client 允许用户从应用程序编程接口指定所需的确切数据。React 使用一个<code>useQuery</code>钩子，使我们能够在 GraphQL 应用程序中执行数据检索和数据获取操作。下面是官方文档中的一个示例:</p>
<pre>function Feed() {
    const { loading, error, data } = useQuery(GET_DOGS);
    if (error) return &lt;Error /&gt;;
    if (loading || !data) return &lt;Fetching /&gt;;

    return &lt;DogList dogs={data.dogs} /&gt;;
  }
</pre>
<p>在<code>useQuery</code>钩子的帮助下，我们能够从 GraphQL 服务器获取数据，这将导致 UI 更新以反映任何更改。</p>
<h3>贮藏</h3>
<p>除了可以使用 GraphQL 执行的主要获取操作之外，智能数据缓存操作也可以在几乎不需要配置的情况下执行。</p>
<p>下面是用于数据缓存的 Apollo 客户端配置:</p>
<pre> import { ApolloClient, InMemoryCache } from '@apollo/client';

const client = new ApolloClient({
  cache: new InMemoryCache()
});
</pre>
<p>阿波罗客户端的其他优势包括:</p>
<ol>
<li>支持现代<a href="https://blog.logrocket.com/react-reference-guide-hooks-api/">反应钩子</a></li>
<li>和睦相处</li>
<li>强大的社区支持</li>
<li>页码</li>
</ol>
<h2 id="h2installationanduseofgraphqlandapolloclient">GraphQL 和 Apollo 客户端的安装和使用</h2>
<p>如果您尚未设置 React 应用程序，请运行以下命令:</p>
<pre><code>npx create-react-app
</code></pre>
<p>要在 React 应用程序中使用 GraphQL 和 Apollo，您需要安装以下依赖项:</p>
<pre><code>npm install apollo-boost graphql react-apollo
</code></pre>
<p>您的带有 GraphQL 的 React 应用程序现在已经设置好，可以使用了！</p>
<p>要创建连接，首先创建一个<code>index.js</code>文件并添加以下代码片段:</p>
<pre><code>import ApolloClient from "apollo-boost";
import { ApolloProvider } from 'react-apollo';

const client = new ApolloClient({
    uri: //graghql server url should be here
  });
</code></pre>
<p>接下来，用 ApolloProvider 包装您的应用程序组件，将客户端作为道具传递:</p>
<pre><code>ReactDOM.render(
    &lt;ApolloProvider client={client}&gt;
      &lt;App /&gt;
    &lt;/ApolloProvider&gt;,
    document.getElementById("root")
  );
</code></pre>
<p>在开始，我们讨论了可以用 GraphQL 执行的基本操作，包括<code>query</code>和<code>mutation</code>。现在让我们来看看如何使用<code>useQuery</code>钩子方法和渲染道具方法在阿波罗上执行这些操作。</p>
<h3 id="h3queries">问题</h3>
<p>GraphQL 查询涉及数据的读取和提取。在使用 React Apollo 执行该操作时，我们可以采用两种方法:挂钩方法和渲染道具方法。</p>
<h4 id="h4usequeryhookapproach"><code>useQuery</code>挂钩方法</h4>
<p>首先，让我们创建一个 GraphQL 查询，并将其命名为<code>getItems</code>，如下所示:</p>
<pre>import React from "react";
import { useQuery } from "react-apollo";
import { gql } from "apollo-boost";

const GET_ITEMS = gql`
  query GetItems {
    items {
      id
          oneitem
    }
  }
`;
</pre>
<p>接下来，创建一个功能组件并将 GraphQL 查询传递给<code>useQuery</code>钩子，如下所示:</p>
<pre>function DisplayItems() {
  const { loading, error, data } = useQuery(GET_ITEMS);

  if (loading) return 'Loading...';
  if (error) return `Error! ${error.message}`;

  return (
    &lt;select name="items"&gt;
      {data.items.map(item =&gt; (
        &lt;option key={item.id} value={item.oneitem}&gt;
          {item.oneitem}
        &lt;/option&gt;
      ))}
    &lt;/select&gt;
  );
}
</pre>
<p>当获取新数据或发生错误时，应用程序将更新以反映新的更改。</p>
<h4><strong>渲染道具进场</strong></h4>
<p>对于渲染道具方法，第一步保持不变，除了从我们之前安装的<code>react-apollo</code>中额外导入查询:</p>
<pre>import React from "react";
import { Query } from "react-apollo";
import { gql } from "apollo-boost";

const GET_ITEMS = gql`
  query GetItems {
    items {
      id
          oneitem
    }
  }
`;
</pre>
<p>接下来，我们将通过将创建的 GraphQL 查询传递给<code>query</code>来使用它，如下所示:</p>
<pre>function DisplayItems() {

  if (loading) return 'Loading...';
  if (error) return `Error! ${error.message}`;

  return (
    &lt;Query query={GET_ITEMS}&gt;
    &lt;select name="items"&gt;
      {data.items.map(item =&gt; (
        &lt;option key={item.id} value={item.oneitem}&gt;
          {item.oneitem}
        &lt;/option&gt;
      ))}
    &lt;/select&gt;
    &lt;/Query&gt;
  );
}
</pre>
<p>就像钩子方法一样，应用程序要么更新以反映新数据，要么返回一个错误。</p>
<h3 id="h3mutation">变化</h3>
<p>变异包括执行创建、更新和删除操作。与查询一样，在处理变异时，我们可以利用 hooks 方法和 render props 方法。</p>
<h4>钩子接近</h4>
<p>首先让我们导入依赖项，包括从<code>react-apollo</code>导入的<code>useMutation</code>。</p>
<pre>import React, { useState } from 'react';
import { useMutation } from 'react-apollo';
import { gql } from 'apollo-boost';

const ADD_TODO = gql`
  mutation AddTodo($type: String!) {
    addTodo(type: $type) {
      id
      type
    }
  }
`;
</pre>
<p>下一步是创建一个名为<code>AddToDo</code>的功能组件，并将我们的<code>ADD_TODO</code>变异传递给<code>useMutation</code>钩子:</p>
<pre>function AddTodo() {
  let input;
  const [addTodo, { data }] = useMutation(ADD_TODO);

  return (
    &lt;div&gt;
      &lt;form
        onSubmit={e =&gt; {
          e.preventDefault();
          addTodo({ variables: { type: input.value } });
          input.value = '';
        }}
      &gt;
        &lt;input
          ref={node =&gt; {
            input = node;
          }}
        /&gt;
        &lt;button type="submit"&gt;Add Todo&lt;/button&gt;
      &lt;/form&gt;
    &lt;/div&gt;
  );
}
</pre>
<h4>渲染道具方法</h4>
<p>与 hooks 方法类似，我们需要从<code>react-apollo</code>导入一个新的<code>mutation</code>来导入必要的依赖项:</p>
<pre>import React, { useState } from 'react';
import { useMutation } from 'react-apollo';
import { gql } from 'apollo-boost';

const ADD_TODO = gql`
  mutation AddTodo($type: String!) {
    addTodo(type: $type) {
      id
      type
    }
  }
`;
</pre>
<p>要完成，请按如下方式传递创建的变异:</p>
<pre>function AddTodo() {
  let input;

  return (
    &lt;Mutation mutation={ADD_TODO}&gt;
    &lt;div&gt;
      &lt;form
        onSubmit={e =&gt; {
          e.preventDefault();
          addTodo({ variables: { type: input.value } });
          input.value = '';
        }}
      &gt;
        &lt;input
          ref={node =&gt; {
            input = node;
          }}
        /&gt;
        &lt;button type="submit"&gt;Add Todo&lt;/button&gt;
      &lt;/form&gt;
    &lt;/div&gt;
    &lt;/Mutation&gt;
  );
}
</pre>
<h2 id="h2conclusion">结论</h2>
<p>在处理数据提取时，GraphQL 是一个很好的选择，因为它解决了 RESTful APIs 带来的过度提取和提取不足的问题。Apollo Client 使 GraphQL 与服务器的连接变得简单、无缝和高效。</p><div class="code-block code-block-17">
<div class="blog-plug inline-plug react-plug" vwo-el-id="26283398190">
<h2 vwo-el-id="41600691720"><a href="https://lp.logrocket.com/blg/react-signup-general" target="_blank" rel="noopener"> LogRocket </a>:全面了解您的生产 React 应用</h2><p>调试 React 应用程序可能很困难，尤其是当用户遇到难以重现的问题时。如果您对监视和跟踪 Redux 状态、自动显示 JavaScript 错误以及跟踪缓慢的网络请求和组件加载时间感兴趣，</p><a href="https://lp.logrocket.com/blg/react-signup-general" target="_blank" vwo-el-id="19356441070">try LogRocket</a><p>. </p><a class="signup" href="https://lp.logrocket.com/blg/react-signup-general" target="_blank" rel="noopener noreferrer" vwo-el-id="19356441380">
<img class="first-react-image alignnone size-full wp-image-46 jetpack-lazy-image jetpack-lazy-image--handled" src="../Images/f300c244a1a1cf916df8b4cb02bec6c6.png" vwo-el-id="18272717540" data-lazy-loaded="1" data-original-src="https://files.readme.io/27c94e7-Image_2017-06-05_at_9.46.04_PM.png"/>
</a>
<a class="signup" href="https://lp.logrocket.com/blg/react-signup-general" target="_blank" rel="noopener noreferrer" vwo-el-id="19356441690">
<img class="second-react-image alignnone size-full wp-image-46 jetpack-lazy-image jetpack-lazy-image--handled" src="../Images/d6f5a5dd739296c1dd7aab3d5e77eeb9.png" alt="LogRocket Dashboard Free Trial Banner" vwo-el-id="30720362350" data-lazy-loaded="1" data-original-src="https://blog.logrocket.com/wp-content/uploads/2017/03/1d0cd-1s_rmyo6nbrasp-xtvbaxfg.png"/>
</a>
<p vwo-el-id="28675660440" class="">LogRocket 结合了会话回放、产品分析和错误跟踪，使软件团队能够创建理想的 web 和移动产品体验。这对你来说意味着什么？</p>
<p>LogRocket 不是猜测错误发生的原因，也不是要求用户提供截图和日志转储，而是让您回放问题，就像它们发生在您自己的浏览器中一样，以快速了解哪里出错了。</p>
<p>不再有嘈杂的警报。智能错误跟踪允许您对问题进行分类，然后从中学习。获得有影响的用户问题的通知，而不是误报。警报越少，有用的信号越多。</p>
<p vwo-el-id="28675660750">LogRocket Redux 中间件包为您的用户会话增加了一层额外的可见性。LogRocket 记录 Redux 存储中的所有操作和状态。</p>
<p vwo-el-id="28675661060">现代化您调试 React 应用的方式— <a class="signup" href="https://lp.logrocket.com/blg/react-signup-general" target="_blank" rel="noopener noreferrer" vwo-el-id="40093418840">开始免费监控</a>。</p>
</div></div>

<p class="clearfix"/>
<p class="clearfix"/>
</article>

</div>    
</body>
</html>