<html>
<head>
<title>Using AppState in React Native to improve performance - LogRocket Blog</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>在 React Native 中使用 AppState 提高性能</h1>
<blockquote>原文：<a href="https://blog.logrocket.com/using-appstate-react-native-improve-performance/#0001-01-01">https://blog.logrocket.com/using-appstate-react-native-improve-performance/#0001-01-01</a></blockquote><div><article class="article-post">
<p>出于各种原因，了解应用程序的当前状态是至关重要的，最明显的是内存管理。持续更新应用程序的状态会消耗大量的能量，有时最好在用户没有与应用程序交互时暂停更新。</p>
<p>这就是 React 本机 AppState API 的用武之地。AppState 会告诉您应用程序何时处于非活动状态或处于后台，以便您可以停止不必要的进程，节省内存，并提高 React 本机应用程序的性能。</p>
<p>在本教程中，我们将向您介绍 AppState，并通过一个简单的例子演示它是如何工作的。</p>
<h2>React Native 中的 AppState 是什么？</h2>
<p>在 React Native 中，<a href="https://reactnative.dev/docs/appstate" target="_blank" rel="noopener"> AppState </a>表示应用的当前状态——即应用是在前台还是后台。</p>
<p>AppState 对于收集应用程序使用情况的数据非常有用，例如，在将应用程序置于后台或关闭应用程序之前，用户在应用程序上花费的时间。分析这些数据有助于您了解用户与您的应用程序交互的方式，以便您可以在必要时做出更改来提高参与度。</p>
<p>有无数的 SDK 旨在帮助您生成这种类型的洞察力，但是 AppState 使您能够自己监控状态变化，而不依赖于任何第三方工具。</p>
<h2>AppState 是做什么用的？</h2>
<p>如上所述，AppState 最常用于内存管理和用户状态管理。让我们更深入地研究一下，看看它是如何在这些重要任务中发挥作用的。</p>
<h3>内存管理</h3>
<p>当用户没有与应用程序交互时，AppState 可以帮助您避免不必要的状态更改。</p>
<p>创建一个根据应用程序状态变化的<code>isMounted</code>属性是一个很好的实践。如果我们考虑类组件，一旦<code>componentDidMount</code>被触发，则<code>isMounted</code>被设置为<code>true</code>，而当<code>componentWillUnmount</code>被触发时，则<code>false</code>。</p>
<p>你可以在所有组件中使用<code>this</code>的<code>isMounted</code>属性，只在组件被挂载时调用<code>this.setState</code>。</p>
<pre>this.isMounted &amp;&amp; this.setState(...)
</pre>
<p>您可以使用 AppState 的功能来相应地限制状态更新，例如，当应用程序处于后台或不活跃(在 iOS 中)时暂停状态更新，并在用户返回应用程序时继续。</p>
<h3>用户状态管理</h3>
<p>就分析而言，AppState 使您能够更新用户交互的数据库，例如，当用户返回应用程序或将其置于后台时，这些数据会告诉您用户如何与您的应用程序交互。</p>
<p>AppState 还可以帮助你判断用户是在线还是离线，这对于聊天应用来说尤为重要。你可能在 WhatsApp、Telegram 和其他提供聊天功能的应用程序中看到过“在线”和“最后一次出现在…”。</p>
<p>您可以根据应用程序状态的变化轻松更新用户状态，例如，当用户与应用程序交互时，当应用程序当前处于活动状态时，或当应用程序处于前台时，在线；当用户将应用程序置于后台或将其关闭时，离线。</p>
<h2>如何在 React Native 中使用 AppState</h2>
<p>为了查看 AppState 的运行情况，我们将创建一个 React 本地聊天应用程序来显示用户的在线状态。我们将使用 AppState 来指示用户何时在线，何时应用程序打开或处于前台，以及何时应用程序处于后台或关闭。</p>
<p>AppState 是<code>react-native</code>库的一部分，可以使用以下代码轻松导入:</p>
<pre>import {AppState} from 'react-native';
</pre>
<p>现在，您可以在应用程序中使用 AppState 及其侦听器了。</p>
<p>AppState 最基本的用例是使用<code>currentState</code>属性获取应用程序的状态:</p>
<pre>AppState.currentState
</pre>
<p>从上面的属性我们可以得到两种状态:<code>active</code>和<code>background</code>。</p>
<ul>
<li><code>active</code>表示应用程序当前正在运行，并处于前台</li>
<li><code>background</code>表示应用程序正在运行，但目前处于后台，即用户正在运行另一个应用程序或查看其主屏幕</li>
</ul>
<p>Android 和 iOS 上都给出了上述状态，但 iOS 支持一个名为<code>inactive</code>的附加 AppState，当用户在两个应用之间转换、打开通知中心或收到来电时，就会出现这种状态。</p>
<h2>侦听 AppState 中的更改</h2>
<p>AppState 带有状态变化的监听器。Android 和 iOS 都支持<code>change</code>监听器。</p>
<p>要添加新的监听程序，请输入以下内容:</p>
<pre>AppState.addEventListener
</pre>
<p>然后添加<code>change</code>事件监听器，根据更改更新应用程序:</p>
<pre>const appStateListener = AppState.addEventListener(
  'change',
  nextAppState =&gt; {
    console.log('Next AppState is: ', nextAppState);
    setAppState(nextAppState);
  },
);
</pre>
<p>为了提高性能，清理侦听器总是一个好的做法。要清理 AppState 监听器，只需使用<code>remove</code>方法:</p>
<pre>appStateListener.remove()
</pre>
<p>下面是我们示例的完整代码:</p>
<pre>import React, {useEffect, useState} from 'react';
import {View, StyleSheet, Text, AppState} from 'react-native';

const App = () =&gt; {
  const [aState, setAppState] = useState(AppState.currentState);
  useEffect(() =&gt; {
    const appStateListener = AppState.addEventListener(
      'change',
      nextAppState =&gt; {
        console.log('Next AppState is: ', nextAppState);
        setAppState(nextAppState);
      },
    );
    return () =&gt; {
      appStateListener?.remove();
    };
  }, []);
  return (
    &lt;View style={styles.container}&gt;
      &lt;Text style={styles.txt}&gt;
        Current App State is: &lt;Text style={styles.aState}&gt;{aState}&lt;/Text&gt;
      &lt;/Text&gt;
    &lt;/View&gt;
  );
};

const styles = StyleSheet.create({
  container: {
    flex: 1,
    alignItems: 'center',
    justifyContent: 'center',
    backgroundColor: '#000',
  },
  txt: {
    color: '#d9d9d9',
    fontSize: 18,
  },
  aState: {
    color: '#fff',
  },
});
export default App;
</pre>
<p>还有两个特定于 Android 的监听器可供您使用:</p>
<ul>
<li><code>focus</code>当用户与应用程序交互时</li>
<li><code>blur</code>当用户拉下通知中心时</li>
</ul>
<p>下面是最终结果:</p>

<h2>结论</h2>
<p>现在，您已经对 AppState 工具以及如何在 React 本机应用程序中使用它有了基本的了解。您可以使用它来更改应用程序中的用户状态(从在线到离线，反之亦然)，收集应用程序使用情况的分析，以及播放或暂停应用程序中的 AV 内容，具体取决于您正在处理的项目类型。</p>
<p>感谢阅读！</p><div class="code-block code-block-18">
<div class="blog-plug inline-plug react-native-plug"><h2><a href="https://lp.logrocket.com/blg/react-native-signup"> LogRocket </a>:即时重现 React 原生应用中的问题。</h2><a class="signup" href="https://lp.logrocket.com/blg/react-native-signup" target="_blank" rel="noopener noreferrer"><img class="alignnone size-full wp-image-46 jetpack-lazy-image" src="../Images/110055665562c1e02069b3698e6cc671.png" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2021/10/react-native-plug_v2-2.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2021/10/react-native-plug_v2-2.png"/><noscript><img data-lazy-fallback="1" class="alignnone size-full wp-image-46" src="../Images/110055665562c1e02069b3698e6cc671.png" data-original-src="https://blog.logrocket.com/wp-content/uploads/2021/10/react-native-plug_v2-2.png"/></noscript></a><p><a href="https://lp.logrocket.com/blg/react-native-signup" target="_blank" rel="noopener noreferrer"> LogRocket </a>是一款 React 原生监控解决方案，可帮助您即时重现问题、确定 bug 的优先级并了解 React 原生应用的性能。</p><p>LogRocket 还可以向你展示用户是如何与你的应用程序互动的，从而帮助你提高转化率和产品使用率。LogRocket 的产品分析功能揭示了用户不完成特定流程或不采用新功能的原因。</p><p>开始主动监控您的 React 原生应用— <a class="signup" href="https://lp.logrocket.com/blg/react-native-signup" target="_blank" rel="noopener noreferrer">免费试用 LogRocket】。</a></p></div>
</div>

<p class="clearfix"/>
<p class="clearfix"/>
</article>

</div>    
</body>
</html>