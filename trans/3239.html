<html>
<head>
<title>Deploying Next.js with Flask - LogRocket Blog</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>使用Flask - LogRocket博客部署Next.js</h1>
<blockquote>原文：<a href="https://blog.logrocket.com/deploying-next-js-flask/#0001-01-01">https://blog.logrocket.com/deploying-next-js-flask/#0001-01-01</a></blockquote><div><article class="article-post">
<p>Flask和Next.js是两个独特的开源web框架，分别构建在Python和JavaScript编程语言之上。</p>
<p>没有Next.js也可以构建Flask应用，没有Flask也可以构建Next.js app。但是，您可能会发现自己已经用Flask构建了一个应用程序，然后决定使用Next.js进行服务器端呈现。</p>
<p>那么，此时你会怎么做呢？</p>
<p>你可以尝试的一件事是逐步采用Next.js或Flask。在本文中，我将向您展示如何使用Next.js增量采用设计使Next.js与Flask API无缝协作，以及如何在Ubuntu服务器上使用Nginx部署它。</p>
<p>在这篇文章中:</p>

<h2 id="build-app-next-js-flask">在Next.js和Flask中构建一个app</h2>
<h3 id="requirement">要求<i> s </i></h3>

<p>让我们首先构建一个示例Next.js应用程序。遵循官方的<a href="https://nextjs.org/docs/getting-started" target="_blank" rel="noopener"> Next.js文档</a>，运行以下命令在您的计算机上安装next . js:<code>npx <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="482b3a2d293c2d65262d303c652938380824293c2d3b3c">[email protected]</a></code>。按照说明设置基本应用程序。</p>
<p><img data-attachment-id="127156" data-permalink="https://blog.logrocket.com/deploying-next-js-flask/attachment/basic-app-setup/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/08/basic-app-setup.png" data-orig-size="730,358" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Basic app setup" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/08/basic-app-setup-300x147.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/08/basic-app-setup.png" decoding="async" class="aligncenter size-full wp-image-127156 jetpack-lazy-image" src="../Images/854b4e7862c3c485089eb9c764eca2a8.png" alt="Basic App Setup" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2022/08/basic-app-setup.png 730w, https://blog.logrocket.com/wp-content/uploads/2022/08/basic-app-setup-300x147.png 300w" data-lazy-sizes="(max-width: 730px) 100vw, 730px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2022/08/basic-app-setup.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/08/basic-app-setup.png"/></p><noscript><img data-lazy-fallback="1" data-attachment-id="127156" data-permalink="https://blog.logrocket.com/deploying-next-js-flask/attachment/basic-app-setup/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/08/basic-app-setup.png" data-orig-size="730,358" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Basic app setup" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/08/basic-app-setup-300x147.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/08/basic-app-setup.png" decoding="async" loading="lazy" class="aligncenter size-full wp-image-127156" src="../Images/854b4e7862c3c485089eb9c764eca2a8.png" alt="Basic App Setup" srcset="https://blog.logrocket.com/wp-content/uploads/2022/08/basic-app-setup.png 730w, https://blog.logrocket.com/wp-content/uploads/2022/08/basic-app-setup-300x147.png 300w" sizes="(max-width: 730px) 100vw, 730px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/08/basic-app-setup.png"/></noscript>
<p>这个装置将给我们一个“你好，世界！”app，准备部署。如果一切顺利，您可以在终端上运行<code>yarn run dev</code>,并在浏览器上访问<code>localhost:3000</code>,以确认它工作正常。您应该会看到类似这样的内容:</p>
<p><img data-attachment-id="127158" data-permalink="https://blog.logrocket.com/deploying-next-js-flask/attachment/next-js-app/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/08/next-js-app.png" data-orig-size="730,299" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Next.js app" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/08/next-js-app-300x123.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/08/next-js-app.png" decoding="async" class="aligncenter size-full wp-image-127158 jetpack-lazy-image" src="../Images/bbbfae0d65d7b055a2b553f48f570fff.png" alt="Next.js App" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2022/08/next-js-app.png 730w, https://blog.logrocket.com/wp-content/uploads/2022/08/next-js-app-300x123.png 300w" data-lazy-sizes="(max-width: 730px) 100vw, 730px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2022/08/next-js-app.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/08/next-js-app.png"/></p><noscript><img data-lazy-fallback="1" data-attachment-id="127158" data-permalink="https://blog.logrocket.com/deploying-next-js-flask/attachment/next-js-app/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/08/next-js-app.png" data-orig-size="730,299" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Next.js app" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/08/next-js-app-300x123.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/08/next-js-app.png" decoding="async" loading="lazy" class="aligncenter size-full wp-image-127158" src="../Images/bbbfae0d65d7b055a2b553f48f570fff.png" alt="Next.js App" srcset="https://blog.logrocket.com/wp-content/uploads/2022/08/next-js-app.png 730w, https://blog.logrocket.com/wp-content/uploads/2022/08/next-js-app-300x123.png 300w" sizes="(max-width: 730px) 100vw, 730px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/08/next-js-app.png"/></noscript>
<p>目前就这些了。接下来，让我们构建一个基本的Flask API。我假设你已经安装了Python，但是如果你没有，你可以按照你的操作系统的官方文档中的说明来安装它。</p>
<p>首先，让我们创建并激活一个虚拟环境来包含Python应用程序。</p>
<pre class="language-python hljs">python3 -m venv env &amp; source ./env/bin/activate
</pre>
<p>接下来，<a href="https://flask.palletsprojects.com/en/2.1.x/installation/" target="_blank" rel="noopener">通过在您的终端中运行以下命令来安装Flask </a>。我们将使用Flask-RESTful创建一个restful API:</p>
<pre class="language-python hljs">pip install Flask flask-restful
</pre>
<p>然后，创建一个名为<code>hello.py</code>的文件，并向其中添加以下代码:</p>
<pre class="language-python hljs">from flask import Flask
from flask_restful import reqparse, Api, Resource
app = Flask(__name__)
api = Api(app)

parser = reqparse.RequestParser()
parser.add_argument('task')
class Message(Resource):
    def get(self):
        return {"message": 'Hello World'}
api.add_resource(Message, '/api/hello')

if __name__ == '__main__':
    app.run(debug=True)
</pre>
<p>现在，我们已经设置好了Flask和Next.js应用程序。让我们继续让他们一起工作。</p>
<h2 id="integrating-flask-api-next-js-rewrites">使用重写将Flask API集成到Next.js中</h2>
<blockquote><p><a href="https://nextjs.org/docs/api-reference/next.config.js/rewrites" target="_blank" rel="noopener"> Next.js重写</a>允许您将传入的请求路径映射到不同的目标路径。</p></blockquote>
<p>进入我们刚刚创建的Next.js应用程序的目录，打开<code>next.config.js</code>文件，用下面的代码替换内容:</p>
<pre class="language-javascript hljs">module.exports = () =&gt; {
  const rewrites = () =&gt; {
    return [
      {
        source: "/hello/:path*",
        destination: "http://localhost:5000/hello/:path*",
      },
    ];
  };
  return {
    rewrites,
  };
};
</pre>
<p>通过这种集成，我们可以直接从Next.js访问我们的所有API路由，就好像API与Next.js客户机在同一个域和端口中一样。这意味着我们将只需要调用<code><a href="http://localhost:3000/api/" rel="nofollow">http://localhost:3000/api/</a></code>，并且我们将能够间接地到达端口<code>5000</code>的API。</p>
<p>让我们看一个例子。</p>
<p>打开<code>/pages/index.js</code>文件，用“Hello，World！”替换它的组件以下组件:</p>
<pre class="language-javascript hljs">import styles from '../styles/Home.module.css'
import { useEffect, useState } from 'react'

export default function Home() {
    const [message, setMessage] = useState("");
    const [loading, setLoading] = useState(true);

    useEffect(() =&gt; {
        fetch('/hello/')
            .then(res =&gt; res.json())
            .then(data =&gt; {
                setMessage(data.message);
                setLoading(false);
            })
    }, [])

    return (
        &lt;div className={styles.container}&gt;
            &lt;p&gt; {!loading ? message : "Loading.."}&lt;/p&gt;
        &lt;/div&gt;
    )
}</pre>
<p>上面的代码是一个简单的Next.js组件，它使用Fetch与Flask API对话。如您所见，我们不需要在API调用中输入确切的URL。Next.js是根据我们最初设置的理解的。</p>
<p>当然，你也可以选择直接调用Flask API。</p>
<h2 id="set-up-nginx">设置Nginx</h2>
<p>既然我们已经有了一个工作的集成，让我们继续在Nginx中部署。<a href="https://docs.nginx.com/nginx/admin-guide/installing-nginx/installing-nginx-open-source/" target="_blank" rel="noopener">在您的服务器上安装Nginx </a>(在我们的例子中，是Ubuntu服务器)，为您的Nginx配置创建一个配置文件，我们称之为<code>nextflask</code>，并将以下代码添加到该文件中:</p>
<pre class="language-javascript hljs">/** 
/etc/nginx/sites-available/nextflask
**/
server {
    server_name        yourdomainname.com www.yourdomainname.com;
    listen 80;

  location /hello/ {
    proxy_pass http://127.0.0.1:5000/hello/;
    proxy_http_version 1.1;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host $host;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  }
  location / {
    proxy_pass http://0.0.0.0:3000;
    proxy_http_version 1.1;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host $host;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  }
}
</pre>
<p>上面的Nginx配置将在根域<code>yourdomainname.com</code>上为你的Next.js应用服务，在<code>yourdomainname.com/api/hello</code>上为你的API服务。</p>
<p>添加此配置后，通过运行以下命令启动Nginx:</p>
<pre class="language-javascript hljs">sudo systemctl start nginx.service
</pre>
<p>这就是为我们的Flask API和Next.js服务器设置Nginx的全部内容。将Flask和Next.js代码推送到服务器，安装依赖项，并分别运行它们。哦，等等，我们需要给它们起名字。</p>
<p>你可以用<a href="https://www.techcoil.com/blog/how-to-host-your-python-3-flask-mvp-with-supervisor-on-ubuntu-server-16-04/" target="_blank" rel="noopener"> Supervisor </a>或<a href="https://docs.gunicorn.org/en/stable/deploy.html" target="_blank" rel="noopener"> Gunicorn </a>来守护Flask应用，这是两个部署Python应用的流行工具。</p>
<p>我们将使用Gunicorn的Flask和PM2的Next.js</p>
<h2 id="flask-api-next-js-api-service">将Flask API和Next.js API作为服务运行</h2>
<p>让我们从用Gunicorn运行Flask API开始。确保您的服务器上安装了Python，然后创建一个虚拟环境来安装Gunicorn。</p>
<p>创建虚拟环境:</p>
<pre class="language-python hljs">python3 -m venv env
</pre>
<p>然后，安装Gunicorn和烧瓶:</p>
<pre class="language-python hljs">pip install gunicorn flask
</pre>
<h3 id="set-up-gunicorn-flask-application">设置Gunicorn以服务于Flask应用程序</h3>
<p>首先，在根目录下创建一个<code>wsgi.py</code>文件。这将作为应用程序的入口点。将以下代码添加到文件中:</p>
<pre class="language-python hljs">// wsgi.py
from hello import app

if __name__ == "__main__":
    app.run()
</pre>
<p>接下来，为Gunicorn创建配置文件<code>sudo vim /etc/systemd/system/hello.service</code>,并向其中添加以下配置:</p>
<pre class="language-python hljs">[Unit]
Description=Gunicorn instance to serve hello
After=network.target

[Service]
User=eze
Group=www-data
WorkingDirectory=/path/to/your/app/directory
ExecStart=/path/to/gunicorn/bin/gunicorn --workers 3 --bind unix:hello.sock -m 007 wsgi:app

[Install]
WantedBy=multi-user.target
</pre>
<p>请注意参考路径。最后，通过在终端中运行以下命令来启动并启用Gunicorn:</p>
<pre class="language-python hljs">sudo systemctl start hello &amp; sudo systemctl enable hello
</pre>
<p>要检查操作是否成功，请通过运行以下命令来查看状态:</p>
<pre class="language-python hljs">sudo systemctl status
</pre>
<p>如果一切顺利，我们的Flask应用程序应该在端口<code>500</code>和根域<code>yourdomainname.com</code>上启动并运行。</p>
<h2 id="next-js-app-pm2">和PM2一起运行Next.js应用程序</h2>
<p><a href="https://pm2.keymetrics.io/" target="_blank" rel="noopener"> PM2 </a>是Node.js应用程序的流程管理工具。要使用它，请使用以下命令全局安装PM2:</p>
<pre class="language-python hljs">pm2 install -g pm2
</pre>
<p>接下来，在包含Next.js代码的目录中运行这个命令:</p>
<pre class="language-python hljs">pm2 start "npm run start" --name nextapp
</pre>
<p>您的Next.js应用程序将在端口<code>3000</code>和根域<code>yourdomainname.com</code>上开始工作。</p>
<p>恭喜你！您已经使用Flask API成功部署了Next.js前端。乍一看，这似乎很复杂，但是您不必在将来的部署中重复这个过程，因为这为您的应用程序正常工作设置了基本环境。您可能只需要推送您的代码并重启您的服务器，这可以由您的<a href="https://blog.logrocket.com/ci-cd-pipelines-react-github-actions-heroku/" target="_blank" rel="noopener"> CI/CD管道</a>来管理。</p>
<h2 id="conclusion">结论</h2>
<p>新技术总是来来去去，现在可能是您选择使用Flask部署Next.js来改进应用程序的一般工程的时候了。我希望这篇文章对你有所帮助。</p>
<p>就我个人而言，我有一个旧的Flask API，但我想继续用Next.js进行开发，同时保留一些Python后端实现。我发现在不中断或破坏现有API的情况下进行切换非常容易。</p>
<p>查看这个<a href="https://github.com/ezesundayeze/basic-nextjs-app" target="_blank" rel="noopener">示例Next.js项目</a>，您可以克隆它来复制本文中的过程。干杯！</p><div class="code-block code-block-30">
<div class="blog-plug inline-plug next-plug"><h2><a href="https://lp.logrocket.com/blg/nextjs-signup" target="_blank"> LogRocket </a>:全面了解生产Next.js应用</h2><p>调试下一个应用程序可能会很困难，尤其是当用户遇到难以重现的问题时。如果您对监视和跟踪状态、自动显示JavaScript错误、跟踪缓慢的网络请求和组件加载时间感兴趣，</p><a href="https://lp.logrocket.com/blg/nextjs-signup" target="_blank">try LogRocket</a><p>. </p><a class="signup" href="https://lp.logrocket.com/blg/nextjs-signup" target="_blank" rel="noopener noreferrer"><img class="alignnone size-full wp-image-46 jetpack-lazy-image" src="../Images/f300c244a1a1cf916df8b4cb02bec6c6.png" data-lazy-src="https://files.readme.io/27c94e7-Image_2017-06-05_at_9.46.04_PM.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://files.readme.io/27c94e7-Image_2017-06-05_at_9.46.04_PM.png"/><noscript><img data-lazy-fallback="1" class="alignnone size-full wp-image-46" src="../Images/f300c244a1a1cf916df8b4cb02bec6c6.png" data-original-src="https://files.readme.io/27c94e7-Image_2017-06-05_at_9.46.04_PM.png"/></noscript></a><a class="signup" href="https://lp.logrocket.com/blg/nextjs-signup" target="_blank" rel="noopener noreferrer"><img class="alignnone size-full wp-image-46 jetpack-lazy-image" src="../Images/d6f5a5dd739296c1dd7aab3d5e77eeb9.png" alt="LogRocket Dashboard Free Trial Banner" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2017/03/1d0cd-1s_rmyo6nbrasp-xtvbaxfg.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2017/03/1d0cd-1s_rmyo6nbrasp-xtvbaxfg.png"/><noscript><img data-lazy-fallback="1" class="alignnone size-full wp-image-46" src="../Images/d6f5a5dd739296c1dd7aab3d5e77eeb9.png" alt="LogRocket Dashboard Free Trial Banner" data-original-src="https://blog.logrocket.com/wp-content/uploads/2017/03/1d0cd-1s_rmyo6nbrasp-xtvbaxfg.png"/></noscript></a><p>LogRocket 就像是网络和移动应用的DVR，记录下你的Next.js应用上发生的一切。您可以汇总并报告问题发生时应用程序的状态，而不是猜测问题发生的原因。LogRocket还可以监控应用程序的性能，报告客户端CPU负载、客户端内存使用等指标。</p><p>LogRocket Redux中间件包为您的用户会话增加了一层额外的可见性。LogRocket记录Redux存储中的所有操作和状态。</p><p>让您调试Next.js应用的方式现代化— <a class="signup" href="https://lp.logrocket.com/blg/nextjs-signup" target="_blank" rel="noopener noreferrer">开始免费监控</a>。</p></div></div>

<p class="clearfix"/>
<p class="clearfix"/>
</article>

</div>    
</body>
</html>