<html>
<head>
<title>What's new in Django v4.0 - LogRocket Blog</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>Django v4.0 中的新内容- LogRocket 博客</h1>
<blockquote>原文：<a href="https://blog.logrocket.com/whats-new-django-v4/#0001-01-01">https://blog.logrocket.com/whats-new-django-v4/#0001-01-01</a></blockquote><div><article class="article-post">
<p>2021 年 12 月，<a href="https://docs.djangoproject.com/en/4.0/releases/4.0/"> Django 团队发布了 Django v4 </a>，它包含了对框架的各种升级，比如改进的定制和对表单、表单集和<code>ErrorList</code>的模板引擎的使用。</p>
<p>但是宣布只有 Python v3.6、3.9、3.10 版本会支持 Django v4.0，另外 Django v3.2.x 系列是支持 Python v3.6、3.7 的最终版本。</p>
<p>在本文中，我们将介绍 Django v4.0 中的一些新特性，以及 Django v4.0 中已经删除的一些旧的第三方版本。让我们开始吧！</p>
<h2>升级到 Django v4.0 版</h2>
<p>在升级到 Django v4.0 之前，确保在使用当前的 Django 版本时解决项目报告的任何不赞成使用的警告。默认情况下，不推荐使用警告是关闭的。要启用弃用警告，请使用下面的测试命令:</p>
<pre class="language-bash hljs">$ python -Wa manage.py test
</pre>
<h3>装置</h3>
<p>一旦你修复了任何反对警告，你就可以继续安装 Django v4.0。如果你<a href="https://docs.djangoproject.com/en/4.0/topics/install/">用 pip </a>安装了 Django，你可以使用<code>--upgrade</code>或<code>-U</code>标志:</p>
<pre class="language-bash hljs">$ python -m pip install -U Django
</pre>
<h2>Django v4.0 版不再支持</h2>
<p>随着 Django v4.0 的推出，一些较低的第三方包版本将不再受支持。下面，你会发现一个列表和每个的描述。</p>
<h3>postgresql9.6</h3>
<p>Django v4.0 不支持 PostgreSQL v9.6 及更早版本，Django v4.0 将只支持 PostgreSQL ≥v10。</p>
<h3>Oracle v12.2 和 18c</h3>
<p>Django v4.0 将只支持 Oracle ≥v19。Django 团队已经正式移除了对 Oracle 版本 18c 和更早版本的支持。根据公告，截至 2024 年 4 月，Django v3.2 将不再支持 Oracle ≤v18c。</p>
<h3>Django v4.0 中增加的包和函数</h3>
<p>Django v4.0 版不支持以下功能和第三方软件包:</p>
<ul>
<li>PostGIS 2.3</li>
<li>GDAL 2.0 和 GEOS 3.5</li>
<li>cx_ORACLE 7.0</li>
<li><code>django.utils.text.unescape_entities()</code>功能已被弃用</li>
<li><code>django.utils.http.is_safe url()</code>功能已被弃用</li>
</ul>
<h2>Django v4.0 有什么新功能？</h2>
<h3><code>zoneinfo</code>默认时区</h3>
<p>在 Django v4.0 中，<a href="https://blog.logrocket.com/python-datetime-module-handling-dates-time/">默认的<code>pytz</code>时区已经迁移到了<code>zoneinfo</code> </a>。对<code>pytz</code>时区的支持现在被否决了，在即将发布的 Django v5.0 和更高版本中将不再支持。</p>
<p>迁移到<code>zoneinfo</code>相当简单。您可以选择当前时区，并将表单和模板中的<code>datetime</code>实例转换为当前时区。UTC 中对 aware <code>datetime</code>实例的操作不受影响。</p>
<h3>基于模板的表单呈现</h3>
<p>表单、表单集和<code>ErrorList</code>现在使用模板引擎呈现，以增强定制。</p>
<p>Django 团队对 Django v4.0 中如何使用<code>render()</code>、<code>get_context()</code>和<code>template_name</code>进行了修改。<code>render()</code>选项现在是可选的，其中<code>None</code>是所有选项的默认值。</p>
<p>使用以下代码时:</p>
<pre class="language-python hljs">render(template_name=None, context=None, renderer=None)
</pre>
<p>如果没有传入参数值，参数将默认为以下值:</p>
<ul>
<li><code>template_name</code> : <code>template_name()</code></li>
<li><code>Context</code>:包含由<code>get_context()</code>返回的值</li>
<li><code>renderer</code>:由<code>default_renderer</code>返回的值</li>
</ul>
<p>为了灵活起见，<code>formset</code>渲染已经被移到 Django v4.0 版的模板引擎中。</p>
<p>当在视图中使用<code>formset</code>时，您将在模板中使用<code>management</code>表单。让我们来看一个<code>view</code>的例子:</p>
<pre class="language-python hljs">from django.forms import formset_factory
from django.shortcuts import render
from myapp.forms import ArticleForm
def manage_articles(request):
    ArticleFormSet = formset_factory(ArticleForm)
    if request.method == 'POST':
        formset = ArticleFormSet(request.POST, request.FILES)
        if formset.is_valid():
            # do something with the formset.cleaned_data
            pass
    else:
        formset = ArticleFormSet()
    return render(request, 'manage_articles.html', {'formset': formset})
</pre>
<p><code>manage_articles.html</code>模板看起来像下面的代码:</p>
<pre class="language-html hljs">&lt;form method="post"&gt;
    &lt;table&gt;
        {{ formset }}
    &lt;/table&gt;
&lt;/form&gt;
</pre>
<h3>国际化</h3>
<p>Django v4.0 现在支持马来语翻译，这在 Django 以前的版本中是不可用的。开发人员现在可以在他们的项目中转换马来语内容。</p>
<h3>本地化</h3>
<p>在 Django v4.0 中，参数<code>USE_L10N</code>的默认值从<code>False</code>更改为<code>True</code>，以遵循最佳实践。</p>
<p>随着 Dango v4.0 的发布，<code>USE_L10N</code>已经被弃用。还需要注意的是，在 Django v5.x 中，任何日期或数字都会被默认本地化。</p>
<h3><code>CSRF_TRUSTED_ORIGINS</code></h3>
<p>设置<code>CSRF_TRUSTED_ORIGINS</code>设置时，Django v4.0 不启用仅使用<code>hostname</code>值；相反，这些值必须包含方案，例如<code>http://</code>或<code>https://</code>。</p>
<p>此外，以点开头的值现在必须以星号开头。例如，你可以用<code><a href="https://*.example.com" rel="nofollow">https://*.example.com</a></code>代替<code>.example.com</code>。</p>
<h3>scrypt 密码散列器</h3>
<p>Django v4.0 中添加了<a href="https://docs.djangoproject.com/en/4.0/topics/auth/passwords/#scrypt-usage"> scrypt 密码散列器</a>以提供额外的安全性，建议您使用<a href="https://docs.djangoproject.com/en/4.0/topics/auth/passwords/"> scrypt 而不是 PBKDF2 </a>来限制攻击者可以利用的并行数量。</p>
<p>scrypt 被设计为比其他基于密码的密钥派生技术使用更多的内存。</p>
<h3>功能唯一约束</h3>
<p><code>UniqueConstraint()</code>现在有了一个新的<code>*expressions</code>位置选项，允许程序员使用与<code>Index.expressions</code>相同的数据库限制来实现函数唯一约束，如下面的代码所示:</p>
<pre class="language-python hljs">from django.db import models
from django.db.models import UniqueConstraint
from django.db.models.functions import Lower

class MyModel(models.Model):
    first_name = models.CharField(max_length=255)
    last_name = models.CharField(max_length=255)
    class Meta:
        constraints = [
            UniqueConstraint(
                Lower('first_name'),
                Lower('last_name').desc(),
                name='first_last_name_unique',
            ),
        ]
</pre>
<p><code>Meta.restrictions</code>选项用于将功能独特的约束应用于模型。</p>
<h2>结论</h2>
<p>在本文中，我们讨论了 Django 4.0 中的一些新特性，Django 4.0 不再支持的一些第三方包，以及将现有版本升级到 Django 4.0 所需的步骤。</p>
<p>Django v4.0 的新特性不仅限于本文中提到的。关于新功能的完整列表，请查看 Django 的官方声明。我希望你喜欢这个教程！</p><div class="code-block code-block-1">
<div class="blog-plug base-cta"><h2>使用<a class="signup" href="https://lp.logrocket.com/blg/signup" target="_blank" rel="noopener noreferrer"> LogRocket </a>消除传统错误报告的干扰</h2>
<a href="https://lp.logrocket.com/blg/signup" class="signup" target="_blank" rel="noopener noreferrer"><img class="alignnone size-full wp-image-46 jetpack-lazy-image" src="../Images/d6f5a5dd739296c1dd7aab3d5e77eeb9.png" alt="LogRocket Dashboard Free Trial Banner" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2017/03/1d0cd-1s_rmyo6nbrasp-xtvbaxfg.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2017/03/1d0cd-1s_rmyo6nbrasp-xtvbaxfg.png"/><noscript><img data-lazy-fallback="1" class="alignnone size-full wp-image-46" src="../Images/d6f5a5dd739296c1dd7aab3d5e77eeb9.png" alt="LogRocket Dashboard Free Trial Banner" data-original-src="https://blog.logrocket.com/wp-content/uploads/2017/03/1d0cd-1s_rmyo6nbrasp-xtvbaxfg.png"/></noscript></a>
<p><a href="https://lp.logrocket.com/blg/signup" target="_blank" rel="noopener noreferrer"> LogRocket </a>是一个数字体验分析解决方案，它可以保护您免受数百个假阳性错误警报的影响，只针对几个真正重要的项目。LogRocket 会告诉您应用程序中实际影响用户的最具影响力的 bug 和 UX 问题。</p>
<p>然后，使用具有深层技术遥测的会话重放来确切地查看用户看到了什么以及是什么导致了问题，就像你在他们身后看一样。</p>
<p>LogRocket 自动聚合客户端错误、JS 异常、前端性能指标和用户交互。然后 LogRocket 使用机器学习来告诉你哪些问题正在影响大多数用户，并提供你需要修复它的上下文。</p>
<p>关注重要的 bug—<a class="signup" href="https://lp.logrocket.com/blg/signup-issue-free" target="_blank" rel="noopener noreferrer">今天就试试 LogRocket】。</a></p></div></div>

<p class="clearfix"/>
<p class="clearfix"/>
</article>

</div>    
</body>
</html>