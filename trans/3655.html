<html>
<head>
<title>Learn how to build a monorepo in Next.js </title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>了解如何在Next.js中构建monorepo</h1>
<blockquote>原文：<a href="https://blog.logrocket.com/build-monorepo-next-js/#0001-01-01">https://blog.logrocket.com/build-monorepo-next-js/#0001-01-01</a></blockquote><div><article class="article-post">
<p>Monorepo架构在开发现代web应用程序的开发人员中已经成为一种非常流行的趋势。</p>
<p>尽管这种做法并不新鲜，但像谷歌和微软这样的大公司已经利用monorepos大规模管理软件很长时间了，它也用于流行的开源项目，如React、Next.js、Jest、Babel等等。</p>
<p>在这篇文章中，我们将讨论什么是monorepos以及使用它们所需的工具。</p>
<p>我们还将探索如何为Next.js项目构建monorepo，并提供一个样例用例。</p>
<p><em>向前跳转:</em></p>

<h2 id="what-monorepo">什么是单向回购？</h2>
<p>monorepo是一个单一的受版本控制的存储库，它包含几个具有良好定义关系的独立项目。</p>
<p>这种方法不同于更典型的软件开发方法，在这种方法中，每个项目通常存储在一个单独的存储库中，有自己的配置用于构建、测试和部署。</p>
<p><img data-attachment-id="144458" data-permalink="https://blog.logrocket.com/build-monorepo-next-js/attachment/monorepo-vs-multirepo/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/11/monorepo-vs-multirepo.jpeg" data-orig-size="730,354" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;1&quot;}" data-image-title="monorepo-vs-multirepo" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/11/monorepo-vs-multirepo-300x145.jpeg" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/11/monorepo-vs-multirepo.jpeg" decoding="async" class="aligncenter wp-image-144458 size-full jetpack-lazy-image" src="../Images/6252ae125982cfd99996c782fbb4e84b.png" alt="Monorepo Vs. Multirepo" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2022/11/monorepo-vs-multirepo.jpeg 730w, https://blog.logrocket.com/wp-content/uploads/2022/11/monorepo-vs-multirepo-300x145.jpeg 300w" data-lazy-sizes="(max-width: 730px) 100vw, 730px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2022/11/monorepo-vs-multirepo.jpeg?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/11/monorepo-vs-multirepo.jpeg"/></p><noscript><img data-lazy-fallback="1" data-attachment-id="144458" data-permalink="https://blog.logrocket.com/build-monorepo-next-js/attachment/monorepo-vs-multirepo/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/11/monorepo-vs-multirepo.jpeg" data-orig-size="730,354" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;1&quot;}" data-image-title="monorepo-vs-multirepo" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/11/monorepo-vs-multirepo-300x145.jpeg" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/11/monorepo-vs-multirepo.jpeg" decoding="async" loading="lazy" class="aligncenter wp-image-144458 size-full" src="../Images/6252ae125982cfd99996c782fbb4e84b.png" alt="Monorepo Vs. Multirepo" srcset="https://blog.logrocket.com/wp-content/uploads/2022/11/monorepo-vs-multirepo.jpeg 730w, https://blog.logrocket.com/wp-content/uploads/2022/11/monorepo-vs-multirepo-300x145.jpeg 300w" sizes="(max-width: 730px) 100vw, 730px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/11/monorepo-vs-multirepo.jpeg"/></noscript>
<h2 id="benefits-monorepo-next-js">在Next.js中使用monorepo的好处</h2>
<p>有一些关键因素导致了关于软件项目如何构建的方向的转变(特别是那些具有大代码库的项目)。</p>
<p>这些因素是:</p>
<h3 id="simple-code-sharing">简单代码共享</h3>
<p>monorepo中构建的应用程序可以很容易地共享可重用的代码和配置，因为它们共享同一个存储库。</p>
<p>与polyrepo相比，这意味着减少了代码重复，确保了更快的开发和易于维护。</p>
<p>此外，开发人员不必经历发布包和解决与依赖它们的项目不兼容的困难过程。</p>
<h3 id="atomic-commits">原子提交</h3>
<p>影响多个应用程序的大规模更改可以在一次提交中完成，同时确保应用程序在提交更改前按预期工作。</p>
<p>原子提交的一个很好的例子是当对几个应用程序使用的共享库进行重大更改时，从而迫使开发人员确保依赖它的应用程序更新为与最近的更改兼容。</p>
<h3 id="consistency">一致性</h3>
<p>Monorepos比polyrepos提供了更好的一致性，因为代码库都在一个地方，每个项目都可以轻松地共享相同的编码风格和工具来进行测试、部署和代码维护。</p>

<p>Monorepos对于管理项目非常有用，但是要充分利用它们，您需要使用正确的工具来确保您的开发工作流快速有效。</p>
<p>可用的monorepo工具因其功能、语言支持和使用它们所需的专业知识而异。</p>
<p>以下是使用JavaScript/TypeScript代码库的monorepo工具列表:</p>
<ul>
<li><a href="https://github.com/vercel/turborepo"> Turborepo </a>:由Vercel为JavaScript/TypeScript monorepos维护的智能构建系统</li>
<li><a href="https://github.com/nrwl/nx"> Nx </a>:具有一流monorepo支持和强大集成的下一代构建系统</li>
<li>Bazel :快速、可伸缩、多语言和可扩展的构建系统</li>
<li>Lerna :快速现代的构建系统，用于管理和发布来自同一个存储库的多个JavaScript/TypeScript包</li>
</ul>
<p>Turborepo是本教程的首选工具。对于TypeScript/JavaScript代码库来说，这是一个易于使用、快速且有效的构建系统。</p>
<blockquote><p><strong>注意，</strong>如果你想看看Turborepo还能做些什么，我们有另一个教程，重点是<a href="https://blog.logrocket.com/build-full-stack-typescript-application-turborepo/">构建一个全栈式脚本monorepo </a></p></blockquote>
<p>Turborepo构建在<a href="https://docs.npmjs.com/cli/v7/using-npm/workspaces">工作空间</a>上，这是一个由Yarn、npm和<a href="https://blog.logrocket.com/managing-full-stack-monorepo-pnpm/"> pnpm </a>支持的特性，用于管理一个顶级根包中的多个包。</p>
<p>Turborepo附带以下功能，使monorepos的使用变得简单:</p>
<ul>
<li>增量构建:这确保当工作空间中有变化时构建被执行，以防止不必要的计算</li>
<li>并行执行:并行执行任务，同时最大限度地利用CPU中的每个可用内核，以确保快速执行</li>
<li>远程缓存:这是Turborepo支持的一个令人印象深刻的特性，它允许您与开发团队和CI/CD服务器共享任务执行的缓存，以减少执行时间</li>
<li>依赖图可视化:这支持生成任务执行计划的图形，以给出运行它所采取的步骤的高级视图</li>
</ul>
<h2 id="building-monorepo">构建monorepo</h2>
<p>对于本教程，我们将为一个示例电子商务应用程序构建一个monorepo，该应用程序由两个独立的Next.js应用程序组成:一个admin和一个store。</p>
<p>我们还将介绍如何利用monorepos提供的显著优势。这些主要是:</p>
<ul>
<li>代码共享；创建一个可重用的组件库，供两个Next.js应用程序使用</li>
<li>用于林挺和格式化的共享配置包</li>
</ul>
<h2 id="project-setup">项目设置</h2>
<p>在您的终端中，输入以下命令为项目创建一个新目录并设置<code>package.json</code>:</p>
<pre class="language-bash hljs">mkdir nextjs-monorepo 
cd nextjs-monorepo 
yarn init -y
</pre>
<p>这是构建单一回购的第一步；现在我们必须设置项目的工作环境。</p>
<h2 id="creating-workspaces">创建工作区</h2>
<p>在本文的前面，我提到了Turborepo是建立在工作空间之上的monorepo中的所有包和应用程序都将存储在它们自己的独立工作空间中。</p>
<p>打开项目根目录下的<code>package.json</code>文件，插入下面的代码:</p>
<pre class="language-json hljs">{
  "name": "nextjs-monorepo",
  "private": true,
  "version": "1.0.0",
  "workspaces": [
    "apps/*",
    "packages/config/*",
    "packages/shared/*"
  ],
  "engines": {
    "node": "&gt;=14.0.0"
  },
  "packageManager": "<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="84fde5f6eac4b5aab6b6aab5b3">[email protected]</a>"
}
</pre>
<p><code>package.json</code>文件中的<code>workspaces</code>字段是一个路径数组，它告诉包管理器我们的工作区位于哪里。</p>
<p><code>apps/*</code>是针对所有独立的Next.js应用；<code>packages/config/*</code>存储可重复使用的包，用于林挺和格式化；并且<code>packages/shared/*</code>包含由<code>app/</code>中的项目使用的可重用代码——这是UI组件库将被存储的地方。</p>
<h2 id="set-up-next-js-applications">设置Next.js应用程序</h2>
<p>在项目的根目录下，创建一个新文件夹<code>apps/</code>，用于存储我们将要设置的Next.js应用程序:</p>
<pre class="language-bash hljs">mkdir apps
cd apps
</pre>
<p>接下来，让我们添加<code>admin</code>和<code>store</code>应用程序:</p>
<pre class="language-json hljs">yarn create next-app admin 
yarn create next-app store
</pre>
<p>安装完成后，打开位于<code>apps/admin/package.json</code>的<code>admin</code>应用程序的<code>package.json</code>文件。然后，用下一个<code>dev</code>——端口3001——替换<code>dev</code>脚本的值，这样它就可以在不同的端口上运行。</p>
<p>一旦完成，用<code>yarn dev</code>运行两个项目的开发服务器，以确保一切正常工作。</p>
<p>在<code>apps/admin/pages/index.js</code>文件中，插入以下代码:</p>
<pre class="language-javascript hljs">export default function Home() {
  return (
    &lt;div&gt;
      &lt;h1&gt;Admin&lt;/h1&gt;
      &lt;button&gt;Click Me!&lt;/button&gt;
    &lt;/div&gt;
  );
}
</pre>
<p>我们将在<code>apps/store/pages/index.js</code>文件中做同样的事情，所以再次插入下面的代码:</p>
<pre class="language-javascript hljs">export default function Home() {
  return (
    &lt;div&gt;
      &lt;h1&gt;Store&lt;/h1&gt;
      &lt;button&gt;Click Me!&lt;/button&gt;
    &lt;/div&gt;
  );
}
</pre>
<p>现在，我们已经完成了两个Next.js应用程序的基本设置。在下一节中，我们将设置Turborepo来运行我们的开发任务。</p>
<h2 id="set-turborepo">设置Turborepo</h2>
<p>工作区和任务是monorepo的构造块。</p>
<p>Yarn和npm之类的包管理器在安装包和配置工作空间方面工作得很好，但是它们并不适合在monorepo之类的复杂项目设置中运行任务，而这正是Turborepo的优势所在。</p>
<h3 id="installing-turborepo">安装Turborepo</h3>
<p>让我们从为我们的项目安装Turborepo开始。在monorepo的根目录下，运行以下脚本:</p>
<pre class="language-bashhljs">yarn add turborepo -DW
</pre>
<p>安装完成后，在monorepo的根目录下创建一个新文件<code>turbo.json</code>，以存储Turborepo工作所需的配置。然后，输入以下代码:</p>
<pre class="language-json hljs">{
  "$schema": "https://turborepo.org/schema.json",
}
</pre>
<h3 id="running-tasks">运行任务</h3>
<p>让我们配置Turborepo来运行<code>apps/</code>中的Next.js应用程序。打开<code>turbo.json</code>文件，输入下面的代码:</p>
<pre class="language-json hljs">{
  "$schema": "https://turborepo.org/schema.json",
  "pipeline": {
    "dev": {
      "cache": false
    }
  }
}
</pre>
<p>让我们花点时间来检查一下<code>turbo.json</code>文件的内容:</p>
<ul>
<li><code>pipeline</code>字段定义了Turborepo将在monorepo上运行的任务；对象中的每个属性都是一个任务，对应于工作区的<code>package.json</code>文件中的一个脚本</li>
<li><code>pipeline</code>对象中的<code>dev</code>字段定义了一个工作区的开发任务；<code>"cache": false</code>告诉Turborepo不要缓存该任务的结果</li>
</ul>
<blockquote><p><strong>注意，</strong> Turborepo将只运行在工作区的<code>package.json</code>文件的<code>scripts</code>部分中定义的任务</p></blockquote>
<p>我们需要在monorepo根目录下的<code>package.json</code>文件的<code>scripts</code>字段中定义一个脚本来运行Next.js应用程序的开发服务器。</p>
<p>在monorepo根目录下的<code>package.json</code>文件中插入以下代码:</p>
<pre class="language-json hljs">{
  "scripts": {
    "dev": "turbo run dev --parallel"
  }
}
</pre>
<p><code>--parallel</code>标志告诉Turborepo并行运行工作区的<code>dev</code>任务。</p>
<p>在monorepo根目录下的终端中输入<code>yarn dev</code>,启动Next.js应用程序的开发服务器。</p>
<p>如果这是成功的，您应该得到类似下图的输出:</p>
<p><img data-attachment-id="144464" data-permalink="https://blog.logrocket.com/build-monorepo-next-js/attachment/turborepo-output/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/11/turborepo-output.jpeg" data-orig-size="730,332" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;1&quot;}" data-image-title="turborepo-output" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/11/turborepo-output-300x136.jpeg" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/11/turborepo-output.jpeg" decoding="async" class="aligncenter wp-image-144464 size-full jetpack-lazy-image" src="../Images/8438a2bc775d690807189afc1685733e.png" alt="Turborepo Output" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2022/11/turborepo-output.jpeg 730w, https://blog.logrocket.com/wp-content/uploads/2022/11/turborepo-output-300x136.jpeg 300w" data-lazy-sizes="(max-width: 730px) 100vw, 730px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2022/11/turborepo-output.jpeg?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/11/turborepo-output.jpeg"/></p><noscript><img data-lazy-fallback="1" data-attachment-id="144464" data-permalink="https://blog.logrocket.com/build-monorepo-next-js/attachment/turborepo-output/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/11/turborepo-output.jpeg" data-orig-size="730,332" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;1&quot;}" data-image-title="turborepo-output" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/11/turborepo-output-300x136.jpeg" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/11/turborepo-output.jpeg" decoding="async" loading="lazy" class="aligncenter wp-image-144464 size-full" src="../Images/8438a2bc775d690807189afc1685733e.png" alt="Turborepo Output" srcset="https://blog.logrocket.com/wp-content/uploads/2022/11/turborepo-output.jpeg 730w, https://blog.logrocket.com/wp-content/uploads/2022/11/turborepo-output-300x136.jpeg 300w" sizes="(max-width: 730px) 100vw, 730px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/11/turborepo-output.jpeg"/></noscript>
<p>既然Turborepo已经启动并运行，下一步就是为林挺和格式化设置一个可重用的配置包。</p>
<h2 id="linting-formatting">林挺和格式</h2>
<p>Monorepos支持对其中的所有项目使用统一的代码标准，以确保整个代码库的一致性。</p>
<p>像<a href="https://blog.logrocket.com/troubleshooting-next-js-app-eslint/"> ESLint </a>这样的自动化代码林挺和格式化工具可以被配置为扩展项目中每个工作空间都可以使用的共享配置。</p>
<h3 id="set-eslint">设置ESLint</h3>
<p>我们需要为共享的ESLint配置包创建一个新的工作空间，它将在<code>apps/</code>中的工作空间中使用。</p>
<p>输入以下脚本为ESLint配置包创建新的工作区:</p>
<pre class="language-bash hljs">mkdir -p packages/config/eslint-config-custom 
cd packages/config/eslint-config-custom    
</pre>
<p>在<code>packages/config/eslint-config-custom</code>中创建一个<code>package.json</code>文件，并插入以下代码:</p>
<pre class="language-json hljs">{
  "name": "eslint-config-custom",
  "version": "1.0.0",
  "main": "index.js",
}    
</pre>
<p><code>"main": "index.js"</code>指定这个包的入口点，而<code>index.js</code>包含将由使用它的模块导入的ESLint配置。</p>
<p>安装ESLint和与此项目相关的插件，如下所示:</p>
<pre class="language-bash hljs">yarn add eslint eslint-config-next eslint-config-prettier eslint-config-react eslint-config-turbo
</pre>
<p>在<code>packages/config/eslint-config-custom</code>中创建一个新文件<code>index.js</code>，并输入以下代码:</p>
<pre class="language-javascript hljs">module.exports = {
  extends: ["next", "turbo", "prettier"],
};
</pre>
<p>现在我们已经为这个项目设置了可重用的ESLint配置包，下一步是在我们的Next.js应用程序中使用它。</p>
<p>为了在<code>admin</code>和<code>store</code>工作区中使用<code>eslint-config-custom</code>包，我们需要将它添加为一个依赖项。</p>
<p>在<code>admin</code>和<code>store</code>工作区的<code>package.json</code>文件中，删除每个ESLint包和插件，并插入以下代码:</p>
<pre class="language-json hljs">{
  "devDependencies": {
   "eslint-config-custom": "*"
  }    
}
</pre>
<p>用以下代码更新<code>apps/store</code>和<code>apps/admin</code>工作区中的<code>.eslintrc.json</code>文件:</p>
<pre class="language-json hljs">{
  "root": true,
  "extends": ["custom"] // Tells ESLint to use the "eslint-config-custom" package
}
</pre>
<p>最后，在monorepo的根目录下运行<code>yarn install</code>来更新<code>node_modules</code>文件夹中的依赖项。</p>
<p>如果您正确地遵循了前面的步骤，您应该在根<code>node_modules</code>文件夹中找到本地<code>eslint-config-custom</code>包。</p>
<p><img data-attachment-id="144467" data-permalink="https://blog.logrocket.com/build-monorepo-next-js/attachment/eslint-config-custom-package/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/11/eslint-config-custom-package.jpeg" data-orig-size="730,777" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;1&quot;}" data-image-title="eslint-config-custom-package" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/11/eslint-config-custom-package-282x300.jpeg" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/11/eslint-config-custom-package.jpeg" decoding="async" class="aligncenter wp-image-144467 size-full jetpack-lazy-image" src="../Images/6fb9a03a8a698c89fa2bc1bcc7653c88.png" alt="Eslint-config-custom Package" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2022/11/eslint-config-custom-package.jpeg 730w, https://blog.logrocket.com/wp-content/uploads/2022/11/eslint-config-custom-package-282x300.jpeg 282w" data-lazy-sizes="(max-width: 730px) 100vw, 730px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2022/11/eslint-config-custom-package.jpeg?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/11/eslint-config-custom-package.jpeg"/></p><noscript><img data-lazy-fallback="1" data-attachment-id="144467" data-permalink="https://blog.logrocket.com/build-monorepo-next-js/attachment/eslint-config-custom-package/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/11/eslint-config-custom-package.jpeg" data-orig-size="730,777" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;1&quot;}" data-image-title="eslint-config-custom-package" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/11/eslint-config-custom-package-282x300.jpeg" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/11/eslint-config-custom-package.jpeg" decoding="async" loading="lazy" class="aligncenter wp-image-144467 size-full" src="../Images/6fb9a03a8a698c89fa2bc1bcc7653c88.png" alt="Eslint-config-custom Package" srcset="https://blog.logrocket.com/wp-content/uploads/2022/11/eslint-config-custom-package.jpeg 730w, https://blog.logrocket.com/wp-content/uploads/2022/11/eslint-config-custom-package-282x300.jpeg 282w" sizes="(max-width: 730px) 100vw, 730px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/11/eslint-config-custom-package.jpeg"/></noscript>
<h3 id="running-linting-formatting-tasks">运行林挺和格式化任务</h3>
<p>在我们开始运行林挺和格式化任务之前，我们需要在<code>admin</code>和<code>store</code>应用程序的<code>package.json</code>文件中添加必要的脚本。</p>
<p>打开<code>admin</code>和<code>store</code>应用程序的<code>package.json</code>文件，在<code>scripts</code>字段插入以下内容:</p>
<pre class="language-json hljs">{
  "lint": "eslint .",
  "format": "eslint --fix --ext .js,.jsx ."
}
</pre>
<p>接下来，我们需要为林挺创建任务，并在monorepo中格式化工作区。在monorepo根目录下的<code>turbo.json</code>文件中，在<code>pipeline</code>字段中添加以下代码:</p>
<pre class="language-json hljs">{
  "lint": {
    "outputs": []
  },
  "format": {
    "outputs": []
  }  
}
</pre>
<p><code>lint</code>和<code>format</code>任务中的<code>outputs</code>字段存储了一组glob——任何匹配glob模式的文件都被视为将被缓存的工件。</p>
<p>在<code>lint</code>和<code>format</code>任务中的<code>output</code>的值被设置为一个空数组，这告诉Turborepo将日志缓存到这个任务的<code>stdout</code>和<code>stderr</code>。因此，每当该任务重新运行并且工作区中没有任何更改时，Turborepo都会重放缓存的日志，这意味着任务的执行时间非常快。</p>
<p>要运行新任务，我们需要用下面的代码更新monorepo根目录下的<code>package.json</code>文件的<code>scripts</code>字段:</p>
<pre class="language-json hljs">{
  "lint": "turbo run lint",
  "format": "turbo run format"  
}
</pre>
<p>一旦完成，您现在可以通过输入以下命令来运行<code>lint</code>和<code>format</code>任务:</p>
<pre class="language-bash hljs">yarn lint
yarn format
</pre>
<p>下面是执行<code>yarn lint</code>的示例输出:</p>
<p><img data-attachment-id="144469" data-permalink="https://blog.logrocket.com/build-monorepo-next-js/attachment/yarn-lint-output/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/11/yarn-lint-output.jpeg" data-orig-size="730,390" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;1&quot;}" data-image-title="yarn-lint-output" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/11/yarn-lint-output-300x160.jpeg" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/11/yarn-lint-output.jpeg" decoding="async" class="aligncenter wp-image-144469 size-full jetpack-lazy-image" src="../Images/7c7c2c429f130ff12157c269d96538f1.png" alt="Yarn-lint Output" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2022/11/yarn-lint-output.jpeg 730w, https://blog.logrocket.com/wp-content/uploads/2022/11/yarn-lint-output-300x160.jpeg 300w" data-lazy-sizes="(max-width: 730px) 100vw, 730px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2022/11/yarn-lint-output.jpeg?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/11/yarn-lint-output.jpeg"/></p><noscript><img data-lazy-fallback="1" data-attachment-id="144469" data-permalink="https://blog.logrocket.com/build-monorepo-next-js/attachment/yarn-lint-output/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/11/yarn-lint-output.jpeg" data-orig-size="730,390" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;1&quot;}" data-image-title="yarn-lint-output" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/11/yarn-lint-output-300x160.jpeg" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/11/yarn-lint-output.jpeg" decoding="async" loading="lazy" class="aligncenter wp-image-144469 size-full" src="../Images/7c7c2c429f130ff12157c269d96538f1.png" alt="Yarn-lint Output" srcset="https://blog.logrocket.com/wp-content/uploads/2022/11/yarn-lint-output.jpeg 730w, https://blog.logrocket.com/wp-content/uploads/2022/11/yarn-lint-output-300x160.jpeg 300w" sizes="(max-width: 730px) 100vw, 730px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/11/yarn-lint-output.jpeg"/></noscript>
<h2 id="building-reusable-component-library">构建可重用的组件库</h2>
<p>在现代前端开发中，组件是每个应用程序的构建块，与项目的大小无关。</p>
<p>将复杂的ui分解成可重用的组件，并将它们抽象成共享的组件库，这是当今标准的开发实践——它使得代码库更容易维护，同时仍然遵循软件开发的最佳实践，如DRY。</p>
<p>我们将构建自己的可重用组件库，供<code>apps/</code>中的项目使用。首先，我们需要创建一个新的工作空间。</p>
<p>在monorepo的根目录下输入以下命令，为组件库创建一个新的工作区:</p>
<pre class="language-bash hljs">mkdir -p packages/shared/ui
cd packages/shared/ui
</pre>
<p>在<code>packages/shared/ui</code>中，创建一个新的<code>package.json</code>文件，并插入以下内容:</p>
<pre class="language-json hljs">{
  "name": "ui",
  "version": "1.0.0",
  "main": "index.js",
  "license": "MIT",
  "scripts": {
    "lint": "eslint .",
    "format": "eslint --fix --ext .js,.jsx ."
  },
  "devDependencies": {
    "eslint": "^7.32.0",
    "eslint-config-custom": "*",
    "react": "^18.2.0"
  }
}
</pre>
<p>接下来，让我们创建一个可重用的按钮组件，供Next.js应用程序使用。在<code>packages/shared/ui</code>工作区中，创建一个新文件<code>Button.jsx</code>，并输入以下代码:</p>
<pre class="language-jsx hljs">import * as React from "react";

export const Button = ({ children }) =&gt; {
  return &lt;button&gt;{children}&lt;/button&gt;;
};
</pre>
<p>创建一个新文件<code>index.js</code>，它将作为这个包的入口点，并导出各个React组件。</p>
<p>将以下代码添加到<code>index.js</code>文件中:</p>
<pre class="language-jsx hljs">import { Button } from "./Button.jsx";
export { Button };
</pre>
<p>要在Next.js应用程序中使用<code>Button</code>组件，我们需要将<code>ui</code>包作为依赖项添加到工作区的<code>package.json</code>文件中。</p>
<p>通过在<code>admin</code>和<code>store</code>工作区的<code>package.json</code>文件的<code>dependencies</code>字段中分别插入以下代码来添加<code>ui</code>包:</p>
<pre class="language-json hljs">{
  "dependencies": {
    "ui": "*"
  }
}
</pre>
<p>一旦完成，运行<code>yarn install</code>来更新<code>node_modules</code>文件夹中的依赖项。</p>
<p>接下来，在Next.js应用程序的<code>pages/index.js</code>文件中，用以下代码替换现有代码:</p>
<pre class="language-javascript hljs">// apps/admin/pages/index.js
import { Button } from "ui";
export default function Home() {
  return (
    &lt;div&gt;
      &lt;h1&gt;Admin&lt;/h1&gt;
      &lt;Button&gt;Click Me!&lt;/Button&gt;
    &lt;/div&gt;
  );
}

// apps/store/pages/index.js
import { Button } from "ui";
export default function Home() {
  return (
    &lt;div&gt;
      &lt;h1&gt;Store&lt;/h1&gt;
      &lt;Button&gt;Click Me!&lt;/Button&gt;
    &lt;/div&gt;
  );
}
</pre>
<p>重新启动开发服务器，访问每个应用程序，您将看到类似下图的错误:</p>
<p><img data-attachment-id="144473" data-permalink="https://blog.logrocket.com/build-monorepo-next-js/attachment/error-signal-2/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/11/error-signal-1.jpeg" data-orig-size="730,283" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;1&quot;}" data-image-title="error-signal" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/11/error-signal-1-300x116.jpeg" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/11/error-signal-1.jpeg" decoding="async" class="aligncenter wp-image-144473 size-full jetpack-lazy-image" src="../Images/7a833d0db76948713c5b49e19a39138f.png" alt="Error Signals" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2022/11/error-signal-1.jpeg 730w, https://blog.logrocket.com/wp-content/uploads/2022/11/error-signal-1-300x116.jpeg 300w" data-lazy-sizes="(max-width: 730px) 100vw, 730px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2022/11/error-signal-1.jpeg?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/11/error-signal-1.jpeg"/></p><noscript><img data-lazy-fallback="1" data-attachment-id="144473" data-permalink="https://blog.logrocket.com/build-monorepo-next-js/attachment/error-signal-2/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/11/error-signal-1.jpeg" data-orig-size="730,283" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;1&quot;}" data-image-title="error-signal" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/11/error-signal-1-300x116.jpeg" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/11/error-signal-1.jpeg" decoding="async" loading="lazy" class="aligncenter wp-image-144473 size-full" src="../Images/7a833d0db76948713c5b49e19a39138f.png" alt="Error Signals" srcset="https://blog.logrocket.com/wp-content/uploads/2022/11/error-signal-1.jpeg 730w, https://blog.logrocket.com/wp-content/uploads/2022/11/error-signal-1-300x116.jpeg 300w" sizes="(max-width: 730px) 100vw, 730px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/11/error-signal-1.jpeg"/></noscript>
<p>这个错误的原因是我们没有配置我们的Next.js应用程序来处理本地包的编译，就像<code>packages/shared</code>中的<code>ui</code>包一样。</p>
<p>npm上有一个很好的包可以解决这个问题:<a href="https://www.npmjs.com/package/next-transpile-modules">next-trans file-modules</a>。它支持使用Next.js/Babel配置的本地包的传输。</p>
<p>让我们通过输入以下命令在<code>admin</code>和<code>store</code>工作区中安装<code>next-transpile-modules</code>包:</p>
<pre class="language-bash hljs">yarn workspace admin add -D next-transpile-modules
yarn workspace store add -D next-transpile-modules
</pre>
<p>在<code>admin</code>和<code>store</code>工作区的<code>next.config.js</code>文件中，输入以下代码，使用<code>next-transpile-modules</code>包传输组件库包:</p>
<pre class="language-javascript hljs">/** @type {import('next').NextConfig} */
const withTM = require("next-transpile-modules")(["ui"]);
module.exports = withTM({
  reactStrictMode: true,
  swcMinify: true,
});
</pre>
<p>因为我们已经对<code>next.config.js</code>文件进行了更改，所以我们必须重启开发服务器以使更改生效。重启服务器后，导航到<a href="http://localhost:3000"> localhost:3000 </a>，错误应该会得到解决，现在一切正常。</p>
<h2 id="conclusion">结论</h2>
<p>Monorepos将继续在web开发社区中流行，因为它们有许多好处，而且工具的进步使开发人员更容易使用它们。</p>
<p>我希望你觉得这篇在Next.js中构建monorepo的指南很有用——请在下面的评论中告诉我你的经历。</p><div class="code-block code-block-30">
<div class="blog-plug inline-plug next-plug"><h2><a href="https://lp.logrocket.com/blg/nextjs-signup" target="_blank"> LogRocket </a>:全面了解生产Next.js应用</h2><p>调试下一个应用程序可能会很困难，尤其是当用户遇到难以重现的问题时。如果您对监视和跟踪状态、自动显示JavaScript错误、跟踪缓慢的网络请求和组件加载时间感兴趣，</p><a href="https://lp.logrocket.com/blg/nextjs-signup" target="_blank">try LogRocket</a><p>. </p><a class="signup" href="https://lp.logrocket.com/blg/nextjs-signup" target="_blank" rel="noopener noreferrer"><img class="alignnone size-full wp-image-46 jetpack-lazy-image" src="../Images/f300c244a1a1cf916df8b4cb02bec6c6.png" data-lazy-src="https://files.readme.io/27c94e7-Image_2017-06-05_at_9.46.04_PM.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://files.readme.io/27c94e7-Image_2017-06-05_at_9.46.04_PM.png"/><noscript><img data-lazy-fallback="1" class="alignnone size-full wp-image-46" src="../Images/f300c244a1a1cf916df8b4cb02bec6c6.png" data-original-src="https://files.readme.io/27c94e7-Image_2017-06-05_at_9.46.04_PM.png"/></noscript></a><a class="signup" href="https://lp.logrocket.com/blg/nextjs-signup" target="_blank" rel="noopener noreferrer"><img class="alignnone size-full wp-image-46 jetpack-lazy-image" src="../Images/d6f5a5dd739296c1dd7aab3d5e77eeb9.png" alt="LogRocket Dashboard Free Trial Banner" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2017/03/1d0cd-1s_rmyo6nbrasp-xtvbaxfg.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2017/03/1d0cd-1s_rmyo6nbrasp-xtvbaxfg.png"/><noscript><img data-lazy-fallback="1" class="alignnone size-full wp-image-46" src="../Images/d6f5a5dd739296c1dd7aab3d5e77eeb9.png" alt="LogRocket Dashboard Free Trial Banner" data-original-src="https://blog.logrocket.com/wp-content/uploads/2017/03/1d0cd-1s_rmyo6nbrasp-xtvbaxfg.png"/></noscript></a><p>LogRocket 就像是网络和移动应用的DVR，记录下你的Next.js应用上发生的一切。您可以汇总并报告问题发生时应用程序的状态，而不是猜测问题发生的原因。LogRocket还可以监控应用程序的性能，报告客户端CPU负载、客户端内存使用等指标。</p><p>LogRocket Redux中间件包为您的用户会话增加了一层额外的可见性。LogRocket记录Redux存储中的所有操作和状态。</p><p>让您调试Next.js应用的方式现代化— <a class="signup" href="https://lp.logrocket.com/blg/nextjs-signup" target="_blank" rel="noopener noreferrer">开始免费监控</a>。</p></div></div>

<p class="clearfix"/>
<p class="clearfix"/>
</article>

</div>    
</body>
</html>